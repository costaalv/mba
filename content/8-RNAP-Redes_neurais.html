

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Redes Neurais e Aprendizado Profundo &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/8-RNAP-Redes_neurais';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1 - APRENDIZADO DE MÁQUINA - AM" href="9-REVISOES.html" />
    <link rel="prev" title="7.1-ADBPMP-Slides+ASs" href="7.1-ADBPMP-Slides%2BASs.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    MBA - Ciência de Dados - 2023
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">1. ICD - Introdução à Ciência de Dados</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1-ICD-Introducao_Ciencia_%20de_Dados.html">Aula 1</a></li>
















</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">2. PCD - Programação para Ciência de dados</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="2-PCD-Programacao_para_Ciencia_de_dados.html"><span style="color:blue">Python Parte I</span></a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">3. AD - Aprendizado Dinâmico</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="3-AD-Aprendizado_dinamico.html">Aprendizado Dinâmico</a></li>
































</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">4. TACTD - Técnicas Avancadas</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="4-TACTD-Tecnicas_avancadas.html"><span style="color:darkred">Dados estruturados e não estruturados e problemas típicos em bases de dados</span></a></li>



































</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">5. AM - Aprendizado de Máquina</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="5-AM-Aprendizado_de_maquina.html">Prática 1: Visão Geral da Biblioteca Sklearn</a></li>

























</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">5.1 AM - Slides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="5.1-AM-Slides.html">5.1-AM-Slides</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">6. ECD - Estatística</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="6-ECD-Estatistica.html">Estatística para Ciência de Dados</a></li>























</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">7. ADBPMP - DW</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="7-ADBPMP-DW.html"><span style="color:blue">Análise de Dados com Base em Processamento Massivo em Paralelo</span></a></li>




















































</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">7.1 ADBPMP - Slides + ASs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="7.1-ADBPMP-Slides%2BASs.html">7.1-ADBPMP-Slides+ASs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">8. RNAP - Redes Neurais</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Redes Neurais e Aprendizado Profundo</a></li>











</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">9. Revisões</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="9-REVISOES.html">1 - APRENDIZADO DE MÁQUINA - AM</a></li>































</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/8-RNAP-Redes_neurais.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Redes Neurais e Aprendizado Profundo</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Redes Neurais e Aprendizado Profundo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perceptron">Perceptron</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classe-perceptron">1. Classe Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metodo-para-predicao-e-funcao-de-custo">2. Método para predição e função de custo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#redes-neurais-e-arquiteturas-profundas">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mba-em-ciencias-de-dados"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-1-introducao-ao-aprendizado-profundo"><em>Módulo 1 - Introdução ao Aprendizado Profundo</em></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-com-tensorflow-e-keras">Implementação com Tensorflow e Keras</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-avaliacao-com-solucoes-span"><span style="color:darkred">Avaliação (com soluções)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-1">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-2">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-3">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-4">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-5">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-exercicios-com-solucoes-span"><span style="color:darkred">Exercícios com soluções</span></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-1-exercicios-essenciais">Parte 1 - Exercícios Essenciais</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-1">Exercício 1)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-2">Exercício 2)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-3">Exercício 3)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-4">Exercício 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-5">Exercício 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-6">Exercício 6)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-7">Exercício 7)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-8">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#perceptron-e-seu-treinamento">Perceptron e seu Treinamento</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1. Classe Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-da-classe">Uso da classe</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dados-de-treinamento">Dados de treinamento:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2"><em>Módulo 2</em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-com-dados-estruturados">MLP com dados estruturados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#podemos-mudar-as-metricas-a-serem-acompanhadas">Podemos mudar as métricas a serem acompanhadas</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisando-o-modelo">Analisando o modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#desbalanceamento">Desbalanceamento</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outros-ajustes">Outros ajustes:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2-embeddings-de-modelos-pre-treinados-imagens">Modulo 2 - Embeddings de Modelos Pré-treinados - Imagens</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rede-convolucional-supervisionada-pre-treinada">Rede Convolucional Supervisionada Pré-treinada</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicando-as-features-obtidas-em-um-classificador">Aplicando as features obtidas em um classificador</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2-embeddings-de-modelos-pre-treinados-texto"><em>Modulo 2</em> - Embeddings de Modelos Pré-treinados - Texto</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-sentence-transformer">Modelos Sentence Transformer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Aplicando as features obtidas em um classificador</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-ii-span"><span style="color:darkred">Módulo II</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Questão 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-5-as2">Questão 5 - AS2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Implementação com Tensorflow e Keras</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-2-span"><span style="color:darkred">Módulo 2</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12"><span style="color:darkred">Exercícios com soluções</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-3-redes-neurais-convolucionais-cnns"><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-vs-cnn"><strong>MLP vs CNN</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exemplo-de-uso-de-redes-neurais-profundas-para-classificacao-de-imagens">Exemplo de uso de redes neurais profundas para classificação de imagens</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#como-tratar-bases-de-imagens-antes-de-comecar-a-processar">1. Como tratar bases de imagens antes de começar a processar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacao-rede-densa-mlp-vs-rede-convolucional-cnn">2. Comparação: Rede Densa (MLP) vs Rede Convolucional (CNN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tudo-pronto-agora-vamos-comecar">Tudo pronto, agora vamos começar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vamos-aos-concorrentes">Vamos aos concorrentes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-o-dataset-e-os-modelos">1) Preparando o dataset e os modelos</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#e-la-vamos-nos-em-quem-voce-apostaria"><strong>E lá vamos nós</strong>: em quem você apostaria?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id22"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id23"><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-e-preparar-base-de-dados">1. Carregar e preparar base de dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparar-os-batches">Preparar os batches</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#projetar-redes-neurais">2. Projetar redes neurais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cnn-estilo-vggnet">2.1 - CNN estilo “VGGNet”</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#substituicao-de-maxpooling-por-strides-1">2.2 - Substituição de MaxPooling por strides &gt; 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-de-convolucoes-por-partes-1x3-3x1-1x1">2.3 - Uso de convoluções por partes 1x3, 3x1, 1x1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#blocos-residuais-estilo-resnet">2.4 - Blocos Residuais (estilo ResNet)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#blocos-separaveis-em-profundidade-estilo-xception-mobilenet">2.5 - Blocos Separáveis em Profundidade (estilo Xception/MobileNet)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compilando-modelos">3. Compilando Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#executando-o-treinamento">4. Executando o treinamento</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-3-redes-neurais-convolucionais-cnns-span"><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Questão 1)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Questão 2)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Questão 3)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Questão 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Questão 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30"><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id31"><span style="color:darkred">Exercícios com soluções</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-4-treinamento-de-redes-profundas"><em>Módulo 4 - Treinamento de Redes Profundas</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regularizacao-e-normalizacao">Regularização e Normalização</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vamos-investigar-uma-cnn-sequencial-e-adicionar-opcoes-de-dropout-regularizacao-e-normalizacao-por-batch-e-por-camada">1) Vamos investigar uma CNN sequencial, e adicionar opções de Dropout (regularização), e normalização por batch e por camada</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#i-avaliando-o-papel-da-normalizacao">I - Avaliando o papel da Normalização</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#com-batch-normalization">com Batch Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#com-layer-normalization">com Layer Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">Redes Neurais e Aprendizado Profundo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id41"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42"><em>Módulo 4 - Treinamento de Redes Profundas</em></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augmentation">Data Augmentation:</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#funciona-como-uma-camada-de-pre-processamento-gerando-transformacoes-aleatorias-na-imagem-de-entrada">funciona como uma camada de pré-processamento, gerando transformações aleatórias na imagem de entrada.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-a-cnn-mobilenet-v2-para-ser-usada-como-backbone-da-solucao">Carregando a CNN “MobileNet V2” para ser usada como “backbone” da solução</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compilando-e-treinando-o-modelo-a-partir-de-pessos-aleatorios">Compilando e treinando o modelo a partir de pessos aleatórios</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-a-cnn-mobilenet-v2-com-pesos-pre-treinados">Carregando a CNN “MobileNet V2” com pesos pré-treinados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-1-treinar-apenas-a-camada-de-saida-softmax">Passo 1: treinar apenas a camada de saída (softmax)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-2-ajuste-fino-do-restante-dos-parametros">Passo 2: ajuste fino do restante dos parâmetros</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#obtendo-features-a-partir-da-cnn-mobilenet-v2-com-pesos-pre-treinados">Obtendo features a partir da CNN “MobileNet V2” com pesos pré-treinados</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-4-estrategias-de-treinamento-e-transferencia-de-aprendizado-span"><span style="color:darkred">Módulo 4 - Estratégias de Treinamento e Transferência de Aprendizado</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id43"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id44">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id45">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id46">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id47">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id48">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-iv-estrategias-de-treinamento-e-transferencia-de-aprendizado-span"><span style="color:darkred">Módulo IV - Estratégias de Treinamento e Transferência de Aprendizado</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id49"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id50">Parte 1 - Exercícios Essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id51">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id52">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id53">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id54">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id55">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id56">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id57">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-exercicios-complementares-opcionais">Parte 2 - Exercícios Complementares/Opcionais</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id58">Exercício 8)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-9">Exercício 9)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-10">Exercício 10)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id59">Módulo 4 - Treinamento de Redes Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entendendo-a-funcao-de-custo-entropia-cruzada-cross-entropy">Entendendo a função de custo entropia cruzada (cross-entropy)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id60"><em>Módulo 4 - Treinamento de Redes Profundas</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taxa-de-aprendizado">Taxa de aprendizado</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-dataset">1. Preparando Dataset</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#definindo-rede-neural">2. Definindo Rede Neural</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explorando-diferentes-estrategias-para-o-learning-rate">3. Explorando Diferentes Estratégias para o Learning Rate</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-fixo">3.1 - Learning Rate Fixo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-alto">3.2 - Learning Rate Alto</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sgd-momentum-com-peso-0-9">3.2 - SGD + Momentum com peso 0.9</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decaimento-de-learning-rate">3.3 - Decaimento de Learning Rate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-5-redes-neurais-para-dados-sequenciais-span"><span style="color:darkred">Módulo 5 - Redes neurais para dados sequenciais</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id61"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id62">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id63">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id64">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id65">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id66">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-5-redes-neurais-para-dados-sequenciais-span">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-lstms-e-grus-para-predicao-de-series-temporais-span"><span style="color:darkred"><strong>LSTMs e GRUs</strong> para predição de séries temporais</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-1-preparando-os-dados">Parte 1: Preparando os dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulacao-para-aprendizado-supervisionado-adequacao-dos-arrays">Formulação para aprendizado supervisionado: adequação dos arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-utilizando-unidades-densas-para-predicao">Parte 2: Utilizando unidades Densas para predição</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-utilizando-lstms-para-predicao">Parte 3 : Utilizando LSTMs para predição</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rede-com-unidades-lstm">Rede com unidades LSTM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gru-como-forma-alternativa-a-lstm">GRU como forma alternativa à LSTM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-5-redes-neurais-para-dados-sequenciais">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-mecanismo-de-atencao-span"><span style="color:darkred"><strong>Mecanismo de atenção</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id67">Redes Neurais e Aprendizado Profundo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id68"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id69">Módulo 5 - Redes neurais para dados sequenciais </a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-camada-self-attention-combinada-com-lstm-span"><span style="color:darkred"><strong>Camada Self-Attention</strong> combinada com LSTM</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id70">Parte 1: Preparando os dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id71">Formulação para aprendizado supervisionado: adequação dos arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-utilizando-lstms-para-predicao">Parte 2 : Utilizando LSTMs para predição</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id72">Rede com unidades LSTM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-camada-self-attention">Parte 3: Camada Self-Attention</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id73">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-series-multivariadas-e-statefulness-span"><span style="color:darkred"><strong>Séries Multivariadas e Statefulness</strong></span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id74">Parte 1: Preparando os dados</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-problema-regressao-com-entrada-multivariada">Parte 2: problema regressão com entrada multivariada</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statefullness">Statefullness</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-6-redes-neurais-para-texto-span"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id75"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id76">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id77">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id78">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id79">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id80">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id81"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id82"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id83">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id84">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id85">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id86">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id87">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id88">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id89">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id90">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id91"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-word-embeddings-span"><span style="color:darkred"><strong>Parte 1: Word Embeddings</strong></span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-representacoes-pre-treinadas-em-portugues">Carregando representações pré-treinadas em português</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#base-de-dados-rumor-brazil-2018">Base de dados: rumor Brazil 2018</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#camada-de-word-embedding">Camada de “Word Embedding”</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-baseado-em-convolucoes">Modelo baseado em Convoluções</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-utilizando-gru">Modelo utilizando GRU</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id92"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-transformer-based-network-span"><strong>Parte 2: Transformer-based Network</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-de-transformer">Implementação de Transformer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#camada-de-embedding-contendo-word-embedding-e-vetor-com-posicoes-das-palavras">Camada de Embedding, contendo word embedding e vetor com posições das palavras</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#montando-a-rede-transformer">Montando a rede Transformer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id93"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-distilbert-transferencia-de-aprendizado-span"><strong>Parte 3: DistilBERT: transferência de aprendizado</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-dataset-de-texto">1. Carregando Dataset de texto</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-o-dataset-para-uso-na-rede-neural">2.1 Preparando o dataset para uso na rede neural</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-modelo-pre-treinado-e-configura-lo">3. Carregar modelo pré-treinado e configurá-lo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#criar-modelo-para-realizar-transferencia-de-aprendizado-para-a-tarefa-alvo-downstream-task-de-classificacao">3.1 Criar modelo para realizar transferência de aprendizado para a tarefa alvo (downstream task) de classificação</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#treinamento-das-camadas-novas-transfer-learning">3.2 Treinamento das camadas novas (transfer learning)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fine-tuning-do-distilbert">3.3 Fine-tuning do DistilBERT</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-7-auto-encoders-e-redes-geradoras-span"><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id94"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id95">Parte 1 - Exercícios Essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id96">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id97">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id98">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id99">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id100">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id101">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-exercicios-complementares">Parte 2 - Exercícios complementares</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id102">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-7-auto-encodes-e-redes-geradoras-span"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-autoencoders-para-aprendizado-de-representacoes-span"><span style="color:darkred"><strong>Parte 1: Autoencoders para Aprendizado de Representações</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autoencoder-convolucional">Autoencoder convolucional</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#treinando-o-autoencoder">Treinando o autoencoder</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id103"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-2-autoencoders-para-reducao-de-dimensionalidade-span"><span style="color:darkred"><strong>Parte 2: Autoencoders para Redução de Dimensionalidade</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#o-autoencoder-sera-denso-com">O autoencoder será denso, com:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-em-regressor-externo">Uso em regressor externo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id104"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-3-rede-geradora-adversarial-gan-span"><span style="color:darkred"><strong>Parte 3: Rede Geradora Adversarial (GAN)</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discriminador">Discriminador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gerador">Gerador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gan">GAN</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id105"><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id106"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id107">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id108">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id109">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id110">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id111">Questão 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-spa"><span style="color:darkred">Módulo 8 -  Introdução ao Aprendizado por Reforço&lt;/spa</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-avaliacao-respostas"><span style="color:darkred">Avaliação&lt;respostas</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id112">Questão 1)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id113">Questão 2)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id114">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id115">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id116">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-vii-introducao-ao-aprendizado-por-reforco-span"><span style="color:darkred">Módulo VII -  Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id117"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id118">Parte 1: Exercícios essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id119">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id120">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id121">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id122">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id123">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id124">Exercício 6)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id125">Parte 2: Exercícios Complementares</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id126">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id127">Exercício 8)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id128">Exercício 9)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-span"><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-biblioteca-gym-e-problemas-benchmark-de-aprendizado-por-reforco-span"><span style="color:darkred"><strong>Parte 1: Biblioteca Gym e Problemas Benchmark de Aprendizado por Reforço</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-montain-car">Problema “Montain Car”</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-do-taxi">Problema do táxi</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id129"><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-2-algoritmo-de-aprendizado-por-reforco-value-learning-span"><span style="color:darkred"><strong>Parte 2: Algoritmo de Aprendizado por Reforço “Value Learning”</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-taxi">Problema Taxi</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#algoritmo-de-value-learning">Algoritmo de Value learning</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#avaliando-a-performance-do-agente">Avaliando a performance do agente</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executando-uma-vez-para-visualizar">Executando uma vez para visualizar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avaliacao-final-2023">Avaliação Final - 2023</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacao">Preparação</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biblioteca-sentence-transformers-e-carregar-modelo">1. Biblioteca <code class="docutils literal notranslate"><span class="pre">sentence_transformers</span></code> e carregar modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-base-de-dados-e-obter-amostra">2. Carregar base de dados e obter amostra</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#separar-dados-em-treinamento-e-teste-preparar-rotulos-e-estimar-numero-de-palavras-nas-instancias">3. Separar dados em treinamento e teste, preparar rótulos e estimar número de palavras nas instancias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geracao-dos-embeddings">4. Geração dos embeddings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#realizar-tarefas">Realizar Tarefas:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-modelo-a-classificador-de-sentimento-em-portugues-usando-embedding-pre-treinado">1. (2,5 pt) Modelo A: classificador de sentimento em <em>portugues</em> usando embedding pré-treinado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-modelo-b-classificador-de-sentimento-em-portugues-usando-tokenizador-e-rede-cnn-lstm">2. (2,5 pt) Modelo B: classificador de sentimento em <em>português</em> usando tokenizador e rede CNN+LSTM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-avaliacao-dos-modelos-metricas-durante-treinamento-e-avaliacao-das-metricas-no-conjunto-de-teste-de-ambos-os-modelos">3. (2,0 pt) Avaliação dos modelos: métricas durante treinamento e avaliação das métricas no conjunto de teste de ambos os modelos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-fine-tuning-dos-modelos-anteriores-usando-os-dados-em-ingles">4. (3,0 pt) Fine-tuning dos Modelos anteriores usando os dados em <strong>ingles</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-1pt">Bônus (+1pt)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-dos-espacos-de-caracteristicas-do-textos-em-portugues-usando-tsne-em-duas-dimensoes">1: Análise dos espaços de características do textos em português usando tSNE em duas dimensões</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-espaco-embedding-original-em-portugues">a. Espaço embedding original em portugues</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#b-espaco-embedding-modelo-a">b. Espaço embedding Modelo A</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#c-espaco-embedding-modelo-b">c. Espaço embedding Modelo B</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="redes-neurais-e-aprendizado-profundo">
<h1>Redes Neurais e Aprendizado Profundo<a class="headerlink" href="#redes-neurais-e-aprendizado-profundo" title="Permalink to this heading">#</a></h1>
<section id="perceptron">
<h2>Perceptron<a class="headerlink" href="#perceptron" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p>Vamos gerar alguns dados aleatórios como exemplo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dados aleatórios</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span><span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[ 1.62434536, -0.61175641],
        [-0.52817175, -1.07296862],
        [ 0.86540763, -2.3015387 ],
        [ 1.74481176, -0.7612069 ],
        [ 0.3190391 , -0.24937038],
        [ 1.46210794, -2.06014071],
        [-0.3224172 , -0.38405435],
        [ 1.13376944, -1.09989127],
        [-0.17242821, -0.87785842],
        [ 0.04221375,  0.58281521]]),
 array([0, 0, 1, 1, 0, 0, 0, 0, 1, 1]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x111fcffd690&gt;
</pre></div>
</div>
<img alt="../_images/d6eefd930f3627668f9fb9c75d361a7257b9731b2ad5eecb94c749259c9bed4d.svg" src="../_images/d6eefd930f3627668f9fb9c75d361a7257b9731b2ad5eecb94c749259c9bed4d.svg" /></div>
</div>
</section>
<hr class="docutils" />
<section id="classe-perceptron">
<h2>1. Classe Perceptron<a class="headerlink" href="#classe-perceptron" title="Permalink to this heading">#</a></h2>
<p>Primeira implementação:</p>
<ul class="simple">
<li><p>define e inicializa os parâmetros da rede,</p></li>
<li><p>método para realizar o feed-forward</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Perceptron</span><span class="p">:</span>
    <span class="c1"># construtor - chamado ao instanciar </span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="n">n_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bias&#39;</span><span class="p">)</span>                     
                    
    <span class="c1"># método especial - chamado ao usar o objeto </span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">return</span> <span class="n">logits</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># intanciamos a classe em um objeto que suporta 2 features</span>
<span class="n">perc</span> <span class="o">=</span> <span class="n">Perceptron</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">perc</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">perc</span><span class="o">.</span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Variable &#39;weights:0&#39; shape=(5, 1) dtype=float32, numpy=
 array([[-1.184153  ],
        [-0.5496916 ],
        [ 1.1126369 ],
        [ 2.2485967 ],
        [-0.17531215]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;bias:0&#39; shape=(1,) dtype=float32, numpy=array([0.2], dtype=float32)&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## chama implicitamente o metodo especial __call()__ (erro)</span>
<span class="c1">#perc(X)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Perceptron</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">model</span><span class="p">(</span><span class="n">X_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[ 1.62434536, -0.61175641],
        [-0.52817175, -1.07296862],
        [ 0.86540763, -2.3015387 ],
        [ 1.74481176, -0.7612069 ],
        [ 0.3190391 , -0.24937038],
        [ 1.46210794, -2.06014071],
        [-0.3224172 , -0.38405435],
        [ 1.13376944, -1.09989127],
        [-0.17242821, -0.87785842],
        [ 0.04221375,  0.58281521]]),
 &lt;tf.Tensor: shape=(10, 1), dtype=float32, numpy=
 array([[ 3.33634   ],
        [ 1.9738803 ],
        [ 5.7330356 ],
        [ 3.742772  ],
        [ 1.3005193 ],
        [ 5.8968124 ],
        [ 0.8893056 ],
        [ 3.7474084 ],
        [ 1.975079  ],
        [-0.55422235]], dtype=float32)&gt;)
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="metodo-para-predicao-e-funcao-de-custo">
<h3>2. Método para predição e função de custo<a class="headerlink" href="#metodo-para-predicao-e-funcao-de-custo" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Perceptron</span><span class="p">:</span>
    <span class="c1"># construtor - chamado ao instanciar </span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="n">n_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bias&#39;</span><span class="p">)</span>                     
                    
    <span class="c1"># método especial - chamado ao usar o objeto </span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">return</span> <span class="n">logits</span>

    <span class="c1"># permite realizar predicao (Feed-forward) com numpy array</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">X_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">X_tf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">loss_MSE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">preds</span><span class="o">-</span><span class="n">labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># intanciamos a classe em um objeto que suporta 2 features</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Perceptron</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0, 0, 1, 1, 0, 0, 0, 0, 1, 1]),
 array([[-0.32072365],
        [-0.20537943],
        [-1.4474404 ],
        [-0.4611516 ],
        [ 0.24002764],
        [-1.3926197 ],
        [ 0.27650923],
        [-0.5872215 ],
        [-0.13356411],
        [ 0.9363347 ]], dtype=float32))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">loss_value</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">loss_MSE</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_value</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2241823415016264
</pre></div>
</div>
</div>
</div>
</section>
<section id="redes-neurais-e-arquiteturas-profundas">
<h3>Redes Neurais e Arquiteturas Profundas<a class="headerlink" href="#redes-neurais-e-arquiteturas-profundas" title="Permalink to this heading">#</a></h3>
<section id="mba-em-ciencias-de-dados">
<h4><strong>MBA em Ciências de Dados</strong><a class="headerlink" href="#mba-em-ciencias-de-dados" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="modulo-1-introducao-ao-aprendizado-profundo">
<h3><em>Módulo 1 - Introdução ao Aprendizado Profundo</em><a class="headerlink" href="#modulo-1-introducao-ao-aprendizado-profundo" title="Permalink to this heading">#</a></h3>
<p>Moacir A. Ponti - ICMC/USP</p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="implementacao-com-tensorflow-e-keras">
<h1>Implementação com Tensorflow e Keras<a class="headerlink" href="#implementacao-com-tensorflow-e-keras" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">keras</span>

<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dados aleatórios</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="p">),</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span><span class="o">+</span><span class="n">delta</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">)])</span>

<span class="c1"># Split the dataset into training and testing sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> 
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x1366621ff10&gt;
</pre></div>
</div>
<img alt="../_images/6bdba12cceb0232ea039166c366f736fa89f376bd3f93f97ffd37d33b7f2f307.svg" src="../_images/6bdba12cceb0232ea039166c366f736fa89f376bd3f93f97ffd37d33b7f2f307.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## funcao para retornar modelo em Keras</span>
<span class="k">def</span> <span class="nf">create_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">(</span>
        <span class="p">[</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer1&quot;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer2&quot;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer3&quot;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Output&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># instanciar modelo</span>
<span class="n">p_model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>

<span class="c1"># compilar modelo com configuracoes de otimizacao</span>
<span class="c1"># Compile the model</span>
<span class="n">p_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># treinamento</span>
<span class="n">p_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># avaliacao</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
Epoch 2/30
Epoch 3/30
Epoch 4/30
Epoch 5/30
Epoch 6/30
Epoch 7/30
Epoch 8/30
Epoch 9/30
Epoch 10/30
Epoch 11/30
Epoch 12/30
Epoch 13/30
Epoch 14/30
Epoch 15/30
Epoch 16/30
Epoch 17/30
Epoch 18/30
Epoch 19/30
Epoch 20/30
Epoch 21/30
Epoch 22/30
Epoch 23/30
Epoch 24/30
Epoch 25/30
Epoch 26/30
Epoch 27/30
Epoch 28/30
Epoch 29/30
Epoch 30/30
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.src.callbacks.History at 0x1366809dad0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate the model on the test data using `evaluate`</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluate on test data&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">p_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test loss, test acc:&quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate on test data
4/4 [==============================] - 0s 2ms/step - loss: 0.0742 - accuracy: 0.9075
test loss, test acc: [0.07417245954275131, 0.9075000286102295]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">p_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13/13 [==============================] - 0s 1ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plotando os dados de teste</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Predicted data&#39;)
</pre></div>
</div>
<img alt="../_images/13b611e28fd8fbbaaad3839e6f3fd1c1dc8dba0a6482866e66f02be30d48ed83.svg" src="../_images/13b611e28fd8fbbaaad3839e6f3fd1c1dc8dba0a6482866e66f02be30d48ed83.svg" /></div>
</div>
<section id="span-style-color-darkred-avaliacao-com-solucoes-span">
<h2><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#span-style-color-darkred-avaliacao-com-solucoes-span" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="questao-1">
<h3>Questão 1)<a class="headerlink" href="#questao-1" title="Permalink to this heading">#</a></h3>
<p>Qual dos cenários abaixo define o “aprendizado de características/feature learning” em aprendizado profundo supervisionado quando trabalhamos com dados não estruturados para classificação?</p>
<p>(a) realizar extração de características dos dados, trabalhar o espaço de características resultante, aplicar métodos de redução de dimensionalidade e um algoritmo de classificação para uma tarefa alvo<br>
(b) modelar por meio de diferentes redes neurais as etapas de extração de características, redução de dimensionalidade e de classificação da tarefa alvo<br>
(c) utilizar classificadores do tipo Perceptron para abordar o problema<br>
<font color='red'>(d) realizar preparação básica de dados e deixar que uma única rede neural aprenda as características e o classificador com base na tarefa alvo<br></font>
(e) realizar extração de características dos dados, trabalhar o espaço de características resultante com métodos do estado da arte e então utilizar um ensemble de redes neurais para resolver o problema<br></p>
<p><strong>Justificativa</strong>:</p>
</section>
<hr class="docutils" />
<section id="questao-2">
<h3>Questão 2)<a class="headerlink" href="#questao-2" title="Permalink to this heading">#</a></h3>
<p>Qual a diferença entre as funções de ativação <em>sigmoide</em> e <em>tangente hiperbólica</em> aplicadas a uma camada de uma rede neural?</p>
<p>(a) a sigmóide produz como saída vetores cuja somatória é 1 e que podem ser interpretados como uma distribuição de probabilidade, enquanto a tangente hiperbólica comprime os valores da saída entre 0 e 1<br>
(b) a sigmóide produz como saída vetores cujos valores estão entre -1 e 1 de forma suave, enquanto a tangente hiperbólica  mapeia para 0 valores negativos e funciona como função linear para os positivos<br>
<font color='red'>(c) a sigmóide comprime os valores da saída entre 0 e 1 de forma suave, enquanto a tangente hiperbólica comprime os valores da saída entre -1 e 1 de forma suave<br></font>
(d) a sigmóide comprime os valores da saída entre 0 e 1 de forma suave, enquanto a tangente hiperbólica também comprime os valores da saída entre 0 e 1 porém na forma de um degrau na posição 0.
(e) ambas produzem a mesma saída pois possuem o mesmo formato.</p>
</section>
<hr class="docutils" />
<section id="questao-3">
<h3>Questão 3)<a class="headerlink" href="#questao-3" title="Permalink to this heading">#</a></h3>
<p>Considere uma amostra com <span class="math notranslate nohighlight">\(n=6\)</span> exemplos, para os quais temos as saídas (rótulos): <span class="math notranslate nohighlight">\(\mathbf{y} = [0, 0, 1, 1, 1, 0]\)</span>.</p>
<p>Dois modelos de rede neural produziram as seguintes saídas:<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_1 = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0]\)</span>,<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_2 = [0.1, 0.1, 0.1, 0.9, 0.9, 0.1]\)</span>.</p>
<p>Implemente funções que calcule as perdas para as saídas 1 e 2, respectivamente, arredondando para 2 casas decimais:</p>
<ul class="simple">
<li><p>quadrática média (MSE), considerando a formulação <span class="math notranslate nohighlight">\(\frac{1}{n} \sum_j (y_j - \hat{y}_j)^2\)</span>, com <span class="math notranslate nohighlight">\(j=1,...,n\)</span></p></li>
<li><p>entropia cruzada binária (CE), considerando a formulação <span class="math notranslate nohighlight">\( \frac{1}{n}\sum_{j} -(y_j \ln \hat{y}_j + (1-y_j) \ln (1-\hat{y}_j)) \)</span>, com <span class="math notranslate nohighlight">\(j=1,...,n\)</span>.</p></li>
</ul>
<p>OBS: para evitar erros por log de 0, use <span class="math notranslate nohighlight">\(ln(x+0.001)\)</span>, ou seja some 0.001 aos logs.</p>
<p>Assinale a alternativa que indica as perdas MSE e CE calculadas para as saídas 1 e 2</p>
<p><font color='red'>(a) 1: MSE=0.50, CE=3.45, 2: MSE=0.14, CE=0.47<br></font>
(b) 1: MSE=3.00, CE=20.70, 2: MSE=0.84, CE=2.82<br>
(c) 1: MSE=0.50, CE=3.45, 2: MSE=4.00, CE=2.82<br>
(d) 1: MSE=0.50, CE=20.70, 2: MSE=0.47, CE=0.47<br>
(e) 1: MSE=1.00, CE=1.00, 2: MSE=0.14, CE=0.47<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y_h</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_h</span><span class="p">))</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y_h</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_h</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span> <span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y_h</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)))</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">y_hat_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">y_hat_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Perda Quadrática Média&#39;</span><span class="p">)</span>
<span class="n">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_2</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Perda Quadrática Média
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3.0, 0.8400000000000001)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entropia Cruzada Média&#39;</span><span class="p">)</span>
<span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_2</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entropia Cruzada Média
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(20.700000000000003, 2.82)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="questao-4">
<h3>Questão 4)<a class="headerlink" href="#questao-4" title="Permalink to this heading">#</a></h3>
<p>Quando dizemos que um neurônio de uma rede neural “aprende” (no sentido de aprendizado de máquina), o que isso significa em termos do modelo matemático do Perceptron?</p>
<p>(a) aprender é inicializar os parâmetros do modelo (pesos e bias) com valores aleatórios<br>
(b) aprender é computar a função de perda/custo do modelo considerando seus parâmetros atuais (pesos e bias)<br>
(c) aprender é computar a multiplicação vetorial entre os dados de entrada e os pesos, e somar o valor bias<br>
<font color='red'>(d) aprender é ajustar os parâmetros do modelo (pesos e bias) usando uma base de dados de treinamento<br></font>
(e) aprender é ajustar os parâmetros do modelo (pesos e bias) usando uma base de dados de validação<br></p>
<p><strong>Justificativa</strong>:</p>
</section>
<hr class="docutils" />
<section id="questao-5">
<h3>Questão 5)<a class="headerlink" href="#questao-5" title="Permalink to this heading">#</a></h3>
<p>Suponha duas formulações de um classificador:</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(\hat y = s(\mathbf{w}^T \mathbf{x} + b)\)</span>, com <span class="math notranslate nohighlight">\(\mathbf{x} \in R^3\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\hat y = s(w_1 x_1 + w_2 x_2 + w_3 x_3 + b)\)</span>,<br>
em que <span class="math notranslate nohighlight">\(s(.)\)</span> é uma função de ativação do tipo sigmóide.</p></li>
</ol>
<p>Qual a afirmativa correta quando comparamos essas formulações?</p>
<p><font color='red'>(a) representam a mesma função de classificação</font><br>
(b) ambas são classicadores lineares, porém apenas a (1)  é válida para uso como neurônio de uma rede neural Perceptron<br>
(c) ambas são classicadores lineares, porém apenas a (2) é válida para uso como neurônio de uma rede neural Perceptron<br>
(d) apenas (1) é um classificador linear, enquanto a (2) é não linear <br>
(e) apenas (2) é um classificador linear, enquanto a (1) é não linear <br></p>
<p><strong>Justificativa</strong>:</p>
</section>
</section>
<section id="span-style-color-darkred-exercicios-com-solucoes-span">
<h2><span style="color:darkred">Exercícios com soluções</span><a class="headerlink" href="#span-style-color-darkred-exercicios-com-solucoes-span" title="Permalink to this heading">#</a></h2>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="parte-1-exercicios-essenciais">
<h1>Parte 1 - Exercícios Essenciais<a class="headerlink" href="#parte-1-exercicios-essenciais" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<section id="exercicio-1">
<h2>Exercício 1)<a class="headerlink" href="#exercicio-1" title="Permalink to this heading">#</a></h2>
<p>As redes neurais artificiais passaram por um chamado “inverno” em que recebiam pouca atenção da academia e do mercado quando comparado aos sistemas especialistas. Por que isso mudou em meados de 2010?</p>
<p>(a) Devido a descobertas da inteligência artificial em 2012 que revolucionou a área<br>
<font color='red'>(b) Trabalhos científicos mostraram que a utilização de grandes bases de dados anotadas e o uso de placas gráficas permitiam treinar modelos com baixo erro de classificação</font><br>
(c) Devido a melhoria dos sistemas computacionais, incluindo melhores processadores (CPUs), maior memória principal disponível (RAM) e placas gráficas (GPUs)<br>
(d) Pois foi nessa época em que a área de ciência de dados tomou destaque, devido a grande quantidade de dados disponível (big data)<br></p>
<hr class="docutils" />
</section>
<section id="exercicio-2">
<h2>Exercício 2)<a class="headerlink" href="#exercicio-2" title="Permalink to this heading">#</a></h2>
<p>Seja <span class="math notranslate nohighlight">\(\mathbf{x} \in X\)</span> um vetor com informações sobre perfis de clientes de um e-commerce, incluindo: data de nascimento, cidade, quantidade de pedidos realizados nos últimos 12 meses, total em reais das compras, entre outros. Desejamos obter um modelo que seja capaz de receber por entrada uma instância de <span class="math notranslate nohighlight">\(X\)</span> e inferir a probabilidade <span class="math notranslate nohighlight">\(y\)</span> de um cliente realizar uma compra no próximo mês. Considere duas formulações conforme abaixo:</p>
<ol class="arabic simple">
<li><p>Modelo A: <span class="math notranslate nohighlight">\(f(\mathbf{x}) = \hat{y}\)</span></p></li>
<li><p>Modelo B:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
g(\mathbf{x}) &amp;= \mathbf{r},\\
h(\mathbf{r}) &amp;= \mathbf{s},\\
i(\mathbf{s}) &amp;= \mathbf{w},\\
f(\mathbf{w}) &amp;= \hat{y}
\end{align}
\end{split}\]</div>
<p>O que podemos dizer sobre A e B?</p>
<p>(a) A é um classificador linear e B é um regressor multi-estágio<br>
(b) apenas B é uma formulação de aprendizado de máquina, enquanto A não pode ser considerado aprendizado de máquina<br>
(c) A é um classificador linear como o Perceptron, enquanto B é uma rede neural profunda<br>
<font color='red'>(d) A é uma formulação rasa, enquanto que B é uma formulação profunda para aprendizado de máquina</font><br></p>
<hr class="docutils" />
</section>
<section id="exercicio-3">
<h2>Exercício 3)<a class="headerlink" href="#exercicio-3" title="Permalink to this heading">#</a></h2>
<p>Seja <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> um vetor de entrada e <span class="math notranslate nohighlight">\(s\)</span> um valor de saída de um neurônio de uma rede neural baseada em Perceptron. O processamento pode ser escrito na forma:</p>
<p><span class="math notranslate nohighlight">\(f(\mathbf{x}) = a(\mathbf{w}^t\mathbf{x}+b) = s\)</span>,</p>
<p>sendo que <span class="math notranslate nohighlight">\(a()\)</span> é a função de ativação. Sabendo que a entrada tem <span class="math notranslate nohighlight">\(d\)</span> dimensões, quais são as dimensões das variáveis <span class="math notranslate nohighlight">\(w\)</span> e <span class="math notranslate nohighlight">\(b\)</span>?</p>
<p><font color='red'>(a) <span class="math notranslate nohighlight">\(w\)</span> é um vetor com <span class="math notranslate nohighlight">\(d\)</span> dimensões, enquanto <span class="math notranslate nohighlight">\(b\)</span> é escalar possuindo uma dimensão<br></font>
(b) <span class="math notranslate nohighlight">\(w\)</span> é um vetor com 2 dimensões, enquanto <span class="math notranslate nohighlight">\(b\)</span> é escalar possuindo uma dimensão<br>
(c) <span class="math notranslate nohighlight">\(w\)</span> é escalar com 1 dimensão, enquanto <span class="math notranslate nohighlight">\(b\)</span> é o vetor bias cujo número de dimensões é igual ao número de classes do problema<br>
(d) <span class="math notranslate nohighlight">\(w\)</span> é um vetor com <span class="math notranslate nohighlight">\(d-1\)</span> dimensões, enquanto <span class="math notranslate nohighlight">\(b\)</span> é bias e portanto possui apenas 1 dimensão</p>
<hr class="docutils" />
</section>
<section id="exercicio-4">
<h2>Exercício 4)<a class="headerlink" href="#exercicio-4" title="Permalink to this heading">#</a></h2>
<p>Seja <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> um vetor de entrada e <span class="math notranslate nohighlight">\(\mathbf{s}\)</span> um vetor de saída de uma camada de rede neural baseada em Perceptron. O processamento pode ser escrito na forma:</p>
<p><span class="math notranslate nohighlight">\(f(\mathbf{x}) = a(W\mathbf{x}+\mathbf{b}) = \mathbf{s}\)</span>,</p>
<p>sendo que <span class="math notranslate nohighlight">\(a()\)</span> é a função de ativação. Sabendo que a entrada tem <span class="math notranslate nohighlight">\(d\)</span> dimensões e a saída tem <span class="math notranslate nohighlight">\(z\)</span> dimensões, quais são as dimensões das variáveis <span class="math notranslate nohighlight">\(W\)</span> e <span class="math notranslate nohighlight">\(b\)</span> e quantos neurônios possui essa camada?</p>
<p>(a) são <span class="math notranslate nohighlight">\(d\)</span> neurônios, sendo que <span class="math notranslate nohighlight">\(W\)</span> possui <span class="math notranslate nohighlight">\(z \times d\)</span>, e <span class="math notranslate nohighlight">\(b\)</span> possui <span class="math notranslate nohighlight">\(d\)</span> dimensões<br>
(b) são <span class="math notranslate nohighlight">\(d \times z\)</span> neurônios, sendo que <span class="math notranslate nohighlight">\(W\)</span> possui <span class="math notranslate nohighlight">\(z \times d\)</span>, e <span class="math notranslate nohighlight">\(b\)</span> possui <span class="math notranslate nohighlight">\(d\)</span> dimensões<br>
<font color='red'>(c) são <span class="math notranslate nohighlight">\(z\)</span> neurônios, sendo que <span class="math notranslate nohighlight">\(W\)</span> possui <span class="math notranslate nohighlight">\(z \times d\)</span>, e <span class="math notranslate nohighlight">\(b\)</span> possui <span class="math notranslate nohighlight">\(z\)</span> dimensões<br></font>
(d) são <span class="math notranslate nohighlight">\(z\)</span> neurônios, sendo que <span class="math notranslate nohighlight">\(W\)</span> possui <span class="math notranslate nohighlight">\(d\)</span>, e <span class="math notranslate nohighlight">\(b\)</span> possui <span class="math notranslate nohighlight">\(z\)</span> dimensões</p>
<hr class="docutils" />
</section>
<section id="exercicio-5">
<h2>Exercício 5)<a class="headerlink" href="#exercicio-5" title="Permalink to this heading">#</a></h2>
<p>Qual a diferença entre as funções de ativação <em>sigmoide</em> e <em>ReLU</em> aplicadas a uma camada de uma rede neural?</p>
<p>(a) a sigmóide produz como saída vetores cuja somatória é 1 e que podem ser interpretados como uma distribuição de probabilidade, enquanto a ReLU comprime os valores da saída entre 0 e 1 <br>
(b) a sigmóide produz como saída vetores cujos valores estão entre -1 e 1 de forma suave, enquanto a ReLU  mapeia para 0 valores negativos e funciona como função linear para os positivos<br>
<font color='red'>(c) a sigmóide comprime os valores da saída entre 0 e 1 de forma suave, enquanto a ReLU mapeia para 0 valores negativos e funciona como função linear para os positivos<br></font>
(d) a sigmóide comprime os valores da saída entre 0 e 1 de forma suave, enquanto a ReLU também comprime os valores da saída entre 0 e 1 porém na forma de um degrau na posição 0.</p>
<hr class="docutils" />
</section>
<section id="exercicio-6">
<h2>Exercício 6)<a class="headerlink" href="#exercicio-6" title="Permalink to this heading">#</a></h2>
<p>Qual a diferença entre a perda esperada (expected loss) e a perda empírica (empirical loss)?</p>
<p>(a) Não há diferença, ambas são usadas para o treinamento de redes neurais, porém a perda esperada é contínua enquanto a perda empírica é discreta<br>
(b) A perda esperada exige uma quantidade infinita de exemplos, enquanto a perda empírica pode ser computada em um conjunto finito de instancias<br>
(c) A perda esperada é difícil de computar pois não temos acesso a probabilidade P(Y), assim computamos a perda empírica que é uma aproximação para um conjunto de treinamento quando não sabemos P(Y)<br>
<font color='red'>(d) A perda esperada é impossível de computar ao não ter disponível a probabilidade conjunta P(X,Y), enqanto a perda empírica se computa de forma agnóstica à P(X,Y) sobre um conjunto de treinamento. <br></font></p>
<hr class="docutils" />
</section>
<section id="exercicio-7">
<h2>Exercício 7)<a class="headerlink" href="#exercicio-7" title="Permalink to this heading">#</a></h2>
<p>Considere uma amostra com <span class="math notranslate nohighlight">\(n=5\)</span> exemplos, para os quais temos as saídas (rótulos): <span class="math notranslate nohighlight">\(\mathbf{y} = [0, 1, 0, 0, 1]\)</span>.</p>
<p>Dois modelos de rede neural produziram as seguintes saídas:<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_1 = [0.5, 0.5, 0.5, 0.5, 0.5]\)</span>,<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_2 = [0.25, 0.75, 0.25, 0.25, 0.75]\)</span>.</p>
<p>Qual a perda quadrática média, considerando a formulação <span class="math notranslate nohighlight">\(\frac{1}{n} \sum_j (y_j - \hat{y}_j)^2\)</span>, com <span class="math notranslate nohighlight">\(j=1,...,n\)</span> para as saídas 1 e 2, respectivamente?</p>
<p><font color='red'>(a) 1: 0.25, 2: 0.0625<br></font>
(b) 1: 0.5, 2: 0.0625<br>
(c) 1: 0.25, 2: 0.5<br>
(d) 1: 0.5, 2: 0.25<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">y_hat_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">y_hat_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y_h</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_h</span><span class="p">))</span><span class="o">/</span><span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_1</span><span class="p">),</span> <span class="n">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.25, 0.0625)
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="exercicio-8">
<h2>Exercício 8)<a class="headerlink" href="#exercicio-8" title="Permalink to this heading">#</a></h2>
<p>Considere uma amostra com <span class="math notranslate nohighlight">\(n=5\)</span> exemplos, para os quais temos as saídas (rótulos): <span class="math notranslate nohighlight">\(\mathbf{y} = [0, 1, 0, 0, 1]\)</span>.</p>
<p>Dois modelos de rede neural produziram as seguintes saídas:<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_1 = [0.5, 0.5, 0.5, 0.5, 0.5]\)</span>,<br>
<span class="math notranslate nohighlight">\(\hat{\mathbf{y}}_2 = [0.25, 0.75, 0.25, 0.25, 0.75]\)</span>.</p>
<p>Qual a entropia cruzada binária, considerando a formulação <span class="math notranslate nohighlight">\( \frac{1}{n}\sum_{j} -(y_j \ln \hat{y}_j + (1-y_j) \ln (1-\hat{y}_j)) \)</span>, com <span class="math notranslate nohighlight">\(j=1,...,n\)</span> para as saídas 1 e 2, respectivamente, arredondando para 2 casas decimais?</p>
<p>(a) 1: 0.3, 2: 0.12<br>
<font color='red'>(b) 1: 0.69, 2: 0.29<br></font>
(c) 1: 0.12, 2: 0.03<br>
(d) 1: 0.29, 2: 0.07<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">y_h</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span> <span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y_h</span><span class="p">)))</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_1</span><span class="p">),</span> <span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>

<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)

<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>

<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_1</span><span class="p">),</span> <span class="n">ce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat_2</span><span class="p">)</span>



<span class="ne">NameError</span>: name &#39;ce&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="perceptron-e-seu-treinamento">
<h1>Perceptron e seu Treinamento<a class="headerlink" href="#perceptron-e-seu-treinamento" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="id1">
<h2>1. Classe Perceptron<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Perceptron</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Construtor &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_features</span> <span class="o">=</span> <span class="n">num_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bias&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Feed-forward pass &quot;&quot;&quot;</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">return</span> <span class="n">logits</span>
    
    <span class="k">def</span> <span class="nf">squared_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Funcao de perda quadrática &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">labels</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Predição/inferencia convertendo para tipo tensorflow &quot;&quot;&quot;</span>
        <span class="n">X_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">X_tf</span><span class="p">)</span> <span class="c1">### chama o método __call()__</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Realiza o treinamento com o otimizador SGD&quot;&quot;&quot;</span>
        <span class="n">X_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">y_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">X_tf</span><span class="p">)</span>
        <span class="n">current_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">y_tf</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>

            <span class="c1"># mecanismo to TF para computar e armazenar gradiente</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                <span class="n">current_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">(</span><span class="n">X_tf</span><span class="p">),</span> <span class="n">y_tf</span><span class="p">)</span>

            <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_loss</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">])</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, Loss: </span><span class="si">{</span><span class="n">current_loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="uso-da-classe">
<h3>Uso da classe<a class="headerlink" href="#uso-da-classe" title="Permalink to this heading">#</a></h3>
<section id="dados-de-treinamento">
<h4>Dados de treinamento:<a class="headerlink" href="#dados-de-treinamento" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dados aleatórios</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span><span class="o">+</span><span class="n">delta</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_samples</span><span class="o">//</span><span class="mi">2</span><span class="p">)])</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="c1">#X_test = np.array([[0.1, 0.1], [1.25, 1.25]])</span>
<span class="c1">#y_test = np.array([0,1])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + testing data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>  <span class="c1"># &#39;c&#39; parameter controls the colors, &#39;cmap&#39; sets the color map</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>  <span class="c1"># &#39;c&#39; parameter controls the colors, &#39;cmap&#39; sets the color map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x1a19eae2a50&gt;
</pre></div>
</div>
<img alt="../_images/bb4e3bb919f5f5da89f754d6daa6da72a59bfac784867b0af748b6ad56842b87.svg" src="../_images/bb4e3bb919f5f5da89f754d6daa6da72a59bfac784867b0af748b6ad56842b87.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create and train the Perceptron</span>
<span class="n">perceptron</span> <span class="o">=</span> <span class="n">Perceptron</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">perceptron</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.6952412 ],
       [ 0.12461984],
       [-0.523608  ],
       [ 0.15988788],
       [-1.7138021 ],
       [-0.19160736],
       [ 0.7096729 ],
       [ 0.88143885],
       [ 0.46193656],
       [ 0.26305926],
       [ 0.49361765],
       [-0.65958977],
       [-0.3320099 ],
       [ 0.3912253 ],
       [-1.894666  ],
       [ 1.069214  ],
       [-0.08607818],
       [ 1.4752133 ],
       [ 0.35311115],
       [ 1.2860482 ]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perceptron</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0, Loss: 0.8342491388320923
Epoch: 200, Loss: 0.6022453308105469
Epoch: 400, Loss: 0.4466138780117035
Epoch: 600, Loss: 0.34071269631385803
Epoch: 800, Loss: 0.2682083547115326
Epoch: 1000, Loss: 0.2184402048587799
Epoch: 1200, Loss: 0.18424129486083984
Epoch: 1400, Loss: 0.16073016822338104
Epoch: 1600, Loss: 0.1445636749267578
Epoch: 1800, Loss: 0.13344649970531464
Epoch: 2000, Loss: 0.12580128014087677
Epoch: 2200, Loss: 0.12054365873336792
Epoch: 2400, Loss: 0.11692795902490616
Epoch: 2600, Loss: 0.1144413948059082
Epoch: 2800, Loss: 0.11273135244846344
Epoch: 3000, Loss: 0.1115553230047226
Epoch: 3200, Loss: 0.11074656248092651
Epoch: 3400, Loss: 0.11019035428762436
Epoch: 3600, Loss: 0.10980784893035889
Epoch: 3800, Loss: 0.1095447763800621
Epoch: 4000, Loss: 0.1093638688325882
Epoch: 4200, Loss: 0.10923943668603897
Epoch: 4400, Loss: 0.1091538667678833
Epoch: 4600, Loss: 0.1090950146317482
Epoch: 4800, Loss: 0.10905452817678452
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict após treinamento</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">perceptron</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="n">loss_test</span> <span class="o">=</span> <span class="n">perceptron</span><span class="o">.</span><span class="n">squared_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predictions: </span><span class="si">{</span><span class="n">predictions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True values: </span><span class="si">{</span><span class="n">y_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss test: </span><span class="si">{</span><span class="n">loss_test</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Predictions: [[-0.15537651]
 [ 0.5329551 ]
 [ 0.57763255]
 [ 0.5196074 ]
 [ 0.81417495]
 [ 0.7346054 ]
 [ 0.6176122 ]
 [ 0.39591345]
 [ 0.27742636]
 [ 0.6726368 ]
 [ 0.99988496]
 [-0.04575525]
 [ 0.46877724]
 [ 0.6395277 ]
 [ 0.3943296 ]
 [ 0.8491974 ]
 [-0.06762289]
 [ 1.0223639 ]
 [ 0.8599701 ]
 [ 0.44338906]]
True values: [0. 1. 1. 1. 1. 1. 1. 0. 0. 1. 1. 0. 1. 1. 0. 1. 0. 1. 1. 1.]
Loss test: 0.3452
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plotando os dados de teste</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Predicted data&#39;)
</pre></div>
</div>
<img alt="../_images/3f9152007764a509f9b5a4841fe901cae80143364939908f446778eb6180f281.svg" src="../_images/3f9152007764a509f9b5a4841fe901cae80143364939908f446778eb6180f281.svg" /></div>
</div>
</section>
</section>
<section id="id2">
<h3>Redes Neurais e Arquiteturas Profundas<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<section id="id3">
<h4><strong>MBA em Ciências de Dados</strong><a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="modulo-2">
<h3><em>Módulo 2</em><a class="headerlink" href="#modulo-2" title="Permalink to this heading">#</a></h3>
<p>Moacir A. Ponti - ICMC/USP</p>
</section>
</section>
<section id="mlp-com-dados-estruturados">
<h2>MLP com dados estruturados<a class="headerlink" href="#mlp-com-dados-estruturados" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1">#import tensorflow_datasets as tfds</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregar dataset Wine Quality</span>
<span class="c1">#ds, ds_info = tfds.load(&#39;wine_quality/red&#39;, split=&#39;train&#39;, </span>
<span class="c1">#                        as_supervised=True, with_info=True)</span>

<span class="n">path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\jmblima\OneDrive - Sefaz-SP\Área de Trabalho\MBA - USP\Redes Neurais\dados\winequality_white.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fixed acidity</th>
      <th>volatile acidity</th>
      <th>citric acid</th>
      <th>residual sugar</th>
      <th>chlorides</th>
      <th>free sulfur dioxide</th>
      <th>total sulfur dioxide</th>
      <th>density</th>
      <th>pH</th>
      <th>sulphates</th>
      <th>alcohol</th>
      <th>quality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7.0</td>
      <td>0.27</td>
      <td>0.36</td>
      <td>20.7</td>
      <td>0.045</td>
      <td>45.0</td>
      <td>170.0</td>
      <td>1.0010</td>
      <td>3.00</td>
      <td>0.45</td>
      <td>8.8</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6.3</td>
      <td>0.30</td>
      <td>0.34</td>
      <td>1.6</td>
      <td>0.049</td>
      <td>14.0</td>
      <td>132.0</td>
      <td>0.9940</td>
      <td>3.30</td>
      <td>0.49</td>
      <td>9.5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.1</td>
      <td>0.28</td>
      <td>0.40</td>
      <td>6.9</td>
      <td>0.050</td>
      <td>30.0</td>
      <td>97.0</td>
      <td>0.9951</td>
      <td>3.26</td>
      <td>0.44</td>
      <td>10.1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.2</td>
      <td>0.23</td>
      <td>0.32</td>
      <td>8.5</td>
      <td>0.058</td>
      <td>47.0</td>
      <td>186.0</td>
      <td>0.9956</td>
      <td>3.19</td>
      <td>0.40</td>
      <td>9.9</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7.2</td>
      <td>0.23</td>
      <td>0.32</td>
      <td>8.5</td>
      <td>0.058</td>
      <td>47.0</td>
      <td>186.0</td>
      <td>0.9956</td>
      <td>3.19</td>
      <td>0.40</td>
      <td>9.9</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#ds_info</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conversao para DataFrame</span>
<span class="c1">#df = tfds.as_dataframe(ds, ds_info)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;quality&#39;&gt;
</pre></div>
</div>
<img alt="../_images/a07fb297049543442a4e8522ef9caecb5f68e79c495bc1fe3104c43f177b0fd2.svg" src="../_images/a07fb297049543442a4e8522ef9caecb5f68e79c495bc1fe3104c43f177b0fd2.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Separar rótulo (Y) das features (X)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_normalized</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;quality&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="n">num_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_normalized</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Converter labels para one-hot</span>
<span class="n">y_onehot</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_normalized</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Divisao treinamento / teste</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">,</span> 
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Normalizacao</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>  <span class="c1"># ou StandardScaler()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dataset size = </span><span class="si">{</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset size = (3918, 11)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modelo de Rede Neural</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
    <span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)),</span>
    <span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense (Dense)               (None, 4)                 48        
                                                                 
 dense_1 (Dense)             (None, 7)                 35        
                                                                 
=================================================================
Total params: 83 (332.00 Byte)
Trainable params: 83 (332.00 Byte)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compilacao = definir parametros de treinamento e métricas</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> 
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># Fit = Treinamento do modelo definindo número de épocas e batch_size</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
392/392 [==============================] - 1s 923us/step - loss: 1.5334 - accuracy: 0.4201
Epoch 2/20
392/392 [==============================] - 0s 897us/step - loss: 1.3302 - accuracy: 0.4507
Epoch 3/20
392/392 [==============================] - 0s 851us/step - loss: 1.3060 - accuracy: 0.4507
Epoch 4/20
392/392 [==============================] - 0s 824us/step - loss: 1.2919 - accuracy: 0.4507
Epoch 5/20
392/392 [==============================] - 0s 826us/step - loss: 1.2798 - accuracy: 0.4507
Epoch 6/20
392/392 [==============================] - 0s 810us/step - loss: 1.2684 - accuracy: 0.4525
Epoch 7/20
392/392 [==============================] - 0s 824us/step - loss: 1.2578 - accuracy: 0.4518
Epoch 8/20
392/392 [==============================] - 0s 817us/step - loss: 1.2468 - accuracy: 0.4523
Epoch 9/20
392/392 [==============================] - 0s 864us/step - loss: 1.2363 - accuracy: 0.4581
Epoch 10/20
392/392 [==============================] - 0s 834us/step - loss: 1.2259 - accuracy: 0.4622
Epoch 11/20
392/392 [==============================] - 0s 850us/step - loss: 1.2165 - accuracy: 0.4770
Epoch 12/20
392/392 [==============================] - 0s 815us/step - loss: 1.2078 - accuracy: 0.4811
Epoch 13/20
392/392 [==============================] - 0s 807us/step - loss: 1.2001 - accuracy: 0.4934
Epoch 14/20
392/392 [==============================] - 0s 844us/step - loss: 1.1926 - accuracy: 0.4990
Epoch 15/20
392/392 [==============================] - 0s 810us/step - loss: 1.1871 - accuracy: 0.4997
Epoch 16/20
392/392 [==============================] - 0s 800us/step - loss: 1.1825 - accuracy: 0.5031
Epoch 17/20
392/392 [==============================] - 0s 827us/step - loss: 1.1776 - accuracy: 0.5084
Epoch 18/20
392/392 [==============================] - 0s 841us/step - loss: 1.1733 - accuracy: 0.5087
Epoch 19/20
392/392 [==============================] - 0s 793us/step - loss: 1.1696 - accuracy: 0.5048
Epoch 20/20
392/392 [==============================] - 0s 853us/step - loss: 1.1664 - accuracy: 0.5123
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.src.callbacks.History at 0x1f159e85150&gt;
</pre></div>
</div>
</div>
</div>
<section id="podemos-mudar-as-metricas-a-serem-acompanhadas">
<h3>Podemos mudar as métricas a serem acompanhadas<a class="headerlink" href="#podemos-mudar-as-metricas-a-serem-acompanhadas" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nn_model</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]):</span>
    <span class="c1"># Build the Neural Network model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">Dense</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="c1"># Compile the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(),</span> 
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Precision</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;precision&quot;</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Recall</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;recall&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the Neural Network model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn_model</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
392/392 [==============================] - 1s 1ms/step - loss: 1.5267 - precision: 0.2857 - recall: 0.0015
Epoch 2/20
392/392 [==============================] - 0s 947us/step - loss: 1.3105 - precision: 0.3595 - recall: 0.0222
Epoch 3/20
392/392 [==============================] - 0s 880us/step - loss: 1.2768 - precision: 0.3781 - recall: 0.0352
Epoch 4/20
392/392 [==============================] - 0s 849us/step - loss: 1.2592 - precision: 0.4059 - recall: 0.0595
Epoch 5/20
392/392 [==============================] - 0s 845us/step - loss: 1.2453 - precision: 0.4235 - recall: 0.0664
Epoch 6/20
392/392 [==============================] - 0s 820us/step - loss: 1.2325 - precision: 0.4519 - recall: 0.0684
Epoch 7/20
392/392 [==============================] - 0s 867us/step - loss: 1.2218 - precision: 0.4669 - recall: 0.0990
Epoch 8/20
392/392 [==============================] - 0s 839us/step - loss: 1.2128 - precision: 0.4738 - recall: 0.0947
Epoch 9/20
392/392 [==============================] - 0s 847us/step - loss: 1.2039 - precision: 0.5082 - recall: 0.1108
Epoch 10/20
392/392 [==============================] - 0s 862us/step - loss: 1.1970 - precision: 0.4916 - recall: 0.1337
Epoch 11/20
392/392 [==============================] - 0s 846us/step - loss: 1.1908 - precision: 0.5063 - recall: 0.1434
Epoch 12/20
392/392 [==============================] - 0s 863us/step - loss: 1.1847 - precision: 0.5174 - recall: 0.1557
Epoch 13/20
392/392 [==============================] - 0s 867us/step - loss: 1.1797 - precision: 0.5218 - recall: 0.1710
Epoch 14/20
392/392 [==============================] - 0s 865us/step - loss: 1.1751 - precision: 0.5323 - recall: 0.1912
Epoch 15/20
392/392 [==============================] - 0s 827us/step - loss: 1.1719 - precision: 0.5099 - recall: 0.1968
Epoch 16/20
392/392 [==============================] - 0s 850us/step - loss: 1.1670 - precision: 0.5431 - recall: 0.2057
Epoch 17/20
392/392 [==============================] - 0s 845us/step - loss: 1.1643 - precision: 0.5559 - recall: 0.2208
Epoch 18/20
392/392 [==============================] - 0s 841us/step - loss: 1.1617 - precision: 0.5468 - recall: 0.2386
Epoch 19/20
392/392 [==============================] - 0s 878us/step - loss: 1.1586 - precision: 0.5478 - recall: 0.2443
Epoch 20/20
392/392 [==============================] - 0s 845us/step - loss: 1.1563 - precision: 0.5379 - recall: 0.2499
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate the model</span>
<span class="n">loss</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">recall</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores :&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test loss:&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test metrics:&quot;</span><span class="p">,</span>  <span class="n">prec</span><span class="p">,</span> <span class="n">recall</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>31/31 [==============================] - 0s 1ms/step - loss: 1.1521 - precision: 0.5571 - recall: 0.2439
Valores :
Test loss: 1.1520522832870483
Test metrics: 0.557109534740448 0.24387754499912262
</pre></div>
</div>
</div>
</div>
</section>
<section id="analisando-o-modelo">
<h3>Analisando o modelo<a class="headerlink" href="#analisando-o-modelo" title="Permalink to this heading">#</a></h3>
<p>Aqui aparecem conceitos na prática:</p>
<ul class="simple">
<li><p><strong>batchsize</strong></p></li>
<li><p>número de épocas (<strong>epochs</strong>).</p></li>
</ul>
<p>Uma época ocorre após treinarmos o modelo com N instâncias</br>
onde N é o total de exemplos de treinamento</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3918, 11)
</pre></div>
</div>
</div>
</div>
<p>Temos 1279 exemplos de treinamento.</p>
<p>Por exemplo com batchsize = 10, precisaremos de 1279/10,</p>
<ul class="simple">
<li><p>128 iterações (mini-batchs selecionados) para perfazer uma <strong>época</strong></p></li>
</ul>
<p>Com o Keras podemos plotar as funções de perda ao longo do treinamento</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;model loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/27fa8a98263604e244317b96a65737549b7cd7cbdbfc0b3f829bc0954a661c84.svg" src="../_images/27fa8a98263604e244317b96a65737549b7cd7cbdbfc0b3f829bc0954a661c84.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e3273dae11d4b30bd40a30a9864fb31025edfe29a0aa001aacb8cc2106345104.svg" src="../_images/e3273dae11d4b30bd40a30a9864fb31025edfe29a0aa001aacb8cc2106345104.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computando as métricas para o teste</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Precisao: &quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Revocacao: &quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Precisao:  0.29591837525367737
Revocacao:  0.29591837525367737
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_pred_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_pred_class</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fb2c4c99830c9c262992a1d1c5669483ee1d6e42b56f87a36cd967b6f35bcd06.svg" src="../_images/fb2c4c99830c9c262992a1d1c5669483ee1d6e42b56f87a36cd967b6f35bcd06.svg" /></div>
</div>
</section>
<section id="desbalanceamento">
<h3>Desbalanceamento<a class="headerlink" href="#desbalanceamento" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_normalized</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">labels</span><span class="p">,</span><span class="n">counts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0, 1, 2, 3, 4, 5, 6], dtype=int64),
 array([  20,  163, 1457, 2198,  880,  175,    5], dtype=int64))
</pre></div>
</div>
</div>
</div>
<p>Uma das formas de mitigar é gerar pesos para as classes</p>
<p>Aqui faremos o peso inversamente proporcional à sua distribuição no treinamento</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_weight</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
    <span class="n">class_weight</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">total</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span>

<span class="n">class_weight</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: 0.9959167,
 1: 0.96672111,
 2: 0.70253165,
 3: 0.55124541,
 4: 0.82033483,
 5: 0.96427113,
 6: 0.99897918}
</pre></div>
</div>
</div>
</div>
</section>
<section id="outros-ajustes">
<h3>Outros ajustes:<a class="headerlink" href="#outros-ajustes" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Tamanho do batch e learning rate</p></li>
<li><p>Número de neurônios</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nn_model</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># Build the Neural Network model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                    <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
    
    <span class="k">for</span> <span class="n">lay</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">[</span><span class="n">lay</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
    
    <span class="c1"># Compile the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">),</span> 
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">nn_model</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/90
123/123 [==============================] - 1s 1ms/step - loss: 0.9933 - precision: 0.3920 - recall: 0.0241
Epoch 2/90
123/123 [==============================] - 0s 1ms/step - loss: 0.9282 - precision: 0.3750 - recall: 7.6570e-04
Epoch 3/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8955 - precision: 0.5143 - recall: 0.0092
Epoch 4/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8679 - precision: 0.5508 - recall: 0.0526
Epoch 5/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8550 - precision: 0.5109 - recall: 0.0957
Epoch 6/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8464 - precision: 0.5351 - recall: 0.1325
Epoch 7/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8397 - precision: 0.5357 - recall: 0.1434
Epoch 8/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8349 - precision: 0.5442 - recall: 0.1554
Epoch 9/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8299 - precision: 0.5490 - recall: 0.1631
Epoch 10/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8257 - precision: 0.5601 - recall: 0.1797
Epoch 11/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8204 - precision: 0.5536 - recall: 0.1884
Epoch 12/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8185 - precision: 0.5619 - recall: 0.1876
Epoch 13/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8163 - precision: 0.5620 - recall: 0.1840
Epoch 14/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8132 - precision: 0.5699 - recall: 0.1853
Epoch 15/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8115 - precision: 0.5715 - recall: 0.1968
Epoch 16/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8085 - precision: 0.5763 - recall: 0.2024
Epoch 17/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8057 - precision: 0.5666 - recall: 0.1955
Epoch 18/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8039 - precision: 0.5697 - recall: 0.2055
Epoch 19/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8030 - precision: 0.5700 - recall: 0.2108
Epoch 20/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8013 - precision: 0.5758 - recall: 0.2162
Epoch 21/90
123/123 [==============================] - 0s 1ms/step - loss: 0.8005 - precision: 0.5731 - recall: 0.2070
Epoch 22/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7992 - precision: 0.5695 - recall: 0.2124
Epoch 23/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7991 - precision: 0.5805 - recall: 0.2200
Epoch 24/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7980 - precision: 0.5744 - recall: 0.2218
Epoch 25/90
123/123 [==============================] - 0s 2ms/step - loss: 0.7965 - precision: 0.5702 - recall: 0.2147
Epoch 26/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7961 - precision: 0.5757 - recall: 0.2310
Epoch 27/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7951 - precision: 0.5837 - recall: 0.2198
Epoch 28/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7942 - precision: 0.5751 - recall: 0.2277
Epoch 29/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7912 - precision: 0.5887 - recall: 0.2363
Epoch 30/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7939 - precision: 0.5878 - recall: 0.2272
Epoch 31/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7926 - precision: 0.5795 - recall: 0.2381
Epoch 32/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7912 - precision: 0.5798 - recall: 0.2243
Epoch 33/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7898 - precision: 0.5833 - recall: 0.2369
Epoch 34/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7902 - precision: 0.5884 - recall: 0.2328
Epoch 35/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7891 - precision: 0.5848 - recall: 0.2376
Epoch 36/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7886 - precision: 0.5864 - recall: 0.2338
Epoch 37/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7866 - precision: 0.5871 - recall: 0.2392
Epoch 38/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7874 - precision: 0.5862 - recall: 0.2300
Epoch 39/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7849 - precision: 0.5903 - recall: 0.2504
Epoch 40/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7841 - precision: 0.5898 - recall: 0.2430
Epoch 41/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7847 - precision: 0.5881 - recall: 0.2402
Epoch 42/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7838 - precision: 0.5813 - recall: 0.2392
Epoch 43/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7814 - precision: 0.5997 - recall: 0.2394
Epoch 44/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7820 - precision: 0.5920 - recall: 0.2489
Epoch 45/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7815 - precision: 0.5879 - recall: 0.2458
Epoch 46/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7797 - precision: 0.5977 - recall: 0.2491
Epoch 47/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7797 - precision: 0.5979 - recall: 0.2611
Epoch 48/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7794 - precision: 0.6013 - recall: 0.2552
Epoch 49/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7776 - precision: 0.5830 - recall: 0.2555
Epoch 50/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7774 - precision: 0.5973 - recall: 0.2624
Epoch 51/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7778 - precision: 0.5922 - recall: 0.2639
Epoch 52/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7743 - precision: 0.6039 - recall: 0.2767
Epoch 53/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7763 - precision: 0.5875 - recall: 0.2570
Epoch 54/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7746 - precision: 0.5948 - recall: 0.2547
Epoch 55/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7747 - precision: 0.6035 - recall: 0.2665
Epoch 56/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7744 - precision: 0.5957 - recall: 0.2693
Epoch 57/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7729 - precision: 0.6044 - recall: 0.2690
Epoch 58/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7732 - precision: 0.5977 - recall: 0.2624
Epoch 59/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7721 - precision: 0.6054 - recall: 0.2667
Epoch 60/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7718 - precision: 0.6014 - recall: 0.2649
Epoch 61/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7721 - precision: 0.5871 - recall: 0.2726
Epoch 62/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7709 - precision: 0.5981 - recall: 0.2677
Epoch 63/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7704 - precision: 0.6013 - recall: 0.2749
Epoch 64/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7702 - precision: 0.6031 - recall: 0.2808
Epoch 65/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7685 - precision: 0.6025 - recall: 0.2797
Epoch 66/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7669 - precision: 0.6058 - recall: 0.2828
Epoch 67/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7681 - precision: 0.6027 - recall: 0.2779
Epoch 68/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7686 - precision: 0.5948 - recall: 0.2779
Epoch 69/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7672 - precision: 0.5899 - recall: 0.2772
Epoch 70/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7671 - precision: 0.5861 - recall: 0.2823
Epoch 71/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7669 - precision: 0.5829 - recall: 0.2754
Epoch 72/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7664 - precision: 0.5991 - recall: 0.2838
Epoch 73/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7655 - precision: 0.5943 - recall: 0.2800
Epoch 74/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7651 - precision: 0.5947 - recall: 0.2782
Epoch 75/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7644 - precision: 0.5983 - recall: 0.2805
Epoch 76/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7634 - precision: 0.5989 - recall: 0.2953
Epoch 77/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7638 - precision: 0.6051 - recall: 0.2874
Epoch 78/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7635 - precision: 0.5962 - recall: 0.2848
Epoch 79/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7641 - precision: 0.5960 - recall: 0.3012
Epoch 80/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7628 - precision: 0.5867 - recall: 0.2815
Epoch 81/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7626 - precision: 0.5909 - recall: 0.2994
Epoch 82/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7634 - precision: 0.5926 - recall: 0.2843
Epoch 83/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7628 - precision: 0.5994 - recall: 0.2856
Epoch 84/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7613 - precision: 0.6025 - recall: 0.2910
Epoch 85/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7614 - precision: 0.6001 - recall: 0.2915
Epoch 86/90
123/123 [==============================] - 0s 2ms/step - loss: 0.7608 - precision: 0.6008 - recall: 0.2912
Epoch 87/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7604 - precision: 0.6006 - recall: 0.3040
Epoch 88/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7593 - precision: 0.6029 - recall: 0.2864
Epoch 89/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7578 - precision: 0.6003 - recall: 0.3063
Epoch 90/90
123/123 [==============================] - 0s 1ms/step - loss: 0.7605 - precision: 0.5970 - recall: 0.2930
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computando as métricas para o teste</span>
<span class="n">score2</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Precisao: &quot;</span><span class="p">,</span> <span class="n">score2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Revocacao: &quot;</span><span class="p">,</span> <span class="n">score2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Precisao:  0.2928571403026581
Revocacao:  0.2928571403026581
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;model loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/97cf9e6ea40dfc86acb4afd8bf67a19b2be08d82f4a39cb957365deda9301782.svg" src="../_images/97cf9e6ea40dfc86acb4afd8bf67a19b2be08d82f4a39cb957365deda9301782.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ae41495519d17ab01106bf0b39dc9b8a842df942354e00ece5d9f37cbf874f07.svg" src="../_images/ae41495519d17ab01106bf0b39dc9b8a842df942354e00ece5d9f37cbf874f07.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_pred_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_pred_class</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c594ce86c72b6d6cacb260b4f50a4588d086267f3ce41378ae78211a4c412dec.svg" src="../_images/c594ce86c72b6d6cacb260b4f50a4588d086267f3ce41378ae78211a4c412dec.svg" /></div>
</div>
</section>
</section>
<section id="modulo-2-embeddings-de-modelos-pre-treinados-imagens">
<h2>Modulo 2 - Embeddings de Modelos Pré-treinados - Imagens<a class="headerlink" href="#modulo-2-embeddings-de-modelos-pre-treinados-imagens" title="Permalink to this heading">#</a></h2>
<section id="rede-convolucional-supervisionada-pre-treinada">
<h3>Rede Convolucional Supervisionada Pré-treinada<a class="headerlink" href="#rede-convolucional-supervisionada-pre-treinada" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the CIFAR-10 dataset from TensorFlow Datasets</span>
<span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;cifar10&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:10%]&#39;</span><span class="p">,</span> <span class="s1">&#39;test[:10%]&#39;</span><span class="p">],</span> 
                                         <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Funcao para exterair os labels apenas</span>
<span class="k">def</span> <span class="nf">extract_labels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="c1"># Obter os labels</span>
<span class="n">ds_train_labels</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">extract_labels</span><span class="p">)</span>
<span class="n">ds_test_labels</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">extract_labels</span><span class="p">)</span>
<span class="c1"># converter para numpy array</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ds_train_labels</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">()))</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ds_test_labels</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preprocessamento do dataset de imagens</span>
<span class="k">def</span> <span class="nf">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1"># tamanho das imagens 224x224</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
    <span class="c1"># usa o preprocessamento do modelo &quot;mobilenet_v2&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="o">.</span><span class="n">preprocess_input</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># Preprocessa imagens em batches</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carrega um modelo base, sem incluir o classificador (include_top = False)</span>
<span class="c1"># esse modelo foi pretreinado na ImageNet</span>
<span class="c1"># ver https://keras.io/api/applications/</span>
<span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
                                               <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1">#base_model.summary()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Como o modelo não tem a camada de classificacao, </span>
<span class="c1"># o predict aqui nos gera como saída os embeddings</span>
<span class="n">features_train</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ds_train</span><span class="p">)</span>
<span class="n">features_test</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>157/157 [==============================] - 199s 1s/step
32/32 [==============================] - 37s 1s/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Agora achatamos o resultado pois a saída são tensores e não vetores</span>
<span class="n">features_train_flat</span> <span class="o">=</span> <span class="n">features_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_train</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">features_test_flat</span> <span class="o">=</span> <span class="n">features_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_test</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_train_flat</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5000, 62720)
</pre></div>
</div>
</div>
</div>
</section>
<section id="aplicando-as-features-obtidas-em-um-classificador">
<h3>Aplicando as features obtidas em um classificador<a class="headerlink" href="#aplicando-as-features-obtidas-em-um-classificador" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Redução da dimensonalidade</p></li>
<li><p>Treinamento do classificador</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PCA para reduzir a dimensionalidade</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train_flat</span><span class="p">)</span>

<span class="c1"># Transformacao e obtencao dos componentes principais</span>
<span class="n">compressed_features_train</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_train_flat</span><span class="p">)</span>
<span class="n">compressed_features_test</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_test_flat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logreg_classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">logreg_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">compressed_features_train</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Avaliando o classificador</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">logreg_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">compressed_features_test</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test accuracy:&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.822
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modulo-2-embeddings-de-modelos-pre-treinados-texto">
<h2><em>Modulo 2</em> - Embeddings de Modelos Pré-treinados - Texto<a class="headerlink" href="#modulo-2-embeddings-de-modelos-pre-treinados-texto" title="Permalink to this heading">#</a></h2>
</section>
<section id="modelos-sentence-transformer">
<h2>Modelos Sentence Transformer<a class="headerlink" href="#modelos-sentence-transformer" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>sentence_transformers
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IMDb movie reviews dataset</span>
<span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;imdb_reviews&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:10%]&#39;</span><span class="p">,</span> <span class="s1">&#39;test[:5%]&#39;</span><span class="p">],</span>
                                         <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># pega numero de classes</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading and preparing dataset 80.23 MiB (download: 80.23 MiB, generated: Unknown size, total: 80.23 MiB) to /root/tensorflow_datasets/imdb_reviews/plain_text/1.0.0...
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "995cc0ca577344d3a08e34a42d53343f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ea653cbc6eee49d6bd554e864eeebacd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "da161c8d21e4434c8ad5e9d5df0ddbad", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "34ce58e11c614e8faf3c34d168cbb0e2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6b68e371e2c14533a83a9bd8a2d755e6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d34b7c294f81462e87ddef5b3d743e69", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "dd2c5e2f8f3c40308ffab57ea1dbf44a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "dcca3f3b4fcc4934a5b4eed3fcedf8b8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6e38c99a654e4fdb954f45419e0e9328", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset imdb_reviews downloaded and prepared to /root/tensorflow_datasets/imdb_reviews/plain_text/1.0.0. Subsequent calls will reuse this data.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extraindo textos e respectivos rotulos</span>
<span class="n">texts_train</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="p">])</span>
<span class="n">labels_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="p">])</span>

<span class="n">texts_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ds_test</span><span class="p">])</span>
<span class="n">labels_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_test</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">texts_train</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels_train</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([&quot;This was an absolutely terrible movie. Don&#39;t be lured in by Christopher Walken or Michael Ironside. Both are great actors, but this must simply be their worst role in history. Even their great acting could not redeem this movie&#39;s ridiculous storyline. This movie is an early nineties US propaganda piece. The most pathetic scenes were those when the Columbian rebels were making their cases for revolutions. Maria Conchita Alonso appeared phony, and her pseudo-love affair with Walken was nothing but a pathetic emotional plug in a movie that was devoid of any real meaning. I am disappointed that there are movies like this, ruining actor&#39;s like Christopher Walken&#39;s good name. I could barely sit through it.&quot;,
        &#39;I have been known to fall asleep during films, but this is usually due to a combination of things including, really tired, being warm and comfortable on the sette and having just eaten a lot. However on this occasion I fell asleep because the film was rubbish. The plot development was constant. Constantly slow and boring. Things seemed to happen, but with no explanation of what was causing them or why. I admit, I may have missed part of the film, but i watched the majority of it and everything just seemed to happen of its own accord without any real concern for anything else. I cant recommend this film at all.&#39;],
       dtype=&#39;&lt;U6620&#39;),
 array([0, 0]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels_train</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">counts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1265, 1235])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">texts_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">texts_test</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((2500,), (1250,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregando um Sentence Transformer</span>
<span class="c1"># modelos pré-treinados: https://www.sbert.net/docs/pretrained_models.html</span>
<span class="n">model_pretrained</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;distiluse-base-multilingual-cased-v1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c58ded57d65e448781b1a5e093357283", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "de06ee090d7142cb8ed01dffbf15cc39", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "88779446a1a6428babd55c09aed60c62", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1607fc9eecf34357a246f10eb742d402", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "677189550b2c462da8e5f9e507a4c377", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "382c6fe3ad32413c9205fb473dcaf1a6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0f4733d1e92743ba9c3dfa6ea9cddb3f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3926d1b0aecf42f1851c239be6a5a6c2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "09aa3ddfafd6492b842e9e2629cda629", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "017a379199cc44ca9113ebdf92ed5a77", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "970556baa8f542e583042b5dd3f0e837", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cf5160556daf411ba9ce920939f0bd9b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c129af4b791749118edeeaa3a4a00bc8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e1de6a70225041cba0463707630f4025", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtem os embeddings</span>
<span class="n">embeddings_train</span> <span class="o">=</span> <span class="n">model_pretrained</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">texts_train</span><span class="p">,</span> 
                                           <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">embeddings_test</span> <span class="o">=</span> <span class="n">model_pretrained</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">texts_test</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a0c60825d87840cd9270118e7528544c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5d97037f1b844c40bea90f555df102d1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<section id="id4">
<h3>Aplicando as features obtidas em um classificador<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Treinando um Logistic Regression Classifier com os embeddings obtidos</span>
<span class="n">logreg_classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">logreg_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeddings_train</span><span class="p">,</span> <span class="n">labels_train</span><span class="p">)</span>

<span class="c1"># predizendo para conjunto de teste e avaliando</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">logreg_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">embeddings_test</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test accuracy:&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.7736
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-darkred-modulo-ii-span">
<h2><span style="color:darkred">Módulo II</span><a class="headerlink" href="#span-style-color-darkred-modulo-ii-span" title="Permalink to this heading">#</a></h2>
<section id="id5">
<h3><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id6">
<h3>Questão 1)<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h3>
<p>Seja uma rede neural para classificação binária com seus parâmetros inicializados aleatoriamente e cuja saída tem um neurônio com ativação tangente hiperbólica. Executamos o passo “Forward” com uma única instância que sabemos ser positiva e o resultado foi 1.0. O que podemos dizer sobre esse modelo?</p>
<p>(a) O modelo está superconfiante na classe positiva e pode ser usado com sucesso para novas instâncias pois irá gerar saídas próximas a 1.0<br>
(b) O modelo acertou a classe da instância, indicando que pode ser usado com sucesso em novas instâncias, inclusive da classe negativa, desde que seja  substituida a função de ativação para sigmoide<br>
(c) O modelo acertou a classe da instância, indicando que pode ser usado com sucesso em novas instâncias, inclusive da classe negativa, desde que seja  substituida a função de ativação para softmax<br>
(d) O modelo está superconfiante nessa instância, porém seria necessário verificar sua saída também em uma única instância negativa para verificar se estaria pronto para ser utilizado amplamente<br>
<font color='red'>(e) O modelo está superconfiante nessa instância, mas seria necessário avaliar sua qualidade usando uma função de custo e um conjunto maior de treinamento<br></font></p>
<p><strong>Justificativa</strong>: Considerando que a ativação é hiperbólica, o valor máximo é 1.0, assim podemos considerar que o modelo está superconfiante nessa instância, tendo acertado sua classe. Não é possível dizer isso para toda a classe positiva, e asim apenas para a instância em questão, o que invalida a opção (a). Também não há garantias de que outras novas instâncias terão o mesmo sucesso, mesmo modificando a função de ativação para outras como sigmóide e softmax, invalidando as opções (b) e (c). Finalmente, avaliar sua saída em uma única instância negativa não nos dá garantias de que possa ser utilizado amplamente. De fato, a avaliação do modelo deve ser feita preferencialmente usando uma métrica ou função de custo sobre um conjunto mais amplo de dados, e assim a alternativa (e) é a correta.</p>
</section>
<hr class="docutils" />
<section id="id7">
<h3>Questão 2)<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<p>Qual o papel do <strong>gradiente</strong> no treinamento de redes neurais?</p>
<p><font color='red'>(a) Prover a direção e magnitude na qual cada parâmetro poderá ser adaptado de forma a reduzir o custo</font><br>
(b) Avaliar a qualidade do modelo atual, sendo que quanto menor o valor de sua saída, melhor é o modelo<br>
(c) Avaliar a qualidade do modelo atual, sendo que quanto maior o valor de sua saída, melhor é o modelo<br>
(d) Inicializar os parâmetros do modelo de forma a assegurar a melhor <br>
(e) Prover um novo valor, com base na função de custo, que irá substituir o parâmetro atual<br></p>
<p><strong>Justificativa</strong>: O gradiente não tem como objetivo avaliar qualidade (essa comumente é avaliada por uma função de custo), invalidando as alternativas (b) e (c). Também não tem ligação com a inicialização, invalidando a alternativa (d). O valor que gera o gradiente não é usado para substituir o parâmetro atual, portanto (e) é inválida. O gradiente é uma função que provê uma direção (sinal) e magnitude que é usado por um algoritmo de otimização para adaptar o parâmetro para minimizar a função de custo.</p>
</section>
<hr class="docutils" />
<section id="id8">
<h3>Questão 3)<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h3>
<p>Considere que vamos utilizar uma rede neural pré-treinada usando uma tarefa auto-supervisionada genérica para dados textuais. Primeiramente utilizamos uma rede neural que foi treinada para a tarefa de predizer palavras ocultadas em um texto com bases de dados públicas. A seguir, aproveitamos esse modelo para obter características com base no embedding da tarefa base, porém para um problema alvo diferente, o de classificação em texto. Podemos dizer que:</p>
<p>(a) Como raramente há dados abundantes para o pré-treinamento, o qual depende da variabilidade e quantidade de dados, esse processo pode não gerar bons resultados<br>
<font color='red'>(b) O modelo pré-treinado pode prover boas representações para a tarefa alvo devido à generalidade, variabilidade e quantidade de dados com o qual a tarefa base foi treinada.<br></font>
(c) O modelo pré-treinado pode não ter boa qualidade para a tarefa alvo em questão, pois nenhum dos rótulos foram obtidos por anotação manual/humana<br>
(d) O ideal é reinicializar o modelo pré-treinado para treiná-lo desde zero com a tarefa alvo usando aprendizado supervisionados<br>
(e) O modelo pré-treinado gera cortes no espaço de características original que possui tarefa diferente da tarefa alvo, assim será necessário treinar um classificador novo, do zero, usando uma nova tarefa auto-supervisionada.<br></p>
<p><strong>Justificativa</strong>: As tarefas auto-supervisionadas permitem gerar os alvos diretamente a partir dos dados, tornando a quantidade de dados disponíveis abundante - esse fato invalida a opção (a). O fato de não ser computado a partir de anotação humana não significa que as representações sejam ruins pois a quantidade e variabilidade dos dados de origem é o foco dessa abordagem - invalidando a opção (c).  O uso de modelos pré-treinados autosupervisionado é não treinar desde o zero - invalidando a opção (d). Igualmente, usar uma nova tarefa auto-supervisionada não é necessário se a tarefa inicial foi genérica - invalidando a opção (e). Assim, a opção válida é a (b)</p>
</section>
<hr class="docutils" />
<section id="id9">
<h3>Questão 4)<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h3>
<p>Qual o motivo de utilizar mais do que um neurônio Perceptron em paralelo numa camada oculta (antes da saída) da rede neural Multilayer Perceptron?</p>
<p>(a) Permitir o uso de aprendizado profundo, o qual possui vantagens sobre o aprendizado de máquina “raso”<br>
<font color='red'>(b) Cada neurônio aprende uma função linear independente utilizando como base os dados de entrada, permitindo aproximar funções mais complexas<br></font>
(c) Reduzir a dimensionalidade dos dados de entrada por meio de uma projeção das características, de forma a facilitar a classificação final no cenário multiclasse<br>
(d) Mais do que um neurônio permite treinar a rede neural profunda por meio de mini-batch stochastic gradient descent, permitindo um treinamento mais eficiente em particular em bases de dados grandes<br>
(e) Viabilizar um treinamento de um modelo com maior acurácia pois serão feitas múltiplas adaptações da rede neural para cada minibatch<br></p>
<p><strong>Justificativa</strong>: Cada neurônio Perceptron ajusta uma função linear. Ao aumentar a quantidade de neurônios estamos gerando uma nova função linear aprendida de forma paralela às demais. Isso permite aproximar funções cada vez mais complexas conforme aumentamos o número de neurônios. Alternativas incorretas: (a) ao aumentar a quantidade de neurônios temos um modelo maior em “largura” e não em profundidade; (c) ao aumentar a quantidade de neurônios, se aumenta a dimensionalidade, além disso não é esse o objetivo exato do incremento de neurônios e não se relaciona necessariamente com o cenário multiclasse; (d) o número de neurônios não se relaciona com o treinamento com algoritmos baseados em gradiente; (e) não necessariamente utilizar mais do que um neurônio viabiliza maior acurácia - no caso de um problema linearmente separável por exemplo um neurônio é suficiente.</p>
</section>
<hr class="docutils" />
<section id="id10">
<h3>Questão 5)<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h3>
<p>Instale o pacote <code class="docutils literal notranslate"><span class="pre">tensorflow_datasets</span></code>. Defina as sementes aleatórias do numpy para 3 e do tensorflow para 1, depois carregue a base de dados <code class="docutils literal notranslate"><span class="pre">wine_quality</span></code> da biblioteca Tensorflow Datasets, conforme código abaixo para entender o problema.</p>
<p>O objetivo dessa base de dados é obter a qualidade de um rótulo de vinho com base nas características de entrada. Assim, os valores alvo (target) são escalares, tipicamente entre 0 e 10 (representando um tipo de nota do vinho).  Para essa formulação, queremos que o valor alvo (target) seja um único número escalar (representando o valor da nota do vinho), portanto a saída da rede deve gerar um único número entre 0 e 10.</p>
<p>Utilizando a biblioteca Keras, formule um modelo de rede neural sequencial, do tipo MLP, com 3 camadas ocultas contendo, respectivamente, 128, 128 e 8 neurônios, todas com função de ativação do tipo <code class="docutils literal notranslate"><span class="pre">relu</span></code>. A rede deve ser montada de forma a ser capaz de resolver o problema com relação ao alvo, mas não é necessário treiná-la para essa questão.</p>
<p>Quantos parâmetros essa rede possui na primeira camada, e no total?</p>
<p>(a) primeira 1408, no total 1153<br>
(b) primeira 1408, no total 18824<br>
(c) primeira 1536, no total 18824<br>
<font color='red'>(d) primeira 1536, no total 19089<br></font>
(e) primeira 768, no total 3937<br></p>
<p><strong>Justificativa</strong>: ver código abaixo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="p">,</span> <span class="n">info_data</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;wine_quality&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">n_feats</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Quantidade de features: </span><span class="si">{</span><span class="n">n_feats</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">feat_type</span> <span class="ow">in</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">feat_type</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:absl:You use TensorFlow DType &lt;dtype: &#39;float32&#39;&gt; in tfds.features This will soon be deprecated in favor of NumPy DTypes. In the meantime it was converted to float32.
WARNING:absl:You use TensorFlow DType &lt;dtype: &#39;float64&#39;&gt; in tfds.features This will soon be deprecated in favor of NumPy DTypes. In the meantime it was converted to float64.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading and preparing dataset 258.23 KiB (download: 258.23 KiB, generated: 1.87 MiB, total: 2.13 MiB) to /root/tensorflow_datasets/wine_quality/white/1.0.0...
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8867892b967945c3b0ce426b7643a455", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "781d89c0a4e24471abada295a3621564", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0002203112224cb1860d3eb2da47953f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4cdd0e14907147cf9af950b5620cf0d7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c3df69a743f745f2b45452d451785cd3", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset wine_quality downloaded and prepared to /root/tensorflow_datasets/wine_quality/white/1.0.0. Subsequent calls will reuse this data.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
WARNING:absl:`FeatureConnector.dtype` is deprecated. Please change your code to use NumPy with the field `FeatureConnector.np_dtype` or use TensorFlow with the field `FeatureConnector.tf_dtype`.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Quantidade de features: 11
- fixed acidity: &lt;dtype: &#39;float32&#39;&gt;
- volatile acidity: &lt;dtype: &#39;float32&#39;&gt;
- citric acid: &lt;dtype: &#39;float32&#39;&gt;
- residual sugar: &lt;dtype: &#39;float32&#39;&gt;
- chlorides: &lt;dtype: &#39;float32&#39;&gt;
- free sulfur dioxide: &lt;dtype: &#39;float32&#39;&gt;
- total sulfur dioxide: &lt;dtype: &#39;float32&#39;&gt;
- density: &lt;dtype: &#39;float32&#39;&gt;
- pH: &lt;dtype: &#39;float32&#39;&gt;
- sulphates: &lt;dtype: &#39;float64&#39;&gt;
- alcohol: &lt;dtype: &#39;float32&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,)),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_4 (Dense)             (None, 128)               1536      
                                                                 
 dense_5 (Dense)             (None, 128)               16512     
                                                                 
 dense_6 (Dense)             (None, 8)                 1032      
                                                                 
 dense_7 (Dense)             (None, 1)                 9         
                                                                 
=================================================================
Total params: 19089 (74.57 KB)
Trainable params: 19089 (74.57 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="questao-5-as2">
<h3>Questão 5 - AS2<a class="headerlink" href="#questao-5-as2" title="Permalink to this heading">#</a></h3>
<p>Instale o pacote <code class="docutils literal notranslate"><span class="pre">tensorflow_datasets</span></code>. Defina as sementes aleatórias do numpy para 3 e do tensorflow para 1, depois carregue a base de dados <code class="docutils literal notranslate"><span class="pre">wine_quality</span></code> da biblioteca Tensorflow Datasets, conforme código abaixo para entender o problema.</p>
<p>O objetivo dessa base de dados é obter a qualidade de um rótulo de vinho com base nas características de entrada. Assim, os valores alvo (target) são escalares, tipicamente entre 0 e 10 (representando um tipo de nota do vinho).  Para essa formulação, queremos que o valor alvo (target) seja um único número escalar (representando o valor da nota do vinho), portanto a saída da rede deve gerar um único número entre 0 e 10.</p>
<p>Utilizando a biblioteca Keras, formule um modelo de rede neural sequencial, do tipo MLP, com 3 camadas ocultas contendo, respectivamente, 128, 128 e 8 neurônios, todas com função de ativação do tipo <code class="docutils literal notranslate"><span class="pre">relu</span></code>. A rede deve ser montada de forma a ser capaz de resolver o problema com relação ao alvo, mas não é necessário treiná-la para essa questão.</p>
<p>Quantos parâmetros essa rede possui na primeira camada, e no total?</p>
<p>(a) primeira 1408, no total 1153<br>
(b) primeira 1408, no total 18824<br>
(c) primeira 1536, no total 18824<br>
(d) primeira 1536, no total 19089<br>
(e) primeira 768, no total 3937<br></p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id11">
<h1>Implementação com Tensorflow e Keras<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">RMSprop</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">History</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregar dataset Wine Quality</span>

<span class="n">path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\jmblima\OneDrive - Sefaz-SP\Área de Trabalho\MBA - USP\Redes Neurais\dados\winequality_white.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Users\jmblima\OneDrive - Sefaz-SP\Área de Trabalho\MBA - USP\Redes Neurais\dados\winequality_red.csv&#39;</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fixed acidity</th>
      <th>volatile acidity</th>
      <th>citric acid</th>
      <th>residual sugar</th>
      <th>chlorides</th>
      <th>free sulfur dioxide</th>
      <th>total sulfur dioxide</th>
      <th>density</th>
      <th>pH</th>
      <th>sulphates</th>
      <th>alcohol</th>
      <th>quality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7.0</td>
      <td>0.27</td>
      <td>0.36</td>
      <td>20.7</td>
      <td>0.045</td>
      <td>45.0</td>
      <td>170.0</td>
      <td>1.0010</td>
      <td>3.00</td>
      <td>0.45</td>
      <td>8.8</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6.3</td>
      <td>0.30</td>
      <td>0.34</td>
      <td>1.6</td>
      <td>0.049</td>
      <td>14.0</td>
      <td>132.0</td>
      <td>0.9940</td>
      <td>3.30</td>
      <td>0.49</td>
      <td>9.5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.1</td>
      <td>0.28</td>
      <td>0.40</td>
      <td>6.9</td>
      <td>0.050</td>
      <td>30.0</td>
      <td>97.0</td>
      <td>0.9951</td>
      <td>3.26</td>
      <td>0.44</td>
      <td>10.1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.2</td>
      <td>0.23</td>
      <td>0.32</td>
      <td>8.5</td>
      <td>0.058</td>
      <td>47.0</td>
      <td>186.0</td>
      <td>0.9956</td>
      <td>3.19</td>
      <td>0.40</td>
      <td>9.9</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7.2</td>
      <td>0.23</td>
      <td>0.32</td>
      <td>8.5</td>
      <td>0.058</td>
      <td>47.0</td>
      <td>186.0</td>
      <td>0.9956</td>
      <td>3.19</td>
      <td>0.40</td>
      <td>9.9</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;quality&#39;&gt;
</pre></div>
</div>
<img alt="../_images/5b87d775eb8e198aaa890c2be447d30d62102e86ef3e7334728ded22af104d1e.svg" src="../_images/5b87d775eb8e198aaa890c2be447d30d62102e86ef3e7334728ded22af104d1e.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_normalized</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;quality&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Dividir o conjunto em teste e treino</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_normalized</span> <span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalizacao de X</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>  <span class="c1"># ou StandardScaler()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dataset size = </span><span class="si">{</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset size = (5197, 11)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## funcao para retornar modelo em Keras</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
    <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer1&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)),</span>
    <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer2&quot;</span><span class="p">),</span>
    <span class="c1">#Dense(8, activation=&#39;relu&#39;, name=&quot;layer3&quot;),</span>
    <span class="c1">#Dense(8, activation=&#39;relu&#39;, name=&quot;layer4&quot;),</span>
    <span class="c1">#Dense(8, activation=&#39;relu&#39;, name=&quot;layer5&quot;),</span>
    <span class="c1">#Dense(8, activation=&#39;relu&#39;, name=&quot;layer6&quot;),</span>
    <span class="c1">#Dense(8, activation=&#39;relu&#39;, name=&quot;layer7&quot;),</span>
    <span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;layer8&quot;</span><span class="p">),</span>
    <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Output&quot;</span><span class="p">)]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 layer1 (Dense)              (None, 128)               1536      
                                                                 
 layer2 (Dense)              (None, 128)               16512     
                                                                 
 layer8 (Dense)              (None, 8)                 1032      
                                                                 
 Output (Dense)              (None, 1)                 9         
                                                                 
=================================================================
Total params: 19089 (74.57 KB)
Trainable params: 19089 (74.57 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compilar modelo com configuracoes de otimizacao</span>
<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">])</span>

<span class="c1"># treinamento</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

<span class="c1"># avaliacao</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/100
21/21 [==============================] - 1s 2ms/step - loss: 23.3470 - mean_absolute_error: 4.7411
Epoch 2/100
21/21 [==============================] - 0s 2ms/step - loss: 18.5781 - mean_absolute_error: 4.2178
Epoch 3/100
21/21 [==============================] - 0s 1ms/step - loss: 15.3097 - mean_absolute_error: 3.8108
Epoch 4/100
21/21 [==============================] - 0s 1ms/step - loss: 12.4103 - mean_absolute_error: 3.4101
Epoch 5/100
21/21 [==============================] - 0s 1ms/step - loss: 9.8528 - mean_absolute_error: 3.0108
Epoch 6/100
21/21 [==============================] - 0s 2ms/step - loss: 7.6318 - mean_absolute_error: 2.6186
Epoch 7/100
21/21 [==============================] - 0s 2ms/step - loss: 5.7392 - mean_absolute_error: 2.2313
Epoch 8/100
21/21 [==============================] - 0s 2ms/step - loss: 4.1641 - mean_absolute_error: 1.8514
Epoch 9/100
21/21 [==============================] - 0s 2ms/step - loss: 2.9082 - mean_absolute_error: 1.4953
Epoch 10/100
21/21 [==============================] - 0s 2ms/step - loss: 1.9693 - mean_absolute_error: 1.1545
Epoch 11/100
21/21 [==============================] - 0s 1ms/step - loss: 1.3221 - mean_absolute_error: 0.8885
Epoch 12/100
21/21 [==============================] - 0s 2ms/step - loss: 0.9521 - mean_absolute_error: 0.7975
Epoch 13/100
21/21 [==============================] - 0s 1ms/step - loss: 0.8017 - mean_absolute_error: 0.7303
Epoch 14/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7760 - mean_absolute_error: 0.6960
Epoch 15/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7745 - mean_absolute_error: 0.6903
Epoch 16/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7751 - mean_absolute_error: 0.6875
Epoch 17/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7755 - mean_absolute_error: 0.6930
Epoch 18/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7747 - mean_absolute_error: 0.6907
Epoch 19/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7748 - mean_absolute_error: 0.6890
Epoch 20/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7746 - mean_absolute_error: 0.6915
Epoch 21/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7750 - mean_absolute_error: 0.6865
Epoch 22/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7747 - mean_absolute_error: 0.6895
Epoch 23/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7754 - mean_absolute_error: 0.6916
Epoch 24/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7753 - mean_absolute_error: 0.6917
Epoch 25/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7754 - mean_absolute_error: 0.6922
Epoch 26/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7747 - mean_absolute_error: 0.6887
Epoch 27/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7755 - mean_absolute_error: 0.6922
Epoch 28/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7753 - mean_absolute_error: 0.6886
Epoch 29/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7754 - mean_absolute_error: 0.6887
Epoch 30/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7754 - mean_absolute_error: 0.6915
Epoch 31/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7754 - mean_absolute_error: 0.6899
Epoch 32/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7751 - mean_absolute_error: 0.6894
Epoch 33/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7751 - mean_absolute_error: 0.6894
Epoch 34/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7755 - mean_absolute_error: 0.6906
Epoch 35/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7750 - mean_absolute_error: 0.6919
Epoch 36/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7752 - mean_absolute_error: 0.6896
Epoch 37/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7750 - mean_absolute_error: 0.6889
Epoch 38/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7752 - mean_absolute_error: 0.6893
Epoch 39/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7755 - mean_absolute_error: 0.6915
Epoch 40/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7746 - mean_absolute_error: 0.6918
Epoch 41/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7752 - mean_absolute_error: 0.6894
Epoch 42/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7752 - mean_absolute_error: 0.6872
Epoch 43/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7751 - mean_absolute_error: 0.6906
Epoch 44/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7741 - mean_absolute_error: 0.6886
Epoch 45/100
21/21 [==============================] - 0s 1ms/step - loss: 0.7750 - mean_absolute_error: 0.6904
Epoch 46/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7748 - mean_absolute_error: 0.6914
Epoch 47/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7744 - mean_absolute_error: 0.6867
Epoch 48/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7820 - mean_absolute_error: 0.6834
Epoch 49/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7749 - mean_absolute_error: 0.6891
Epoch 50/100
21/21 [==============================] - 0s 1ms/step - loss: 0.8006 - mean_absolute_error: 0.6959
Epoch 51/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7593 - mean_absolute_error: 0.6799
Epoch 52/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7501 - mean_absolute_error: 0.6603
Epoch 53/100
21/21 [==============================] - 0s 2ms/step - loss: 0.7129 - mean_absolute_error: 0.6256
Epoch 54/100
21/21 [==============================] - 0s 2ms/step - loss: 0.6883 - mean_absolute_error: 0.6164
Epoch 55/100
21/21 [==============================] - 0s 1ms/step - loss: 0.6530 - mean_absolute_error: 0.6046
Epoch 56/100
21/21 [==============================] - 0s 2ms/step - loss: 0.6254 - mean_absolute_error: 0.5992
Epoch 57/100
21/21 [==============================] - 0s 1ms/step - loss: 0.6248 - mean_absolute_error: 0.6063
Epoch 58/100
21/21 [==============================] - 0s 1ms/step - loss: 0.6156 - mean_absolute_error: 0.6036
Epoch 59/100
21/21 [==============================] - 0s 1ms/step - loss: 0.6074 - mean_absolute_error: 0.6021
Epoch 60/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5885 - mean_absolute_error: 0.5934
Epoch 61/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5839 - mean_absolute_error: 0.5887
Epoch 62/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5906 - mean_absolute_error: 0.5974
Epoch 63/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5885 - mean_absolute_error: 0.5968
Epoch 64/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5786 - mean_absolute_error: 0.5905
Epoch 65/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5656 - mean_absolute_error: 0.5872
Epoch 66/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5684 - mean_absolute_error: 0.5867
Epoch 67/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5609 - mean_absolute_error: 0.5847
Epoch 68/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5633 - mean_absolute_error: 0.5828
Epoch 69/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5746 - mean_absolute_error: 0.5912
Epoch 70/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5435 - mean_absolute_error: 0.5737
Epoch 71/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5504 - mean_absolute_error: 0.5756
Epoch 72/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5477 - mean_absolute_error: 0.5754
Epoch 73/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5479 - mean_absolute_error: 0.5772
Epoch 74/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5384 - mean_absolute_error: 0.5695
Epoch 75/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5435 - mean_absolute_error: 0.5742
Epoch 76/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5452 - mean_absolute_error: 0.5738
Epoch 77/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5360 - mean_absolute_error: 0.5703
Epoch 78/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5365 - mean_absolute_error: 0.5698
Epoch 79/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5322 - mean_absolute_error: 0.5667
Epoch 80/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5239 - mean_absolute_error: 0.5637
Epoch 81/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5232 - mean_absolute_error: 0.5634
Epoch 82/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5230 - mean_absolute_error: 0.5656
Epoch 83/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5219 - mean_absolute_error: 0.5646
Epoch 84/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5175 - mean_absolute_error: 0.5598
Epoch 85/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5211 - mean_absolute_error: 0.5658
Epoch 86/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5177 - mean_absolute_error: 0.5609
Epoch 87/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5069 - mean_absolute_error: 0.5558
Epoch 88/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5131 - mean_absolute_error: 0.5590
Epoch 89/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5119 - mean_absolute_error: 0.5605
Epoch 90/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5081 - mean_absolute_error: 0.5562
Epoch 91/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5070 - mean_absolute_error: 0.5571
Epoch 92/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5074 - mean_absolute_error: 0.5562
Epoch 93/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5006 - mean_absolute_error: 0.5554
Epoch 94/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5016 - mean_absolute_error: 0.5527
Epoch 95/100
21/21 [==============================] - 0s 1ms/step - loss: 0.4984 - mean_absolute_error: 0.5513
Epoch 96/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5005 - mean_absolute_error: 0.5505
Epoch 97/100
21/21 [==============================] - 0s 1ms/step - loss: 0.5013 - mean_absolute_error: 0.5552
Epoch 98/100
21/21 [==============================] - 0s 1ms/step - loss: 0.4912 - mean_absolute_error: 0.5479
Epoch 99/100
21/21 [==============================] - 0s 1ms/step - loss: 0.4917 - mean_absolute_error: 0.5477
Epoch 100/100
21/21 [==============================] - 0s 1ms/step - loss: 0.4877 - mean_absolute_error: 0.5461
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate the model on the test data using `evaluate`</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluate on test data&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test loss, test acc:&quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate on test data
13/13 [==============================] - 0s 1ms/step - loss: 0.4803 - mean_absolute_error: 0.5433
test loss, test acc: [0.48032376170158386, 0.5433313250541687]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>41/41 [==============================] - 0s 825us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;model loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1bb7a716e50f467b86ad99bd7e9c30abf8a27cdf5cd0db952c38dd10c6aa273c.svg" src="../_images/1bb7a716e50f467b86ad99bd7e9c30abf8a27cdf5cd0db952c38dd10c6aa273c.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Matriz de confusão</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">light_palette</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 600x1200 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/752f0762a741fe111061f744e0560e1459845b4065c2d241ddbb226ff23f65b7.svg" src="../_images/752f0762a741fe111061f744e0560e1459845b4065c2d241ddbb226ff23f65b7.svg" /></div>
</div>
<section id="span-style-color-darkred-modulo-2-span">
<h2><span style="color:darkred">Módulo 2</span><a class="headerlink" href="#span-style-color-darkred-modulo-2-span" title="Permalink to this heading">#</a></h2>
<section id="id12">
<h3><span style="color:darkred">Exercícios com soluções</span><a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h3>
</section>
<section id="id13">
<h3>Exercício 1)<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h3>
<p>Utilizando a biblioteca Keras, formule um modelo de rede neural sequencial, do tipo MLP, cuja entrada seja preparada para receber um vetor de 100 dimensões e que possua 2 camadas ocultas, cada uma com 50 neurônios, e 1 camada de saída, com 3 neurônios e função de ativação softmax.</p>
<p>Quantos parâmetros, no total, essa rede possui?</p>
<p>(a) 203<br>
(b) 10303<br>
(c) 7651<br>
<font color='red'>(d) 7753<br></font></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">model1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,)),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">model1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense (Dense)               (None, 50)                5050      
                                                                 
 dense_1 (Dense)             (None, 50)                2550      
                                                                 
 dense_2 (Dense)             (None, 3)                 153       
                                                                 
=================================================================
Total params: 7753 (30.29 KB)
Trainable params: 7753 (30.29 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id14">
<h3>Exercício 2)<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h3>
<p>Considerando que temos uma base de dados de treinamento com 8000 exemplos. Definindo o tamanho do lote (minibatch size) como sendo 50, quantas iterações o algoritmo backpropagation deverá executar, adaptando os parâmetros da rede, para completar 5 épocas?</p>
<p><font color='red'>(a) 800<br></font>
(a) 160<br>
(b) 801<br>
(c) 250<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">iteracoes_epoca</span> <span class="o">=</span> <span class="n">N</span><span class="o">/</span><span class="n">batchsize</span>
<span class="n">iteracoes_epoca</span> <span class="o">*</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>800.0
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id15">
<h3>Exercício 3)<a class="headerlink" href="#id15" title="Permalink to this heading">#</a></h3>
<p>Qual a diferença entre as funções de ativação <em>sigmoide</em> e <em>softmax</em> aplicadas a uma camada de uma rede neural?</p>
<p>(a) a sigmóide produz como saída vetores cuja somatória é 1 e que podem ser interpretados como uma distribuição de probabilidade, enquanto a softmax comprime os valores da saída entre 0 e 1 <br>
(b) a sigmóide produz como saída vetores cujos valores estão entre -1 e 1, enquanto a softmax comprime os valores da saída entre 0 e 1<br>
<font color='red'>(c) a sigmóide comprime os valores da saída entre 0 e 1, enquanto a softmax produz como saída vetores cuja somatória é 1 e que podem ser interpretados como uma distribuição de probabilidade<br></font>
(d) a sigmóide produz como saída vetores cujos valores individuais estão entre 0 e 1 utilizando uma função suave, enquanto a softmax produz vetores no formato one-hot-encoding compatíveis</p>
</section>
<hr class="docutils" />
<section id="id16">
<h3>Exercício 4)<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h3>
<p>Qual a diferença entre os algoritmos Gradient Descent e Stochastic Gradient Descent?</p>
<p>(a) O Stochastic Gradient Descent utiliza a perda quadrática para realizar o treinamento, enquanto o Gradient Descent utiliza a função da entropia cruzada para otimizar os parâmetros<br>
(b) O Gradient Descent utiliza a perda quadrática para realizar o treinamento, enquanto o Stochastic Gradient Descent utiliza a função da entropia cruzada para otimizar os parâmetros<br>
<font color='red'>(c) O Gradient Descent carrega todos os dados de treinamento na memória para realizar o cômputo da função de custo e adaptar os parâmetros, enquanto o Stochastic Gradient Descent seleciona aleatoriamente um subconjunto de instâncias para realizar cada iteração.</font><br>
(d) O Stochastic Gradient Descent carrega todos os dados de treinamento na memória para realizar o cômputo da função de custo e adaptar os parâmetros, enquanto o Gradient Descent seleciona aleatoriamente um subconjunto de instâncias para realizar cada iteração.<br></p>
<p><strong>Justificativa</strong>: Auto-supervisão tem a intenção de diminuir a dependência de grandes quantidades de dados rotulados, permitindo que se utilize dados raspados da Internet ou obtidos de forma automática para gerar um modelo inicial que possa ser transferido para tarefas específicas.</p>
</section>
<hr class="docutils" />
<section id="id17">
<h3>Exercício 5)<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h3>
<p>Para qual cenário a auto-supervisão é uma técnica útil?</p>
<p>(a) Processar dados não estruturados de qualquer origem criando um classificador diretamente a partir dos dados sem a necessidade de rotulação, e posteriormente classificar novas imagens utilizando esse modelo.<br>
(b) Pré-processar grandes bases de dados de forma a eliminar outliers, ruído e outros efeitos indesejados nessa base de dados, garantindo maior acurácia para dados futuros.<br>
<font color='red'>(c) Coletar e utilizar grandes quantidades de dados não anotados, e obter um modelo inicial que possa ser utilizado como base para adaptar modelos para problemas específicos, vencendo a barreira de anotar dados massivamente.</font><br>
(d) Para base de dados pequenas em que não se dispõe de grande quantidades de exemplos para treinar redes neurais profundas para tarefas de classificação e regressão, pois essa técnica realiza aumento de dados de forma nativa.<br></p>
<p><strong>Justificativa</strong>: Auto-supervisão tem a intenção de diminuir a dependência de grandes quantidades de dados rotulados, permitindo que se utilize dados raspados da Internet ou obtidos de forma automática para gerar um modelo inicial que possa ser transferido para tarefas específicas.</p>
</section>
<hr class="docutils" />
<section id="id18">
<h3>Exercício 6)<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h3>
<p>Instale o pacote <code class="docutils literal notranslate"><span class="pre">tensorflow_datasets</span></code>. Defina as sementes aleatórias do numpy para 1 e do tensorflow para 2, depois carregue a base de dados <code class="docutils literal notranslate"><span class="pre">iris</span></code> da biblioteca Tensorflow Datasets, conforme código abaixo.</p>
<p>O objetivo dessa base de dados é classificar flores a partir de 4 características de entrada referentes à tamanhos de sépala e pétala. Assim, os valores alvo (target) são 3 classes possíveis.</p>
<p>Considerando o valor alvo descrito, e que você tem disponíveis as funções de ativação: sigmóide, relu, tangente hiperbólica e softmax, escolha as funções mais adequadas e monte uma arquitetura da rede com 2 camadas ocultas com 12 neurônios na primeira, e 8 neurônios na segunda.</p>
<p>Como deve ficar a arquitetura da rede neural?</p>
<p>(a) 2 camadas com 12 e 8 neurônios, 164 parâmetros e função de ativação relu na camada de saída<br>
(b) 3 camadas com 12, 8 e 1 neurônios, 173 parâmetros e função de ativação sigmóide na camada de saída<br>
(c) 4 camadas com 4, 12, 8 e 3 neurônios, 211 parâmetros e função de ativação softmax na camada de saída<br>
<font color='red'>(d) 3 camadas com 12, 8 e 3 neurônios, 191 parâmetros e função de ativação softmax na camada de saída<br></font></p>
<p><strong>Justificativa</strong>: como a saída precisa ser uma de 3 classes, temos a última camada com a função softmax. A primeira camada recebe as 4 features diretamente, seguida por 12 e 8 neuronios. Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">),</span> <span class="n">info_data</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:90%]&#39;</span><span class="p">,</span><span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de treinamento: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de teste: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>

<span class="n">n_class</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Número de classes: </span><span class="si">{</span><span class="n">n_class</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">n_feats</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantidade de features: </span><span class="si">{</span><span class="n">n_feats</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">IPython</span>\<span class="n">core</span>\<span class="n">interactiveshell</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3526</span> <span class="ow">in</span> <span class="n">run_code</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">code_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>

  <span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>
    <span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">43</span>
    <span class="kn">import</span> <span class="nn">tensorflow_datasets.core.logging</span> <span class="k">as</span> <span class="nn">_tfds_logging</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">22</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core</span> <span class="kn">import</span> <span class="n">community</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">community</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">18</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core.community.huggingface_wrapper</span> <span class="kn">import</span> <span class="n">mock_builtin_to_use_gfile</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">community</span>\<span class="n">huggingface_wrapper</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">31</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core</span> <span class="kn">import</span> <span class="n">dataset_builder</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">dataset_builder</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">44</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core</span> <span class="kn">import</span> <span class="n">split_builder</span> <span class="k">as</span> <span class="n">split_builder_lib</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">split_builder</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">37</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core</span> <span class="kn">import</span> <span class="n">writer</span> <span class="k">as</span> <span class="n">writer_lib</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">writer</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">33</span>
    <span class="kn">from</span> <span class="nn">tensorflow_datasets.core</span> <span class="kn">import</span> <span class="n">shuffle</span>

  <span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="n">core</span>\<span class="n">shuffle</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">79</span>
    <span class="s1">&#39;Soft limit for the maximum number of open file descriptors for&#39;</span>
    <span class="o">^</span>
<span class="ne">IndentationError</span>: unexpected indent
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,)),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">model2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="p">[</span>
<span class="ne">----&gt; </span><span class="mi">3</span>         <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,)),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">model2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;n_feats&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id19">
<h3>Exercício 7)<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h3>
<p>Utilizando a base de dados <code class="docutils literal notranslate"><span class="pre">iris</span></code> do tensorflow datasets, e o modelo de rede neural criado na questão anterior, compile o modelo utilizando uma função de custo de entropia cruzada categórico (categorical_crossentropy), o otimizador SGD e a taxa de aprendizado 0.01.</p>
<p>Utilize os dados para treinar a rede neural por 30 épocas, com batch-size 8.</p>
<p>Avalie o modelo após treinado, usando o conjunto de teste e o método <code class="docutils literal notranslate"><span class="pre">model.evaluate()</span></code>, Escolha a opção que se encaixe no intervalo de valores obtidos para observada no teste.</p>
<p><font color='red'>(a) loss = (0.18, 0.22)<br></font>
(b) loss = (0.05, 0.13)<br>
(c) loss = (0.9, 1.25)<br>
(d) loss = (0.0, 0.04)<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">),</span> <span class="n">info_data</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:90%]&#39;</span><span class="p">,</span><span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de treinamento: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de teste: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>

<span class="n">n_class</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Número de classes: </span><span class="si">{</span><span class="n">n_class</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">n_feats</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantidade de features: </span><span class="si">{</span><span class="n">n_feats</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ImportError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">),</span> <span class="n">info_data</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:90%]&#39;</span><span class="p">,</span><span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">miniconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">tensorflow_datasets</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">43</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="n">_TIMESTAMP_IMPORT_STARTS</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="ne">---&gt; </span><span class="mi">43</span> <span class="kn">import</span> <span class="nn">tensorflow_datasets.core.logging</span> <span class="k">as</span> <span class="nn">_tfds_logging</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span> <span class="kn">from</span> <span class="nn">tensorflow_datasets.core.logging</span> <span class="kn">import</span> <span class="n">call_metadata</span> <span class="k">as</span> <span class="n">_call_metadata</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span> <span class="n">_metadata</span> <span class="o">=</span> <span class="n">_call_metadata</span><span class="o">.</span><span class="n">CallMetadata</span><span class="p">()</span>

<span class="ne">ImportError</span>: cannot import name &#39;core&#39; from partially initialized module &#39;tensorflow_datasets&#39; (most likely due to a circular import) (C:\Users\jmblima\AppData\Local\miniconda3\Lib\site-packages\tensorflow_datasets\__init__.py)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_hot_encoded_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="n">one_hot_encoded_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">one_hot_encoded_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">one_hot_encoded_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

<span class="ne">NameError</span>: name &#39;train_data&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">one_hot_encoded_train</span> <span class="o">=</span> <span class="n">one_hot_encoded_train</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">one_hot_encoded_test</span> <span class="o">=</span> <span class="n">one_hot_encoded_test</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,)),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">model2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense (Dense)               (None, 12)                60        
                                                                 
 dense_1 (Dense)             (None, 8)                 104       
                                                                 
 dense_2 (Dense)             (None, 3)                 27        
                                                                 
=================================================================
Total params: 191 (764.00 Byte)
Trainable params: 191 (764.00 Byte)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">one_hot_encoded_train</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
17/17 [==============================] - 1s 3ms/step - loss: 0.9664
Epoch 2/30
17/17 [==============================] - 0s 2ms/step - loss: 0.8085
Epoch 3/30
17/17 [==============================] - 0s 2ms/step - loss: 0.7043
Epoch 4/30
17/17 [==============================] - 0s 2ms/step - loss: 0.6309
Epoch 5/30
17/17 [==============================] - 0s 2ms/step - loss: 0.5749
Epoch 6/30
17/17 [==============================] - 0s 2ms/step - loss: 0.5292
Epoch 7/30
17/17 [==============================] - 0s 2ms/step - loss: 0.4899
Epoch 8/30
17/17 [==============================] - 0s 2ms/step - loss: 0.4562
Epoch 9/30
17/17 [==============================] - 0s 2ms/step - loss: 0.4276
Epoch 10/30
17/17 [==============================] - 0s 2ms/step - loss: 0.4018
Epoch 11/30
17/17 [==============================] - 0s 2ms/step - loss: 0.3794
Epoch 12/30
17/17 [==============================] - 0s 2ms/step - loss: 0.3601
Epoch 13/30
17/17 [==============================] - 0s 2ms/step - loss: 0.3417
Epoch 14/30
17/17 [==============================] - 0s 2ms/step - loss: 0.3257
Epoch 15/30
17/17 [==============================] - 0s 2ms/step - loss: 0.3106
Epoch 16/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2968
Epoch 17/30
17/17 [==============================] - 0s 3ms/step - loss: 0.2841
Epoch 18/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2721
Epoch 19/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2608
Epoch 20/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2504
Epoch 21/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2406
Epoch 22/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2315
Epoch 23/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2229
Epoch 24/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2148
Epoch 25/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2072
Epoch 26/30
17/17 [==============================] - 0s 2ms/step - loss: 0.2001
Epoch 27/30
17/17 [==============================] - 0s 2ms/step - loss: 0.1934
Epoch 28/30
17/17 [==============================] - 0s 2ms/step - loss: 0.1871
Epoch 29/30
17/17 [==============================] - 0s 2ms/step - loss: 0.1813
Epoch 30/30
17/17 [==============================] - 0s 2ms/step - loss: 0.1758
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">one_hot_encoded_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17/17 [==============================] - 0s 2ms/step - loss: 0.1829
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.18289700150489807
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">one_hot_encoded_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/2 [==============================] - 0s 4ms/step - loss: 0.2033
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.20334936678409576
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id20">
<h3>Exercício 8)<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h3>
<p>Utilizando a base de dados <code class="docutils literal notranslate"><span class="pre">iris</span></code> do tensorflow datasets, e o mesmo modelo de rede neural criado na questão anterior, compile o modelo utilizando uma função de custo de entropia cruzada categórico (categorical_crossentropy), o otimizador SGD e a taxa de aprendizado 0.01. Adicione a métrica <code class="docutils literal notranslate"><span class="pre">accuracy</span></code></p>
<p>Utilize os dados para treinar a rede neural por 30 épocas, com batch-size <strong>16</strong>.</p>
<p>Avalie o modelo após treinado, usando o conjunto de teste e o método <code class="docutils literal notranslate"><span class="pre">model.evaluate()</span></code>, Escolha a opção que se encaixe no intervalo de valores obtidos para acurácia no treinamento e teste, respectivamente.</p>
<p><font color='red'>(a) accuracy train = (94, 97), test = (91, 94)<br></font>
(b) accuracy train = (94, 97), test = (87, 90) <br>
(c) accuracy train = (91, 92), test = (91, 94) <br>
(d) accuracy train = (87, 90), test = (91, 92) <br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">),</span> <span class="n">info_data</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:90%]&#39;</span><span class="p">,</span><span class="s1">&#39;train[90%:]&#39;</span><span class="p">],</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de treinamento: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho do conjunto de teste: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>

<span class="n">n_class</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Número de classes: </span><span class="si">{</span><span class="n">n_class</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">n_feats</span> <span class="o">=</span> <span class="n">info_data</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantidade de features: </span><span class="si">{</span><span class="n">n_feats</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho do conjunto de treinamento:  135
Tamanho do conjunto de teste:  15
Número de classes: 3
Quantidade de features: 4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_hot_encoded_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="n">one_hot_encoded_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">one_hot_encoded_train</span> <span class="o">=</span> <span class="n">one_hot_encoded_train</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">one_hot_encoded_test</span> <span class="o">=</span> <span class="n">one_hot_encoded_test</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_feats</span><span class="p">,)),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">model2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense_3 (Dense)             (None, 12)                60        
                                                                 
 dense_4 (Dense)             (None, 8)                 104       
                                                                 
 dense_5 (Dense)             (None, 3)                 27        
                                                                 
=================================================================
Total params: 191 (764.00 Byte)
Trainable params: 191 (764.00 Byte)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">one_hot_encoded_train</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
9/9 [==============================] - 1s 3ms/step - loss: 0.9591 - accuracy: 0.4963
Epoch 2/30
9/9 [==============================] - 0s 3ms/step - loss: 0.8393 - accuracy: 0.6667
Epoch 3/30
9/9 [==============================] - 0s 3ms/step - loss: 0.7647 - accuracy: 0.6667
Epoch 4/30
9/9 [==============================] - 0s 2ms/step - loss: 0.7076 - accuracy: 0.7185
Epoch 5/30
9/9 [==============================] - 0s 3ms/step - loss: 0.6643 - accuracy: 0.8074
Epoch 6/30
9/9 [==============================] - 0s 3ms/step - loss: 0.6320 - accuracy: 0.7630
Epoch 7/30
9/9 [==============================] - 0s 3ms/step - loss: 0.6053 - accuracy: 0.7333
Epoch 8/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5824 - accuracy: 0.6963
Epoch 9/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5623 - accuracy: 0.6963
Epoch 10/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5447 - accuracy: 0.7111
Epoch 11/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5291 - accuracy: 0.7185
Epoch 12/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5152 - accuracy: 0.7333
Epoch 13/30
9/9 [==============================] - 0s 3ms/step - loss: 0.5026 - accuracy: 0.7556
Epoch 14/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4912 - accuracy: 0.7852
Epoch 15/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4806 - accuracy: 0.8000
Epoch 16/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4707 - accuracy: 0.8148
Epoch 17/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4614 - accuracy: 0.8370
Epoch 18/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4527 - accuracy: 0.8519
Epoch 19/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4442 - accuracy: 0.8519
Epoch 20/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4362 - accuracy: 0.8667
Epoch 21/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4284 - accuracy: 0.8815
Epoch 22/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4208 - accuracy: 0.8889
Epoch 23/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4134 - accuracy: 0.9037
Epoch 24/30
9/9 [==============================] - 0s 3ms/step - loss: 0.4062 - accuracy: 0.9111
Epoch 25/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3991 - accuracy: 0.9259
Epoch 26/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3921 - accuracy: 0.9333
Epoch 27/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3853 - accuracy: 0.9481
Epoch 28/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3785 - accuracy: 0.9556
Epoch 29/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3718 - accuracy: 0.9556
Epoch 30/30
9/9 [==============================] - 0s 3ms/step - loss: 0.3651 - accuracy: 0.9556
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">one_hot_encoded_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9/9 [==============================] - 0s 2ms/step - loss: 0.3600 - accuracy: 0.9630
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.35997042059898376, 0.9629629850387573]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">one_hot_encoded_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/2 [==============================] - 0s 4ms/step - loss: 0.2144 - accuracy: 0.9333
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.21440784633159637, 0.9333333373069763]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modulo-3-redes-neurais-convolucionais-cnns">
<h2><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em><a class="headerlink" href="#modulo-3-redes-neurais-convolucionais-cnns" title="Permalink to this heading">#</a></h2>
<section id="mlp-vs-cnn">
<h3><strong>MLP vs CNN</strong><a class="headerlink" href="#mlp-vs-cnn" title="Permalink to this heading">#</a></h3>
</section>
</section>
<section id="exemplo-de-uso-de-redes-neurais-profundas-para-classificacao-de-imagens">
<h2>Exemplo de uso de redes neurais profundas para classificação de imagens<a class="headerlink" href="#exemplo-de-uso-de-redes-neurais-profundas-para-classificacao-de-imagens" title="Permalink to this heading">#</a></h2>
<section id="como-tratar-bases-de-imagens-antes-de-comecar-a-processar">
<h3>1. Como tratar bases de imagens antes de começar a processar<a class="headerlink" href="#como-tratar-bases-de-imagens-antes-de-comecar-a-processar" title="Permalink to this heading">#</a></h3>
</section>
<section id="comparacao-rede-densa-mlp-vs-rede-convolucional-cnn">
<h3>2. Comparação: Rede Densa (MLP) vs Rede Convolucional (CNN)<a class="headerlink" href="#comparacao-rede-densa-mlp-vs-rede-convolucional-cnn" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># testando o uso de GPU</span>
<span class="n">device_name</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">gpu_device_name</span><span class="p">()</span>
<span class="k">if</span> <span class="n">device_name</span> <span class="o">!=</span> <span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s1">&#39;GPU device not found&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found GPU at: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">SystemError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">4</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">device_name</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">gpu_device_name</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">if</span> <span class="n">device_name</span> <span class="o">!=</span> <span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">4</span>       <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s1">&#39;GPU device not found&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found GPU at: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device_name</span><span class="p">))</span>

<span class="ne">SystemError</span>: GPU device not found
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregando dataset a partir de TensorFlow Datasets</span>
<span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fashion_mnist&#39;</span><span class="p">,</span> 
                                         <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:15%]&#39;</span><span class="p">,</span> <span class="s1">&#39;test[:30%]&#39;</span><span class="p">],</span> 
                                         <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Downloading and preparing dataset Unknown size (download: Unknown size, generated: Unknown size, total: Unknown size) to C:\Users\jmblima\tensorflow_datasets\fashion_mnist\3.0.1...</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e7c84a0ecc7f48a684864c033f45ae5f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "69dbefb40fb84118847b879582b25723", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0dcbe89b755441808f741443297c816c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "14b16792232d47f2989fbd0e4642b062", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "204e97cd66034f90b17d96ccf007c887", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3edc9c87eb264d99bafb1e671ee5c21c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bbcc2a968d9c464faee21847b96eadf3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "028544fc12444088bd4e52105f45b2e6", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Dataset fashion_mnist downloaded and prepared to C:\Users\jmblima\tensorflow_datasets\fashion_mnist\3.0.1. Subsequent calls will reuse this data.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># extrai primeiras 10 imagens para exibir</span>
<span class="n">list_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">list_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">list_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    
<span class="n">show_images</span><span class="p">(</span><span class="n">list_images</span><span class="p">,</span> <span class="n">list_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8e6247397308b5d9555227cf4770a6a127d8bd4257d84f35e883dc7a3f52fd48.svg" src="../_images/8e6247397308b5d9555227cf4770a6a127d8bd4257d84f35e883dc7a3f52fd48.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resolucao da imagem</span>
<span class="n">image_resolution</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Tamanho do dataset</span>
<span class="n">num_train_examples_total</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_examples</span>
<span class="n">num_test_examples_total</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_examples</span>
<span class="c1"># TAmanho do dataset realmente carregado</span>
<span class="n">num_train_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_train</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">num_test_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># Número de classes</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolução: </span><span class="si">{</span><span class="n">image_resolution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training Set: </span><span class="si">{</span><span class="n">num_train_examples</span><span class="si">}</span><span class="s2"> exemplos de </span><span class="si">{</span><span class="n">num_train_examples_total</span><span class="si">}</span><span class="s2"> totais&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing Set: </span><span class="si">{</span><span class="n">num_test_examples</span><span class="si">}</span><span class="s2"> exemplos de </span><span class="si">{</span><span class="n">num_test_examples_total</span><span class="si">}</span><span class="s2"> totais&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classes: </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resolução: (28, 28, 1)
Training Set: 9000 exemplos de 60000 totais
Testing Set: 3000 exemplos de 10000 totais
Classes: 10
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Sabendo as características do dataset, agora, o passo ideal é <strong>pré-processar</strong> as imagens para facilitar o processo de otimização das redes neurais:</p>
<ol class="arabic simple">
<li><p>Normalizar seus valores (para o intervalo 0-1)</p></li>
<li><p>Alterar a codificação das classes (para one-hot-encoding): teremos 10 neurônios na saída, não apenas 1</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Exibindo dados originais</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">16</span><span class="p">,:</span><span class="mi">10</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[  0]
 [  0]
 [  0]
 [  0]
 [ 83]
 [ 71]
 [136]
 [194]
 [126]
 [ 46]]
2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one_hot_label</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
    
<span class="c1"># Pre-processa imagens</span>
<span class="k">def</span> <span class="nf">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1"># converte imagem para float32</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Exibindo dados processados</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">16</span><span class="p">,:</span><span class="mi">10</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0.        ]
 [0.        ]
 [0.        ]
 [0.        ]
 [0.3254902 ]
 [0.2784314 ]
 [0.53333336]
 [0.7607844 ]
 [0.49411768]
 [0.18039216]]
[0. 0. 1. 0. 0. 0. 0. 0. 0. 0.]
</pre></div>
</div>
</div>
</div>
</section>
<section id="tudo-pronto-agora-vamos-comecar">
<h3>Tudo pronto, agora vamos começar<a class="headerlink" href="#tudo-pronto-agora-vamos-comecar" title="Permalink to this heading">#</a></h3>
<p>OBS: poderíamos ter feito mais etapas de pré-processamento aqui, como por exemplo normalização z-score das imagens, remoção de outliers, etc.</p>
</section>
<section id="vamos-aos-concorrentes">
<h3>Vamos aos concorrentes<a class="headerlink" href="#vamos-aos-concorrentes" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Multilayer Perceptron, com (pelo menos) 60 anos de vida, uma densa experiência e muitas conexões</p></li>
<li><p>Rede convolucional, mais jovem porém com menos graus de liberdade e maior quantidade de representações intermediárias por camada.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># concorrente número um, no canto direito!</span>
<span class="n">MLP</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>

<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">image_resolution</span><span class="p">))</span> 
<span class="c1"># precisamos achatar a imagem para um vetor antes de começar</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span> 
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 flatten (Flatten)           (None, 784)               0         
                                                                 
 dense (Dense)               (None, 256)               200960    
                                                                 
 dense_1 (Dense)             (None, 256)               65792     
                                                                 
 dense_2 (Dense)             (None, 256)               65792     
                                                                 
 dense_3 (Dense)             (None, 256)               65792     
                                                                 
 dense_4 (Dense)             (None, 10)                2570      
                                                                 
=================================================================
Total params: 400906 (1.53 MB)
Trainable params: 400906 (1.53 MB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># o concorrente novato, no canto esquerdo!</span>
<span class="n">CNN</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>

<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                            <span class="n">input_shape</span><span class="o">=</span><span class="n">image_resolution</span><span class="p">))</span>
<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                            <span class="n">input_shape</span><span class="o">=</span><span class="n">image_resolution</span><span class="p">))</span>
<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>

<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">CNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">CNN</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d (Conv2D)             (None, 13, 13, 32)        320       
                                                                 
 conv2d_1 (Conv2D)           (None, 6, 6, 64)          18496     
                                                                 
 conv2d_2 (Conv2D)           (None, 6, 6, 64)          36928     
                                                                 
 flatten_1 (Flatten)         (None, 2304)              0         
                                                                 
 dense_5 (Dense)             (None, 128)               295040    
                                                                 
 dense_6 (Dense)             (None, 10)                1290      
                                                                 
=================================================================
Total params: 352074 (1.34 MB)
Trainable params: 352074 (1.34 MB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="preparando-o-dataset-e-os-modelos">
<h3>1) Preparando o dataset e os modelos<a class="headerlink" href="#preparando-o-dataset-e-os-modelos" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># as sementes ajudam a ter resultados reproduzíveis</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># vamos usar o mesmo número de épocas e batchsize para ambos</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># definindo o batch size para iterar sobre o dataset</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compilando os modelos</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">CNN</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="e-la-vamos-nos-em-quem-voce-apostaria">
<h2><strong>E lá vamos nós</strong>: em quem você apostaria?<a class="headerlink" href="#e-la-vamos-nos-em-quem-voce-apostaria" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">histMLP</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">scoreMLP_Tr</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">scoreMLP_Te</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">histCNN</span> <span class="o">=</span> <span class="n">CNN</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> 
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">scoreCNN_Tr</span> <span class="o">=</span> <span class="n">CNN</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">scoreCNN_Te</span> <span class="o">=</span> <span class="n">CNN</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histMLP</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histCNN</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;MLP&quot;</span><span class="p">,</span> <span class="s2">&quot;CNN&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Perda ao longo das épocas&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Perda ao longo das épocas&#39;)
</pre></div>
</div>
<img alt="../_images/be865539cc8c5023e983521474c6fdbe8ec73866b89591ffdb67535ee9a500e1.svg" src="../_images/be865539cc8c5023e983521474c6fdbe8ec73866b89591ffdb67535ee9a500e1.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP Acurácia treinamento: </span><span class="si">{</span><span class="p">(</span><span class="n">scoreMLP_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP Acurácia teste: </span><span class="si">{</span><span class="p">(</span><span class="n">scoreMLP_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN Acurácia treinamento: </span><span class="si">{</span><span class="p">(</span><span class="n">scoreCNN_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN Acurácia teste: </span><span class="si">{</span><span class="p">(</span><span class="n">scoreCNN_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MLP Acurácia treinamento: 89.82%
MLP Acurácia teste: 83.73%

CNN Acurácia treinamento: 91.59%
CNN Acurácia teste: 84.10%
</pre></div>
</div>
</div>
</div>
<section id="id21">
<h3>Redes Neurais e Arquiteturas Profundas<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h3>
<section id="id22">
<h4><strong>MBA em Ciências de Dados</strong><a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="id23">
<h3><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em><a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h3>
<p><strong>Explorando alternativas para arquiteturas de CNNs</strong></p>
<p>Moacir A. Ponti</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="carregar-e-preparar-base-de-dados">
<h2>1. Carregar e preparar base de dados<a class="headerlink" href="#carregar-e-preparar-base-de-dados" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregando dataset a partir de TensorFlow Datasets</span>
<span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;cifar10&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:20%]&#39;</span><span class="p">,</span> <span class="s1">&#39;test[:25%]&#39;</span><span class="p">],</span> 
                                         <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the image resolution</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Get the size of each set</span>
<span class="n">num_train_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_train</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">num_test_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># Get the number of classes</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>

<span class="c1"># Print the obtained information</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolução: </span><span class="si">{</span><span class="n">input_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training Set: </span><span class="si">{</span><span class="n">num_train_examples</span><span class="si">}</span><span class="s2"> exemplos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing Set: </span><span class="si">{</span><span class="n">num_test_examples</span><span class="si">}</span><span class="s2"> exemplos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classes: </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resolução: (32, 32, 3)
Training Set: 10000 exemplos
Testing Set: 2500 exemplos
Classes: 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># extrai primeiras 10 imagens para exibir</span>
<span class="n">list_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">list_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">list_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    
<span class="n">show_images</span><span class="p">(</span><span class="n">list_images</span><span class="p">,</span> <span class="n">list_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-10-02 11:46:29.151908: W tensorflow/core/kernels/data/cache_dataset_ops.cc:854] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/67d7a87dcbdf26cc702b03aba49cac06c2faef97bf271e05f09a2fe29b884433.png" src="../_images/67d7a87dcbdf26cc702b03aba49cac06c2faef97bf271e05f09a2fe29b884433.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one_hot_label</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
    
<span class="c1"># Pre-processa imagens</span>
<span class="k">def</span> <span class="nf">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1"># converte imagem para float32</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="preparar-os-batches">
<h3>Preparar os batches<a class="headerlink" href="#preparar-os-batches" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># vamos usar o mesmo número de épocas e batchsize para ambos</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>

<span class="c1"># definindo o batch size para iterar sobre o dataset</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="projetar-redes-neurais">
<h2>2. Projetar redes neurais<a class="headerlink" href="#projetar-redes-neurais" title="Permalink to this heading">#</a></h2>
<section id="cnn-estilo-vggnet">
<h3>2.1 - CNN estilo “VGGNet”<a class="headerlink" href="#cnn-estilo-vggnet" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CNN1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                             <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_11&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_110 (Conv2D)         (None, 30, 30, 32)        896       
                                                                 
 max_pooling2d_40 (MaxPooli  (None, 15, 15, 32)        0         
 ng2D)                                                           
                                                                 
 conv2d_111 (Conv2D)         (None, 15, 15, 64)        18496     
                                                                 
 conv2d_112 (Conv2D)         (None, 15, 15, 64)        36928     
                                                                 
 conv2d_113 (Conv2D)         (None, 15, 15, 64)        36928     
                                                                 
 max_pooling2d_41 (MaxPooli  (None, 7, 7, 64)          0         
 ng2D)                                                           
                                                                 
 conv2d_114 (Conv2D)         (None, 7, 7, 64)          36928     
                                                                 
 conv2d_115 (Conv2D)         (None, 7, 7, 64)          36928     
                                                                 
 conv2d_116 (Conv2D)         (None, 7, 7, 64)          36928     
                                                                 
 max_pooling2d_42 (MaxPooli  (None, 3, 3, 64)          0         
 ng2D)                                                           
                                                                 
 flatten_18 (Flatten)        (None, 576)               0         
                                                                 
 dense_36 (Dense)            (None, 64)                36928     
                                                                 
 dense_37 (Dense)            (None, 10)                650       
                                                                 
=================================================================
Total params: 241610 (943.79 KB)
Trainable params: 241610 (943.79 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="substituicao-de-maxpooling-por-strides-1">
<h3>2.2 - Substituição de MaxPooling por strides &gt; 1<a class="headerlink" href="#substituicao-de-maxpooling-por-strides-1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algumas alternativas: uso de stride ao invés de MaxPooling e uso de tamanhos de filtro diferentes: ao inves de 3x3, usamos 1x3, 3x1 e 1x1</span>
<span class="n">CNN2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_13&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_122 (Conv2D)         (None, 30, 30, 32)        896       
                                                                 
 conv2d_123 (Conv2D)         (None, 15, 15, 64)        18496     
                                                                 
 conv2d_124 (Conv2D)         (None, 15, 15, 64)        36928     
                                                                 
 conv2d_125 (Conv2D)         (None, 8, 8, 64)          36928     
                                                                 
 conv2d_126 (Conv2D)         (None, 8, 8, 64)          36928     
                                                                 
 conv2d_127 (Conv2D)         (None, 4, 4, 64)          36928     
                                                                 
 flatten_20 (Flatten)        (None, 1024)              0         
                                                                 
 dense_40 (Dense)            (None, 64)                65600     
                                                                 
 dense_41 (Dense)            (None, 10)                650       
                                                                 
=================================================================
Total params: 233354 (911.54 KB)
Trainable params: 233354 (911.54 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="uso-de-convolucoes-por-partes-1x3-3x1-1x1">
<h3>2.3 - Uso de convoluções por partes 1x3, 3x1, 1x1<a class="headerlink" href="#uso-de-convolucoes-por-partes-1x3-3x1-1x1" title="Permalink to this heading">#</a></h3>
<p>(como usado por Inception, mas aqui não estão em paralelo, apenas em sequência)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Algumas alternativas: uso de stride ao invés de MaxPooling e </span>
<span class="c1"># uso de tamanhos de filtro diferentes: ao inves de 3x3, usamos 1x3, 3x1 e 1x1</span>
<span class="n">CNN3</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                             <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  
                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_19&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_195 (Conv2D)         (None, 30, 30, 32)        896       
                                                                 
 max_pooling2d_57 (MaxPooli  (None, 15, 15, 32)        0         
 ng2D)                                                           
                                                                 
 conv2d_196 (Conv2D)         (None, 15, 15, 32)        3104      
                                                                 
 conv2d_197 (Conv2D)         (None, 15, 15, 32)        3104      
                                                                 
 conv2d_198 (Conv2D)         (None, 15, 15, 32)        1056      
                                                                 
 max_pooling2d_58 (MaxPooli  (None, 7, 7, 32)          0         
 ng2D)                                                           
                                                                 
 conv2d_199 (Conv2D)         (None, 7, 7, 64)          6208      
                                                                 
 conv2d_200 (Conv2D)         (None, 7, 7, 64)          12352     
                                                                 
 conv2d_201 (Conv2D)         (None, 7, 7, 64)          4160      
                                                                 
 flatten_28 (Flatten)        (None, 3136)              0         
                                                                 
 dense_56 (Dense)            (None, 64)                200768    
                                                                 
 dense_57 (Dense)            (None, 10)                650       
                                                                 
=================================================================
Total params: 232298 (907.41 KB)
Trainable params: 232298 (907.41 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="blocos-residuais-estilo-resnet">
<h3>2.4 - Blocos Residuais (estilo ResNet)<a class="headerlink" href="#blocos-residuais-estilo-resnet" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># skip conection</span>
    <span class="n">skip_connection</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="c1"># Primeira camada convolucional</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> 
                            <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> 
                            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Segunda camada convolucional</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> 
                            <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> 
                            <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Adição da saída antes das camadas</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">skip_connection</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>Para usar a função <code class="docutils literal notranslate"><span class="pre">residual_block</span></code> é melhor montar a rede usando o modo “funcional”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ResNetCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    
    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">input_tensor</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Blocos residuais + MaxPooling</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Achatar a saída do bloco residual</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Camada densa/fully connected</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">output_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>  
    
    <span class="c1"># Cria o modelo com base na entrada e saída</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_tensor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CNN_res</span> <span class="o">=</span> <span class="n">ResNetCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN_res</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_7&quot;
__________________________________________________________________________________________________
 Layer (type)                Output Shape                 Param #   Connected to                  
==================================================================================================
 input_13 (InputLayer)       [(None, 32, 32, 3)]          0         []                            
                                                                                                  
 conv2d_148 (Conv2D)         (None, 32, 32, 32)           896       [&#39;input_13[0][0]&#39;]            
                                                                                                  
 conv2d_149 (Conv2D)         (None, 32, 32, 32)           9248      [&#39;conv2d_148[0][0]&#39;]          
                                                                                                  
 batch_normalization_32 (Ba  (None, 32, 32, 32)           128       [&#39;conv2d_149[0][0]&#39;]          
 tchNormalization)                                                                                
                                                                                                  
 activation_31 (Activation)  (None, 32, 32, 32)           0         [&#39;batch_normalization_32[0][0]
                                                                    &#39;]                            
                                                                                                  
 conv2d_150 (Conv2D)         (None, 32, 32, 32)           9248      [&#39;activation_31[0][0]&#39;]       
                                                                                                  
 batch_normalization_33 (Ba  (None, 32, 32, 32)           128       [&#39;conv2d_150[0][0]&#39;]          
 tchNormalization)                                                                                
                                                                                                  
 add_14 (Add)                (None, 32, 32, 32)           0         [&#39;batch_normalization_33[0][0]
                                                                    &#39;,                            
                                                                     &#39;conv2d_148[0][0]&#39;]          
                                                                                                  
 activation_32 (Activation)  (None, 32, 32, 32)           0         [&#39;add_14[0][0]&#39;]              
                                                                                                  
 max_pooling2d_45 (MaxPooli  (None, 16, 16, 32)           0         [&#39;activation_32[0][0]&#39;]       
 ng2D)                                                                                            
                                                                                                  
 conv2d_151 (Conv2D)         (None, 16, 16, 32)           9248      [&#39;max_pooling2d_45[0][0]&#39;]    
                                                                                                  
 batch_normalization_34 (Ba  (None, 16, 16, 32)           128       [&#39;conv2d_151[0][0]&#39;]          
 tchNormalization)                                                                                
                                                                                                  
 activation_33 (Activation)  (None, 16, 16, 32)           0         [&#39;batch_normalization_34[0][0]
                                                                    &#39;]                            
                                                                                                  
 conv2d_152 (Conv2D)         (None, 16, 16, 32)           9248      [&#39;activation_33[0][0]&#39;]       
                                                                                                  
 batch_normalization_35 (Ba  (None, 16, 16, 32)           128       [&#39;conv2d_152[0][0]&#39;]          
 tchNormalization)                                                                                
                                                                                                  
 add_15 (Add)                (None, 16, 16, 32)           0         [&#39;batch_normalization_35[0][0]
                                                                    &#39;,                            
                                                                     &#39;max_pooling2d_45[0][0]&#39;]    
                                                                                                  
 activation_34 (Activation)  (None, 16, 16, 32)           0         [&#39;add_15[0][0]&#39;]              
                                                                                                  
 max_pooling2d_46 (MaxPooli  (None, 8, 8, 32)             0         [&#39;activation_34[0][0]&#39;]       
 ng2D)                                                                                            
                                                                                                  
 flatten_22 (Flatten)        (None, 2048)                 0         [&#39;max_pooling2d_46[0][0]&#39;]    
                                                                                                  
 dense_44 (Dense)            (None, 128)                  262272    [&#39;flatten_22[0][0]&#39;]          
                                                                                                  
 dense_45 (Dense)            (None, 10)                   1290      [&#39;dense_44[0][0]&#39;]            
                                                                                                  
==================================================================================================
Total params: 301962 (1.15 MB)
Trainable params: 301706 (1.15 MB)
Non-trainable params: 256 (1.00 KB)
__________________________________________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="blocos-separaveis-em-profundidade-estilo-xception-mobilenet">
<h3>2.5 - Blocos Separáveis em Profundidade (estilo Xception/MobileNet)<a class="headerlink" href="#blocos-separaveis-em-profundidade-estilo-xception-mobilenet" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">input_tensor</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Blocos separaveis em profundidade + MaxPooling</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DepthwiseConv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                     <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DepthwiseConv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                     <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Achatar a saída do bloco residual</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Camada densa/fully connected</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">output_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>  
    
    <span class="c1"># Cria o modelo com base na entrada e saída</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_tensor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CNN_x</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN_x</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_8&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_14 (InputLayer)       [(None, 32, 32, 3)]       0         
                                                                 
 conv2d_153 (Conv2D)         (None, 32, 32, 32)        896       
                                                                 
 depthwise_conv2d_4 (Depthw  (None, 32, 32, 32)        320       
 iseConv2D)                                                      
                                                                 
 batch_normalization_36 (Ba  (None, 32, 32, 32)        128       
 tchNormalization)                                               
                                                                 
 activation_35 (Activation)  (None, 32, 32, 32)        0         
                                                                 
 max_pooling2d_47 (MaxPooli  (None, 16, 16, 32)        0         
 ng2D)                                                           
                                                                 
 depthwise_conv2d_5 (Depthw  (None, 16, 16, 32)        320       
 iseConv2D)                                                      
                                                                 
 batch_normalization_37 (Ba  (None, 16, 16, 32)        128       
 tchNormalization)                                               
                                                                 
 activation_36 (Activation)  (None, 16, 16, 32)        0         
                                                                 
 max_pooling2d_48 (MaxPooli  (None, 8, 8, 32)          0         
 ng2D)                                                           
                                                                 
 flatten_23 (Flatten)        (None, 2048)              0         
                                                                 
 dense_46 (Dense)            (None, 128)               262272    
                                                                 
 dense_47 (Dense)            (None, 10)                1290      
                                                                 
=================================================================
Total params: 265354 (1.01 MB)
Trainable params: 265226 (1.01 MB)
Non-trainable params: 128 (512.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="compilando-modelos">
<h1>3. Compilando Modelos<a class="headerlink" href="#compilando-modelos" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># as sementes ajudam a ter resultados reproduzíveis</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">CNN1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">CNN2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">CNN3</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">CNN_res</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">CNN_x</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="executando-o-treinamento">
<h1>4. Executando o treinamento<a class="headerlink" href="#executando-o-treinamento" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist1</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score1_Tr</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">score1_Te</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist2</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score2_Tr</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">score2_Te</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist3</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score3_Tr</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">score3_Te</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist4</span> <span class="o">=</span> <span class="n">CNN_res</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score4_Tr</span> <span class="o">=</span> <span class="n">CNN_res</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">score4_Te</span> <span class="o">=</span> <span class="n">CNN_res</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist5</span> <span class="o">=</span> <span class="n">CNN_x</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score5_Tr</span> <span class="o">=</span> <span class="n">CNN_x</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">score5_Te</span> <span class="o">=</span> <span class="n">CNN_x</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist1</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;-.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist4</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;--r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist5</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;-g&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;max.p&quot;</span><span class="p">,</span> <span class="s2">&quot;strides&quot;</span><span class="p">,</span> <span class="s2">&quot;conv.lat&quot;</span><span class="p">,</span> <span class="s2">&quot;resnet&quot;</span><span class="p">,</span> <span class="s2">&quot;sep.conv&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f443b5869d0&gt;
</pre></div>
</div>
<img alt="../_images/ea8c9407829986e1761c74ecb1f378509d073ddaf28faa40b8da9571277b0fdf.png" src="../_images/ea8c9407829986e1761c74ecb1f378509d073ddaf28faa40b8da9571277b0fdf.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Treinamento&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN max.pool : </span><span class="si">{</span><span class="p">(</span><span class="n">score1_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN strides  : </span><span class="si">{</span><span class="p">(</span><span class="n">score2_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN conv.lat : </span><span class="si">{</span><span class="p">(</span><span class="n">score3_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN resnet   : </span><span class="si">{</span><span class="p">(</span><span class="n">score4_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN sep.conv : </span><span class="si">{</span><span class="p">(</span><span class="n">score5_Tr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Teste&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN max.pool : </span><span class="si">{</span><span class="p">(</span><span class="n">score1_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN strides  : </span><span class="si">{</span><span class="p">(</span><span class="n">score2_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN conv.lat : </span><span class="si">{</span><span class="p">(</span><span class="n">score3_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN resnet   : </span><span class="si">{</span><span class="p">(</span><span class="n">score4_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CNN sep.conv : </span><span class="si">{</span><span class="p">(</span><span class="n">score5_Te</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia Treinamento
CNN max.pool : 39.1
CNN strides  : 40.0
CNN conv.lat : 36.9
CNN resnet   : 71.0
CNN sep.conv : 67.7

Acurácia Teste
CNN max.pool : 38.7
CNN strides  : 40.1
CNN conv.lat : 38.0
CNN resnet   : 55.2
CNN sep.conv : 56.0
</pre></div>
</div>
</div>
</div>
<section id="span-style-color-darkred-modulo-3-redes-neurais-convolucionais-cnns-span">
<h2><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span><a class="headerlink" href="#span-style-color-darkred-modulo-3-redes-neurais-convolucionais-cnns-span" title="Permalink to this heading">#</a></h2>
</section>
<section id="id24">
<h2><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
</section>
<section id="id25">
<h2>Questão 1)<a class="headerlink" href="#id25" title="Permalink to this heading">#</a></h2>
<p>Considere duas camadas independentes de redes neurais profundas:</p>
<p>A. Camada densa com 128 neurônios, cuja entrada é um vetor de 676 dimensões;<br>
B. Camada convolucional com 128 neurônios (filtros) de tamanho 3x3, cuja entrada é uma matriz de 26x26 valores</p>
<p>Qual o total de parâmetros a serem aprendidos em cada camada?</p>
<p>(a) A = 86528 parâmetros; B = 1280 parâmetros <br>
(b) A = 86528 parâmetros; B = 6760 parâmetros <br>
(c) A = 86528 parâmetros; B = 33280 parâmetros <br>
<font color='red'>(d) A = 86656 parâmetros; B = 1280 parâmetros <br></font>
(e) A = 86656 parâmetros; B = 6760 parâmetros <br></p>
<p><strong>Justificativa:</strong> se a entrada possui 676 dimensões, então cada neurônio de uma camada densa tem 676 pesos, mais 1 termo bias = 677, o que multiplicado por 128 neurônios gera 86656. No caso de uma camada convolucional, independente do tamanho da entrada, se há 128 neurônios com filtros 3x3, então cada um deles terá 9 parâmetros + 1 bias = 10 valores, totalizando 1280 parâmetros.</p>
<hr class="docutils" />
</section>
<section id="id26">
<h2>Questão 2)<a class="headerlink" href="#id26" title="Permalink to this heading">#</a></h2>
<p>Considere o conceito de “campo receptivo local” como uma região de certo tamanho dos dados de entrada que é processada de forma a gerar a saída. Considere ainda dois tipos de unidades de processamento de redes neurais profundas:</p>
<p>A. Camada densa (tipo Perceptron), que recebe por entrada um vetor com 16384 dimensões<br>
B. Camada convolucional com filtro de tamanho 3x3 com padding, que recebe por entrada uma imagem com 128 x 128 dimensões.<br>
C. Sequência de duas camadas: a primeira convolucional com filtros de tamanho 5x5 sem padding, que recebe por entrada uma imagem com 128 x 128 dimensões, seguida de uma camada densa (tipo Perceptron), que recebe por entrada o vetor composto por todos os valores achatados (flatten) da camada convolucional anterior.</p>
<p>Qual é o tamanho do campo receptivo local nos dados de entrada, para cada valor de saída das camadas computado por A, B e C?</p>
<p>Em C a saída é referente à segunda camada, portanto considerar o processamento de ambas.</p>
<p><font color='red'>(a) A = 16384; B = 3 x 3; C = 128 x 128 </font><br>
(b) A = 1; B = 3 x 3; C = 126 x 126<br>
(c) A = 1;  B = 128 x 128; C = 128 x 128<br>
(d) A = 16384; B = 5 x 5; C = 128 x 128<br>
(e) A = 16384; B = 130 x 130; C = 126 x 126<br></p>
<p><strong>Justificativa:</strong> No caso (A), toda camada densa processa todos os elementos de entrada e portanto o campo receptivo é composto de todos os valores. De fato poderíamos até mesmo dizer que, na prática, é um campo receptivo global. Já uma camada convolucional (B), essa processa dados localmente sempre igual ao tamanho do filtro, nesse caso 3x3. No caso (C) o campo receptivo da camada convolucional é 5x5, porém todos os valores são posteriormente submetidos a uma camada densa, e para essa segunda camada todos os elementos da entrada estão sendo considerados (direta ou indiretamente). Assim, o campo receptivo termina sendo toda a imagem de entrada contendo 128x128 pixels.</p>
<hr class="docutils" />
</section>
<section id="id27">
<h2>Questão 3)<a class="headerlink" href="#id27" title="Permalink to this heading">#</a></h2>
<p>Utilizando a biblioteca Keras, projete uma rede neural para processar dados unidimensionais (dimensionalidade do vetor de entrada = 256), e que contenha as seguintes camadas:</p>
<ol class="arabic simple">
<li><p>camada max pooling 1D com tamanho de pool = 3</p></li>
<li><p>camada convolucional 1D com 32 filtros de tamanho 5, com zero-padding</p></li>
<li><p>camada max pooling 1D com tamanho de pool = 7</p></li>
<li><p>camada convolucional 1D com 64 filtros de tamanho 3, sem padding</p></li>
<li><p>camada global max pooling 1D</p></li>
</ol>
<p>Essa arquitetura poderia ser utilizada para receber por entrada uma janela de uma série temporal contendo 256 instancias e aprender um espaço de características compacto com a camada Global Max Pooling.</p>
<p>Quais as dimensionalidades das saídas das camadas 1 (primeiro MaxPooling), 4 (segunda Convolucional) e 5 (Global Max Pooling)?</p>
<p>(a) 1=(256,1); 4=(10,32); 5=(64)<br>
(b) 1=(256,32); 4=(7,64); 5=(64)<br>
(c) 1=(84,1); 4=(7,32); 5=(32)<br>
(d) 1=(85,32); 4=(10,64); 5=(64)<br>
<font color='red'>(e) 1=(85,1); 4=(10,64); 5=(64)</font><br></p>
<p><strong>Justificativa:</strong> ver código abaixo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">modelA</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling1D</span><span class="p">())</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 max_pooling1d_4 (MaxPoolin  (None, 85, 1)             0         
 g1D)                                                            
                                                                 
 conv1d_4 (Conv1D)           (None, 85, 32)            192       
                                                                 
 max_pooling1d_5 (MaxPoolin  (None, 12, 32)            0         
 g1D)                                                            
                                                                 
 conv1d_5 (Conv1D)           (None, 10, 64)            6208      
                                                                 
 global_max_pooling1d_2 (Gl  (None, 64)                0         
 obalMaxPooling1D)                                               
                                                                 
=================================================================
Total params: 6400 (25.00 KB)
Trainable params: 6400 (25.00 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="id28">
<h2>Questão 4)<a class="headerlink" href="#id28" title="Permalink to this heading">#</a></h2>
<p>Carregue a base de dados CIFAR-10 conforme o código abaixo. Normalize os dados das imagens de forma a que os valores estejam entre 0 e 1, depois converta as classes para o tipo categórico utilizando o <code class="docutils literal notranslate"> <span class="pre">tf.keras.utils.to_categorical</span></code>.</p>
<p>A seguir, crie uma CNN para classificar imagens dessa base de dados, contendo como camadas:</p>
<ol class="arabic simple">
<li><p>convolucional 1 com 16 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 3\)</span>, sem padding e stride 1 (nas duas direções)</p></li>
<li><p>maxpooling com tamanho 2 e stride 2 nas duas direções</p></li>
<li><p>convolucional 2 com 32 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 1\)</span>, com padding e stride <span class="math notranslate nohighlight">\(2,1\)</span></p></li>
<li><p>convolucional 3 com 32 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 3\)</span>, com padding e stride <span class="math notranslate nohighlight">\(1,2\)</span></p></li>
<li><p>global max pooling</p></li>
<li><p>camada densa com 32 neurônios</p></li>
<li><p>camada classificadora com ativação softmax</p></li>
</ol>
<p>Após montar o modelo realize a predição para o primeiro elemento do conjunto de treinamento no formato <code class="docutils literal notranslate"><span class="pre">model.predict([x_train[1:2]])</span></code></p>
<p>Quais os tamanhos das saídas das camadas de 3 até 5, e qual foi a média das probabilidades (de todas as classes) gerada como saída para a predição do primeiro elemento?</p>
<p>(a) 3=(15,8,32); 4=(8,8,32); 5=(64); média=0.2<br>
(b) 3=(8,8,32); 4=(8,8,32); 5=(64); média=0.01<br>
(c) 3=(16,8,32); 4=(8,8,32); 5=(32); média=0.2<br>
(d) 3=(8,15,32); 4=(4,8,32); 5=(32); média=0.01<br>
<font color='red'>(e) 3=(8,15,32); 4=(8,8,32); 5=(32); média=0.1<br></font></p>
<p><strong>Justificativa:</strong> ver código abaixo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">cifar10</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">cifar10</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Classes: &#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="c1"># normalizando imagens para intervalo entre 0 e 1</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="c1"># verifica se as imagens da base de dados tem um canal (i.e. em tons de cinza)</span>
<span class="c1"># ou mais do que um canal e se houver mais do que um canal entao armazena a</span>
<span class="c1"># quantidade de canais</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># re-formatando as imagens de forma que sejam transformadas em</span>
<span class="c1"># matrizes com canais (por exemplo quando as imagens sao RGB)</span>
<span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_data_format</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-10-01 20:33:12.735635: E tensorflow/compiler/xla/stream_executor/cuda/cuda_dnn.cc:9342] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2023-10-01 20:33:12.735741: E tensorflow/compiler/xla/stream_executor/cuda/cuda_fft.cc:609] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2023-10-01 20:33:12.739963: E tensorflow/compiler/xla/stream_executor/cuda/cuda_blas.cc:1518] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
2023-10-01 20:33:13.019891: I tensorflow/core/platform/cpu_feature_guard.cc:182] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-10-01 20:33:14.996101: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /home/maponti/.cache/pypoetry/virtualenvs/rnapv2-6emnm6FP-py3.11/lib/python3.11/site-packages/tensorflow/python/ops/distributions/distribution.py:259: ReparameterizationType.__init__ (from tensorflow.python.ops.distributions.distribution) is deprecated and will be removed after 2019-01-01.
Instructions for updating:
The TensorFlow Distributions library has moved to TensorFlow Probability (https://github.com/tensorflow/probability). You should update all references to use `tfp.distributions` instead of `tf.distributions`.
WARNING:tensorflow:From /home/maponti/.cache/pypoetry/virtualenvs/rnapv2-6emnm6FP-py3.11/lib/python3.11/site-packages/tensorflow/python/ops/distributions/bernoulli.py:165: RegisterKL.__init__ (from tensorflow.python.ops.distributions.kullback_leibler) is deprecated and will be removed after 2019-01-01.
Instructions for updating:
The TensorFlow Distributions library has moved to TensorFlow Probability (https://github.com/tensorflow/probability). You should update all references to use `tfp.distributions` instead of `tf.distributions`.
(50000, 32, 32, 3)
Classes:  10
</pre></div>
</div>
<img alt="../_images/cdfda2782a7ce27fc121eb3d178381f34c20a9b2b1ffbebead9b2018266681ff.png" src="../_images/cdfda2782a7ce27fc121eb3d178381f34c20a9b2b1ffbebead9b2018266681ff.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling2D</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d (Conv2D)             (None, 30, 30, 16)        448       
                                                                 
 max_pooling2d (MaxPooling2  (None, 15, 15, 16)        0         
 D)                                                              
                                                                 
 conv2d_1 (Conv2D)           (None, 8, 15, 32)         1568      
                                                                 
 conv2d_2 (Conv2D)           (None, 8, 8, 32)          3104      
                                                                 
 global_max_pooling2d (Glob  (None, 32)                0         
 alMaxPooling2D)                                                 
                                                                 
 dense (Dense)               (None, 32)                1056      
                                                                 
 dense_1 (Dense)             (None, 10)                330       
                                                                 
=================================================================
Total params: 6506 (25.41 KB)
Trainable params: 6506 (25.41 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">x_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.10000001
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
</section>
<section id="id29">
<h2>Questão 5)<a class="headerlink" href="#id29" title="Permalink to this heading">#</a></h2>
<p>Carregue a base de dados CIFAR-10 conforme o código abaixo. Normalize os dados das imagens de forma a que os valores estejam entre 0 e 1, depois converta as classes para o tipo categórico utilizando o <code class="docutils literal notranslate"> <span class="pre">tf.keras.utils.to_categorical</span></code>.  Iremos usar um subconjunto de treinamento contendo as primeiras 9000 imagens (usar código abaixo)</p>
<p>A seguir, crie uma CNN para classificar imagens dessa base de dados, contendo como camadas:</p>
<ol class="arabic simple">
<li><p>convolucional 1 com 32 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 3\)</span>, sem padding e stride 1 (nas duas direções)</p></li>
<li><p>maxpooling com tamanho 2 e stride 2 nas duas direções</p></li>
<li><p>convolucional 2 com 64 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 1\)</span>, sem padding e stride <span class="math notranslate nohighlight">\(2,1\)</span></p></li>
<li><p>convolucional 3 com 64 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 3\)</span>, sem padding e stride <span class="math notranslate nohighlight">\(1,2\)</span></p></li>
<li><p>global max pooling</p></li>
<li><p>camada densa com 32 neurônios</p></li>
<li><p>camada classificadora com ativação softmax</p></li>
</ol>
<p>Todas as camadas convolucionais devem ter ativação relu.</p>
<p>Iremos repetir 5 vezes o experimento de treinamento e avaliação dessa rede, da seguinte forma: defina as sementes aleatórias do numpy para 1 e do tensorflow para 2. Depois, utilizando a arquitetura definida, configure a rede para treinar com a configuração abaixo.</p>
<ul class="simple">
<li><p>otimizador: SGD</p></li>
<li><p>taxa de aprendizado: 0.015</p></li>
<li><p>função de custo: <code class="docutils literal notranslate"><span class="pre">categorical_crossentropy</span></code></p></li>
<li><p>métrica: <code class="docutils literal notranslate"><span class="pre">accuracy</span></code></p></li>
<li><p>épocas: 15</p></li>
<li><p>batchsize: 50</p></li>
</ul>
<p>Após o processo de aprendizado, obtenha a acurácia calculada no conjunto de treinamento e no conjunto de testes utilizando a função <code class="docutils literal notranslate"><span class="pre">evaluate()</span></code>.</p>
<p>Com base na média da acurácia de treinamento e teste obtida das 5 execuções, escolha a opção cujo intervalo se enquadre nos valores obtidos.</p>
<p>(a) Acurácia Treinamento = [47,52],  Acurácia Teste = [37,42]<br>
(b) Acurácia Treinamento = [41,44],  Acurácia Teste = [35,40]<br>
(c) Acurácia Treinamento = [30,34],  Acurácia Teste = [35,40]<br>
(d) Acurácia Treinamento = [41,44],  Acurácia Teste = [30,34]<br>
<font color='red'>(e) Acurácia Treinamento = [30,34],  Acurácia Teste = [30,34]<br></font></p>
<p><strong>Justificativa:</strong> ver código abaixo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">cifar10</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">cifar10</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Classes: &#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="c1"># verifica se as imagens da base de dados tem um canal (i.e. em tons de cinza)</span>
<span class="c1"># ou mais do que um canal e se houver mais do que um canal entao armazena a</span>
<span class="c1"># quantidade de canais</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># re-formatando as imagens de forma que sejam transformadas em</span>
<span class="c1"># matrizes com canais (por exemplo quando as imagens sao RGB)</span>
<span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_data_format</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>

<span class="c1">## subconjunto</span>
<span class="n">x_train_sub</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">9000</span><span class="p">]</span>
<span class="n">y_train_sub</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">9000</span><span class="p">]</span>

<span class="k">del</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50000, 32, 32, 3)
Classes:  10
</pre></div>
</div>
<img alt="../_images/f27c7d9347d711f329aecfbea027b682b67edbb62ac6d342b791c2528b1f1f96.png" src="../_images/f27c7d9347d711f329aecfbea027b682b67edbb62ac6d342b791c2528b1f1f96.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="k">def</span> <span class="nf">my_cnn</span><span class="p">(</span><span class="n">show_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling2D</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show_summary</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exemplo de como realizar o treinamento</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="c1"># sementes</span>
    <span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># criar modelo</span>
    <span class="c1"># compilar modelo</span>
    <span class="c1"># treinar modelo</span>
    <span class="c1"># avaliar modelo</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">acc_train</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">acc_test</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training Model </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.015</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_sub</span><span class="p">,</span> <span class="n">y_train_sub</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">scoreTr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_train_sub</span><span class="p">,</span> <span class="n">y_train_sub</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">scoreTe</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">acc_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreTr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">acc_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreTe</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy: Train </span><span class="si">{</span><span class="n">scoreTr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% / Test </span><span class="si">{</span><span class="n">scoreTe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Model 1...
	Accuracy: Train 31.0% / Test 30.4%
Training Model 2...
	Accuracy: Train 32.5% / Test 31.2%
Training Model 3...
	Accuracy: Train 30.8% / Test 29.5%
Training Model 4...
	Accuracy: Train 31.4% / Test 31.0%
Training Model 5...
	Accuracy: Train 30.6% / Test 29.8%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acurácia média treinamento: </span><span class="si">{</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acurácia média teste: </span><span class="si">{</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc_test</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia média treinamento: 31.3%
Acurácia média teste: 30.4%
</pre></div>
</div>
</div>
</div>
</section>
<section id="id30">
<h2><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span><a class="headerlink" href="#id30" title="Permalink to this heading">#</a></h2>
<section id="id31">
<h3><span style="color:darkred">Exercícios com soluções</span><a class="headerlink" href="#id31" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id32">
<h3>Exercício 1)<a class="headerlink" href="#id32" title="Permalink to this heading">#</a></h3>
<p>A operação de convolução consiste em, centrada em um ponto de uma matriz ou tensor, fazer uma combinação linear de valores na região da posição central, gerando como saída um único valor, escalar.</p>
<p>Considere que a convolução opera numa região de tamanho <span class="math notranslate nohighlight">\(5\times 5\)</span> com stride = 1, isso significa que para cada conjunto local de <span class="math notranslate nohighlight">\(5 \times 5\)</span> valores, produziremos um único de saída. Se a entrada é uma matriz com tamanho <span class="math notranslate nohighlight">\(10 \times 10\)</span>, e caso não seja utilizado nenhum pré-processamento ou zero-padding nos dados, qual o tamanho da saída?</p>
<p>(a) <span class="math notranslate nohighlight">\(10\times 10\)</span> <br>
<font color='red'>(b) <span class="math notranslate nohighlight">\(6\times 6\)</span> </font><br>
(c) <span class="math notranslate nohighlight">\(8\times 8\)</span><br>
(d) <span class="math notranslate nohighlight">\(5\times 5\)</span><br></p>
<p><strong>Justificativa</strong>: para computar a saída em regiões de <span class="math notranslate nohighlight">\(5\times 5\)</span>, precisamos começar na terceira linha e terceira coluna da matriz, e finalizar duas linhas e duas colunas antes da matriz terminar. Assim, para uma entrada de tamanho <span class="math notranslate nohighlight">\(10\times 10\)</span>, perdemos duas linhas e duas colunas de cada lado, gerando uma matriz de <span class="math notranslate nohighlight">\(6\times 6\)</span> como saída.</p>
</section>
<hr class="docutils" />
<section id="id33">
<h3>Exercício 2)<a class="headerlink" href="#id33" title="Permalink to this heading">#</a></h3>
<p>Cada camada convolucional com <span class="math notranslate nohighlight">\(k\)</span> neurônios (filtros de convolução) gera <span class="math notranslate nohighlight">\(k\)</span> saídas distintas. Enquanto na camada densa as <span class="math notranslate nohighlight">\(k\)</span> saídas são valores individuais (escalares), na convolucional as saídas são mapas de ativação (ou mapas de características). Porque eles recebem esse nome?</p>
<p>(a) Pois podemos escolher os filtros de convolução de forma a processar imagens de entrada e obter características como borda, textura e regiões planas com cores.<br>
<font color='red'>(b) Pois podem ser interpretados como representações dos dados de entrada, aprendidas por meio da otimização da função de custo/perda da rede neural convolucional</font><br>
(c) Pois os filtros convolucionais extraem de forma aleatória características da entrada de forma que essas características, ou ativações, melhorem a capacidade de classificar novos exemplos<br>
(d) Pois foram baseadas em funções de ativação das redes neurais Multilayer Perceptron, as quais também realizam um tipo de processamento de características das entradas<br></p>
</section>
<hr class="docutils" />
<section id="id34">
<h3>Exercício 3)<a class="headerlink" href="#id34" title="Permalink to this heading">#</a></h3>
<p>Assuma uma entrada de tamanho <span class="math notranslate nohighlight">\(256 \times 256 \times 3\)</span>, e duas camadas convolucionais, sequenciais. A primeira possui 8 neurônios de tamanho <span class="math notranslate nohighlight">\(3\times 3 \times 3\)</span> e <em>não</em> usa zero-padding. A segunda possui 16 neurônios de tamanho <span class="math notranslate nohighlight">\(3 \times 3 \times p\)</span> e aplica zero-padding.</p>
<p>Quantos mapas de ativação são gerados pela segunda camada convolucional, qual o tamanho final da saída da segunda camada e qual o valor de <span class="math notranslate nohighlight">\(p\)</span>?</p>
<p><font color='red'>(a) 16 mapas, saída <span class="math notranslate nohighlight">\(254 \times 254 \times 16\)</span>, <span class="math notranslate nohighlight">\(p = 8\)</span></font><br>
(a) 24 mapas, saída <span class="math notranslate nohighlight">\(254 \times 254 \times 8\)</span>, <span class="math notranslate nohighlight">\(p = 8\)</span><br>
(c) 16 mapas, saída <span class="math notranslate nohighlight">\(252 \times 252 \times 8\)</span>, <span class="math notranslate nohighlight">\(p = 16\)</span><br>
(d) 24 mapas, saída <span class="math notranslate nohighlight">\(256 \times 256 \times 16\)</span>, <span class="math notranslate nohighlight">\(p = 8\)</span><br></p>
</section>
<hr class="docutils" />
<section id="id35">
<h3>Exercício 4)<a class="headerlink" href="#id35" title="Permalink to this heading">#</a></h3>
<p>Camadas convolucionais costumam gerar saídas de alta dimensionalidade, o que pode tornar difícil a otimização do modelo. Desejamos manter o aprendizado de mapas de ativação, mas reduzir a dimensionalidade espacial dos dados ao longo da rede neural. Marque a alternativa com a estratégia que melhor se adequa ao efeito desejado.</p>
<p>(a) Utilizar filtros de convolucão de tamanho menor<br>
(b) Aumentar a quantidade de camadas de convolucão<br>
<font color='red'>(c) Utilizar camadas de pooling ou convoluções com stride maior do que 1<br></font>
(d) Substituir todas as camadas convolucionais por camadas de pooling</p>
</section>
<hr class="docutils" />
<section id="id36">
<h3>Exercício 5)<a class="headerlink" href="#id36" title="Permalink to this heading">#</a></h3>
<p>Utilizando a biblioteca Keras, formule duas arquiteturas de rede neural sequencial convolucional, cuja entrada seja preparada para receber um vetor unidimensional de <span class="math notranslate nohighlight">\(1024\)</span> dimensões.</p>
<p>Arquitetura A</p>
<ol class="arabic simple">
<li><p>camada convolucional 1 com 16 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 8\)</span>, com padding</p></li>
<li><p>camada max pooling de tamanho <span class="math notranslate nohighlight">\(4\)</span></p></li>
<li><p>camada convolucional 2 com 32 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 8\)</span>, com padding</p></li>
<li><p>camada max pooling de tamanho <span class="math notranslate nohighlight">\(4\)</span></p></li>
<li><p>camada convolucional 3 com 8 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 1\)</span>, com padding</p></li>
<li><p>camada densa de saída com 3 neurônios.</p></li>
</ol>
<p>Arquitetura B</p>
<ol class="arabic simple">
<li><p>camada convolucional 1 com 16 filtros de tamanho  <span class="math notranslate nohighlight">\(1\times 8\)</span> e stride 4, com padding</p></li>
<li><p>camada convolucional 2 com 32 filtros de tamanho  <span class="math notranslate nohighlight">\(1\times 8\)</span> e stride 4, com padding</p></li>
<li><p>camada convolucional 3 com 8 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 1\)</span>, com padding</p></li>
<li><p>camada densa de saída com 3 neurônios.</p></li>
</ol>
<p>Qual o tamanho da saída das camadas convolucionais 2 e 3, e o total de parâmetros de cada rede?</p>
<p>(a) A: conv2=(256,32), conv3=(64,8), total=6075; B: conv2=(64,32), conv3=(64,8), total=4075 <br>
(b) A: conv2=(64,32), conv3=(64,8), total=6075; B: conv2=(64,32), conv3=(64,8), total=6075 <br>
(c) A: conv2=(64,32), conv3=(1,8), total=4128; B: conv2=(64,32), conv3=(1,8), total=1539 <br>
<font color='red'>(d) A: conv2=(256,32), conv3=(64,8), total=6075; B: conv2=(64,32), conv3=(64,8), total=6075 <br></font></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">modelA</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>

<span class="n">modelA</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv1d_3 (Conv1D)            (None, 1024, 16)          144       
_________________________________________________________________
max_pooling1d_2 (MaxPooling1 (None, 256, 16)           0         
_________________________________________________________________
conv1d_4 (Conv1D)            (None, 256, 32)           4128      
_________________________________________________________________
max_pooling1d_3 (MaxPooling1 (None, 64, 32)            0         
_________________________________________________________________
conv1d_5 (Conv1D)            (None, 64, 8)             264       
_________________________________________________________________
flatten_1 (Flatten)          (None, 512)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 3)                 1539      
=================================================================
Total params: 6,075
Trainable params: 6,075
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelB</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv1d_3 (Conv1D)            (None, 256, 16)           144       
_________________________________________________________________
conv1d_4 (Conv1D)            (None, 64, 32)            4128      
_________________________________________________________________
conv1d_5 (Conv1D)            (None, 64, 8)             264       
_________________________________________________________________
flatten_1 (Flatten)          (None, 512)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 3)                 1539      
=================================================================
Total params: 6,075
Trainable params: 6,075
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelC</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">())</span>
<span class="n">modelC</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_2&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d (Conv2D)              (None, 512, 512, 32)      320       
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 512, 256, 64)      6208      
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 256, 256, 64)      12352     
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 85, 85, 128)       73856     
_________________________________________________________________
global_average_pooling2d (Gl (None, 128)               0         
=================================================================
Total params: 92,736
Trainable params: 92,736
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id37">
<h3>Exercício 6)<a class="headerlink" href="#id37" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados CIFAR-100 e exiba as 10 primeiras imagens dessa base de dados. Normalize os dados das imagens de forma a que os valores estejam entre 0 e 1, depois converta as classes para o tipo categórico utilizando o <code class="docutils literal notranslate"> <span class="pre">tf.keras.utils.to_categorical</span></code>.</p>
<p>A seguir, use a arquitetura:</p>
<ol class="arabic simple">
<li><p>camada convolucional 1 com 32 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 3\)</span>, com padding e stride 2 (nas duas direções)</p></li>
<li><p>camada convolucional 2 com 64 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 3\)</span>, com padding e stride <span class="math notranslate nohighlight">\(1,2\)</span></p></li>
<li><p>camada convolucional 3 com 64 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 1\)</span>, com padding e stride <span class="math notranslate nohighlight">\(2,1\)</span></p></li>
<li><p>camada convolucional 4 com 128 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 3\)</span>, sem padding e stride 3 (nas duas direções)</p></li>
<li><p>camada global average pooling</p></li>
</ol>
<p>E adapte a rede para receber como entrada imagens dessa base. Todas as camadas da rede, exceto a última, devem ter funções de ativação do tipo <code class="docutils literal notranslate"><span class="pre">relu</span></code>. Crie uma camada densa no final que permita classificar as imagens nos rótulos disponíveis no conjunto de treinamento, usando a função de ativação adequada.</p>
<p>Qual o tamanho da saída das duas últimas camadas da rede (global average pooling e densa), e o total de parâmetros da mesma rede?</p>
<p>(a) global average pooling = 128, densa = 128, parâmetros = 106212<br>
(b) global average pooling = 128, densa = 100, parâmetros = 12900<br>
(c) global average pooling = 128, densa = 20, parâmetros = 12900<br>
<font color='red'>(d) global average pooling = 128, densa = 100, parâmetros = 106212<br></font></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">cifar100</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">cifar100</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">n_imgs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_imgs</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_imgs</span><span class="p">,</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">im</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
<span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">img_cha</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Classes: &#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50000, 32, 32, 3)
Classes:  100
</pre></div>
</div>
<img alt="../_images/52e237144108eb0ae99c50f1e3800199efe6ae9f533bf0f54b66a5b1c432dffd.png" src="../_images/52e237144108eb0ae99c50f1e3800199efe6ae9f533bf0f54b66a5b1c432dffd.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelD</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">img_cha</span><span class="p">)))</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">())</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">))</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_7&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_16 (Conv2D)           (None, 16, 16, 32)        896       
_________________________________________________________________
conv2d_17 (Conv2D)           (None, 16, 8, 64)         6208      
_________________________________________________________________
conv2d_18 (Conv2D)           (None, 8, 8, 64)          12352     
_________________________________________________________________
conv2d_19 (Conv2D)           (None, 2, 2, 128)         73856     
_________________________________________________________________
global_average_pooling2d_4 ( (None, 128)               0         
_________________________________________________________________
dense_5 (Dense)              (None, 100)               12900     
=================================================================
Total params: 106,212
Trainable params: 106,212
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id38">
<h3>Exercício 7)<a class="headerlink" href="#id38" title="Permalink to this heading">#</a></h3>
<p>Defina as sementes aleatórias do numpy para 1 e do tensorflow para 2. Depois, utilizando a arquitetura definida no exercício anterior, configure a rede para treinar com a configuração abaixo, salvando o histórico da perda e acurácia para as épocas.</p>
<ul class="simple">
<li><p>otimizador: SGD</p></li>
<li><p>taxa de aprendizado: 0.09</p></li>
<li><p>função de custo: <code class="docutils literal notranslate"><span class="pre">categorical_crossentropy</span></code></p></li>
<li><p>métrica: <code class="docutils literal notranslate"><span class="pre">accuracy</span></code></p></li>
<li><p>épocas: 10</p></li>
<li><p>batchsize: 64</p></li>
</ul>
<p>Após as 8 épocas, exiba e analise gráfico da função de custo no conjunto de treinamento ao longo das épocas e avalie a acurácia no conjunto de testes. Considerando: (1) a convergência da função de custo e (2) comparando a acurácia no conjunto de testes com o que seria a acurácia de um classificador aleatório para a base de dados CIFAR-100, escolha a alternativa correta.</p>
<p>(a) A função de custo indica estabilização, alcançando uma acurácia 25 vezes superior a de um classificador aleatório<br>
(b) A função de custo indica que ainda há espaço para o treinamento de mais épocas, a acurácia obtida é mais do que 50 vezes superior do que um classificador aleatório<br>
<font color='red'>(c) A função de custo indica que ainda há espaço para o treinamento de mais épocas, e a acurácia obtida é mais do que 15 vezes superior do que um classificador aleatório<br></font>
(d) A função de custo indica um valor baixo de custo e assim, treinar por mais épocas não irá beneficiar o modelo, a acurácia obtida é apenas ligeiramente superior a um classificador aleatório<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">modelD</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.09</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># a variável history guarda os dados do processo de treinamento para</span>
<span class="c1"># posteriormente analisarmos</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">modelD</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-06 09:28:38.167655: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:176] None of the MLIR Optimization Passes are enabled (registered 2)
2021-10-06 09:28:38.203665: I tensorflow/core/platform/profile_utils/cpu_utils.cc:114] CPU Frequency: 2594535000 Hz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-06 09:28:39.244874: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcudnn.so.8
2021-10-06 09:28:40.652193: I tensorflow/stream_executor/cuda/cuda_dnn.cc:359] Loaded cuDNN version 8200
2021-10-06 09:28:42.200502: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcublas.so.11
2021-10-06 09:28:43.570437: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcublasLt.so.11
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>782/782 [==============================] - 12s 8ms/step - loss: 4.5044 - accuracy: 0.0208
Epoch 2/10
782/782 [==============================] - 6s 8ms/step - loss: 4.1216 - accuracy: 0.0634
Epoch 3/10
782/782 [==============================] - 6s 8ms/step - loss: 3.8989 - accuracy: 0.0999
Epoch 4/10
782/782 [==============================] - 7s 9ms/step - loss: 3.7254 - accuracy: 0.1297
Epoch 5/10
782/782 [==============================] - 7s 9ms/step - loss: 3.5972 - accuracy: 0.1533
Epoch 6/10
782/782 [==============================] - 7s 9ms/step - loss: 3.4905 - accuracy: 0.1710
Epoch 7/10
782/782 [==============================] - 7s 10ms/step - loss: 3.3939 - accuracy: 0.1902
Epoch 8/10
782/782 [==============================] - 7s 9ms/step - loss: 3.3146 - accuracy: 0.2036
Epoch 9/10
782/782 [==============================] - 7s 9ms/step - loss: 3.2380 - accuracy: 0.2178
Epoch 10/10
782/782 [==============================] - 7s 9ms/step - loss: 3.1709 - accuracy: 0.2309
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Perda&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f4752ba6f878d06060b902cbea6abd052dad4bbfebc921c2e510f3ad050cb76b.png" src="../_images/f4752ba6f878d06060b902cbea6abd052dad4bbfebc921c2e510f3ad050cb76b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score</span> <span class="o">=</span> <span class="n">modelD</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia: </span><span class="si">%.4f</span><span class="s2"> (aleatório = </span><span class="si">%.4f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">num_classes</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia: 0.1775 (aleatório = 0.0100)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id39">
<h3>Exercício 8)<a class="headerlink" href="#id39" title="Permalink to this heading">#</a></h3>
<p>Crie uma nova rede neural com base na anterior mas adicionando, logo após a 3.a camada convolucional, e antes da 4.a camada convolucional, outras 2 camadas no formato:</p>
<ul class="simple">
<li><p>camada convolucional com 64 filtros de tamanho <span class="math notranslate nohighlight">\(1\times 3\)</span>, com padding e stride <span class="math notranslate nohighlight">\(1,2\)</span></p></li>
<li><p>camada convolucional com 64 filtros de tamanho <span class="math notranslate nohighlight">\(3\times 1\)</span>, com padding e stride <span class="math notranslate nohighlight">\(2,1\)</span></p></li>
</ul>
<p>Defina as sementes aleatórias do numpy para 1 e do tensorflow para 2, e a seguir execute o treinamento dessa rede utilizando os parâmetros conforme a questão anterior, mas aumente o número de épocas para 15.</p>
<p>Considerando:</p>
<ol class="arabic simple">
<li><p>a diferença no valor da função de custo obtida nas épocas 1 e 10 (para permitir comparar com a anterior), e</p></li>
<li><p>a acurácia no conjunto de testes após o treinamento completo</p></li>
</ol>
<p>Escolha a alternativa correta:</p>
<p>(a) A diferença do valor da função de custo da 1.a para a 10.a época é menor nessa nova arquitetura, indicando convergência mais lenta, e ao final a acurácia atinge valor superior a 25% com essa arquitetura mais profunda<br>
(b) A diferença do valor da função de custo da 1.a para a 10.a época é maior nessa nova arquitetura, mostrando a superioridade da arquitetura mais profunda, que ao final atinge acurácia acima de 50%<br>
<font color='red'>(c) A diferença do custo da 1.a para a 10.a época é maior nessa nova arquitetura, indicando convergência mais rápida, e ao final a acurácia atinge valor superior a 20% com a arquitetura mais profunda<br></font>
(d) A diferença do valor da função de custo da 1.a para a 10.a época é menor nessa nova arquitetura, indicando que a arquitetura menos profunda é mais estável, e ao final a acurácia atinge valor próxmo a 10% com essa arquitetura mais profunda<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelE</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">img_cha</span><span class="p">)))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">())</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">))</span>
<span class="n">modelE</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_8&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_20 (Conv2D)           (None, 16, 16, 32)        896       
_________________________________________________________________
conv2d_21 (Conv2D)           (None, 16, 8, 64)         6208      
_________________________________________________________________
conv2d_22 (Conv2D)           (None, 8, 8, 64)          12352     
_________________________________________________________________
conv2d_23 (Conv2D)           (None, 8, 4, 64)          12352     
_________________________________________________________________
conv2d_24 (Conv2D)           (None, 4, 4, 64)          12352     
_________________________________________________________________
conv2d_25 (Conv2D)           (None, 1, 1, 128)         73856     
_________________________________________________________________
global_average_pooling2d_5 ( (None, 128)               0         
_________________________________________________________________
dense_6 (Dense)              (None, 100)               12900     
=================================================================
Total params: 130,916
Trainable params: 130,916
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">modelE</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.09</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># a variável history guarda os dados do processo de treinamento para</span>
<span class="c1"># posteriormente analisarmos</span>
<span class="n">history2</span> <span class="o">=</span> <span class="n">modelE</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
782/782 [==============================] - 10s 12ms/step - loss: 4.4691 - accuracy: 0.0270 - val_loss: 4.3204 - val_accuracy: 0.0592
Epoch 2/15
782/782 [==============================] - 10s 12ms/step - loss: 3.8839 - accuracy: 0.1056 - val_loss: 3.9983 - val_accuracy: 0.0964
Epoch 3/15
782/782 [==============================] - 9s 12ms/step - loss: 3.5757 - accuracy: 0.1581 - val_loss: 3.5837 - val_accuracy: 0.1588
Epoch 4/15
782/782 [==============================] - 10s 13ms/step - loss: 3.3323 - accuracy: 0.2034 - val_loss: 3.6952 - val_accuracy: 0.1580
Epoch 5/15
782/782 [==============================] - 10s 13ms/step - loss: 3.1355 - accuracy: 0.2386 - val_loss: 3.3290 - val_accuracy: 0.2219
Epoch 6/15
782/782 [==============================] - 11s 13ms/step - loss: 2.9794 - accuracy: 0.2659 - val_loss: 3.2684 - val_accuracy: 0.2197
Epoch 7/15
782/782 [==============================] - 11s 14ms/step - loss: 2.8492 - accuracy: 0.2922 - val_loss: 3.3787 - val_accuracy: 0.2181
Epoch 8/15
782/782 [==============================] - 11s 14ms/step - loss: 2.7414 - accuracy: 0.3121 - val_loss: 3.2175 - val_accuracy: 0.2307
Epoch 9/15
782/782 [==============================] - 11s 14ms/step - loss: 2.6460 - accuracy: 0.3337 - val_loss: 3.1430 - val_accuracy: 0.2652
Epoch 10/15
782/782 [==============================] - 11s 14ms/step - loss: 2.5580 - accuracy: 0.3484 - val_loss: 3.0226 - val_accuracy: 0.2763
Epoch 11/15
782/782 [==============================] - 11s 14ms/step - loss: 2.4765 - accuracy: 0.3654 - val_loss: 3.2776 - val_accuracy: 0.2326
Epoch 12/15
782/782 [==============================] - 12s 15ms/step - loss: 2.4032 - accuracy: 0.3815 - val_loss: 3.3519 - val_accuracy: 0.2311
Epoch 13/15
782/782 [==============================] - 12s 15ms/step - loss: 2.3285 - accuracy: 0.3940 - val_loss: 3.0041 - val_accuracy: 0.2839
Epoch 14/15
782/782 [==============================] - 12s 15ms/step - loss: 2.2628 - accuracy: 0.4130 - val_loss: 3.4006 - val_accuracy: 0.2439
Epoch 15/15
782/782 [==============================] - 12s 16ms/step - loss: 2.1990 - accuracy: 0.4205 - val_loss: 3.2221 - val_accuracy: 0.2572
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score</span> <span class="o">=</span> <span class="n">modelE</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia: </span><span class="si">%.1f</span><span class="s2"> (aleatório = </span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">num_classes</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Perda&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modulo-4-treinamento-de-redes-profundas">
<h2><em>Módulo 4 - Treinamento de Redes Profundas</em><a class="headerlink" href="#modulo-4-treinamento-de-redes-profundas" title="Permalink to this heading">#</a></h2>
<section id="regularizacao-e-normalizacao">
<h3>Regularização e Normalização<a class="headerlink" href="#regularizacao-e-normalizacao" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="n">tfds</span><span class="o">.</span><span class="n">disable_progress_bar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Carregando a base de dados “Cats vs Dogs”</p>
<p>Vamos ainda re-dimensionar as imagens para o tamanho <span class="math notranslate nohighlight">\(150\times 150\)</span></p>
<p>Posteriormente, para aumentar a velocidade, vamos pré-calcular os batches</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">validation_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">),</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s2">&quot;cats_vs_dogs&quot;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train[0%:20%]&quot;</span><span class="p">,</span> <span class="s2">&quot;train[20%:25%]&quot;</span><span class="p">,</span> <span class="s2">&quot;train[25%:40%]&quot;</span><span class="p">],</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Include labels</span>
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Normalizes images: `uint8` -&gt; `float32`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># redimensionando exemplos e normalizando entre 0-1 tipo float32</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">input_shape</span> <span class="o">=</span> <span class="n">img_size</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tfds.core.DatasetInfo(
    name=&#39;cats_vs_dogs&#39;,
    full_name=&#39;cats_vs_dogs/4.0.0&#39;,
    description=&quot;&quot;&quot;
    A large set of images of cats and dogs. There are 1738 corrupted images that are dropped.
    &quot;&quot;&quot;,
    homepage=&#39;https://www.microsoft.com/en-us/download/details.aspx?id=54765&#39;,
    data_dir=&#39;/root/tensorflow_datasets/cats_vs_dogs/4.0.0&#39;,
    file_format=tfrecord,
    download_size=786.67 MiB,
    dataset_size=689.64 MiB,
    features=FeaturesDict({
        &#39;image&#39;: Image(shape=(None, None, 3), dtype=uint8),
        &#39;image/filename&#39;: Text(shape=(), dtype=string),
        &#39;label&#39;: ClassLabel(shape=(), dtype=int64, num_classes=2),
    }),
    supervised_keys=(&#39;image&#39;, &#39;label&#39;),
    disable_shuffling=False,
    splits={
        &#39;train&#39;: &lt;SplitInfo num_examples=23262, num_shards=8&gt;,
    },
    citation=&quot;&quot;&quot;@Inproceedings (Conference){asirra-a-captcha-that-exploits-interest-aligned-manual-image-categorization,
    author = {Elson, Jeremy and Douceur, John (JD) and Howell, Jon and Saul, Jared},
    title = {Asirra: A CAPTCHA that Exploits Interest-Aligned Manual Image Categorization},
    booktitle = {Proceedings of 14th ACM Conference on Computer and Communications Security (CCS)},
    year = {2007},
    month = {October},
    publisher = {Association for Computing Machinery, Inc.},
    url = {https://www.microsoft.com/en-us/research/publication/asirra-a-captcha-that-exploits-interest-aligned-manual-image-categorization/},
    edition = {Proceedings of 14th ACM Conference on Computer and Communications Security (CCS)},
    }&quot;&quot;&quot;,
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># definindo tamanho de batch e colocando os batches num &quot;cache&quot;</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/41501932b2a72dbb7c71e66c3575b1f05763947f265fc7dc605480c0f33f2053.png" src="../_images/41501932b2a72dbb7c71e66c3575b1f05763947f265fc7dc605480c0f33f2053.png" />
</div>
</div>
</section>
<section id="vamos-investigar-uma-cnn-sequencial-e-adicionar-opcoes-de-dropout-regularizacao-e-normalizacao-por-batch-e-por-camada">
<h3>1) Vamos investigar uma CNN sequencial, e adicionar opções de Dropout (regularização), e normalização por batch e por camada<a class="headerlink" href="#vamos-investigar-uma-cnn-sequencial-e-adicionar-opcoes-de-dropout-regularizacao-e-normalizacao-por-batch-e-por-camada" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">batch_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># guarda ativacao para somar ao fim do bloco residual</span>
    <span class="n">ativacao_residual</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">for</span> <span class="n">n_filtros</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">SeparableConv2D</span><span class="p">(</span><span class="n">n_filtros</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">batch_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">layer_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">SeparableConv2D</span><span class="p">(</span><span class="n">n_filtros</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">batch_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">layer_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># residual</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filtros</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span>
            <span class="n">ativacao_residual</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">residual</span><span class="p">])</span>  <span class="c1"># adiciona resisual</span>
        <span class="n">ativacao_residual</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># armazena saida do bloco</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">SeparableConv2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">batch_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">layer_norm</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span>
        <span class="n">neuronios</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="s2">&quot;softmax&quot;</span>
        <span class="n">neuronios</span> <span class="o">=</span> <span class="n">num_classes</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neuronios</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="i-avaliando-o-papel-da-normalizacao">
<h3>I - Avaliando o papel da Normalização<a class="headerlink" href="#i-avaliando-o-papel-da-normalizacao" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">CNN1</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
              <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist1</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/8
146/146 [==============================] - 30s 85ms/step - loss: 0.6931 - accuracy: 0.4987 - val_loss: 0.6925 - val_accuracy: 0.5189
Epoch 2/8
146/146 [==============================] - 5s 34ms/step - loss: 0.6926 - accuracy: 0.5138 - val_loss: 0.6916 - val_accuracy: 0.5309
Epoch 3/8
146/146 [==============================] - 5s 34ms/step - loss: 0.6919 - accuracy: 0.5277 - val_loss: 0.6901 - val_accuracy: 0.5619
Epoch 4/8
146/146 [==============================] - 5s 35ms/step - loss: 0.6905 - accuracy: 0.5464 - val_loss: 0.6874 - val_accuracy: 0.5610
Epoch 5/8
146/146 [==============================] - 5s 33ms/step - loss: 0.6879 - accuracy: 0.5486 - val_loss: 0.6829 - val_accuracy: 0.5662
Epoch 6/8
146/146 [==============================] - 5s 34ms/step - loss: 0.6841 - accuracy: 0.5540 - val_loss: 0.6772 - val_accuracy: 0.5722
Epoch 7/8
146/146 [==============================] - 5s 33ms/step - loss: 0.6799 - accuracy: 0.5621 - val_loss: 0.6718 - val_accuracy: 0.5739
Epoch 8/8
146/146 [==============================] - 5s 33ms/step - loss: 0.6761 - accuracy: 0.5692 - val_loss: 0.6669 - val_accuracy: 0.5773
</pre></div>
</div>
</div>
</div>
</section>
<section id="com-batch-normalization">
<h3>com Batch Normalization<a class="headerlink" href="#com-batch-normalization" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">CNN2</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
              <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">CNN2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist2</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/8
146/146 [==============================] - 13s 46ms/step - loss: 0.6573 - accuracy: 0.5989 - val_loss: 0.7110 - val_accuracy: 0.4905
Epoch 2/8
146/146 [==============================] - 6s 42ms/step - loss: 0.6238 - accuracy: 0.6481 - val_loss: 0.8381 - val_accuracy: 0.4905
Epoch 3/8
146/146 [==============================] - 6s 43ms/step - loss: 0.5999 - accuracy: 0.6756 - val_loss: 1.1213 - val_accuracy: 0.4905
Epoch 4/8
146/146 [==============================] - 6s 42ms/step - loss: 0.5781 - accuracy: 0.7021 - val_loss: 0.9012 - val_accuracy: 0.5198
Epoch 5/8
146/146 [==============================] - 6s 42ms/step - loss: 0.5612 - accuracy: 0.7165 - val_loss: 0.5776 - val_accuracy: 0.6838
Epoch 6/8
146/146 [==============================] - 6s 42ms/step - loss: 0.5477 - accuracy: 0.7257 - val_loss: 0.6057 - val_accuracy: 0.6864
Epoch 7/8
146/146 [==============================] - 7s 48ms/step - loss: 0.5365 - accuracy: 0.7311 - val_loss: 0.6271 - val_accuracy: 0.6770
Epoch 8/8
146/146 [==============================] - 6s 41ms/step - loss: 0.5265 - accuracy: 0.7380 - val_loss: 0.6274 - val_accuracy: 0.6796
</pre></div>
</div>
</div>
</div>
</section>
<section id="com-layer-normalization">
<h3>com Layer Normalization<a class="headerlink" href="#com-layer-normalization" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">CNN3</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
              <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">CNN3</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist3</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/8
146/146 [==============================] - 25s 120ms/step - loss: 0.6913 - accuracy: 0.5303 - val_loss: 0.6750 - val_accuracy: 0.5954
Epoch 2/8
146/146 [==============================] - 15s 105ms/step - loss: 0.6697 - accuracy: 0.5873 - val_loss: 0.6422 - val_accuracy: 0.6177
Epoch 3/8
146/146 [==============================] - 15s 106ms/step - loss: 0.6536 - accuracy: 0.6083 - val_loss: 0.6285 - val_accuracy: 0.6237
Epoch 4/8
146/146 [==============================] - 15s 106ms/step - loss: 0.6432 - accuracy: 0.6197 - val_loss: 0.6188 - val_accuracy: 0.6263
Epoch 5/8
146/146 [==============================] - 15s 104ms/step - loss: 0.6337 - accuracy: 0.6290 - val_loss: 0.6101 - val_accuracy: 0.6418
Epoch 6/8
146/146 [==============================] - 15s 104ms/step - loss: 0.6242 - accuracy: 0.6455 - val_loss: 0.6002 - val_accuracy: 0.6529
Epoch 7/8
146/146 [==============================] - 16s 112ms/step - loss: 0.6144 - accuracy: 0.6617 - val_loss: 0.5899 - val_accuracy: 0.6684
Epoch 8/8
146/146 [==============================] - 15s 105ms/step - loss: 0.6047 - accuracy: 0.6696 - val_loss: 0.5811 - val_accuracy: 0.6796
</pre></div>
</div>
</div>
</div>
<p>com BN + Regularização Dropout</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">CNN4</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
              <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">CNN4</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist4</span> <span class="o">=</span> <span class="n">CNN4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/8
146/146 [==============================] - 13s 43ms/step - loss: 0.6821 - accuracy: 0.5858 - val_loss: 0.6959 - val_accuracy: 0.4905
Epoch 2/8
146/146 [==============================] - 6s 43ms/step - loss: 0.6400 - accuracy: 0.6232 - val_loss: 0.7382 - val_accuracy: 0.4905
Epoch 3/8
146/146 [==============================] - 6s 42ms/step - loss: 0.6269 - accuracy: 0.6460 - val_loss: 0.8436 - val_accuracy: 0.4905
Epoch 4/8
146/146 [==============================] - 6s 43ms/step - loss: 0.6029 - accuracy: 0.6694 - val_loss: 0.6690 - val_accuracy: 0.5928
Epoch 5/8
146/146 [==============================] - 6s 42ms/step - loss: 0.5869 - accuracy: 0.6872 - val_loss: 0.6040 - val_accuracy: 0.6546
Epoch 6/8
146/146 [==============================] - 6s 43ms/step - loss: 0.5705 - accuracy: 0.6948 - val_loss: 0.6900 - val_accuracy: 0.6375
Epoch 7/8
146/146 [==============================] - 6s 41ms/step - loss: 0.5565 - accuracy: 0.7130 - val_loss: 0.6671 - val_accuracy: 0.6478
Epoch 8/8
146/146 [==============================] - 6s 43ms/step - loss: 0.5443 - accuracy: 0.7190 - val_loss: 0.6657 - val_accuracy: 0.6546
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores1</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores2</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores3</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores4</span> <span class="o">=</span> <span class="n">CNN4</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Na validação&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BatchNorm LayerNorm Dropout - Loss</span><span class="se">\t</span><span class="s2">Acc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -         -        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    X         -        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -         X        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores3</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    X         -        X      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores4</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Na validação
BatchNorm LayerNorm Dropout - Loss	Acc
    -         -        -      0.6669	0.5773
    X         -        -      0.6274	0.6796
    -         X        -      0.5811	0.6796
    X         -        X      0.6657	0.6546
</pre></div>
</div>
</div>
</div>
<p><strong>Resumo: avaliando os modelos agora no teste</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores1</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores2</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores3</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scores4</span> <span class="o">=</span> <span class="n">CNN4</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BatchNorm LayerNorm Dropout - Loss</span><span class="se">\t</span><span class="s2">Acc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -         -        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    X         -        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -         X        -      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores3</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    X         -        X      </span><span class="si">%.4f</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scores4</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BatchNorm LayerNorm Dropout - Loss	Acc
    -         -        -      0.6704	0.5744
    X         -        -      0.6127	0.6756
    -         X        -      0.5704	0.7085
    X         -        X      0.6639	0.6489
</pre></div>
</div>
</div>
</div>
</section>
<section id="id40">
<h3>Redes Neurais e Aprendizado Profundo<a class="headerlink" href="#id40" title="Permalink to this heading">#</a></h3>
<section id="id41">
<h4><strong>MBA em Ciências de Dados</strong><a class="headerlink" href="#id41" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="id42">
<h3><em>Módulo 4 - Treinamento de Redes Profundas</em><a class="headerlink" href="#id42" title="Permalink to this heading">#</a></h3>
<p><strong>Aumentação de Dados e Transferência de Aprendizado</strong></span></p>
<p>Moacir Antonelli Ponti</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="c1">#tfds.disable_progress_bar()</span>

<span class="c1"># selecionamos 50% do treinamento</span>
<span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">validation_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">),</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s2">&quot;beans&quot;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train[0%:50%]&quot;</span><span class="p">,</span> <span class="s2">&quot;validation[0%:100%]&quot;</span><span class="p">,</span> <span class="s2">&quot;test[0%:100%]&quot;</span><span class="p">],</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">9</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-12 15:19:35.936679: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/687c23d839109036b0add70082cb65c1aa74647c4d88ed9f9331fc92c0b34f21.png" src="../_images/687c23d839109036b0add70082cb65c1aa74647c4d88ed9f9331fc92c0b34f21.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Normalizes images: `uint8` -&gt; `float32`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># redimensionando exemplos e normalizando entre 0-1 tipo float32</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">input_shape</span> <span class="o">=</span> <span class="n">img_size</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tfds.core.DatasetInfo(
    name=&#39;beans&#39;,
    full_name=&#39;beans/0.1.0&#39;,
    description=&quot;&quot;&quot;
    Beans is a dataset of images of beans taken in the field using smartphone
    cameras. It consists of 3 classes: 2 disease classes and the healthy class.
    Diseases depicted include Angular Leaf Spot and Bean Rust. Data was annotated
    by experts from the National Crops Resources Research Institute (NaCRRI) in
    Uganda and collected by the Makerere AI research lab.
    &quot;&quot;&quot;,
    homepage=&#39;https://github.com/AI-Lab-Makerere/ibean/&#39;,
    data_path=&#39;/home/maponti/tensorflow_datasets/beans/0.1.0&#39;,
    download_size=171.69 MiB,
    dataset_size=171.63 MiB,
    features=FeaturesDict({
        &#39;image&#39;: Image(shape=(500, 500, 3), dtype=tf.uint8),
        &#39;label&#39;: ClassLabel(shape=(), dtype=tf.int64, num_classes=3),
    }),
    supervised_keys=(&#39;image&#39;, &#39;label&#39;),
    disable_shuffling=False,
    splits={
        &#39;test&#39;: &lt;SplitInfo num_examples=128, num_shards=1&gt;,
        &#39;train&#39;: &lt;SplitInfo num_examples=1034, num_shards=2&gt;,
        &#39;validation&#39;: &lt;SplitInfo num_examples=133, num_shards=1&gt;,
    },
    citation=&quot;&quot;&quot;@ONLINE {beansdata,
        author=&quot;Makerere AI Lab&quot;,
        title=&quot;Bean disease dataset&quot;,
        month=&quot;January&quot;,
        year=&quot;2020&quot;,
        url=&quot;https://github.com/AI-Lab-Makerere/ibean/&quot;
    }&quot;&quot;&quot;,
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="data-augmentation">
<h3>Data Augmentation:<a class="headerlink" href="#data-augmentation" title="Permalink to this heading">#</a></h3>
<section id="funciona-como-uma-camada-de-pre-processamento-gerando-transformacoes-aleatorias-na-imagem-de-entrada">
<h4>funciona como uma camada de pré-processamento, gerando transformações aleatórias na imagem de entrada.<a class="headerlink" href="#funciona-como-uma-camada-de-pre-processamento-gerando-transformacoes-aleatorias-na-imagem-de-entrada" title="Permalink to this heading">#</a></h4>
<p>Ao longo das épocas é responsável pela perturbação da entrada.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_augmentation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;vertical&quot;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.25</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomContrast</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">augmented_image</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1">#plt.title(str(labels[i].numpy()))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
2021-10-12 15:16:21.651463: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
2021-10-12 15:16:21.651758: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/7830fef37606244747215557c65a09269f84350f16fffe667a909577574e72f7.png" src="../_images/7830fef37606244747215557c65a09269f84350f16fffe667a909577574e72f7.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="carregando-a-cnn-mobilenet-v2-para-ser-usada-como-backbone-da-solucao">
<h3>Carregando a CNN “MobileNet V2” para ser usada como “backbone” da solução<a class="headerlink" href="#carregando-a-cnn-mobilenet-v2-para-ser-usada-como-backbone-da-solucao" title="Permalink to this heading">#</a></h3>
<p><strong>Abordagem 1</strong>: pesos inicializados aleatoriamente</p>
<p>carregamos <code class="docutils literal notranslate"><span class="pre">include_top=False</span></code> pois não queremos a última camada (top), especifica da ImageNet</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_model_random</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Permitir treinamento do modelo carregado</span>
<span class="n">base_model_random</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Com base na MobileNetV2 vamos criar nosso modelo</span>
<span class="c1"># definimos o tamanho da entrada</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1"># aplicamos a transformacao da imagem de entrada</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

<span class="c1"># Depois da &quot;aumentacao de dados&quot;, temos o modelo base</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">base_model_random</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;avg_pool&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model_random</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="n">model_random</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 128, 128, 3)]     0         
_________________________________________________________________
sequential (Sequential)      (None, 128, 128, 3)       0         
_________________________________________________________________
mobilenetv2_1.00_128 (Functi (None, 4, 4, 1280)        2257984   
_________________________________________________________________
avg_pool (GlobalAveragePooli (None, 1280)              0         
_________________________________________________________________
dropout (Dropout)            (None, 1280)              0         
_________________________________________________________________
dense (Dense)                (None, 3)                 3843      
=================================================================
Total params: 2,261,827
Trainable params: 2,227,715
Non-trainable params: 34,112
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<section id="compilando-e-treinando-o-modelo-a-partir-de-pessos-aleatorios">
<h4>Compilando e treinando o modelo a partir de pessos aleatórios<a class="headerlink" href="#compilando-e-treinando-o-modelo-a-partir-de-pessos-aleatorios" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">model_random</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;categorical_crossentropy&quot;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">rand_hist</span> <span class="o">=</span> <span class="n">model_random</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-12 15:16:26.178629: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcudnn.so.8
2021-10-12 15:16:26.521686: I tensorflow/stream_executor/cuda/cuda_dnn.cc:359] Loaded cuDNN version 8200
2021-10-12 15:16:26.842776: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcublas.so.11
2021-10-12 15:16:27.038451: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Successfully opened dynamic library libcublasLt.so.11
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17/17 [==============================] - 8s 201ms/step - loss: 1.1388 - acc: 0.3656 - val_loss: 1.1155 - val_acc: 0.4286
Epoch 2/20
17/17 [==============================] - 2s 127ms/step - loss: 1.1382 - acc: 0.3501 - val_loss: 1.0942 - val_acc: 0.4135
Epoch 3/20
17/17 [==============================] - 2s 128ms/step - loss: 1.1287 - acc: 0.3985 - val_loss: 1.0715 - val_acc: 0.3985
Epoch 4/20
17/17 [==============================] - 2s 127ms/step - loss: 1.1479 - acc: 0.3656 - val_loss: 1.0948 - val_acc: 0.4361
Epoch 5/20
17/17 [==============================] - 2s 128ms/step - loss: 1.1333 - acc: 0.4004 - val_loss: 1.1341 - val_acc: 0.3759
Epoch 6/20
17/17 [==============================] - 2s 127ms/step - loss: 1.1406 - acc: 0.3810 - val_loss: 1.1272 - val_acc: 0.4060
Epoch 7/20
17/17 [==============================] - 2s 126ms/step - loss: 1.1174 - acc: 0.4120 - val_loss: 1.0720 - val_acc: 0.4436
Epoch 8/20
17/17 [==============================] - 2s 126ms/step - loss: 1.0556 - acc: 0.4662 - val_loss: 1.0426 - val_acc: 0.4586
Epoch 9/20
17/17 [==============================] - 2s 128ms/step - loss: 1.0549 - acc: 0.4565 - val_loss: 1.0244 - val_acc: 0.4812
Epoch 10/20
17/17 [==============================] - 2s 128ms/step - loss: 1.0447 - acc: 0.4642 - val_loss: 1.0182 - val_acc: 0.5038
Epoch 11/20
17/17 [==============================] - 2s 126ms/step - loss: 1.0446 - acc: 0.4855 - val_loss: 0.9870 - val_acc: 0.4887
Epoch 12/20
17/17 [==============================] - 2s 128ms/step - loss: 1.0538 - acc: 0.4487 - val_loss: 0.9693 - val_acc: 0.4737
Epoch 13/20
17/17 [==============================] - 2s 126ms/step - loss: 0.9872 - acc: 0.5048 - val_loss: 0.9976 - val_acc: 0.4511
Epoch 14/20
17/17 [==============================] - 2s 129ms/step - loss: 0.9818 - acc: 0.5145 - val_loss: 1.0129 - val_acc: 0.4887
Epoch 15/20
17/17 [==============================] - 2s 129ms/step - loss: 0.9491 - acc: 0.5629 - val_loss: 0.9855 - val_acc: 0.4812
Epoch 16/20
17/17 [==============================] - 2s 132ms/step - loss: 0.9683 - acc: 0.5126 - val_loss: 0.9559 - val_acc: 0.5338
Epoch 17/20
17/17 [==============================] - 2s 133ms/step - loss: 0.9478 - acc: 0.5609 - val_loss: 0.9366 - val_acc: 0.5489
Epoch 18/20
17/17 [==============================] - 2s 135ms/step - loss: 0.9022 - acc: 0.6035 - val_loss: 0.9348 - val_acc: 0.5714
Epoch 19/20
17/17 [==============================] - 2s 134ms/step - loss: 0.9259 - acc: 0.5783 - val_loss: 0.9376 - val_acc: 0.5564
Epoch 20/20
17/17 [==============================] - 2s 138ms/step - loss: 0.8676 - acc: 0.5861 - val_loss: 0.9188 - val_acc: 0.5489
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">model_random</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Inicializacao Aleatoria. Scores: &#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5/5 [==============================] - 0s 25ms/step - loss: 0.9188 - acc: 0.5489
Inicializacao Aleatoria. Scores:  [0.918752133846283, 0.548872172832489]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="carregando-a-cnn-mobilenet-v2-com-pesos-pre-treinados">
<h3>Carregando a CNN “MobileNet V2” com pesos pré-treinados<a class="headerlink" href="#carregando-a-cnn-mobilenet-v2-com-pesos-pre-treinados" title="Permalink to this heading">#</a></h3>
<p><strong>Abordagem 2</strong>: uso de pesos pré-treinados na imagenet para Transferência de Aprendizado</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># Tornamos o modelo base não treinável, &quot;congelando&quot; os parâmetros</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Nosso modelo como anteriormente</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> 

<span class="c1"># Incluindo a MobileNetV2 com parametros pré-treinados, mas ainda não treinável</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;avg_pool&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;projection&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_4 (InputLayer)         [(None, 128, 128, 3)]     0         
_________________________________________________________________
sequential (Sequential)      (None, 128, 128, 3)       0         
_________________________________________________________________
mobilenetv2_1.00_128 (Functi (None, 4, 4, 1280)        2257984   
_________________________________________________________________
avg_pool (GlobalAveragePooli (None, 1280)              0         
_________________________________________________________________
projection (Dense)           (None, 160)               204960    
_________________________________________________________________
dropout_1 (Dropout)          (None, 160)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 3)                 483       
=================================================================
Total params: 2,463,427
Trainable params: 205,443
Non-trainable params: 2,257,984
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<section id="passo-1-treinar-apenas-a-camada-de-saida-softmax">
<h4>Passo 1: treinar apenas a camada de saída (softmax)<a class="headerlink" href="#passo-1-treinar-apenas-a-camada-de-saida-softmax" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;categorical_crossentropy&quot;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">pt_hist1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
17/17 [==============================] - 4s 86ms/step - loss: 1.1934 - acc: 0.4662 - val_loss: 0.8421 - val_acc: 0.6165
Epoch 2/15
17/17 [==============================] - 1s 41ms/step - loss: 0.8905 - acc: 0.6093 - val_loss: 0.6766 - val_acc: 0.7143
Epoch 3/15
17/17 [==============================] - 1s 39ms/step - loss: 0.7171 - acc: 0.7195 - val_loss: 0.6161 - val_acc: 0.7293
Epoch 4/15
17/17 [==============================] - 1s 39ms/step - loss: 0.6391 - acc: 0.7215 - val_loss: 0.5821 - val_acc: 0.7444
Epoch 5/15
17/17 [==============================] - 1s 39ms/step - loss: 0.6195 - acc: 0.7331 - val_loss: 0.5374 - val_acc: 0.7744
Epoch 6/15
17/17 [==============================] - 1s 39ms/step - loss: 0.6023 - acc: 0.7408 - val_loss: 0.5285 - val_acc: 0.7744
Epoch 7/15
17/17 [==============================] - 1s 39ms/step - loss: 0.5762 - acc: 0.7544 - val_loss: 0.5242 - val_acc: 0.7744
Epoch 8/15
17/17 [==============================] - 1s 40ms/step - loss: 0.5421 - acc: 0.7679 - val_loss: 0.4985 - val_acc: 0.7744
Epoch 9/15
17/17 [==============================] - 1s 40ms/step - loss: 0.5066 - acc: 0.7950 - val_loss: 0.4784 - val_acc: 0.7820
Epoch 10/15
17/17 [==============================] - 1s 40ms/step - loss: 0.5332 - acc: 0.7892 - val_loss: 0.4593 - val_acc: 0.8045
Epoch 11/15
17/17 [==============================] - 1s 40ms/step - loss: 0.4786 - acc: 0.7930 - val_loss: 0.4908 - val_acc: 0.7895
Epoch 12/15
17/17 [==============================] - 1s 42ms/step - loss: 0.4227 - acc: 0.8317 - val_loss: 0.4558 - val_acc: 0.7970
Epoch 13/15
17/17 [==============================] - 1s 40ms/step - loss: 0.4454 - acc: 0.7930 - val_loss: 0.4608 - val_acc: 0.7895
Epoch 14/15
17/17 [==============================] - 1s 44ms/step - loss: 0.4499 - acc: 0.8027 - val_loss: 0.4714 - val_acc: 0.7895
Epoch 15/15
17/17 [==============================] - 1s 40ms/step - loss: 0.4348 - acc: 0.8279 - val_loss: 0.4394 - val_acc: 0.8195
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transferencia do Aprendizado de Representacaoes. Scores: &#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5/5 [==============================] - 0s 24ms/step - loss: 0.4394 - acc: 0.8195
Transferencia do Aprendizado de Representacaoes. Scores:  [0.43939706683158875, 0.8195488452911377]
</pre></div>
</div>
</div>
</div>
</section>
<section id="passo-2-ajuste-fino-do-restante-dos-parametros">
<h4>Passo 2: ajuste fino do restante dos parâmetros<a class="headerlink" href="#passo-2-ajuste-fino-do-restante-dos-parametros" title="Permalink to this heading">#</a></h4>
<p>Executamos mais algumas épocas para tentar melhorar as outras camadas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># des-congelando o modelo base, permitindo ser treinável</span>

<span class="c1"># modelo completo</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># congelando as primeiras camadas, deixando apenas as ultimas treinaveis</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]:</span> 
    <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># congela tambem camadas de BN</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">_per_input_updates</span> <span class="o">=</span> <span class="p">{}</span>
        
<span class="c1"># verificando</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span><span class="p">)</span>      
<span class="c1"># note a diferença no summary</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.keras.layers.convolutional.DepthwiseConv2D object at 0x7f8c86065fd0&gt; False
&lt;tensorflow.python.keras.layers.normalization_v2.BatchNormalization object at 0x7f8c86067df0&gt; False
&lt;tensorflow.python.keras.layers.advanced_activations.ReLU object at 0x7f8c860a8190&gt; False
&lt;tensorflow.python.keras.layers.convolutional.Conv2D object at 0x7f8c8600db20&gt; False
&lt;tensorflow.python.keras.layers.normalization_v2.BatchNormalization object at 0x7f8c8604c3a0&gt; True
&lt;tensorflow.python.keras.layers.convolutional.Conv2D object at 0x7f8c85fbe520&gt; True
&lt;tensorflow.python.keras.layers.normalization_v2.BatchNormalization object at 0x7f8c85fbef70&gt; True
&lt;tensorflow.python.keras.layers.advanced_activations.ReLU object at 0x7f8c85fbe9a0&gt; True
Model: &quot;model_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_4 (InputLayer)         [(None, 128, 128, 3)]     0         
_________________________________________________________________
sequential (Sequential)      (None, 128, 128, 3)       0         
_________________________________________________________________
mobilenetv2_1.00_128 (Functi (None, 4, 4, 1280)        2257984   
_________________________________________________________________
avg_pool (GlobalAveragePooli (None, 1280)              0         
_________________________________________________________________
projection (Dense)           (None, 160)               204960    
_________________________________________________________________
dropout_1 (Dropout)          (None, 160)               0         
_________________________________________________________________
dense_1 (Dense)              (None, 3)                 483       
=================================================================
Total params: 2,463,427
Trainable params: 618,243
Non-trainable params: 1,845,184
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># aqui definimos um passo/learning rate bem pequeno para o ajuste-fino</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">10e-7</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;categorical_crossentropy&quot;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">pt_hist2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/5
17/17 [==============================] - 4s 85ms/step - loss: 0.3963 - acc: 0.8491 - val_loss: 0.4386 - val_acc: 0.8195
Epoch 2/5
17/17 [==============================] - 1s 39ms/step - loss: 0.4145 - acc: 0.8298 - val_loss: 0.4397 - val_acc: 0.8195
Epoch 3/5
17/17 [==============================] - 1s 39ms/step - loss: 0.3686 - acc: 0.8414 - val_loss: 0.4394 - val_acc: 0.8195
Epoch 4/5
17/17 [==============================] - 1s 41ms/step - loss: 0.4001 - acc: 0.8221 - val_loss: 0.4408 - val_acc: 0.8195
Epoch 5/5
17/17 [==============================] - 1s 42ms/step - loss: 0.4020 - acc: 0.8337 - val_loss: 0.4420 - val_acc: 0.8195
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ajuste Fino. Scores validacao: &#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5/5 [==============================] - 0s 25ms/step - loss: 0.4420 - acc: 0.8195
Ajuste Fino. Scores validacao:  [0.4419874846935272, 0.8195488452911377]
</pre></div>
</div>
</div>
</div>
<p>Comparando o histórico das duas abordagens</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pt_tra_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pt_hist1</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">],</span> <span class="n">pt_hist2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">pt_val_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pt_hist1</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">],</span> <span class="n">pt_hist2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rand_hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rand_hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt_tra_hist</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt_val_hist</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;rnd_acc&#39;</span><span class="p">,</span><span class="s1">&#39;rnd_val_acc&#39;</span><span class="p">,</span><span class="s1">&#39;pt_acc&#39;</span><span class="p">,</span><span class="s1">&#39;pt_val_acc&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f8c8653d4c0&gt;
</pre></div>
</div>
<img alt="../_images/b124c8e8b2f23f267fb8a2453d35d4ae3a4396077368e94d2c3474c2f9035546.png" src="../_images/b124c8e8b2f23f267fb8a2453d35d4ae3a4396077368e94d2c3474c2f9035546.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="obtendo-features-a-partir-da-cnn-mobilenet-v2-com-pesos-pre-treinados">
<h3>Obtendo features a partir da CNN “MobileNet V2” com pesos pré-treinados<a class="headerlink" href="#obtendo-features-a-partir-da-cnn-mobilenet-v2-com-pesos-pre-treinados" title="Permalink to this heading">#</a></h3>
<p><strong>Abordagem 3</strong>: obter a saída dessa rede, sem incluir a camada de predição (softmax).</p>
<p>Esse processo <em>não necessita de treinamento</em> da rede. Para obter features, incluímos uma nova camada, de Global Pooling e definimos essa camada como sendo a de saída do modelo.</p>
<p>Aqui também não incluimos o “topo” da rede, cujas camadas dependem de uma entrada de tamanho igual a da ImageNet (224x224) e saída com 1000 classes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># carregando pessos pré-treinados</span>
<span class="n">base_model_extraction</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># obtemos a camada de saída do modelo carregado (última camada pois não incluímos o topo da rede)</span>
<span class="n">base_output</span> <span class="o">=</span> <span class="n">base_model_extraction</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

<span class="c1"># para evitar uma dimensionalidade alta, definimos uma nova camada de saída</span>
<span class="n">feat_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">base_output</span><span class="p">)</span>

<span class="c1"># montamos um novo modelo com a entrada do pré-treinado, e saída criada acima</span>
<span class="n">model_imagenet</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">base_model_extraction</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">feat_layer</span><span class="p">)</span>

<span class="c1"># passando os exemplos de treinamento pela rede sem treinamento</span>
<span class="c1"># o &quot;predict&quot; vai nos dar a saída programada, obtida da GlobalAveragePooling2D</span>
<span class="n">features_train_mobilenet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_imagenet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>
<span class="n">features_val_mobilenet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_imagenet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">))</span>
<span class="n">features_test_mobilenet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_imagenet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_ds</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Dados x features obtidas treinamento: &#39;</span><span class="p">,</span> <span class="n">features_train_mobilenet</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Dados x features obtidas test: &#39;</span><span class="p">,</span> <span class="n">features_test_mobilenet</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	Dados x features obtidas treinamento:  (517, 1280)
	Dados x features obtidas test:  (128, 1280)
</pre></div>
</div>
</div>
</div>
<p>As features obtidas podem ser utilizadas para treinar classificadores não profundos ou como índices de sistemas de recuperação baseada em conteúdo.</p>
<p>Vamos visualizá-las utilizando uma projeção PCA em duas dimensões</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># pca com dados da ImageNet</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train_mobilenet</span><span class="p">)</span>
<span class="n">pca_train_imagenet</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_train_mobilenet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[45.509853 36.836216]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># obtem labels treinamento</span>
<span class="n">train_ds2</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">train_ds2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># obtem labels da validacao</span>
<span class="n">validation_ds2</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">val_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">validation_ds2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># obtem labels do teste</span>
<span class="n">test_ds2</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">test_ds2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca_train_imagenet</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(517, 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pca_train_imagenet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">pca_train_imagenet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x7f8c867b6760&gt;
</pre></div>
</div>
<img alt="../_images/dceb7704f72884a22e32a03313a1ebea681cd81bc53ddec02b991d93a8c4b3f9.png" src="../_images/dceb7704f72884a22e32a03313a1ebea681cd81bc53ddec02b991d93a8c4b3f9.png" />
</div>
</div>
<p>Usando em um classificador externo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>

<span class="n">svm_feat1</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">svm_feat1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train_mobilenet</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SVC(C=10, probability=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acurácia Treinamento:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">svm_feat1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_train_mobilenet</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acurácia Validacao:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">svm_feat1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_val_mobilenet</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia Treinamento:
1.0
Acurácia Validacao:
0.8872180451127819
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Resumo comparativo das abordagens:</p>
<ol class="arabic simple">
<li><p>Treinamento a partir de pesos aleatórios</p></li>
<li><p>Pré-treinamento + Transferência de Aprendizado e Ajuste Fino</p></li>
<li><p>Extração de Características + Classificador Externo</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoresR</span> <span class="o">=</span> <span class="n">model_random</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scoresTL</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scoresF</span> <span class="o">=</span> <span class="n">svm_feat1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_test_mobilenet</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MobileNet treinada de pesos aleatorios: &#39;</span><span class="p">,</span> <span class="n">scoresR</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MobileNet pré-treinada + ajuste fino: &#39;</span><span class="p">,</span> <span class="n">scoresTL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Features MobileNet + SVM: &#39;</span><span class="p">,</span> <span class="n">scoresF</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-darkred-modulo-4-estrategias-de-treinamento-e-transferencia-de-aprendizado-span">
<h2><span style="color:darkred">Módulo 4 - Estratégias de Treinamento e Transferência de Aprendizado</span><a class="headerlink" href="#span-style-color-darkred-modulo-4-estrategias-de-treinamento-e-transferencia-de-aprendizado-span" title="Permalink to this heading">#</a></h2>
<section id="id43">
<h3><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id43" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id44">
<h3>Questão 1)<a class="headerlink" href="#id44" title="Permalink to this heading">#</a></h3>
<p>Considere as seguintes suposições que comumente são feitas ao treinar redes neurais profundas por serem consideradas importantes ou essenciais para o bom treinamento desses modelos:</p>
<p>I - Dados de entrada são uma mistura de categóricos e não estruturados<br>
II - Dados possuem alta taxa ruído nos rótulos<br>
III - Conjunto de treinamento possui quantidade adequada ao problema<br>
IV - Dados de entrada podem possuir features em  intervalos muito diferentes de valores<br>
V - Há dados representativos com relação à tarefa alvo do problema<br></p>
<p>Quais dessas são verdadeiras?</p>
<p>(a) I, III<br>
(b) I, III, V<br>
(c) II, III<br>
(d) II, III, V<br>
<font color='red'>(e) III, V<br></font></p>
<p><strong>Justificativa:</strong> I é inválida pois redes neurais não permitem dados categóricos de forma nativa, II é inválida pois o treinamento de redes neurais supõe dados com baixa taxa de ruído nos rótulos devido ao fato de que esses podem ser memorizados, III é válida pois a quantidade de dados é relevante para modelos com alta complexidade como é o caso de redes profundas, IV é inválido pois redes neurais não se dão bem com features/dados de entrada em intervalos arbitrários, V é válido pois é preciso haver representatividade dos dados de saída/alvo, por exemplo entre as diferentes classes ou valores da regressão.</p>
</section>
<hr class="docutils" />
<section id="id45">
<h3>Questão 2)<a class="headerlink" href="#id45" title="Permalink to this heading">#</a></h3>
<p>Considere os valores de perda abaixo listadas, observadas no conjunto de treinamento de forma independente após treinar modelos de rede profunda por 50 épocas para um problema de classificação de 3 classes usando a perda entropia cruzada categórica.</p>
<p>I - Perda 0.9<br>
II - Perda 1.1<br>
III - Perda 11.5<br>
IV - Perda -39.0<br></p>
<p>Dica: para interpretar os valores acima, realize simulações com distintas situações calculando as perdas a partir de vetores de probabilidade com: (1) todas as classes equiprováveis, (2) classe correta (alvo) com probabilidade muito baixa (0.00001) e demais equiprováveis, (3) e vetor de probabilidade com a classe alvo contendo a máxima, porém baixa, probabilidade.<br></p>
<p>Qual a interpretação do resultado dos valores acima?</p>
<p>(a) I: classe alvo com probabilidade 0.9, II: classe alvo probabilidade 0.00001 e demais equiprováveis, III: classes equiprováveis, IV:  erro de cálculo numérico<br>
(b) I: classes equiprováveis, II: classe alvo com probabilidade 0.51, III: classe alvo com probabilidade 0.1, IV: classe alvo probabilidade 0.00001 e demais equiprováveis<br>
(c) I: classes equiprováveis, II: classe alvo com probabilidade 0.05, III: erro de cálculo numérico, IV: classe alvo probabilidade 0.00001 e demais equiprováveis<br>
<font color='red'>(d) I: classe alvo com probabilidade 0.4, II: classes equiprováveis, III: classe alvo probabilidade 0.00001 e demais equiprováveis, IV: erro de cálculo numérico<br></font>
(e) I: classe alvo com probabilidade 0.33, II: classes equiprováveis, III: classe alvo com probabilidade 0.51, IV: erro de cálculo numérico<br></p>
<p><strong>Justificativa:</strong> ver código abaixo. No pior cenário em que a classe alvo tem probabilidade 0.00001 o custo pode chegar a 11.5 (III), portanto uma perda de 39 (IV) é provavelmente um erro de cálculo ou de precisão numérica pois um valor negativo não é esperado para o custo de entropia cruzada. Já com classes equiprováveis temos a perda próxima a 1.1 (II). Com baixa (porém máxima) probabilidade 0.4 temos perda 0.9 (I).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">cross_entropy_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">yh</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yh</span><span class="p">)))</span>

<span class="c1">#</span>
<span class="n">classes</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vetor alvo: &#39;</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

<span class="c1"># cenário uniformemente distribuído</span>
<span class="n">yh2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span><span class="o">/</span><span class="n">classes</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classes equiprovaveis: &#39;</span><span class="p">,</span> <span class="n">yh2</span><span class="p">)</span>

<span class="n">loss_eq1</span> <span class="o">=</span> <span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">yh2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;uniforme: </span><span class="si">{</span><span class="n">loss_eq1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># cenário de probabilidade próxima a zero</span>
<span class="n">yr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">yr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">yr2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yr2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">classes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># outras classes equiprovaveis</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;classe correta probabilidade 10^-5: </span><span class="si">{</span><span class="n">yr2</span><span class="si">}</span><span class="s1">, sum = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yr2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">loss_eq2</span> <span class="o">=</span> <span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">yr2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;alvo prob. zero: </span><span class="si">{</span><span class="n">loss_eq2</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># cenário correto com baixa probabilidade</span>
<span class="n">yc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
<span class="n">yc2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># probabilidade baixa</span>
<span class="n">yc2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">yc2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">classes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># outras classes equiprovaveis</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">classe correta baixa probabilidade: </span><span class="si">{</span><span class="n">yc2</span><span class="si">}</span><span class="s1">, sum = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yc2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">loss_eq3</span> <span class="o">=</span> <span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">yc2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;correto, com baixa probabilidade: </span><span class="si">{</span><span class="n">loss_eq3</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vetor alvo:  [1. 0. 0.]
classes equiprovaveis:  [0.33333333 0.33333333 0.33333333]
uniforme: 1.1

classe correta probabilidade 10^-5: [1.e-50 5.e-01 5.e-01], sum = 1.0
alvo prob. zero: 115.1

classe correta baixa probabilidade: [0.4 0.3 0.3], sum = 1.0
correto, com baixa probabilidade: 0.9
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id46">
<h3>Questão 3)<a class="headerlink" href="#id46" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados Fashion MNIST código disponível no notebook fornecido e crie um modelo de CNN com a seguinte arquitetura, capaz de obter classificação nessa base de dados de imagens. Considere que todas as camadas convolucionais tem zeropadding, e ativação relu, exceto quando mencionado contrário.</p>
<ol class="arabic simple">
<li><p>Pré-processamento para aumentação contendo:</p></li>
</ol>
<ul class="simple">
<li><p>RandomRotation(0.05)</p></li>
<li><p>RandomZoom(0.075),</p></li>
<li><p>RandomContrast(0.2),</p></li>
<li><p>RandomFlip(“horizontal”)</p></li>
</ul>
<ol class="arabic simple">
<li><p>Convolucional 2D com 256 filtros <span class="math notranslate nohighlight">\(3\times 3\)</span>.</p></li>
<li><p>MaxPooling2D <span class="math notranslate nohighlight">\(2\times 2\)</span> e strides <span class="math notranslate nohighlight">\(2\)</span></p></li>
<li><p>Batch Normalization</p></li>
<li><p>SeparableConv2D com 128 filtros <span class="math notranslate nohighlight">\(3\times 3\)</span>.</p></li>
<li><p>MaxPooling2D <span class="math notranslate nohighlight">\(2\times 2\)</span> e strides <span class="math notranslate nohighlight">\(2\)</span></p></li>
<li><p>Batch Normalization</p></li>
<li><p>SeparableConv2D com 128 filtros <span class="math notranslate nohighlight">\(3\times 3\)</span>.</p></li>
<li><p>GlobalAveragePooling2D</p></li>
<li><p>Camada densa com 100 neurônios</p></li>
<li><p>Dropout de 0.3</p></li>
<li><p>Densa com ativação softmax</p></li>
</ol>
<p>Parte da implementação já está disponível no notebook fornecido. Usar o que está disponível e completar conforme necessário para obter os resultados.</p>
<p>Realize 10 experimentos, incializando as sementes do numpy e tensorflow para os valores: 10,20,30,40,50,60,70,80,90 e 100. Em cada uma, treine um modelo contendo a camada de aumento de dados.</p>
<p>Utilize as primeiras 4 mil imagens (use [:4000]) por 8 épocas com batch size 42, otimizador AdamW e taxa de aprendizado 0.0003 com a perda de entropia cruzada categórica. Em cada experimento, avalie o resultado da acurácia no conjunto de testes.</p>
<p>Considerando a acurácia média em porcentagem obtida  no conjunto de testes considerando apenas a sua parte inteira (sem contar casas decimais, exemplo: 38%), qual foi o resultado mais próximo do seu experimento com relação aos casos abaixo?</p>
<p>(a) Acurácia entre 25% e 35%<br>
(b) Acurácia entre 45 e 55%<br>
<font color="red">(c) Acurácia entre 65 e 75%<br></font>
(d) Acurácia entre 80 e 90%<br>
(e) Acurácia acima de 95%<br></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="n">fashion_mnist</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span>
<span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">test_images</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">train_labels</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">train_labels</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_augmentation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomZoom</span><span class="p">(</span><span class="mf">0.075</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomContrast</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">my_cnn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">augmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">SeparableConv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">SeparableConv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_7&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_8 (InputLayer)        [(None, 28, 28, 1)]       0         
                                                                 
 sequential_1 (Sequential)   (None, 28, 28, 1)         0         
                                                                 
 conv2d_7 (Conv2D)           (None, 28, 28, 256)       2560      
                                                                 
 max_pooling2d_14 (MaxPooli  (None, 14, 14, 256)       0         
 ng2D)                                                           
                                                                 
 batch_normalization_14 (Ba  (None, 14, 14, 256)       1024      
 tchNormalization)                                               
                                                                 
 separable_conv2d_14 (Separ  (None, 14, 14, 128)       35200     
 ableConv2D)                                                     
                                                                 
 max_pooling2d_15 (MaxPooli  (None, 7, 7, 128)         0         
 ng2D)                                                           
                                                                 
 batch_normalization_15 (Ba  (None, 7, 7, 128)         512       
 tchNormalization)                                               
                                                                 
 separable_conv2d_15 (Separ  (None, 7, 7, 128)         17664     
 ableConv2D)                                                     
                                                                 
 global_average_pooling2d_7  (None, 128)               0         
  (GlobalAveragePooling2D)                                       
                                                                 
 dense_14 (Dense)            (None, 100)               12900     
                                                                 
 dropout_7 (Dropout)         (None, 100)               0         
                                                                 
 dense_15 (Dense)            (None, 10)                1010      
                                                                 
=================================================================
Total params: 70870 (276.84 KB)
Trainable params: 70102 (273.84 KB)
Non-trainable params: 768 (3.00 KB)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">no_images</span> <span class="o">=</span> <span class="mi">4000</span>

<span class="n">train_sub</span> <span class="o">=</span> <span class="n">train_images</span><span class="p">[:</span><span class="n">no_images</span><span class="p">]</span>
<span class="n">labels_sub</span><span class="o">=</span> <span class="n">train_labels</span><span class="p">[:</span><span class="n">no_images</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>

<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Experimento com semente = &#39;</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">my_cnn</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="n">hist1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_sub</span><span class="p">,</span> <span class="n">labels_sub</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_acc</span> <span class="o">=</span> <span class="n">mean_acc</span> <span class="o">+</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Acuracia DA: </span><span class="si">{</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Experimento com semente =  10
	Acuracia DA: 69.86
Experimento com semente =  20
	Acuracia DA: 72.99
Experimento com semente =  30
	Acuracia DA: 63.75
Experimento com semente =  40
	Acuracia DA: 71.43
Experimento com semente =  50
	Acuracia DA: 73.16
Experimento com semente =  60
	Acuracia DA: 62.95
Experimento com semente =  70
	Acuracia DA: 73.58
Experimento com semente =  80
	Acuracia DA: 70.95
Experimento com semente =  90
	Acuracia DA: 71.66
Experimento com semente =  100
	Acuracia DA: 67.02
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acurácia de teste média </span><span class="si">{</span><span class="p">(</span><span class="n">mean_acc</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">seeds</span><span class="p">))</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia de teste média 70%
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id47">
<h3>Questão 4)<a class="headerlink" href="#id47" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados Fashion-MNIST e use uma rede neural convolucional com arquitetura contendo as seguintes camadas  (conforme código disponível no notebook fornecido)</p>
<ul class="simple">
<li><p>Camada Convolucional 2D, contendo 128 filtros 3x3 e stride 1, ativação=relu, padding=same</p></li>
<li><p>MaxPooling 2D com passo e stride 2 nas duas direções</p></li>
<li><p>Bloco Residual com 64 filtros nas suas camadas convolucionais</p></li>
<li><p>GlobalAveragePooling2D</p></li>
<li><p>Camada densa de saída softmax</p></li>
</ul>
<p>Utilizar: otimizador Adam, batchsize 24, e 8 épocas. com entropia cruzada categórica.</p>
<p>Investigue os seguintes valores de taxa de aprendizado: 0.0001, 0.0005, 0.001, 0.005, 0.01, todos com decaimento exponencial com taxa de decaimento 0.02 desde a primeira época (sem arredondar o resultado no scheduler).</p>
<p>Para isso, utilize as primeiras 800 imagens (:800) para treinamento e as próximas 400 para validação (800:1200), conforme código disponível no notebook fornecido.</p>
<p>Repita o experimento 5 vezes, utilizando sementes de 1 a 5 que devem ser setadas no tensorflow e numpy antes da compilação e treinamento de cada modelo. Use o mesmo conjunto de treinamento e validação em todas as execuções e obtenha a perda média (das 5 execuções) computada no conjunto de validação .</p>
<p>Qual taxa de aprendizado teve menor valor de perda média, considerando o conjunto de validação?</p>
<p>(a) 0.0001<br>
(b) 0.0005<br>
(c) 0.001<br>
<font color='red'>(d) 0.005<br></font>
(e) 0.01<br></p>
<p><strong>Justificativa:</strong> ver código abaixo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">fashion_mnist</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Classes: &#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="c1"># verifica se as imagens da base de dados tem um canal (i.e. em tons de cinza)</span>
<span class="c1"># ou mais do que um canal e se houver mais do que um canal entao armazena a</span>
<span class="c1"># quantidade de canais</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
      <span class="n">n_channels</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># re-formatando as imagens de forma que sejam transformadas em</span>
<span class="c1"># matrizes com canais (por exemplo quando as imagens sao RGB)</span>
<span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_data_format</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_lin</span><span class="p">,</span> <span class="n">img_col</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(60000, 28, 28)
Classes:  10
</pre></div>
</div>
<img alt="../_images/149453dd03aec138ca39ecb4a3adb074b44b26817f1190926cb72b5189d72030.png" src="../_images/149453dd03aec138ca39ecb4a3adb074b44b26817f1190926cb72b5189d72030.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">MaxPooling2D</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">concatenate</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">add</span>

<span class="k">def</span> <span class="nf">residual_block</span><span class="p">(</span><span class="n">layer_in</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">):</span>
    <span class="n">merge_input</span> <span class="o">=</span> <span class="n">layer_in</span>
    <span class="c1">#verifica se é necessária uma primeira camada para deixar o número de filtros iguais para adição</span>
    <span class="k">if</span> <span class="n">layer_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_filters</span><span class="p">:</span>
        <span class="n">merge_input</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">)(</span><span class="n">layer_in</span><span class="p">)</span>
    <span class="c1"># conv1</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">)(</span><span class="n">layer_in</span><span class="p">)</span>
    <span class="c1"># conv2</span>
    <span class="n">conv2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>
    <span class="c1"># soma entrada com saída (pulou 2 camadas)</span>
    <span class="n">layer_out</span> <span class="o">=</span> <span class="n">add</span><span class="p">([</span><span class="n">conv2</span><span class="p">,</span> <span class="n">merge_input</span><span class="p">])</span>
    <span class="c1"># função de ativação da saída do bloco</span>
    <span class="n">layer_out</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">layer_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">layer_out</span>

<span class="c1"># minha ResNet</span>
<span class="k">def</span> <span class="nf">ResNetModel</span><span class="p">():</span>
    <span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">layer1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
    <span class="n">pool1</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">layer1</span><span class="p">)</span>
    <span class="n">rblock1</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">pool1</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">avgpool</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">rblock1</span><span class="p">)</span>
    <span class="n">softmax</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)(</span><span class="n">avgpool</span><span class="p">)</span>
    <span class="n">ResNetModel</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">softmax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ResNetModel</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_sub</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">800</span><span class="p">]</span>
<span class="n">y_sub</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">800</span><span class="p">]</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="mi">800</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">800</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">)</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">lrs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>
<span class="n">losses_</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="n">lrs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LR:&#39;</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
        <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ResNetModel</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">),</span>
                      <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_sub</span><span class="p">,</span> <span class="n">y_sub</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                             <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">losses_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">LR final=</span><span class="si">%.6f</span><span class="s2">, Ent.Cruzada = </span><span class="si">%.4f</span><span class="s2">, Acuracia = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LR: 0.0001
	LR final=0.000085, Ent.Cruzada = 1.9485, Acuracia = 0.3950
	LR final=0.000085, Ent.Cruzada = 1.8882, Acuracia = 0.3575
	LR final=0.000085, Ent.Cruzada = 1.8224, Acuracia = 0.4100
	LR final=0.000085, Ent.Cruzada = 1.8741, Acuracia = 0.3350
	LR final=0.000085, Ent.Cruzada = 1.8473, Acuracia = 0.3325
LR: 0.0005
	LR final=0.000426, Ent.Cruzada = 1.1793, Acuracia = 0.5350
	LR final=0.000426, Ent.Cruzada = 1.2128, Acuracia = 0.5175
	LR final=0.000426, Ent.Cruzada = 1.1612, Acuracia = 0.5975
	LR final=0.000426, Ent.Cruzada = 1.2151, Acuracia = 0.5650
	LR final=0.000426, Ent.Cruzada = 1.1669, Acuracia = 0.5100
LR: 0.001
	LR final=0.000852, Ent.Cruzada = 1.0248, Acuracia = 0.6125
	LR final=0.000852, Ent.Cruzada = 1.0545, Acuracia = 0.6150
	LR final=0.000852, Ent.Cruzada = 1.0255, Acuracia = 0.5775
	LR final=0.000852, Ent.Cruzada = 1.0178, Acuracia = 0.6375
	LR final=0.000852, Ent.Cruzada = 1.0143, Acuracia = 0.6025
LR: 0.005
	LR final=0.004261, Ent.Cruzada = 0.9191, Acuracia = 0.6475
	LR final=0.004261, Ent.Cruzada = 0.9448, Acuracia = 0.6225
	LR final=0.004261, Ent.Cruzada = 0.8744, Acuracia = 0.6450
	LR final=0.004261, Ent.Cruzada = 0.8964, Acuracia = 0.6850
	LR final=0.004261, Ent.Cruzada = 0.8641, Acuracia = 0.6700
LR: 0.01
	LR final=0.008521, Ent.Cruzada = 1.0767, Acuracia = 0.6125
	LR final=0.008521, Ent.Cruzada = 1.3260, Acuracia = 0.4200
	LR final=0.008521, Ent.Cruzada = 1.0721, Acuracia = 0.6125
	LR final=0.008521, Ent.Cruzada = 1.6341, Acuracia = 0.3600
	LR final=0.008521, Ent.Cruzada = 0.9414, Acuracia = 0.6375
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">losses_</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losses_</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lrs</span><span class="p">),</span><span class="mi">5</span><span class="p">))</span>
<span class="n">mean_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">lr</span><span class="p">,</span><span class="n">ma</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lrs</span><span class="p">,</span> <span class="n">mean_loss</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">LR=</span><span class="si">%.4f</span><span class="s2">, Perda Media = </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lr</span><span class="p">,</span><span class="n">ma</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	LR=0.0001, Perda Media = 1.876
	LR=0.0005, Perda Media = 1.187
	LR=0.0010, Perda Media = 1.027
	LR=0.0050, Perda Media = 0.900
	LR=0.0100, Perda Media = 1.210
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id48">
<h3>Questão 5)<a class="headerlink" href="#id48" title="Permalink to this heading">#</a></h3>
<p>Realize um procedimento de extração de características de imagens conforme os seguintes passos, parte dos quais já está disponivel no notebook fornecido:</p>
<ol class="arabic simple">
<li><p>Carregue e processe a base de dados “eurosat” do tensorflow-datasets conforme código disponível.</p></li>
<li><p>Carregue um modelo ResNet50V2 pré-treinado na ImageNet sem utilizar o topo da rede. Crie um modelo extrator de características incluindo a ResNet50V2 carregada seguida de uma camada de Global Max Pooling para realizar extração de 2048 características da base de dados.</p></li>
<li><p>Obtenha um array com as características extraídas a partir do modelo extrator criado no passo anterior</p></li>
<li><p>Utilizando as características obtidas referentes ao conjunto de treinamento, ajuste um modelo PCA com 200 componentes. Utilize o atributo <code class="docutils literal notranslate"><span class="pre">explained_variance_ratio_</span></code> e compute a porcentagem da variância retida nesses 200 componentes (somadas).</p></li>
</ol>
<p>Em qual intervalo recai a soma da porcentagem da variância retida nas 200 componentes principais?</p>
<p>(a) 15 a 32%<br>
(b) 33 a 47%<br>
(c) 48 a 60%<br>
(d) 61 a 76%<br>
<font color='red'>(e) 77 a 91%<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Passo 1 - carregar e preparar dados</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="n">download_url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/torchgeo/eurosat/resolve/c4629ffcef452ee1dd8025fb71c57a0dfb4ba61c/EuroSAT.zip&quot;</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">builder</span><span class="p">(</span><span class="s1">&#39;eurosat&#39;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">builder_config</span><span class="o">.</span><span class="n">download_url</span> <span class="o">=</span> <span class="n">download_url</span>
<span class="n">builder</span><span class="o">.</span><span class="n">download_and_prepare</span><span class="p">()</span>

<span class="n">train_ds</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;eurosat&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[50%:70%]&#39;</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Normalizes images: `uint8` -&gt; `float32`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># redimensionando exemplos e normalizando entre 0-1 tipo float32</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">input_shape</span> <span class="o">=</span> <span class="n">img_size</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading and preparing dataset 89.91 MiB (download: 89.91 MiB, generated: Unknown size, total: 89.91 MiB) to /root/tensorflow_datasets/eurosat/rgb/2.0.0...
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "013159b9cd544aa4af349c4f4d07a8e7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b3fb59631761476ea9bd3d1e52ea2a48", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4f933b4b271b43e5bfcf627013d2bc71", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8fd6dd6a08ce4678ac0873251c64f577", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d4f31da6963b4343b9c17a567bba51ac", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e71ac063cd894b6f9b9d5623fd742d56", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset eurosat downloaded and prepared to /root/tensorflow_datasets/eurosat/rgb/2.0.0. Subsequent calls will reuse this data.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">15</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fd7485ba0855c72655132fb22886cc7c745b23612ea1c0adc1091a8d9258b378.png" src="../_images/fd7485ba0855c72655132fb22886cc7c745b23612ea1c0adc1091a8d9258b378.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">ResNet50V2</span><span class="p">(</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># obtemos a camada de saída do modelo carregado (última camada pois não incluímos o topo da rede)</span>
<span class="n">base_output</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
<span class="c1"># camada extratora</span>
<span class="n">feat_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling2D</span><span class="p">()(</span><span class="n">base_output</span><span class="p">)</span>

<span class="c1"># montamos um novo modelo com a entrada do pré-treinado, e saída criada acima</span>
<span class="n">model_features</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">feat_layer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/resnet/resnet50v2_weights_tf_dim_ordering_tf_kernels_notop.h5
94668760/94668760 [==============================] - 3s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Dados x features obtidas treinamento: &#39;</span><span class="p">,</span> <span class="n">features_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>85/85 [==============================] - 13s 50ms/step
	Dados x features obtidas treinamento:  (5400, 2048)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># pca com dados da ImageNet - InceptionV3</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">)</span>
<span class="n">pca_train_imagenet</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variancia retida nos 200 componentes principais: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variancia retida nos 200 componentes principais: 83.9
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-darkred-modulo-iv-estrategias-de-treinamento-e-transferencia-de-aprendizado-span">
<h2><span style="color:darkred">Módulo IV - Estratégias de Treinamento e Transferência de Aprendizado</span><a class="headerlink" href="#span-style-color-darkred-modulo-iv-estrategias-de-treinamento-e-transferencia-de-aprendizado-span" title="Permalink to this heading">#</a></h2>
<section id="id49">
<h3><span style="color:darkred">Exercícios (com soluções)</span><a class="headerlink" href="#id49" title="Permalink to this heading">#</a></h3>
</section>
</section>
<section id="id50">
<h2>Parte 1 - Exercícios Essenciais<a class="headerlink" href="#id50" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="id51">
<h3>Exercício 1)<a class="headerlink" href="#id51" title="Permalink to this heading">#</a></h3>
<p>Modelos de redes neurais com alta capacidade, isso é, com grande quantidade de parâmetros, são capazes de:</p>
<p>(a) Generalizar muito bem sempre, para qualquer tipo de dados futuros<br>
(b) Gerar underfitting pois podem não conseguir convergir e portanto não se ajustam aos dados de treinamento<br>
<font color='red'>(c) Memorizar o conjunto de treinamento, ajustando até mesmo rótulos aleatórios<br></font>
(d) Obter robustez com relação à possíveis ataques<br></p>
<p><strong>Justificativa:</strong> se possuirem capacidade suficiente, podem memorizar o conjunto de treinamento completo com rótulos aleatórios. Modelos com muitos parâmetros podem falhar em generalizar, comumente não geram underfitting - pelo contrário, tendem a obter overfitting nos dados de treinamento, e não há garantia de robustez à ataques.</p>
</section>
<hr class="docutils" />
<section id="id52">
<h3>Exercício 2)<a class="headerlink" href="#id52" title="Permalink to this heading">#</a></h3>
<p>Métodos diretamente relacionados a evitar que redes neurais profundas convirjam para o modelo “memorizador” incluem:</p>
<p><font color='red'>(a) Evitar treinar por número de épocas excessivas, técnicas de regularização e obtenção de conjuntos de treinamento maiores</font><br>
(b) Regularização, transferência de aprendizado e emprego de maior número de neurônios por camada<br>
(c) Ajustar corretamente o tamanho do batch, utilizar dropout e evitar o uso da função de ativação softmax<br>
(d) Regularização, aumento da quantidade de dados de treinamento e uso de funções de ativação do tipo ReLU<br></p>
<p><strong>Justificativa</strong>: as técnicas: transferência de aprendizado, ajuste do tamanho do batch, aumento de quantidade de neurônios por camada, função de ativação softmax ou relu não estão diretamente relacionadas ao efeito de memorização ou overfitting de modelos.</p>
</section>
<hr class="docutils" />
<section id="id53">
<h3>Exercício 3)<a class="headerlink" href="#id53" title="Permalink to this heading">#</a></h3>
<p>Considerando as funções de perda: entropia cruzada categórica e perda quadrática, qual é o valor das perdas para um exemplo arbitrário no caso o modelo considere as classes equiprováveis numa tarefa de classificação de 5 classes?</p>
<p>(a) <font color='red'>Entropia Cruzada = 1.6; Quadrática = 0.8</font><br>
(b) Entropia Cruzada = 2.3; Quadrática = 0.8<br>
(c) Entropia Cruzada = 1.6; Quadrática = 0.16<br>
(d) Entropia Cruzada = 0.32; Quadrática = 0.8<br></p>
<p>DICA: compare dois vetores de probabilidade, um com a classe real em <em>one-hot-encoding</em> e o outro exemplificando o caso equiprovável.</p>
<p><strong>Justificativa</strong>: veja código abaixo. Na média, numa inicialização aleatória, teríamos um classificador gerando um vetor de probabilidade com a distribuição aproximadamente uniforme, ou seja, todos os valores 0.2=1/5. Computando a entropia cruzada categórica, temos apenas o -log do valor predito para a classe verdadeira, enquanto que na quadrática, a soma dos erros cometidos ao longo do vetor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">yh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="n">loss_ec</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yh</span><span class="p">)))</span>

<span class="n">loss_qu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yh</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loss_ec</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loss_qu</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.6094379124341003
0.8000000000000002
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id54">
<h3>Exercício 4)<a class="headerlink" href="#id54" title="Permalink to this heading">#</a></h3>
<p>A projeção e visualização das saídas das camadas intermediárias da rede neural tem a função de</p>
<p>(a) Extrair melhores características a partir da rede neural<br>
(b) Evitar underfitting gerando magnitudes de gradientes mais extremas<br>
<font color='red'>(c) Melhor interpretar o espaço de características aprendido pela rede neural<br></font>
(d) Prevenir sobreposição entre as classes mesmo quando temos poucos dados<br></p>
<p><strong>Justificativa</strong>: a visualização das projeções auxilia na interpretação do que é aprendido com base nos dados de entrada. Essa projeção é uma forma de entender se o espaço de característica tem coerência com relação à tarefa alvo, a ser executada sob esse espaço.</p>
</section>
<hr class="docutils" />
<section id="id55">
<h3>Exercício 5)<a class="headerlink" href="#id55" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados Boston Housing, e padronize os dados (conforme código abaixo).</p>
<p>A seguir, considere as seguintes arquitetura de rede neural com camadas densas, todas com <strong>6</strong> neurônios nas camadas intenas/ocultas:</p>
<p>Arquitetura A (12 camadas):</p>
<ul class="simple">
<li><p>12 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada densa com 1 neurônio e ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
</ul>
<p>Arquitetura B (12 camadas com normalização em batch):</p>
<ul class="simple">
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada de normalização em batch</p></li>
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada de normalização em batch</p></li>
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada de normalização em batch</p></li>
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada de normalização em batch</p></li>
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada de normalização em batch</p></li>
<li><p>2 camadas densas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
<li><p>1 camada densa com 1 neurônio e ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code></p></li>
</ul>
<p>Faremos 7 experimentos de treinamento, a partir de 7 configurações de sementes distintas. Dica: monte cada arquitetura em uma função do Python e retorne o modelo para facilitar o processo.</p>
<p>Cada experimento deve configurar os métodos seed() e set_seed() com os valores de 1 a 7.</p>
<p>Você deverá inicializar as sementes antes de criar cada modelo (A e B) na memória. Logo a seguir, compilar e treinar com a função de custo <code class="docutils literal notranslate"><span class="pre">mse</span></code>, o otimizador AdamW com taxa de aprendizado 0.004, 15 épocas, e tamanho de batch 32. Salve os históricos por época para cada experimento com relação à função de custo no treinamento e na validação.</p>
<p>Após os 5 experimentos, trace o gráfico do custo médio em cada época para os modelos A e B tanto do treinamento quanto da validação. Observando os gráficos, podemos dizer sobre o processo de convergência do custo, ou seja, seus valores ao longo das épocas:</p>
<p>(a) A: convergiu para um valor baixo de erro com erro na validação instável; B: convergiu para um valor baixo de erro com boa generalização<br>
(b) A: convergiu para um valor alto de erro com boa generalização; B: convergiu para valor mais baixo de erro com erro na validação estável mas diferente do erro no treinamento<br>
(c) A: convergiu para um valor alto de erro com boa generalização; B: convergiu para valor de erro similar à A, mas com erro na validação instável<br>
<font color='red'>(d) A: convergiu para um valor mais alto de erro com boa generalização; B: convergiu para valor mais baixo de erro, mas com maior diferença entre treinamento e validação<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">boston_housing</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">boston_housing</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1">#normalizacao max-min 0-1</span>
<span class="n">maxv</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">minv</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_train</span> <span class="o">-</span> <span class="n">minv</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">maxv</span><span class="o">-</span><span class="n">minv</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_test</span> <span class="o">-</span> <span class="n">minv</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">maxv</span><span class="o">-</span><span class="n">minv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_A</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="n">model1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">layers</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model1</span>

<span class="k">def</span> <span class="nf">model_B</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
    <span class="n">model2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)))</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">layers</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
        <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>

    <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">trainA</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valA</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">trainB</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valB</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot; - modelo A&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">modelA</span> <span class="o">=</span> <span class="n">model_A</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">modelA</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="mf">0.002</span><span class="p">),</span>
                   <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">)</span>
    <span class="n">historyA</span> <span class="o">=</span> <span class="n">modelA</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trainA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyA</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
    <span class="n">valA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyA</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">historyA</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">), modelo B&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">modelB</span> <span class="o">=</span> <span class="n">model_B</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">modelB</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="mf">0.002</span><span class="p">),</span>
                   <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">)</span>
    <span class="n">historyB</span> <span class="o">=</span> <span class="n">modelB</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trainB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyB</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
    <span class="n">valB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historyB</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">historyB</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1  - modelo A (586.16), modelo B (218.52)
2  - modelo A (64.93), modelo B (61.50)
3  - modelo A (56.36), modelo B (89.90)
4  - modelo A (586.16), modelo B (65.50)
5  - modelo A (586.16), modelo B (78.32)
6  - modelo A (81.58), modelo B (55.73)
7  - modelo A (586.16), modelo B (81.80)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainA</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;A treinamento&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valA</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;:r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;A validacao&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainB</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;B treinamento&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valB</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;:b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;B validacao&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7a0fd0436ec0&gt;
</pre></div>
</div>
<img alt="../_images/4d57d1f3c068ae5d6a3467c3b5bc45c7b57dd4dcf5017e521be4b3851d803208.png" src="../_images/4d57d1f3c068ae5d6a3467c3b5bc45c7b57dd4dcf5017e521be4b3851d803208.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="id56">
<h3>Exercício 6)<a class="headerlink" href="#id56" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados “eurosat” do tensorflow-datasets conforme código abaixo usando 20% dos dados iniciais como treinamento e os seguintes 10% para validação.</p>
<p>A seguir carregue um modelo <code class="docutils literal notranslate"><span class="pre">DenseNet121</span></code> pré-treinado na ImageNet. Iremos conectar a camada de número -11 desse modelo a uma camada de Global Average Pooling para realizar extração de características da base de dados. Devem ser 32 características no total.</p>
<p>OBS: para isso use: <code class="docutils literal notranslate"><span class="pre">layers[-11].output</span></code></p>
<p>Obtenha um array com as características extraídas (sem treinar a rede) e treine um classificador SVM utilizando essas características.</p>
<p>Utilize o sklearn e o classificador no seguinte formato: <code class="docutils literal notranslate"><span class="pre">SVC(C=100,</span> <span class="pre">kernel=&quot;linear&quot;)</span></code></p>
<p>O resultado de classificação (acurácia) no conjunto de validação está em qual intervalo?</p>
<p>(a) 11 a 16%<br>
(b) 26 a 31%<br>
(c) 40 a 46%<br>
<font color='red'>(d) 57 a 63%<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">validation_ds</span><span class="p">)</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s2">&quot;eurosat&quot;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train[0%:20%]&quot;</span><span class="p">,</span> <span class="s2">&quot;train[20%:30%]&quot;</span><span class="p">],</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Normalizes images: `uint8` -&gt; `float32`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span> <span class="n">label</span>

<span class="c1"># redimensionando exemplos e normalizando entre 0-1 tipo float32</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">input_shape</span> <span class="o">=</span> <span class="n">img_size</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># obtem rotulos no formato para uso no SVM do sklearn</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">train_ds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">val_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">validation_ds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading and preparing dataset 89.91 MiB (download: 89.91 MiB, generated: Unknown size, total: 89.91 MiB) to /root/tensorflow_datasets/eurosat/rgb/2.0.0...
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5d1e2e74207d4470932112d9efa401c9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5701465ffc6049068885d50e8c82d3ea", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9668d0220f0e4e05ac3ca78ac6abb2b0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "76cca7ad7fe4406085c99b6f4aaef28f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "795abac22bf848a380b5249c92d80f75", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2432f3a204fa4dab8f59e97c25f428fe", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset eurosat downloaded and prepared to /root/tensorflow_datasets/eurosat/rgb/2.0.0. Subsequent calls will reuse this data.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">15</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08f1834a4f52e2cfa3e514536710a0280bf013d1f24e2855106c9963b2dfb751.png" src="../_images/08f1834a4f52e2cfa3e514536710a0280bf013d1f24e2855106c9963b2dfb751.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">DenseNet121</span><span class="p">(</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
    <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># obtemos a camada de saída do modelo carregado (obtendo a camada -11)</span>
<span class="n">base_output</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
<span class="c1"># camada extratora</span>
<span class="n">feat_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">base_output</span><span class="p">)</span>
<span class="c1"># montamos um novo modelo com a entrada do pré-treinado, e saída criada acima</span>
<span class="n">model_features</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">feat_layer</span><span class="p">)</span>
<span class="c1">#model_features.summary()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># passando os exemplos de treinamento pela rede sem treinamento</span>
<span class="c1"># o &quot;predict&quot; vai nos dar a saída programada, obtida da GlobalAveragePooling2D</span>
<span class="n">features_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>
<span class="n">features_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Dados x features obtidas treinamento: &#39;</span><span class="p">,</span> <span class="n">features_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Dados x features obtidas validacao: &#39;</span><span class="p">,</span> <span class="n">features_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>169/169 [==============================] - 6s 20ms/step
85/85 [==============================] - 1s 11ms/step
	Dados x features obtidas treinamento:  (5400, 32)
	Dados x features obtidas validacao:  (2700, 32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>

<span class="n">svm_feat1</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">svm_feat1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-5 {color: black;background-color: white;}#sk-container-id-5 pre{padding: 0;}#sk-container-id-5 div.sk-toggleable {background-color: white;}#sk-container-id-5 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-5 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-5 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-5 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-5 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-5 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-5 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-5 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-5 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-5 div.sk-item {position: relative;z-index: 1;}#sk-container-id-5 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-5 div.sk-item::before, #sk-container-id-5 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-5 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-5 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-5 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-5 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-5 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-5 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-5 div.sk-label-container {text-align: center;}#sk-container-id-5 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-5 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>SVC(C=100, kernel=&#x27;linear&#x27;, random_state=0)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" checked><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">SVC</label><div class="sk-toggleable__content"><pre>SVC(C=100, kernel=&#x27;linear&#x27;, random_state=0)</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acurácia Treinamento: </span><span class="si">%.1f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svm_feat1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acurácia Validacao: </span><span class="si">%.1f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svm_feat1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_val</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia Treinamento: 62.8%
Acurácia Validacao: 61.7%
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id57">
<h3>Exercício 7)<a class="headerlink" href="#id57" title="Permalink to this heading">#</a></h3>
<p>Utilizando a biblioteca Keras, investige os hiperparâmetros relacionadas a learning rate na base de dados Boston Housing. Carregue a base de dados e normalize os atributos com z-score. Crie uma rede com camadas densas: 16, 8 e 1 (de saída), todas com ativação <code class="docutils literal notranslate"><span class="pre">relu</span></code>, função de custo <code class="docutils literal notranslate"><span class="pre">mse</span></code>, medindo também a <code class="docutils literal notranslate"><span class="pre">mae</span></code> como avaliação adicional.</p>
<p>Iremos investigar o uso de decaimento de learning rate, a partir de um valor inicial estabelecido. Para isso vamos usar um conjunto de validação de 20% retirado a partir do conjunto de testes, e repetir 5 vezes, cada vez utilizando uma semente, de 1 até 5, conforme código base abaixo.</p>
<p>Treine por 20 épocas com batchsize 24 e com o otimizador AdamW, 2 arquiteturas diferentes:</p>
<p><em>A</em>. Uso dos parâmetros padrão<br>
<em>B</em>. Iniciando com learning rate 0.01 e decaimento exponencial de 0.075 a partir da época 3</p>
<p>Posteriormente, treine os dois modelos, porém agora com o conjunto de treinamento completo e avalie no conjunto de teste.</p>
<p>Considerando a média dos valores de erro (MSE e MAE) obtidos na validação arredondados para um número inteiro (ou seja, sem considerar as casas decimais), e posteriormente os mesmos erros quando treinado com o conjunto completo e avaliados no teste:</p>
<p>(a) B obteve menores valores de erro (MSE e MAE) do que A na validação, B também tem MAE menor do que A no teste, mas ambos foram similares no MSE do teste<br>
<font color='red'>(b) B obteve menores valores de erro (MSE e MAE) do que A na validação e no teste<br></font>
(c) A obteve valores de erro MAE menores do que B, mas valores MSE maiores do que B na validação e no teste.<br>
(d) A obteve valores de erro MAE e MSE similares com B validação e no teste<br></p>
<p><strong>Justificativa</strong>: Notar no código abaixo que A obteve no treinamento MSE e MAE maiores do que o modelo B, sendo que o modelo B também tem uma generalizacao ligeiramente melhor (menor diferenca entre as medidas no treinamento e validacao).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">boston_housing</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">boston_housing</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">x_train</span> <span class="o">-=</span> <span class="n">mean</span>
<span class="n">x_train</span> <span class="o">/=</span> <span class="n">std</span>

<span class="n">x_test</span> <span class="o">-=</span> <span class="n">mean</span>
<span class="n">x_test</span> <span class="o">/=</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">my_dnn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.075</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lr</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># arrays para conter os erros</span>
<span class="n">mses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">maes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># para cada semente</span>
<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">x_trains</span><span class="p">,</span> <span class="n">x_val</span><span class="p">,</span> <span class="n">y_trains</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">sd</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Seed&quot;</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">modelA</span> <span class="o">=</span> <span class="n">my_dnn</span><span class="p">((</span><span class="n">x_trains</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">modelA</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
    <span class="n">modelA</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_trains</span><span class="p">,</span> <span class="n">y_trains</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">modelB</span> <span class="o">=</span> <span class="n">my_dnn</span><span class="p">((</span><span class="n">x_trains</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="n">modelB</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
    <span class="n">modelB</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_trains</span><span class="p">,</span> <span class="n">y_trains</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">modelA</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">modelB</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">maes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># converte em array e refaz o formato para que fiquem 5 execucoes (linhas) e 2 modelos (A e B)</span>
<span class="n">mses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mses</span><span class="p">)</span>
<span class="n">mses</span> <span class="o">=</span> <span class="n">mses</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

<span class="n">maes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maes</span><span class="p">)</span>
<span class="n">maes</span> <span class="o">=</span> <span class="n">maes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

<span class="n">mean_mses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean_maes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">maes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validacao</span><span class="se">\t</span><span class="s1">MSE</span><span class="se">\t</span><span class="s1">MAE&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">met</span><span class="p">,</span><span class="n">mse1</span><span class="p">,</span><span class="n">mae1</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;Default LR&#39;</span><span class="p">,</span> <span class="s1">&#39;Scheduling&#39;</span><span class="p">],</span> <span class="n">mean_mses</span><span class="p">,</span> <span class="n">mean_maes</span><span class="p">):</span>
       <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.0f</span><span class="se">\t</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">mse1</span><span class="p">,</span><span class="n">mae1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed 1
Seed 2
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 70 calls to &lt;function Model.make_test_function.&lt;locals&gt;.test_function at 0x7a0f19738820&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed 3
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 13 calls to &lt;function Model.make_test_function.&lt;locals&gt;.test_function at 0x7a0f195f15a0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed 4
Seed 5
Validacao	MSE	MAE
Default LR	89	7
Scheduling	17	3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># avalia novamentem agora no teste!</span>
<span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
<span class="n">modelA</span> <span class="o">=</span> <span class="n">my_dnn</span><span class="p">((</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="n">modelA</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
<span class="n">modelB</span> <span class="o">=</span> <span class="n">my_dnn</span><span class="p">((</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="n">modelB</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">modelA</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default LR&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">modelB</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scheduling&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Default LR [131.33001708984375, 9.529081344604492]
Scheduling [29.592296600341797, 3.6924495697021484]
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="parte-2-exercicios-complementares-opcionais">
<h3>Parte 2 - Exercícios Complementares/Opcionais<a class="headerlink" href="#parte-2-exercicios-complementares-opcionais" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id58">
<h3>Exercício 8)<a class="headerlink" href="#id58" title="Permalink to this heading">#</a></h3>
<p>Vamos utilizar imagens da base de dados <code class="docutils literal notranslate"><span class="pre">cifar10</span></code> carregada do TensorFlow Datasets. Considere o código abaixo que carrega essa base de dados (utilizamos um subconjunto de treinamento e validação), e seu posterior processamento. Redimensionamos as imagens para <span class="math notranslate nohighlight">\(96\times 96\)</span> para facilitar uso em CNNs pré-treinadas. Note também que é preciso obter codificação one-hot-encoding para as classes pois essa base de dados não é binária. Utilizaremos essa mesma base de dados nos exercícios subsequentes.</p>
<p>Vamos simular um cenário de poucos dados, utilizando apenas as 10% primeiras imagens da base de dados. Usando pre-fetch do tensorflow criaremos batches de 64 instâncias.</p>
<p>Crie uma rede neural com a seguinte arquitetura:</p>
<ol class="arabic simple">
<li><p>Camada de entrada para as imagens de 96 x 96 pixels</p></li>
<li><p>Modelo MobileNetV2 sem o topo (top=False) e sem carregar pesos (weight=None). Ver:
<a class="reference external" href="https://keras.io/api/applications/mobilenet/#mobilenetv2-function">https://keras.io/api/applications/mobilenet/#mobilenetv2-function</a></p></li>
<li><p>GlobalAveragePooling2D</p></li>
<li><p>Dropout com 25% de probabilidade</p></li>
<li><p>Camada Densa adequada à base de dados para classificação e função de custo entropia cruzada categórica</p></li>
</ol>
<p>Deixe o modelo MobileNetV2 <strong>não treinável</strong>.</p>
<p>Faça um experimento variando as sementes numpy e tensorflow 0, 1, 2 e 3, treinando e avaliando portanto 4 vezes e obtendo a média da entropia cruzada no treinamento e na validação. Cada modelo deve ser instanciado, compilado e treinado logo após a definição das sementes. Qual foi o intervalo do custo encontrado após obtidas as médias?</p>
<p><font color='red'>(a) Treinamento=[0.45,0.65]; Val=[0.65,0.85]<br></font>
(b) Treinamento=[0.45,0.65]; Val=[0.65,0.85]<br>
(c) Treinamento=[0.1,0.4]; Val=[0.45,0.65]<br>
(d) Treinamento=[0.1,0.4]; Val=[0.45,0.65]<br></p>
<p><strong>Justificativa</strong>: Notar no código abaixo a comparação.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="n">tfds</span><span class="o">.</span><span class="n">disable_progress_bar</span><span class="p">()</span>

<span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">validation_ds</span><span class="p">),</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s2">&quot;cifar10&quot;</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train[0%:10%]&quot;</span><span class="p">,</span> <span class="s2">&quot;train[10%:20%]&quot;</span><span class="p">],</span>
    <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">num_classes</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Classes: &quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Normalizes images: `uint8` -&gt; `float32`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span> <span class="n">label</span>

<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">normalize_img</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

<span class="n">input_shape</span> <span class="o">=</span> <span class="n">img_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Classes:  10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-24 10:24:16.002251: W tensorflow/core/kernels/data/cache_dataset_ops.cc:768] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/b53bcb436ab3ee3f6e48dd299c8dde2c6d956c16d31dcc73b8bbfa52cf58009a.png" src="../_images/b53bcb436ab3ee3f6e48dd299c8dde2c6d956c16d31dcc73b8bbfa52cf58009a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">label_preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="k">if</span> <span class="p">(</span><span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">label_preprocess</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span>
    <span class="p">)</span>
    <span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">label_preprocess</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">validation_ds</span> <span class="o">=</span> <span class="n">validation_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">####################</span>
<span class="n">data_augmentation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s2">&quot;horizontal&quot;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomContrast</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mycnn</span><span class="p">(</span><span class="n">augmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
        <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
        <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># essa será a única camada treinável</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_summary</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">trainLoss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valLoss</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mycnn</span><span class="p">(</span><span class="n">augmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scoresT</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scoresV</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trainLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss: </span><span class="si">%.4f</span><span class="s1"> Val Loss: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainLoss</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valLoss</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loss: 0.5092 Val Loss: 0.7328
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="exercicio-9">
<h3>Exercício 9)<a class="headerlink" href="#exercicio-9" title="Permalink to this heading">#</a></h3>
<p>Utilize a mesma base de dados, conforme carregada e pré-processada no exercício anterior.</p>
<p>Você deve agora criar uma camada, logo após a entrada, contendo aumento de dados:</p>
<ul class="simple">
<li><p>RandomFlip(“horizontal”),</p></li>
<li><p>RandomContrast(0.3),</p></li>
<li><p>RandomRotation(0.2),</p></li>
</ul>
<p>Qual foi o intervalo de custo médio no treinamento e validação?</p>
<p>(a) Treinamento=[0.7, 0.9]; Val=[0.55, 0.75]<br>
(b) Treinamento=[0.45, 0.65]; Val=[0.8, 1.0]<br>
(c) Treinamento=[0.1, 0.4]; Val=[0.55, 0.75]<br>
<font color='red'>(d) Treinamento=[0.7, 0.9]; Val=[0.8, 1.0]<br></font></p>
<p><strong>Justificativa</strong>: Notar no código abaixo a comparação. Veja que apesar de um custo maior os valores estão mais próximos. Seria preciso rodar por mais épocas pois temos maior diversidade nos dados.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">trainLoss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valLoss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mycnn</span><span class="p">(</span><span class="n">augmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scoresT</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scoresV</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trainLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Com aumento de dados&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Loss: </span><span class="si">%.4f</span><span class="s1"> Val Loss: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainLoss</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valLoss</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Com aumento de dados
	Loss: 0.8122 Val Loss: 0.9234
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="exercicio-10">
<h3>Exercício 10)<a class="headerlink" href="#exercicio-10" title="Permalink to this heading">#</a></h3>
<p>Similar ao exercício anterior,  agora descongele os pesos das últimas 4 camadas da MobileNet e treine por 5 épocas. <em>Não utilize aumento de dados</em>. <em>Não reutilize os modelos anteriores</em>, recarregue o modelo pré-treinado e refaça o treinamento agora permitindo que as últimas 4 camadas da MobileNet também se adaptem (além da camada de saída que foi inserida como classificadora).</p>
<p>Qual foi o intervalo de custo médio no treinamento e validação?</p>
<p><font color='red'>(a) Treinamento=[0.05, 0.3]; Val=[0.8, 1.0]<br></font>
(b) Treinamento=[0.4, 0.7]; Val=[0.5, 0.7]<br>
(c) Treinamento=[0.4, 0.7]; Val=[0.8, 1.0]<br>
(d) Treinamento=[0.05, 0.3]; Val=[0.5, 0.7]<br></p>
<p><strong>Justificativa</strong>: Notar no código abaixo a comparação.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mycnn</span><span class="p">(</span><span class="n">augmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trainable_top_layers</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">base_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span>
        <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
        <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># congelando as primeiras camadas, deixando apenas as ultimas treinaveis</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">base_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="o">-</span><span class="n">trainable_top_layers</span><span class="p">]:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># congela tambem camadas de BN</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">):</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">_per_input_updates</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">augmentation</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data_augmentation</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="s2">&quot;softmax&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># essa será a única camada treinável</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_summary</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">trainLoss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valLoss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mycnn</span><span class="p">(</span><span class="n">augmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trainable_top_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">scoresT</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scoresV</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_ds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trainLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">valLoss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoresV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Com ajuste fino das últimas camadas&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Loss: </span><span class="si">%.4f</span><span class="s1"> Val Loss: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trainLoss</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valLoss</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Com ajuste fino das últimas camadas
	Loss: 0.1544 Val Loss: 0.9376
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id59">
<h2>Módulo 4 - Treinamento de Redes Profundas<a class="headerlink" href="#id59" title="Permalink to this heading">#</a></h2>
<section id="entendendo-a-funcao-de-custo-entropia-cruzada-cross-entropy">
<h3>Entendendo a função de custo entropia cruzada (cross-entropy)<a class="headerlink" href="#entendendo-a-funcao-de-custo-entropia-cruzada-cross-entropy" title="Permalink to this heading">#</a></h3>
<p>A <strong>entropia cruzada</strong> é amplamente utilizada, mas, ao contrário da <strong>perda quadrática</strong>, mais conhecida e de fácil interpretação, não é tão intuitiva.</p>
<p>Há dois formatos básicos dessa função:</p>
<ul class="simple">
<li><p>Entropia cruzada binária: utilizada para duas classes
$<span class="math notranslate nohighlight">\(-\frac{1}{N} \sum_{i=1}^N y_i \log \hat{y}_i + (1-y_i) \log (1-\hat{y}_i)\)</span>$</p></li>
<li><p>Entropia cruzada categórica: problemas multiclasse
$<span class="math notranslate nohighlight">\(-\frac{1}{N} \sum_{i=1}^N y_i \log \hat{y}_i\)</span>$</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="n">loss_ec</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="o">+</span><span class="mf">.0001</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y_hat</span> <span class="o">+</span><span class="mf">.0001</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">loss_ec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;perda entropia cruzada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;em relaçao a </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.     0.0526 0.1053 0.1579 0.2105 0.2632 0.3158 0.3684 0.4211 0.4737
 0.5263 0.5789 0.6316 0.6842 0.7368 0.7895 0.8421 0.8947 0.9474 1.    ]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;em relaçao a 1.0&#39;)
</pre></div>
</div>
<img alt="../_images/2bff3064153dab4486495d15a790042b6760b0695e3563a68e339dc6b99d6e02.svg" src="../_images/2bff3064153dab4486495d15a790042b6760b0695e3563a68e339dc6b99d6e02.svg" /></div>
</div>
<p>Vamos comparar com a perda quadrática, por ilustração</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y_hat</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">loss_q</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;perda quadrática&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;em relaçao a </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;em relaçao a 1.0&#39;)
</pre></div>
</div>
<img alt="../_images/fb8c5f5a2f4830914d511a9d63bfed44644229ea5dcc481e17aa4f0d8a065c85.svg" src="../_images/fb8c5f5a2f4830914d511a9d63bfed44644229ea5dcc481e17aa4f0d8a065c85.svg" /></div>
</div>
<p>Vamos estudar um exemplo em 1D</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.8</span><span class="p">,</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x19f3d8ccc90&gt;
</pre></div>
</div>
<img alt="../_images/a8cb378254b156cfa3fc824b49209257e0def1bf973331f54484ff1619f4c631.svg" src="../_images/a8cb378254b156cfa3fc824b49209257e0def1bf973331f54484ff1619f4c631.svg" /></div>
</div>
<p>Treinando um classificador para diferenciar as duas classes (0 e 1)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">logr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>
<span class="n">logr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># vamos pegar as probabilidades de cada elemento pertencer a classe 1</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">logr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># para obter as classes, fazemos uma limiarizacao das probabilidades</span>
<span class="n">y_clas</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y_clas</span><span class="p">[</span><span class="n">y_clas</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y_clas</span><span class="p">[</span><span class="n">y_clas</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classes       = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_clas</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p(y)          = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>classes       = [0. 0. 0. 0. 0. 1. 1. 1. 1. 1.]
p(y)          = [0.133 0.178 0.325 0.433 0.49  0.547 0.576 0.682 0.792 0.843]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">celoss_ind</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="o">+</span><span class="mf">.00001</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y_hat</span> <span class="o">+</span><span class="mf">.00001</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p(y)          = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Por instancia = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">celoss_ind</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cross Entropy (média) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">celoss_ind</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>p(y)          = [0.133 0.178 0.325 0.433 0.49  0.547 0.576 0.682 0.792 0.843]
Por instancia = [0.142 0.195 0.394 0.837 0.674 0.603 0.857 0.382 0.233 0.17 ]
Cross Entropy (média) = 0.449
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Adicionando uma nova classe ao problema, note que a função:
$<span class="math notranslate nohighlight">\(-\frac{1}{N} \sum_{i=1}^N y_i \log \hat{y}_i + (1-y_i) \log (1-\hat{y}_i)\)</span>$
não seria mais possível calcular como antes.</p>
<p>Assim, adotamos a entropia cruzada categórica, somando as divergências para cada classe
$<span class="math notranslate nohighlight">\(-\frac{1}{N} \sum_{i=1}^N y_i \log \hat{y}_i\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.8</span><span class="p">,</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">])</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">brg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x19f40635190&gt;
</pre></div>
</div>
<img alt="../_images/3262338292815ad84b09027bc422eb56acaa7a184233c82773e9f0a8fa18e62b.svg" src="../_images/3262338292815ad84b09027bc422eb56acaa7a184233c82773e9f0a8fa18e62b.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>
<span class="n">logr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y2</span><span class="p">)</span>

<span class="c1"># agora as probabilidades são para 3 classes</span>
<span class="c1"># então uma única probabilidade não é suficiente para obter a resposta</span>
<span class="n">y2_hat</span> <span class="o">=</span> <span class="n">logr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y2_hat</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0.856  0.1229 0.0211]
 [0.7999 0.1636 0.0364]
 [0.6033 0.2821 0.1146]
 [0.4587 0.3441 0.1971]
 [0.3851 0.3659 0.2489]
 [0.3149 0.379  0.3061]
 [0.282  0.3819 0.3362]
 [0.1704 0.3701 0.4595]
 [0.0806 0.3162 0.6032]
 [0.0491 0.2742 0.6768]]
</pre></div>
</div>
</div>
</div>
<p>Como os rótulos estão em formato discreto, vamos obter one-hot-encodings para computar o custo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="n">y2_onehot</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y one-hot-enc.= </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y2_onehot</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p(y)          = </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y2_hat</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">celoss_ind2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y2_onehot</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y2_hat</span><span class="o">+</span><span class="mf">.0001</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Por instancia = </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">celoss_ind2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cross Entropy (média) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">celoss_ind2</span><span class="p">[:])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">y2_onehot</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y one-hot-enc.= </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y2_onehot</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tensorflow&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id60">
<h2><em>Módulo 4 - Treinamento de Redes Profundas</em><a class="headerlink" href="#id60" title="Permalink to this heading">#</a></h2>
<section id="taxa-de-aprendizado">
<h3>Taxa de aprendizado<a class="headerlink" href="#taxa-de-aprendizado" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="preparando-dataset">
<h1>1. Preparando Dataset<a class="headerlink" href="#preparando-dataset" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Carregando dataset a partir de TensorFlow Datasets</span>
<span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_test</span><span class="p">),</span> <span class="n">ds_info</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;cifar10&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train[:12%]&#39;</span><span class="p">,</span> <span class="s1">&#39;test[:20%]&#39;</span><span class="p">],</span> 
                                         <span class="n">as_supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the image resolution</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Get the size of each set</span>
<span class="n">num_train_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_train</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">num_test_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">cardinality</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># Get the number of classes</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>

<span class="c1"># Print the obtained information</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolução: </span><span class="si">{</span><span class="n">input_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training Set: </span><span class="si">{</span><span class="n">num_train_examples</span><span class="si">}</span><span class="s2"> exemplos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing Set: </span><span class="si">{</span><span class="n">num_test_examples</span><span class="si">}</span><span class="s2"> exemplos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classes: </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resolução: (32, 32, 3)
Training Set: 6000 exemplos
Testing Set: 2000 exemplos
Classes: 10
</pre></div>
</div>
</div>
</div>
<p>Temos portando 60 mil exemplos de treinamento</p>
<p>Imagens de tamanho <span class="math notranslate nohighlight">\(28\times 28\)</span> e 10 classes.</p>
<p>Agora, o passo ideal é pré-processar as imagens para facilitar o processo de otimização das redes neurais:</p>
<ol class="arabic simple">
<li><p>Normalizar seus valores (para o intervalo 0-1)</p></li>
<li><p>Alterar a codificação das classes (para one-hot-encoding): teremos 10 neurônios na saída, não apenas 1</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># extrai primeiras 10 imagens para exibir</span>
<span class="n">list_images</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">list_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">list_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    
<span class="n">show_images</span><span class="p">(</span><span class="n">list_images</span><span class="p">,</span> <span class="n">list_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-10-08 17:38:56.727355: W tensorflow/core/kernels/data/cache_dataset_ops.cc:854] The calling iterator did not fully read the dataset being cached. In order to avoid unexpected truncation of the dataset, the partially cached contents of the dataset  will be discarded. This can happen if you have an input pipeline similar to `dataset.cache().take(k).repeat()`. You should use `dataset.take(k).cache().repeat()` instead.
</pre></div>
</div>
<img alt="../_images/67d7a87dcbdf26cc702b03aba49cac06c2faef97bf271e05f09a2fe29b884433.png" src="../_images/67d7a87dcbdf26cc702b03aba49cac06c2faef97bf271e05f09a2fe29b884433.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one_hot_label</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
    
<span class="c1"># Pre-processa imagens</span>
<span class="k">def</span> <span class="nf">preprocess_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1"># converte imagem para float32</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_image</span><span class="p">)</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">one_hot_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="definindo-rede-neural">
<h1>2. Definindo Rede Neural<a class="headerlink" href="#definindo-rede-neural" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">input_tensor</span>

    <span class="c1">#x = keras.layers.Conv2D(n_filters, kernel_size=3, strides=1, activation=&#39;relu&#39;, padding=&#39;same&#39;)(x)</span>
    
    <span class="c1"># Blocos separaveis em profundidade + MaxPooling</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DepthwiseConv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DepthwiseConv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Achatar a saída do bloco residual</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Camada densa/fully connected</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.325</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">output_tensor</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>  
    
    <span class="c1"># Cria o modelo com base na entrada e saída</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_tensor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<p>Definindo sementes e um subconjunto menor para testarmos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="explorando-diferentes-estrategias-para-o-learning-rate">
<h1>3. Explorando Diferentes Estratégias para o Learning Rate<a class="headerlink" href="#explorando-diferentes-estrategias-para-o-learning-rate" title="Permalink to this heading">#</a></h1>
<section id="learning-rate-fixo">
<h2>3.1 - Learning Rate Fixo<a class="headerlink" href="#learning-rate-fixo" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CNN1</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">CNN1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_14&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_15 (InputLayer)       [(None, 32, 32, 3)]       0         
                                                                 
 depthwise_conv2d_28 (Depth  (None, 32, 32, 3)         30        
 wiseConv2D)                                                     
                                                                 
 batch_normalization_28 (Ba  (None, 32, 32, 3)         12        
 tchNormalization)                                               
                                                                 
 activation_28 (Activation)  (None, 32, 32, 3)         0         
                                                                 
 max_pooling2d_28 (MaxPooli  (None, 16, 16, 3)         0         
 ng2D)                                                           
                                                                 
 depthwise_conv2d_29 (Depth  (None, 16, 16, 3)         30        
 wiseConv2D)                                                     
                                                                 
 batch_normalization_29 (Ba  (None, 16, 16, 3)         12        
 tchNormalization)                                               
                                                                 
 activation_29 (Activation)  (None, 16, 16, 3)         0         
                                                                 
 max_pooling2d_29 (MaxPooli  (None, 8, 8, 3)           0         
 ng2D)                                                           
                                                                 
 flatten_14 (Flatten)        (None, 192)               0         
                                                                 
 dense_28 (Dense)            (None, 128)               24704     
                                                                 
 dropout_3 (Dropout)         (None, 128)               0         
                                                                 
 dense_29 (Dense)            (None, 10)                1290      
                                                                 
=================================================================
Total params: 26078 (101.87 KB)
Trainable params: 26066 (101.82 KB)
Non-trainable params: 12 (48.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist1</span> <span class="o">=</span> <span class="n">CNN1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/16
188/188 [==============================] - 7s 29ms/step - loss: 2.6806 - accuracy: 0.1115 - val_loss: 2.3075 - val_accuracy: 0.0965
Epoch 2/16
188/188 [==============================] - 5s 26ms/step - loss: 2.3494 - accuracy: 0.1613 - val_loss: 2.2634 - val_accuracy: 0.1470
Epoch 3/16
188/188 [==============================] - 5s 25ms/step - loss: 2.2162 - accuracy: 0.2002 - val_loss: 2.1395 - val_accuracy: 0.2340
Epoch 4/16
188/188 [==============================] - 5s 25ms/step - loss: 2.1368 - accuracy: 0.2278 - val_loss: 2.0783 - val_accuracy: 0.2600
Epoch 5/16
188/188 [==============================] - 5s 28ms/step - loss: 2.0757 - accuracy: 0.2627 - val_loss: 2.0253 - val_accuracy: 0.2830
Epoch 6/16
188/188 [==============================] - 5s 26ms/step - loss: 2.0192 - accuracy: 0.2715 - val_loss: 1.9841 - val_accuracy: 0.2975
Epoch 7/16
188/188 [==============================] - 5s 27ms/step - loss: 1.9769 - accuracy: 0.2968 - val_loss: 1.9553 - val_accuracy: 0.3155
Epoch 8/16
188/188 [==============================] - 5s 27ms/step - loss: 1.9543 - accuracy: 0.3110 - val_loss: 1.9307 - val_accuracy: 0.3295
Epoch 9/16
188/188 [==============================] - 5s 27ms/step - loss: 1.9202 - accuracy: 0.3172 - val_loss: 1.9032 - val_accuracy: 0.3395
Epoch 10/16
188/188 [==============================] - 5s 26ms/step - loss: 1.8917 - accuracy: 0.3268 - val_loss: 1.8864 - val_accuracy: 0.3405
Epoch 11/16
188/188 [==============================] - 7s 39ms/step - loss: 1.8738 - accuracy: 0.3385 - val_loss: 1.8659 - val_accuracy: 0.3475
Epoch 12/16
188/188 [==============================] - 9s 46ms/step - loss: 1.8539 - accuracy: 0.3440 - val_loss: 1.8528 - val_accuracy: 0.3515
Epoch 13/16
188/188 [==============================] - 9s 46ms/step - loss: 1.8280 - accuracy: 0.3613 - val_loss: 1.8337 - val_accuracy: 0.3600
Epoch 14/16
188/188 [==============================] - 9s 45ms/step - loss: 1.8005 - accuracy: 0.3685 - val_loss: 1.8203 - val_accuracy: 0.3695
Epoch 15/16
188/188 [==============================] - 9s 48ms/step - loss: 1.7957 - accuracy: 0.3712 - val_loss: 1.8093 - val_accuracy: 0.3705
Epoch 16/16
188/188 [==============================] - 6s 30ms/step - loss: 1.7755 - accuracy: 0.3848 - val_loss: 1.7901 - val_accuracy: 0.3790
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-rate-alto">
<h2>3.2 - Learning Rate Alto<a class="headerlink" href="#learning-rate-alto" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>(muito alto)</strong></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modelo 2 - Learning Rate Alto (Adam)&quot;</span><span class="p">)</span>
<span class="n">CNN2</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.09</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist2</span> <span class="o">=</span> <span class="n">CNN2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Modelo 2 - Learning Rate Alto (Adam)
Epoch 1/16
188/188 [==============================] - 7s 27ms/step - loss: 2.5831 - accuracy: 0.1048 - val_loss: 2.3101 - val_accuracy: 0.1025
Epoch 2/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3137 - accuracy: 0.1013 - val_loss: 2.3105 - val_accuracy: 0.1025
Epoch 3/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3139 - accuracy: 0.1020 - val_loss: 2.3108 - val_accuracy: 0.1025
Epoch 4/16
188/188 [==============================] - 5s 26ms/step - loss: 2.3140 - accuracy: 0.1020 - val_loss: 2.3111 - val_accuracy: 0.1025
Epoch 5/16
188/188 [==============================] - 5s 26ms/step - loss: 2.3141 - accuracy: 0.1020 - val_loss: 2.3112 - val_accuracy: 0.1025
Epoch 6/16
188/188 [==============================] - 5s 27ms/step - loss: 2.3141 - accuracy: 0.1020 - val_loss: 2.3113 - val_accuracy: 0.1025
Epoch 7/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3141 - accuracy: 0.1020 - val_loss: 2.3114 - val_accuracy: 0.1025
Epoch 8/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3141 - accuracy: 0.1020 - val_loss: 2.3115 - val_accuracy: 0.1025
Epoch 9/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3141 - accuracy: 0.1020 - val_loss: 2.3115 - val_accuracy: 0.1025
Epoch 10/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3116 - val_accuracy: 0.1025
Epoch 11/16
188/188 [==============================] - 5s 25ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3116 - val_accuracy: 0.1025
Epoch 12/16
188/188 [==============================] - 5s 24ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3116 - val_accuracy: 0.1025
Epoch 13/16
188/188 [==============================] - 4s 24ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3116 - val_accuracy: 0.1025
Epoch 14/16
188/188 [==============================] - 5s 24ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3116 - val_accuracy: 0.1025
Epoch 15/16
188/188 [==============================] - 5s 28ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3117 - val_accuracy: 0.1025
Epoch 16/16
188/188 [==============================] - 5s 28ms/step - loss: 2.3142 - accuracy: 0.1020 - val_loss: 2.3117 - val_accuracy: 0.1025
</pre></div>
</div>
</div>
</div>
</section>
<section id="sgd-momentum-com-peso-0-9">
<h2>3.2 - SGD + Momentum com peso 0.9<a class="headerlink" href="#sgd-momentum-com-peso-0-9" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modelo 3- Momentum&quot;</span><span class="p">)</span>
<span class="n">CNN3</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN3</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.95</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">hist3</span> <span class="o">=</span> <span class="n">CNN3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Modelo 3- Momentum
Epoch 1/16
188/188 [==============================] - 6s 27ms/step - loss: 2.1598 - accuracy: 0.2215 - val_loss: 2.0331 - val_accuracy: 0.2850
Epoch 2/16
188/188 [==============================] - 5s 27ms/step - loss: 1.9048 - accuracy: 0.3102 - val_loss: 1.8176 - val_accuracy: 0.3470
Epoch 3/16
188/188 [==============================] - 5s 26ms/step - loss: 1.8008 - accuracy: 0.3553 - val_loss: 1.7466 - val_accuracy: 0.3620
Epoch 4/16
188/188 [==============================] - 5s 26ms/step - loss: 1.7346 - accuracy: 0.3733 - val_loss: 1.6851 - val_accuracy: 0.3915
Epoch 5/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6840 - accuracy: 0.3892 - val_loss: 1.7836 - val_accuracy: 0.3545
Epoch 6/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6455 - accuracy: 0.4058 - val_loss: 1.7370 - val_accuracy: 0.3645
Epoch 7/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6037 - accuracy: 0.4262 - val_loss: 1.6472 - val_accuracy: 0.4145
Epoch 8/16
188/188 [==============================] - 5s 26ms/step - loss: 1.5741 - accuracy: 0.4353 - val_loss: 1.6201 - val_accuracy: 0.4260
Epoch 9/16
188/188 [==============================] - 5s 26ms/step - loss: 1.5358 - accuracy: 0.4617 - val_loss: 1.8558 - val_accuracy: 0.3545
Epoch 10/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4999 - accuracy: 0.4608 - val_loss: 1.6156 - val_accuracy: 0.4330
Epoch 11/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4802 - accuracy: 0.4737 - val_loss: 1.6271 - val_accuracy: 0.4210
Epoch 12/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4419 - accuracy: 0.4763 - val_loss: 1.6144 - val_accuracy: 0.4395
Epoch 13/16
188/188 [==============================] - 5s 27ms/step - loss: 1.3934 - accuracy: 0.4933 - val_loss: 1.6401 - val_accuracy: 0.4340
Epoch 14/16
188/188 [==============================] - 5s 25ms/step - loss: 1.3780 - accuracy: 0.5047 - val_loss: 1.7071 - val_accuracy: 0.4180
Epoch 15/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3613 - accuracy: 0.5105 - val_loss: 1.7612 - val_accuracy: 0.4115
Epoch 16/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3445 - accuracy: 0.5083 - val_loss: 2.0586 - val_accuracy: 0.3400
</pre></div>
</div>
</div>
</div>
</section>
<section id="decaimento-de-learning-rate">
<h2>3.3 - Decaimento de Learning Rate<a class="headerlink" href="#decaimento-de-learning-rate" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>com learning Rate inicial um pouco mais alto</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modelo 4 - Decaimento de Learning Rate &quot;</span><span class="p">)</span>
<span class="n">CNN4</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN4</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Taxa inicial = &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">CNN4</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Modelo 4 - Decaimento de Learning Rate 
Taxa inicial =  0.002
</pre></div>
</div>
</div>
</div>
<p>Criando uma função “callback” para definir uma modificação no learning rate ao longo das épocas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
  <span class="c1">#print(&quot;Learning rate atual = &quot;, lr)</span>
  <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lr</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

<span class="n">hist4</span> <span class="o">=</span> <span class="n">CNN4</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> 
                 <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                 <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/16
188/188 [==============================] - 7s 27ms/step - loss: 2.0835 - accuracy: 0.2352 - val_loss: 2.1174 - val_accuracy: 0.2090 - lr: 0.0020
Epoch 2/16
188/188 [==============================] - 5s 26ms/step - loss: 1.8632 - accuracy: 0.3082 - val_loss: 1.9776 - val_accuracy: 0.2685 - lr: 0.0020
Epoch 3/16
188/188 [==============================] - 5s 28ms/step - loss: 1.7697 - accuracy: 0.3605 - val_loss: 1.7392 - val_accuracy: 0.3625 - lr: 0.0018
Epoch 4/16
188/188 [==============================] - 5s 26ms/step - loss: 1.7072 - accuracy: 0.3782 - val_loss: 1.6782 - val_accuracy: 0.3905 - lr: 0.0016
Epoch 5/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6697 - accuracy: 0.3892 - val_loss: 1.6710 - val_accuracy: 0.3825 - lr: 0.0015
Epoch 6/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6176 - accuracy: 0.4177 - val_loss: 1.6588 - val_accuracy: 0.3915 - lr: 0.0013
Epoch 7/16
188/188 [==============================] - 5s 27ms/step - loss: 1.5846 - accuracy: 0.4265 - val_loss: 1.6478 - val_accuracy: 0.3965 - lr: 0.0012
Epoch 8/16
188/188 [==============================] - 5s 27ms/step - loss: 1.5551 - accuracy: 0.4328 - val_loss: 1.6483 - val_accuracy: 0.3910 - lr: 0.0011
Epoch 9/16
188/188 [==============================] - 5s 27ms/step - loss: 1.5233 - accuracy: 0.4442 - val_loss: 1.6196 - val_accuracy: 0.4095 - lr: 9.9400e-04
Epoch 10/16
188/188 [==============================] - 5s 26ms/step - loss: 1.5018 - accuracy: 0.4608 - val_loss: 1.6180 - val_accuracy: 0.4095 - lr: 8.9900e-04
Epoch 11/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4605 - accuracy: 0.4750 - val_loss: 1.6287 - val_accuracy: 0.4075 - lr: 8.1300e-04
Epoch 12/16
188/188 [==============================] - 5s 27ms/step - loss: 1.4566 - accuracy: 0.4808 - val_loss: 1.6185 - val_accuracy: 0.4125 - lr: 7.3600e-04
Epoch 13/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4289 - accuracy: 0.4820 - val_loss: 1.6185 - val_accuracy: 0.4115 - lr: 6.6600e-04
Epoch 14/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4107 - accuracy: 0.4927 - val_loss: 1.6214 - val_accuracy: 0.4100 - lr: 6.0300e-04
Epoch 15/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3988 - accuracy: 0.5017 - val_loss: 1.6217 - val_accuracy: 0.4085 - lr: 5.4600e-04
Epoch 16/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3730 - accuracy: 0.5073 - val_loss: 1.6211 - val_accuracy: 0.4090 - lr: 4.9400e-04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modelo 5 - Decaimento de Learning Rate + AdamW&quot;</span><span class="p">)</span>
<span class="n">CNN5</span> <span class="o">=</span> <span class="n">XceptionCNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">CNN5</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

<span class="n">hist5</span> <span class="o">=</span> <span class="n">CNN5</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> 
                 <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                 <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Modelo 5 - Decaimento de Learning Rate + AdamW
Epoch 1/16
188/188 [==============================] - 7s 29ms/step - loss: 2.1631 - accuracy: 0.2218 - val_loss: 2.2652 - val_accuracy: 0.1515 - lr: 0.0020
Epoch 2/16
188/188 [==============================] - 5s 28ms/step - loss: 1.9461 - accuracy: 0.3022 - val_loss: 1.9179 - val_accuracy: 0.3365 - lr: 0.0020
Epoch 3/16
188/188 [==============================] - 6s 30ms/step - loss: 1.8087 - accuracy: 0.3563 - val_loss: 1.7408 - val_accuracy: 0.3885 - lr: 0.0018
Epoch 4/16
188/188 [==============================] - 6s 30ms/step - loss: 1.7280 - accuracy: 0.3790 - val_loss: 1.6957 - val_accuracy: 0.4025 - lr: 0.0016
Epoch 5/16
188/188 [==============================] - 5s 28ms/step - loss: 1.6563 - accuracy: 0.4158 - val_loss: 1.6630 - val_accuracy: 0.4055 - lr: 0.0015
Epoch 6/16
188/188 [==============================] - 5s 26ms/step - loss: 1.6063 - accuracy: 0.4282 - val_loss: 1.6443 - val_accuracy: 0.4210 - lr: 0.0013
Epoch 7/16
188/188 [==============================] - 5s 26ms/step - loss: 1.5590 - accuracy: 0.4443 - val_loss: 1.6261 - val_accuracy: 0.4135 - lr: 0.0012
Epoch 8/16
188/188 [==============================] - 5s 26ms/step - loss: 1.5076 - accuracy: 0.4695 - val_loss: 1.6107 - val_accuracy: 0.4235 - lr: 0.0011
Epoch 9/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4687 - accuracy: 0.4828 - val_loss: 1.6143 - val_accuracy: 0.4265 - lr: 9.9400e-04
Epoch 10/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4341 - accuracy: 0.4903 - val_loss: 1.6062 - val_accuracy: 0.4270 - lr: 8.9900e-04
Epoch 11/16
188/188 [==============================] - 5s 26ms/step - loss: 1.4117 - accuracy: 0.4942 - val_loss: 1.6197 - val_accuracy: 0.4240 - lr: 8.1300e-04
Epoch 12/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3771 - accuracy: 0.5142 - val_loss: 1.6027 - val_accuracy: 0.4350 - lr: 7.3600e-04
Epoch 13/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3531 - accuracy: 0.5220 - val_loss: 1.6128 - val_accuracy: 0.4275 - lr: 6.6600e-04
Epoch 14/16
188/188 [==============================] - 5s 26ms/step - loss: 1.3289 - accuracy: 0.5280 - val_loss: 1.5976 - val_accuracy: 0.4305 - lr: 6.0300e-04
Epoch 15/16
188/188 [==============================] - 5s 25ms/step - loss: 1.3059 - accuracy: 0.5398 - val_loss: 1.6097 - val_accuracy: 0.4365 - lr: 5.4600e-04
Epoch 16/16
188/188 [==============================] - 5s 26ms/step - loss: 1.2872 - accuracy: 0.5548 - val_loss: 1.6051 - val_accuracy: 0.4305 - lr: 4.9400e-04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist1</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist4</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist5</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Adam lr=.0001&quot;</span><span class="p">,</span> <span class="s2">&quot;Adam lr=.09&quot;</span><span class="p">,</span> <span class="s2">&quot;SGD lr=.01 m=.95&quot;</span><span class="p">,</span><span class="s2">&quot;Adam lr=.0002+dec&quot;</span><span class="p">,</span><span class="s2">&quot;AdamW lr=.0002+dec&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fb30491fad0&gt;
</pre></div>
</div>
<img alt="../_images/05ccd10224c0c83c3137e6695ce7919991468289638e5db4f85726d4c63cc7ef.png" src="../_images/05ccd10224c0c83c3137e6695ce7919991468289638e5db4f85726d4c63cc7ef.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist4</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist4</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="s1">&#39;b--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist5</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist5</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;SGD lr=.01 m=.95 (tre)&quot;</span><span class="p">,</span><span class="s2">&quot;SGD lr=.01 m=.95 (val)&quot;</span><span class="p">,</span><span class="s2">&quot;Adam lr=.0002+dec (tre)&quot;</span><span class="p">,</span><span class="s2">&quot;Adam lr=.0002+dec (val)&quot;</span><span class="p">,</span><span class="s2">&quot;AdamW lr=.0002+dec (tre)&quot;</span><span class="p">,</span><span class="s2">&quot;AdamW lr=.0002+dec (val)&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fb3a5d3fc90&gt;
</pre></div>
</div>
<img alt="../_images/a49f19d6f41a7a45491012e30c1159c0ecfc00a1fce38b246f99bafff18809dc.png" src="../_images/a49f19d6f41a7a45491012e30c1159c0ecfc00a1fce38b246f99bafff18809dc.png" />
</div>
</div>
</section>
<section id="span-style-color-darkred-modulo-5-redes-neurais-para-dados-sequenciais-span">
<h2><span style="color:darkred">Módulo 5 - Redes neurais para dados sequenciais</span><a class="headerlink" href="#span-style-color-darkred-modulo-5-redes-neurais-para-dados-sequenciais-span" title="Permalink to this heading">#</a></h2>
<section id="id61">
<h3><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id61" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id62">
<h3>Questão 1)<a class="headerlink" href="#id62" title="Permalink to this heading">#</a></h3>
<p>Considere as seguintes características de instâncias de um conjunto de treinamento:<br></p>
<p>I - Podem ser observadas/analisadas em qualquer ordem, inclusive aleatória, e manter a coerência da sua interpretação<br>
II - Podem possuir ruído ou um componente estocástico<br>
III - Considerando que são do tipo numérico, seus valores originais estão sempre no intervalo entre 0 e 1<br>
IV - Comumente uma instância está correlacionada com a próxima instância, em uma determinada ordem<br>
V - Dados do tipo string em formato texto livre<br></p>
<p>Quais características estão relacionadas a dados sequenciais, utilizados tipicamente em redes neurais recorrentes e suas variantes?</p>
<p>(a) I, II<br>
(b) I, II, IV<br>
(c) II, III<br>
(d) II, IV<br>
<font color='red'>(e) II, IV, V<br></font></p>
<p><strong>Justificativa</strong>: dados sequenciais usados em redes recorrentes possuem uma sequência que deve ser observada para que os dados possam ser interpretados, como uma sequência de dados organizados no tempo, ou uma sequência de texto ordenada, dessa forma, I é inválida, enquanto que IV é válida. Esses dados podem possuir ruído e continuar sendo sequenciais, portanto II é válida. Os seus valores originais não estão concentrados sempre entre 0 e 1, apesar de poderem ser normalizados para esse intervalo ou outros como entre -1 e 1. Finalmente, textos também são dados sequenciais, e são do tipo string validando a V.</p>
</section>
<hr class="docutils" />
<section id="id63">
<h3>Questão 2)<a class="headerlink" href="#id63" title="Permalink to this heading">#</a></h3>
<p>Qual o mecanismo que unidades recorrentes do tipo RNN clássica e GRU usam para considerar a sequência dos dados durante o aprendizado dos parâmetros do modelo?</p>
<p>(a) Gerar como saída o escalar referente ao produto interno entre as features da entrada anterior <span class="math notranslate nohighlight">\(t-1\)</span> com a entrada atual <span class="math notranslate nohighlight">\(t\)</span><br>
<font color='red'>(b) Utilizar a saída do neurônio na entrada atual <span class="math notranslate nohighlight">\(s\)</span> e utilizá-la em conjunto com a entrada da próxima observação <span class="math notranslate nohighlight">\(s+1\)</span> para gerar a saída do neurônio relativa a essa última observação</font><br>
(c) A saída de cada neurônio recorrente é combinada com a de outros neurônios na mesma camada, formando uma memória paralela da camada<br>
(d) Realizar a combinação linear entre as features da entrada por meio de uma matriz de pesos <span class="math notranslate nohighlight">\(W\)</span>, um parâmetro bias <span class="math notranslate nohighlight">\(b\)</span> e utilizando uma função de ativação para gerar a saída<br>
(e) Possuir um estado de célula <span class="math notranslate nohighlight">\(C_t\)</span> que é responsável por manter ou eliminar partes dos sumários anteriores e gerar a nova saída<br></p>
<p><strong>Justificativa</strong>: a alternativa (b) indica o mecanismo correto de sumário ou memória da unidade recorrente que utiliza a saída de um neurônio em conjunto com a entrada seguinte. As alternativas incorretas são (a) pois não é realizado um produto interno entre duas entradas subsequentes, (c) pois os neurônios de cada camada, em paralelo, não usam as saídas dos outros neurônios como entrada, nem mesmo é formada uma memória combinada da camada, (d) descreve uma camada densa convencional, (e) indica a memória/sumário extra da LSTM, e não das unidades RNN ou GRU.</p>
</section>
<section id="id64">
<h3>Questão 3)<a class="headerlink" href="#id64" title="Permalink to this heading">#</a></h3>
<p>Quais das alternativas descreve a saída de uma camada de atenção para uma entrada com um conjunto de valores de dados sequenciais?</p>
<p>(a) Define quais valores, ao longo de uma sequência de dados em diferentes iterações, serão processados, e quais serão ignorados, para produzir cada saída da camada de atenção, similar a uma camada de “dropout”.<br>
(b) Um vetor contendo scores entre 0 e 1 para ponderar os valores da entrada.<br>
(c) Um vetor memória acumulado ao longo das iterações de forma que um histórico de todos dados anteriores influencia na saída atual.<br>
<font color='red'>(d) Uma representação vetorial contextual, a qual é ponderada de acordo com a importância relativa, aprendida pela camada, entre os valores da entrada.<br></font>
(e) A similaridade entre cada par de valores da entrada.<br></p>
<p><strong>Justificativa:</strong> O mecanismo de atenção, captura relações entre os valores de entrada de forma a entender o contexto em que estão relacionados e gera como saída uma representação contextual que está ponderada pela importância relativa entre os dados de entrada a qual é aprendida por meio de uma função softmax - estando correta a alternativa (d).</p>
<p>As alternativas incorretas são (a) o mecanismo não define entradas a serem usadas ou ignoradas ao longo de iterações pois não possui memória, (b) apesar de aprender scores por meio de uma função softmax, essa não é a saída da camada, (c) a memória aprendida ao longo de iterações define a saída de camadas recorrentes, (e) a similaridade entre cada par de valores de entrada é calculada pela camada de atenção, sobre a qual é aplicada a função softmax, mas essa não é a saída da camada.</p>
</section>
<hr class="docutils" />
<section id="id65">
<h3>Questão 4)<a class="headerlink" href="#id65" title="Permalink to this heading">#</a></h3>
<p>Considere os seguintes casos de entrada e saída no contexto de redes neurais que processam dados sequenciais:</p>
<p>I - Entrada: texto livre de até 1000 caracteres contendo a reclamação de um cliente sobre um determinado, Saída: categoria do produto reclamado entre 1000 categorias possíveis<br>
II - Entrada: um espectrograma (imagem formada a partir de um áudio) representando uma frase proferida por uma pessoa. Saída: transcrição, palavra por palavra, da frase proferida<br>
III - Entrada: uma série temporal contendo valores numéricos do instante T1 até um instante TN. Saída: uma série temporal contendo a predição futura para os mesmos valores relativa aos instantes TN+1 até TN+10.<br>
IV - Entrada: frase no idioma Inglês. Saída: frase traduzida para o idioma Português<br></p>
<p>Quais dos casos acima representam o cenário implementado por meio de Sequence-to-Sequence?</p>
<p>(a) I, III<br>
(b) II, III, IV<br>
<font color='red'>(c) III, IV<br></font>
(d) IV<br>
(e) todos os casos<br></p>
<p><strong>Justificativa</strong>: I - possui como saída uma única categoria e não uma sequência; II - possui como entrada um único objeto (imagem espectrograma), não sendo uma sequência; III - entrada e saída são dados sequenciais, organizados temporalmente; IV - entrada e saída são dados sequenciais textuais.</p>
</section>
<hr class="docutils" />
<section id="id66">
<h3>Questão 5)<a class="headerlink" href="#id66" title="Permalink to this heading">#</a></h3>
<p>Execute um experimento para predição de valores futuros de uma série temporal. Use o código fornecido no notebook e complete para obter o resultado necessário.</p>
<p>A arquitetura a usar possui:</p>
<ul class="simple">
<li><p>Camada LSTM com 20 neuronios, retornando sequencias, ativação relu</p></li>
<li><p>Camada LSTM com 20 neuronios, sem retornar sequencias, ativação relu</p></li>
<li><p>Camada Dropout 0.2</p></li>
<li><p>Camada Densa de saída para predição univariada do próximo valor da série, ativação relu.</p></li>
</ul>
<p>Treinar com batch_size=1, por 10 épocas, usando Adam e learning_rate fixo = 0.00025.</p>
<p>Vamos explorar o treinamento com dados usando 3 time steps diferentes [1, 3, 6]. Para cada time step, gere os conjuntos de treinamento e validação correspondentes, e execute 10 treinamentos com as mesmas configurações e a use como semente 42. Veja código inicial, e complemente com os passos necessários.</p>
<p>Compute o mean squared error (MSE) para cada execução no conjunto de validação. Depois, excluindo o maior e o menor valor de MSE das 10 execuções, calcule e armazene a média e desvio padrão do MSE ao longo das diferentes seeds para cada configuração de time steps. Ou seja, a média e desvio serão calculados sobre 8 valores.</p>
<p>OBS: devido às várias repetições o experimento completo pode demorar até 10 minutos.</p>
<p>Considerando 3 casas decimais, qual(is) configuração de time steps gerou a menor média, e a maior média, respectivamente? Caso haja empate use o desvio padrão para desempatar (configuração com menor desvio padrão para desempatar a menor média, e com maior desvio padrão para desempatar maior média).</p>
<p>(a) Menor média = 1, Maior média = 6<br>
(b) Menor média = 3, Maior média = 1<br>
(c) Menor média = 3, Maior média = 6<br>
<font color='red'>(d) Menor média = 6, Maior média = 1<br></font>
(e) Menor média = 6, Maior média = 3<br></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">optimizers</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;price_of_ground_chuck.csv&quot;</span><span class="p">)</span>

<span class="c1"># pega segunda coluna do dataframe</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x786c1cd40610&gt;]
</pre></div>
</div>
<img alt="../_images/4113eb1bcb6d8a47a0ba4aee6a7b12d03fa49bc96728171ae4069f7550a8100b.png" src="../_images/4113eb1bcb6d8a47a0ba4aee6a7b12d03fa49bc96728171ae4069f7550a8100b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variaveis que definem divisao em treinamento e teste e controlam adição de ruído</span>
<span class="n">porc_treinamento</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">porc_validacao</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># calcula tamanhos dos dados de treinamento (n_train) e teste (n_test)</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_treinamento</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
<span class="n">n_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_validacao</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="p">)</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">val_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">n_train</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="p">]</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

<span class="c1"># normalização min-max com base no treinamento</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">train_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
<span class="n">val_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
<span class="n">test_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Treinamento: &quot;</span><span class="p">,</span> <span class="n">n_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Validacao: &quot;</span><span class="p">,</span> <span class="n">n_val</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Teste: &quot;</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de Treinamento:  144
Exemplos de Validacao:  36
Exemplos de Teste:  61
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">train_x_norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">val_x_norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="o">+</span><span class="n">n_test</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">test_x_norm</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Série preparada para os experimentos&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b3c993a0859677979635490c74da2bc1170a4525fca8cdb6ef74fd5bc5c325c4.png" src="../_images/b3c993a0859677979635490c74da2bc1170a4525fca8cdb6ef74fd5bc5c325c4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formato deve ser [samples, time steps, features]</span>
<span class="k">def</span> <span class="nf">recurrent_array</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">train_y_ts</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">time_steps</span><span class="p">:]</span>
    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">):</span>
        <span class="n">train_x_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">time_steps</span><span class="p">])</span>

    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x_ts</span><span class="p">)</span>

    <span class="c1">#rec_array = np.reshape(array, (array.shape[0], time_steps, array.shape[1]))</span>
    <span class="k">return</span> <span class="n">train_x_ts</span><span class="p">,</span> <span class="n">train_y_ts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_LSTM</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span>
    <span class="n">modelLSTM</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">modelLSTM</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.00025</span>

<span class="n">n_exp</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">time_steps_expr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">ts_models_mse_mu</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({(</span><span class="n">ts</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">time_steps_expr</span><span class="p">})</span>
<span class="n">ts_models_mse_sd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({(</span><span class="n">ts</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">time_steps_expr</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">time_steps</span> <span class="ow">in</span> <span class="n">time_steps_expr</span><span class="p">:</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time step = </span><span class="si">{</span><span class="n">time_steps</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>

    <span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>
    <span class="n">val_x_rec</span><span class="p">,</span> <span class="n">val_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">val_x_norm</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>

    <span class="n">models_mse</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_exp</span><span class="p">):</span>
        <span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model_LSTM</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
                        <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">))</span>

        <span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pred_v</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_x_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mse_v</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">val_y_rec</span><span class="p">,</span> <span class="n">pred_v</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">exp </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, mse = </span><span class="si">{</span><span class="n">mse_v</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">models_mse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse_v</span><span class="p">)</span>

    <span class="n">ts_models_mse_mu</span><span class="p">[</span><span class="n">time_steps</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">models_mse</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ts_models_mse_sd</span><span class="p">[</span><span class="n">time_steps</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">models_mse</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
Time step = 1:
	exp 0, mse = 0.0107
	exp 1, mse = 0.0513
	exp 2, mse = 0.0739
	exp 3, mse = 0.0248
	exp 4, mse = 0.0390
	exp 5, mse = 0.0150
	exp 6, mse = 0.0422
	exp 7, mse = 0.0497
	exp 8, mse = 0.0110
	exp 9, mse = 0.0312
--------------------------------------------------
Time step = 3:
	exp 0, mse = 0.0045
	exp 1, mse = 0.0055
	exp 2, mse = 0.0183
	exp 3, mse = 0.0233
	exp 4, mse = 0.0080
	exp 5, mse = 0.0488
	exp 6, mse = 0.0069
	exp 7, mse = 0.0269
	exp 8, mse = 0.0035
	exp 9, mse = 0.0090
--------------------------------------------------
Time step = 6:
	exp 0, mse = 0.0073
	exp 1, mse = 0.0100
	exp 2, mse = 0.0118
	exp 3, mse = 0.0057
	exp 4, mse = 0.0077
	exp 5, mse = 0.0085
	exp 6, mse = 0.0265
	exp 7, mse = 0.0077
	exp 8, mse = 0.0083
	exp 9, mse = 0.0052
--------------------------------------------------
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE  em validação&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ts_models_mse_mu</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time Step </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">, media = </span><span class="si">{</span><span class="n">ts_models_mse_mu</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> +- </span><span class="si">{</span><span class="n">ts_models_mse_sd</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
MSE  em validação
Time Step 1, media = 0.033 +- 0.014
Time Step 3, media = 0.013 +- 0.008
Time Step 6, media = 0.008 +- 0.002
==================================================
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="modulo-5-redes-neurais-para-dados-sequenciais-span">
<h2>Módulo 5 - Redes neurais para dados sequenciais</span><a class="headerlink" href="#modulo-5-redes-neurais-para-dados-sequenciais-span" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-lstms-e-grus-para-predicao-de-series-temporais-span">
<h3><span style="color:darkred"><strong>LSTMs e GRUs</strong> para predição de séries temporais</span><a class="headerlink" href="#span-style-color-darkred-lstms-e-grus-para-predicao-de-series-temporais-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="c1"># outros</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Alcohol_Sales.csv&#39;</span><span class="p">)</span>
<span class="c1">#df = read_csv(&#39;data/Miles_Traveled.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/starbucks.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/passengers.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/price_of_ground_chuck.csv&#39;)</span>

<span class="c1"># pega segunda coluna do dataframe</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Série: &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho da série: &quot;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Série:  S4248SM144NCEN
Tamanho da série:  325
</pre></div>
</div>
<img alt="../_images/82908a5d059d327dfdc74b55fce82d7ed956c96c585a6e7b7faa7b11420cffa3.png" src="../_images/82908a5d059d327dfdc74b55fce82d7ed956c96c585a6e7b7faa7b11420cffa3.png" />
</div>
</div>
</section>
</section>
<section id="parte-1-preparando-os-dados">
<h2>Parte 1: Preparando os dados<a class="headerlink" href="#parte-1-preparando-os-dados" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Separação em treinamento e teste</strong>: o treinamento sempre deve vir antes do teste no caso de dados sequenciais</p></li>
<li><p><strong>Normalização</strong>: aqui utilizaremos a normalização Min-Max para 0-1</p></li>
<li><p><strong>Inserção de ruído opcional</strong>: no treinamento e teste para avaliação da robustez dos modelos</p></li>
<li><p><strong>Formulação como aprendizado supervisionado</strong>: adequando os arrays de forma a permitir uso nas redes neurais</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variaveis que definem divisao em treinamento e teste e</span>
<span class="c1"># controlam adição de ruído</span>
<span class="n">porc_treinamento</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">inserir_ruido_serie</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">inserir_ruido_teste</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">porc_ruido</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calcula tamanhos dos dados de treinamento (n_train) e teste (n_test)</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_treinamento</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">-</span><span class="n">n_train</span><span class="o">+</span><span class="mi">1</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">n_train</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

<span class="c1"># normalização min-max com base no treinamento</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">train_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
<span class="n">test_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Treinamento: &quot;</span><span class="p">,</span> <span class="n">n_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Teste: &quot;</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de Treinamento:  227
Exemplos de Teste:  99
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># insere ruido na serie</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_serie</span><span class="p">):</span>
    <span class="n">train_x_norm</span> <span class="o">=</span> <span class="n">train_x_norm</span> <span class="o">+</span> \
                  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_train</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

<span class="c1"># insere ruido apenas no teste</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_teste</span><span class="p">):</span>
    <span class="n">test_x_norm</span> <span class="o">=</span> <span class="n">test_x_norm</span> <span class="o">+</span> \
                  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_test</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">train_x_norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="p">),</span> <span class="n">test_x_norm</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Série preparada para os experimentos&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5a2c53177ea5343fbcc7d27b6a438c9b59fec67391cb5cfd0ae86d4b1537e409.png" src="../_images/5a2c53177ea5343fbcc7d27b6a438c9b59fec67391cb5cfd0ae86d4b1537e409.png" />
</div>
</div>
<section id="formulacao-para-aprendizado-supervisionado-adequacao-dos-arrays">
<h3>Formulação para aprendizado supervisionado: adequação dos arrays<a class="headerlink" href="#formulacao-para-aprendizado-supervisionado-adequacao-dos-arrays" title="Permalink to this heading">#</a></h3>
<p>Podemos cumprir essa etapa utilizando a observação do último passo <span class="math notranslate nohighlight">\(t-1\)</span> como entrada e a observação atual <span class="math notranslate nohighlight">\(t\)</span> como saída.</p>
<p>Podemos alcançar isso deslocando todos os valores da série por um número específico de posições. Aqui vamos deslocar 1 posição para trás, que se tornarão as variáveis de entrada, sendo que a série temporal original será considerada como a variável de saída.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># modifica a serie temporal tornando-a um problema de aprendizado supervisionado</span>
<span class="c1"># retornando array de entrada x e de saída y</span>
<span class="k">def</span> <span class="nf">timeseries_to_supervised_dense</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># o reshape com -1 preenche a dimensão conforme necessário, nesse caso teremos (num_valores, 1)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">[:</span><span class="o">-</span><span class="n">look_back</span><span class="p">]),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">look_back</span><span class="p">:]),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">look_back</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">train_x_dense</span><span class="p">,</span> <span class="n">train_y_dense</span> <span class="o">=</span> <span class="n">timeseries_to_supervised_dense</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span>
                                                      <span class="n">look_back</span><span class="o">=</span><span class="n">look_back</span><span class="p">)</span>

<span class="c1"># numero de features na série</span>
<span class="n">no_features</span> <span class="o">=</span> <span class="n">train_x_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de treinamento x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros elementos de x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_dense</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho dos arrays de treinamento x e y
(226, 1)
(226, 1)

Primeiros elementos de x e y
[[0.05478751]
 [0.0546595 ]]

[[0.0546595 ]
 [0.12429595]]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="parte-2-utilizando-unidades-densas-para-predicao">
<h2>Parte 2: Utilizando unidades Densas para predição<a class="headerlink" href="#parte-2-utilizando-unidades-densas-para-predicao" title="Permalink to this heading">#</a></h2>
<p>Vamos tentar aprender a partir da série para obter um tipo de regressão</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">MLP</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_features</span><span class="p">)))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense (Dense)               (None, None, 16)          32        
                                                                 
 dense_1 (Dense)             (None, None, 32)          544       
                                                                 
 dropout (Dropout)           (None, None, 32)          0         
                                                                 
 dense_2 (Dense)             (None, None, 1)           33        
                                                                 
=================================================================
Total params: 609 (2.38 KB)
Trainable params: 609 (2.38 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># decaimento de learning rate</span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">):</span>
      <span class="n">lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Época </span><span class="si">%04d</span><span class="s2"> - learning rate </span><span class="si">%.9f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lr</span>


<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compilacao e treinamento</span>
<span class="n">MLP</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="n">histMLP</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_dense</span><span class="p">,</span> <span class="n">train_y_dense</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Época 0000 - learning rate 0.000100000
Época 0020 - learning rate 0.000085215
Época 0040 - learning rate 0.000069766
Época 0060 - learning rate 0.000057120
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_dense</span><span class="p">,</span> <span class="n">train_y_dense</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histMLP</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0144
MAE: 0.0864
</pre></div>
</div>
<img alt="../_images/1e955f656655fb2bdae5c44739957a7d5494250f1d10d49a876f1667532bbbbb.png" src="../_images/1e955f656655fb2bdae5c44739957a7d5494250f1d10d49a876f1667532bbbbb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_x_dense</span><span class="p">,</span> <span class="n">test_y_dense</span> <span class="o">=</span> <span class="n">timeseries_to_supervised_dense</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">,</span>
                                                        <span class="n">look_back</span><span class="o">=</span><span class="n">look_back</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_x_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_y_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros elementos de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_x_dense</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho dos arrays de teste x e y
(98, 1)
(98, 1)

Primeiros 4 elementos de teste x e y
[[0.874936  ]
 [1.07834101]
 [0.49539171]
 [0.63786482]]
[[1.07834101]
 [0.49539171]
 [0.63786482]
 [0.87058372]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_pred</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_dense</span><span class="p">)</span>
<span class="n">train_y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_pred</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">test_y_pred</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_dense</span><span class="p">)</span>
<span class="n">test_y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_pred</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 2ms/step
4/4 [==============================] - 0s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">test_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">test_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/adfddef6d1daff86d204368079f2974129886fa861f39bc7bd9a5719339b0d3a.png" src="../_images/adfddef6d1daff86d204368079f2974129886fa861f39bc7bd9a5719339b0d3a.png" />
<img alt="../_images/400b9de8cf24923684949184ee61b8e2334d1a5cba575adae5251ca6ba42904c.png" src="../_images/400b9de8cf24923684949184ee61b8e2334d1a5cba575adae5251ca6ba42904c.png" />
</div>
</div>
</section>
<section id="parte-3-utilizando-lstms-para-predicao">
<h2>Parte 3 : Utilizando LSTMs para predição<a class="headerlink" href="#parte-3-utilizando-lstms-para-predicao" title="Permalink to this heading">#</a></h2>
<p>Agora utilizaremos uma rede neural baseada em camada recorrente, permitindo aprender a sequência.</p>
<p>Uma camada LSTM espera como entrada um tensor com as seguintes dimensões:</p>
<p>samples x time_steps x features</p>
<ul class="simple">
<li><p><em>Samples</em> são as observações independentes do domínio, tipicamente colunas de dados, consideradas no batch</p></li>
<li><p><em>Time steps</em> são os passos temporais separados de uma dada variável para uma dada observação - quantas observações serão dadas como entrada antes de que a primeira saída seja obtida</p></li>
<li><p><em>Features</em> são as medidas separadas observada em cada tempo da observação - quantos valores são considerados em cada entrada</p></li>
</ul>
<p>No caso dessa base de dados, podemos usar diferentes configurações. Para manter simples, consideramos que o problema em cada passo de tempo é uma amostra individual, com um time step e uma feature apenas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formato deve ser [samples, time steps, features]</span>
<span class="k">def</span> <span class="nf">recurrent_array</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">train_y_ts</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">time_steps</span><span class="p">:]</span>
    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">):</span>
        <span class="n">train_x_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">time_steps</span><span class="p">])</span>

    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x_ts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">train_x_ts</span><span class="p">,</span> <span class="n">train_y_ts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_steps</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span>
                                           <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>

<span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">,</span>
                                         <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dados de treinamento para rede recorrente&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros 4 elementos de treinamento x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_rec</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dados de treinamento para rede recorrente
Tamanho dos arrays de teste x e y
(225, 2, 1)
(225, 1)

Primeiros 4 elementos de treinamento x e y
[[[0.05478751]
  [0.0546595 ]]

 [[0.0546595 ]
  [0.12429595]]

 [[0.12429595]
  [0.19623656]]

 [[0.19623656]
  [0.15232975]]]

[[0.12429595]
 [0.19623656]
 [0.15232975]
 [0.19175627]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_x_dense</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.05478751],
       [0.0546595 ],
       [0.12429595],
       [0.19623656],
       [0.15232975],
       [0.19175627]])
</pre></div>
</div>
</div>
</div>
<section id="rede-com-unidades-lstm">
<h3>Rede com unidades LSTM<a class="headerlink" href="#rede-com-unidades-lstm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">modelLSTM</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_features</span><span class="p">)))</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span> <span class="c1"># 32</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 lstm (LSTM)                 (None, None, 16)          1152      
                                                                 
 lstm_1 (LSTM)               (None, 32)                6272      
                                                                 
 dropout_1 (Dropout)         (None, 32)                0         
                                                                 
 dense_3 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 7457 (29.13 KB)
Trainable params: 7457 (29.13 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># compilacao e treinamento</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="n">histLSTM</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Época 0000 - learning rate 0.000100000
Época 0020 - learning rate 0.000085215
Época 0040 - learning rate 0.000069766
Época 0060 - learning rate 0.000057120
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histLSTM</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento LSTM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0134
MAE: 0.0888
</pre></div>
</div>
<img alt="../_images/f906ee9bed9e863beab0bad250efc0a35db6d302e87e24b7d8e6d7a5fc7b7659.png" src="../_images/f906ee9bed9e863beab0bad250efc0a35db6d302e87e24b7d8e6d7a5fc7b7659.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">)</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">)</span>
<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 2ms/step
4/4 [==============================] - 0s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">train_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">])),</span> <span class="n">test_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bd2a5c830ad8b302adb9282f441163422a75fdd7ffba7b34653eb29239e3ace2.png" src="../_images/bd2a5c830ad8b302adb9282f441163422a75fdd7ffba7b34653eb29239e3ace2.png" />
<img alt="../_images/58a782fe4558f1c118719db19302dd0e09ba994373b83085fd47f12e734c014e.png" src="../_images/58a782fe4558f1c118719db19302dd0e09ba994373b83085fd47f12e734c014e.png" />
</div>
</div>
</section>
<section id="gru-como-forma-alternativa-a-lstm">
<h3>GRU como forma alternativa à LSTM<a class="headerlink" href="#gru-como-forma-alternativa-a-lstm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">GRU</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">InputLayer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_features</span><span class="p">)))</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span> <span class="c1"># 32</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:Layer gru_4 will not use cuDNN kernels since it doesn&#39;t meet the criteria. It will use a generic GPU kernel as fallback when running on GPU.
WARNING:tensorflow:Layer gru_5 will not use cuDNN kernels since it doesn&#39;t meet the criteria. It will use a generic GPU kernel as fallback when running on GPU.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 gru_4 (GRU)                 (None, None, 24)          1944      
                                                                 
 gru_5 (GRU)                 (None, 32)                5568      
                                                                 
 dropout_2 (Dropout)         (None, 32)                0         
                                                                 
 dense_2 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 7545 (29.47 KB)
Trainable params: 7545 (29.47 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># compilacao e treinamento</span>
<span class="n">GRU</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="n">histGRU</span> <span class="o">=</span> <span class="n">GRU</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Época 0000 - learning rate 0.000100000
Época 0010 - learning rate 0.000094177
Época 0020 - learning rate 0.000085215
Época 0030 - learning rate 0.000077104
Época 0040 - learning rate 0.000069766
Época 0050 - learning rate 0.000063128
Época 0060 - learning rate 0.000057120
Época 0070 - learning rate 0.000051684
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">GRU</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histGRU</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento GRU&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0128
MAE: 0.0840
</pre></div>
</div>
<img alt="../_images/db926bc530021b967e14345291abea5c3f8e37297ac66b6d129fae73584f989f.png" src="../_images/db926bc530021b967e14345291abea5c3f8e37297ac66b6d129fae73584f989f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predG</span> <span class="o">=</span> <span class="n">GRU</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">)</span>
<span class="n">train_y_predG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predG</span> <span class="o">=</span> <span class="n">GRU</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">)</span>
<span class="n">test_y_predG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 3ms/step
4/4 [==============================] - 0s 3ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">train_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">test_y_predG</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">])),</span> <span class="n">test_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/71c93c2d7cf0a3e3aa2abcdf5ce4e7f4d2034bdb0ef520f6bb533f897077b0da.png" src="../_images/71c93c2d7cf0a3e3aa2abcdf5ce4e7f4d2034bdb0ef520f6bb533f897077b0da.png" />
<img alt="../_images/413c3b88805ad701acd5ee8393bd845bed52061a889c1e2f5938e0118046beab.png" src="../_images/413c3b88805ad701acd5ee8393bd845bed52061a889c1e2f5938e0118046beab.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histMLP</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histLSTM</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histGRU</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;mlp&#39;</span><span class="p">,</span> <span class="s1">&#39;lstm&#39;</span><span class="p">,</span> <span class="s1">&#39;gru&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f63e4373b50&gt;
</pre></div>
</div>
<img alt="../_images/00674e846e67e30cce32d72af9c4a48e0ac484d7ce15e59bd526a090a054bd81.png" src="../_images/00674e846e67e30cce32d72af9c4a48e0ac484d7ce15e59bd526a090a054bd81.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># avaliacao da predição ponto a ponto</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erro no teste com predição a cada ponto:&quot;</span><span class="p">)</span>
<span class="n">scoreMLP</span> <span class="o">=</span> <span class="n">MLP</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_dense</span><span class="p">,</span> <span class="n">test_y_dense</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MLP: </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoreMLP</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">scoreLSTM</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LSTM: </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoreLSTM</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">scoreGRU</span> <span class="o">=</span> <span class="n">GRU</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GRU: </span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoreGRU</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Erro no teste com predição a cada ponto:
MLP: 0.07012
LSTM: 0.05254
GRU: 0.04837
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_dense</span><span class="p">[</span><span class="n">time_steps</span><span class="p">:],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_pred</span><span class="p">[</span><span class="n">time_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mlp&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lstm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gru&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1b5170fdf58a5289ee5cf0cce7a83a9e41b5ca161e57851f10d72f84ddc473d5.png" src="../_images/1b5170fdf58a5289ee5cf0cce7a83a9e41b5ca161e57851f10d72f84ddc473d5.png" />
</div>
</div>
</section>
</section>
<section id="modulo-5-redes-neurais-para-dados-sequenciais">
<h2>Módulo 5 - Redes neurais para dados sequenciais<a class="headerlink" href="#modulo-5-redes-neurais-para-dados-sequenciais" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-mecanismo-de-atencao-span">
<h3><span style="color:darkred"><strong>Mecanismo de atenção</strong></span><a class="headerlink" href="#span-style-color-darkred-mecanismo-de-atencao-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">modelo_denso</span><span class="p">(</span><span class="n">input_shape</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,))</span>

    <span class="c1"># Atenção baseada em softmax</span>
    <span class="n">attention_probs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;attention_vec&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">attention_mul</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Multiply</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;attention_mul&#39;</span><span class="p">)([</span><span class="n">inputs</span><span class="p">,</span>
                                                           <span class="n">attention_probs</span><span class="p">])</span>
    <span class="c1"># Fim da camada de atencao</span>

    <span class="n">attention_mul</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">)(</span><span class="n">attention_mul</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">attention_mul</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">inputs</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dados_atencao</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">atencao</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">dim</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="n">dim</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atencao</span><span class="p">):</span>
      <span class="n">x</span><span class="p">[:,</span> <span class="n">at</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="n">dados_atencao</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">dados_atencao</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">141</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">train_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">train_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">142</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">train_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">train_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">143</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">train_x</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">train_y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">144</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">train_x</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">train_y</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;[0]&#39;)
</pre></div>
</div>
<img alt="../_images/d553d91f799c256ca3deb31ae68eef1616ef1fc1f737110202b85b934c893c04.png" src="../_images/d553d91f799c256ca3deb31ae68eef1616ef1fc1f737110202b85b934c893c04.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelD</span> <span class="o">=</span> <span class="n">modelo_denso</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">modelD</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
               <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">modelD</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="n">output_att</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">modelD</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                                <span class="n">outputs</span><span class="o">=</span><span class="n">modelD</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;attention_vec&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

<span class="n">output_mul</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">modelD</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                                <span class="n">outputs</span><span class="o">=</span><span class="n">modelD</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;attention_mul&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attention_vector</span> <span class="o">=</span> <span class="n">output_att</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vetor de &quot;atencao&quot; =&#39;</span><span class="p">,</span> <span class="n">attention_vector</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_vector</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 48ms/step
Vetor de &quot;atencao&quot; = [0.07313    0.12323563 0.11441259 0.09396052 0.07890335 0.11104407
 0.08578157 0.10759716 0.09634164 0.11559344]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;BarContainer object of 10 artists&gt;
</pre></div>
</div>
<img alt="../_images/b32583bd33dc78c0155e5192fa05e9c48ad44a80b566b0388234ffe7b5fdb267.png" src="../_images/b32583bd33dc78c0155e5192fa05e9c48ad44a80b566b0388234ffe7b5fdb267.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attention_mul</span> <span class="o">=</span> <span class="n">output_mul</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vetor de &quot;atencao&quot; * features =&#39;</span><span class="p">,</span> <span class="n">attention_mul</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_mul</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 53ms/step
Vetor de &quot;atencao&quot; * features = [-0.01122643  0.03469804  0.03551516  0.02143101 -0.00125266  0.01334104
  0.00439272  0.05334779  0.01269396 -0.0312859 ]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;BarContainer object of 10 artists&gt;
</pre></div>
</div>
<img alt="../_images/01c2b51ef75709628c2b911bf2ec327452bf57fc257e55d4301cce955a399dc1.png" src="../_images/01c2b51ef75709628c2b911bf2ec327452bf57fc257e55d4301cce955a399dc1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelD</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">score1</span> <span class="o">=</span> <span class="n">modelD</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span>  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia treinamento:&quot;</span><span class="p">,</span> <span class="n">score1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia treinamento: 100.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">attention_vector</span> <span class="o">=</span> <span class="n">output_att</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#print(&#39;Vetor de &quot;atencao&quot; =&#39;, attention_vector)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_vector</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vetor atencao classe: </span><span class="si">{</span><span class="n">test_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">attention_mul</span> <span class="o">=</span> <span class="n">output_mul</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#print(&#39;Vetor de &quot;atencao&quot; ponderado =&#39;, attention_mul)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_mul</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vetor atencao ponderado classe </span><span class="si">{</span><span class="n">test_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 37ms/step
1/1 [==============================] - 0s 39ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Vetor atencao ponderado classe [1]&#39;)
</pre></div>
</div>
<img alt="../_images/0572a70101909346b97f9e784485638cfd2cdaa0a740b043f04b0b16f4be9108.png" src="../_images/0572a70101909346b97f9e784485638cfd2cdaa0a740b043f04b0b16f4be9108.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">attention_vector</span> <span class="o">=</span> <span class="n">output_att</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#print(&#39;Vetor de &quot;atencao&quot; =&#39;, attention_vector)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_vector</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vetor atencao classe: </span><span class="si">{</span><span class="n">test_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">attention_mul</span> <span class="o">=</span> <span class="n">output_mul</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#print(&#39;Vetor de &quot;atencao&quot; ponderado =&#39;, attention_mul)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">attention_mul</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vetor atencao ponderado classe </span><span class="si">{</span><span class="n">test_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 39ms/step
1/1 [==============================] - 0s 37ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Vetor atencao ponderado classe [0]&#39;)
</pre></div>
</div>
<img alt="../_images/eeb14f60ff8b2b7bfcbc1b1b9f6d492f1714b7c126d4b60ddb208980e5e51d73.png" src="../_images/eeb14f60ff8b2b7bfcbc1b1b9f6d492f1714b7c126d4b60ddb208980e5e51d73.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score2</span> <span class="o">=</span> <span class="n">modelD</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span>  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia teste:&quot;</span><span class="p">,</span> <span class="n">score2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acurácia teste: 100.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="id67">
<h3>Redes Neurais e Aprendizado Profundo<a class="headerlink" href="#id67" title="Permalink to this heading">#</a></h3>
<section id="id68">
<h4><strong>MBA em Ciências de Dados</strong><a class="headerlink" href="#id68" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="id69">
<h3>Módulo 5 - Redes neurais para dados sequenciais </span><a class="headerlink" href="#id69" title="Permalink to this heading">#</a></h3>
<section id="span-style-color-darkred-camada-self-attention-combinada-com-lstm-span">
<h4><span style="color:darkred"><strong>Camada Self-Attention</strong> combinada com LSTM</span><a class="headerlink" href="#span-style-color-darkred-camada-self-attention-combinada-com-lstm-span" title="Permalink to this heading">#</a></h4>
<p>Moacir Antonelli Ponti</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Layer</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="c1"># outros</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Alcohol_Sales.csv&#39;</span><span class="p">)</span>
<span class="c1">#df = read_csv(&#39;data/Miles_Traveled.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/starbucks.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/passengers.csv&#39;)</span>
<span class="c1">#df = read_csv(&#39;data/price_of_ground_chuck.csv&#39;)</span>

<span class="c1"># pega segunda coluna do dataframe</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Série: &quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho da série: &quot;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Série:  S4248SM144NCEN
Tamanho da série:  325
</pre></div>
</div>
<img alt="../_images/82908a5d059d327dfdc74b55fce82d7ed956c96c585a6e7b7faa7b11420cffa3.png" src="../_images/82908a5d059d327dfdc74b55fce82d7ed956c96c585a6e7b7faa7b11420cffa3.png" />
</div>
</div>
</section>
</section>
</section>
<section id="id70">
<h2>Parte 1: Preparando os dados<a class="headerlink" href="#id70" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Separação em treinamento e teste</strong>: o treinamento sempre deve vir antes do teste no caso de dados sequenciais</p></li>
<li><p><strong>Normalização</strong>: aqui utilizaremos a normalização Min-Max para 0-1</p></li>
<li><p><strong>Inserção de ruído opcional</strong>: no treinamento e teste para avaliação da robustez dos modelos</p></li>
<li><p><strong>Formulação como aprendizado supervisionado</strong>: adequando os arrays de forma a permitir uso nas redes neurais</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calcula tamanhos dos dados de treinamento (n_train) e teste (n_test)</span>
<span class="n">porc_treinamento</span> <span class="o">=</span> <span class="mi">70</span>

<span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_treinamento</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">-</span><span class="n">n_train</span><span class="o">+</span><span class="mi">1</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">n_train</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

<span class="c1"># normalização min-max com base no treinamento</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">train_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
<span class="n">test_x_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Treinamento: &quot;</span><span class="p">,</span> <span class="n">n_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Teste: &quot;</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de Treinamento:  227
Exemplos de Teste:  99
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inserir_ruido_serie</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">inserir_ruido_teste</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">porc_ruido</span> <span class="o">=</span> <span class="mf">10.0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># insere ruido na serie</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_serie</span><span class="p">):</span>
    <span class="n">train_x_norm</span> <span class="o">=</span> <span class="n">train_x_norm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_train</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

<span class="c1"># insere ruido apenas no teste</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_teste</span><span class="p">):</span>
    <span class="n">test_x_norm</span> <span class="o">=</span> <span class="n">test_x_norm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_test</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">train_x_norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="p">),</span> <span class="n">test_x_norm</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Série preparada para os experimentos&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5a2c53177ea5343fbcc7d27b6a438c9b59fec67391cb5cfd0ae86d4b1537e409.png" src="../_images/5a2c53177ea5343fbcc7d27b6a438c9b59fec67391cb5cfd0ae86d4b1537e409.png" />
</div>
</div>
<section id="id71">
<h3>Formulação para aprendizado supervisionado: adequação dos arrays<a class="headerlink" href="#id71" title="Permalink to this heading">#</a></h3>
<p>Podemos cumprir essa etapa utilizando a observação do último passo <span class="math notranslate nohighlight">\(t-1\)</span> como entrada e a observação atual <span class="math notranslate nohighlight">\(t\)</span> como saída.</p>
<p>Podemos alcançar isso deslocando todos os valores da série por um número específico de posições. Aqui vamos deslocar 1 posição para trás, que se tornarão as variáveis de entrada, sendo que a série temporal original será considerada como a variável de saída.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># modifica a serie temporal tornando-a um problema de aprendizado supervisionado</span>
<span class="c1"># retornando array de entrada x e de saída y</span>
<span class="k">def</span> <span class="nf">timeseries_to_supervised_dense</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># o reshape com -1 preenche a dimensão conforme necessário, nesse caso teremos (num_valores, 1)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">[:</span><span class="o">-</span><span class="n">look_back</span><span class="p">]),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">look_back</span><span class="p">:]),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">look_back</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">train_x_dense</span><span class="p">,</span> <span class="n">train_y_dense</span> <span class="o">=</span> <span class="n">timeseries_to_supervised_dense</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="n">look_back</span><span class="p">)</span>

<span class="c1"># numero de features na série</span>
<span class="n">no_features</span> <span class="o">=</span> <span class="n">train_x_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de treinamento x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros 4 elementos de x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_dense</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho dos arrays de treinamento x e y
(226, 1)
(226, 1)

Primeiros 4 elementos de x e y
[[0.05478751]
 [0.0546595 ]
 [0.12429595]
 [0.19623656]]
[[0.0546595 ]
 [0.12429595]
 [0.19623656]
 [0.15232975]]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="parte-2-utilizando-lstms-para-predicao">
<h2>Parte 2 : Utilizando LSTMs para predição<a class="headerlink" href="#parte-2-utilizando-lstms-para-predicao" title="Permalink to this heading">#</a></h2>
<p>Agora utilizaremos uma rede neural baseada em camada recorrente, permitindo aprender a sequência.</p>
<p>Uma camada LSTM espera como entrada um tensor com as seguintes dimensões:</p>
<p>samples x time_steps x features</p>
<ul class="simple">
<li><p><em>Samples</em> são as observações independentes do domínio, tipicamente colunas de dados, consideradas no batch</p></li>
<li><p><em>Time steps</em> são os passos temporais separados de uma dada variável para uma dada observação - quantas observações serão dadas como entrada antes de que a primeira saída seja obtida</p></li>
<li><p><em>Features</em> são as medidas separadas observada em cada tempo da observação - quantos valores são considerados em cada entrada</p></li>
</ul>
<p>No caso dessa base de dados, podemos usar diferentes configurações. Para manter simples, consideramos que o problema em cada passo de tempo é uma amostra individual, com um time step e uma feature apenas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formato deve ser [samples, time steps, features]</span>
<span class="k">def</span> <span class="nf">recurrent_array</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">train_y_ts</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">time_steps</span><span class="p">:]</span>
    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">):</span>
        <span class="n">train_x_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">time_steps</span><span class="p">])</span>

    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x_ts</span><span class="p">)</span>

    <span class="c1">#rec_array = np.reshape(array, (array.shape[0], time_steps, array.shape[1]))</span>
    <span class="k">return</span> <span class="n">train_x_ts</span><span class="p">,</span> <span class="n">train_y_ts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_steps</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>

<span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">,</span><span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dados de treinamento para rede recorrente&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros 4 elementos de treinamento x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_rec</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dados de treinamento para rede recorrente
Tamanho dos arrays de teste x e y
(225, 2, 1)
(225, 1)

Primeiros 4 elementos de treinamento x e y
[[[0.05478751]
  [0.0546595 ]]

 [[0.0546595 ]
  [0.12429595]]

 [[0.12429595]
  [0.19623656]]

 [[0.19623656]
  [0.15232975]]]
[[0.12429595]
 [0.19623656]
 [0.15232975]
 [0.19175627]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_x_dense</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.05478751],
       [0.0546595 ],
       [0.12429595],
       [0.19623656],
       [0.15232975],
       [0.19175627]])
</pre></div>
</div>
</div>
</div>
<section id="id72">
<h3>Rede com unidades LSTM<a class="headerlink" href="#id72" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_LSTM</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">no_features</span><span class="p">))</span>

    <span class="n">lstm_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">lstm_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">lstm_x</span><span class="p">)</span>

    <span class="n">drop</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">do_rate</span><span class="p">)(</span><span class="n">lstm_x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="n">modelLSTM</span> <span class="o">=</span> <span class="n">create_LSTM</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, 2, 1)]            0         
                                                                 
 lstm (LSTM)                 (None, 2, 16)             1152      
                                                                 
 lstm_1 (LSTM)               (None, 16)                2112      
                                                                 
 dropout (Dropout)           (None, 16)                0         
                                                                 
 dense (Dense)               (None, 1)                 17        
                                                                 
=================================================================
Total params: 3281 (12.82 KB)
Trainable params: 3281 (12.82 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">35</span>

<span class="c1"># decaimento de learning rate</span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="c1">#if (epoch % 20 == 0): print(&quot;Época %04d - learning rate %.9f&quot; % (epoch, lr))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

<span class="n">modelLSTM</span> <span class="o">=</span> <span class="n">create_LSTM</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># compilacao e treinamento</span>
<span class="n">modelLSTM</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0002</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="n">histLSTM</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/35
225/225 [==============================] - 13s 11ms/step - loss: 0.2035 - mae: 0.3960 - lr: 2.0000e-04
Epoch 2/35
225/225 [==============================] - 2s 10ms/step - loss: 0.1400 - mae: 0.3084 - lr: 2.0000e-04
Epoch 3/35
225/225 [==============================] - 2s 10ms/step - loss: 0.0909 - mae: 0.2335 - lr: 2.0000e-04
Epoch 4/35
225/225 [==============================] - 3s 11ms/step - loss: 0.0605 - mae: 0.1966 - lr: 2.0000e-04
Epoch 5/35
225/225 [==============================] - 3s 12ms/step - loss: 0.0549 - mae: 0.1944 - lr: 1.9604e-04
Epoch 6/35
225/225 [==============================] - 3s 13ms/step - loss: 0.0523 - mae: 0.1883 - lr: 1.9216e-04
Epoch 7/35
225/225 [==============================] - 3s 12ms/step - loss: 0.0441 - mae: 0.1777 - lr: 1.8835e-04
Epoch 8/35
225/225 [==============================] - 2s 7ms/step - loss: 0.0485 - mae: 0.1824 - lr: 1.8462e-04
Epoch 9/35
225/225 [==============================] - 2s 10ms/step - loss: 0.0430 - mae: 0.1717 - lr: 1.8097e-04
Epoch 10/35
225/225 [==============================] - 2s 10ms/step - loss: 0.0361 - mae: 0.1576 - lr: 1.7738e-04
Epoch 11/35
225/225 [==============================] - 2s 9ms/step - loss: 0.0392 - mae: 0.1624 - lr: 1.7387e-04
Epoch 12/35
225/225 [==============================] - 2s 10ms/step - loss: 0.0349 - mae: 0.1542 - lr: 1.7043e-04
Epoch 13/35
225/225 [==============================] - 2s 8ms/step - loss: 0.0365 - mae: 0.1554 - lr: 1.6705e-04
Epoch 14/35
225/225 [==============================] - 2s 7ms/step - loss: 0.0314 - mae: 0.1372 - lr: 1.6375e-04
Epoch 15/35
225/225 [==============================] - 1s 6ms/step - loss: 0.0337 - mae: 0.1438 - lr: 1.6050e-04
Epoch 16/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0284 - mae: 0.1326 - lr: 1.5733e-04
Epoch 17/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0231 - mae: 0.1220 - lr: 1.5421e-04
Epoch 18/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0274 - mae: 0.1283 - lr: 1.5116e-04
Epoch 19/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0275 - mae: 0.1282 - lr: 1.4816e-04
Epoch 20/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0271 - mae: 0.1261 - lr: 1.4523e-04
Epoch 21/35
225/225 [==============================] - 1s 6ms/step - loss: 0.0259 - mae: 0.1246 - lr: 1.4235e-04
Epoch 22/35
225/225 [==============================] - 1s 6ms/step - loss: 0.0216 - mae: 0.1119 - lr: 1.3953e-04
Epoch 23/35
225/225 [==============================] - 1s 5ms/step - loss: 0.0242 - mae: 0.1182 - lr: 1.3677e-04
Epoch 24/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0207 - mae: 0.1109 - lr: 1.3406e-04
Epoch 25/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0234 - mae: 0.1169 - lr: 1.3141e-04
Epoch 26/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0250 - mae: 0.1196 - lr: 1.2881e-04
Epoch 27/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0227 - mae: 0.1174 - lr: 1.2626e-04
Epoch 28/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0234 - mae: 0.1220 - lr: 1.2376e-04
Epoch 29/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0235 - mae: 0.1128 - lr: 1.2130e-04
Epoch 30/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0199 - mae: 0.1078 - lr: 1.1890e-04
Epoch 31/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0212 - mae: 0.1085 - lr: 1.1655e-04
Epoch 32/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0213 - mae: 0.1118 - lr: 1.1424e-04
Epoch 33/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0210 - mae: 0.1098 - lr: 1.1198e-04
Epoch 34/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0209 - mae: 0.1074 - lr: 1.0976e-04
Epoch 35/35
225/225 [==============================] - 1s 6ms/step - loss: 0.0244 - mae: 0.1167 - lr: 1.0759e-04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histLSTM</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento LSTM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0146
MAE: 0.0930
</pre></div>
</div>
<img alt="../_images/39bb46591bff17fa8ec5c8a9aae35ad241115728ffaea9ba7f368f1fe3dda841.png" src="../_images/39bb46591bff17fa8ec5c8a9aae35ad241115728ffaea9ba7f368f1fe3dda841.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">)</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">)</span>
<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8/8 [==============================] - 0s 3ms/step
4/4 [==============================] - 0s 3ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">train_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">])),</span> <span class="n">test_y_rec</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15bcb1d8324bdd33b7b08a98c74ebca0b18109d6377fc7d2651d1ca96efcd343.png" src="../_images/15bcb1d8324bdd33b7b08a98c74ebca0b18109d6377fc7d2651d1ca96efcd343.png" />
<img alt="../_images/a25b86bdeb262ea37c84b69e1c8a9b946e8b7c1cf6d864ba8c1e72c1bd279079.png" src="../_images/a25b86bdeb262ea37c84b69e1c8a9b946e8b7c1cf6d864ba8c1e72c1bd279079.png" />
</div>
</div>
</section>
</section>
<section id="parte-3-camada-self-attention">
<h2>Parte 3: Camada Self-Attention<a class="headerlink" href="#parte-3-camada-self-attention" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SelfAttentionLayer</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SelfAttentionLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span> <span class="o">=</span> <span class="n">return_sequences</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="c1"># Create a trainable weight variable for this layer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_q&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_k&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_v&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">)</span>

        <span class="c1"># Calculate attention scores using dot product</span>
        <span class="n">attn_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Apply softmax activation to get attention weights</span>
        <span class="n">attn_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attn_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Weighted sum using the attention scores</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn_score</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">create_LSTM_with_attention</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">no_features</span><span class="p">))</span>

    <span class="n">lstm_x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">#lstm_x = layers.LSTM(hidden_units, return_sequences=True, activation=activation)(lstm_x)</span>
    <span class="n">attention</span> <span class="o">=</span> <span class="n">SelfAttentionLayer</span><span class="p">()(</span><span class="n">lstm_x</span><span class="p">)</span>

    <span class="n">attention_drop</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">do_rate</span><span class="p">)(</span><span class="n">attention</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)(</span><span class="n">attention_drop</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="n">modelAtt</span> <span class="o">=</span> <span class="n">create_LSTM_with_attention</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">modelAtt</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_4&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_5 (InputLayer)        [(None, 2, 1)]            0         
                                                                 
 lstm_6 (LSTM)               (None, 2, 16)             1152      
                                                                 
 self_attention_layer_2 (Se  (None, 16)                768       
 lfAttentionLayer)                                               
                                                                 
 dropout_4 (Dropout)         (None, 16)                0         
                                                                 
 dense_4 (Dense)             (None, 1)                 17        
                                                                 
=================================================================
Total params: 1937 (7.57 KB)
Trainable params: 1937 (7.57 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelAtt</span> <span class="o">=</span> <span class="n">create_LSTM_with_attention</span><span class="p">(</span><span class="n">no_features</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># compilacao e treinamento</span>
<span class="n">modelAtt</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0002</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="n">histAtt</span> <span class="o">=</span> <span class="n">modelAtt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/35
225/225 [==============================] - 2s 3ms/step - loss: 0.0914 - mae: 0.2671 - lr: 2.0000e-04
Epoch 2/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0248 - mae: 0.1243 - lr: 2.0000e-04
Epoch 3/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0243 - mae: 0.1255 - lr: 2.0000e-04
Epoch 4/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0268 - mae: 0.1291 - lr: 2.0000e-04
Epoch 5/35
225/225 [==============================] - 1s 5ms/step - loss: 0.0236 - mae: 0.1222 - lr: 1.9604e-04
Epoch 6/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0239 - mae: 0.1214 - lr: 1.9216e-04
Epoch 7/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0242 - mae: 0.1207 - lr: 1.8835e-04
Epoch 8/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0218 - mae: 0.1176 - lr: 1.8462e-04
Epoch 9/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0221 - mae: 0.1165 - lr: 1.8097e-04
Epoch 10/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0198 - mae: 0.1073 - lr: 1.7738e-04
Epoch 11/35
225/225 [==============================] - 1s 5ms/step - loss: 0.0220 - mae: 0.1142 - lr: 1.7387e-04
Epoch 12/35
225/225 [==============================] - 1s 5ms/step - loss: 0.0204 - mae: 0.1063 - lr: 1.7043e-04
Epoch 13/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0231 - mae: 0.1147 - lr: 1.6705e-04
Epoch 14/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0192 - mae: 0.1036 - lr: 1.6375e-04
Epoch 15/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0215 - mae: 0.1110 - lr: 1.6050e-04
Epoch 16/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0190 - mae: 0.1050 - lr: 1.5733e-04
Epoch 17/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0204 - mae: 0.1070 - lr: 1.5421e-04
Epoch 18/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0197 - mae: 0.1048 - lr: 1.5116e-04
Epoch 19/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0209 - mae: 0.1112 - lr: 1.4816e-04
Epoch 20/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0144 - mae: 0.0934 - lr: 1.4523e-04
Epoch 21/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0211 - mae: 0.1096 - lr: 1.4235e-04
Epoch 22/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0175 - mae: 0.1017 - lr: 1.3953e-04
Epoch 23/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0186 - mae: 0.1009 - lr: 1.3677e-04
Epoch 24/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0190 - mae: 0.1095 - lr: 1.3406e-04
Epoch 25/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0196 - mae: 0.1060 - lr: 1.3141e-04
Epoch 26/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0189 - mae: 0.1048 - lr: 1.2881e-04
Epoch 27/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0181 - mae: 0.1005 - lr: 1.2626e-04
Epoch 28/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0187 - mae: 0.1047 - lr: 1.2376e-04
Epoch 29/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0203 - mae: 0.1070 - lr: 1.2130e-04
Epoch 30/35
225/225 [==============================] - 1s 4ms/step - loss: 0.0191 - mae: 0.1053 - lr: 1.1890e-04
Epoch 31/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0178 - mae: 0.1012 - lr: 1.1655e-04
Epoch 32/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0192 - mae: 0.1031 - lr: 1.1424e-04
Epoch 33/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0193 - mae: 0.1027 - lr: 1.1198e-04
Epoch 34/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0162 - mae: 0.0958 - lr: 1.0976e-04
Epoch 35/35
225/225 [==============================] - 1s 3ms/step - loss: 0.0176 - mae: 0.1017 - lr: 1.0759e-04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">modelAtt</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histAtt</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento Attention&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0141
MAE: 0.0899
</pre></div>
</div>
<img alt="../_images/4d08c0cbb989a21fe8124169b917725d116005dd0662f4b2a08985fc6a2ca69b.png" src="../_images/4d08c0cbb989a21fe8124169b917725d116005dd0662f4b2a08985fc6a2ca69b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predG</span> <span class="o">=</span> <span class="n">modelAtt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">train_y_predG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predG</span> <span class="o">=</span> <span class="n">modelAtt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">test_y_predG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>225/225 [==============================] - 1s 2ms/step
97/97 [==============================] - 0s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span> <span class="n">train_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_y_dense</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">test_y_predG</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">])),</span> <span class="n">test_y_rec</span><span class="p">[:</span><span class="o">-</span><span class="n">time_steps</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/77e335da9b4006e90d08d1453596404c9146c3ad3310839d33a38559e2427528.png" src="../_images/77e335da9b4006e90d08d1453596404c9146c3ad3310839d33a38559e2427528.png" />
<img alt="../_images/139c076353339dd1958eadaf02fa8e94047a7f2a244460df4972006118e2467b.png" src="../_images/139c076353339dd1958eadaf02fa8e94047a7f2a244460df4972006118e2467b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># avaliacao da predição ponto a ponto</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erro no teste com predição a cada ponto:&quot;</span><span class="p">)</span>
<span class="n">scoreLSTM</span> <span class="o">=</span> <span class="n">modelLSTM</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LSTM    : MSE=</span><span class="si">{</span><span class="n">scoreLSTM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, MAE=</span><span class="si">{</span><span class="n">scoreLSTM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">scoreAtt</span> <span class="o">=</span> <span class="n">modelAtt</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LSTM+Att: MSE=</span><span class="si">{</span><span class="n">scoreAtt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, MAE=</span><span class="si">{</span><span class="n">scoreAtt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Erro no teste com predição a cada ponto:
LSTM    : MSE=0.0626, MAE=0.2195)
LSTM+Att: MSE=0.0494, MAE=0.1871)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="c1"># plt.plot(test_y_predL, &#39;--&#39;, alpha=0.8, label=&#39;lstm&#39;)</span>
<span class="c1"># plt.plot(test_y_predG, &#39;--&#39;, alpha=0.8, label=&#39;att&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predG</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span><span class="n">test_y_predG</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;att&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span><span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lstm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training + Testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3fc2a53bcc605acc9ef1905e4a28fdd74b7f3bf1cb00dd01b8981610add7e83c.png" src="../_images/3fc2a53bcc605acc9ef1905e4a28fdd74b7f3bf1cb00dd01b8981610add7e83c.png" />
</div>
</div>
</section>
<section id="id73">
<h2>Módulo 5 - Redes neurais para dados sequenciais</span><a class="headerlink" href="#id73" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-series-multivariadas-e-statefulness-span">
<h3><span style="color:darkred"><strong>Séries Multivariadas e Statefulness</strong></span><a class="headerlink" href="#span-style-color-darkred-series-multivariadas-e-statefulness-span" title="Permalink to this heading">#</a></h3>
<p>Utilizaremos a base de dados 3W (Petrobrás) que possui séries multivariadas medidas em poços de petróleo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">read_csv</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Layer</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="c1"># outros</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;WELL-00001_20140124213136.csv&quot;</span><span class="p">)</span>
<span class="n">df1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho da série: &quot;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho da série:  12440
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id74">
<h2>Parte 1: Preparando os dados<a class="headerlink" href="#id74" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Separação em treinamento e teste</strong>: o treinamento sempre deve vir antes do teste no caso de dados sequenciais</p></li>
<li><p><strong>Normalização</strong>: aqui utilizaremos a normalização Min-Max para 0-1</p></li>
<li><p><strong>Inserção de ruído opcional</strong>: no treinamento e teste para avaliação da robustez dos modelos</p></li>
<li><p><strong>Formulação como aprendizado supervisionado</strong>: adequando os arrays de forma a permitir uso nas redes neurais</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variaveis que definem divisao em treinamento e teste e controlam adição de ruído</span>
<span class="n">porc_treinamento</span> <span class="o">=</span> <span class="mi">46</span>
<span class="n">inserir_ruido_serie</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">inserir_ruido_teste</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">porc_ruido</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calcula tamanhos dos dados de treinamento (n_train) e teste (n_test)</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_treinamento</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">-</span><span class="n">n_train</span><span class="o">+</span><span class="mi">1</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">n_train</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">train_x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">test_x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">train_x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">train_x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">train_x_norm</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
    <span class="n">test_x_norm</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Treinamento: &quot;</span><span class="p">,</span> <span class="n">n_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de Teste: &quot;</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de Treinamento:  5722
Exemplos de Teste:  6719
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># insere ruido na serie</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_serie</span><span class="p">):</span>
    <span class="n">train_x_norm</span> <span class="o">=</span> <span class="n">train_x_norm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_train</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

<span class="c1"># insere ruido apenas no teste</span>
<span class="k">if</span> <span class="p">(</span><span class="n">inserir_ruido_teste</span><span class="p">):</span>
    <span class="n">test_x_norm</span> <span class="o">=</span> <span class="n">test_x_norm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_test</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">porc_ruido</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="parte-2-problema-regressao-com-entrada-multivariada">
<h2>Parte 2: problema regressão com entrada multivariada<a class="headerlink" href="#parte-2-problema-regressao-com-entrada-multivariada" title="Permalink to this heading">#</a></h2>
<p>Vamos usar as séries 1, 2 e 3 para prever a série 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_y_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_y_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">train_x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_x_norm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">train_x_norm</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="p">),</span> <span class="n">test_x_norm</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">train_y_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_test</span><span class="p">),</span> <span class="n">test_y_norm</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Série preparada para os experimentos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7c6f161c7490&gt;
</pre></div>
</div>
<img alt="../_images/db343b5ec1d02929590560e7d12714451eb905346a66741315dc2fc67ac11430.png" src="../_images/db343b5ec1d02929590560e7d12714451eb905346a66741315dc2fc67ac11430.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_x_norm</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 8.61920000e-01,  0.00000000e+00,  1.00000000e+00],
       [ 8.62560000e-01, -6.88846986e-05,  1.00022317e+00],
       [ 8.63040000e-01, -1.37769397e-04,  1.00045055e+00],
       [ 8.63520000e-01, -2.05824160e-04,  1.00067793e+00]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_y_norm</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.00443615, 0.00452387, 0.00459906, 0.00468678])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formato deve ser [samples, time steps, features]</span>
<span class="k">def</span> <span class="nf">recurrent_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">array_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">array_out</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">train_y_ts</span> <span class="o">=</span> <span class="n">array_out</span><span class="p">[</span><span class="n">time_steps</span><span class="p">:]</span>
    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_in</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">):</span>
        <span class="n">train_x_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_in</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">time_steps</span><span class="p">])</span>

    <span class="n">train_x_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_x_ts</span><span class="p">)</span>

    <span class="c1">#rec_array = np.reshape(array, (array.shape[0], time_steps, array.shape[1]))</span>
    <span class="k">return</span> <span class="n">train_x_ts</span><span class="p">,</span> <span class="n">train_y_ts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_steps</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">train_x_norm</span><span class="p">,</span> <span class="n">train_y_norm</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>
<span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span> <span class="o">=</span> <span class="n">recurrent_array</span><span class="p">(</span><span class="n">test_x_norm</span><span class="p">,</span> <span class="n">test_y_norm</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="n">time_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dados de treinamento para rede recorrente&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tamanho dos arrays de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_y_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Primeiros 5 elementos de teste x e y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_y_rec</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

<span class="n">no_features</span> <span class="o">=</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Número de features:&#39;</span><span class="p">,</span> <span class="n">no_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dados de treinamento para rede recorrente
Tamanho dos arrays de teste x e y
(5720, 2, 3)
(5720, 1)

Primeiros 5 elementos de teste x e y
[[[ 8.61920000e-01  0.00000000e+00  1.00000000e+00]
  [ 8.62560000e-01 -6.88846986e-05  1.00022317e+00]]

 [[ 8.62560000e-01 -6.88846986e-05  1.00022317e+00]
  [ 8.63040000e-01 -1.37769397e-04  1.00045055e+00]]

 [[ 8.63040000e-01 -1.37769397e-04  1.00045055e+00]
  [ 8.63520000e-01 -2.05824160e-04  1.00067793e+00]]

 [[ 8.63520000e-01 -2.05824160e-04  1.00067793e+00]
  [ 8.64000000e-01 -2.74708858e-04  1.00090531e+00]]

 [[ 8.64000000e-01 -2.74708858e-04  1.00090531e+00]
  [ 8.64640000e-01 -3.43593557e-04  1.00112848e+00]]]
[[0.00459906]
 [0.00468678]
 [0.00476196]
 [0.00484968]
 [0.00492487]]

Número de features: 3
</pre></div>
</div>
</div>
</div>
</section>
<section id="statefullness">
<h2>Statefullness<a class="headerlink" href="#statefullness" title="Permalink to this heading">#</a></h2>
<p>Ao considerar uma unidade recorrente como “<em>stateful</em>” estamos indicando que cada seleção de batch é a continuação da anterior.</p>
<p>Isso só é possível se usarmos batches sequenciais e sem embaralhamento (shuffle) por isso a recomendação anterior de usar batchsize 1 para predição do próximo instante de tempo.</p>
<p>O <em>stateful</em> também permite que a LSTM mantenha a memória mesmo quando usamos time_step=1, desde que os batches sejam sequenciais, de forma que cada posição do batch na iteração <span class="math notranslate nohighlight">\(j\)</span> é uma continuação da mesma posição do batch <span class="math notranslate nohighlight">\(j-1\)</span></p>
<p>Além disso:</p>
<ul class="simple">
<li><p>é preciso especificar na própria arquitetura o batch size</p></li>
<li><p>o <strong>batch_size tem que ser divisível</strong> pelo total de exemplos de treinamento para não haver sobras no final da época</p></li>
<li><p><strong>LayerNormalization</strong> passa a ser necessário para evitar problemas com a magnitude do gradiente. Ao retirá-lo obtemos <code class="docutils literal notranslate"><span class="pre">nan</span></code> como valor de custo após algumas épocas</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># decaimento de learning rate</span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2"> - learning rate </span><span class="si">%.8f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lr</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># checando batch size</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5720
572.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_LSTM_stateful</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">stateful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">batch_input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="n">lstm_1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">stateful</span><span class="o">=</span><span class="n">stateful</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">lstm_1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span>
                         <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">stateful</span><span class="o">=</span><span class="n">stateful</span><span class="p">)(</span><span class="n">lstm_1</span><span class="p">)</span>
    <span class="n">feats</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">lstm_1</span><span class="p">)</span>

    <span class="n">drop</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">do_rate</span><span class="p">)(</span><span class="n">feats</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelStat</span> <span class="o">=</span> <span class="n">model_LSTM_stateful</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">modelStat</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_4&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_5 (InputLayer)        [(10, 2, 3)]              0         
                                                                 
 lstm_8 (LSTM)               (10, 2, 16)               1280      
                                                                 
 lstm_9 (LSTM)               (10, 16)                  2112      
                                                                 
 layer_normalization_4 (Lay  (10, 16)                  32        
 erNormalization)                                                
                                                                 
 dropout_4 (Dropout)         (10, 16)                  0         
                                                                 
 dense_4 (Dense)             (10, 1)                   17        
                                                                 
=================================================================
Total params: 3441 (13.44 KB)
Trainable params: 3441 (13.44 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>Nesse tipo de modelo, é mais indicado resetar os estados das unidades LSTM a cada época.</p>
<ul class="simple">
<li><p>caso queiramos fazer decrescer o learning rate, então também é preciso re-compilar o modelo com o valor a cada época</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">no_features</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">modelStat</span> <span class="o">=</span> <span class="n">model_LSTM_stateful</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="c1"># compilacao e treinamento</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">hist_all</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">scheduler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
    <span class="n">modelStat</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">modelStat</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">modelStat</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>

    <span class="n">hist_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>00 - learning rate 0.00010000
572/572 [==============================] - 7s 7ms/step - loss: 0.1684 - mae: 0.3114
01 - learning rate 0.00010000
572/572 [==============================] - 7s 6ms/step - loss: 0.0894 - mae: 0.2053
02 - learning rate 0.00010000
572/572 [==============================] - 8s 6ms/step - loss: 0.0317 - mae: 0.1221
03 - learning rate 0.00009802
572/572 [==============================] - 7s 6ms/step - loss: 0.0174 - mae: 0.0888
04 - learning rate 0.00009608
572/572 [==============================] - 7s 5ms/step - loss: 0.0123 - mae: 0.0748
05 - learning rate 0.00009418
572/572 [==============================] - 10s 10ms/step - loss: 0.0103 - mae: 0.0684
06 - learning rate 0.00009232
572/572 [==============================] - 13s 9ms/step - loss: 0.0093 - mae: 0.0652
07 - learning rate 0.00009049
572/572 [==============================] - 7s 7ms/step - loss: 0.0088 - mae: 0.0633
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">modelStat</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0121
MAE: 0.0861
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ERRO - batchsize foi fixado no modelo e ao tentar usar o padrao, falhará</span>
<span class="c1">#scoresT = modelStat.evaluate(test_x_rec, test_y_rec, verbose=0)</span>
<span class="c1">#print(&#39;Scores test&#39;)</span>
<span class="c1">#print(&#39;MSE: %.4f&#39; % (scoresT[0]))</span>
<span class="c1">#print(&#39;MAE: %.4f&#39; % (scoresT[1]))</span>
</pre></div>
</div>
</div>
</div>
<p>Como o modelo foi criado com batch_size fixo e relacionado ao conjunto de treinamento, depois não conseguimos usá-lo para outras inferências e testes</p>
<p>Assim é preciso criar um novo modelo com batch_size=1 e setar os pesos do modelo treinado</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">inference_model</span> <span class="o">=</span> <span class="n">model_LSTM_stateful</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">new_batch_size</span><span class="p">,</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                      <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">inference_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="c1"># copia pesos do modelo anterior</span>
<span class="n">pesos_modelo</span> <span class="o">=</span> <span class="n">modelStat</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<span class="n">inference_model</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">pesos_modelo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoresT</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">new_batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores test&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores test
MSE: 0.0040
MAE: 0.0571
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_all</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento modelStat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c38482a977e5726b6b28281ae7cce134bdd4157e036df706952dbb6febcb77e6.png" src="../_images/c38482a977e5726b6b28281ae7cce134bdd4157e036df706952dbb6febcb77e6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predS</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">new_batch_size</span><span class="p">)</span>
<span class="n">train_y_predS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predS</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predS</span> <span class="o">=</span> <span class="n">inference_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">new_batch_size</span><span class="p">)</span>
<span class="n">test_y_predS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predS</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5720/5720 [==============================] - 17s 3ms/step
6717/6717 [==============================] - 20s 3ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predS</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span>
         <span class="n">test_y_predS</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_norm</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Testing data for the target series&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/817cd0de92c9dd7918065e699f61e0e1f320846c55137989053672ae812b86f9.png" src="../_images/817cd0de92c9dd7918065e699f61e0e1f320846c55137989053672ae812b86f9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">modelL</span> <span class="o">=</span> <span class="n">model_LSTM_stateful</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_x_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                <span class="n">stateful</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">do_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">no_features</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># compilacao e treinamento</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="n">modelL</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
<span class="n">hist_all2</span> <span class="o">=</span> <span class="n">modelL</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>00 - learning rate 0.00010000
Epoch 1/8
572/572 [==============================] - 7s 6ms/step - loss: 0.2249 - mae: 0.3146 - lr: 1.0000e-04
01 - learning rate 0.00010000
Epoch 2/8
572/572 [==============================] - 3s 6ms/step - loss: 0.0379 - mae: 0.1309 - lr: 1.0000e-04
02 - learning rate 0.00009802
Epoch 3/8
572/572 [==============================] - 3s 6ms/step - loss: 0.0225 - mae: 0.1045 - lr: 9.8020e-05
03 - learning rate 0.00009608
Epoch 4/8
572/572 [==============================] - 4s 6ms/step - loss: 0.0162 - mae: 0.0896 - lr: 9.6080e-05
04 - learning rate 0.00009418
Epoch 5/8
572/572 [==============================] - 3s 6ms/step - loss: 0.0135 - mae: 0.0821 - lr: 9.4180e-05
05 - learning rate 0.00009232
Epoch 6/8
572/572 [==============================] - 3s 6ms/step - loss: 0.0109 - mae: 0.0743 - lr: 9.2320e-05
06 - learning rate 0.00009049
Epoch 7/8
572/572 [==============================] - 4s 6ms/step - loss: 0.0102 - mae: 0.0712 - lr: 9.0490e-05
07 - learning rate 0.00008870
Epoch 8/8
572/572 [==============================] - 3s 6ms/step - loss: 0.0088 - mae: 0.0661 - lr: 8.8700e-05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores2</span> <span class="o">=</span> <span class="n">modelL</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">train_y_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scoresT2</span> <span class="o">=</span> <span class="n">modelL</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">test_y_rec</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores treinamento&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scores test&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoresT2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scoresT2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scores treinamento
MSE: 0.0054
MAE: 0.0601
Scores test
MSE: 0.0072
MAE: 0.0764
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_all</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;stateful&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_all2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;non-stateful&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergencia de treinamento&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ab002f1fa96b918b1346f90c3297e8df164046cc58ece9d8cab8508df9f860d8.png" src="../_images/ab002f1fa96b918b1346f90c3297e8df164046cc58ece9d8cab8508df9f860d8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># realiza predicoes com os dados de treinamento e teste</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">modelL</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_x_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">train_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>

<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">modelL</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x_rec</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">test_y_predL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">time_steps</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
672/672 [==============================] - 2s 3ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predL</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span>
         <span class="n">test_y_predL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;non-statef MAE=</span><span class="si">{</span><span class="n">scoresT2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">test_y_predS</span><span class="p">)</span><span class="o">+</span><span class="n">time_steps</span><span class="p">),</span>
         <span class="n">test_y_predS</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;statef MAE=</span><span class="si">{</span><span class="n">scoresT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_y_norm</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;testing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Testing data for the target series&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6776808b365ab93a072d040845d5af2fbf54dd8aeb9ae593707e05d289c9c9d1.png" src="../_images/6776808b365ab93a072d040845d5af2fbf54dd8aeb9ae593707e05d289c9c9d1.png" />
</div>
</div>
</section>
<section id="span-style-color-darkred-modulo-6-redes-neurais-para-texto-span">
<h2><span style="color:darkred">Módulo 6 - Redes neurais para texto</span><a class="headerlink" href="#span-style-color-darkred-modulo-6-redes-neurais-para-texto-span" title="Permalink to this heading">#</a></h2>
<section id="id75">
<h3><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id75" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id76">
<h3>Questão 1)<a class="headerlink" href="#id76" title="Permalink to this heading">#</a></h3>
<p>A abordagem word2vec gera um vetor numérico para cada palavra, permitindo processar texto com redes neurais. Essa abordagem resulta em representações vetoriais como por exemplo Glove e FastText, cujo espaço de característica apresenta qual característica principal?</p>
<p>(a) Palavras que ocorrem com maior frequência no texto onde foram aprendidas possuem maior valor na representação final<br>
(b) Palavras estão organizadas no espaço de forma associada à classe do documento em que foram obtidas no conjunto de treinamento, ou seja, formam grupos com outras palavras de acordo com o rótulo do texto de origem.<br>
(c) Palavras que aparecem em uma determinada ordem no texto em que forem treinadas, considerando uma janela de palavras, estarão na mesma ordem em cada direção vetorial do espaço de características do word2vec.<br>
(d) Palavras que são classificadas corretamente com relação à análise morfológica (ex. substantivos, verbos, adjetivos, etc.), aparecem próximas no espaço de caracerísticas<br>
<font color='red'>(e) Palavras que aparecem próximas uma das outras nas sentenças dos textos em que foram treinados, estarão também próximas no espaço de características do word2vec<br></font></p>
<p><strong>Justificativa</strong>: A abordagem tem como principal característica capturar o contexto linguístico de forma não supervisionada, ou seja palavras que aparecem próximas nas sentenças também serão próximas. A alternativa (a) é incorreta pois define o método TF-IDF, a alternativa (b) é incorreta pois abordagens word-embedding baseadas em skipgrams não utilizam rotulação, e a alternativa (c) é incorreta pois o objetivo do word2vec não é aprender a mesma ordenação nas direções vetoriais e sim aproximar (independente da ordem) palavras que aparecem em contextos similares, (d) pelo mesmo motivo que a alternativa (b) não há dependência de rótulo ou tarefa de classificação.</p>
</section>
<hr class="docutils" />
<section id="id77">
<h3>Questão 2)<a class="headerlink" href="#id77" title="Permalink to this heading">#</a></h3>
<p>O que o mecanismo de atenção aprende com base em uma entrada no caso de dados de texto?</p>
<p>(a) Define quais palavras, individualmente, ao longo de uma sequência serão processadas, e quais serão ignoradas, para produzir cada saída da camada de atenção, similar a uma camada de “dropout” aplicada numa entrada composta por palavras.<br>
(b) Uma representação vetorial única para cada palavra de um determinado vocabulário<br>
<font color='red'>(c) Uma representação vetorial que captura o contexto entre as palavras de forma que é possível saber quais palavras estão mais relacionadas à outras.<br></font>
(d) Uma memória que é aprendida ao longo das iterações (dados sequenciais) de forma que um histórico de todas as iterações anteriores é usada em cada iteração para computar as saídas.<br>
(e) Uma combinação linear da palavra atual de uma sentença com as palavras anteriores utilizando uma codificação posicional (positional encoding).<br></p>
<p><strong>Justificativa:</strong> O mecanismo de atenção, no caso de um texto, captura relações entre as palavras de forma a entender o contexto mesmo quando as palavras não estejam imediatamente próximas. As alternativas incorretas são (a) o mecanismo não define palavras a ser ignoradas como em um dropout, (b) não há relação com a taxa de amostragem dos tokens, (d) a memória aprendida está relacionada com camadas recorrentes, (e) a combinação linear com positional encoding faz parte da arquitetura Transformer mas não é parte do mecanismo de atenção em si.</p>
</section>
<hr class="docutils" />
<section id="id78">
<h3>Questão 3)<a class="headerlink" href="#id78" title="Permalink to this heading">#</a></h3>
<p>Qual o papel do Positional Encoding em arquiteturas do tipo Transformer?<br></p>
<p><font color='red'>(a) Modificar os valores de entrada de forma que a rede neural tenha uma informação sobre sua posição relativa, visto que as camadas de atenção não possuem recorrência<br></font>
(b) Determinar a posição correta das palavras em uma sentença embaralhada, visto que nas arquiteturas Transformer é comum aleatorizar a ordem dos tokens de entrada<br>
(c) Gerar o word embedding individual de cada palavra ou token de entrada, que irá ser transformado pela camada de atenção para gerar um embedding contextual<br>
(d) Processar os dados de entrada de forma a gerar uma combinação linear dos mesmos e passar à camada de atenção<br>
(e) Determinar qual cabeça de atenção irá processar cada palavra ou token de entrada, de forma que seja possível paralelizar o processamento de toda a sentença<br></p>
<p><strong>Justificativa</strong>:</p>
</section>
<hr class="docutils" />
<section id="id79">
<h3>Questão 4)<a class="headerlink" href="#id79" title="Permalink to this heading">#</a></h3>
<p>Qual alternativa melhor descreve e compara os métodos GPT (Generative Pretrained Transformer) e BERT (Bidirectional Encoder Representations from Transformers)?<br></p>
<p><font color='red'>(a) O BERT permite o pré-treinamento de encoders transformer para posterior uso em aplicações gerais, enquanto o GPT permite o pré-treinamento de decoders transformer para posterior uso em tarefas de predição do próximo token de texto de forma autoregressiva<br></font>
(b) O BERT permite o pré-treinamento de encoders transformer para posterior uso unicamente em tarefas de classificação, enquanto o GPT permite o pré-treinamento de encoders transformer para posterior uso unicamente na extração autoregressiva de embeddings de palavras<br>
(c) O BERT permite o pré-treinamento de encoders transformer para posterior uso unicamente em tarefas de classificação, enquanto o GPT permite o pré-treinamento de decoders transformer para posterior uso unicamente em aplicações de perguntas e respostas<br>
(d) O BERT permite o pré-treinamento de encoders transformer para posterior uso para tarefas de tradução entre idiomas, enquanto o GPT permite o pré-treinamento de decoders transformer para posterior uso unicamente em tarefas de classificação<br>
(e) O BERT permite o pré-treinamento de decoders transformer autoregressivos para posterior uso em aplicações gerais, enquanto o GPT permite o pré-treinamento de encoders transformer bidirecionais para posterior em tarefas de predição de próximo token de texto.<br></p>
<p><strong>Justificativa</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">,</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id80">
<h3>Questão 5)<a class="headerlink" href="#id80" title="Permalink to this heading">#</a></h3>
<p>Carregue o word embedding <code class="docutils literal notranslate"><span class="pre">skip_s50</span></code> (do tipo Fasttext Skipgram) em Português do NILC, conforme visto em aula, e obtenha os word embeddings das palavras:
‘ventilador’, ‘ar-condicionado’, ‘geladeira’, ‘liquidificador’, ‘batedeira’, ‘celular’, ‘computador’, ‘lavadora’, ‘panela’</p>
<p>Produza uma projeção em 2 dimensões utilizando o algoritmo TSNE com os parâmetros:  n_components=2 learning_rate=”auto”, perplexity=4,init=”random” random_state=1, e visualize os embeddings das palavras em um scatterplot. A seguir, utilize a distância do Cosseno para computar as palavras mais próximas da palavra ‘ventilador’ (excluindo a própria palavra) utilizando (1) o espaço word embedding original de 50 dimensões e (2) o espaço reduzido pelo TNSE com 2 dimensões. Quais são essas palavras, em ordem (iniciando pela menor distância)?</p>
<p>OBS: lembrar que a distância do cosseno observa o ângulo entre os vetores</p>
<p>(a) Espaço 50-d: geladeira, ar-condicionado; Espaço 2-d: ar-condicionado, geladeira <br>
(b) Espaço 50-d: ar-condicionado, geladeira; Espaço 2-d: ar-condicionado, geladeira<br>
(c) Espaço 50-d: ar-condicionado, liquidificador; Espaço 2-d: geladeira, liquidificador <br>
(d) Espaço 50-d: geladeira, liquidificador; Espaço 2-d: liquidificador, computador<br>
<font color='red'>(e) Espaço 50-d: ar-condicionado, geladeira; Espaço 2-d: ar-condicionado, computador<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># descomente a linha abaixo para baixar o arquivo na primeira vez (demora um pouco)</span>
<span class="o">!</span>wget<span class="w"> </span>http://143.107.183.175:22980/download.php?file<span class="o">=</span>embeddings/fasttext/skip_s50.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2023-11-01 08:36:47--  http://143.107.183.175:22980/download.php?file=embeddings/fasttext/skip_s50.zip
Connecting to 143.107.183.175:22980... connected.
HTTP request sent, awaiting response... 200 OK
Length: 162531753 (155M) [application/octet-stream]
Saving to: ‘download.php?file=embeddings%2Ffasttext%2Fskip_s50.zip’

download.php?file=e 100%[===================&gt;] 155.00M  7.60MB/s    in 23s     

2023-11-01 08:37:10 (6.81 MB/s) - ‘download.php?file=embeddings%2Ffasttext%2Fskip_s50.zip’ saved [162531753/162531753]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># descomente abaixo para a primeira execucao (renomear arquivo + realizar unzip)</span>
<span class="o">!</span>mv<span class="w"> </span>download.php?file<span class="o">=</span>embeddings%2Ffasttext%2Fskip_s50.zip<span class="w"> </span>skip_s50.zip
<span class="o">!</span>unzip<span class="w"> </span>-q<span class="w"> </span>skip_s50.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_to_glove_file</span> <span class="o">=</span> <span class="s2">&quot;./skip_s50.txt&quot;</span>

<span class="n">embeddings_index</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_glove_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">embeddings_index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encontrados </span><span class="si">%s</span><span class="s2"> word vectors.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-4-ab062c2068ae&gt;:7: DeprecationWarning: string or file could not be read to its end due to unmatched data; this will raise a ValueError in the future.
  coefs = np.fromstring(coefs, &quot;f&quot;, sep=&quot; &quot;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Encontrados 929594 word vectors.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palavras</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ventilador&#39;</span><span class="p">,</span> <span class="s1">&#39;ar-condicionado&#39;</span><span class="p">,</span>
            <span class="s1">&#39;geladeira&#39;</span><span class="p">,</span> <span class="s1">&#39;liquidificador&#39;</span><span class="p">,</span> <span class="s1">&#39;batedeira&#39;</span><span class="p">,</span>
            <span class="s1">&#39;celular&#39;</span><span class="p">,</span> <span class="s1">&#39;computador&#39;</span><span class="p">,</span> <span class="s1">&#39;lavadora&#39;</span><span class="p">,</span> <span class="s1">&#39;panela&#39;</span><span class="p">]</span>

<span class="n">embedd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">palavras</span><span class="p">:</span>
    <span class="n">embedd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

<span class="n">embedd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embedd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_distances</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_sne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
    <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">perplexity</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">init</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">tnse_words</span> <span class="o">=</span> <span class="n">t_sne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">embedd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tnse_words</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tnse_words</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">palavras</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">tnse_words</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tnse_words</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span> <span class="mi">140</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-140.0, 140.0)
</pre></div>
</div>
<img alt="../_images/66b7ae5af3139952695fd5c825d211d94309b0a6b779dd281ba1d38097067c73.png" src="../_images/66b7ae5af3139952695fd5c825d211d94309b0a6b779dd281ba1d38097067c73.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dmat</span> <span class="o">=</span> <span class="n">cosine_distances</span><span class="p">(</span><span class="n">embedd</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

<span class="n">dmatemb</span> <span class="o">=</span> <span class="n">cosine_distances</span><span class="p">(</span><span class="n">tnse_words</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">dmatemb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

<span class="n">palavras_base</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_vizinhos</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">palavras_base</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">palavras</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">fasttext 50d : &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vizinhos</span><span class="p">):</span>
        <span class="n">prox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dmat</span><span class="p">[</span><span class="n">p</span><span class="p">,:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> (d=</span><span class="si">%.3f</span><span class="s1">)</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">palavras</span><span class="p">[</span><span class="n">prox</span><span class="p">],</span><span class="n">dmat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">prox</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">dmat</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">prox</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">tnse 2d      : &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vizinhos</span><span class="p">):</span>
        <span class="n">prox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dmatemb</span><span class="p">[</span><span class="n">p</span><span class="p">,:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> (d=</span><span class="si">%.3f</span><span class="s1">)</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">palavras</span><span class="p">[</span><span class="n">prox</span><span class="p">],</span><span class="n">dmatemb</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">prox</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">dmatemb</span><span class="p">[</span><span class="n">p</span><span class="p">,</span><span class="n">prox</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- ventilador
	fasttext 50d : 1. ar-condicionado (d=0.149)	2. geladeira (d=0.224)	
	tnse 2d      : 1. ar-condicionado (d=0.035)	2. computador (d=0.171)	
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id81">
<h2><span style="color:darkred">Módulo 6 - Redes neurais para texto</span><a class="headerlink" href="#id81" title="Permalink to this heading">#</a></h2>
<section id="id82">
<h3><span style="color:darkred">Exercícios (com soluções)</span><a class="headerlink" href="#id82" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id83">
<h3>Exercício 1)<a class="headerlink" href="#id83" title="Permalink to this heading">#</a></h3>
<p>Com relação ao processamento de dados sequenciais, ou seja, em que a ordem das observações importa e dá sentido aos dados, considere as seguintes premissas realizadas por diferentes camadas de redes neurais.</p>
<p>I - com base na similaridade cruzada entre elementos sequenciais da entrada, aprendendo uma ponderação para cada elemento que leva à uma representação contextual dos mesmos na saída de cada posição<br>
II - assume que os dados de entrada não estão ordenados e aprende a partir de qualquer permutação dos dados sequenciais<br>
III - utiliza uma memória para armazenar valores das ativações de todos os dados anteriores (ao longo das iterações) e com isso considerar a sequência dos dados na saída de cada posição<br>
IV - realiza uma combinação ponderada das features de cada entrada, produzindo valores de  saída para cada elemento individualmente ao longo das iterações<br></p>
<p>Associe as premissas acima às camadas do tipo densa (D), recorrente (R), baseada em atenção (A).</p>
<p>(a) I - A; II - R; III - D; IV - D<br>
<font color='red'>(b) I - A; II - D; III - R; IV - D<br></font>
(a) I - A; II - A; III - R; IV - D<br>
(d) I - R; II - D; III - A; IV - D<br></p>
<p><strong>Justificativa</strong>: D: camadas densas combinam (uma ponderação entre as features) as observações de entrada sem considerar sua ordem, aprendendo a partir de qualquer permutação observações de cada instância, estando relacionadas às premissas II e IV. R: unidades recorrentes são capazes de manter uma memória relativa a sequência (ou ordenação) dos dados, de forma que os pesos/parâmetros serão computados de forma a serem influenciados por dados observados anteriormente, relacionada à premissa III. A: utiliza o produto interno entre uma sequencia de elementos da entrada, e aprende um score de atenção que permite gerar uma representação contextualizada de cada elemento da sequencia com relação à todos os outros, relacionado à premissa I.</p>
</section>
<hr class="docutils" />
<section id="id84">
<h3>Exercício 2)<a class="headerlink" href="#id84" title="Permalink to this heading">#</a></h3>
<p>O que assumimos ao usar um word-embedding pré-treinado (Skipgrams ou CBOWs como FastText, Glove) para uma nova tarefa de classificação como entrada para uma rede neural de classificação, em contraste com o uso de modelo pré-treinado do tipo BERT, para a mesma nova tarefa (diferente da usada no pré-treinamento)?</p>
<p>(a) Word-embedding possui representações fixas (e individuais) por palavra as quais permanecerão fixas durante o treinamento da rede neural, enquanto que o BERT produz representações contextuais das palavras, as quais também permanecerão fixas durante o treinamento.<br>
(b) Word-embedding possui representações fixas (e individuais) por palavra as quais permanecerão fixas durante o treinamento da rede neural, enquanto que o BERT produz representações contextuais das palavras, as quais podem ser opcionamente ajustadas durante o treinamento.<br>
<font color='red'>(c) Word-embedding possui representações fixas (e individuais) por palavra as quais podem ser opcionamente ajustadas durante o treinamento da rede neural, enquanto que o BERT produz representações contextuais das palavras, as quais podem ser opcionamente ajustadas durante o treinamento.<br></font>
(d) Word-embedding possui representações contextuais  das palavras, as quais podem ser opcionamente ajustadas durante o treinamento da rede neural, enquanto que o BERT produz representações fixas (e individuais) por palavra, as quais podem ser opcionamente ajustadas durante o treinamento.<br></p>
<p><strong>Justificativa</strong>: Word-embeddings aprendem representações fixas e individuais por palavras, em contraste com o BERT cujas representações das palavras de entrada mudam a depender do contexto. Além disso, ao usar esses modelos pré-treinados, em ambos casos podemos opcionalmente permitir a adaptação da matriz de embeddings (no caso do Word Embedding), e das camadas de atenção (no caso do BERT) durante o treinamento de um classificador.</p>
</section>
<hr class="docutils" />
<section id="id85">
<h3>Exercício 3)<a class="headerlink" href="#id85" title="Permalink to this heading">#</a></h3>
<p>Como se comparam os modelos BERT e GPT, considerando os modos autoregressivo vs bidirecional, sendo o texto é dividido em tokens (que podem ser por exemplo palavras ou trechos de palavras)?</p>
<p>(a) Ambos permitem que o modelo analise todo o texto de entrada durante o processo de treinamento, porém durante inferência, enquanto o BERT segue utilizando todo o texto de entrada para produzir uma saída, o GPT utiliza cada saída atual como entrada para predizer o próximo token<br>
(b) Ambos permitem que o modelo analise todo o texto de entrada durante o processo de treinamento, porém durante inferência, enquanto o GPT segue utilizando todo o texto de entrada para produzir uma saída, o BERT utiliza cada saída atual como entrada para predizer o próximo token<br>
<font color='red'>(c) O BERT é treinado bidirecional utilizando todo o texto de entrada para produzir uma saída, e o GPT é autoregressivo, permite usar apenas os tokens anteriores para predizer o próximo. Ambos funcionam assim tanto em treinamento quanto em inferência.<br></font>
(d) O BERT é treinado bidirecional utilizando todo o texto de entrada para produzir uma saída, e em inferência é autoregressivo, e o GPT é autoregressivo, utilizando cada saída atual como entrada para predizer o próximo token tanto em treinamento quanto em inferência.<br></p>
<p><strong>Justificativa</strong>: O BERT usa o encoder do Transformer, o qual é bi-direcional e aplica o mecanismo de atenção sobre todos os tokens de entrada para permitir produzir a saída, para tarefas como classificação e perguntas/respostas. O GPT usa o decoder do Transformer, o qual é auto-regressivo e permite ver apenas os tokens anteriores para predizer o próximo.</p>
</section>
<hr class="docutils" />
<section id="id86">
<h3>Exercício 4)<a class="headerlink" href="#id86" title="Permalink to this heading">#</a></h3>
<p>Carregue o arquivo <code class="docutils literal notranslate"><span class="pre">livro1.txt</span></code> conforme indicado abaixo, bem como o word embedding Glove com 50 dimensões em português utilizado em aula. Obtenha uma vetorização de texto com número máximo de tokens 5000 e tamanho da sentença com no máximo 30 tokens. A seguir obtenha a matriz de embeddings a partir das palavras desse arquivo e imprima palavras não convertidas. Qual a natureza da maior parte das palavras em que houveram falhas?</p>
<p><font color='red'>(a) Palavras com hífens, números e em outro idioma<br></font>
(b) Nomes próprios e caracteres especiais isolados<br>
(c) Palavras com caracteres não codificados corretamente no UTF-16<br>
(d) Palavras em outro idioma e caracteres isolados<br></p>
<p><strong>Justificativa</strong>: Veja abaixo. As palavras que usam hífens como em “queixava-se” deveriam ter sido pré-processadas e usando o vectorizer não foram reconhecidas. Também números e palavras em outros idiomas foram encontradas e não existem no vocabulário utilizado.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># colab ou execucao uma unica vez local</span>
<span class="o">!</span>wget<span class="w"> </span>http://143.107.183.175:22980/download.php?file<span class="o">=</span>embeddings/glove/glove_s50.zip
<span class="o">!</span>mv<span class="w"> </span>download.php?file<span class="o">=</span>embeddings%2Fglove%2Fglove_s50.zip<span class="w"> </span>glove_s50.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2023-11-01 08:52:14--  http://143.107.183.175:22980/download.php?file=embeddings/glove/glove_s50.zip
Connecting to 143.107.183.175:22980... connected.
HTTP request sent, awaiting response... 200 OK
Length: 181356545 (173M) [application/octet-stream]
Saving to: ‘download.php?file=embeddings%2Fglove%2Fglove_s50.zip’

download.php?file=e 100%[===================&gt;] 172.96M  11.2MB/s    in 16s     

2023-11-01 08:52:31 (10.6 MB/s) - ‘download.php?file=embeddings%2Fglove%2Fglove_s50.zip’ saved [181356545/181356545]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>unzip<span class="w"> </span>-q<span class="w"> </span>glove_s50.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># codigo colab</span>
<span class="n">path_to_glove_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;/content/glove_s50.txt&quot;</span> <span class="c1"># colab</span>
<span class="p">)</span>

<span class="c1"># codigo local</span>
<span class="c1">#path_to_glove_file = &quot;./glove_s50.txt&quot;</span>

<span class="n">embeddings_index</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_glove_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">embeddings_index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encontrados </span><span class="si">%s</span><span class="s2"> word vectors.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-4-b412cc99fba8&gt;:13: DeprecationWarning: string or file could not be read to its end due to unmatched data; this will raise a ValueError in the future.
  coefs = np.fromstring(coefs, &quot;f&quot;, sep=&quot; &quot;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Encontrados 929594 word vectors.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;livro1.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;[</span><span class="se">\n\r</span><span class="s1">]+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-907a7384-fe7e-4a5e-af04-d71c9c3a4a06" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Os curiosos acontecimentos que são o objeto de...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Segundo a opinião geral, estavam deslocados, j...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>À primeira vista, Oran é, na verdade, uma cida...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A própria cidade, vamos admiti-lo, é feia</td>
    </tr>
    <tr>
      <th>4</th>
      <td>com seu aspecto tranquilo, é preciso algum tem...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>538</th>
      <td>Queimava, na verdade, mas nem mais nem menos d...</td>
    </tr>
    <tr>
      <th>539</th>
      <td>Toda a cidade estava com febre</td>
    </tr>
    <tr>
      <th>540</th>
      <td>Era essa pelo menos a impressão que perseguia ...</td>
    </tr>
    <tr>
      <th>541</th>
      <td>Mas essa impressão parecia-lhe insensata</td>
    </tr>
    <tr>
      <th>542</th>
      <td>Atribuía-a ao enervamento e às preocupações qu...</td>
    </tr>
  </tbody>
</table>
<p>543 rows × 1 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-907a7384-fe7e-4a5e-af04-d71c9c3a4a06')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-907a7384-fe7e-4a5e-af04-d71c9c3a4a06 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-907a7384-fe7e-4a5e-af04-d71c9c3a4a06');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-a521856e-fcf0-47f2-8839-08ecc20d25ea">
  <button class="colab-df-quickchart" onclick="quickchart('df-a521856e-fcf0-47f2-8839-08ecc20d25ea')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-a521856e-fcf0-47f2-8839-08ecc20d25ea button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">texto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[&#39;Os curiosos acontecimentos que são o objeto desta crônica ocorreram em 194x, em Oran&#39;]
 [&#39;Segundo a opinião geral, estavam deslocados, já que saíam um pouco do comum&#39;]
 [&#39;À primeira vista, Oran é, na verdade, uma cidade comum e não passa de uma prefeitura francesa na costa argelina&#39;]
 [&#39;A própria cidade, vamos admiti-lo, é feia&#39;]
 [&#39;com seu aspecto tranquilo, é preciso algum tempo para se perceber o que a torna diferente de tantas outras cidades comerciais em todas as latitudes&#39;]]
(543, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental.preprocessing</span> <span class="kn">import</span> <span class="n">TextVectorization</span>

<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TextVectorization</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">output_sequence_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">text_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">vectorizer</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">text_ds</span><span class="p">)</span>

<span class="n">voc</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
<span class="n">word_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">voc</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Número de tokens: &quot;</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">convertidas</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">falhas</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">word_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">embedding_vector</span> <span class="o">=</span> <span class="n">embeddings_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embedding_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">embedding_vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">embedding_dim</span><span class="p">):</span>
            <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_vector</span>
            <span class="n">convertidas</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Palavras convertidas: </span><span class="si">%d</span><span class="s2"> / não convertidas: </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">convertidas</span><span class="p">,</span> <span class="n">falhas</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de tokens:  2194
(2194, 50)

[UNK]
à
É
tarrou
às
À
paneloux
cottard
vigiálo
tinhamno
respondilhe
ransdoc
queixavase
ocupouse
acompanhouo
18
voltavalhe
veiolhe
veemse
têlos
tratarao
tinhamlhe
sentilo
sentiamse
sentase
saintjust
ríchard
reúnemse
purgava
proíboo
preparavase
perdiase
percebese
pareceralhe
parecelhe
ouviamse
olhavaos
ocupamse
obrigavao
leválas
lançarse
jogouse
isolálo
interrogálo
interessamse
instalavaa
instalamse
inquietarse
inclinavase
gracejadores
fungosidades
frontdemer
fixarase
fechála
faziao
explicarlhe
exigiamse
esperouos
escarrara
encontrálos
encontrála
encontravamnos
empoleirarse
dãolhe
distraise
dirseia
detevese
desconhecese
desateio
demorouse
deitese
darmes
curvavamse
cuidese
contemplouo
consolálo
compreendiase
carroleito
boulomanes
bemeducados
bemeducada
aviseme
atribuíaa
atirálos
atirouse
assuou
apressavamse
apoiavase
apertoulhe
amicales
alastravamse
agravouse
agitouse
afligiase
afastase
adormecese
admitilo
acusavamse
acalmese
abraçoua
abateramse
30
28
25
194x
17
16
1
Palavras convertidas: 2083 / não convertidas: 109)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id87">
<h3>Exercício 5)<a class="headerlink" href="#id87" title="Permalink to this heading">#</a></h3>
<p>A matriz de embedding  (<code class="docutils literal notranslate"><span class="pre">embedding_matrix</span></code>) contém a mesma representação para uma dada palavra do que o índice de embedding  (<code class="docutils literal notranslate"><span class="pre">embedding_index</span></code>), mas a quantidade de elementos da matriz é limitada ao vocabulário da base de dados que estamos trabalhando. Imprima a quantidade de elementos em ambos para conferir a diferença.</p>
<p>Utilize a configuração obtida no exercício anterior (base de texto e word embedding carregados), e obtenha os índices das palavras: <code class="docutils literal notranslate"><span class="pre">rato</span></code>, <code class="docutils literal notranslate"><span class="pre">médico</span></code>, <code class="docutils literal notranslate"><span class="pre">cidade</span></code> e <code class="docutils literal notranslate"><span class="pre">febre</span></code> calculados pelo vetorizador.</p>
<p>A seguir, obtenha a soma da diferença absoluta (ou distância L1) entre as representações da palavra <code class="docutils literal notranslate"><span class="pre">rato</span></code> e aqueles obtidos por meio dos índices encontrados das palavras <code class="docutils literal notranslate"><span class="pre">médico</span></code>, <code class="docutils literal notranslate"><span class="pre">ouro</span></code>, <code class="docutils literal notranslate"><span class="pre">cidade</span></code> e <code class="docutils literal notranslate"><span class="pre">febre</span></code> na matriz de embedding (<code class="docutils literal notranslate"><span class="pre">embedding_matrix</span></code>), ou seja, dentre as palavras convertidas.</p>
<p>Qual palavra, das citadas acima dentro do vocabulário, é mais próxima de <code class="docutils literal notranslate"><span class="pre">rato</span></code> segundo o word embedding utilizado?</p>
<p><font color='red'>(a) Febre<br></font>
(b) Ouro<br>
(c) Médico<br>
(d) Médico e Febre empatados<br></p>
<p><strong>Justificativa</strong>: Veja abaixo, a palavra “ouro” não está no vocabulário, sendo atribuído o índice 1. Assim, a palavra mais próxima dentro do vocabulário é “Febre”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho do índice: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho da matriz: &quot;</span><span class="p">,</span> <span class="n">embedding_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho do índice:  929594
Tamanho da matriz:  2194
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">([[</span><span class="s2">&quot;rato médico ouro cidade febre&quot;</span><span class="p">]])</span>
<span class="n">output</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(1, 30), dtype=int64, numpy=
array([[ 82,  33,   1,  27, 110,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0]])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Médico: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span><span class="o">-</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">82</span><span class="p">])))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cidade: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">-</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">82</span><span class="p">])))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ouro: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">82</span><span class="p">])))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Febre: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">110</span><span class="p">]</span><span class="o">-</span><span class="n">embedding_matrix</span><span class="p">[</span><span class="mi">82</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Médico:  33.421877262182534
Cidade:  39.917805386241525
Ouro:  22.207107034511864
Febre:  31.358608989976346
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id88">
<h3>Exercício 6)<a class="headerlink" href="#id88" title="Permalink to this heading">#</a></h3>
<p>Word2Vec com aprendizado de uma rede recorrente para classificação de sentenças.</p>
<p>Iremos treinar uma rede neural capaz de diferenciar frases de dois livros diferentes, contidos nos arquivos <code class="docutils literal notranslate"><span class="pre">livro1.txt</span></code> e <code class="docutils literal notranslate"><span class="pre">livro2.txt</span></code>.</p>
<p>Com base no processo realizado nos exercícios anteriores, carregue os arquivos citados. Gere o vetorizador com máximo de tokens 5000 e sequência com máximo de 60 elementos/tokens e realize a conversão com os textos de ambos os livros em conjunto.</p>
<p>Depois crie o conjunto de treinamento e teste da seguinte forma:</p>
<ul class="simple">
<li><p>o conjunto de treinamento terá as 75% primeiras frases do livro1 seguida das 75% primeiras frases do livro2</p></li>
<li><p>o conjunto de teste terá as 25% frases restantes do livro1 seguida das 25% frases restantes do livro 2</p></li>
<li><p>monte vetores com os rótulos de treinamento e teste de forma que livro 1 seja a classe 0 e livro 2 seja a classe 1.</p></li>
</ul>
<p>Projete uma rede Recorrente com as seguintes camadas (todas com ativação ReLU exceto especificado outra)</p>
<ul class="simple">
<li><p>Embedding layer</p></li>
<li><p>GRU com 64 unidades e ativação relu</p></li>
<li><p>Dropout com taxa 25%</p></li>
<li><p>Densa com 1 unidade e ativação sigmoide</p></li>
</ul>
<p>Configure as sementes com seed(1) e set_seed(2), depois compile com a função entropia cruzada binária, otimizador adam (com seus parâmetros padrão) e compute a acurácia. Treine por 20 épocas com batch size 16.</p>
<p>Após o treinamento, o valor da acurácia no conjunto de teste (use o método <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>) estão em qual intervalo?</p>
<p>(a) [95, 100]<br>
<font color='red'>(c) [85, 91]<br></font>
(b) [72, 79]<br>
(d) [60, 67]<br></p>
<p><strong>Justificativa</strong>: Veja abaixo o código</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;livro1.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;[</span><span class="se">\n\r</span><span class="s1">]+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="n">df1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-b9580b53-39dc-4a3c-958d-b3a0ac8e5ccd" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Os curiosos acontecimentos que são o objeto de...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Segundo a opinião geral, estavam deslocados, j...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>À primeira vista, Oran é, na verdade, uma cida...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A própria cidade, vamos admiti-lo, é feia</td>
    </tr>
    <tr>
      <th>4</th>
      <td>com seu aspecto tranquilo, é preciso algum tem...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>538</th>
      <td>Queimava, na verdade, mas nem mais nem menos d...</td>
    </tr>
    <tr>
      <th>539</th>
      <td>Toda a cidade estava com febre</td>
    </tr>
    <tr>
      <th>540</th>
      <td>Era essa pelo menos a impressão que perseguia ...</td>
    </tr>
    <tr>
      <th>541</th>
      <td>Mas essa impressão parecia-lhe insensata</td>
    </tr>
    <tr>
      <th>542</th>
      <td>Atribuía-a ao enervamento e às preocupações qu...</td>
    </tr>
  </tbody>
</table>
<p>543 rows × 1 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-b9580b53-39dc-4a3c-958d-b3a0ac8e5ccd')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-b9580b53-39dc-4a3c-958d-b3a0ac8e5ccd button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-b9580b53-39dc-4a3c-958d-b3a0ac8e5ccd');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e0412a5a-e80b-40c0-8c06-44c959a05432">
  <button class="colab-df-quickchart" onclick="quickchart('df-e0412a5a-e80b-40c0-8c06-44c959a05432')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e0412a5a-e80b-40c0-8c06-44c959a05432 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;livro2.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;[</span><span class="se">\n\r</span><span class="s1">]+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-8837fb2a-4934-4d40-a1e4-70338e3428d4" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>No princípio era o Verbo e o Verbo estava junt...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ele estava no princípio junto a Deus e dever d...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mas videmus nunc per speculum et in aenigmate ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Chegando ao fim desta minha vida de pecador, e...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Conceda-me o Senhor a graça de ser testemunha ...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>96</th>
      <td>Pela mole, e pela forma, o Edifício me pareceu...</td>
    </tr>
    <tr>
      <th>97</th>
      <td>E é sorte que, sendo uma límpida manhã de inve...</td>
    </tr>
    <tr>
      <th>98</th>
      <td>Não direi de modo algum que ela sugerisse sent...</td>
    </tr>
    <tr>
      <th>99</th>
      <td>Trouxe-me espanto, e uma inquietação sutil</td>
    </tr>
    <tr>
      <th>100</th>
      <td>Deus sabe que não eram fantasmas de minha alma...</td>
    </tr>
  </tbody>
</table>
<p>101 rows × 1 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-8837fb2a-4934-4d40-a1e4-70338e3428d4')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-8837fb2a-4934-4d40-a1e4-70338e3428d4 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-8837fb2a-4934-4d40-a1e4-70338e3428d4');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-352a755d-b05e-4c4b-be66-3458afe88a33">
  <button class="colab-df-quickchart" onclick="quickchart('df-352a755d-b05e-4c4b-be66-3458afe88a33')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-352a755d-b05e-4c4b-be66-3458afe88a33 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">texto1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto1</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">texto2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto2</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texto2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[&#39;Os curiosos acontecimentos que são o objeto desta crônica ocorreram em 194x, em Oran&#39;]
 [&#39;Segundo a opinião geral, estavam deslocados, já que saíam um pouco do comum&#39;]
 [&#39;À primeira vista, Oran é, na verdade, uma cidade comum e não passa de uma prefeitura francesa na costa argelina&#39;]
 [&#39;A própria cidade, vamos admiti-lo, é feia&#39;]
 [&#39;com seu aspecto tranquilo, é preciso algum tempo para se perceber o que a torna diferente de tantas outras cidades comerciais em todas as latitudes&#39;]]
(543, 1)
[[&#39;No princípio era o Verbo e o Verbo estava junto a Deus, e o Verbo era Deus&#39;]
 [&#39;Ele estava no princípio junto a Deus e dever do monge fiel seria repetir cada dia com salmodiante humildade o único evento imodificável do qual se pode confirmar a incontrovertível verdade&#39;]
 [&#39;Mas videmus nunc per speculum et in aenigmate e a verdade, em vez de cara a cara, manifesta-se deixando às vezes rastros (ai, quão ilegíveis) no erro do mundo, tanto que precisamos calculá-lo, soletrando os verdadeiros sinais, mesmo lá onde nos parecem obscuros e quase entremeados por uma vontade totalmente voltada para o mal&#39;]
 [&#39;Chegando ao fim desta minha vida de pecador, enquanto, encanecido, envelheço como o mundo, à espera de perder-me no abismo sem fundo da divindade silenciosa e deserta, participando da luz inconversível das inteligências angélicas, já entrevado com meu corpo pesado e doente nesta cela do caro mosteiro de Melk, apresto-me a deixar sobre este pergaminho o testemunho dos eventos miríficos e formidáveis a que na juventude me foi dado assistir, repetindo verbatim quanto vi e ouvi, sem me aventurar a tirar disso um desenho, como a deixar aos que virão (se o Anticristo não os preceder) signos de signos, para que sobre eles se exercite a prece da decifração&#39;]
 [&#39;Conceda-me o Senhor a graça de ser testemunha transparente dos acontecimentos que tiveram lugar na abadia da qual é bem e piedoso se cale também afinal o nome, ao findar do ano do Senhor de 1327 em que o imperador Ludovico entrou na Itália para reconstituir a dignidade do sagrado império romano, segundo os desígnios do Altíssimo e a confusão do infame usurpador simoníaco e heresiarca que em Avignon lançou vergonha ao santo nome do apóstolo (falo da alma pecadora de Jacques de Cahors, que os ímpios honraram como João XXII)&#39;]]
(101, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">texto_integrado</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">texto1</span><span class="p">,</span> <span class="n">texto2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental.preprocessing</span> <span class="kn">import</span> <span class="n">TextVectorization</span>

<span class="n">vectorizer2</span> <span class="o">=</span> <span class="n">TextVectorization</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">output_sequence_length</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">text_ds2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">texto_integrado</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">vectorizer2</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">text_ds2</span><span class="p">)</span>

<span class="n">voc2</span> <span class="o">=</span> <span class="n">vectorizer2</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
<span class="n">word_index2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">voc2</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voc2</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">voc2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Número de tokens: &quot;</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">convertidas</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">falhas</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">embedding_matrix2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">embedding_matrix2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">word_index2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">embedding_vector2</span> <span class="o">=</span> <span class="n">embeddings_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embedding_vector2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">embedding_vector2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">embedding_dim</span><span class="p">):</span>
            <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_matrix2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_vector2</span>
            <span class="n">convertidas</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Palavras convertidas: </span><span class="si">%d</span><span class="s2"> / não convertidas: </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">convertidas</span><span class="p">,</span> <span class="n">falhas</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de tokens:  3200
(3200, 50)
Palavras convertidas: 3025 / não convertidas: 173)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Embedding</span>

<span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span>
    <span class="n">num_tokens</span><span class="p">,</span>
    <span class="n">embedding_dim</span><span class="p">,</span>
    <span class="n">embeddings_initializer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">embedding_matrix2</span><span class="p">),</span>
    <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># texto 1</span>
<span class="n">num_validation1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_split</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="p">))</span>
<span class="n">num_train1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="p">))</span>

<span class="n">x_train1</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation1</span><span class="p">]</span>
<span class="n">y_train1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_train1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x_val1</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation1</span><span class="p">:]</span>
<span class="n">y_val1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_validation1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Texto 1:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train (x,y): </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_train1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_train1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;val (x,y): </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_val1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_val1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="c1"># texto 2</span>
<span class="n">num_validation2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_split</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto2</span><span class="p">))</span>
<span class="n">num_train2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto2</span><span class="p">))</span>
<span class="n">x_train2</span> <span class="o">=</span> <span class="n">texto2</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation2</span><span class="p">]</span>
<span class="n">y_train2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_train2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x_val2</span> <span class="o">=</span> <span class="n">texto2</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation2</span><span class="p">:]</span>
<span class="n">y_val2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_validation2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Texto 2:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train (x,y): </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_train2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_train2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;val (x,y): </span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_val2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_val2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Texto 1:
train (x,y): 408,408
val (x,y): 135,135
Texto 2:
train (x,y): 76,76
val (x,y): 25,25
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># juntando textos</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x_train1</span><span class="p">,</span> <span class="n">x_train2</span><span class="p">))</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x_val1</span><span class="p">,</span> <span class="n">x_val2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y_train1</span><span class="p">,</span> <span class="n">y_train2</span><span class="p">))</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y_val1</span><span class="p">,</span> <span class="n">y_val2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(484, 1)
(160, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># vetorizacao dos dados</span>
<span class="n">x_train_net</span> <span class="o">=</span> <span class="n">vectorizer2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_train</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">x_val_net</span> <span class="o">=</span> <span class="n">vectorizer2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_val</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x_train_net</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_val_net</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(484, 60)
(160, 60)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GRU_texto</span><span class="p">():</span>
    <span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">predsGRUout</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">modelGRU</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predsGRUout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modelGRU</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modelGRU</span> <span class="o">=</span> <span class="n">GRU_texto</span><span class="p">()</span>
<span class="n">modelGRU</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">modelGRU</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelGRU</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_net</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
             <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:Layer gru will not use cuDNN kernels since it doesn&#39;t meet the criteria. It will use a generic GPU kernel as fallback when running on GPU.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, None)]            0         
                                                                 
 embedding (Embedding)       (None, None, 50)          160000    
                                                                 
 gru (GRU)                   (None, 32)                8064      
                                                                 
 dense (Dense)               (None, 32)                1056      
                                                                 
 dropout (Dropout)           (None, 32)                0         
                                                                 
 dense_1 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 169153 (660.75 KB)
Trainable params: 9153 (35.75 KB)
Non-trainable params: 160000 (625.00 KB)
_________________________________________________________________
Epoch 1/15
31/31 [==============================] - 11s 121ms/step - loss: 0.6635 - acc: 0.8657 - val_loss: 0.6348 - val_acc: 0.8438
Epoch 2/15
31/31 [==============================] - 5s 151ms/step - loss: 0.5769 - acc: 0.8698 - val_loss: 0.5200 - val_acc: 0.8438
Epoch 3/15
31/31 [==============================] - 3s 109ms/step - loss: 0.4257 - acc: 0.8698 - val_loss: 0.4358 - val_acc: 0.8438
Epoch 4/15
31/31 [==============================] - 3s 110ms/step - loss: 0.3810 - acc: 0.8760 - val_loss: 0.4163 - val_acc: 0.8375
Epoch 5/15
31/31 [==============================] - 5s 155ms/step - loss: 0.3747 - acc: 0.8698 - val_loss: 0.4133 - val_acc: 0.8375
Epoch 6/15
31/31 [==============================] - 3s 110ms/step - loss: 0.3395 - acc: 0.8740 - val_loss: 0.4007 - val_acc: 0.8500
Epoch 7/15
31/31 [==============================] - 3s 109ms/step - loss: 0.3290 - acc: 0.8698 - val_loss: 0.3790 - val_acc: 0.8375
Epoch 8/15
31/31 [==============================] - 5s 152ms/step - loss: 0.3170 - acc: 0.8760 - val_loss: 0.3785 - val_acc: 0.8438
Epoch 9/15
31/31 [==============================] - 3s 112ms/step - loss: 0.2746 - acc: 0.8843 - val_loss: 0.4265 - val_acc: 0.8562
Epoch 10/15
31/31 [==============================] - 6s 189ms/step - loss: 0.2637 - acc: 0.9070 - val_loss: 0.3809 - val_acc: 0.8438
Epoch 11/15
31/31 [==============================] - 7s 226ms/step - loss: 0.2497 - acc: 0.8988 - val_loss: 0.3612 - val_acc: 0.8562
Epoch 12/15
31/31 [==============================] - 3s 112ms/step - loss: 0.2559 - acc: 0.9091 - val_loss: 0.3213 - val_acc: 0.8687
Epoch 13/15
31/31 [==============================] - 5s 153ms/step - loss: 0.2396 - acc: 0.9029 - val_loss: 0.3167 - val_acc: 0.8562
Epoch 14/15
31/31 [==============================] - 3s 109ms/step - loss: 0.2018 - acc: 0.9298 - val_loss: 0.3690 - val_acc: 0.8750
Epoch 15/15
31/31 [==============================] - 3s 112ms/step - loss: 0.1868 - acc: 0.9298 - val_loss: 0.3680 - val_acc: 0.8625
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.src.callbacks.History at 0x796d8c42bfa0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">modelGRU</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Perda validação: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia validação: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Perda validação: 0.368015
Acurácia validação: 0.862500
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id89">
<h3>Exercício 7)<a class="headerlink" href="#id89" title="Permalink to this heading">#</a></h3>
<p>Word2Vec com aprendizado de uma rede totalmente convolucional, com convoluções dilatadas para classificação de sentenças.</p>
<p>Considere o mesmo problema anteriormente abordado no exercício anterior. Agora vamos utilizar uma redes com convoluções dilatadas que é um método para ampliar o campo receptivo local e reduzir número de operações, utilizada por exemplo para aplicações com áudio (como a WaveNet) de forma a combinar regiões cada vez mais amplas dos dados de entrada. No entanto é também aplicável para outros dados sequenciais como texto.</p>
<p>Veja uma explicação em: <a class="reference external" href="https://www.paperswithcode.com/method/dilated-convolution">https://www.paperswithcode.com/method/dilated-convolution</a></p>
<p>Projete uma rede neural, a qual chamaremos Conv, com as seguintes camadas</p>
<ul class="simple">
<li><p>Embedding layer</p></li>
<li><p>Conv1D com 32 filtros de tamanho 3, zeropadding e parâmetro <code class="docutils literal notranslate"><span class="pre">dilation_rate=2</span></code>, ativação relu</p></li>
<li><p>Camada Flatten: <em>como temos a entrada representada por (batch_size, seq_len, 1), a saída será (batch_size, seq_len, 1), por isso precisamos de uma camada flatten para achatar as dimensões e permitir uma saída (batch_size, 1)</em></p></li>
<li><p>Densa com 32 unidades e ativação relu</p></li>
<li><p>Dropout com taxa 25%</p></li>
<li><p>Densa com 1 unidade e ativação sigmoide</p></li>
</ul>
<p>Projete também uma segunda rede, que substitua a camada densa de 64 neurônios, logo antes da Camada Dropout, por uma camada GRU contendo 64 neurônios e ativação relu. Chamaremos essa rede de Conv+GRU.</p>
<p>Para cada rede, configure as sementes com seed(2) e set_seed(2), depois instancie o modelo, compile com a função entropia cruzada binária, otimizador adam (com seus parâmetros padrão). Treine por 20 épocas com batch size 16.</p>
<p>Considere a perda e a acurácia no conjunto de teste (use o método <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>). Qual dos modelos teve menor perda? Compare os resultados. Caso haja empate, use a maior acurácia para desempatar.</p>
<p>OBS: se possível execute algumas vezes para ver como varia a performance em diferentes inicializações</p>
<p><strong>Justificativa</strong>: Veja abaixo o código</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Conv_texto</span><span class="p">(</span><span class="n">input_shape_size</span><span class="p">):</span>
    <span class="c1"># na arquitetura totalmente convolucional precisamos definir o shape fixo para depois ter uma camada Flatten</span>
    <span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># como temos a entrada representada por (batch_size, seq_len, 1), a saída será (batch_size, seq_len, 1)</span>
    <span class="c1"># por isso precisamos de uma camada flatten para achatar as dimensões e permitir uma saída (batch_size, 1)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">predsConvout</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">modelConv</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predsConvout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modelConv</span>

<span class="k">def</span> <span class="nf">ConvGRU_texto</span><span class="p">():</span>
    <span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">predsConvout</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">modelConv</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predsConvout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modelConv</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modelConv</span> <span class="o">=</span> <span class="n">Conv_texto</span><span class="p">(</span><span class="n">x_train_net</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">modelConv</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">modelConv</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelConv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_net</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
              <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_3 (InputLayer)        [(None, 60)]              0         
                                                                 
 embedding (Embedding)       multiple                  160000    
                                                                 
 conv1d_2 (Conv1D)           (None, 60, 32)            3232      
                                                                 
 conv1d_3 (Conv1D)           (None, 60, 32)            3104      
                                                                 
 flatten_1 (Flatten)         (None, 1920)              0         
                                                                 
 dense_4 (Dense)             (None, 32)                61472     
                                                                 
 dropout_2 (Dropout)         (None, 32)                0         
                                                                 
 dense_5 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 227841 (890.00 KB)
Trainable params: 67841 (265.00 KB)
Non-trainable params: 160000 (625.00 KB)
_________________________________________________________________
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.src.callbacks.History at 0x796d40599e10&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modelConvGRU</span> <span class="o">=</span> <span class="n">ConvGRU_texto</span><span class="p">()</span>
<span class="n">modelConvGRU</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">modelConvGRU</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelConvGRU</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_net</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:Layer gru_1 will not use cuDNN kernels since it doesn&#39;t meet the criteria. It will use a generic GPU kernel as fallback when running on GPU.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_3&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_4 (InputLayer)        [(None, None)]            0         
                                                                 
 embedding (Embedding)       multiple                  160000    
                                                                 
 conv1d_4 (Conv1D)           (None, None, 32)          3232      
                                                                 
 conv1d_5 (Conv1D)           (None, None, 32)          3104      
                                                                 
 gru_1 (GRU)                 (None, 32)                6336      
                                                                 
 dropout_3 (Dropout)         (None, 32)                0         
                                                                 
 dense_6 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 172705 (674.63 KB)
Trainable params: 12705 (49.63 KB)
Non-trainable params: 160000 (625.00 KB)
_________________________________________________________________
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;keras.src.callbacks.History at 0x796d2c5a41f0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoresC</span> <span class="o">=</span> <span class="n">modelConv</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span><span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scoresG</span> <span class="o">=</span> <span class="n">modelConvGRU</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span><span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolucional&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perda teste: </span><span class="si">{</span><span class="n">scoresC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acurácia teste: </span><span class="si">{</span><span class="n">scoresC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolucional+GRU&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perda teste: </span><span class="si">{</span><span class="n">scoresG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acurácia teste: </span><span class="si">{</span><span class="n">scoresG</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Convolucional
Perda teste: 0.9274
Acurácia teste: 81.2%

Convolucional+GRU
Perda teste: 0.7847
Acurácia teste: 91.9%
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id90">
<h3>Exercício 8)<a class="headerlink" href="#id90" title="Permalink to this heading">#</a></h3>
<p>Considere o mesmo problema anteriormente abordado no exercício anterior. Agora vamos utilizar uma camada do tipo Self-Attention substituindo a Flatten do modelo Conv. Chamaremos esse modelo de Conv+Att.</p>
<p>Para cada rede, configure as sementes com seed(2) e set_seed(2), depois instancie o modelo, compile com a função entropia cruzada binária, otimizador adam (com seus parâmetros padrão). Treine por 20 épocas com batch size 16.</p>
<p>Compute acurácia e perda no conjunto de teste (use o método <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> após o treinamento), considere a acurácia em porcentagem e sem casas decimais (ex. 35%, 100%, 1%) e a perda com 4 casas decimais (ex. 0.9999, 0.6929, 0.4101).</p>
<p>Considerando a maior acurácia (e menor perda para desempatar), como se comparam os métodos Conv+ATT, Conv+GRU e Conv?</p>
<p>OBS: se possível execute algumas vezes para ver como varia a performance em diferentes inicializações</p>
<p><strong>Justificativa</strong>: Veja abaixo o código</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SelfAttentionLayer</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SelfAttentionLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span> <span class="o">=</span> <span class="n">return_sequences</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="c1"># Create a trainable weight variable for this layer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_q&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_k&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;W_v&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_q</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">)</span>

        <span class="c1"># Calculate attention scores using dot product</span>
        <span class="n">attn_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Apply softmax activation to get attention weights</span>
        <span class="n">attn_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attn_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Weighted sum using the attention scores</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn_score</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ConvAtt_texto</span><span class="p">():</span>
    <span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">dilation_rate</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">SelfAttentionLayer</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">predsConvout</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">modelConvAtt</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predsConvout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modelConvAtt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modelConvATT</span> <span class="o">=</span> <span class="n">ConvAtt_texto</span><span class="p">()</span>
<span class="n">modelConvATT</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">modelConvATT</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelConvATT</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_net</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">scoresA</span> <span class="o">=</span> <span class="n">modelConvATT</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_val_net</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_4&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_5 (InputLayer)        [(None, None)]            0         
                                                                 
 embedding (Embedding)       multiple                  160000    
                                                                 
 conv1d_6 (Conv1D)           (None, None, 32)          3232      
                                                                 
 conv1d_7 (Conv1D)           (None, None, 32)          3104      
                                                                 
 self_attention_layer (Self  (None, 32)                3072      
 AttentionLayer)                                                 
                                                                 
 dense_7 (Dense)             (None, 32)                1056      
                                                                 
 dropout_4 (Dropout)         (None, 32)                0         
                                                                 
 dense_8 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 170497 (666.00 KB)
Trainable params: 10497 (41.00 KB)
Non-trainable params: 160000 (625.00 KB)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolucional&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Perda teste: </span><span class="si">{</span><span class="n">scoresC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Acurácia teste: </span><span class="si">{</span><span class="n">scoresC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolucional+GRU&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Perda teste: </span><span class="si">{</span><span class="n">scoresG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Acurácia teste: </span><span class="si">{</span><span class="n">scoresG</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convolucional+Att&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Perda teste: </span><span class="si">{</span><span class="n">scoresA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Acurácia teste: </span><span class="si">{</span><span class="n">scoresA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Convolucional
-Perda teste: 0.9274
-Acurácia teste: 81%

Convolucional+GRU
-Perda teste: 0.7847
-Acurácia teste: 92%

Convolucional+Att
-Perda teste: 0.8076
-Acurácia teste: 89%
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id91">
<h2><span style="color:darkred">Módulo 6 - Redes neurais para texto</span><a class="headerlink" href="#id91" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-1-word-embeddings-span">
<h3><span style="color:darkred"><strong>Parte 1: Word Embeddings</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-1-word-embeddings-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Enabling eager execution
INFO:tensorflow:Enabling v2 tensorshape
INFO:tensorflow:Enabling resource variables
INFO:tensorflow:Enabling tensor equality
INFO:tensorflow:Enabling control flow v2
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="carregando-representacoes-pre-treinadas-em-portugues">
<h2>Carregando representações pré-treinadas em português<a class="headerlink" href="#carregando-representacoes-pre-treinadas-em-portugues" title="Permalink to this heading">#</a></h2>
<p>Após salvar, vamos montar um dicionário com palavra/vetor</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!wget http://143.107.183.175:22980/download.php?file=embeddings/glove/glove_s50.zip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!mv download.php?file=embeddings%2Fglove%2Fglove_s50.zip glove_s50.zip</span>
<span class="c1">#!unzip -q glove_s50.zip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># codigo arquivo Colab</span>
<span class="c1">#path_to_glove_file = os.path.join(</span>
<span class="c1">#    os.path.expanduser(&quot;~&quot;), &quot;/content/glove_s50.txt&quot; # colab</span>
<span class="c1">#)</span>

<span class="c1"># codigo arquivo Local</span>
<span class="n">path_to_glove_file</span> <span class="o">=</span> <span class="s2">&quot;./glove_s50.txt&quot;</span>

<span class="n">embeddings_index</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_glove_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Arquivo: total de linhas </span><span class="si">%d</span><span class="s1">, dimensoes </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tot</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
    <span class="n">il</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">coefs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">embeddings_index</span><span class="p">:</span>
                <span class="n">embeddings_index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span>
            <span class="n">il</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Problema ao processar&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="c1"># remover chave com problema</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">embeddings_index</span><span class="p">:</span>
                <span class="n">embeddings_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">il</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encontrados </span><span class="si">%s</span><span class="s2"> word vectors distintos.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processadas </span><span class="si">%d</span><span class="s2"> linhas.&quot;</span> <span class="o">%</span> <span class="n">il</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Arquivo: total de linhas 929605, dimensoes 50
	Problema ao processar 593019 r$
	Problema ao processar 638481 00
	Problema ao processar 748942 三藏法師玄奘奉
	Problema ao processar 821680 r$
Encontrados 929591 word vectors distintos.
Processadas 929599 linhas.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">[</span><span class="s1">&#39;aprovação&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">[</span><span class="s1">&#39;aprovação&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 6.984870e-01  1.938170e-01  1.839920e-01 -2.590166e+00 -3.155430e-01
 -1.469410e-01  1.290320e-01  3.814410e-01 -4.846610e-01  3.721310e-01
  6.471990e-01 -1.248160e+00 -3.151210e-01  3.676890e-01 -7.965720e-01
  2.589710e-01 -1.260200e-02 -6.782460e-01 -4.735670e-01  3.739230e-01
  1.437597e+00  2.001800e-02  9.999200e-02 -1.829620e-01  2.779400e-01
  1.222500e-01 -2.345070e-01 -7.791430e-01  6.422940e-01  3.167230e-01
 -3.914640e-01  3.333300e-01  2.291640e-01 -9.465310e-01 -2.157560e-01
 -3.246800e-02 -3.029230e-01  9.146800e-02 -1.788646e+00 -2.995630e-01
 -3.183580e-01 -7.586490e-01  2.524000e-03 -6.656960e-01  7.843900e-01
  1.341660e-01  6.273990e-01  3.014050e-01 -4.354190e-01  1.121057e+00]
50
</pre></div>
</div>
</div>
</div>
</section>
<section id="base-de-dados-rumor-brazil-2018">
<h2>Base de dados: rumor Brazil 2018<a class="headerlink" href="#base-de-dados-rumor-brazil-2018" title="Permalink to this heading">#</a></h2>
<p>Base de dados de texto para classificação em frases “falsas” ou “verdadeiras” conforme checado por agências</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/rumor-election-brazil-2018.csv&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">texto</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;texto&#39;</span><span class="p">]</span>
<span class="n">rotulos</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rotulo&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;VERDADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FALSO&quot;</span><span class="p">,</span> <span class="s2">&quot;VERDADEIRO&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">texto</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rotulos</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    Salário Mínimo: R$ 950,00. Bolsa Presidiário: ...
1    Empresa contratada pelo TSE para apuração dos ...
2    O Aloizio Mercadante, ministro da Educação, mo...
3    Há um complô espalhando fake news descaradas e...
4    Somente em 2017, mais de 800 milhões de tonela...
5    Nunca vi o Lula pronunciar essa palavra fascis...
6    O Mourão, por exemplo, foi ele próprio tortura...
7    O PSB, todos os seus governadores e o seu pres...
8    Bolsonaro Nunca aprovou um projeto de seguranç...
9    Ele Lula não pode aparecer mais que 25% no hor...
Name: texto, dtype: object
0    0
1    0
2    0
3    0
4    1
5    0
6    0
7    0
8    1
9    1
Name: rotulo, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">rotulos</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[239 221]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rotulos</span><span class="p">)</span>

<span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">num_validation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_split</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="p">))</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation</span><span class="p">]</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation</span><span class="p">:]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">rotulos</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation</span><span class="p">]</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">rotulos</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-14-87b77ae273f0&gt;:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  rng.shuffle(texto)
</pre></div>
</div>
</div>
</div>
<p>Vocabulário irá considerar até 20 mil palavras, e irá truncar sequências com mais de 32 tokens</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental.preprocessing</span> <span class="kn">import</span> <span class="n">TextVectorization</span>

<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TextVectorization</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">output_sequence_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">text_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">vectorizer</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">text_ds</span><span class="p">)</span>

<span class="n">voc</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
<span class="n">word_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">voc</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<p>Podemos ver o resultado do vetorizador, que exibe 1 para palavras fora do vocabulário</p>
<p>Assim, o token 1 será atribuído a qualquer palavra que seja desconhecida</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">([[</span><span class="s2">&quot;um dois one two three&quot;</span><span class="p">]])</span>
<span class="n">output</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([19, 92,  1,  1,  1])
</pre></div>
</div>
</div>
</div>
<p>Abaixo, considerando o número de tokens (palavras) da base de dados, vamos tentar gerar seus embedding vectors.</p>
<p>Palavras fora do vocabulário não são convertidas. Comumente artigos, números e outros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Número de tokens: &quot;</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">convertidas</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">falhas</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Prepare embedding matrix</span>
<span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">word_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">embedding_vector</span> <span class="o">=</span> <span class="n">embeddings_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embedding_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">embedding_vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">embedding_dim</span><span class="p">):</span>
            <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Words not found in embedding index will be all-zeros.</span>
            <span class="c1"># This includes the representation for &quot;padding&quot; and &quot;OOV&quot;</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_vector</span>
            <span class="n">convertidas</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Palavras convertidas: </span><span class="si">%d</span><span class="s2"> / não convertidas: </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">convertidas</span><span class="p">,</span> <span class="n">falhas</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de tokens:  1944
(1944, 50)
Palavras convertidas: 1786 / não convertidas: 156)
</pre></div>
</div>
</div>
</div>
<p>Montando a base de dados para o treinamento, no formato numpy array</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_train</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_val</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(414, 32)
(46, 32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="camada-de-word-embedding">
<h2>Camada de “Word Embedding”<a class="headerlink" href="#camada-de-word-embedding" title="Permalink to this heading">#</a></h2>
<p>Para isso devemos informar o número de palavras, a dimensionalidade e passar a matrix com pesos pré-treinados.</p>
<p>Caso não utilizemos os parâmetros <code class="docutils literal notranslate"><span class="pre">embeddings_initializer</span></code>, os pesos serão aleatórios.</p>
<p>Também deixamos essa camada não treinável pois não queremos modificar as representações</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Embedding</span>

<span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span>
    <span class="n">num_tokens</span><span class="p">,</span>
    <span class="n">embedding_dim</span><span class="p">,</span>
    <span class="c1"># define a inicializacao com a matriz obtida</span>
    <span class="n">embeddings_initializer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">),</span>
    <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># nao será treinavel</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># decaimento de learning rate</span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.005</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="modelo-baseado-em-convolucoes">
<h3>Modelo baseado em Convoluções<a class="headerlink" href="#modelo-baseado-em-convolucoes" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
<span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling1D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">modelConv</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
<span class="n">modelConv</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_1&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, None)]            0         
_________________________________________________________________
embedding (Embedding)        (None, None, 50)          97200     
_________________________________________________________________
conv1d_2 (Conv1D)            (None, None, 64)          6464      
_________________________________________________________________
conv1d_3 (Conv1D)            (None, None, 128)         24704     
_________________________________________________________________
global_max_pooling1d_1 (Glob (None, 128)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 64)                8256      
_________________________________________________________________
dropout_1 (Dropout)          (None, 64)                0         
_________________________________________________________________
dense_3 (Dense)              (None, 1)                 65        
=================================================================
Total params: 136,689
Trainable params: 39,489
Non-trainable params: 97,200
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelConv</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelConv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
Época 0000 - learning rate 0.001000000
26/26 [==============================] - 1s 12ms/step - loss: 0.7649 - acc: 0.4741 - val_loss: 0.6875 - val_acc: 0.5000
Epoch 2/20
26/26 [==============================] - 0s 4ms/step - loss: 0.6745 - acc: 0.5874 - val_loss: 0.6622 - val_acc: 0.6739
Epoch 3/20
26/26 [==============================] - 0s 4ms/step - loss: 0.6181 - acc: 0.6632 - val_loss: 0.6583 - val_acc: 0.5435
Epoch 4/20
26/26 [==============================] - 0s 4ms/step - loss: 0.5357 - acc: 0.7762 - val_loss: 0.6289 - val_acc: 0.5435
Epoch 5/20
26/26 [==============================] - 0s 4ms/step - loss: 0.4919 - acc: 0.7897 - val_loss: 0.6313 - val_acc: 0.6739
Epoch 6/20
Época 0005 - learning rate 0.000995012
26/26 [==============================] - 0s 4ms/step - loss: 0.4180 - acc: 0.8334 - val_loss: 0.6319 - val_acc: 0.5652
Epoch 7/20
26/26 [==============================] - 0s 4ms/step - loss: 0.3445 - acc: 0.8767 - val_loss: 0.6547 - val_acc: 0.6957
Epoch 8/20
26/26 [==============================] - 0s 4ms/step - loss: 0.2140 - acc: 0.9504 - val_loss: 0.6360 - val_acc: 0.7174
Epoch 9/20
26/26 [==============================] - 0s 4ms/step - loss: 0.1662 - acc: 0.9688 - val_loss: 0.6551 - val_acc: 0.6087
Epoch 10/20
26/26 [==============================] - 0s 4ms/step - loss: 0.1195 - acc: 0.9922 - val_loss: 0.5900 - val_acc: 0.6739
Epoch 11/20
Época 0010 - learning rate 0.000970445
26/26 [==============================] - 0s 4ms/step - loss: 0.0816 - acc: 0.9890 - val_loss: 0.7782 - val_acc: 0.6739
Epoch 12/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0585 - acc: 0.9944 - val_loss: 0.6438 - val_acc: 0.6087
Epoch 13/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0433 - acc: 0.9985 - val_loss: 0.6334 - val_acc: 0.6522
Epoch 14/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0401 - acc: 0.9980 - val_loss: 0.6968 - val_acc: 0.6739
Epoch 15/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0275 - acc: 1.0000 - val_loss: 0.7266 - val_acc: 0.6522
Epoch 16/20
Época 0015 - learning rate 0.000946485
26/26 [==============================] - 0s 4ms/step - loss: 0.0302 - acc: 0.9988 - val_loss: 0.7060 - val_acc: 0.6522
Epoch 17/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0219 - acc: 1.0000 - val_loss: 0.7375 - val_acc: 0.6739
Epoch 18/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0141 - acc: 1.0000 - val_loss: 0.7709 - val_acc: 0.6957
Epoch 19/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0097 - acc: 1.0000 - val_loss: 0.7621 - val_acc: 0.6522
Epoch 20/20
26/26 [==============================] - 0s 4ms/step - loss: 0.0117 - acc: 1.0000 - val_loss: 0.8726 - val_acc: 0.5652
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.keras.callbacks.History at 0x7ff47c6b1b20&gt;
</pre></div>
</div>
</div>
</div>
<p>Podemos agora testar frases novas!</p>
<p>Para isso vou criar uma camada de entrada que passa por um vetorizador, e depois alimenta o modelo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a entrada é uma string</span>
<span class="n">string_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="c1"># a string é passada ao vetorizador</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">string_input</span><span class="p">)</span>
<span class="c1"># as predicoes sao obtidas do modelo Convolucional</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">modelConv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># definimos o modelo end-to-end cuja entrada é uma string</span>
<span class="c1"># e depois passa por nosso modelo treinado gerando predicoes como saida</span>
<span class="n">end_to_end_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Na pós graduação, as mulheres são maioria&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Acabou a corrupção no Brasil&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Para poder ganhar eleições, presidente faz aliança com partidos grandes&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;São Paulo é a cidade com os piores índices educacionais&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Na pós graduação, as mulheres são maioria :  VERDADEIRO
As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido :  VERDADEIRO
Acabou a corrupção no Brasil :  VERDADEIRO
Para poder ganhar eleições, presidente faz aliança com partidos grandes :  VERDADEIRO
São Paulo é a cidade com os piores índices educacionais :  FALSO
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelo-utilizando-gru">
<h3>Modelo utilizando GRU<a class="headerlink" href="#modelo-utilizando-gru" title="Permalink to this heading">#</a></h3>
<p>Vamos substituir uma camada convolucional por uma GRU (poderia ser uma LSTM também)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">int_sequences_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
<span class="n">embedded_sequences</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">int_sequences_input</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">embedded_sequences</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">predsGRUout</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">modelGRU</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">int_sequences_input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predsGRUout</span><span class="p">)</span>
<span class="n">modelGRU</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_3&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_4 (InputLayer)         [(None, None)]            0         
_________________________________________________________________
embedding (Embedding)        (None, None, 50)          97200     
_________________________________________________________________
conv1d_4 (Conv1D)            (None, None, 64)          6464      
_________________________________________________________________
gru (GRU)                    (None, 64)                24960     
_________________________________________________________________
dense_4 (Dense)              (None, 64)                4160      
_________________________________________________________________
dropout_2 (Dropout)          (None, 64)                0         
_________________________________________________________________
dense_5 (Dense)              (None, 1)                 65        
=================================================================
Total params: 132,849
Trainable params: 35,649
Non-trainable params: 97,200
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelGRU</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">modelGRU</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
Época 0000 - learning rate 0.001000000
26/26 [==============================] - 3s 29ms/step - loss: 0.6937 - acc: 0.4940 - val_loss: 0.7017 - val_acc: 0.5435
Epoch 2/20
26/26 [==============================] - 0s 15ms/step - loss: 0.6853 - acc: 0.4620 - val_loss: 0.7001 - val_acc: 0.4783
Epoch 3/20
26/26 [==============================] - 1s 31ms/step - loss: 0.6801 - acc: 0.5673 - val_loss: 0.7048 - val_acc: 0.5435
Epoch 4/20
26/26 [==============================] - 1s 45ms/step - loss: 0.6779 - acc: 0.4919 - val_loss: 0.7051 - val_acc: 0.4783
Epoch 5/20
26/26 [==============================] - 1s 44ms/step - loss: 0.6779 - acc: 0.4996 - val_loss: 0.7020 - val_acc: 0.4348
Epoch 6/20
Época 0005 - learning rate 0.000995012
26/26 [==============================] - 1s 38ms/step - loss: 0.6646 - acc: 0.5270 - val_loss: 0.7021 - val_acc: 0.4348
Epoch 7/20
26/26 [==============================] - 1s 43ms/step - loss: 0.6625 - acc: 0.5464 - val_loss: 0.7021 - val_acc: 0.4565
Epoch 8/20
26/26 [==============================] - 1s 38ms/step - loss: 0.6529 - acc: 0.5097 - val_loss: 0.7118 - val_acc: 0.5435
Epoch 9/20
26/26 [==============================] - 1s 34ms/step - loss: 0.6392 - acc: 0.5575 - val_loss: 0.7458 - val_acc: 0.5435
Epoch 10/20
26/26 [==============================] - 1s 35ms/step - loss: 0.6445 - acc: 0.6008 - val_loss: 0.7593 - val_acc: 0.5652
Epoch 11/20
Época 0010 - learning rate 0.000970445
26/26 [==============================] - 1s 43ms/step - loss: 0.6244 - acc: 0.5984 - val_loss: 0.6836 - val_acc: 0.5652
Epoch 12/20
26/26 [==============================] - 1s 38ms/step - loss: 0.6120 - acc: 0.6449 - val_loss: 0.6669 - val_acc: 0.4783
Epoch 13/20
26/26 [==============================] - 1s 39ms/step - loss: 0.6218 - acc: 0.6430 - val_loss: 0.6383 - val_acc: 0.5870
Epoch 14/20
26/26 [==============================] - 1s 45ms/step - loss: 0.5785 - acc: 0.6609 - val_loss: 0.6203 - val_acc: 0.6087
Epoch 15/20
26/26 [==============================] - 1s 42ms/step - loss: 0.5482 - acc: 0.6886 - val_loss: 0.6383 - val_acc: 0.6957
Epoch 16/20
Época 0015 - learning rate 0.000946485
26/26 [==============================] - 1s 45ms/step - loss: 0.5657 - acc: 0.6775 - val_loss: 0.6185 - val_acc: 0.7174
Epoch 17/20
26/26 [==============================] - 1s 44ms/step - loss: 0.5462 - acc: 0.7203 - val_loss: 0.5872 - val_acc: 0.6522
Epoch 18/20
26/26 [==============================] - 1s 39ms/step - loss: 0.5175 - acc: 0.7263 - val_loss: 0.5449 - val_acc: 0.6957
Epoch 19/20
26/26 [==============================] - 1s 42ms/step - loss: 0.4592 - acc: 0.7863 - val_loss: 0.5999 - val_acc: 0.5652
Epoch 20/20
26/26 [==============================] - 1s 38ms/step - loss: 0.4511 - acc: 0.7566 - val_loss: 0.6371 - val_acc: 0.6739
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.keras.callbacks.History at 0x7ff45c591700&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">string_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">string_input</span><span class="p">)</span>
<span class="n">predsGRU</span> <span class="o">=</span> <span class="n">modelGRU</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">end_to_end_modelGRU</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">predsGRU</span><span class="p">)</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Na pós graduação, as mulheres são maioria&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_modelGRU</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_modelGRU</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Acabou a corrupção no Brasil&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_modelGRU</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Para poder ganhar eleições, presidente faz aliança com partidos grandes&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_modelGRU</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;São Paulo é a cidade com os piores índices educacionais&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Na pós graduação, as mulheres são maioria :  VERDADEIRO
As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido :  VERDADEIRO
Acabou a corrupção no Brasil :  FALSO
Para poder ganhar eleições, presidente faz aliança com partidos grandes :  VERDADEIRO
São Paulo é a cidade com os piores índices educacionais :  FALSO
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id92">
<h2><span style="color:darkred">Módulo 6 - Redes neurais para texto</span><a class="headerlink" href="#id92" title="Permalink to this heading">#</a></h2>
<section id="parte-2-transformer-based-network-span">
<h3><strong>Parte 2: Transformer-based Network</strong></span><a class="headerlink" href="#parte-2-transformer-based-network-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Enabling eager execution
INFO:tensorflow:Enabling v2 tensorshape
INFO:tensorflow:Enabling resource variables
INFO:tensorflow:Enabling tensor equality
INFO:tensorflow:Enabling control flow v2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!wget http://143.107.183.175:22980/download.php?file=embeddings/glove/glove_s50.zip</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2020-10-18 00:09:58--  http://143.107.183.175:22980/download.php?file=embeddings/glove/glove_s50.zip
Connecting to 143.107.183.175:22980... connected.
HTTP request sent, awaiting response... 200 OK
Length: 181356545 (173M) [application/octet-stream]
Saving to: ‘download.php?file=embeddings%2Fglove%2Fglove_s50.zip’

download.php?file=e 100%[===================&gt;] 172.96M  9.32MB/s    in 27s     

2020-10-18 00:10:26 (6.37 MB/s) - ‘download.php?file=embeddings%2Fglove%2Fglove_s50.zip’ saved [181356545/181356545]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!mv download.php?file=embeddings%2Fglove%2Fglove_s50.zip glove_s50.zip</span>
<span class="c1">#!unzip -q glove_s50.zip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># codigo arquivo Colab</span>
<span class="c1">#path_to_glove_file = os.path.join(</span>
<span class="c1">#    os.path.expanduser(&quot;~&quot;), &quot;/content/glove_s50.txt&quot; # colab</span>
<span class="c1">#)</span>

<span class="c1"># codigo arquivo Local</span>
<span class="n">path_to_glove_file</span> <span class="o">=</span> <span class="s2">&quot;./glove_s50.txt&quot;</span>

<span class="n">embeddings_index</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_glove_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Arquivo: total de linhas </span><span class="si">%d</span><span class="s1">, dimensoes </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tot</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
    <span class="n">il</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">word</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">coefs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">embeddings_index</span><span class="p">:</span>
                <span class="n">embeddings_index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span>
            <span class="n">il</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Problema ao processar&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="c1"># remover chave com problema</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">embeddings_index</span><span class="p">:</span>
                <span class="n">embeddings_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">il</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encontrados </span><span class="si">%s</span><span class="s2"> word vectors distintos.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processadas </span><span class="si">%d</span><span class="s2"> linhas.&quot;</span> <span class="o">%</span> <span class="n">il</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Arquivo: total de linhas 929605, dimensoes 50
	Problema ao processar 593019 r$
	Problema ao processar 638481 00
	Problema ao processar 748942 三藏法師玄奘奉
	Problema ao processar 821680 r$
Encontrados 929591 word vectors distintos.
Processadas 929599 linhas.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">[</span><span class="s1">&#39;aprovação&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">embeddings_index</span><span class="p">[</span><span class="s1">&#39;aprovação&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 6.984870e-01  1.938170e-01  1.839920e-01 -2.590166e+00 -3.155430e-01
 -1.469410e-01  1.290320e-01  3.814410e-01 -4.846610e-01  3.721310e-01
  6.471990e-01 -1.248160e+00 -3.151210e-01  3.676890e-01 -7.965720e-01
  2.589710e-01 -1.260200e-02 -6.782460e-01 -4.735670e-01  3.739230e-01
  1.437597e+00  2.001800e-02  9.999200e-02 -1.829620e-01  2.779400e-01
  1.222500e-01 -2.345070e-01 -7.791430e-01  6.422940e-01  3.167230e-01
 -3.914640e-01  3.333300e-01  2.291640e-01 -9.465310e-01 -2.157560e-01
 -3.246800e-02 -3.029230e-01  9.146800e-02 -1.788646e+00 -2.995630e-01
 -3.183580e-01 -7.586490e-01  2.524000e-03 -6.656960e-01  7.843900e-01
  1.341660e-01  6.273990e-01  3.014050e-01 -4.354190e-01  1.121057e+00]
50
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/rumor-election-brazil-2018.csv&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">texto</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;texto&#39;</span><span class="p">]</span>
<span class="n">rotulos</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rotulo&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;VERDADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FALSO&quot;</span><span class="p">,</span> <span class="s2">&quot;VERDADEIRO&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">texto</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rotulos</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    Salário Mínimo: R$ 950,00. Bolsa Presidiário: ...
1    Empresa contratada pelo TSE para apuração dos ...
2    O Aloizio Mercadante, ministro da Educação, mo...
3    Há um complô espalhando fake news descaradas e...
4    Somente em 2017, mais de 800 milhões de tonela...
5    Nunca vi o Lula pronunciar essa palavra fascis...
6    O Mourão, por exemplo, foi ele próprio tortura...
7    O PSB, todos os seus governadores e o seu pres...
8    Bolsonaro Nunca aprovou um projeto de seguranç...
9    Ele Lula não pode aparecer mais que 25% no hor...
Name: texto, dtype: object
0    0
1    0
2    0
3    0
4    1
5    0
6    0
7    0
8    1
9    1
Name: rotulo, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">texto</span><span class="p">)</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rotulos</span><span class="p">)</span>

<span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">num_validation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_split</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="p">))</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation</span><span class="p">]</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">texto</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation</span><span class="p">:]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">rotulos</span><span class="p">[:</span><span class="o">-</span><span class="n">num_validation</span><span class="p">]</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">rotulos</span><span class="p">[</span><span class="o">-</span><span class="n">num_validation</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-8-87b77ae273f0&gt;:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  rng.shuffle(texto)
</pre></div>
</div>
</div>
</div>
<p>Vocabulário irá considerar até 20 mil palavras, e irá truncar sequências com mais de 32 tokens</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">maxlen</span> <span class="o">=</span> <span class="mi">32</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental.preprocessing</span> <span class="kn">import</span> <span class="n">TextVectorization</span>

<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TextVectorization</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">output_sequence_length</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span>
<span class="n">text_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">vectorizer</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">text_ds</span><span class="p">)</span>

<span class="n">voc</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_vocabulary</span><span class="p">()</span>
<span class="n">word_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">voc</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">voc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Número de tokens: &quot;</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">convertidas</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">falhas</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Prepare embedding matrix</span>
<span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">word_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">embedding_vector</span> <span class="o">=</span> <span class="n">embeddings_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">embedding_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">embedding_vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">embedding_dim</span><span class="p">):</span>
            <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Words not found in embedding index will be all-zeros.</span>
            <span class="c1"># This includes the representation for &quot;padding&quot; and &quot;OOV&quot;</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_vector</span>
            <span class="n">convertidas</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">falhas</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Palavras convertidas: </span><span class="si">%d</span><span class="s2"> / não convertidas: </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">convertidas</span><span class="p">,</span> <span class="n">falhas</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de tokens:  1944
(1944, 50)
Palavras convertidas: 1786 / não convertidas: 156)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_train</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x_val</span><span class="p">]))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">y_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(414, 32)
(46, 32)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="implementacao-de-transformer">
<h2>Implementação de Transformer<a class="headerlink" href="#implementacao-de-transformer" title="Permalink to this heading">#</a></h2>
<p>Apoorv Nandan</p>
<p><a class="reference external" href="https://keras.io/examples/nlp/text_classification_with_transformer/">https://keras.io/examples/nlp/text_classification_with_transformer/</a></p>
<p>Camada Multi-head Self-attention</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MultiHeadSelfAttention</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiHeadSelfAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
        <span class="k">if</span> <span class="n">embed_dim</span> <span class="o">%</span> <span class="n">num_heads</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;embedding dimension = </span><span class="si">{</span><span class="n">embed_dim</span><span class="si">}</span><span class="s2"> should be divisible by number of heads = </span><span class="si">{</span><span class="n">num_heads</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_dim</span> <span class="o">=</span> <span class="n">embed_dim</span> <span class="o">//</span> <span class="n">num_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_dense</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_dense</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_dense</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine_heads</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dim_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">scaled_score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dim_key</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scaled_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">weights</span>

    <span class="k">def</span> <span class="nf">separate_heads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_dim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># x.shape = [batch_size, seq_len, embedding_dim]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">inputs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_dense</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>  <span class="c1"># (batch_size, seq_len, embed_dim)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_dense</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>  <span class="c1"># (batch_size, seq_len, embed_dim)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_dense</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>  <span class="c1"># (batch_size, seq_len, embed_dim)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_heads</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">batch_size</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, num_heads, seq_len, projection_dim)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_heads</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">batch_size</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, num_heads, seq_len, projection_dim)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_heads</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">batch_size</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, num_heads, seq_len, projection_dim)</span>
        <span class="n">attention</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="n">attention</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, seq_len, num_heads, projection_dim)</span>
        <span class="n">concat_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">attention</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, seq_len, embed_dim)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_heads</span><span class="p">(</span>
            <span class="n">concat_attention</span>
        <span class="p">)</span>  <span class="c1"># (batch_size, seq_len, embed_dim)</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<p>Bloco Transformer com Atenção + combinação residual + normalização + dropout</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TransformerBlock</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">ff_dim</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TransformerBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">MultiHeadSelfAttention</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">ff_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">),]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layernorm1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layernorm2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="p">):</span>
        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">att</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">attn_output</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layernorm1</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="n">attn_output</span><span class="p">)</span>
        <span class="n">ffn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span>
        <span class="n">ffn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">ffn_output</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layernorm2</span><span class="p">(</span><span class="n">out1</span> <span class="o">+</span> <span class="n">ffn_output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="camada-de-embedding-contendo-word-embedding-e-vetor-com-posicoes-das-palavras">
<h3>Camada de Embedding, contendo word embedding e vetor com posições das palavras<a class="headerlink" href="#camada-de-embedding-contendo-word-embedding-e-vetor-com-posicoes-das-palavras" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TokenAndPositionEmbedding</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">embedding_matrix</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TokenAndPositionEmbedding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_emb</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">maxlen</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span>
            <span class="n">embeddings_initializer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">embedding_matrix</span><span class="p">),</span>
            <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_emb</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="n">maxlen</span><span class="p">,</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_emb</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_emb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">positions</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="montando-a-rede-transformer">
<h3>Montando a rede Transformer<a class="headerlink" href="#montando-a-rede-transformer" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_heads</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Number of attention heads</span>
<span class="n">ff_dim</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Hidden layer size in feed forward network inside transformer</span>

<span class="n">embedding_layer</span> <span class="o">=</span> <span class="n">TokenAndPositionEmbedding</span><span class="p">(</span><span class="n">num_tokens</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">embedding_matrix</span><span class="p">)</span>
<span class="n">transformer_block</span> <span class="o">=</span> <span class="n">TransformerBlock</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">ff_dim</span><span class="p">)</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">embedding_layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">transformer_block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling1D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">modelT</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
<span class="n">modelT</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_8&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
Total params: 211,411
Trainable params: 114,211
Non-trainable params: 97,200
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modelT</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">modelT</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="c1">#x_train, y_train, batch_size=32, epochs=20, validation_data=(x_val, y_val)</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/25
52/52 [==============================] - 2s 13ms/step - loss: 0.7006 - accuracy: 0.5263 - val_loss: 0.6653 - val_accuracy: 0.6739
Epoch 2/25
52/52 [==============================] - 0s 5ms/step - loss: 0.6355 - accuracy: 0.6046 - val_loss: 0.6668 - val_accuracy: 0.6522
Epoch 3/25
52/52 [==============================] - 0s 5ms/step - loss: 0.6258 - accuracy: 0.6104 - val_loss: 0.7202 - val_accuracy: 0.5870
Epoch 4/25
52/52 [==============================] - 0s 5ms/step - loss: 0.5547 - accuracy: 0.6890 - val_loss: 0.7440 - val_accuracy: 0.4565
Epoch 5/25
52/52 [==============================] - 0s 5ms/step - loss: 0.5769 - accuracy: 0.6797 - val_loss: 0.6599 - val_accuracy: 0.5652
Epoch 6/25
52/52 [==============================] - 0s 5ms/step - loss: 0.5543 - accuracy: 0.7248 - val_loss: 0.6848 - val_accuracy: 0.5652
Epoch 7/25
52/52 [==============================] - 0s 5ms/step - loss: 0.4809 - accuracy: 0.7589 - val_loss: 0.7122 - val_accuracy: 0.6304
Epoch 8/25
52/52 [==============================] - 0s 5ms/step - loss: 0.4931 - accuracy: 0.7566 - val_loss: 0.7292 - val_accuracy: 0.6304
Epoch 9/25
52/52 [==============================] - 0s 5ms/step - loss: 0.3954 - accuracy: 0.8397 - val_loss: 0.8361 - val_accuracy: 0.5000
Epoch 10/25
52/52 [==============================] - 0s 5ms/step - loss: 0.4585 - accuracy: 0.7766 - val_loss: 0.7274 - val_accuracy: 0.6304
Epoch 11/25
52/52 [==============================] - 0s 5ms/step - loss: 0.4396 - accuracy: 0.7657 - val_loss: 0.7077 - val_accuracy: 0.6304
Epoch 12/25
52/52 [==============================] - 0s 5ms/step - loss: 0.3747 - accuracy: 0.8441 - val_loss: 0.6897 - val_accuracy: 0.6522
Epoch 13/25
52/52 [==============================] - 0s 5ms/step - loss: 0.3418 - accuracy: 0.8381 - val_loss: 0.9956 - val_accuracy: 0.5652
Epoch 14/25
52/52 [==============================] - 0s 5ms/step - loss: 0.3039 - accuracy: 0.8616 - val_loss: 0.6988 - val_accuracy: 0.7174
Epoch 15/25
52/52 [==============================] - 1s 10ms/step - loss: 0.2710 - accuracy: 0.8787 - val_loss: 0.8059 - val_accuracy: 0.6522
Epoch 16/25
52/52 [==============================] - 1s 12ms/step - loss: 0.2720 - accuracy: 0.8886 - val_loss: 0.8043 - val_accuracy: 0.6739
Epoch 17/25
52/52 [==============================] - 1s 12ms/step - loss: 0.1556 - accuracy: 0.9513 - val_loss: 0.7691 - val_accuracy: 0.7391
Epoch 18/25
52/52 [==============================] - 1s 12ms/step - loss: 0.1136 - accuracy: 0.9678 - val_loss: 0.8189 - val_accuracy: 0.6739
Epoch 19/25
52/52 [==============================] - 1s 12ms/step - loss: 0.0878 - accuracy: 0.9686 - val_loss: 0.9843 - val_accuracy: 0.6522
Epoch 20/25
52/52 [==============================] - 1s 12ms/step - loss: 0.1085 - accuracy: 0.9630 - val_loss: 0.9449 - val_accuracy: 0.6957
Epoch 21/25
52/52 [==============================] - 1s 12ms/step - loss: 0.1030 - accuracy: 0.9712 - val_loss: 1.0103 - val_accuracy: 0.6739
Epoch 22/25
52/52 [==============================] - 1s 12ms/step - loss: 0.0864 - accuracy: 0.9602 - val_loss: 0.9199 - val_accuracy: 0.6957
Epoch 23/25
52/52 [==============================] - 1s 12ms/step - loss: 0.0639 - accuracy: 0.9843 - val_loss: 1.1275 - val_accuracy: 0.7174
Epoch 24/25
52/52 [==============================] - 1s 12ms/step - loss: 0.0703 - accuracy: 0.9850 - val_loss: 1.0581 - val_accuracy: 0.7391
Epoch 25/25
52/52 [==============================] - 1s 12ms/step - loss: 0.0302 - accuracy: 0.9969 - val_loss: 1.0737 - val_accuracy: 0.7391
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">string_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="p">(</span><span class="n">string_input</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">modelT</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">end_to_end_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">string_input</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Na pós graduação, as mulheres são maioria&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Acabou a corrupção no Brasil&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;Para poder ganhar eleições, presidente faz aliança com partidos grandes&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">frase</span> <span class="o">=</span> <span class="s2">&quot;São Paulo é a cidade com os piores índices educacionais&quot;</span>
<span class="n">classe</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_to_end_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">frase</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frase</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classe</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Na pós graduação, as mulheres são maioria :  VERDADEIRO
As queimadas esse ano são equivalentes a uma área do tamanho do Reino Unido :  VERDADEIRO
Acabou a corrupção no Brasil :  FALSO
Para poder ganhar eleições, presidente faz aliança com partidos grandes :  VERDADEIRO
São Paulo é a cidade com os piores índices educacionais :  FALSO
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id93">
<h2><span style="color:darkred">Módulo 6 - Redes neurais para texto</span><a class="headerlink" href="#id93" title="Permalink to this heading">#</a></h2>
<section id="parte-3-distilbert-transferencia-de-aprendizado-span">
<h3><strong>Parte 3: DistilBERT: transferência de aprendizado</strong></span><a class="headerlink" href="#parte-3-distilbert-transferencia-de-aprendizado-span" title="Permalink to this heading">#</a></h3>
<p><font size=2>Baseado no material de: Ray William (Rice University)
<a class="reference external" href="https://towardsdatascience.com/hugging-face-transformers-fine-tuning-distilbert-for-binary-classification-tasks-490f1d192379">https://towardsdatascience.com/hugging-face-transformers-fine-tuning-distilbert-for-binary-classification-tasks-490f1d192379</a></font></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
!pip install transformers
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TFDistilBertModel</span><span class="p">,</span> <span class="n">DistilBertConfig</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">DistilBertTokenizerFast</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="carregando-dataset-de-texto">
<h1>1. Carregando Dataset de texto<a class="headerlink" href="#carregando-dataset-de-texto" title="Permalink to this heading">#</a></h1>
<p>Assumindo que há as colunas:</p>
<ul class="simple">
<li><p>text: contendo o texto a ser classificado</p></li>
<li><p>label contendo o rótulo do texto</p></li>
</ul>
<p>Aqui usarei um subconjunto do IMDB dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Train.csv&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5000, 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Test.csv&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5000, 2)
</pre></div>
</div>
</div>
</div>
<section id="preparando-o-dataset-para-uso-na-rede-neural">
<h2>2.1 Preparando o dataset para uso na rede neural<a class="headerlink" href="#preparando-o-dataset-para-uso-na-rede-neural" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Número máximo de palavras a tokenizar em uma instancia</span>
<span class="c1"># (DistilBERT aceita até 512)</span>
<span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c1"># Funcao para realizar encoding do texto em batches</span>
<span class="k">def</span> <span class="nf">batch_encode</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">MAX_LENGTH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Input:</span>
<span class="s2">        - tokenizer:   Objeto de uma classe PreTrainedTokenizer</span>
<span class="s2">        - texts:       Lista de strings</span>
<span class="s2">        - batch_size:  inteiro com número de textos num batch</span>
<span class="s2">        - max_length:  máximo número de palavras para tokenizar num texto</span>
<span class="s2">    Output:</span>
<span class="s2">        - input_ids:      sequencia de textos codificados como objeto tf.Tensor</span>
<span class="s2">        - attention_mask: máscaras de atenção dos textos como objeto tf.Tensor</span>
<span class="s2">    &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</span>

    <span class="n">input_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span>
                                             <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                                             <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;longest&#39;</span><span class="p">,</span>
                                             <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">return_token_type_ids</span><span class="o">=</span><span class="kc">False</span>
                                             <span class="p">)</span>
        <span class="n">input_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
        <span class="n">attention_mask</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">])</span>


    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">input_ids</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">)</span>


<span class="c1"># tokenizador do modelo que desejamos usar</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">DistilBertTokenizerFast</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;distilbert-base-uncased&#39;</span><span class="p">)</span>

<span class="c1"># Codificar treinamento</span>
<span class="n">X_train_ids</span><span class="p">,</span> <span class="n">X_train_attention</span> <span class="o">=</span> <span class="n">batch_encode</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Codificar teste</span>
<span class="n">X_test_ids</span><span class="p">,</span> <span class="n">X_test_attention</span> <span class="o">=</span> <span class="n">batch_encode</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "30f74753a16c45388a3fd502ff786a9f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "51f0caa6da934ffa9599639e14df5e1c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7167c4db2176456c92e24ff010ce3917", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c3ae7e2a6f5344bf96aac318fe8cae66", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="carregar-modelo-pre-treinado-e-configura-lo">
<h1>3. Carregar modelo pré-treinado e configurá-lo<a class="headerlink" href="#carregar-modelo-pre-treinado-e-configura-lo" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DISTILBERT_DROPOUT</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">DISTILBERT_ATT_DROPOUT</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># Configurar inicializacao do DistilBERT</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">DistilBertConfig</span><span class="p">(</span><span class="n">dropout</span><span class="o">=</span><span class="n">DISTILBERT_DROPOUT</span><span class="p">,</span>
                          <span class="n">attention_dropout</span><span class="o">=</span><span class="n">DISTILBERT_ATT_DROPOUT</span><span class="p">,</span>
                          <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># pre-trained DistilBERT com saída baseada nos hidden_states do modelo</span>
<span class="n">distilBERT</span> <span class="o">=</span> <span class="n">TFDistilBertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;distilbert-base-uncased&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># congelar backbone distilBERT</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">distilBERT</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ba4d0f80cb4647be8effc64b0baa639e", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Some weights of the PyTorch model were not used when initializing the TF 2.0 model TFDistilBertModel: [&#39;vocab_layer_norm.weight&#39;, &#39;vocab_transform.weight&#39;, &#39;vocab_projector.bias&#39;, &#39;vocab_layer_norm.bias&#39;, &#39;vocab_transform.bias&#39;]
- This IS expected if you are initializing TFDistilBertModel from a PyTorch model trained on another task or with another architecture (e.g. initializing a TFBertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing TFDistilBertModel from a PyTorch model that you expect to be exactly identical (e.g. initializing a TFBertForSequenceClassification model from a BertForSequenceClassification model).
All the weights of TFDistilBertModel were initialized from the PyTorch model.
If your task is similar to the task the model of the checkpoint was trained on, you can already use TFDistilBertModel for predictions without further training.
</pre></div>
</div>
</div>
</div>
<section id="criar-modelo-para-realizar-transferencia-de-aprendizado-para-a-tarefa-alvo-downstream-task-de-classificacao">
<h2>3.1 Criar modelo para realizar transferência de aprendizado para a tarefa alvo (downstream task) de classificação<a class="headerlink" href="#criar-modelo-para-realizar-transferencia-de-aprendizado-para-a-tarefa-alvo-downstream-task-de-classificacao" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">LAYER_DROPOUT</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">3e-5</span>
<span class="n">RANDOM_STATE</span> <span class="o">=</span> <span class="mi">42</span>

<span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">MAX_LENGTH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Input:</span>
<span class="sd">      - transformer:  objeto Hugging Face transformer (BERT, DistilBERT)</span>
<span class="sd">                      sem a camada finald e classificação.</span>
<span class="sd">      - max_length:   máximo de tokens a codificar</span>

<span class="sd">    Output:</span>
<span class="sd">      - model:        tf.keras.Model compilado com camadas finais adicionadas</span>
<span class="sd">                      para classificação binária</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># inicializador usando Glorot</span>
    <span class="n">weight_initializer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">GlorotNormal</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>

    <span class="c1"># input layers (ids e attention)</span>
    <span class="n">input_ids_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">max_length</span><span class="p">,),</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_ids&#39;</span><span class="p">,</span>
                                            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">input_attention_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">max_length</span><span class="p">,),</span>
                                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_attention&#39;</span><span class="p">,</span>
                                                  <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="c1"># DistilBERT gera uma tupla na qual o primeiro elemento (0) é o</span>
    <span class="c1"># hidden_state na saída do modelo</span>
    <span class="c1"># é um tf.Tensor de tamanho=(batch_size, sequence_length, hidden_size=768).</span>
    <span class="n">last_hidden_state</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">([</span><span class="n">input_ids_layer</span><span class="p">,</span> <span class="n">input_attention_layer</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># vamos usar apenas o [CLS] token, localizado no índice 0</span>
    <span class="n">cls_token</span> <span class="o">=</span> <span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1">## Camadas novas</span>

    <span class="c1"># camada oculta</span>
    <span class="n">hidden_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span>
                                         <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;gelu&#39;</span><span class="p">,</span>
                                         <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">weight_initializer</span><span class="p">,</span>
                                         <span class="n">bias_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)(</span><span class="n">cls_token</span><span class="p">)</span>

    <span class="c1"># camada de classificação</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
                                   <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">weight_initializer</span><span class="p">,</span>
                                   <span class="n">kernel_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">bias_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span>
                                   <span class="p">)(</span><span class="n">hidden_layer</span><span class="p">)</span>

    <span class="c1"># definição do modelo</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">([</span><span class="n">input_ids_layer</span><span class="p">,</span> <span class="n">input_attention_layer</span><span class="p">],</span> <span class="n">output</span><span class="p">)</span>

    <span class="c1"># compilação do modelo</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="treinamento-das-camadas-novas-transfer-learning">
<h2>3.2 Treinamento das camadas novas (transfer learning)<a class="headerlink" href="#treinamento-das-camadas-novas-transfer-learning" title="Permalink to this heading">#</a></h2>
<p><strong>Backbone DistilBERT congelado</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">NUM_STEPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">BATCH_SIZE</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">distilBERT</span><span class="p">)</span>

<span class="n">train_history1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_train_ids</span><span class="p">,</span> <span class="n">X_train_attention</span><span class="p">],</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">EPOCHS</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">NUM_STEPS</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/8
78/78 - 28s - loss: 0.6998 - accuracy: 0.5086 - 28s/epoch - 358ms/step
Epoch 2/8
78/78 - 20s - loss: 0.6690 - accuracy: 0.6078 - 20s/epoch - 256ms/step
Epoch 3/8
78/78 - 20s - loss: 0.6406 - accuracy: 0.6860 - 20s/epoch - 259ms/step
Epoch 4/8
78/78 - 21s - loss: 0.6147 - accuracy: 0.7103 - 21s/epoch - 265ms/step
Epoch 5/8
78/78 - 22s - loss: 0.5894 - accuracy: 0.7287 - 22s/epoch - 278ms/step
Epoch 6/8
78/78 - 21s - loss: 0.5648 - accuracy: 0.7389 - 21s/epoch - 272ms/step
Epoch 7/8
78/78 - 21s - loss: 0.5490 - accuracy: 0.7415 - 21s/epoch - 268ms/step
Epoch 8/8
78/78 - 21s - loss: 0.5383 - accuracy: 0.7508 - 21s/epoch - 273ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_test_ids</span><span class="p">,</span> <span class="n">X_test_attention</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transfer Learning&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acc.: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>157/157 [==============================] - 25s 149ms/step - loss: 0.5024 - accuracy: 0.7772
Transfer Learning
Loss: 0.5024
Acc.: 77.7
</pre></div>
</div>
</div>
</div>
</section>
<section id="fine-tuning-do-distilbert">
<h2>3.3 Fine-tuning do DistilBERT<a class="headerlink" href="#fine-tuning-do-distilbert" title="Permalink to this heading">#</a></h2>
<p><strong>descongelando camadas e abaixando learning rate</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FT_EPOCHS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">NUM_STEPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">BATCH_SIZE</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">1e-5</span>

<span class="c1"># descongelando camadas do distilBERT para permitir seu ajuste</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">distilBERT</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># recompilando modelo</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># fine-tuning</span>
<span class="n">train_history2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_train_ids</span><span class="p">,</span> <span class="n">X_train_attention</span><span class="p">],</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FT_EPOCHS</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">NUM_STEPS</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/4
78/78 - 95s - loss: 0.4365 - accuracy: 0.7933 - 95s/epoch - 1s/step
Epoch 2/4
78/78 - 60s - loss: 0.3419 - accuracy: 0.8481 - 60s/epoch - 764ms/step
Epoch 3/4
78/78 - 59s - loss: 0.2970 - accuracy: 0.8695 - 59s/epoch - 762ms/step
Epoch 4/4
78/78 - 60s - loss: 0.2447 - accuracy: 0.8985 - 60s/epoch - 765ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_test_ids</span><span class="p">,</span> <span class="n">X_test_attention</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fine Tuning&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss: </span><span class="si">{</span><span class="n">scores2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acc.: </span><span class="si">{</span><span class="n">scores2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>157/157 [==============================] - 24s 139ms/step - loss: 0.3949 - accuracy: 0.8488
Fine Tuning
Loss: 0.3949
Acc.: 84.9
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-darkred-modulo-7-auto-encoders-e-redes-geradoras-span">
<h2><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span><a class="headerlink" href="#span-style-color-darkred-modulo-7-auto-encoders-e-redes-geradoras-span" title="Permalink to this heading">#</a></h2>
<section id="id94">
<h3><span style="color:darkred">Exercícios (com soluções)</span><a class="headerlink" href="#id94" title="Permalink to this heading">#</a></h3>
</section>
</section>
<section id="id95">
<h2>Parte 1 - Exercícios Essenciais<a class="headerlink" href="#id95" title="Permalink to this heading">#</a></h2>
<section id="id96">
<h3>Exercício 1)<a class="headerlink" href="#id96" title="Permalink to this heading">#</a></h3>
<p>Auto-encoders são apropriados para tarefas de aprendizado não supervisionado, em que os dados de entrada são reconstruídos e uma representação compacta destes dados é aprendida. Em relação a esse método, qual afirmação está incorreta?</p>
<p>a) A função de custo Mean Square Error deve ser utilizada com o propósito de medir a eficiência do aprendizado da rede, em que se considera seu potencial de obter imagens com alto grau de similaridade em relação às imagens de entrada.</p>
<p>b) Podemos utilizar um auto-encoder para ser treinado com exemplos não rotulados e reaproveitar somente o Encoder para formar uma CNN com adição de novas camadas para a predição com posterior fine-tuning.</p>
<p><font color='red'>c) Auto-encoders overcomplete obtém naturalmente códigos compactos e de baixa dimensionalidade, similar a projeção PCA nos principais componentes considerando dimensionalidade menor do que a da entrada.</font></p>
<p>d) Denoising auto-encoderes são arquiteturas que podem ser utilizadas para duas tarefas simultaneamente após o seu treinamento. O primeiro deles é fornecer espaço de características que representam um conjunto de dados. O segundo propósito é funcionar como um filtro para remoção de ruídos.</p>
<p><strong>Justificativa:</strong> A única alternativa incorreta é a de que autoencoders overcomplete obtem naturalmente códigos de baixa dimensionalidade. Ao contrário, aprendem uma transformação para dimensionalidades igual ou superior à da entrada.</p>
</section>
<hr class="docutils" />
<section id="id97">
<h3>Exercício 2)<a class="headerlink" href="#id97" title="Permalink to this heading">#</a></h3>
<p>É correto afirmar sobre a principal tarefa realizada pela família de métodos do tipo Autoencoder</p>
<p>(a) Mapeia os dados de entrada em um espaço latente que melhor permita uma boa classificação dos dados de treinamento, sendo o foco principal do aprendizado aumento de acurácia<br>
<font color='red'>(b) Mapeia os dados de entrada em um espaço latente, e posteriormente aprende uma reconstrução desse espaço latente novamente no espaço de entrada, sendo o foco principal do aprendizado obter um espaço latente compacto e representativo.<br></font>
(c) Mapeia os dados de entrada no espaço de saída num problema similar à regressão, em que temos informações a priori sobre como reconstruir os dados de entrada<br>
(d) Mapeia os dados de entrada com principal objetivo de eliminar o ruído dos dados e portanto é útil para tarefas de limpeza de dados. <br></p>
<p><strong>Justificativa:</strong> (a) é incorreta pois não é possível garantir acurácia, já que esses métodos não possuem acesso a rótulos de classes. (c) é incorreta pois o método não possui informações a priori sobre como reconstruir os dados de entrada, finalmente (d) é incorreta pois o objetivo principal dos métodos autoencoder não é eliminar ruído, ainda que isso seja um efeito colateral especificamente do método denoising autoencoder, mas não de toda a família de métodos.</p>
</section>
<hr class="docutils" />
<section id="id98">
<h3>Exercício 3)<a class="headerlink" href="#id98" title="Permalink to this heading">#</a></h3>
<p>Autoencoders do tipo Overcomplete possuem dimensão latente superior a da entrada. Como garantir o aprendizado sem que haja uma cópia simples dos dados?</p>
<p>(a) Utilizando mais camadas, projetando um Autoencoder Overcomplete Profundo que permita obter uma camada latente com maior qualidade<br>
(b) Substituindo a função de custo de perda ou erro quadrático pela função de custo de entropia cruzada<br>
(d) Utilizando normalização do tipo Batch ou Layer para que os dados sejam modificados ao longo da rede neural, assim evitando que haja uma cópia direta da entrada para o código<br>
<font color='red'>(d) Impondo uma restrição na projeção do código que penalize o uso de todas as dimensões do espaço latente e privilegie projeções esparsas para uma dada instância.<br></font></p>
<p><strong>Justificativa:</strong> O aprendizado de autoencoder em geral funciona impondo uma restrição no código. No caso dos overcomplete isso funciona impondo restrições no aprendizado do código como por exemplo a de esparsidade via regularização e/ou dropout.</p>
</section>
<hr class="docutils" />
<section id="id99">
<h3>Exercício 4)<a class="headerlink" href="#id99" title="Permalink to this heading">#</a></h3>
<p>Qual a diferença da forma como os métodos Variational Autoencoder (VAE) ou Generative Adversarial Network (GAN) aprendem a gerar exemplos artificiais (X) com relação ao espaço latente (Z)?</p>
<p>a) GANs aprendem a gerar dados <span class="math notranslate nohighlight">\(x \in X\)</span> amostrando dados <span class="math notranslate nohighlight">\(z\)</span> de forma implícita, enquanto VAEs aprendem <span class="math notranslate nohighlight">\(Z\)</span> por meio de distribuiçõs de probabilidades <span class="math notranslate nohighlight">\(P(Z)\)</span>, amostrando dados <span class="math notranslate nohighlight">\(z\)</span> de <span class="math notranslate nohighlight">\(P(Z)\)</span> para gerar <span class="math notranslate nohighlight">\(x\)</span><br>
b) GANs aprendem a gerar dados <span class="math notranslate nohighlight">\(x \in X\)</span> amostrando dados <span class="math notranslate nohighlight">\(z\)</span> a partir de uma distribuição <span class="math notranslate nohighlight">\(P(Z|X)\)</span>, enquanto VAEs aprendem <span class="math notranslate nohighlight">\(Z\)</span> por meio de distribuiçõs de probabilidade explícitas<br>
c) GANs aprendem a gerar dados <span class="math notranslate nohighlight">\(x \in X\)</span> amostrando dados <span class="math notranslate nohighlight">\(z\)</span> a partir de uma distribuição <span class="math notranslate nohighlight">\(P(Z|X)\)</span>, enquanto VAEs aprendem <span class="math notranslate nohighlight">\(Z\)</span> por meio de distribuiçõs de probabilidade implícitas<br>
<font color='red'>d) GANs aprendem a gerar dados <span class="math notranslate nohighlight">\(x \in X\)</span> amostrando aleatoriamente a partir de uma distribuição arbitrária <span class="math notranslate nohighlight">\(P(Z)\)</span>, enquanto VAEs aprendem <span class="math notranslate nohighlight">\(Z\)</span> por meio de distribuiçõs de probabilidade explícitas<br></font></p>
<p><strong>Justificativa</strong>: A alternativa (a) está correta, muitas garantias teóricas que temos dos nossos otimizadores simplesmente desaparecem no cenário de 2 modelos oponentes sendo otimizados ao mesmo tempo, na verdade o mero fato dos dados de entrada do discriminador mudarem ao longo do treino já aumenta a complexidade e instabilidade do treinamento dos modelos. A alternativa (b) está errada pois a perda do VAE não é particularmente complexa ou custosa de calcular. Já na (c) enquanto a área do uso de Data Augmentation em GANs está sendo muito estudada, sabemos com certeza que não é necessário DA para otimizar GANs, e que DA demais pode piorar o treino. Por fim na letra (d) esse fato não é sozinho um grande problema para a convergência de VAEs e enquanto GANs não têm que aprender a distribuição explicitamente, elas terminam tendo que aprendê-la de maneira implícita, com o gerador tendendo a conseguir amostrar a distribuição e o discriminador tendo que aprender a diferenciar se um dado faz ou não parte daquela distribuição. Como uma nota adicional, em aprendizado por reforço alguns algoritmos ficam mais estáveis ao serem modificados para aprender uma distribuição em vez de aprender uma única saída.</p>
</section>
<hr class="docutils" />
<section id="id100">
<h3>Exercício 5)<a class="headerlink" href="#id100" title="Permalink to this heading">#</a></h3>
<p>Carregue a base de dados <code class="docutils literal notranslate"><span class="pre">smartphone_activity_dataset.csv</span></code>, que possui 6 classes, conforme abaixo. Utilizaremos os primeiros 70% exemplos como treinamento e o restante como teste.</p>
<p>Defina as sementes <code class="docutils literal notranslate"><span class="pre">seed(1)</span></code> e <code class="docutils literal notranslate"><span class="pre">set_seed(2)</span></code>. Logo após, projete e instancie um Encoder (apenas encoder, não é necessário um AE aqui) com as seguintes camadas, sendo que, após a entrada, todas terão ativação tangente hiperbólica:</p>
<ul class="simple">
<li><p>Entrada</p></li>
<li><p>Densa com metade das dimensões da entrada (use a divisão inteira //2)</p></li>
<li><p>Densa com um quarto das dimensões da entrada (use a divisão inteira //4)</p></li>
<li><p>Densa com 32 dimensões (use name=”code” nessa camada para facilitar)</p></li>
</ul>
<p>Sem realizar treinamento, passe os dados de treinamento e teste pela rede, obtendo as ativações da última camada, com 32 dimensões. Isso gera uma projeção aleatória.</p>
<p>Carregue o classificador SVC da biblioteca sklearn, e treine com parâmetros C=1, random_state=1, kernel=”linear” com as características obtidas da rede neural de treinamento, realizando a predição no teste a seguir, medindo a acurácia por meio da função score.</p>
<p>Qual foi o resultado de acurácia obtido?</p>
<p>(a) Acurácia de um classificador aleatório<br>
(b) Acurácia abaixo de 5%<br>
(c) Acurácia no intervalo entre 45% e 65%<br>
<font color='red'>(d) Acurácia acima de 75%<br></font></p>
<p><strong>Justificativa</strong>: ver código abaixo. Como as características de entrada são bem discriminativas, ao projetá-las de forma aleatória com as camadas densas, ainda mantemos esse poder discriminativo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;smartphone_activity_dataset.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-30d5334b-cfdd-45a9-99c7-257cad85dbda" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature_1</th>
      <th>feature_2</th>
      <th>feature_3</th>
      <th>feature_4</th>
      <th>feature_5</th>
      <th>feature_6</th>
      <th>feature_7</th>
      <th>feature_8</th>
      <th>feature_9</th>
      <th>feature_10</th>
      <th>...</th>
      <th>feature_553</th>
      <th>feature_554</th>
      <th>feature_555</th>
      <th>feature_556</th>
      <th>feature_557</th>
      <th>feature_558</th>
      <th>feature_559</th>
      <th>feature_560</th>
      <th>feature_561</th>
      <th>activity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.289</td>
      <td>-0.0203</td>
      <td>-0.1330</td>
      <td>-0.995</td>
      <td>-0.9830</td>
      <td>-0.914</td>
      <td>-0.995</td>
      <td>-0.983</td>
      <td>-0.924</td>
      <td>-0.93500</td>
      <td>...</td>
      <td>-0.2990</td>
      <td>-0.710</td>
      <td>-0.1130</td>
      <td>0.03040</td>
      <td>-0.465</td>
      <td>-0.0184</td>
      <td>-0.841</td>
      <td>0.180</td>
      <td>-0.0586</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.278</td>
      <td>-0.0164</td>
      <td>-0.1240</td>
      <td>-0.998</td>
      <td>-0.9750</td>
      <td>-0.960</td>
      <td>-0.999</td>
      <td>-0.975</td>
      <td>-0.958</td>
      <td>-0.94300</td>
      <td>...</td>
      <td>-0.5950</td>
      <td>-0.861</td>
      <td>0.0535</td>
      <td>-0.00743</td>
      <td>-0.733</td>
      <td>0.7040</td>
      <td>-0.845</td>
      <td>0.180</td>
      <td>-0.0543</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.280</td>
      <td>-0.0195</td>
      <td>-0.1130</td>
      <td>-0.995</td>
      <td>-0.9670</td>
      <td>-0.979</td>
      <td>-0.997</td>
      <td>-0.964</td>
      <td>-0.977</td>
      <td>-0.93900</td>
      <td>...</td>
      <td>-0.3910</td>
      <td>-0.760</td>
      <td>-0.1190</td>
      <td>0.17800</td>
      <td>0.101</td>
      <td>0.8090</td>
      <td>-0.849</td>
      <td>0.181</td>
      <td>-0.0491</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.279</td>
      <td>-0.0262</td>
      <td>-0.1230</td>
      <td>-0.996</td>
      <td>-0.9830</td>
      <td>-0.991</td>
      <td>-0.997</td>
      <td>-0.983</td>
      <td>-0.989</td>
      <td>-0.93900</td>
      <td>...</td>
      <td>-0.1170</td>
      <td>-0.483</td>
      <td>-0.0368</td>
      <td>-0.01290</td>
      <td>0.640</td>
      <td>-0.4850</td>
      <td>-0.849</td>
      <td>0.182</td>
      <td>-0.0477</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.277</td>
      <td>-0.0166</td>
      <td>-0.1150</td>
      <td>-0.998</td>
      <td>-0.9810</td>
      <td>-0.990</td>
      <td>-0.998</td>
      <td>-0.980</td>
      <td>-0.990</td>
      <td>-0.94200</td>
      <td>...</td>
      <td>-0.3510</td>
      <td>-0.699</td>
      <td>0.1230</td>
      <td>0.12300</td>
      <td>0.694</td>
      <td>-0.6160</td>
      <td>-0.848</td>
      <td>0.185</td>
      <td>-0.0439</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10294</th>
      <td>0.310</td>
      <td>-0.0534</td>
      <td>-0.0991</td>
      <td>-0.288</td>
      <td>-0.1410</td>
      <td>-0.215</td>
      <td>-0.356</td>
      <td>-0.149</td>
      <td>-0.232</td>
      <td>0.18500</td>
      <td>...</td>
      <td>-0.3760</td>
      <td>-0.751</td>
      <td>-0.3370</td>
      <td>0.34600</td>
      <td>0.885</td>
      <td>-0.6990</td>
      <td>-0.652</td>
      <td>0.275</td>
      <td>0.1850</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10295</th>
      <td>0.363</td>
      <td>-0.0392</td>
      <td>-0.1060</td>
      <td>-0.305</td>
      <td>0.0281</td>
      <td>-0.196</td>
      <td>-0.374</td>
      <td>-0.030</td>
      <td>-0.270</td>
      <td>0.18500</td>
      <td>...</td>
      <td>-0.3200</td>
      <td>-0.700</td>
      <td>-0.7370</td>
      <td>-0.37300</td>
      <td>-0.657</td>
      <td>0.3230</td>
      <td>-0.655</td>
      <td>0.274</td>
      <td>0.1820</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10296</th>
      <td>0.350</td>
      <td>0.0301</td>
      <td>-0.1160</td>
      <td>-0.330</td>
      <td>-0.0421</td>
      <td>-0.250</td>
      <td>-0.388</td>
      <td>-0.133</td>
      <td>-0.347</td>
      <td>0.00747</td>
      <td>...</td>
      <td>-0.1190</td>
      <td>-0.467</td>
      <td>-0.1820</td>
      <td>0.08860</td>
      <td>0.697</td>
      <td>0.3630</td>
      <td>-0.655</td>
      <td>0.274</td>
      <td>0.1810</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10297</th>
      <td>0.238</td>
      <td>0.0185</td>
      <td>-0.0965</td>
      <td>-0.323</td>
      <td>-0.2300</td>
      <td>-0.208</td>
      <td>-0.392</td>
      <td>-0.280</td>
      <td>-0.289</td>
      <td>0.00747</td>
      <td>...</td>
      <td>-0.2050</td>
      <td>-0.618</td>
      <td>0.4450</td>
      <td>-0.81900</td>
      <td>0.929</td>
      <td>-0.0084</td>
      <td>-0.660</td>
      <td>0.265</td>
      <td>0.1880</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10298</th>
      <td>0.154</td>
      <td>-0.0184</td>
      <td>-0.1370</td>
      <td>-0.330</td>
      <td>-0.1950</td>
      <td>-0.164</td>
      <td>-0.431</td>
      <td>-0.218</td>
      <td>-0.230</td>
      <td>-0.11200</td>
      <td>...</td>
      <td>-0.0722</td>
      <td>-0.437</td>
      <td>0.5990</td>
      <td>-0.28800</td>
      <td>0.876</td>
      <td>-0.0250</td>
      <td>-0.660</td>
      <td>0.264</td>
      <td>0.1880</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>10299 rows × 562 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-30d5334b-cfdd-45a9-99c7-257cad85dbda')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-30d5334b-cfdd-45a9-99c7-257cad85dbda button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-30d5334b-cfdd-45a9-99c7-257cad85dbda');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-2f90062b-397e-428a-be58-8f0665619e2d">
  <button class="colab-df-quickchart" onclick="quickchart('df-2f90062b-397e-428a-be58-8f0665619e2d')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-2f90062b-397e-428a-be58-8f0665619e2d button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rotulos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">])</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">rotulos</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de treinamento:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de teste:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de treinamento: 7209
Exemplos de teste: 3090
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">deep_encoder</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">code_dim</span><span class="p">):</span>

    <span class="n">input_data</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">code_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">encoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_dim</span> <span class="o">=</span> <span class="mi">32</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">autoencoder_1</span> <span class="o">=</span> <span class="n">deep_encoder</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">code_dim</span><span class="o">=</span><span class="n">code_dim</span><span class="p">)</span>
<span class="n">autoencoder_1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">code_modelenc</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder_1</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder_1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">code_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_modelenc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span>

<span class="n">clf2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">code_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">code_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_modelenc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculando score...&#39;</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">clf2</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">code_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score: </span><span class="si">%.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">))</span>

<span class="n">disp</span> <span class="o">=</span>  <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">clf2</span><span class="p">,</span> <span class="n">code_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, 561)]             0         
                                                                 
 dense (Dense)               (None, 280)               157360    
                                                                 
 dense_1 (Dense)             (None, 140)               39340     
                                                                 
 code (Dense)                (None, 32)                4512      
                                                                 
=================================================================
Total params: 201212 (785.98 KB)
Trainable params: 201212 (785.98 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
226/226 [==============================] - 3s 5ms/step
97/97 [==============================] - 0s 4ms/step
Calculando score...

score: 0.88 
</pre></div>
</div>
<img alt="../_images/172fa5b54abf857501a7a1d3b77e27a39fef085934a53489d2e6d32599264bb1.png" src="../_images/172fa5b54abf857501a7a1d3b77e27a39fef085934a53489d2e6d32599264bb1.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="id101">
<h3>Exercício 6)<a class="headerlink" href="#id101" title="Permalink to this heading">#</a></h3>
<p>Interpolação utilizando código autoencoder.</p>
<p>Crie um Autoencoder profundo do tipo Denoising Undercomplete para imagens da base de dados MNIST.</p>
<p>Para tornar o treinamento mais rápido utilizaremos apenas as 3000 primeiras imagens da base de dados de treinamento. Crie uma versão ruidosa do conjunto de treinamento conforme indicado no código.</p>
<p>O Autoencoder deve possuir a seguinte arquitetura no encoder (todas as camadas com ativação relu):</p>
<ul class="simple">
<li><p>Conv2D com 32 filtros 3x3, strides 2, zeropadding</p></li>
<li><p>Conv2D com 32 filtros 3x3, strides 2, sem zeropadding</p></li>
<li><p>MaxPooling2D com poolsize=2</p></li>
<li><p>Densa com 32 dimensões (utilize name=’code’ para facilitar)</p></li>
</ul>
<p>A seguir, deve possuir um decoder espelhado (com convoluções transpostas e upsampling), resultando na saida de mesma dimensão da entrada.</p>
<p>Antes de instanciar o modelo, inicialize as sementes com seed(1), set_seed(2). Depois, compile e treine com perda MSE, Otimizador SGD, taxa 0.01, momentum 0.95, por 25 épocas com batchsize 32.</p>
<p>Vamos agora obter interpolações de imagens utilizando os seus códigos. Para isso crie dois modelos, com base no treinado:</p>
<ol class="arabic simple">
<li><p>Encoder, que permite recuperar o código de uma imagem (camada ‘code’)</p></li>
<li><p>Decoder, que permite receber um código e retornar uma imagem</p></li>
</ol>
<p>O segundo pode ser feito de formas distintas:</p>
<ul class="simple">
<li><p>pegando o <code class="docutils literal notranslate"><span class="pre">input</span></code> da primeira camada do decoder, desde que esteja nomeada
ex: <code class="docutils literal notranslate"><span class="pre">keras.models.Model(inputs=modelo.get_layer('camada').input,</span> <span class="pre">outputs=modelo.output)</span></code></p></li>
<li><p>ou feita a montagem das camadas utilizando a seguinte instrução (estude com calma para entender):</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## cria nova camada de entrada para receber dimensionalidade do código</span>
<span class="c1">#input_code_layer = keras.layers.Input(shape=(code_dim))</span>

<span class="c1">## encadeia camadas a partir de &#39;inicio&#39;, nesse caso 6 - ajuste conforme necessário</span>
<span class="c1">#inicio = 6</span>
<span class="c1">#x = input_code_layer</span>
<span class="c1">#for layer in convae.layers[inicio:]:</span>
<span class="c1">#    x = layer(x)</span>

<span class="c1">#decoder = keras.models.Model(inputs=input_code_layer, outputs=x)</span>
</pre></div>
</div>
</div>
</div>
<p>Obtenha as imagens de teste de índice 128 e 198, e então:</p>
<ol class="arabic simple">
<li><p>calcule seus códigos pelo encoder: code128 e code198;</p></li>
<li><p>gere interpolações 10 lineares entre code128 e code198 combinando linearmente cada dimensão do vetor com ponderações entre 0 (que resulta apenas na imagem 128) e 1 (que resulta apenas na imagem 198);</p></li>
<li><p>passe cada vetor interpolado pelo decoder, obtendo imagens intermediárias;</p></li>
</ol>
<p>OBS: os modelos esperam arrays em formatos específicos para predição, para passar uma única imagem use <code class="docutils literal notranslate"><span class="pre">model.predict(np.array([x_test[indice_imagem],]))</span></code></p>
<p>Quais das imagens abaixo representa a saída da interpolação?</p>
<p>(a) <img src="ex7_6_alternativa_a.png" width=620></img><br>
(b) <img src="ex7_6_alternativa_b.png" width=620></img><br>
<font color='red'>(c)</font> <img src="ex7_6_alternativa_c.png" width=620></img><br>
(d) <img src="ex7_6_alternativa_d.png" width=620></img><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># os pixels das imagens sao reescalados para melhor processamento</span>
<span class="c1"># em particular divide-se por 255 para que os valores fiquem entre 0 e 1</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset size:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;train samples&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;test samples&#39;</span><span class="p">)</span>

<span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
<span class="n">n_classes</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">n</span><span class="o">=</span><span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">## gerando dados ruidosos a serem oferecidos na entrada (a saída deve ser x_train[:3000])</span>
<span class="n">noisy_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">3000</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:</span><span class="mi">3000</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mf">0.3</span>

<span class="n">n</span><span class="o">=</span><span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noisy_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset size:
60000 train samples
10000 test samples
</pre></div>
</div>
<img alt="../_images/51e5c07757ae706ffc80755b33d1f737957f1506d869edb2aa253d8dd7e1d056.png" src="../_images/51e5c07757ae706ffc80755b33d1f737957f1506d869edb2aa253d8dd7e1d056.png" />
<img alt="../_images/a763990190d38946aff5200b70ca4073f3fa00829905a5a872209c8942cebca3.png" src="../_images/a763990190d38946aff5200b70ca4073f3fa00829905a5a872209c8942cebca3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">conv_autoencoder</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">code_dim</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">input_img</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">))</span>

    <span class="c1"># encoder</span>
    <span class="c1">## conv.layers</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_img</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2p</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x2</span><span class="p">)</span>
    <span class="c1">## achatando</span>
    <span class="n">x2f</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x2p</span><span class="p">)</span>
    <span class="c1">#código</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">code_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">x2f</span><span class="p">)</span>

    <span class="c1"># decoder</span>
    <span class="c1">## projetando num espaco de maior dimensionalidade e redimensionando</span>
    <span class="n">x2f_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1152</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_decoder&#39;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x2r_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">32</span><span class="p">))(</span><span class="n">x2f_hat</span><span class="p">)</span>
    <span class="c1">## invertendo o pooling</span>
    <span class="n">x2p_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x2r_hat</span><span class="p">)</span>
    <span class="c1">## convolucao transpostas (inversas)</span>
    <span class="n">x2_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x2p_hat</span><span class="p">)</span>
    <span class="n">x1_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x2_hat</span><span class="p">)</span>

    <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">x1_hat</span><span class="p">)</span>
    <span class="n">autoencoder</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">autoencoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span><span class="o">=</span> <span class="mi">25</span>
<span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="n">code_dim</span><span class="o">=</span> <span class="mi">32</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">convae</span> <span class="o">=</span> <span class="n">conv_autoencoder</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">code_dim</span><span class="p">)</span>
<span class="n">convae</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.95</span><span class="p">))</span>

<span class="n">hist_ae</span> <span class="o">=</span> <span class="n">convae</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">noisy_train</span><span class="p">,</span> <span class="n">x_train</span><span class="p">[:</span><span class="mi">3000</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_2 (InputLayer)        [(None, 28, 28, 1)]       0         
                                                                 
 conv2d (Conv2D)             (None, 14, 14, 32)        320       
                                                                 
 conv2d_1 (Conv2D)           (None, 12, 12, 32)        9248      
                                                                 
 max_pooling2d (MaxPooling2  (None, 6, 6, 32)          0         
 D)                                                              
                                                                 
 flatten (Flatten)           (None, 1152)              0         
                                                                 
 code (Dense)                (None, 32)                36896     
                                                                 
 input_decoder (Dense)       (None, 1152)              38016     
                                                                 
 reshape (Reshape)           (None, 6, 6, 32)          0         
                                                                 
 up_sampling2d (UpSampling2  (None, 12, 12, 32)        0         
 D)                                                              
                                                                 
 conv2d_transpose (Conv2DTr  (None, 14, 14, 32)        9248      
 anspose)                                                        
                                                                 
 conv2d_transpose_1 (Conv2D  (None, 28, 28, 1)         289       
 Transpose)                                                      
                                                                 
=================================================================
Total params: 94017 (367.25 KB)
Trainable params: 94017 (367.25 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
Epoch 1/25
94/94 [==============================] - 8s 7ms/step - loss: 0.0970
Epoch 2/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0929
Epoch 3/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0814
Epoch 4/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0659
Epoch 5/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0639
Epoch 6/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0628
Epoch 7/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0617
Epoch 8/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0601
Epoch 9/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0572
Epoch 10/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0527
Epoch 11/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0486
Epoch 12/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0453
Epoch 13/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0422
Epoch 14/25
94/94 [==============================] - 1s 7ms/step - loss: 0.0395
Epoch 15/25
94/94 [==============================] - 1s 7ms/step - loss: 0.0372
Epoch 16/25
94/94 [==============================] - 1s 7ms/step - loss: 0.0353
Epoch 17/25
94/94 [==============================] - 1s 6ms/step - loss: 0.0337
Epoch 18/25
94/94 [==============================] - 1s 6ms/step - loss: 0.0323
Epoch 19/25
94/94 [==============================] - 1s 6ms/step - loss: 0.0310
Epoch 20/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0299
Epoch 21/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0290
Epoch 22/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0281
Epoch 23/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0273
Epoch 24/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0267
Epoch 25/25
94/94 [==============================] - 0s 5ms/step - loss: 0.0261
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">convae</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">convae</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_code_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">code_dim</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">input_code_layer</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">convae</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_code_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img1</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">x_test_dec1</span> <span class="o">=</span> <span class="n">convae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_test</span><span class="p">[</span><span class="n">img1</span><span class="p">],]))</span>
<span class="n">img2</span> <span class="o">=</span> <span class="mi">198</span>
<span class="n">x_test_dec2</span> <span class="o">=</span> <span class="n">convae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_test</span><span class="p">[</span><span class="n">img2</span><span class="p">],]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">img1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test_dec1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">img2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test_dec2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">code_img1</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_test</span><span class="p">[</span><span class="n">img1</span><span class="p">],]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">code_img2</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_test</span><span class="p">[</span><span class="n">img2</span><span class="p">],]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code_img1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">code_img2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 189ms/step
1/1 [==============================] - 0s 17ms/step
</pre></div>
</div>
<img alt="../_images/f58c143722ecd09db30d877bdebe94b3dc61ffa8f587385f5302613407177b9d.png" src="../_images/f58c143722ecd09db30d877bdebe94b3dc61ffa8f587385f5302613407177b9d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 54ms/step
1/1 [==============================] - 0s 16ms/step
[0.         2.3220105  5.1895194  0.4804806  1.9626539  0.
 0.02358731 0.48622996 0.         1.5874826  3.2502344  0.53344774
 1.2369108  0.         0.         1.0387987  0.6137252  0.
 1.7129406  3.1968465  0.66188353 0.         0.         0.
 1.7708288  3.055439   3.4412606  1.1560148  0.92297864 0.7041049
 1.7045676  0.        ]
[0.         1.4370214  4.0565705  0.08960172 0.89008677 0.
 0.         0.5812293  0.         1.8392336  1.7945033  0.
 2.0300841  0.         0.         0.35933727 0.64194244 0.
 1.1470132  0.69930786 0.         0.         0.         0.
 0.798034   2.5386863  1.6609128  0.8022421  0.06090127 1.2777855
 1.0896007  0.        ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">alt_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">code_img1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alt_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">alt_code</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="o">+</span> <span class="p">(</span><span class="n">code_img2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="n">alt_img</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alt_code</span><span class="p">,]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># a depender da forma como foi implementado talvez necessite inserir dimensao 0</span>
    <span class="c1">#plt.imshow(alt_img[0][:,:,0], cmap=&quot;gray&quot;); plt.axis(&#39;off&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">alt_img</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 81ms/step
1/1 [==============================] - 0s 16ms/step
1/1 [==============================] - 0s 16ms/step
1/1 [==============================] - 0s 19ms/step
1/1 [==============================] - 0s 17ms/step
1/1 [==============================] - 0s 27ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 17ms/step
1/1 [==============================] - 0s 16ms/step
1/1 [==============================] - 0s 17ms/step
</pre></div>
</div>
<img alt="../_images/863d4b112211c056fef53b51c3eaa9c2d17496a2ea3e009ef464df829d8f6c4e.png" src="../_images/863d4b112211c056fef53b51c3eaa9c2d17496a2ea3e009ef464df829d8f6c4e.png" />
</div>
</div>
</section>
<section id="parte-2-exercicios-complementares">
<h3>Parte 2 - Exercícios complementares<a class="headerlink" href="#parte-2-exercicios-complementares" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id102">
<h3>Exercício 8)<a class="headerlink" href="#id102" title="Permalink to this heading">#</a></h3>
<p>Uso de GANs para aprendizado de representações. Utilizando a mesma base de dados do exercício anterior, projete e treine uma GAN para gerar exemplos artificiais da base de dados <code class="docutils literal notranslate"><span class="pre">smartphone_activity_dataset.csv</span></code>. Utilizaremos todos os exemplos para treinamento da GAN.</p>
<p>Para isso, utilize a GAN similar à proposta em aula, alterada conforme o código abaixo, com as seguintes configurações:</p>
<ul class="simple">
<li><p>discriminador com uma camada oculta com 32 dimensões (utilize o parâmetro <code class="docutils literal notranslate"><span class="pre">name='embedding'</span></code> nessa camada para facilitar seu uso posterior), deve ser treinado com Adam e taxa de aprendizado 0.0001 (apenas para o discriminador)</p></li>
<li><p>gerador com 2 camadas ocultas com 256 neurônios</p></li>
<li><p>dimensão de z = 256</p></li>
<li><p>dimensão de entrada igual a da base de dados</p></li>
<li><p>função de distribuição alvo deve amostrar da base de dados</p></li>
</ul>
<p>Todas as camadas serão <code class="docutils literal notranslate"><span class="pre">tanh</span></code> exceto a camada de saída do discriminador que é <code class="docutils literal notranslate"><span class="pre">sigmoid</span></code>.</p>
<p>Treine a GAN por 1000 épocas com batch size 32 e otimizador Adam com lr=0.001.</p>
<p>Após, utilize a camada “embedding” do discriminador como extratora de características, passando os dados da base de treinamento e teste (na mesma divisão feita na questão anterior) para o discriminador, e pegando a projeção feita pela camada densa.</p>
<p>Treine classificadores SVM com parâmetros C=1, kernel=”linear” e random_state=1, um na base de dados com suas características originais, e o outro nas característias do “embedding” do discriminador. Obtenha o score nos respectivos conjuntos de teste. Os resultados estão em qual intervalo?</p>
<p>(a) Original = [80,100], Embedding 32d GAN = [50,75], a GAN não foi capaz de aprender uma representação compacta com acurácia similar ao uso dos dados originais<br>
(b) Original = [50,75], Embedding 32d GAN = [80,100], a GAN produz representação melhor que dados originais<br>
(c) Original = [50,75], Embedding 32d GAN = [50,75], a GAN gera uma representação compacta com resultado similar, porém ambas geram resultados baixos de acurácia<br>
<font color='red'>(d)  Original = [80,100], Embedding 32d GAN = [80,100], a GAN gera uma representação compacta com resultado similar, porém de forma absoluta inferior ao uso da base original<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;smartphone_activity_dataset.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">rotulos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">])</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">rotulos</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de treinamento:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de teste:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exemplos de treinamento: 7209
Exemplos de teste: 3090
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># modelo discriminador base : classificador</span>
<span class="k">def</span> <span class="nf">discriminator</span><span class="p">(</span><span class="n">dim_input</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">embedding_size</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embedding_size</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;embedding&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">dim_input</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">distribuicao_alvo</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x_train</span><span class="p">):</span>
    <span class="n">labels_reais</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x_train</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="p">:],</span> <span class="n">labels_reais</span>

<span class="c1"># modelo gerador, cuja entrada tem dimensão do espaço latente</span>
<span class="c1"># sua saída tem dimensão igual a dos exemplos da distribuição alvo</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">dim_output</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">embedding_size1</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">embedding_size2</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embedding_size1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;embedding1&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">z_dim</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embedding_size2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;embedding2&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">dim_output</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># funcao para gerar uma amostra com n exemplos da distribuicao latente</span>
<span class="k">def</span> <span class="nf">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">exemplos_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">z_dim</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exemplos_z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">)</span>

<span class="c1"># funcao para gerar exemplos &quot;falsos&quot;, aleatorios a partir da</span>
<span class="c1"># saída do gerador G(z)</span>
<span class="k">def</span> <span class="nf">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_g</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">exemplos_z</span> <span class="o">=</span> <span class="n">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">exemplos_falsos</span> <span class="o">=</span> <span class="n">model_g</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">exemplos_z</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">labels_falsos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">exemplos_falsos</span><span class="p">,</span> <span class="n">labels_falsos</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">):</span>
    <span class="c1"># o discriminador sera treinado separadamente, entao marcamos como</span>
    <span class="c1"># nao treinável dentro desse modelo</span>
    <span class="n">model_dis</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># criamos modelo que gera exemplos, depois os passa ao discriminador</span>
    <span class="n">model_gan</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_gen</span><span class="p">)</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_dis</span><span class="p">)</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model_gan</span>

<span class="k">def</span> <span class="nf">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">histR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="n">histF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="c1"># amostra exemplos para o discriminador</span>
        <span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">x_train</span><span class="p">)</span>
        <span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># treina modelo em meio batch</span>
        <span class="n">model_dis</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span>
        <span class="n">model_dis</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">)</span>

        <span class="c1"># exemplos da distribuicao latente</span>
        <span class="n">z_batch</span> <span class="o">=</span> <span class="n">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># invertemos os labels aqui para treinar de forma a enganar o discriminador</span>
        <span class="n">z_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">model_GAN</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">z_batch</span><span class="p">,</span> <span class="n">z_labels</span><span class="p">)</span>

        <span class="c1"># avalia modelo discriminador atual</span>
        <span class="n">loss_real</span><span class="p">,</span> <span class="n">acc_real</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_falso</span><span class="p">,</span> <span class="n">acc_falso</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">histR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_real</span>
        <span class="n">histF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_falso</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">%d</span><span class="s2">, Accuracy- real: </span><span class="si">%.2f</span><span class="s2"> falso: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc_real</span><span class="p">,</span> <span class="n">acc_falso</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">histR</span><span class="p">,</span> <span class="n">histF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">z_dim</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">model_dis</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">model_gen</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embedding_size1</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">embedding_size2</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

<span class="n">model_GAN</span> <span class="o">=</span> <span class="n">GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">)</span>

<span class="n">histR</span><span class="p">,</span> <span class="n">histF</span> <span class="o">=</span> <span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0, Accuracy- real: 0.88 falso: 0.38
Epoch: 100, Accuracy- real: 1.00 falso: 0.00
Epoch: 200, Accuracy- real: 1.00 falso: 0.25
Epoch: 300, Accuracy- real: 1.00 falso: 0.06
Epoch: 400, Accuracy- real: 1.00 falso: 0.50
Epoch: 500, Accuracy- real: 1.00 falso: 0.31
Epoch: 600, Accuracy- real: 1.00 falso: 0.75
Epoch: 700, Accuracy- real: 1.00 falso: 0.56
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_GAN</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model_dis</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">model_dis</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;embedding&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">code_trainGAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_GAN</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
<span class="n">code_testGAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_GAN</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>226/226 [==============================] - 0s 1ms/step
97/97 [==============================] - 0s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">code_trainGAN</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculando score embedding GAN...&#39;</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">code_testGAN</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">))</span>

<span class="c1"># Make predictions on the testing set</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">code_testGAN</span><span class="p">)</span>

<span class="c1"># Generate the confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="c1"># Plotting the confusion matrix using seaborn</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - GAN&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculando score embedding GAN...

score: 0.84
</pre></div>
</div>
<img alt="../_images/dc256945d317c22747a926f66ccec6c58b1fff5b8315027c199e181ba16f9a21.png" src="../_images/dc256945d317c22747a926f66ccec6c58b1fff5b8315027c199e181ba16f9a21.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_orig</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="n">clf_orig</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculando score dados originais...&#39;</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">clf_orig</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>

<span class="n">y_pred_orig</span> <span class="o">=</span> <span class="n">clf_orig</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

<span class="c1"># Generate the confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_orig</span><span class="p">)</span>

<span class="c1"># Plotting the confusion matrix using seaborn</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - Dataset Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculando score dados originais...

score: 0.9883495145631068
</pre></div>
</div>
<img alt="../_images/d8fcdd2322121c2d9c25dd34f3f847df9b440dc95afd8938598f229b4c2112b6.png" src="../_images/d8fcdd2322121c2d9c25dd34f3f847df9b440dc95afd8938598f229b4c2112b6.png" />
</div>
</div>
</section>
</section>
<section id="span-style-color-darkred-modulo-7-auto-encodes-e-redes-geradoras-span">
<h2><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span><a class="headerlink" href="#span-style-color-darkred-modulo-7-auto-encodes-e-redes-geradoras-span" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-1-autoencoders-para-aprendizado-de-representacoes-span">
<h3><span style="color:darkred"><strong>Parte 1: Autoencoders para Aprendizado de Representações</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-1-autoencoders-para-aprendizado-de-representacoes-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">fashion_mnist</span>
</pre></div>
</div>
</div>
</div>
<p>Carregando a base de dados “Fashion MNIST”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-labels-idx1-ubyte.gz
29515/29515 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-images-idx3-ubyte.gz
26421880/26421880 [==============================] - 1s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-labels-idx1-ubyte.gz
5148/5148 [==============================] - 0s 0us/step
Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-images-idx3-ubyte.gz
4422102/4422102 [==============================] - 1s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># os pixels das imagens sao reescalados para melhor processamento</span>
<span class="c1"># em particular divide-se por 255 para que os valores fiquem entre 0 e 1</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset size:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;train samples&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;test samples&#39;</span><span class="p">)</span>

<span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
<span class="n">n_classes</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset size:
60000 train samples
10000 test samples
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="autoencoder-convolucional">
<h3>Autoencoder convolucional<a class="headerlink" href="#autoencoder-convolucional" title="Permalink to this heading">#</a></h3>
<p>Projetaremos de forma que Encoder e Decoder sejam simétricos</p>
<p>Escolhemos a dimensionalidade latente como sendo 256</p>
<p>Note que após o código, buscamos inverter as operações do encoder:</p>
<ul class="simple">
<li><p>camada de projeção para maior dimensiondlidade</p></li>
<li><p>reshape para o formato de feature maps</p></li>
<li><p>upsampling (inverso de pooling)</p></li>
<li><p>convoluções transpostas farão o papel de inversão</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_img</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">))</span>

<span class="c1"># encoder</span>
<span class="c1">## conv.layers</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_img</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x1</span><span class="p">)</span>
<span class="n">x2p</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x2</span><span class="p">)</span>
<span class="c1">## achatando</span>
<span class="n">x2f</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x2p</span><span class="p">)</span>
<span class="n">x2f</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x2f</span><span class="p">)</span>
<span class="c1">#código</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">x2f</span><span class="p">)</span>

<span class="c1"># decoder</span>
<span class="c1">## projetando num espaco de maior dimensionalidade e redimensionando</span>
<span class="n">x2f_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">576</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
<span class="n">x2r_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">))(</span><span class="n">x2f_hat</span><span class="p">)</span>
<span class="c1">## invertendo o pooling</span>
<span class="n">x2p_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">x2r_hat</span><span class="p">)</span>
<span class="c1">## convolucao transpostas (inversas)</span>
<span class="n">x2_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x2p_hat</span><span class="p">)</span>
<span class="n">x1_hat</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x2_hat</span><span class="p">)</span>

<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">x1_hat</span><span class="p">)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_4&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_6 (InputLayer)        [(None, 28, 28, 1)]       0         
                                                                 
 conv2d_10 (Conv2D)          (None, 14, 14, 32)        320       
                                                                 
 conv2d_11 (Conv2D)          (None, 12, 12, 16)        4624      
                                                                 
 max_pooling2d_5 (MaxPoolin  (None, 6, 6, 16)          0         
 g2D)                                                            
                                                                 
 flatten_5 (Flatten)         (None, 576)               0         
                                                                 
 dropout_5 (Dropout)         (None, 576)               0         
                                                                 
 code (Dense)                (None, 256)               147712    
                                                                 
 dense_8 (Dense)             (None, 576)               148032    
                                                                 
 reshape_3 (Reshape)         (None, 6, 6, 16)          0         
                                                                 
 up_sampling2d_2 (UpSamplin  (None, 12, 12, 16)        0         
 g2D)                                                            
                                                                 
 conv2d_transpose_4 (Conv2D  (None, 14, 14, 32)        4640      
 Transpose)                                                      
                                                                 
 conv2d_transpose_5 (Conv2D  (None, 28, 28, 1)         289       
 Transpose)                                                      
                                                                 
=================================================================
Total params: 305617 (1.17 MB)
Trainable params: 305617 (1.17 MB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="treinando-o-autoencoder">
<h3>Treinando o autoencoder<a class="headerlink" href="#treinando-o-autoencoder" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                             <span class="n">momentum</span><span class="o">=</span><span class="mf">0.95</span><span class="p">))</span>

<span class="n">hist_ae</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                          <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
1875/1875 [==============================] - 12s 6ms/step - loss: 0.0449
Epoch 2/20
1875/1875 [==============================] - 11s 6ms/step - loss: 0.0290
Epoch 3/20
1875/1875 [==============================] - 8s 4ms/step - loss: 0.0251
Epoch 4/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0229
Epoch 5/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0215
Epoch 6/20
1875/1875 [==============================] - 8s 4ms/step - loss: 0.0205
Epoch 7/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0198
Epoch 8/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0192
Epoch 9/20
1875/1875 [==============================] - 8s 5ms/step - loss: 0.0187
Epoch 10/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0183
Epoch 11/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0179
Epoch 12/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0176
Epoch 13/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0173
Epoch 14/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0171
Epoch 15/20
1875/1875 [==============================] - 10s 5ms/step - loss: 0.0168
Epoch 16/20
1875/1875 [==============================] - 11s 6ms/step - loss: 0.0166
Epoch 17/20
1875/1875 [==============================] - 9s 5ms/step - loss: 0.0164
Epoch 18/20
1875/1875 [==============================] - 10s 5ms/step - loss: 0.0162
Epoch 19/20
1875/1875 [==============================] - 10s 5ms/step - loss: 0.0160
Epoch 20/20
1875/1875 [==============================] - 10s 5ms/step - loss: 0.0159
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># obtem as reconstrucoes para o conjunto de teste</span>
<span class="n">decoded_imgs</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="o">=</span><span class="mi">15</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># display reconstruction</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decoded_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8fffa5eb23c299ff62ad32ca53ed9f4f9ee30a208d63f15690f8617c0f599e96.png" src="../_images/8fffa5eb23c299ff62ad32ca53ed9f4f9ee30a208d63f15690f8617c0f599e96.png" />
</div>
</div>
<hr class="docutils" />
<p>Supondo um cenário em que tenhamos muitos exemplos não rotulados:</p>
<ul class="simple">
<li><p>aprendemos as características de forma não supervisionada</p></li>
<li><p>utilizamos as características treinando um classificador externo com poucos exemplos rotulados</p></li>
</ul>
<p>Para isso, fazemos com que a saída seja a camada do código, e obtemos as predições para o treinamento e o teste</p>
<p>Aqui vamos supor um subconjunto pequeno de dados rotulados</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># quantidade de dados rotulados</span>
<span class="n">n_treinamento</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">code_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                                <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">code_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:</span><span class="n">n_treinamento</span><span class="p">]))</span>
<span class="n">code_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training data size = &quot;</span><span class="p">,</span> <span class="n">code_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing data size = &quot;</span><span class="p">,</span> <span class="n">code_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16/16 [==============================] - 0s 9ms/step
313/313 [==============================] - 1s 3ms/step
Training data size =  (500, 256)
Testing data size =  (10000, 256)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Treinando SVM com ~</span><span class="si">%d</span><span class="s1"> exemplos por classe...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_treinamento</span><span class="o">//</span><span class="n">n_classes</span><span class="p">))</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">code_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">n_treinamento</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treinando SVM com ~50 exemplos por classe...
</pre></div>
</div>
<div class="output text_html"><style>#sk-container-id-3 {color: black;background-color: white;}#sk-container-id-3 pre{padding: 0;}#sk-container-id-3 div.sk-toggleable {background-color: white;}#sk-container-id-3 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-3 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-3 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-3 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-3 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-3 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-3 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-3 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-3 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-3 div.sk-item {position: relative;z-index: 1;}#sk-container-id-3 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-3 div.sk-item::before, #sk-container-id-3 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-3 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-3 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-3 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-3 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-3 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-3 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-3 div.sk-label-container {text-align: center;}#sk-container-id-3 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-3 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>SVC(C=10)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" checked><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">SVC</label><div class="sk-toggleable__content"><pre>SVC(C=10)</pre></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculando score...&#39;</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">code_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculando score...

score: 0.7869
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id103">
<h2><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span><a class="headerlink" href="#id103" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-2-autoencoders-para-reducao-de-dimensionalidade-span">
<h3><span style="color:darkred"><strong>Parte 2: Autoencoders para Redução de Dimensionalidade</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-2-autoencoders-para-reducao-de-dimensionalidade-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
</pre></div>
</div>
</div>
</div>
<p>Outra aplicação de auto-encoders é seu uso para <strong>redução de dimensionalidade não supervisionada</strong></p>
<p>Vamos utilizar a base de dados Boston Housing e a tarefa de regressão</p>
<p>Essa base de dados possui 13 atributos originalmente, vamos aprender uma redução desse espaço.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">boston_housing</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">-=</span> <span class="n">mean</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">/=</span> <span class="n">std</span>

<span class="n">x_test</span> <span class="o">-=</span> <span class="n">mean</span>
<span class="n">x_test</span> <span class="o">/=</span> <span class="n">std</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">target_dimensions</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/boston_housing.npz
57026/57026 [==============================] - 0s 0us/step
(102, 13)
</pre></div>
</div>
</div>
</div>
</section>
<section id="o-autoencoder-sera-denso-com">
<h3>O autoencoder será denso, com:<a class="headerlink" href="#o-autoencoder-sera-denso-com" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>uma camada de 10 dimensões intermediária (para o encoder e o decoder)</p></li>
<li><p>a camada de projeção no espaco do código</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_data</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,))</span>

<span class="c1"># encoder</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">input_data</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">target_dimensions</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">e1</span><span class="p">)</span>

<span class="c1"># decoder</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">d1</span><span class="p">)</span>

<span class="n">autoencoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
<span class="n">autoencoder</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_4&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_3 (InputLayer)        [(None, 13)]              0         
                                                                 
 dense_7 (Dense)             (None, 10)                140       
                                                                 
 code (Dense)                (None, 6)                 66        
                                                                 
 dense_8 (Dense)             (None, 10)                70        
                                                                 
 dense_9 (Dense)             (None, 13)                143       
                                                                 
=================================================================
Total params: 419 (1.64 KB)
Trainable params: 419 (1.64 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># definindo um decaimento para a taxa de aprendizado</span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lr</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

<span class="n">autoencoder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.003</span><span class="p">))</span>

<span class="n">hist_ae</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/150
51/51 - 1s - loss: 0.8801 - lr: 0.0030 - 868ms/epoch - 17ms/step
Epoch 2/150
51/51 - 0s - loss: 0.5754 - lr: 0.0030 - 94ms/epoch - 2ms/step
Epoch 3/150
51/51 - 0s - loss: 0.4932 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 4/150
51/51 - 0s - loss: 0.4448 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 5/150
51/51 - 0s - loss: 0.4129 - lr: 0.0030 - 88ms/epoch - 2ms/step
Epoch 6/150
51/51 - 0s - loss: 0.3925 - lr: 0.0030 - 95ms/epoch - 2ms/step
Epoch 7/150
51/51 - 0s - loss: 0.3776 - lr: 0.0030 - 89ms/epoch - 2ms/step
Epoch 8/150
51/51 - 0s - loss: 0.3654 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 9/150
51/51 - 0s - loss: 0.3553 - lr: 0.0030 - 104ms/epoch - 2ms/step
Epoch 10/150
51/51 - 0s - loss: 0.3463 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 11/150
51/51 - 0s - loss: 0.3377 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 12/150
51/51 - 0s - loss: 0.3311 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 13/150
51/51 - 0s - loss: 0.3252 - lr: 0.0030 - 84ms/epoch - 2ms/step
Epoch 14/150
51/51 - 0s - loss: 0.3211 - lr: 0.0030 - 100ms/epoch - 2ms/step
Epoch 15/150
51/51 - 0s - loss: 0.3175 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 16/150
51/51 - 0s - loss: 0.3148 - lr: 0.0030 - 97ms/epoch - 2ms/step
Epoch 17/150
51/51 - 0s - loss: 0.3117 - lr: 0.0030 - 107ms/epoch - 2ms/step
Epoch 18/150
51/51 - 0s - loss: 0.3091 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 19/150
51/51 - 0s - loss: 0.3077 - lr: 0.0030 - 95ms/epoch - 2ms/step
Epoch 20/150
51/51 - 0s - loss: 0.3054 - lr: 0.0030 - 103ms/epoch - 2ms/step
Epoch 21/150
51/51 - 0s - loss: 0.3037 - lr: 0.0030 - 92ms/epoch - 2ms/step
Epoch 22/150
51/51 - 0s - loss: 0.3018 - lr: 0.0030 - 99ms/epoch - 2ms/step
Epoch 23/150
51/51 - 0s - loss: 0.3010 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 24/150
51/51 - 0s - loss: 0.2995 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 25/150
51/51 - 0s - loss: 0.2973 - lr: 0.0030 - 90ms/epoch - 2ms/step
Epoch 26/150
51/51 - 0s - loss: 0.2965 - lr: 0.0030 - 95ms/epoch - 2ms/step
Epoch 27/150
51/51 - 0s - loss: 0.2955 - lr: 0.0030 - 89ms/epoch - 2ms/step
Epoch 28/150
51/51 - 0s - loss: 0.2945 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 29/150
51/51 - 0s - loss: 0.2942 - lr: 0.0030 - 95ms/epoch - 2ms/step
Epoch 30/150
51/51 - 0s - loss: 0.2921 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 31/150
51/51 - 0s - loss: 0.2912 - lr: 0.0030 - 94ms/epoch - 2ms/step
Epoch 32/150
51/51 - 0s - loss: 0.2908 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 33/150
51/51 - 0s - loss: 0.2898 - lr: 0.0030 - 87ms/epoch - 2ms/step
Epoch 34/150
51/51 - 0s - loss: 0.2892 - lr: 0.0030 - 92ms/epoch - 2ms/step
Epoch 35/150
51/51 - 0s - loss: 0.2881 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 36/150
51/51 - 0s - loss: 0.2879 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 37/150
51/51 - 0s - loss: 0.2881 - lr: 0.0030 - 93ms/epoch - 2ms/step
Epoch 38/150
51/51 - 0s - loss: 0.2872 - lr: 0.0030 - 89ms/epoch - 2ms/step
Epoch 39/150
51/51 - 0s - loss: 0.2858 - lr: 0.0030 - 86ms/epoch - 2ms/step
Epoch 40/150
51/51 - 0s - loss: 0.2859 - lr: 0.0030 - 95ms/epoch - 2ms/step
Epoch 41/150
51/51 - 0s - loss: 0.2854 - lr: 0.0030 - 100ms/epoch - 2ms/step
Epoch 42/150
51/51 - 0s - loss: 0.2849 - lr: 0.0030 - 85ms/epoch - 2ms/step
Epoch 43/150
51/51 - 0s - loss: 0.2850 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 44/150
51/51 - 0s - loss: 0.2845 - lr: 0.0030 - 87ms/epoch - 2ms/step
Epoch 45/150
51/51 - 0s - loss: 0.2831 - lr: 0.0030 - 96ms/epoch - 2ms/step
Epoch 46/150
51/51 - 0s - loss: 0.2825 - lr: 0.0030 - 94ms/epoch - 2ms/step
Epoch 47/150
51/51 - 0s - loss: 0.2824 - lr: 0.0030 - 88ms/epoch - 2ms/step
Epoch 48/150
51/51 - 0s - loss: 0.2828 - lr: 0.0030 - 92ms/epoch - 2ms/step
Epoch 49/150
51/51 - 0s - loss: 0.2824 - lr: 0.0030 - 85ms/epoch - 2ms/step
Epoch 50/150
51/51 - 0s - loss: 0.2837 - lr: 0.0030 - 91ms/epoch - 2ms/step
Epoch 51/150
51/51 - 0s - loss: 0.2811 - lr: 0.0030 - 99ms/epoch - 2ms/step
Epoch 52/150
51/51 - 0s - loss: 0.2809 - lr: 0.0029 - 93ms/epoch - 2ms/step
Epoch 53/150
51/51 - 0s - loss: 0.2801 - lr: 0.0029 - 94ms/epoch - 2ms/step
Epoch 54/150
51/51 - 0s - loss: 0.2798 - lr: 0.0029 - 90ms/epoch - 2ms/step
Epoch 55/150
51/51 - 0s - loss: 0.2798 - lr: 0.0029 - 85ms/epoch - 2ms/step
Epoch 56/150
51/51 - 0s - loss: 0.2786 - lr: 0.0028 - 91ms/epoch - 2ms/step
Epoch 57/150
51/51 - 0s - loss: 0.2786 - lr: 0.0028 - 94ms/epoch - 2ms/step
Epoch 58/150
51/51 - 0s - loss: 0.2791 - lr: 0.0028 - 89ms/epoch - 2ms/step
Epoch 59/150
51/51 - 0s - loss: 0.2787 - lr: 0.0027 - 93ms/epoch - 2ms/step
Epoch 60/150
51/51 - 0s - loss: 0.2809 - lr: 0.0027 - 91ms/epoch - 2ms/step
Epoch 61/150
51/51 - 0s - loss: 0.2783 - lr: 0.0027 - 92ms/epoch - 2ms/step
Epoch 62/150
51/51 - 0s - loss: 0.2770 - lr: 0.0027 - 97ms/epoch - 2ms/step
Epoch 63/150
51/51 - 0s - loss: 0.2767 - lr: 0.0026 - 99ms/epoch - 2ms/step
Epoch 64/150
51/51 - 0s - loss: 0.2765 - lr: 0.0026 - 90ms/epoch - 2ms/step
Epoch 65/150
51/51 - 0s - loss: 0.2766 - lr: 0.0026 - 97ms/epoch - 2ms/step
Epoch 66/150
51/51 - 0s - loss: 0.2758 - lr: 0.0026 - 91ms/epoch - 2ms/step
Epoch 67/150
51/51 - 0s - loss: 0.2759 - lr: 0.0025 - 90ms/epoch - 2ms/step
Epoch 68/150
51/51 - 0s - loss: 0.2761 - lr: 0.0025 - 99ms/epoch - 2ms/step
Epoch 69/150
51/51 - 0s - loss: 0.2753 - lr: 0.0025 - 93ms/epoch - 2ms/step
Epoch 70/150
51/51 - 0s - loss: 0.2756 - lr: 0.0025 - 88ms/epoch - 2ms/step
Epoch 71/150
51/51 - 0s - loss: 0.2747 - lr: 0.0024 - 95ms/epoch - 2ms/step
Epoch 72/150
51/51 - 0s - loss: 0.2745 - lr: 0.0024 - 113ms/epoch - 2ms/step
Epoch 73/150
51/51 - 0s - loss: 0.2743 - lr: 0.0024 - 93ms/epoch - 2ms/step
Epoch 74/150
51/51 - 0s - loss: 0.2742 - lr: 0.0024 - 102ms/epoch - 2ms/step
Epoch 75/150
51/51 - 0s - loss: 0.2736 - lr: 0.0023 - 86ms/epoch - 2ms/step
Epoch 76/150
51/51 - 0s - loss: 0.2737 - lr: 0.0023 - 101ms/epoch - 2ms/step
Epoch 77/150
51/51 - 0s - loss: 0.2734 - lr: 0.0023 - 101ms/epoch - 2ms/step
Epoch 78/150
51/51 - 0s - loss: 0.2732 - lr: 0.0023 - 93ms/epoch - 2ms/step
Epoch 79/150
51/51 - 0s - loss: 0.2729 - lr: 0.0022 - 104ms/epoch - 2ms/step
Epoch 80/150
51/51 - 0s - loss: 0.2728 - lr: 0.0022 - 91ms/epoch - 2ms/step
Epoch 81/150
51/51 - 0s - loss: 0.2725 - lr: 0.0022 - 97ms/epoch - 2ms/step
Epoch 82/150
51/51 - 0s - loss: 0.2720 - lr: 0.0022 - 104ms/epoch - 2ms/step
Epoch 83/150
51/51 - 0s - loss: 0.2722 - lr: 0.0022 - 95ms/epoch - 2ms/step
Epoch 84/150
51/51 - 0s - loss: 0.2716 - lr: 0.0021 - 106ms/epoch - 2ms/step
Epoch 85/150
51/51 - 0s - loss: 0.2715 - lr: 0.0021 - 133ms/epoch - 3ms/step
Epoch 86/150
51/51 - 0s - loss: 0.2716 - lr: 0.0021 - 162ms/epoch - 3ms/step
Epoch 87/150
51/51 - 0s - loss: 0.2714 - lr: 0.0021 - 141ms/epoch - 3ms/step
Epoch 88/150
51/51 - 0s - loss: 0.2711 - lr: 0.0021 - 151ms/epoch - 3ms/step
Epoch 89/150
51/51 - 0s - loss: 0.2708 - lr: 0.0020 - 146ms/epoch - 3ms/step
Epoch 90/150
51/51 - 0s - loss: 0.2708 - lr: 0.0020 - 156ms/epoch - 3ms/step
Epoch 91/150
51/51 - 0s - loss: 0.2709 - lr: 0.0020 - 158ms/epoch - 3ms/step
Epoch 92/150
51/51 - 0s - loss: 0.2704 - lr: 0.0020 - 144ms/epoch - 3ms/step
Epoch 93/150
51/51 - 0s - loss: 0.2704 - lr: 0.0020 - 149ms/epoch - 3ms/step
Epoch 94/150
51/51 - 0s - loss: 0.2697 - lr: 0.0019 - 150ms/epoch - 3ms/step
Epoch 95/150
51/51 - 0s - loss: 0.2695 - lr: 0.0019 - 152ms/epoch - 3ms/step
Epoch 96/150
51/51 - 0s - loss: 0.2700 - lr: 0.0019 - 164ms/epoch - 3ms/step
Epoch 97/150
51/51 - 0s - loss: 0.2695 - lr: 0.0019 - 150ms/epoch - 3ms/step
Epoch 98/150
51/51 - 0s - loss: 0.2692 - lr: 0.0019 - 138ms/epoch - 3ms/step
Epoch 99/150
51/51 - 0s - loss: 0.2692 - lr: 0.0018 - 137ms/epoch - 3ms/step
Epoch 100/150
51/51 - 0s - loss: 0.2695 - lr: 0.0018 - 144ms/epoch - 3ms/step
Epoch 101/150
51/51 - 0s - loss: 0.2687 - lr: 0.0018 - 147ms/epoch - 3ms/step
Epoch 102/150
51/51 - 0s - loss: 0.2686 - lr: 0.0018 - 148ms/epoch - 3ms/step
Epoch 103/150
51/51 - 0s - loss: 0.2684 - lr: 0.0018 - 94ms/epoch - 2ms/step
Epoch 104/150
51/51 - 0s - loss: 0.2683 - lr: 0.0017 - 106ms/epoch - 2ms/step
Epoch 105/150
51/51 - 0s - loss: 0.2683 - lr: 0.0017 - 87ms/epoch - 2ms/step
Epoch 106/150
51/51 - 0s - loss: 0.2681 - lr: 0.0017 - 97ms/epoch - 2ms/step
Epoch 107/150
51/51 - 0s - loss: 0.2681 - lr: 0.0017 - 93ms/epoch - 2ms/step
Epoch 108/150
51/51 - 0s - loss: 0.2678 - lr: 0.0017 - 89ms/epoch - 2ms/step
Epoch 109/150
51/51 - 0s - loss: 0.2679 - lr: 0.0017 - 90ms/epoch - 2ms/step
Epoch 110/150
51/51 - 0s - loss: 0.2677 - lr: 0.0016 - 108ms/epoch - 2ms/step
Epoch 111/150
51/51 - 0s - loss: 0.2676 - lr: 0.0016 - 96ms/epoch - 2ms/step
Epoch 112/150
51/51 - 0s - loss: 0.2679 - lr: 0.0016 - 97ms/epoch - 2ms/step
Epoch 113/150
51/51 - 0s - loss: 0.2672 - lr: 0.0016 - 92ms/epoch - 2ms/step
Epoch 114/150
51/51 - 0s - loss: 0.2671 - lr: 0.0016 - 107ms/epoch - 2ms/step
Epoch 115/150
51/51 - 0s - loss: 0.2667 - lr: 0.0016 - 101ms/epoch - 2ms/step
Epoch 116/150
51/51 - 0s - loss: 0.2670 - lr: 0.0016 - 95ms/epoch - 2ms/step
Epoch 117/150
51/51 - 0s - loss: 0.2670 - lr: 0.0015 - 100ms/epoch - 2ms/step
Epoch 118/150
51/51 - 0s - loss: 0.2667 - lr: 0.0015 - 105ms/epoch - 2ms/step
Epoch 119/150
51/51 - 0s - loss: 0.2666 - lr: 0.0015 - 100ms/epoch - 2ms/step
Epoch 120/150
51/51 - 0s - loss: 0.2666 - lr: 0.0015 - 106ms/epoch - 2ms/step
Epoch 121/150
51/51 - 0s - loss: 0.2663 - lr: 0.0015 - 97ms/epoch - 2ms/step
Epoch 122/150
51/51 - 0s - loss: 0.2663 - lr: 0.0015 - 93ms/epoch - 2ms/step
Epoch 123/150
51/51 - 0s - loss: 0.2663 - lr: 0.0014 - 109ms/epoch - 2ms/step
Epoch 124/150
51/51 - 0s - loss: 0.2661 - lr: 0.0014 - 99ms/epoch - 2ms/step
Epoch 125/150
51/51 - 0s - loss: 0.2661 - lr: 0.0014 - 104ms/epoch - 2ms/step
Epoch 126/150
51/51 - 0s - loss: 0.2657 - lr: 0.0014 - 92ms/epoch - 2ms/step
Epoch 127/150
51/51 - 0s - loss: 0.2658 - lr: 0.0014 - 95ms/epoch - 2ms/step
Epoch 128/150
51/51 - 0s - loss: 0.2656 - lr: 0.0014 - 96ms/epoch - 2ms/step
Epoch 129/150
51/51 - 0s - loss: 0.2657 - lr: 0.0014 - 88ms/epoch - 2ms/step
Epoch 130/150
51/51 - 0s - loss: 0.2656 - lr: 0.0013 - 93ms/epoch - 2ms/step
Epoch 131/150
51/51 - 0s - loss: 0.2657 - lr: 0.0013 - 94ms/epoch - 2ms/step
Epoch 132/150
51/51 - 0s - loss: 0.2654 - lr: 0.0013 - 88ms/epoch - 2ms/step
Epoch 133/150
51/51 - 0s - loss: 0.2653 - lr: 0.0013 - 88ms/epoch - 2ms/step
Epoch 134/150
51/51 - 0s - loss: 0.2651 - lr: 0.0013 - 99ms/epoch - 2ms/step
Epoch 135/150
51/51 - 0s - loss: 0.2650 - lr: 0.0013 - 89ms/epoch - 2ms/step
Epoch 136/150
51/51 - 0s - loss: 0.2652 - lr: 0.0013 - 92ms/epoch - 2ms/step
Epoch 137/150
51/51 - 0s - loss: 0.2652 - lr: 0.0013 - 88ms/epoch - 2ms/step
Epoch 138/150
51/51 - 0s - loss: 0.2651 - lr: 0.0012 - 89ms/epoch - 2ms/step
Epoch 139/150
51/51 - 0s - loss: 0.2648 - lr: 0.0012 - 95ms/epoch - 2ms/step
Epoch 140/150
51/51 - 0s - loss: 0.2647 - lr: 0.0012 - 91ms/epoch - 2ms/step
Epoch 141/150
51/51 - 0s - loss: 0.2649 - lr: 0.0012 - 95ms/epoch - 2ms/step
Epoch 142/150
51/51 - 0s - loss: 0.2646 - lr: 0.0012 - 101ms/epoch - 2ms/step
Epoch 143/150
51/51 - 0s - loss: 0.2647 - lr: 0.0012 - 98ms/epoch - 2ms/step
Epoch 144/150
51/51 - 0s - loss: 0.2647 - lr: 0.0012 - 108ms/epoch - 2ms/step
Epoch 145/150
51/51 - 0s - loss: 0.2645 - lr: 0.0012 - 93ms/epoch - 2ms/step
Epoch 146/150
51/51 - 0s - loss: 0.2643 - lr: 0.0011 - 88ms/epoch - 2ms/step
Epoch 147/150
51/51 - 0s - loss: 0.2645 - lr: 0.0011 - 94ms/epoch - 2ms/step
Epoch 148/150
51/51 - 0s - loss: 0.2644 - lr: 0.0011 - 101ms/epoch - 2ms/step
Epoch 149/150
51/51 - 0s - loss: 0.2642 - lr: 0.0011 - 92ms/epoch - 2ms/step
Epoch 150/150
51/51 - 0s - loss: 0.2642 - lr: 0.0011 - 109ms/epoch - 2ms/step
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="uso-em-regressor-externo">
<h3>Uso em regressor externo<a class="headerlink" href="#uso-em-regressor-externo" title="Permalink to this heading">#</a></h3>
<p>Com o AE treinado, podemos utilizá-lo para obter representações para instâncias do treinamento e do teste</p>
<p>Vamos compara esse novo espaço aprendido com o original e com uma projeção PCA</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_squared_error</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                                <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">code_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">))</span>
<span class="n">code_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training data size = &quot;</span><span class="p">,</span> <span class="n">code_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing data size = &quot;</span><span class="p">,</span> <span class="n">code_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13/13 [==============================] - 0s 2ms/step
4/4 [==============================] - 0s 3ms/step
Training data size =  (404, 6)
Testing data size =  (102, 6)
</pre></div>
</div>
</div>
</div>
<p>Criando a projeção PCA para comparação</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">target_dimensions</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">pca_train</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">pca_test</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Treinando os regressores</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Treinando Regressor com Código AE...&#39;</span><span class="p">)</span>
<span class="n">clf_ae</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">clf_ae</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">code_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">code_pred</span> <span class="o">=</span> <span class="n">clf_ae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">code_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treinando Regressor com Código AE...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Treinando Regressor com PCA...&#39;</span><span class="p">)</span>
<span class="n">clf_pca</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">clf_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pca_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pca_pred</span> <span class="o">=</span> <span class="n">clf_pca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pca_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treinando Regressor com PCA...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Treinando Regressor com Dados Originais...&#39;</span><span class="p">)</span>
<span class="n">clf_ori</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">clf_ori</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf_ori</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treinando Regressor com Dados Originais...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculando score...&#39;</span><span class="p">)</span>
<span class="n">score_ae</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">code_pred</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">score_ori</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">score_pca</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">pca_pred</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score original: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score_ori</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score PCA: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score_pca</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">score AE: </span><span class="si">%.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score_ae</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculando score...

score original: 23.11

score PCA: 21.63

score AE: 20.67 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id104">
<h2><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span><a class="headerlink" href="#id104" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-3-rede-geradora-adversarial-gan-span">
<h3><span style="color:darkred"><strong>Parte 3: Rede Geradora Adversarial (GAN)</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-3-rede-geradora-adversarial-gan-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
</pre></div>
</div>
</div>
</div>
<p>Vamos projetar uma rede adversária para gerar dados num plano.</p>
<p>Para isso utilizaremos uma função como referência, uma função Senoidal</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">distribuicao_dados</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

<span class="n">amostragem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">distribuicao_dados</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">amostragem</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">amostragem</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7c20b9578f10&gt;]
</pre></div>
</div>
<img alt="../_images/0edb461566539f2536db2a52809ff75a10ce7426e2a89dd32d9c71636b577ed3.png" src="../_images/0edb461566539f2536db2a52809ff75a10ce7426e2a89dd32d9c71636b577ed3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># funcao que obtem amostras a partir a distribuicao de dados alvo</span>
<span class="k">def</span> <span class="nf">distribuicao_alvo</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
  <span class="n">amost_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
  <span class="n">amost_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">distribuicao_dados</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">amost_x</span><span class="p">])</span>
  <span class="n">dados_reais</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">amost_x</span><span class="p">,</span> <span class="n">amost_y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">dados_reais</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># funcao que obtem amostras aleatórias no plano</span>
<span class="k">def</span> <span class="nf">distribuicao_aleatoria</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
  <span class="n">amost_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
  <span class="n">amost_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span>
  <span class="n">dados_aleatorios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">amost_x</span><span class="p">,</span> <span class="n">amost_y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">dados_aleatorios</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exemplos</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">exemplos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">exemplos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x7c20b957a5f0&gt;
</pre></div>
</div>
<img alt="../_images/dc8ef229fc6f130bcb47803dbd94c1bddec7d0ec343d030fa347c1a6fbb650b6.png" src="../_images/dc8ef229fc6f130bcb47803dbd94c1bddec7d0ec343d030fa347c1a6fbb650b6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exemplos</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">distribuicao_aleatoria</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">exemplos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">exemplos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x7c20b7348bb0&gt;
</pre></div>
</div>
<img alt="../_images/85e0bb15567b459620f95d1d4ce5312c9794e9d5b183a9adceff84c4df4d7535.png" src="../_images/85e0bb15567b459620f95d1d4ce5312c9794e9d5b183a9adceff84c4df4d7535.png" />
</div>
</div>
</section>
<section id="discriminador">
<h3>Discriminador<a class="headerlink" href="#discriminador" title="Permalink to this heading">#</a></h3>
<p>Componente que é responsável por identificar se um ponto foi produzido por uma distribuição original ou por outra distribuição.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># modelo discriminador base : classificador</span>
<span class="k">def</span> <span class="nf">discriminator</span><span class="p">(</span><span class="n">dim_input</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">dim_input</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<p>Para treinar o discriminador, geramos exemplos reais e “falsos” criando rótulos para cada caso</p>
<p>Aqui fazemos um treinamento manual, com metade do batch de cada rótulo.</p>
<p>Não temos ainda uma GAN, aqui o discriminador aprende a classificar entre dados reais e aleatórios, não gerados por outra rede neural</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># funcao de ajuste do discriminador</span>
<span class="k">def</span> <span class="nf">fit_discriminator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">histR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="n">histF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># treina modelo em meio batch</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span>

        <span class="c1"># gera exemplos falsos</span>
        <span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">distribuicao_aleatoria</span><span class="p">(</span><span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># treina modelo em meio batch</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">)</span>
        <span class="n">loss_real</span><span class="p">,</span> <span class="n">acc_real</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_falso</span><span class="p">,</span> <span class="n">acc_falso</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">histR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_real</span>
        <span class="n">histF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_falso</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">%d</span><span class="s2">, Accuracy- real: </span><span class="si">%.2f</span><span class="s2"> falso: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc_real</span><span class="p">,</span> <span class="n">acc_falso</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">histR</span><span class="p">,</span> <span class="n">histF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the discriminator model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="c1"># fit the model</span>
<span class="n">histR</span><span class="p">,</span> <span class="n">histF</span> <span class="o">=</span> <span class="n">fit_discriminator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 dense (Dense)               (None, 12)                36        
                                                                 
 dense_1 (Dense)             (None, 1)                 13        
                                                                 
=================================================================
Total params: 49
Trainable params: 49
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<p>Exibindo os gráficos da perda computada nos exemplos reais e aleatórios, fica claro como raramente elas vão bem ao mesmo tempo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histR</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histF</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Perda dados reais&#39;</span><span class="p">,</span> <span class="s1">&#39;Perda dados aleatórios&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7c20a5a9a560&gt;
</pre></div>
</div>
<img alt="../_images/8edc3c7753a4de2a6f0c1cc468ddb0da84f145a8a2fb8db1de05bfd2be11fe0b.png" src="../_images/8edc3c7753a4de2a6f0c1cc468ddb0da84f145a8a2fb8db1de05bfd2be11fe0b.png" />
</div>
</div>
</section>
<section id="gerador">
<h3>Gerador<a class="headerlink" href="#gerador" title="Permalink to this heading">#</a></h3>
<p>Modelo que, a partir de uma amostra da distribuição latente, aprende uma transformação desse em um exemplo candidato à distribuição alvo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># modelo gerador, cuja entrada tem dimensão do espaço latente</span>
<span class="c1"># sua saída tem dimensão igual a dos exemplos da distribuição alvo</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">dim_output</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">z_dim</span><span class="p">))</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">dim_output</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">model</span>

<span class="c1"># funcao para gerar uma amostra com n exemplos da distribuicao latente</span>
<span class="k">def</span> <span class="nf">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
  <span class="n">exemplos_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">z_dim</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">exemplos_z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">)</span>

<span class="c1"># funcao para gerar exemplos &quot;falsos&quot;, aleatorios a partir da</span>
<span class="c1"># saída do gerador G(z)</span>
<span class="k">def</span> <span class="nf">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_g</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
  <span class="n">exemplos_z</span> <span class="o">=</span> <span class="n">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
  <span class="n">exemplos_falsos</span> <span class="o">=</span> <span class="n">model_g</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">exemplos_z</span><span class="p">)</span>
  <span class="n">labels_falsos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">exemplos_falsos</span><span class="p">,</span> <span class="n">labels_falsos</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># gerador com dimensionalidade latente = 6</span>
<span class="n">model_gen</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># exemplos a partir do gerador aleatório (inicial)</span>
<span class="n">exemplos_falsos</span><span class="p">,</span> <span class="n">lab_falsos</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">exemplos_falsos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">exemplos_falsos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 98ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x7c20b46a0be0&gt;
</pre></div>
</div>
<img alt="../_images/57eab5c10cfb91709e84c00c6ad9f84f335cf3853e1ecd71139cebece185b46e.png" src="../_images/57eab5c10cfb91709e84c00c6ad9f84f335cf3853e1ecd71139cebece185b46e.png" />
</div>
</div>
</section>
<section id="gan">
<h3>GAN<a class="headerlink" href="#gan" title="Permalink to this heading">#</a></h3>
<p>Tendo os dois componentes, vamos conectá-los para treinamento em conjunto, de forma adversarial</p>
<p>A GAN terá por objetivo treinar o <strong>gerador</strong> enquanto o <em>discriminador</em> será treinado de forma independente, e alternada.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">):</span>
    <span class="c1"># o discriminador sera treinado separadamente, entao marcamos como</span>
    <span class="c1"># nao treinável dentro desse modelo</span>
    <span class="n">model_dis</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># criamos modelo que gera exemplos, depois os passa ao discriminador</span>
    <span class="n">model_gan</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_gen</span><span class="p">)</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_dis</span><span class="p">)</span>
    <span class="n">model_gan</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model_gan</span>
</pre></div>
</div>
</div>
</div>
<p>A função para treinamento da GAN alterna treinamento do <em>discriminador</em>, por meio de exemplos falsos e verdadeiros gerados, seguido do treinamento do <strong>gerador</strong> o qual será otimizado para ganhar do discriminador.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">histR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="n">histF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="c1"># treinamento do discriminador</span>
        <span class="c1"># amostra exemplos para o discriminador</span>
        <span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># treina modelo em meio batch</span>
        <span class="n">model_dis</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span>
        <span class="n">model_dis</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">)</span>

        <span class="c1"># treinamento do gerador</span>
        <span class="c1"># exemplos da distribuicao latente</span>
        <span class="n">z_batch</span> <span class="o">=</span> <span class="n">amostra_distribuicao_latente</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># invertemos os labels aqui para treinar de forma a enganar o discriminador</span>
        <span class="n">z_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">model_GAN</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">z_batch</span><span class="p">,</span> <span class="n">z_labels</span><span class="p">)</span>

        <span class="c1"># avalia modelo discriminador atual</span>
        <span class="n">loss_real</span><span class="p">,</span> <span class="n">acc_real</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">loss_falso</span><span class="p">,</span> <span class="n">acc_falso</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">histR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_real</span>
        <span class="n">histF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_falso</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">%d</span><span class="s2">, Accuracy- real: </span><span class="si">%.2f</span><span class="s2"> falso: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">acc_real</span><span class="p">,</span> <span class="n">acc_falso</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p>Vamos agora treinar a GAN</p>
<p>Escolhemos uma dimensionalidade latente de forma que <span class="math notranslate nohighlight">\(z \in R^4\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_dim</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">model_dis</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">()</span>
<span class="n">model_gen</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">)</span>

<span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Antes do treinamento&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4/4 [==============================] - 0s 3ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Antes do treinamento&#39;)
</pre></div>
</div>
<img alt="../_images/da2b6c4812d61bc12a857c8b164c3f6b47fa85d6c61a25cd8023c35d02ef6b4d.png" src="../_images/da2b6c4812d61bc12a857c8b164c3f6b47fa85d6c61a25cd8023c35d02ef6b4d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_GAN</span> <span class="o">=</span> <span class="n">GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">)</span>

<span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 23ms/step
Epoch: 0, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 1, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 2, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 3, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 4, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 29ms/step
Epoch: 5, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 6, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 7, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 8, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 35ms/step
Epoch: 9, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 10, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 11, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 12, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 13, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 14, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 15, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 16, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 17, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 28ms/step
Epoch: 18, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 32ms/step
Epoch: 19, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 33ms/step
Epoch: 20, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 33ms/step
Epoch: 21, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 22, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 40ms/step
Epoch: 23, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 35ms/step
Epoch: 24, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 42ms/step
Epoch: 25, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 33ms/step
Epoch: 26, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 32ms/step
Epoch: 27, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 37ms/step
Epoch: 28, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 29, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 33ms/step
Epoch: 30, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 36ms/step
Epoch: 31, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 36ms/step
Epoch: 32, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 33, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 36ms/step
Epoch: 34, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 21ms/step
Epoch: 35, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 36, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 37, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 38, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 39, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 40, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 41, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 42, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 43, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 44, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 45, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 46, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 21ms/step
Epoch: 47, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 48, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 30ms/step
Epoch: 49, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 50, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 51, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 52, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 32ms/step
Epoch: 53, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 21ms/step
Epoch: 54, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 21ms/step
Epoch: 55, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 56, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 30ms/step
Epoch: 57, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 58, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 59, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 60, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 61, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 62, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 63, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 64, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 36ms/step
Epoch: 65, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 66, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 67, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 68, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 28ms/step
Epoch: 69, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 70, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 71, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 72, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 73, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 43ms/step
Epoch: 74, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 30ms/step
Epoch: 75, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 76, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 32ms/step
Epoch: 77, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 33ms/step
Epoch: 78, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 79, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 32ms/step
Epoch: 80, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 35ms/step
Epoch: 81, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 82, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 39ms/step
Epoch: 83, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 39ms/step
Epoch: 84, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 34ms/step
Epoch: 85, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 52ms/step
Epoch: 86, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 37ms/step
Epoch: 87, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 40ms/step
Epoch: 88, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 44ms/step
Epoch: 89, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 90, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 24ms/step
Epoch: 91, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 92, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 93, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 26ms/step
Epoch: 94, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 95, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 22ms/step
Epoch: 96, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 25ms/step
Epoch: 97, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 23ms/step
Epoch: 98, Accuracy- real: 1.00 falso: 0.00
1/1 [==============================] - 0s 27ms/step
Epoch: 99, Accuracy- real: 1.00 falso: 0.00
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histR</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">histF</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7c20a5490a90&gt;]
</pre></div>
</div>
<img alt="../_images/28fbbe0a459da292a79f6573eaa85c8137c1e88302ad18afb77ff72b32aff8e4.png" src="../_images/28fbbe0a459da292a79f6573eaa85c8137c1e88302ad18afb77ff72b32aff8e4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Após 200 épocas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7/7 [==============================] - 0s 2ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Após 200 épocas&#39;)
</pre></div>
</div>
<img alt="../_images/867d30436e79dc306efa016b5446504a845b1f93feb97fdfc71e183671bdb453.png" src="../_images/867d30436e79dc306efa016b5446504a845b1f93feb97fdfc71e183671bdb453.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 32ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 30ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 38ms/step
1/1 [==============================] - 0s 63ms/step
1/1 [==============================] - 0s 58ms/step
1/1 [==============================] - 0s 36ms/step
1/1 [==============================] - 0s 31ms/step
1/1 [==============================] - 0s 40ms/step
1/1 [==============================] - 0s 30ms/step
1/1 [==============================] - 0s 32ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 33ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 28ms/step
1/1 [==============================] - 0s 32ms/step
1/1 [==============================] - 0s 39ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 39ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 36ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 43ms/step
1/1 [==============================] - 0s 33ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 33ms/step
1/1 [==============================] - 0s 36ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 37ms/step
1/1 [==============================] - 0s 39ms/step
1/1 [==============================] - 0s 36ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 21ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 30ms/step
1/1 [==============================] - 0s 21ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 26ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 21ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 26ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 22ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 25ms/step
1/1 [==============================] - 0s 29ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 23ms/step
1/1 [==============================] - 0s 24ms/step
1/1 [==============================] - 0s 34ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 33ms/step
1/1 [==============================] - 0s 33ms/step
1/1 [==============================] - 0s 40ms/step
1/1 [==============================] - 0s 38ms/step
1/1 [==============================] - 0s 40ms/step
1/1 [==============================] - 0s 35ms/step
1/1 [==============================] - 0s 37ms/step
1/1 [==============================] - 0s 33ms/step
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-26-0ea48e5c5e2b&gt;</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nn">&lt;ipython-input-22-3993ae11f47e&gt;</span> in <span class="ni">fit_GAN</span><span class="nt">(model_gen, model_dis, model_GAN, z_dim, epochs, batch_size, verbose)</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> 
<span class="g g-Whitespace">     </span><span class="mi">22</span>         <span class="c1"># avalia modelo discriminador atual</span>
<span class="ne">---&gt; </span><span class="mi">23</span>         <span class="n">loss_real</span><span class="p">,</span> <span class="n">acc_real</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>         <span class="n">loss_falso</span><span class="p">,</span> <span class="n">acc_falso</span> <span class="o">=</span> <span class="n">model_dis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>         <span class="n">histR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_real</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/keras/utils/traceback_utils.py</span> in <span class="ni">error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>         <span class="n">filtered_tb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">65</span>             <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span>         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>             <span class="n">filtered_tb</span> <span class="o">=</span> <span class="n">_process_traceback_frames</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/keras/engine/training.py</span> in <span class="ni">evaluate</span><span class="nt">(self, x, y, batch_size, verbose, sample_weight, steps, callbacks, max_queue_size, workers, use_multiprocessing, return_dict, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2062</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2063</span>             <span class="n">callbacks</span><span class="o">.</span><span class="n">on_test_begin</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">2064</span>             <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">iterator</span> <span class="ow">in</span> <span class="n">data_handler</span><span class="o">.</span><span class="n">enumerate_epochs</span><span class="p">():</span>  <span class="c1"># Single epoch.</span>
<span class="g g-Whitespace">   </span><span class="mi">2065</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">reset_metrics</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">2066</span>                 <span class="k">with</span> <span class="n">data_handler</span><span class="o">.</span><span class="n">catch_stop_iteration</span><span class="p">():</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/keras/engine/data_adapter.py</span> in <span class="ni">enumerate_epochs</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1303</span><span class="w">         </span><span class="sd">&quot;&quot;&quot;Yields `(epoch, tf.data.Iterator)`.&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1304</span>         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_execution_to_epoch</span><span class="p">():</span>
<span class="ne">-&gt; </span><span class="mi">1305</span>             <span class="n">data_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1306</span>             <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epochs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1307</span>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insufficient_data</span><span class="p">:</span>  <span class="c1"># Set by `catch_stop_iteration`.</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/tensorflow/python/data/ops/dataset_ops.py</span> in <span class="ni">__iter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span>     <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">executing_eagerly</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ops</span><span class="o">.</span><span class="n">inside_function</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span>       <span class="k">with</span> <span class="n">ops</span><span class="o">.</span><span class="n">colocate_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variant_tensor</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">505</span>         <span class="k">return</span> <span class="n">iterator_ops</span><span class="o">.</span><span class="n">OwnedIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">506</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">507</span>       <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;`tf.data.Dataset` only supports Python-style &quot;</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/tensorflow/python/data/ops/iterator_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, dataset, components, element_spec)</span>
<span class="g g-Whitespace">    </span><span class="mi">711</span>             <span class="s2">&quot;When `dataset` is provided, `element_spec` and `components` must &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">712</span>             <span class="s2">&quot;not be specified.&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">713</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_create_iterator</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">714</span> 
<span class="g g-Whitespace">    </span><span class="mi">715</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_call_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/tensorflow/python/data/ops/iterator_ops.py</span> in <span class="ni">_create_iterator</span><span class="nt">(self, dataset)</span>
<span class="g g-Whitespace">    </span><span class="mi">750</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_flat_output_types</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">751</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_iterator_resource</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">experimental_set_type</span><span class="p">(</span><span class="n">fulltype</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">752</span>       <span class="n">gen_dataset_ops</span><span class="o">.</span><span class="n">make_iterator</span><span class="p">(</span><span class="n">ds_variant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterator_resource</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">753</span> 
<span class="g g-Whitespace">    </span><span class="mi">754</span>   <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/tensorflow/python/ops/gen_dataset_ops.py</span> in <span class="ni">make_iterator</span><span class="nt">(dataset, iterator, name)</span>
<span class="g g-Whitespace">   </span><span class="mi">3406</span>   <span class="k">if</span> <span class="n">tld</span><span class="o">.</span><span class="n">is_eager</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">3407</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">3408</span>       <span class="n">_result</span> <span class="o">=</span> <span class="n">pywrap_tfe</span><span class="o">.</span><span class="n">TFE_Py_FastPathExecute</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3409</span>         <span class="n">_ctx</span><span class="p">,</span> <span class="s2">&quot;MakeIterator&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">iterator</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3410</span>       <span class="k">return</span> <span class="n">_result</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Após 3000 épocas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4/4 [==============================] - 0s 3ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Após 3000 épocas&#39;)
</pre></div>
</div>
<img alt="../_images/7d7afda6e3511f063899b9d1419ceff50979d17a8433acb9580d32635ea6b350.png" src="../_images/7d7afda6e3511f063899b9d1419ceff50979d17a8433acb9580d32635ea6b350.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Após 6000 épocas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Após 6000 épocas&#39;)
</pre></div>
</div>
<img alt="../_images/a61a114b8a4e840faab22a2dd5eeea965679186834a1879b4c91c98d46452f0a.png" src="../_images/a61a114b8a4e840faab22a2dd5eeea965679186834a1879b4c91c98d46452f0a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_GAN</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">model_dis</span><span class="p">,</span> <span class="n">model_GAN</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_falso</span><span class="p">,</span> <span class="n">y_falso</span> <span class="o">=</span> <span class="n">gera_exemplos_falsos</span><span class="p">(</span><span class="n">model_gen</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span> <span class="o">=</span> <span class="n">distribuicao_alvo</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_falso</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x_real</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Após 10000 épocas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Após 10000 épocas&#39;)
</pre></div>
</div>
<img alt="../_images/5baa3332034a91bfb0b931d9e8202535fd81a16048bbad4ed605235a9076edc4.png" src="../_images/5baa3332034a91bfb0b931d9e8202535fd81a16048bbad4ed605235a9076edc4.png" />
</div>
</div>
</section>
</section>
<section id="id105">
<h2><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span><a class="headerlink" href="#id105" title="Permalink to this heading">#</a></h2>
<section id="id106">
<h3><span style="color:darkred">Avaliação (com soluções)</span><a class="headerlink" href="#id106" title="Permalink to this heading">#</a></h3>
</section>
<section id="id107">
<h3>Questão 1)<a class="headerlink" href="#id107" title="Permalink to this heading">#</a></h3>
<p>Qual é a principal utilidade do aprendizado de uma rede do tipo Denoising Autoencoder que recebe por entrada <span class="math notranslate nohighlight">\(x \in X\)</span> e realiza as operações em sequência <span class="math notranslate nohighlight">\(z = f(x)\)</span> e <span class="math notranslate nohighlight">\(\hat{x} = g(z)\)</span>, sendo <span class="math notranslate nohighlight">\(z \in Z\)</span> um vetor num espaço latente <span class="math notranslate nohighlight">\(Z\)</span>?</p>
<p><font color='red'>(a) Aprender a tarefa de reconstrução de dados do espaço <span class="math notranslate nohighlight">\(X\)</span> adicionados de ruído, em uma representação não ruidosa, e como efeito colateral um espaço <span class="math notranslate nohighlight">\(Z\)</span> contendo atributos relevantes de <span class="math notranslate nohighlight">\(X\)</span><br></font>
(b) Aprender uma distribuição contínua dos dados de entrada <span class="math notranslate nohighlight">\(X\)</span>, ou seja <span class="math notranslate nohighlight">\(p(X)\)</span>, a partir da amostragem de ruído obtido pela distribuição Normal<br>
(c) Aprender a reconstruir um exemplo <span class="math notranslate nohighlight">\(\hat{x}\)</span> com base na injeção de ruído na variável latente <span class="math notranslate nohighlight">\(z\)</span>, de forma a conter o maior número de atributos relevantes da entrada <span class="math notranslate nohighlight">\(x\)</span>, utilizando uma loss de remoção de ruído<br>
(d) Aprender a reconstruir uma representação ruidosa da entrada <span class="math notranslate nohighlight">\(x\)</span> que contenha atributos relevantes do espaço <span class="math notranslate nohighlight">\(z\)</span> <br>
(e) Aprender a gerar exemplos artificiais <span class="math notranslate nohighlight">\(\hat{x}\)</span> sem ruído a partir de dados ruidosos na distribuição latente <span class="math notranslate nohighlight">\(Z\)</span><br></p>
<p><strong>Justificativa:</strong> o denoising autoencoder aprende uma representação restrita <span class="math notranslate nohighlight">\(Z\)</span> do espaço de entrada <span class="math notranslate nohighlight">\(X\)</span> por meio da tarefa de reconstrução de dados ruidosos em dados sem ruído. As alternativas incorretas são: (b) o Autoencoder não aprende <span class="math notranslate nohighlight">\(p(X)\)</span> mas uma relação entre o espaço X e o espaço latente Z e sua reconstrução de volta em <span class="math notranslate nohighlight">\(X\)</span>, (c) o Denoising Autoencoder não injeta ruído no espaço latente, (d) o Denoising Autoencoder não reconstrói dados ruidosos e sim dados sem ruído a partir da entrada ruidosa, (e) o autoencoder não é um bom modelo para geração de dados, e em particular não lida com uma distribuiçã latente ruidosa e sim uma entrada ruidosa.</p>
</section>
<hr class="docutils" />
<section id="id108">
<h3>Questão 2)<a class="headerlink" href="#id108" title="Permalink to this heading">#</a></h3>
<p>Qual o motivo principal da dificuldade em treinar modelos do tipo Generative Adversarial Networks, na sua forma clássica?</p>
<p>(a) Porque são redes semi-supervisionadas, e assim ao não conter rótulos explícitos para o cenário de geração, apenas para de discriminação, o aprendizado é mais difícil nesse cenário<br>
(b) Porque aprende a distribuição dos dados de forma explícita, em contraste com outros métodos que possuem a distribuição de forma implícita<br>
(c) Devido à dificuldade em encontrar uma distribuição latente aleatória que seja adequada para o problema<br>
(d) É difícil de encontrar conjuntos de treinamento suficientemente grandes para essa tarefa<br>
<font color='red'>(e) Devido à necessidade de otimizar dois componentes, um minimizando e o outro maximizando a mesma função objetivo</font><br></p>
<p><strong>Justificativa</strong>: os dois componentes: gerador e discriminador, competem entre si e seu processo de otimização faz com que se alternem dificultando que o gerador aprenda a partir de um certo ponto. As alternativas incorretas: (a) GANS não são semi-supervisionadas pois não trabalham com bases de dados parcialmente rotuladas, (b) GANS não assumem aprendizado explícito da distribuição dos dados, e sim de forma implícita, (c) a distribuição latente aleatória não é o principal motivo da dificuldade, sendo possível escolher a partir de diversas distribuições, (d) a rede é não supervisionada assim não é difícil encontrar conjuntos de treinamento já que se podem usar dados não anotados.</p>
</section>
<hr class="docutils" />
<section id="id109">
<h3>Questão 3)<a class="headerlink" href="#id109" title="Permalink to this heading">#</a></h3>
<p>A diferença entre o espaço latente (<span class="math notranslate nohighlight">\(Z\)</span>) aprendido por um Autoencoder convencional (AE) e um Variational Autoencoder (VAE) é:</p>
<p>(a) O AE aprende um espaço a partir de distribuições de probabilidade aprendidas enquanto o VAE aproxima um espaço de projeções discretas de cada instância de treinamento<br>
(b) O espaço do AE pode ser overcomplete ou undercomplete, enquanto o do VAE é apenas overcomplete<br>
<font color='red'>(c) O AE aprende um espaço a partir de projeções discretas de cada instância de treinamento, enquanto o VAE aproxima um espaço contínuo por meio do aprendizado de parâmetros de distribuições</font><br>
(d) O espaço do AE é não interpretável, já o espaço aprendido pelo VAE se pode interpretar a partir de cada variável independente<br>
(e) O AE aprende um espaço contínuo a partir de projeções discretas de cada instância de treinamento, enquanto o VAE aproxima um espaço discreto por meio do aprendizado de parâmetros de distribuições<br></p>
<p><strong>Justificativa</strong>: O encoder do AE convencional realiza uma operação discreta para cada ponto de entrada, sendo difícil interpolar entre esses pontos, já o VAE amostra a partir de distribuições o que facilita essa interpolação aproximando um espaço contínuo. As alternativas incorretas: (a) o VAE não aprende um espaço de projeções discretas, (b) ambos podem ser over ou undercomplete, (d) a interpretabilidade dos espaços não é distinta, (e) o AE não aprende um espaço contínuo, e o VAE não aprende um espaço discreto, e sim o contrário.</p>
</section>
<hr class="docutils" />
<section id="id110">
<h3>Questão 4)<a class="headerlink" href="#id110" title="Permalink to this heading">#</a></h3>
<p>Nessa questão você deverá projetar e treinar um Autoencoder a partir do qual utilizaremos seu componente Decoder. Siga como base o código disponível no notebook, e preencha com seu código conforme necessário para cumprir as tarefas a seguir.</p>
<p>Carregue a base de dados <code class="docutils literal notranslate"><span class="pre">wine.csv</span></code>, com uma divisão hold-out utilizando os 80% exemplos iniciais para treinamento e os restantes para teste. Utilizaremos o StandardScaler para normalizar os dados.</p>
<p>Projete um Denoising Autoencoder (usaremos uma camada de dropout na entrada como “ruído” impulsivo) para produzir um espaço de características com 3 dimensões, com as seguinte arquitetura:</p>
<p><em>Encoder</em>:</p>
<ul class="simple">
<li><p>Entrada (com as dimensões da base de dados)</p></li>
<li><p>Dropout de 0.25</p></li>
<li><p>Camada densa de 6 neurônios e ativação tangente hiperbólica</p></li>
<li><p>Camada densa de 3 neurônios (camada de código) e ativação tangente hiperbólica</p></li>
</ul>
<p><em>Decoder</em>:</p>
<ul class="simple">
<li><p>Camada densa de 6 neurônios e ativação tangente hiperbólica (recebe como entrada o código do encoder)</p></li>
<li><p>Camada densa de saída (com as dimensões da base de dados) e ativação tangente hiperbólica</p></li>
</ul>
<p>OBS: código é o nome que se dá à camada latente do Autoencoder, geralmente aquela contendo a maior restrição de dimensionalidade, que fornece um espaço de características compacto para os dados de entrada. Também chamamos de código as características obtidas a partir dessa camada.</p>
<p>Inicialize as sementes <code class="docutils literal notranslate"><span class="pre">seed(1)</span></code> e <code class="docutils literal notranslate"><span class="pre">set_seed(2)</span></code> antes de instanciar o modelo, compilar e treinar.</p>
<p>Utilize a função de custo mean absolute error (mse), otimizador Adam com taxa 0.0001, batchsize 10 e treine por 250 épocas.</p>
<p>Após o treinamento, iremos utilizar o decoder para gerar um dataset artificial. Para isso:</p>
<ol class="arabic simple">
<li><p>Crie um array de tamanho 2000 x 3 com valores obtidos pela distribuição uniforme (<code class="docutils literal notranslate"><span class="pre">np.random.rand()</span></code>), e depois normalize os valores para o intervalo entre -1 e 1 usando o MinMaxScaler. Esses valores serão utilizados como amostras aleatórias do código.</p></li>
<li><p>Passe esse array pelo decoder e obtenha como saída um dataset artificial com 2000 instancias na dimensionalidade original dos dados da base wine.</p></li>
<li><p>Para rotular essas instâncias, iremos utilizar um classificador KNN treinado no conjunto de treinamento da base original wine, com K=5. Após treinar o classificador, aplicá-lo no dataset artificial, obtendo seus rótulos, ou seja consideraremos como rótulo o que o KNN classificar. A seguir selecionaremos apenas as instâncias e seus respectivos rótulos que receberam probabilidade igual ou superior a 0.99 pelo classificador, gerando um dataset mais reduzido. Esse será nosso dataset artificial final.</p></li>
<li><p>Treine dois classificadores SVM com C=1, random_state=1, e kernel=”linear”</p></li>
</ol>
<ul class="simple">
<li><p>o primeiro usando os dados de treinamento originais</p></li>
<li><p>o segundo usando como treinamento os dados artificiais/sintéticos</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p>Avalie ambos no conjunto de testes original usando a acurácia.</p></li>
</ol>
<p>Em qual intervalo estão as acurácias dos classificadores considerando o uso de dados originais e artificiais?</p>
<p>(a) dados originais=[55,70], dados artificiais=[25,40]<br>
(b) dados originais=[55,70], dados artificiais=[55,70]<br>
(c) dados originais=[85,100], dados artificiais=[25,40]<br>
(d) dados originais=[85,100], dados artificiais=[55,70]<br>
<font color='red'>(e) dados originais=[85,100], dados artificiais=[85,100]<br></font></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
!pip install tensorflow tensorflow-datasets
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Carregar os dados do conjunto de dados Wine da UCI</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/wine/wine.data&quot;</span>
<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Class&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Alcohol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Malic acid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ash&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Alcalinity of ash&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Magnesium&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total phenols&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Flavanoids&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Nonflavanoid phenols&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proanthocyanins&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Color intensity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Hue&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OD280/OD315 of diluted wines&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proline&#39;</span>
<span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>

<span class="c1"># extrair features e labels</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span>

<span class="c1"># divisao treinamento e teste</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-ec69aec0-9520-4767-899b-ead0eb62f8ce" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Alcohol</th>
      <th>Malic acid</th>
      <th>Ash</th>
      <th>Alcalinity of ash</th>
      <th>Magnesium</th>
      <th>Total phenols</th>
      <th>Flavanoids</th>
      <th>Nonflavanoid phenols</th>
      <th>Proanthocyanins</th>
      <th>Color intensity</th>
      <th>Hue</th>
      <th>OD280/OD315 of diluted wines</th>
      <th>Proline</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>158</th>
      <td>14.34</td>
      <td>1.68</td>
      <td>2.70</td>
      <td>25.0</td>
      <td>98</td>
      <td>2.80</td>
      <td>1.31</td>
      <td>0.53</td>
      <td>2.70</td>
      <td>13.00</td>
      <td>0.57</td>
      <td>1.96</td>
      <td>660</td>
    </tr>
    <tr>
      <th>137</th>
      <td>12.53</td>
      <td>5.51</td>
      <td>2.64</td>
      <td>25.0</td>
      <td>96</td>
      <td>1.79</td>
      <td>0.60</td>
      <td>0.63</td>
      <td>1.10</td>
      <td>5.00</td>
      <td>0.82</td>
      <td>1.69</td>
      <td>515</td>
    </tr>
    <tr>
      <th>98</th>
      <td>12.37</td>
      <td>1.07</td>
      <td>2.10</td>
      <td>18.5</td>
      <td>88</td>
      <td>3.52</td>
      <td>3.75</td>
      <td>0.24</td>
      <td>1.95</td>
      <td>4.50</td>
      <td>1.04</td>
      <td>2.77</td>
      <td>660</td>
    </tr>
    <tr>
      <th>159</th>
      <td>13.48</td>
      <td>1.67</td>
      <td>2.64</td>
      <td>22.5</td>
      <td>89</td>
      <td>2.60</td>
      <td>1.10</td>
      <td>0.52</td>
      <td>2.29</td>
      <td>11.75</td>
      <td>0.57</td>
      <td>1.78</td>
      <td>620</td>
    </tr>
    <tr>
      <th>38</th>
      <td>13.07</td>
      <td>1.50</td>
      <td>2.10</td>
      <td>15.5</td>
      <td>98</td>
      <td>2.40</td>
      <td>2.64</td>
      <td>0.28</td>
      <td>1.37</td>
      <td>3.70</td>
      <td>1.18</td>
      <td>2.69</td>
      <td>1020</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71</th>
      <td>13.86</td>
      <td>1.51</td>
      <td>2.67</td>
      <td>25.0</td>
      <td>86</td>
      <td>2.95</td>
      <td>2.86</td>
      <td>0.21</td>
      <td>1.87</td>
      <td>3.38</td>
      <td>1.36</td>
      <td>3.16</td>
      <td>410</td>
    </tr>
    <tr>
      <th>106</th>
      <td>12.25</td>
      <td>1.73</td>
      <td>2.12</td>
      <td>19.0</td>
      <td>80</td>
      <td>1.65</td>
      <td>2.03</td>
      <td>0.37</td>
      <td>1.63</td>
      <td>3.40</td>
      <td>1.00</td>
      <td>3.17</td>
      <td>510</td>
    </tr>
    <tr>
      <th>14</th>
      <td>14.38</td>
      <td>1.87</td>
      <td>2.38</td>
      <td>12.0</td>
      <td>102</td>
      <td>3.30</td>
      <td>3.64</td>
      <td>0.29</td>
      <td>2.96</td>
      <td>7.50</td>
      <td>1.20</td>
      <td>3.00</td>
      <td>1547</td>
    </tr>
    <tr>
      <th>92</th>
      <td>12.69</td>
      <td>1.53</td>
      <td>2.26</td>
      <td>20.7</td>
      <td>80</td>
      <td>1.38</td>
      <td>1.46</td>
      <td>0.58</td>
      <td>1.62</td>
      <td>3.05</td>
      <td>0.96</td>
      <td>2.06</td>
      <td>495</td>
    </tr>
    <tr>
      <th>102</th>
      <td>12.34</td>
      <td>2.45</td>
      <td>2.46</td>
      <td>21.0</td>
      <td>98</td>
      <td>2.56</td>
      <td>2.11</td>
      <td>0.34</td>
      <td>1.31</td>
      <td>2.80</td>
      <td>0.80</td>
      <td>3.38</td>
      <td>438</td>
    </tr>
  </tbody>
</table>
<p>142 rows × 13 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-ec69aec0-9520-4767-899b-ead0eb62f8ce')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-ec69aec0-9520-4767-899b-ead0eb62f8ce button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-ec69aec0-9520-4767-899b-ead0eb62f8ce');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-ffa70229-6a26-458e-92c5-da2c92dba7d1">
  <button class="colab-df-quickchart" onclick="quickchart('df-ffa70229-6a26-458e-92c5-da2c92dba7d1')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-ffa70229-6a26-458e-92c5-da2c92dba7d1 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_n</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_n</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Projetar modelo de autoencoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">autoencoder</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">code_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="n">input_x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,))</span>
    <span class="n">xe</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">input_x</span><span class="p">)</span>
    <span class="n">xe</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">xe</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">code_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">xe</span><span class="p">)</span>
    <span class="n">xd</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;decoder&#39;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">output_xd</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">xd</span><span class="p">)</span>
    <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">output_xd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">autoencoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### definir sementes, instanciar AE, compilar e treinar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_n</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(142, 13)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">code_dims</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># instanciar AE</span>
<span class="c1"># compilar AE</span>
<span class="c1"># treinar AE</span>
<span class="n">autoencoder1</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="p">(</span><span class="n">X_train_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">code_dims</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">autoencoder1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">))</span>
<span class="n">hist1</span> <span class="o">=</span> <span class="n">autoencoder1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">X_train_n</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># computa erro de treinamento</span>
<span class="n">scores1</span> <span class="o">=</span> <span class="n">autoencoder1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">X_train_n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5/5 [==============================] - 0s 3ms/step - loss: 0.6275
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># montar decoder, gerar array com 2000 x 3 numeros aleatorios, e escalar para -1,1</span>
<span class="c1"># passar array pelo decoder, obtendo um dataset artificial</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decoder_ae</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;decoder&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder1</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">z_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">z_sample</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">z_sample</span><span class="p">)</span>

<span class="n">train_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">decoder_ae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">z_sample</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63/63 [==============================] - 0s 2ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># treinar KNN (K=5) com base de dados original</span>
<span class="c1"># usá-lo para rotular o dataset artificial</span>
<span class="c1"># selecionar apenas as instancias artificiais que receberam probabilidade maxima &gt;= 0.99</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>

<span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Predicting labels for the unlabeled data</span>
<span class="n">y_augmented</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_aug</span><span class="p">)</span>
<span class="n">prob_augmented</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_aug</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">max_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prob_augmented</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">selected_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_probs</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">train_aug_selected</span> <span class="o">=</span> <span class="n">train_aug</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span>
<span class="n">y_augmented</span> <span class="o">=</span> <span class="n">y_augmented</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total selected: </span><span class="si">{</span><span class="n">train_aug_selected</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total selected: 962
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># treinar classificadores SVM com a base original e artificial</span>
<span class="c1"># avaliar ambos no teste original, usando acuracia</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf1</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="n">clf1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">score1</span> <span class="o">=</span> <span class="n">clf1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_n</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="n">clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_aug_selected</span><span class="p">,</span> <span class="n">y_augmented</span><span class="p">)</span>
<span class="n">score2</span> <span class="o">=</span> <span class="n">clf2</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_n</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acc Original = </span><span class="si">{</span><span class="n">score1</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acc Augmented = </span><span class="si">{</span><span class="n">score2</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Acc Original = 97.2%
Acc Augmented = 91.7%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Código complementar - para entendimento da base artificial</span>

<span class="c1">### Obter características a partir da camada de código do autoencoder</span>
<span class="c1">### - para a base original</span>
<span class="c1">### - para a base artificial selecionada</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_model1</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder1</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_n</span><span class="p">))</span>
<span class="n">code_augmented</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_model1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_aug_selected</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2/2 [==============================] - 0s 4ms/step
45/45 [==============================] - 0s 1ms/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Exibir as duas primeiras caracerísticas para análise visual</span>
<span class="n">size_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">code_test</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">code_test</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">legend1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">scatter</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Classes&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Espaço latente Teste&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Espaço latente Teste&#39;)
</pre></div>
</div>
<img alt="../_images/24b3d347dc4a82f391b60a24a3f596ee72fc642e3a21071256c37242c419549a.png" src="../_images/24b3d347dc4a82f391b60a24a3f596ee72fc642e3a21071256c37242c419549a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Exibir as duas primeiras caracerísticas para análise visual</span>
<span class="n">size_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_aug_selected</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">code_augmented</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">code_augmented</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_augmented</span><span class="p">[:</span><span class="n">size_sample</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">legend1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">scatter</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Classes&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">legend1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Espaço latente Dados Gerados&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Espaço latente Dados Gerados&#39;)
</pre></div>
</div>
<img alt="../_images/22b8433e26697119c8430a3a15dfd56616bd1194bc9883cacb7df2751f202199.png" src="../_images/22b8433e26697119c8430a3a15dfd56616bd1194bc9883cacb7df2751f202199.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="id111">
<h3>Questão 5)<a class="headerlink" href="#id111" title="Permalink to this heading">#</a></h3>
<p>Nessa questão você deverá projetar e treinar um Autoencoder para posteriormente utilizar o seu Encoder como forma de reduzir dimensionalidade. Siga como base o código disponível no notebook, e preencha com seu código conforme necessário para cumprir as tarefas a seguir.</p>
<p>Carregue a base de dados <code class="docutils literal notranslate"><span class="pre">wine.csv</span></code>, com uma divisão hold-out utilizando os 80% exemplos iniciais para treinamento e os restantes para teste. Utilizaremos um StandardScaler para pré-processar os dados antes de utilizá-los no experimento.</p>
<p>Projete um Denoising Autoencoder (o dropout na camada de entrada irá gerar o ruído) para produzir uma projeção em 1 dimensão, com as seguintes camadas:</p>
<ul class="simple">
<li><p>Entrada (com as dimensões originais da base de dados)</p></li>
<li><p>Dropout de 0.25</p></li>
<li><p>Camada densas com 8 neurônios, ativação tangente hiperbólica</p></li>
<li><p>Camada densa com 1 neurônio (camada de código), ativação tangente hiperbólica</p></li>
<li><p>Camada densas com 8 neurônios, ativação tangente hiperbólica</p></li>
<li><p>Camada densa de saída (com as dimensões originais da base de dados), ativação tangente hiperbólica</p></li>
</ul>
<p>Realize 5 experimentos (treinamentos) com as sementes 1, 3, 5, 7 e 13. Inicialize as sementes <code class="docutils literal notranslate"><span class="pre">seed()</span></code> e <code class="docutils literal notranslate"><span class="pre">set_seed()</span></code> antes de instanciar o modelo, compilar e treinar (com o conjunto de treinamento).</p>
<p>Em todas as rodadas, utilize a função de custo mean squared error (MSE), otimizador Adam com taxa 0.001, batchsize 4 e treine por 300 épocas.</p>
<p>Após cada treinamento:</p>
<ol class="arabic simple">
<li><p>Calcule o MSE (do autoencoder) no conjunto de teste (use o método <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>)</p></li>
<li><p>Obtenha as características a partir do código de 1 dimensões para o conjunto de treinamento e de teste. Treine um classificador SVM (utilizando <code class="docutils literal notranslate"><span class="pre">SVC(C=1,</span> <span class="pre">random_state=seed,</span> <span class="pre">kernel=&quot;linear&quot;)</span></code>, sendo <code class="docutils literal notranslate"><span class="pre">seed</span></code> a mesma do treinamento da rede neural, com o código de treinamento. Calcule a acurácia obtida pelo SVM no conjunto de teste (utilizando também as características obtidas a partir do autoencoder).</p></li>
</ol>
<p>Os valores observados da média do MSE no teste do autoencoder, e média da acurácia de classificação SVM no teste estão em qual intervalo?</p>
<p>(a) MSE =[0.49, 0.60]; Acurácia = [0.65, 0.74] <br>
(b) MSE =[0.49, 0.60]; Acurácia = [0.78, 0.87] <br>
(c) MSE =[0.19, 0.30]; Acurácia = [0.78, 0.87] <br>
<font color='red'>(d) MSE =[0.49, 0.60]; Acurácia = [0.90, 0.99] <br></font>
(d) MSE =[0.19, 0.30]; Acurácia = [0.90, 0.99] <br></p>
<p><strong>Justificativa</strong>: Ver código abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>

<span class="c1"># Carregar os dados do conjunto de dados Wine da UCI</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/wine/wine.data&quot;</span>
<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Class&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Alcohol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Malic acid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ash&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Alcalinity of ash&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Magnesium&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total phenols&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Flavanoids&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Nonflavanoid phenols&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proanthocyanins&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Color intensity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Hue&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OD280/OD315 of diluted wines&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Proline&#39;</span>
<span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">classif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Features: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df_features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df_features</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">classif</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de treinamento:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exemplos de teste:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_n</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_n</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Class  Alcohol  Malic acid   Ash  Alcalinity of ash  Magnesium  \
0      1    14.23        1.71  2.43               15.6        127   
1      1    13.20        1.78  2.14               11.2        100   
2      1    13.16        2.36  2.67               18.6        101   
3      1    14.37        1.95  2.50               16.8        113   
4      1    13.24        2.59  2.87               21.0        118   

   Total phenols  Flavanoids  Nonflavanoid phenols  Proanthocyanins  \
0           2.80        3.06                  0.28             2.29   
1           2.65        2.76                  0.26             1.28   
2           2.80        3.24                  0.30             2.81   
3           3.85        3.49                  0.24             2.18   
4           2.80        2.69                  0.39             1.82   

   Color intensity   Hue  OD280/OD315 of diluted wines  Proline  
0             5.64  1.04                          3.92     1065  
1             4.38  1.05                          3.40     1050  
2             5.68  1.03                          3.17     1185  
3             7.80  0.86                          3.45     1480  
4             4.32  1.04                          2.93      735  
Features: [&#39;Alcohol&#39;, &#39;Malic acid&#39;, &#39;Ash&#39;, &#39;Alcalinity of ash&#39;, &#39;Magnesium&#39;, &#39;Total phenols&#39;, &#39;Flavanoids&#39;, &#39;Nonflavanoid phenols&#39;, &#39;Proanthocyanins&#39;, &#39;Color intensity&#39;, &#39;Hue&#39;, &#39;OD280/OD315 of diluted wines&#39;, &#39;Proline&#39;]
(178, 13)
Exemplos de treinamento: 142
Exemplos de teste: 36
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">deep_autoencoder</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">code_dim</span><span class="p">,</span> <span class="n">n_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="n">input_data</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">code_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">autoencoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">code_dims</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0025</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lr</span>

<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seeds_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>

<span class="n">mse_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">acc_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">seeds_list</span><span class="p">:</span>
    <span class="n">seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Seed: </span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">autoencoder2</span> <span class="o">=</span> <span class="n">deep_autoencoder</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">X_train_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">code_dims</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">autoencoder2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">))</span>
    <span class="n">hist2</span> <span class="o">=</span> <span class="n">autoencoder2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">X_train_n</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">],</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">scores2</span> <span class="o">=</span> <span class="n">autoencoder2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">X_train_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE treinamento: </span><span class="si">{</span><span class="n">scores2</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">scores3</span> <span class="o">=</span> <span class="n">autoencoder2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_n</span><span class="p">,</span> <span class="n">X_test_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE teste: </span><span class="si">{</span><span class="n">scores3</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores3</span><span class="p">)</span>

    <span class="n">code_modelae</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">autoencoder2</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">autoencoder2</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">code_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_modelae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">clf2</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">sd</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="n">clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">code_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">code_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">code_modelae</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">clf2</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">code_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SVM accuracy: </span><span class="si">{</span><span class="n">score</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">acc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seed: 1
MSE treinamento: 0.5352
MSE teste: 0.5502
SVM accuracy: 100.0

Seed: 3
MSE treinamento: 0.5681
MSE teste: 0.5922
SVM accuracy: 100.0

Seed: 5
MSE treinamento: 0.5855
MSE teste: 0.6089
SVM accuracy: 86.1

Seed: 7
MSE treinamento: 0.5594
MSE teste: 0.5804
SVM accuracy: 94.4

Seed: 13
MSE treinamento: 0.6018
MSE teste: 0.6316
SVM accuracy: 91.7
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSE médio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mse_list</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acurácia média: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc_list</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE médio: 0.59
Acurácia média: 0.94
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist2</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7e90401c49d0&gt;]
</pre></div>
</div>
<img alt="../_images/b80bfd2c14128128a3bb940c8ce01e56bf71a3446ae7b5cc170e6f98561ad27e.png" src="../_images/b80bfd2c14128128a3bb940c8ce01e56bf71a3446ae7b5cc170e6f98561ad27e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Predicoes do último classificador</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">code_test</span><span class="p">)</span>

<span class="c1"># Matriz de confusão</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - último classificador do experimento&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cc4c9417c0a63662a4678189109c69ba6033fb6fd9fbaa09b214f91ee7436ec3.png" src="../_images/cc4c9417c0a63662a4678189109c69ba6033fb6fd9fbaa09b214f91ee7436ec3.png" />
</div>
</div>
</section>
<section id="span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-spa">
<h3><span style="color:darkred">Módulo 8 -  Introdução ao Aprendizado por Reforço&lt;/spa<a class="headerlink" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-spa" title="Permalink to this heading">#</a></h3>
</section>
<section id="span-style-color-darkred-avaliacao-respostas">
<h3><span style="color:darkred">Avaliação&lt;respostas<a class="headerlink" href="#span-style-color-darkred-avaliacao-respostas" title="Permalink to this heading">#</a></h3>
</section>
<hr class="docutils" />
<section id="id112">
<h3>Questão 1)<a class="headerlink" href="#id112" title="Permalink to this heading">#</a></h3>
<p>Qual das alternativas melhor descreve o processo de treinamento de um modelo de aprendizado por reforço?</p>
<p>(a) Aprender a classificar exemplos anotados de uma base de dados, de forma a  possibilitar inferir ações futuras para exemplos não vistos durante o treinamento<br>
<span style="color:red">(b) Aprender a selecionar as melhores ações em cada estado, estimando a maior recompensa futura com base em múltiplos experimentos simulados<br></span>
(c) Buscar em uma base de ações disponíveis aquela que seja mais similar à ações anteriores de forma a ter maior estabilidade nas ações futuras<br>
(d) Encontrar similaridades em um espaço de ações e estados, de forma que seja possível entender como se agrupam as ações, ou seja, quais subconjuntos de ações e estados são similares, e quais são distintos, permitindo agrupá-los pelo nível de recompensa. <br>
(e) Aprender usando busca exaustiva, avaliando em cada estado todas as ações possíveis e, em cada episódio, caso uma ação gere baixa recompensa, voltar atrás nos estados anteriores para rever as ações tomadas e maximizar a recompensa naquele episódio.<br></p>
</section>
</section>
<hr class="docutils" />
<section id="id113">
<h2>Questão 2)<a class="headerlink" href="#id113" title="Permalink to this heading">#</a></h2>
<p>Quais algoritmos representam as duas principais abordagens no treinamento de modelos de aprendizado por reforço?</p>
<p><span style="color:red">(a) Aprendizado da função valor e Aprendizao de políticas de seleção de ações<br></span>
(b) Otimização da Máxima Recompensa e Aprendizado por Agente-Estado-Ambiente<br>
(c) Actor-Critic e Feed-forward network<br>
(d) Adam e Momentum<br>
(e) Backpropagation e Stochastic Gradient Descent<br></p>
<hr class="docutils" />
<section id="id114">
<h3>Questão 3)<a class="headerlink" href="#id114" title="Permalink to this heading">#</a></h3>
<p>Ao usar uma rede neural para otimizar algoritmos de aprendizado por reforço, considerando Policy Learning e Value Learning, dado como entrada um estado atual, como deve ser projetada a tarefa de forma a gerar uma saída da rede neural condizente com essas abordagens?</p>
<p>a) Policy: classificação da ação que obterá a maior recompensa. Value: regressão do valor de recompensa de todas as ações disponíveis<br>
(b) Policy: regressão do valor de recompensa de todas as ações disponíveis. Value: classificação selecionando a ação de maior valor futuro; <br>
(c) Policy: classificação da ação que obterá a menor recompensa, de forma a evitá-la. Value: classificação da ação de maior recompensa selecionando-a diretamente<br>
(d) Policy: classificação do próximo estado. Value: regressão do valor de recompensa de todas as ações disponíveis<br>
<span style="color:red"> (e) Policy: classificação da política que gerará a melhor estratégia. Value: classificação da ação que obterá a maior recompensa<br></span></p>
</section>
<hr class="docutils" />
<section id="id115">
<h3>Questão 4)<a class="headerlink" href="#id115" title="Permalink to this heading">#</a></h3>
<p>Usando as biblioteca <code class="docutils literal notranslate"><span class="pre">gymnasium</span></code> carregue os ambientes “Blackjack-v1”, “CliffWalking-v0” e “Pendulum-v1”:</p>
<p>Como é o espaço de ações possíveis desses ambientes?</p>
<p>(a) Blackjack: discreto com 2 ações, CliffWalking: discreto com 2 ações, Pendulum: contínuo com valores entre -1.0, 1.0 <br>
(b) Blackjack: discreto com 3 ações, CliffWalking: discreto com 2 ações, Pendulum: contínuo com valores entre -1.0, 1.0<br>
(c) Blackjack: discreto com 2 ações, CliffWalking: discreto com 3 ações, Pendulum: contínuo com valores entre -1.0, 1.0<br>
<span style="color:red">(d) Blackjack: discreto com 2 ações, CliffWalking: discreto com 3 ações, Pendulum: contínuo com valores entre -2.0, 2.0<br> </span>
(e) Blackjack: discreto com 3 ações, CliffWalking: discreto com 3 ações, Pendulum: contínuo com valores entre -2.0, 2.0<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Blackjack </span>

<span class="n">env1</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Blackjack-v1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tuple(Discrete(32), Discrete(11), Discrete(2))
Discrete(2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#CliffWalking-v0 </span>

<span class="n">env1</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CliffWalking-v0&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Discrete(48)
Discrete(4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pendulum</span>

<span class="n">env1</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Pendulum-v1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Box([-1. -1. -8.], [1. 1. 8.], (3,), float32)
Box(-2.0, 2.0, (1,), float32)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id116">
<h3>Questão 5)<a class="headerlink" href="#id116" title="Permalink to this heading">#</a></h3>
<p>Carregue o ambiente <code class="docutils literal notranslate"><span class="pre">FrozenLake-v1</span></code> conforme o código do notebook. Este ambiente faz parte dos ambientes Toy Text, que contêm informações gerais sobre o ambiente.</p>
<p>Frozen Lake envolve atravessar um lago congelado do início ao objetivo sem cair em nenhum buraco, andando sobre o lago congelado. O jogador pode nem sempre se mover na direção pretendida devido à natureza escorregadia do lago congelado.</p>
<p>Espaço de Ação: são possíveis as seguintes ações, indicando em que direção mover o jogador. <br>
0: Mover para a esquerda <br>
1: Mover para baixo <br>
2: Mover para a direita <br>
3: Mover para cima <br></p>
<p>Espaço de Observação: a observação é um valor que representa a posição atual do jogador como <code class="docutils literal notranslate"><span class="pre">current_row</span> <span class="pre">*</span> <span class="pre">nrows</span> <span class="pre">+</span> <span class="pre">current_col</span></code> (onde tanto a linha quanto a coluna começam em 0). <br>
Por exemplo, a posição do objetivo em um mapa de tamanho 4x4 pode ser calculada da seguinte forma: <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">*</span> <span class="pre">4</span> <span class="pre">+</span> <span class="pre">3</span> <span class="pre">=</span> <span class="pre">15</span></code>. O número de observações possíveis depende do tamanho do mapa. <br></p>
<p>Recompensas: <br>
- Alcançar o objetivo: +1 <br>
- Chegar a um buraco: 0 <br>
- Chegar a uma área congelada: 0 <br></p>
<p>Estados de Fim do Episódio:<br></p>
<ul class="simple">
<li><p>O jogador se move para um buraco.<br></p></li>
<li><p>O jogador alcança o objetivo (posição específica do mapa)<br></p></li>
</ul>
<p>Execute 100 mil episódios aleatórios, amostrando aleatoriamente (sample) do espaço de ações. Cada episódio deve executar até chegar ao fim.<br></p>
<p>Calcule e indique a alternativa correta dentro ds intervalos de:<br></p>
<ul class="simple">
<li><p>Média de ações por episódio (MA)<br></p></li>
<li><p>Porcentagem de episódios com sucesso (PS)<br></p></li>
<li><p>Porcentagem de episódios com falha (PF)<br></p></li>
</ul>
<p>Para as porcentagens, considere valores do tipo XXX%, arredondando casas decimais, por ex.: 5%, 100%.<br></p>
<p>(a) MA = [5,10]; PS = [0%,2%]; PF = [98%,100%]<br>
(b) MA = [5,10]; PS = [10%,15%]; PF = [85%,90%]<br>
(c) MA = [5,10]; PS = [45%,50%]; PF = [50%,55%]<br>
(d) MA = [11,16]; PS = [10%,15%]; PF = [85%,90%]<br>
(e) MA = [11,16]; PS = [45%,50%]; PF = [50%,55%]<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;FrozenLake-v1&quot;</span><span class="p">,</span> <span class="n">map_name</span><span class="o">=</span><span class="s2">&quot;4x4&quot;</span><span class="p">,</span> <span class="n">is_slippery</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Discrete(16)
Discrete(4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_episodios</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">episodios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_episodios</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>


<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_episodios</span><span class="p">):</span>
    <span class="n">observation</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">terminated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">terminated</span> <span class="ow">or</span> <span class="n">truncated</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="n">episodios</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">steps</span><span class="p">]</span>

    
<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Média de observações:</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Média de observações&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">episodios</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

<span class="c1">#Média de passos:</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Média de passos&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">episodios</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Média de observações 6.45
Média de passos 7.65
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Porcentagem de episódios com acertos e falhas</span>
<span class="n">teste</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">episodios</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">teste</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">acertos</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
<span class="n">falhas</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Número de episódios com acertos:&#39;</span><span class="p">,</span> <span class="n">acertos</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Percentual de episódios com acertos:&quot;</span> <span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">acertos</span><span class="o">/</span><span class="n">n_episodios</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;%&#39;</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Percentual de episódios com falhas:&quot;</span> <span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">falhas</span><span class="o">/</span><span class="n">n_episodios</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;%&#39;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de episódios com acertos: 1362
Percentual de episódios com acertos: 1.36 %
Percentual de episódios com falhas: 98.64 %
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-darkred-modulo-vii-introducao-ao-aprendizado-por-reforco-span">
<h2><span style="color:darkred">Módulo VII -  Introdução ao Aprendizado por Reforço</span><a class="headerlink" href="#span-style-color-darkred-modulo-vii-introducao-ao-aprendizado-por-reforco-span" title="Permalink to this heading">#</a></h2>
<section id="id117">
<h3><span style="color:darkred">Exercícios (com soluções)</span><a class="headerlink" href="#id117" title="Permalink to this heading">#</a></h3>
</section>
</section>
<section id="id118">
<h2>Parte 1: Exercícios essenciais<a class="headerlink" href="#id118" title="Permalink to this heading">#</a></h2>
<section id="id119">
<h3>Exercício 1)<a class="headerlink" href="#id119" title="Permalink to this heading">#</a></h3>
<p>Qual alternativa descreve a comparação entre os objetivos da análise de agrupamentos e o aprendizado por reforço?</p>
<p><font color='red'>(a) A análise de agrupamentos visa encontrar estrutura nos dados com base na similaridade ou diferença em suas características, enquanto que o aprendizado por reforço objetiva maximizar recompensa futura mapeando observações em ações por meio de uma política<br></font>
(b) A análise de agrupamentos e aprendizado por reforço não possuem supervisão, possuindo algoritmos para treinamento similar, sua diferença está apenas na formulação do problema<br>
(c) A análise de agrupamentos é não supervisionada, enquanto que o aprendizado por reforço é semi-supervisionado<br>
(d) A análise de agrupamentos visa encontrar estrutura nos dados com base em suas características, enquanto que o por reforço visa encontrar um mapeamento entre características e as melhores ações possíveis segundo previamente rotuladas por um especialista<br></p>
<p><strong>Justificativa</strong>: A análise de agrupamento é um método não supervisionado para encontrar (dis)similaridade entre exemplos. O aprendizado por reforço também pode ser considerado sem supervisão no sentido de não haver anotações ou rotulos manualmente definidos - assim não é supervisionado nem semi-supervisionado. Apesar de ambas não supervisionadas, aprendizado por reforço e agrupamentos são tarefas distintas e requerem algoritmos diferentes.</p>
</section>
<hr class="docutils" />
<section id="id120">
<h3>Exercício 2)<a class="headerlink" href="#id120" title="Permalink to this heading">#</a></h3>
<p>São componentes fundamentais do aprendizado por reforço:</p>
<p>(a) Policy learning, estados e redes neurais profundas<br>
(b) Histórico, camadas convolucionais, agente e inicialização<br>
<font color='red'>(c) Agente, ambiente, estado, política de ação e função valor</font><br>
(d) Value learning, estados e redes neurais profundas<br></p>
<p><strong>Justificativa</strong>: Redes neurais profundas e camadas convolucionais podem fazer parte de uma solução para aprendizado por reforço, mas não são compontentes fundamentais.</p>
</section>
<hr class="docutils" />
<section id="id121">
<h3>Exercício 3)<a class="headerlink" href="#id121" title="Permalink to this heading">#</a></h3>
<p>Qual os passos básicos de um algoritmo de aprendizado de políticas (policy learning)?</p>
<p>(a) Inicializar agente, com a política atual executar uma ação, obter uma recompensa, reforçar a política atual se essa produziu recompensa positiva nessa iteração.<br>
(b) Inicializar agente, executar política até estado terminal, e repetir esse processo múltiplas vezes, selecionando o episódio com a maior recompensa total<br>
<font color='red'>(c) Inicializar agente, executar política até estado terminal, armazenar: estados, ações e recompensas, reduzir probabilidade de ações com baixa recompensa, Aumentar probabilidade de ações com alta recompensa</font><br>
(d) Inicializar agente, utilizar rede neural para otimizar a melhor política em cada ação realizada.<br></p>
<p><strong>Justificativa</strong>: O Policy learning executa política até o estado terminal para determinar as recompensas, não sendo um método que adapta por passo/iteração, mesmo quando usando uma rede neural. O processo é repetido múltiplas vezes mas todos os episódios são usados para adaptação do modelo, não apenas o com maior recompensa</p>
</section>
<hr class="docutils" />
<section id="id122">
<h3>Exercício 4)<a class="headerlink" href="#id122" title="Permalink to this heading">#</a></h3>
<p>Dado um problema, como projetá-lo para ser resolvido com aprendizado por reforço?</p>
<p>(a) Organizar os dados em pares <span class="math notranslate nohighlight">\((x,y)\)</span> sendo <span class="math notranslate nohighlight">\(x\)</span> os dados de entrada e <span class="math notranslate nohighlight">\(y\)</span> o espaço de saída ou alvo para que seja aprendido um mapeamento <span class="math notranslate nohighlight">\(X \rightarrow Y\)</span><br>
<font color='red'>(b) Formular o problema como o de um agente que executa ações e maximiza a recompensa dessas ações com base na solução encontrada<br></font>
(c) Coletar dados e organizá-los em uma base dividida em instâncias <span class="math notranslate nohighlight">\(x \in X\)</span> para que sejam inspecionadas por funções de distância e particionar o espaço <span class="math notranslate nohighlight">\(X\)</span><br>
(d) Projetar o problema para funcionar com um agente que explora um ambiente e encontra o resultado por tentativa e erro com backtracking<br></p>
<p><strong>Justificativa</strong>: O problema é sempre colocado no sentido de ações realizadas por um agente a partir de uma política. Não há um espaço de saída explícito, nem divisão em instâncias para particionamento. Ainda, backtracking não é uma estratégia típica de aprendizado por reforço, sendo baseada em múltiplos episódios, ao invés de retornar a um ponto da execução.</p>
</section>
<hr class="docutils" />
<section id="id123">
<h3>Exercício 5)<a class="headerlink" href="#id123" title="Permalink to this heading">#</a></h3>
<p>Carregue o ambiente <code class="docutils literal notranslate"><span class="pre">Pendulum-v1</span></code>. Procure mais obre esse ambiente em <a class="reference external" href="https://gymnasium.farama.org/environments/classic_control/pendulum/">https://gymnasium.farama.org/environments/classic_control/pendulum/</a>.</p>
<p>Como é formulado o espaço de ações e observação desse problema?</p>
<p>a) Espaço de ações: contínuo entre -1 e 1; Espaço de Observações: 2 valores contínuos.<br>
b) Espaço de ações: contínuo entre -1 e 1; Espaço de Observações: 3 valores contínuos.<br>
c) Espaço de ações: contínuo entre -2 e 2; Espaço de Observações: 2 valores contínuos.<br>
<font color='red'> d) Espaço de ações: contínuo entre -2 e 2; Espaço de Observações: 3 valores contínuos.</font><br></p>
<p><strong>Justificativa</strong>: ver abaixo o código.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%%capture</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>gymnasium
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting gymnasium
  Downloading gymnasium-0.29.1-py3-none-any.whl (953 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">953.9/953.9 kB</span> <span class=" -Color -Color-Red">11.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hRequirement already satisfied: numpy&gt;=1.21.0 in /usr/local/lib/python3.10/dist-packages (from gymnasium) (1.23.5)
Requirement already satisfied: cloudpickle&gt;=1.2.0 in /usr/local/lib/python3.10/dist-packages (from gymnasium) (2.2.1)
Requirement already satisfied: typing-extensions&gt;=4.3.0 in /usr/local/lib/python3.10/dist-packages (from gymnasium) (4.5.0)
Collecting farama-notifications&gt;=0.0.1 (from gymnasium)
  Downloading Farama_Notifications-0.0.4-py3-none-any.whl (2.5 kB)
Installing collected packages: farama-notifications, gymnasium
Successfully installed farama-notifications-0.0.4 gymnasium-0.29.1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>

<span class="n">env1</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Pendulum-v1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env1</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>

<span class="n">env2</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Pendulum-v1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env2</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Box([-1. -1. -8.], [1. 1. 8.], (3,), float32)
Box(-2.0, 2.0, (1,), float32)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id124">
<h3>Exercício 6)<a class="headerlink" href="#id124" title="Permalink to this heading">#</a></h3>
<p>Retome o problema do taxi visto em aula. Sem realizar aprendizado, isso é, apenas usando ações aleatórias, defina a semente random.seed(1) e execute 10000 episódios até o fim, armazenando no final de cada episódio a recompensa total obtida e o número de passos necessários para finalizar o episódio. Calcule a média de passos por episódio e a média de recompensas por episódio.</p>
<p>Qual alternativa descreve o valor da média de recompensas e média de passos, sem considerar casas decimais?</p>
<p><font color='red'>a) Média de recompensas é negativa, Média de passos é próxima a 200<br></font>
b) Média de recompensas é negativa, Média de passos é próxima a 50<br>
c) Média de recompensas é positiva, Média de passos é próxima a 200 <br>
d) Média de recompensas é positiva, Média de passos é próxima a 50<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="n">n_episodios</span> <span class="o">=</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/gym/core.py:317: DeprecationWarning: <span class=" -Color -Color-Yellow">WARN: Initializing wrapper in old step API which returns one bool instead of two. It is recommended to set `new_step_api=True` to use new step API. This will be the default behaviour in future.</span>
  deprecation(
/usr/local/lib/python3.10/dist-packages/gym/wrappers/step_api_compatibility.py:39: DeprecationWarning: <span class=" -Color -Color-Yellow">WARN: Initializing environment in old step API which returns one bool instead of two. It is recommended to set `new_step_api=True` to use new step API. This will be the default behaviour in future.</span>
  deprecation(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># historico</span>
<span class="n">episodios</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">recompensas</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">passos</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># episodios</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_episodios</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># episodio atual</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="c1"># realizar acao</span>
        <span class="n">s_n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s_n</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">recompensas</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">passos</span> <span class="o">+=</span> <span class="n">epochs</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">250</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de recompensas por episódio </span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recompensas</span><span class="o">/</span><span class="p">(</span><span class="n">n_episodios</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de passos por episódio </span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">passos</span><span class="o">/</span><span class="p">(</span><span class="n">n_episodios</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Episódio:  10000
Média de recompensas por episódio -771
Média de passos por episódio 196
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="id125">
<h2>Parte 2: Exercícios Complementares<a class="headerlink" href="#id125" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="id126">
<h3>Exercício 7)<a class="headerlink" href="#id126" title="Permalink to this heading">#</a></h3>
<p>Retome o problema do taxi visto em aula, utilizando o mesmo algoritmo de Value Learning, no qual a cada passo utilizamos um método de “exploration” obtendo amostras do espaço de ações por meio do <code class="docutils literal notranslate"><span class="pre">env.action_space.sample()</span></code>. Nesse exercício, vamos executar também “exploitation”. Para isso modifique o treinamento conforme abaixo:</p>
<ol class="arabic simple">
<li><p>Crie uma nova variável <code class="docutils literal notranslate"><span class="pre">tau</span></code> que definirá a chance do algoritmo realizar “exploration”.</p></li>
<li><p>Carregue o pacote <code class="docutils literal notranslate"><span class="pre">random</span></code> e antes dos episódios defina <code class="docutils literal notranslate"><span class="pre">random.seed(1)</span></code></p></li>
<li><p>Substitua a linha em que a ação é selecionada por um condicional:</p>
<ul class="simple">
<li><p>Se <code class="docutils literal notranslate"><span class="pre">random.uniform(0,</span> <span class="pre">1)</span></code> for menor ou igual a <code class="docutils literal notranslate"><span class="pre">tau</span></code>, então realize “exploration” (da mesma forma como estava no algoritmo dado em aula)</p></li>
<li><p>Caso contrário, então realize “exploitation”, isso é, obtendo a ação não aleatória, mas a partir da tabela Q aprendida até agora com <code class="docutils literal notranslate"><span class="pre">np.argmax(q_table[s])</span></code></p></li>
</ul>
</li>
</ol>
<p>Execute dois treinamentos, 1) com <code class="docutils literal notranslate"><span class="pre">tau=0.9</span></code>, 2) com <code class="docutils literal notranslate"><span class="pre">tau=0.3</span></code>, por 3000 episódios, e logo após teste com 50 episódios novos, medindo a média de recompensas totais e média de passos por episódio. Qual foi o resultado, comparativamente?</p>
<p>OBS: lembre-se de definer <code class="docutils literal notranslate"><span class="pre">random.seed(1)</span></code> antes de iniciar cada experimento. Use alpha = 0.1 e gamma = 0.4</p>
<p>a) Maior taxa de <em>exploitation</em> beneficiou o treinamento, o agente alcançou uma política que resultou em menos passos e maior recompensa média, mas mesmo usando mais <strong>exploration</strong> o agente também aprendeu uma política significativamente melhor do que aleatória.<br>
b) Maior taxa de <strong>exploration</strong> beneficiou o treinamento, tendo o agente alcançado uma política que resultou em menos passos e maior recompensa média, enquanto que com maior <em>exploitation</em> o agente não foi capaz de aprender uma política significativamente melhor do que aleatória.<br>
c) Os resultados foram muito similares, não sendo possível dizer qual abordagem é melhor, ambas obtiveram alguma melhoria no sentido da política aprendida<br>
<font color='red'>d) Maior taxa de <strong>exploration</strong> beneficiou o treinamento, o agente alcançou uma política que resultou em menos passos e maior recompensa média, mas mesmo usando mais <em>exploitation</em> o agente também aprendeu uma política significativamente melhor do que aleatória.<br></font></p>
<p><strong>Justificativa</strong>: Notar que, ao menos nos primeiros 3000 episódios uma taxa baixa de exploration impede o agente de explorar novas ações, sendo benéfico uma taxa alta de exploration e baixa de exploitation. Uma opção é aumentar a taxa de exploitation conforme aumenta o número de episódios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="n">n_episodios</span> <span class="o">=</span> <span class="mi">3000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/gym/core.py:317: DeprecationWarning: <span class=" -Color -Color-Yellow">WARN: Initializing wrapper in old step API which returns one bool instead of two. It is recommended to set `new_step_api=True` to use new step API. This will be the default behaviour in future.</span>
  deprecation(
/usr/local/lib/python3.10/dist-packages/gym/wrappers/step_api_compatibility.py:39: DeprecationWarning: <span class=" -Color -Color-Yellow">WARN: Initializing environment in old step API which returns one bool instead of two. It is recommended to set `new_step_api=True` to use new step API. This will be the default behaviour in future.</span>
  deprecation(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tabela Q</span>
<span class="n">q_table1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>

<span class="n">q_table1</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># hiperparametros</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># taxa de aprendizado</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># desconto de recompensas futuras</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># taxa de exploration</span>

<span class="c1"># historico</span>
<span class="n">episodios</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># episodios</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_episodios</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">epochs</span><span class="p">,</span> <span class="n">recompensas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># episodio atual</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tau</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="c1"># exploration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table1</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="c1"># exploitation</span>

        <span class="c1"># realizar acao</span>
        <span class="n">s_n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1"># estado subsequente s_n</span>

        <span class="c1"># salvo o valor atual para (s,a) - Q(s,a)</span>
        <span class="n">valor_ant</span> <span class="o">=</span> <span class="n">q_table1</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>

        <span class="c1"># verifica proximo valor</span>
        <span class="n">prox_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">q_table1</span><span class="p">[</span><span class="n">s_n</span><span class="p">])</span>

        <span class="c1"># combina com desconto na recompensa futura</span>
        <span class="n">novo_valor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">valor_ant</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">gamma</span><span class="o">*</span><span class="n">prox_max</span><span class="p">)</span>
        <span class="n">q_table1</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">novo_valor</span>

        <span class="c1"># atualiza estado</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s_n</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Episódio:  3000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_episodios_teste</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">total_epochs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total_recs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_episodios_teste</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">epochs</span><span class="p">,</span> <span class="n">rec_total_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table1</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">rec_total_i</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">total_epochs</span> <span class="o">+=</span> <span class="n">epochs</span>
    <span class="n">total_recs</span> <span class="o">+=</span> <span class="n">rec_total_i</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de recompensas totais: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_recs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de passos por episódio: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_epochs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Média de recompensas totais: 0.12
Média de passos por episódio: 20.04
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="c1"># tabela Q</span>
<span class="n">q_table2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>

<span class="n">q_table2</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># hiperparametros</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># taxa de aprendizado</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># desconto de recompensas futuras</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># taxa de exploration</span>

<span class="c1"># historico</span>
<span class="n">episodios</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># episodios</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_episodios</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">epochs</span><span class="p">,</span> <span class="n">recompensas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># episodio atual</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tau</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span> <span class="c1"># exploration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table2</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="c1"># exploitation</span>

        <span class="c1"># realizar acao</span>
        <span class="n">s_n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1"># estado subsequente s_n</span>

        <span class="c1"># salvo o valor atual para (s,a) - Q(s,a)</span>
        <span class="n">valor_ant</span> <span class="o">=</span> <span class="n">q_table2</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>

        <span class="c1"># verifica proximo valor</span>
        <span class="n">prox_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">q_table2</span><span class="p">[</span><span class="n">s_n</span><span class="p">])</span>

        <span class="c1"># combina com desconto na recompensa futura</span>
        <span class="n">novo_valor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">valor_ant</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">gamma</span><span class="o">*</span><span class="n">prox_max</span><span class="p">)</span>
        <span class="n">q_table2</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">novo_valor</span>

        <span class="c1"># atualiza estado</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s_n</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Episódio:  3000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_episodios_teste</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">total_epochs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total_recs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_episodios_teste</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">epochs</span><span class="p">,</span> <span class="n">rec_total_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table2</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">rec_total_i</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">total_epochs</span> <span class="o">+=</span> <span class="n">epochs</span>
    <span class="n">total_recs</span> <span class="o">+=</span> <span class="n">rec_total_i</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de recompensas totais: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_recs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de passos por episódio: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_epochs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Média de recompensas totais: -116.00
Média de passos por episódio: 124.40
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ação: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recompensa: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">])</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inicializacao</span>
<span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># animacao</span>
<span class="n">rec_total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">epochs</span><span class="p">,</span> <span class="n">rec_total_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table1</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">rec_total</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ansi&#39;</span><span class="p">),</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">r</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recompensa total: &quot;</span><span class="p">,</span> <span class="n">rec_total</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passos até o estado terminal: &quot;</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------+
|R: | : :<span class=" -Color -Color-Bold -Color-Bold-Blue -Color-Bold-Blue-BGYellow">G</span>|
| : | : : |
| : : : : |
| | : | : |
|Y| : |B: |
+---------+
  (Dropoff)

t:  12
Estado:  85
Ação:  5
Recompensa:  20

Recompensa total:  9
Passos até o estado terminal:  12
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id127">
<h3>Exercício 8)<a class="headerlink" href="#id127" title="Permalink to this heading">#</a></h3>
<p>Tente utilizar o mesmo algoritmo anterior, agora para o ambiente <code class="docutils literal notranslate"><span class="pre">MountainCar-v0</span></code>. Logo ao definir a tabela Q surge um erro. Como interpretar esse erro?</p>
<p>a) Esse problema é muito simples e contem poucas ações assim não conseguimos definir a tabela Q<br>
b) O espaço de ações desse problema não é discreto. Assim, não é possível definir diretamente um número de colunas para a tabela<br>
<font color='red'>c) O espaço de observações (ou quantidade de estados) desse problema não é discreto. Assim, não é possível definir diretamente um número de linhas para a tabela<br></font>
d) O espaço de ações e de observações (ou quantidade de estados) são contínuos não permitindo encontrar diretamente um número de elementos para a tabela<br></p>
<p><strong>Justificativa</strong>: O espaço de observações do problema tem valores contínuos, e portanto há um grande número de possíveis estados, não sendo possível definir uma tabela Q discreta diretamente.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">)</span>

<span class="n">n_episodios</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>

<span class="c1"># tabela Q</span>
<span class="n">q_table2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>

<span class="n">q_table2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Box([-1.2  -0.07], [0.6  0.07], (2,), float32) Discrete(3)
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="n">de9415252e7</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> 
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="c1"># tabela Q</span>
<span class="ne">----&gt; </span><span class="mi">8</span> <span class="n">q_table2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> 
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">q_table2</span><span class="o">.</span><span class="n">shape</span>

<span class="ne">AttributeError</span>: &#39;Box&#39; object has no attribute &#39;n&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho do espaço de ações: &quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho do espaço de observacoes: &quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamanho do espaço de ações:  3
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">4</span><span class="n">bea9f5900d4</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho do espaço de ações: &quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tamanho do espaço de observacoes: &quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

<span class="ne">AttributeError</span>: &#39;Box&#39; object has no attribute &#39;n&#39;
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="id128">
<h3>Exercício 9)<a class="headerlink" href="#id128" title="Permalink to this heading">#</a></h3>
<p>Para o caso em que não conseguimos definir uma tabela Q diretamente, considere as seguintes opções:</p>
<p>I - Projetar uma Deep Q-Network que receba o estado e dê como saída os valores preditos para cada ação<br>
II - Projetar um mecanismo basedo em Policy Learning, aprendendo diretamente probabilidades de selecionar ações a partir dos estados<br>
III - Criar múltiplas tabelas Q, uma para cada ação<br>
IV - Projetar um algoritmo de Value learning que aprenda as distribuições dos valores ao invés dos valores diretamente<br></p>
<p>São viáveis as opções:</p>
<p><font color='red'>a) I e II <br></font>
b) I e IV<br>
c) I e III <br>
d) II e IV<br></p>
<p><strong>Justificativa</strong>: A opção I é válida pois uma rede neural é capaz de receber valores contínos e gerar como saída a predição do valor. Já a opção II também é válida pois Policy Learning não precisa de uma tabela Q, apenas otimizar probabilidades relacionadas à política. Finalmente III é inválida pois múltiplas tabelas Q também não dão conta do espaço contínuo, e um algoritmo de Value Learning para aprender distribuições também não resolveria o problema, já que o problema está ao estimar o valor de um estado que é contínuo.</p>
</section>
</section>
<section id="span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-span">
<h2><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span><a class="headerlink" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-span" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-1-biblioteca-gym-e-problemas-benchmark-de-aprendizado-por-reforco-span">
<h3><span style="color:darkred"><strong>Parte 1: Biblioteca Gym e Problemas Benchmark de Aprendizado por Reforço</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-1-biblioteca-gym-e-problemas-benchmark-de-aprendizado-por-reforco-span" title="Permalink to this heading">#</a></h3>
<p>A biblioteca <code class="docutils literal notranslate"><span class="pre">gym</span></code> criada pela OpenAI e a <code class="docutils literal notranslate"><span class="pre">gymnasium</span></code> (fork da biblioteca <code class="docutils literal notranslate"><span class="pre">gym</span></code>) permitem avaliar algoritmos de aprendizado por reforço.</p>
<p>Ela contem vários ambientes modelados nesse paradigma que podem servir para entender melhor como funciona esse tipo de aprendizado</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># visualização no Colab
%%capture
!pip install renderlab
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym2</span>
<span class="kn">import</span> <span class="nn">gym</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">renderlab</span> <span class="k">as</span> <span class="nn">rl</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym2</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Discrete(3)
Box([-1.2  -0.07], [0.6  0.07], (2,), float32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="problema-montain-car">
<h3>Problema “Montain Car”<a class="headerlink" href="#problema-montain-car" title="Permalink to this heading">#</a></h3>
<p>Versão discreta</p>
<p><strong>Observação</strong>:<br>
0 : Posição: [-1.2, 0.6]<br>
1 : Velocidade: [-0.07, 0.07]</p>
<p><strong>Ações</strong>:<br>
0 : Acelerar para Esquerda<br>
1 : Não acelerar<br>
2 : Acelerar para Direita</p>
<p><strong>Recompensas</strong>:<br></p>
<ul class="simple">
<li><p>0 : se o agente atingir a bandeira (posição 0.5)<br></p></li>
<li><p>-1 : se a posição do agente é menor que 0.5</p></li>
</ul>
<p><strong>Término</strong>:</p>
<ul class="simple">
<li><p>Tamanho do episódio maior do que 1000</p></li>
<li><p>Posição do carro maior ou igual a 0.5</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inicializacao e estado inicial</span>
<span class="n">observ0</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posicao, velocidade: &quot;</span><span class="p">,</span> <span class="n">observ0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Posicao, velocidade:  (array([-0.5415739,  0.       ], dtype=float32), {})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># codigo visualizacao Colab</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym2</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCar-v0&quot;</span><span class="p">,</span> <span class="n">render_mode</span> <span class="o">=</span> <span class="s2">&quot;rgb_array&quot;</span><span class="p">)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">RenderFrame</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;./output&quot;</span><span class="p">)</span>

<span class="c1"># codigo local</span>
<span class="c1"># env = gym.make(&quot;MountainCar-v0&quot;)</span>

<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">n_iteracoes</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iteracoes</span><span class="p">):</span>
    <span class="c1"># codigo para rodar localmente</span>
    <span class="c1"># env.render()</span>

    <span class="c1"># obtem acao aleatoriamente</span>
    <span class="n">acao</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

    <span class="c1"># executa acao e obtem observacao/recompensa</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">trunc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">acao</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">, Acao: </span><span class="si">%d</span><span class="s2">, Rec: </span><span class="si">%d</span><span class="s2">, Obs: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">acao</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">fim</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n_iteracoes</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ultima Acao: &quot;</span><span class="p">,</span> <span class="n">acao</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posicao, velocidade finais: &quot;</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio finalizou após </span><span class="si">%d</span><span class="s2"> passos&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">break</span>

<span class="c1"># codigo colab</span>
<span class="n">env</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>

<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1, Acao: 0, Rec: -1, Obs: -0.59, -0.00
101, Acao: 1, Rec: -1, Obs: -0.46, 0.01
201, Acao: 2, Rec: -1, Obs: -0.45, -0.01
301, Acao: 1, Rec: -1, Obs: -0.64, 0.01
401, Acao: 0, Rec: -1, Obs: -0.31, 0.00
501, Acao: 2, Rec: -1, Obs: -0.68, -0.01
601, Acao: 1, Rec: -1, Obs: -0.56, 0.01
701, Acao: 0, Rec: -1, Obs: -0.37, 0.01
801, Acao: 2, Rec: -1, Obs: -0.69, -0.01
901, Acao: 0, Rec: -1, Obs: -0.50, 0.02
Ultima Acao:  1
Posicao, velocidade finais:  [-0.28767648 -0.01108121]
Episódio finalizou após 1000 passos
Moviepy - Building video temp-{start}.mp4.
Moviepy - Writing video temp-{start}.mp4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moviepy - Done !
Moviepy - video ready temp-{start}.mp4
</pre></div>
</div>
<div class="output text_html"><video controls  >
 <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAgdltZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1OSByMjk5MSAxNzcxYjU1IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxOSAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAOFWWIhAAr//7Y5/Msq1xA0DVUuHVl7uFSgaMoZ2nkvUzAAAADAAADAABo/Ot9/srZ0dc2TAAADNAlrD2ajoAyREKrGoBrmFT/jbr+uKV63H+jYfwGJbVbOn0m1S65oHQGpImqAsySWWW5d9HhpxanDBmZZ4hwTZLG5zws+xg1ZHx6j6STz4DqXbkjtj3+BkQFNtJD/LVwfkW6Q1ZyYS5LqWHgxTbDafHmxytMOgl2OiwH+ipXzwuuyhKz4aqAvG/R51rllCin0WqN1BvyulgAJvuWES6pcBaahQ8kjJcvXTs2FQNwlCiejhKF2f6DxTxMC9x7Fq8ScVJXWWN0F+ULtMhKkployw9zRywa6dFRIB4g2vIeFxXVVHY05adbe0p9zi6uVuA6oc/k/yy+4B1upje23oG8MDq9eAZdfd3mrB4453dtBWjYQUzqOIw9sbShslNlO3szVnzmG6AuyCIZRZAU8iSg97YN5LEQDNsSdhk2O2Qykyyk5mJLyrLLuVDYS8vy0y356/FQyKN2JYuyAEvSCTQ1m4ByXG3vh6APai/Td0OkoBiOh3eSz6TfauSbc1nbjgUgOUlF6f28bq27RGk5D5Ylj4wM8IChBPln/Ll6lkMX12yMNdzJnaScs97BqF9BieRGrcxYB44CzS48gzYAjntUY19oNAV9XVRn2SZPmyuVKE+hSJ+gHvDfUBuX4aoH4Y5suNMwHD+Li7dz5/8ypCFXZ9HnLq6iSie0/GA43kkydtzRBW9fwtGy6FtT6bKd+Zf5aoB3auO08n282j5/f2BNxtGEeUi++ydnUf5LPxtepOVFqIG+HUMSIlT4WJL+1FKTEiyJE1BsIud8KhvfPfE2Dj1L9xSD1UGZg1EKMgRtA+0UwtnwwDQLduZwR5kgH6Uev4ZXC4qvgpodYAAAAwAAXUMmffNUWjvKIFXMOWV5wzPloNRcdtHYt/kaJ5OJjAeSZ83W+5gZGzD9gB8zCmD8v7Iaohu7lBakLBewe+WHONcXldVAt+DE+RO7A724ySkuLyXTEtKuX1OEBXwAAjIxAAykDAvKsgdAsJTHmG4+uAkQ//nc14k1G3fG7Ks6JaqzYsMBBve0CFx5JP/oGIAA84GaUh9aP5W68aZT8YT5raZU/f7672qt9JtGNEW9IOqLr3ldRD6415UYLtJMZX3OtZOsUo6YxSbk9OcR/F0d4raBnwv/U72fb7zKKV0j5BdxDD50ApHx1UGkh0+EBCUWqUVKwn6Gx+0OBfPHhfIuyVq/gKY6UoQHMd8c6Ch3fK6ROFM94lxuL2WiWS/o2REHP+nFN6FsSW1CfHMMSwE4fe7ivJvVC6bxBa0B/2QF5f4VRcEpbiQEpgDAISEweYZoleJfeaWwUe2fvYK5EHRi0779rjDf2hzlprMlkA+NQxmYCNeVF4JIygxs1Jgab8clYBWenqXAopMCSnMgfqU/gCzuuORriGX+ZZq3UfPGlrgmle2r8zKphaMKeJOxGLI9wCQwKPWXxsUomRbGUMsi3BfhpU1DnGZK6LwPJv7UCsdVBAnePRHFkwE/BDAFcTk0IHMjrE82H4uFhUREs74eDR+LSqDKWXf1OJMcqdvXx8OuNUNZbBRN+4gRyOuDiZkAY6adXVkwita1KhioQQF+6CPZymDpt5ZQcLGZR/0XTn2uj0P0vsEIz6t8bqShu24muiQC9GDPACJUijluGbr55LQxMEXn3O49snqIGu+gPP1/q7y999lvQ/+zD7AFPH77tjQmzuQrqNMxb+xuQdk2YTo/Xk3VjpvvuPeV5V5RZpWcT56sBZfyksAfLKTt3of5LScuha0bERNOAXGBDo+51HLCkjyEVa+N40s1F5hPdRaxgNnQ2gmppL4j6YmULSCOUTYKm4TLVg1JJ3C9eEDhylu61xk2Fyc/yKE9RQzrZeRGTHLyyw5XGTfWn7XVXku/e03MXR0MBKXQSuT9jMAORL46jzCS+hO+4U+X6UvXVnPo5BXy98WtehDbSE0waE6pAoOXBTbyj2DP77BmDxCj7EEGMs3K7q9xh+fBYo2se1UV9GYt1kHkOmuM0r0q1DNC/38pyWq9CRmVscTBrYQSlFYFcZBU7EZDnAnyLdHf1cIBEdNrYjmXFKTsGzbGk12OkHJLwJjByqek9ekxH4P8ARMTGWPN2aH80hSn3QoJBP9bPEHsOgb/OR10taqjLtRl1ziX7ZkwNKlLfwPO39hp5BNPga8yC9ccOuNCarNhBSn99WloUh6HLXFzDM0xeP/70GTPFuPKnh0pGxBt2kgYX9ab2Jlyl4kcyYrHiELhsdhHOB5bA+h/EX8ZPjEvk8I3mUDfF3u4rk3hK7dzwDqw+6BgHWUBQKGTRnVhSNLNa0PjfVykyVMcLkHLDJvKqr+3a6V28b9mwB45nkvHIMmHqQ/7I5B8LxaVFQUCXCxzUvje7zXfzoUvs8/cFO6MDRfW/5KShuFVr5VvQeKOt9c/sGDjr4OgvTgH/CSF8K1HNbABIXpr09vDGaNafsCwrpDhSrxTZ3Tzi/pBXUo03z5R0Y/vK9bMp2cAE32Q8h4roWsBkMPAoBE2n7u3ogN/1R1WNYr17SBwsRawf+AbmEFfqRkAAB/C/XOMoY7iSjry0Z5KBZ7uSOaWuI92sJZM6kZzIzaVcrYbtlM4/A42BsoEaB/DxJKLF3Y+NERbCbbmAuld5Ml7IJ4b9AfAvSfKKv0Q40HYAksma+BfH3LZpcVW7dcwIZF5BJU1at9Pld412ObFx/r5Lz2aBenwLsnkplRsVkEMz240o8HZhrTABC4GT4pA1uRaqt2bemG2ATQdLuAAmo5S3eD2oy5Ut3Q+lBiXW0HPU0CzfrOlvAwgU2DQp0yiIwSbkLfAKTAOnkOSZDEid7gVGSH7x2m0JLXEhbyMZwn55WTSG8FtbBdizSnYrpszd30/irnaVbzDPSXTpRVv/ON4Ntyc2ZsiadiBFtVv4Js7S5PiBFI/e2gblfj+3aCAzFDV7rwVQyxu6oS8PaFZe1gMyAEpFc0ASMKSKVSrg6sHfnRj7cbSikZN87zW51f1Yz2Lpc06yEBZSD3VMJ63YyHN/bNTuGw7kRqyJFnSuWxmyIh/pM2/YDZUWz3xNmszGdWFRbkJfN8CdIZmveQw6GpLSUVLQRrJK4lDKctbGg7wYEx1+19hHOMnnlGwmIwnHlOuXShVt1NxiBMUE8/vGG+KFTfCWem0rcJy8a99w+Oue2MLtjFJOb4RJ+AIeK5n6tR3BqXhEIefqeuZr9dQWgqr/ShO9pgjN48c6RN5wAmGhQmYemVR/yforMs2C1GNpovLQVvXXXEeicVzsobpwlrHBLh997+DpNlpKQlDlPpFEcDImnmVv/GPn4OU8mn0mpzp48G0AnQ0KLgtfN6Hsah38w4/KdvyvS0B2ElEzGycS0qyLd9D/fA8bSsmycu5maVLs/xegZjuTgPFz2AJ3yAMgIgAGHs2tk3GZhHKrztXvAZclzyn0JoO7cWVnMDCBeX0Lw2MteOKZj/bgokPDNTkVSqFVtZie0gq5xvSszowFBgIqQa8wlL86WHev5gBdOS1v6LTOuuQ1Yj2PGNXJKO7BlvOkXSlilYKCN3t82rnWTbNvEXXbZzALZRmm0XBETfryVBA9wGwM1fXzUrLC9tfKgknjB2iiAjRnugMAbeipr1IEaxMZZAodTPYGeqCoXEUmLym4SEWyUn6pQzOLhbBAJamULeKRDQ9ilmLsPqHzGRmuy8h2QYqrpnWJ9Jk8BW7xqtV5/RtptIJ29QotcFCoAmhsARtHcw+cgn6bYAADLH579X1mMpvTHUtQz+mwL85axHK65EnW15U+3PgnfJufGgwjKR50ARLJiEb2Cf905AcsRQJnagMxn850Tegtg9WmEYXzC8pGDTeP+vFaewPzzmmAaIJ/VE7xuXcUKkrSVbDNeK0BLCrsaXEsoWAe/HS0yXJF6L7kYO7TLPZa38aX8v8lHz+o2MYl9cu2P9u/PR+Dgg/zlt7N8rZcMJWcsrNyHKdzvynwzk/db001v945xJdF4r//HfthaJJ6XfaybXTLKTb+1SUQAvMmmoTVrNNkvPSq5FwbI3v8JkSkD3uxHLlmMQD3SajeGZSq0qGDIJOj8tplvAtqsdQSA+ToewugrR+qC+Se4Wm50n053YSmtzh+YKcJeue+Cy/ULNIpfeLQgxT+SlDCkZghQO/WNacEY7c0pRraxNx15s+Ao31Wbh62aHhkbr/fCp+FZxx1rYxtCrQjX2ARwsVns2NKmQXJs//tuLpCBJSoKbbB2mFdwn/6EMvVwAB72tXLmAk40DyLTuPgo8gAmtenwY9JcewlJcOaZg/MzTz/v3fCYOHNJu1XIfWV/VD6lTHOCMmx4Z/JaB62la6dx6FaZyHjA9sq/8SkQ4hgaJkpFHs/PSEW4E+AELAgpAXpZSA+op1zCrAenmz1g06/JgPdXWr6Iic7kEWQzmo8axuuAg+zb7gSCX+K407FFfEEYYl6hnfHoyoyMiKwNCQDEmouImIGiFfdpavv2QzEnzIKCfc2hSqVdQ9MDjCoDQ8090KbS6ErNVMpJOTjNt1iaEIsudPW9LoQE1iR3XGQqH3blTsqg+eV0O7XtgPkx6M761EVYnr1RLsXQRP9CKxAv7rCdOlV3hlMFisnFy84NrhiFKSidCgw0HVI3HAOxyMFr+Jcc9shsWJXNRCO+g7X8ziwPDidyocppy3yH0MZ6U4J6Xo6ahoYawEaZiRMwcFzAr6mYB8D3HSd0VdOG27N0XQeH1WkAAkYFe3v/UlFZQQoAMfAAAAr0GaJGxCv/44QAACKr+aAMVxXrp13m85KXl8a8X5Oen9UPjC5xJnNWKecZeZFLBfU8eklfHebfHfc8iEmrXhdvguwCj9i1dbMx9SOJbHxObtBTzZxqHPI5cyggG0DAkbQf/dXhLNxlCxhRa6Q6ovxCt1I4y+Dw/LZSkkE1u9BsJ9vlqrSy1E16AWhEeN+PZBHbSAXkM3/zeCIJV0dojf4GJt8sfJK24tEtXuwoT45WAAAAApQZ5CeI//AFY92nMIJsIg4k76/EEvPfcv8U7DDRDWRtTDKN8yxrov3oEAAAAhAZ5hdEb/AAADAADOGgeuipzmfUnGUx0TZCgtKAnUoW8QAAAAHwGeY2pG/wBr20ygADjAAjaw3H7T/r81HmKGdO62+YEAAADLQZpoSahBaJlMCFf//jhAAAGlaBgBSm8Q2v3bcUxCyWtZlWI7xRS6X2+Kb2+8Qa7LXs0a8KP+ETx6FdAy5J4oVdkvr864ELqnTqWYBlURfY36UU9Hl5uDc+ddqOU6Hto9hmPfqmFz2zElc7DkspAecv/8ZDXXxVdyRq2srGDuzCcgJQuwE+AyKQZBio/KOTR2YqYP59yUiV6ZiSVyX5Kc8rmN1B4AkJRPbEu7DUNCAfEQDHgM/vMpvl4utcnEkuwbKa6ov6NsX3JYFFUAAABXQZ6GRREsfwBWPdpgACp37i2xTv/kF8q/ldWkZ4mUiNpvQv+Q5LIAcyK67uqB60mR1cEw1+3fsOeHvePUbYsBt0X5xE9KyLZktZ32qFpHteglYMYIqGCTAAAALgGepXRG/wAAAwAAzhPJfSf4NP4ry6Gny8B/munewnwQAhz3qkKyFMAluuaBdUEAAABGAZ6nakb/AGvbTKAAOKpTnReoiwAFw4OrBSdPFPzvQ9aoHHX5JzyjC0ZGb4BHx3H3LJTDnPvB4MI2dOYr9kdDcoagC9L6oAAAAMhBmqpJqEFsmUwUTCv//jhAAAADAATS4jugAa1gnBCLve15Inf+4sXabYIG93/3xJuZsV2SJ+unNNDxfzztFMCb18hDDLUOVk5oKbl2SPn9N11Rd6x3TeDwiS/wVOcriCeuq7bnSVAf//fC5BBgoSMf9Y9O97zsIsa4V/EVxcTu7E0KQfKWMgthfsl2F6DXB9Y9OTUig7jp9tg66DhPjlhmALaW+PH6uRfHpOTUpjthFmgttoDdmOXDuULHZSmy2hWos+3ue2rSgAAAADsBnslqRv8Aa9tMoAA4h9Y1Q1Xj73ucpa6BU9g+lw4mMoFMACKinVJTeECYqgSCsjMJ//CtxHA7WuqkYQAAAXBBms5J4QpSZTAhX/44QBFA4oBZWEo8RxfBnyk7E9rNtXiprMSexO/XngS9A0OZYE8EvIfz58V3tBa8YudYdMFz4LFsXkaXDKJdW+NUB3CMlTxX6AgaLP9MgN9gmrf3mhPcShqEeRRzZClevVys7rgA7t2+gqhnu00D1Csnz3/pS4CCYL4i1ad5SmJl4MM+uczT/wbzbQY++Tcdd1FEnLwE9lOrZvZJvtsu3HeERF9MGihqH8cC8tYlq6WyHO4dgby1eMSe4ANS5dpvPsZbTwlrZkQzjrDbT7ArYrHjfdl1U7CxvQgwdtlLqyRhKVTgByxud6UxiUZMF4jG+g0zPfpTQcpotL5SNHikEGLtf68xAxaxScx8Jlq0xVlgDxfKDrxVPEdY8MZTsCrcUEE55K1gRsfiMIZcjB7KVh1NW/p5STNH51fwXORWO4GAaFbRRdk/pDGHfSw3dPDBt9Q5mY4hFxhkOV/OrYMW16SddWsAHAAAAIlBnuxFNEx/AjsermX70/BSlTQNf8lje79cuHqD9PsOthCwjGsokuaYuZiXAj3GTuPjtAPqjrrUrN5Dx0Ay0FFJNMUND+hxzqRApvWH0QbbQVIqRWntatoXZTuvHEDodvPc1JWfEib85bg8KPwuXyc7TfyThGIOKAzcPsxLkUfYAptleRnjM95qoAAAAEgBnwt0Rv8Cv895jsoAYzNTa7JymNxz8+7qXrNv02qutm/UR0/gBElfVdCV5ALrb0kLT360v8kMmMP7eDilOcNf62rkv3MQk/kAAABRAZ8Nakb/AsBRlmadfVYNfs0174hBuiArD+1wP6EYGxyyQdERrzY1USVkf0/Ff//usANxdTvh/iKLPmxbLIU6GqjfsS7B6oh5edx/qLsf/P75AAABZEGbEkmoQWiZTAhP//3xACoVo/EIxnwukhRVOkjcLr0uLCAOkGlm2us/uCQOZR72Int7oWHH756xE9hyeu7ndEwSya2Z3MlXSjmMjhb4UEuo7AJkGQWjUd1EwFTsU0+6kHKNSqRSM5ZYC5MHTo6frlvnxcKjoW0xOb3nMDWi2n8nsnil6B/0jgth5ih2Q3q7KSc1MJVcpfGbcds/IQ9hakyBU04A9UxY72onj9ciFeIUqY01pJPYAnx72JHac2DBKbIusbQ7lb2zdypPzac8V51lwko59lhFpv7w6oTFzUtiFfp8qzIC5DEoSzSlNi66PfzArtlhpI2zcNFv/10Crfk+0144vv8+HFx3/zYvTOKG8nVzXmhH830XzmiJf1MBzVg4P2CL/ZWQD3ZbF38w78SYZ3oxxiznSdasN0OzrSpDdn+MUSYz2XexyIzCCihlm0xFDZJdloYyJdhi10d/OyEXowShAAAAi0GfMEURLH8GNCmS5Hu3/YK2xtJKO/GyMIcBDOjVUhJhZbqsV35MbquL+gssPxHNIGOmFwAPgEKp0+8lcpRuP0VgWQMt7e+kEPquFiGyjMGz0eVYn1htv5DDPbzzZgltmbxAz8tM77MZtV4xVRQyWyb0aHBrBuFSKE5FmWcMHz3Glp27vFgw6fzzHqAAAABeAZ9PdEb/B6CB1DTXB6fs/DGjIBWgSViMOGhRG7q8Oja20PC6cWzEYxZl7WRP6+RERiD6DgAr9LuwnzpIee14K2f9cdgLtunveczTt5m+Y14M/g+Y9RDouCquOWnzcAAAAFoBn1FqRv8HoYA89k5gBh6ylPOSSw8IgzUVmbz/mBHofToqRLDCOXoTVjuHqAFoDpUrhPeMW8N3tbliG4Oj2q1MV22rjuEYMBkPgzuUfOV7n00GkzAkZqaK2oUAAADtQZtUSahBbJlMFEwn//3xAAADAAALE5Ryo3Sk4XOvkToZAjpq1nNG3CfTlnr2WyI2PONjTFuvF6nfHtFPki1/JKhVu07ZmRKeUvXhXZz4OefefOODrSQ+1qHm6QsBBLKpuO+UTEJx2Bw+aEn10w+zfk8YAFHzm4d+f+6R2TngiptnsNM90FVORsTV1EA2vkq+x+ijs0jSHbubQ7YrYMNtGZfDFDlvfEiscQbnwOQG2nBKLBiP39rlD+zxl11teo/Q+fCx//Q2+8EFoyp0+cqBBMi5PgkqEHRJzeq+MndpPcv703ocwm0M4z4C2U3bAAAAWwGfc2pG/wBr20yj2JfhEBdN2Dd1mgsGG9M/X6T76uPL2do91rClsvjhIlU8w/gAA11tgKD+tXo3/qP67Re8iLpjiXJ+vG6FkEPf2L8gKqzUqIvylREbZo9FWGgAAAENQZt1SeEKUmUwIV/+OEAAJqJqgJHAAnB7L0S1JvNaD3gpseQDK8+ecCEQZqPavigPnqWOovojatfda3W0k04CM1gAHOU5jcrIPIFPGUP7LHWBk+yN840A9iR9QBBe+jdakiqyjzSxTBHq6GvO+bO8JO2MMREye7mEU7VrVmAOQkeN0P9sYqVOTMXNyp1iesea/RNP6wplzWgx/8zo5x89n5bX9Fx8s8ppyQ93/6M/NGVMTodA7WcTmfDtCxzdQ0OK6t1ZZLaekAYkhDDaIdMwa9CDX9xjMtCgr9WxFWifkqjzr3aP5uL+HD2jJJ9B63NXtpxXmt+NjCX2GwBJvNr1lppY3aWHfpgo7rqJllEAAAEnQZuYSeEOiZTAhP/98QAAAwCLdE23ShxJxu0wi+/LiB5EedzBhS+u9bMBoiuLzNmvXAvV/xZ/BEcMhIIi/UysW3w5j1I22AofZXpmPmP7N8Z9J5GN3DZL4wF9XMO7tQJsO3F2/2eSZFGp020wKVTIXg3vRekWiLxCunWzFllaojPuhSVz+4BlFFSBADD75dyvT8BiuxaWpKp+s1fRzrg/c5XtznHDyjny6ZDkyZ5NTkgAOL0ywQzpCaFtRT1qbWj3blLOTMRY+NHL1CxTXvfqYAL4v3sa7ame0V8gnP4mHGlPL6t88rLpEKuElsEqxXttyTw4s4HXZrc3+1Lnl7X6lqJEtrHjKWJryLngBDvwHNSAmxCtYeelejPazVfRPPgS9E4gTMfhkwAAAIJBn7ZFETx/Aiw6Qn4NZ5rgMvL+ovL+Hg3jAZ0yPOHMhwFvlNP6Wa1aKr8YgvvE1I4hPWQBVc/MpW2NWfA+Qo5DhpzPcfny1rti6BGuUPVRUJ8Aa5eoiPYLDJYidhoXDo5hwMKUiPQRywGQwRPCZTLCqdy9Xo8U2XGGEKBtolgjvDA5AAAAYQGf12pG/wBr20ygADSd3Y+V7XglxPT2koxOjAAWT8hu5wt11m00wcxo8nRe5W20eIKKuZr7YH37uIj684FVmTisF0bndB/xsMdkldM/qXckR4nN0dhXVam5OFKKSTCLV3EAAACZQZvZSahBaJlMCE///fEAAAMAAAsKjegSRxLY06AVJxL4pTbKJMfzW1147yMLCErxMBWpyl0y9GcDs3xm36ueot7xi58dasYwok14YHEDM+O2f98rz0sEKEdcIgJw1iuiI8K1cb9josiEGiq8VIwj6kXj1eIh4Z0JSboIfLoLqYo7Uh6vaY7QncnOtOuqcnmBGBJCvZU9lTPYAAAA8kGb+0nhClJlMFESwr/+OEAAAAMABHY/AwQDCjrBgC7sGETsL8yu9dUngimxv5zy5gLidG1GHwvoJwzE7cjIkpm6tUrv3k65EzbI6nL+hfoxKZYx8eWrkKadSCi7aQVIV3chrOFn72PsbFvBmznnTfRG/bRfyAbVgjA7eiRuTTnyMw6ewnfBabxfMD8RClQ/3I2PKHxpxEYBIs7M5dRVxGzjaLgckgb6ffr3bxGkPNNA16W3PVpuyEOV6/4HeyCK6GoqGqKmSw6YtFk09jSGBhvqLdrruusZ7brDY7iaZp0f0RnMs25u98symPT72fcajqmBAAAAZwGeGmpG/wBr20yj2JfhEBa9xBmx6rp45OfxHT5Z1rdaABAAien5nCtmwfOytyuHxYRs0zHVSjDZYbGJAapBZ8QSFtpS+I0YYMANvtcbk8ZO4J7nGjbiHoHqD3ve6tQUGZvsSbWzazgAAADoQZodSeEOiZTBRMK//jhAAAADAARzwm7EAmgZO+S7F19zyCp4GcMIQyy55C+tpIti9o0hvBVe/CEKzuC/x0KfnHTeUCQOAL7/g7nWf/Epr4Q7NV9N4ID6m5Bs1fBgKattMdwgT6GYte+cpo+Wq8lHhP4BCQS1Pt6a+BZQHX0MwQwWnE+q9xVGcK6cD6zSGMPK4zFb0cet+nSrW+tkYBZoshzEXZvsaDuhuDNwmyDHD+JGQnpjMoJxW6zKP0VKedbeqanVaorTGngiWH2FnGwsa1iv/+TR6GAlw9oBL0ACJSHoOnaVo2iWwQAAAEkBnjxqRv8Aa9tMo9iX4RA4sjUwgANJtUiCF+/nC/gVpxorMn5HN13wggBuCZe80Jn9kNfI6a9LKXIIuopo0mXTc5zIIbyNfsGxAAAA3kGaP0nhDyZTBTwr//44QAAAAwAEc/ydgBz4nVayacsYm6KMkglYZ9OMdrWrO0LXvNdEbjFcDHipjeRHfI1cJUO+F9en+lpVVgHM/9rqrHFYvhVduReIzOE3AowN04/0omZmiDpf6Wx8qz6Hjgw3m40AqyJdqe/gC6rdO8mbd6hP8r2U3ugs+tiqnb8HsQ6WBJjevEZR4ZvpughAmKrn+gRLHKsgncGzyCS6uC1BwyCl5ir3EF1YUN1dO0MQxvlb6SI51t9EWgDaN9Rzrp3HLkOlEOztzShTLzg2/p1WeAAAAEYBnl5qRv8Aa9tMo9iX4RA3Ul3ogBrL1KTqL2ja54/hWfQ6WEKr0nAv1NwKm0ADaZVf3manFes0eId5LW4xmTIRPoHOCM+gAAAAxUGaQUnhDyZTBTwr//44QAAAAwAEc8ayBEQGRABz/PSqF4prKok7ijv53FhpoSwg/00xsm9UEgNNhcjn0eWTXy9FYsQCp5sOaLehWfP10QM31CO4lHMTseXiL1Ckx29pUFOUZe0KnGMQHwBxNtM1LPAIj2ashQdZtbSdz9glI29zaUU1ZtIbHOrCU5SxgngdDhVoak9TGlao1ZxFXs7wiRrjo7bwhgrq/23dJmzbJo+7a//KKgQbaODXjYErDbeufKBMlbHBAAAAYQGeYGpG/wBr20yj2JfhEDgO1ufBtPLKTfCaeIHED+TO7Wu2Xss6RUTbw6ABvUPpB5hDlo7nvDYeBuDvss/OIVduYqpoPL1liuWJ07PlugrtN2OR/iTQBoPy/guUK+jbQuMAAAEVQZplSeEPJlMCE//98QAAAwAAGwBU+RP7cDJXeKC/ooVLputFPtCYtQDaFRSoS/iYvivMlmfPBqa7o0ZGf2aX1SbcT4Gxm2/l27S3rGHehzCTlM8CBzb/y1B/s2HO7DNm5Fmrcn9q03pm+2TGg/FCaN2zzcAzNkgXmL/1copzfKB0Cr9aTTYYS/EyRh96FBOkU9AsO2cQZIwFf6MCmSvWLDdBrG/m6a+nYygui/TFbK6MqXUEKL/v3PfbV01ukax5IKCm3mR76jwR1K6yVLmYdXMrcgsvCfuzFJijv/yV+7NkrQTGYEE4IOTo7mAhAva5UYyYdfjld2cu51Kke7zd1gROAWCDQ+YxtwnKhx3m6g650SikiQAAAGlBnoNFETx/AFY92mLoAuDQOArW06E0uQC/zGMIeBLhPUwB15KN3OQCAtIHhFGSqVNEk/sNHol9fcZZXyAGO0RbvOJv42r86WzVsJWG/CsV1xSUf5725t6BGcDyMTytJQqtk0n1aDWj0kQAAABGAZ6idEb/AAADAAHaSdbi2BpmQ9rDsbFcQXA4oc8LwAtfXzyLDY+NbV5C+jtPau6IL9cQrr4++UjK1PJERVewMcAwsKzuYQAAAFMBnqRqRv8Aa9tMoACC97y4to2uTSQ3dZYt/ahgTse9bFdlEmcP4AV7AtPWCg2b/QqGuOHaqxaB7x7RwrN2Jb4KfGgX8RZSh28R4LSg6d3wwNHE4wAAAHRBmqdJqEFomUwU8J/98QAAAwAAG5lHdqjn40MAI8f6RRfolvI5wBUPPuSp2MxI6Ppn3157wm+0/fV3ug/Aw96KDZssD3D7IpT7MLAxmaHeeLs1SH1XyehbMRVRtIt6rSMDNggMh6+pNQmSAmjEUMnoaOoK0QAAAFQBnsZqRv8Aa9tMo9iX4RA4lFUnAwI5sLCUx5nvjDoAJWr3whzG5ZJMQ6enHY/kxUeGzW2Kw5fcZ5pW/PpIGq84if9Q/l/LPbWF9QNqRxJX0LsKbMEAAABzQZrISeEKUmUwIV/+OEAAAAMAA/alBmeY5BBg6MGeTYnf/6mktKNs1e3tZLWBhus59aU4+kvnQVS7ZK8wZwz8+Jj0CgqihFyWyIfm5Ad87Pugc+3c2cPq70Xyuo//332oDbU8GXDMma3CziB+juBiiP4xFAAAABdBmupJ4Q6JlMFNEwr//jhAAAADAAAMqAAAAEUBnwlqRv8Aa9tMo9iX4RA3RoBRvZEwftO77dkcjIiEUAqgAFpzSqvAo5OujzWO8poY19V06UDBH3cZUTuQUVH8/gk3pekAAAB2QZsNSeEPJlMCE//98QAAAwAAGx3/bejKChyTmdRyv3GIt9QPe4DsEWEAIRmrGO4YxsPPE6vVS2viFONKDaKSqAdwujpr3ncfa7JuGjIV2YkABWRyPv/hsNgb1xQyKc/b6JIlkVvrS9W6IXllYsVXsBNlvabpuQAAAHBBnytFETx/AFY92mLoAuDQN1Cr3Rlb1hl4iomxD3ogLHKPa1szAAWheZhIop1/rf2oaUk6ri2HcvWYhHIBXcIVQ+z5YKSaQpzv9dd+C54uC2OxLkIB8GXIhJjB2AJ0ovvhC033AtFa0+TgmWqP+C4gAAAAWQGfTGpG/wBr20ygAH7jYj44R1wglynMXnegmPLZFaAC566QfC5eXyrLI3PKdkOjHQIkrdIdANF2HSZHQ8/4ygAFfDr6nYF2w3ktJSeVq3LwQZGeWj53hA0FAAAApUGbTkmoQWiZTAhX//44QAAAAwAEdN1Fz3zTJ8AHFc4jndX4b5Pbh1eW+MGtbIZvOeS6hiIRHz9z0j5pX5qA6sxSwyJYJjnvBX3MtZ25xrFCa6KnpsPdo1bpa34++HDiOVZ+0/FfpHXYXWWrKj2H5rMc9GT2JnLpo0NAkacigR7uqOy9SpIHQtm7AkEY8H2GQITz3RiQQrUmppBfD0Y9ZXJgXJrbZQAAANpBm3FJ4QpSZTAhP/3xAAADAAAbHf9t7VvU8VIZZK1AA4oVK7ojEEL4LQIZAcHC1w4pgsjzBMI96abRb6IKD0LOxwoPARCeD/EomdUgIlGsC9NB5JIzqLIr8nHQFnXkNqNJRYKoWMRuiTg2ksJNN7UkIY9mUEALPCnUUcqIfS7PX6nCbGMCgGnHgI/0FGs3ZV0eLw08o41jtGPGB9ZPM8BRsfvkZxWTDdjaX1AoNmlgXNZm4Q0Si2J0bQ8GWLWenKand48cp8TfmV7VzvSXBplvAbLfUn5OEpX8gQAAAE9Bn49FNEx/AFY92mLoAuDQNz5P1OO8wQgEZD6QxEn3ru3fAwAj3YznwO4fmlLzKO3kRwbtutLOl0LCyOehUsBU7T794mm9ibdi9W/57nH4AAAARQGfsGpG/wBr20ygAIKvN8i8BKMJgJ29KLzfBjEaTmrdZudzObUFYTVG7oAbYs+mcbVKKtA8HMBsyelVgAuXaPKiof1qDgAAAPpBm7NJqEFomUwU8J/98QAAAwAACwso6AF9cLE3wgDJLgI7k8fvQTpRZHSw/RPovm3Ja905q9FBHeCCUXU0XZ30HhJTnBzzJ8KwUUwXCkE5BHj/C9ANcULYXCsMwSPutBpihpzb8p8GYCiH7fMvzRJXcDCJ8dWMS6C0ApykWJRzPUCUVoC6Z/OG1WHUOCPWSTNizCYndGUnH1z8uhzsEa3/1IdD0uVX98Bzi3lf0c2Cl8V055MTENhSyHZB/eLsJbtEUyVqoGj4PSd0fmIH1eUfRGE42F9XXgoFnkadRNU8Rp5EwWxfX7m7FBz6u6bD7EsyBQtsfb2YnwxBAAAAXgGf0mpG/wBr20yj2JfhEBav4SI26dqbIfU8VFExuPYk9xpEIdLB9vev3McANLhUtMPcwPERNFxUm00cIgfilH1A4f+o7NK3KlsInVJKGZNkpqR62+QAVRFOdYvXISAAAADSQZvUSeEKUmUwIT/98QAAAwAACwwiJAAWAKoCLmz6711pHbiqG2hpaD3J1IcQlT/Lgko6fAha+MN4evLYaW75HSbxo9dYpRV12B+/EQUjAhNIzEjYuRqWHm00/UrZ0ZbCV0JKbiQrBeGiWPWF73dapBaEjsl9HEugzKlgBo2vtaNYpH0dccf5cte0qLrjAsmi/NSS7lxfKbvTZLfLi0zOgCy9MF7Cq/6TcAK0NJ+6K0QUUxTbrAdbILRNJXLi163DUfVGFnxSbfqdZVr9OIP7rBpgAAAA7EGb9knhDomUwU0TCf/98QAAAwAACw7aQqAA6BYLLzHbUZqkOoNMgXDvkwW4Zx6FvudLaM5g7FTncfWuDexCVUFqtk7crMgpiVDYkz9mhMAr3b36J/T795krMWPCbYWpkvlhWrA5rjlfAFZgvWVK19kps46dJVON469mFinGeGAsecHBbLthaNVFRd2gRjPvSkewipmbB0ylX7KU0ojwvDdagstjtn2FiuiHUzt8xdzfz4IZf+OP5hzXA/1fs8hEQzt02NZYbRMHyNUGf5MV7SA9t2iUgEuiSXsyQbsApQpoKMg6+rF4Qb5HlI+hAAAAVgGeFWpG/wBr20yj2JfhEBdN4RY5zKG/sVs/OjQd97eiesgzt8qBWQyjrL6ujwmWEAHCKv+YdymWNrJza6qTy/Ahsna5S3hD62CCK5HGLQmwycYgmRjJAAAAzEGaF0nhDyZTAhP//fEAAAMAyfy4QJ3CMDpu1ILvCbwJlOlZl8d512c1mq4F69Zvo9y2DqeYX73TU7z7aLj7GBSqnUMsZMN8WCTtKjL936FCUdEGE4b2CiAbsvAAve3KEFGweb247nQYSh12ldpp4wWjHb/jnAEoBXs+3eLyYYWH+ZcF+Dljxygu2OweRgllOug2h7e0MTiVW2N830S2dpHSIc02vaHT2ecpl0UrS4SXa5mnm2f3nIoeuLeASYetQPqPz2vX5g/preEYWwAAANBBmjhJ4Q8mUwIV//44QAAAAwAEc8SrRADdY13wwURfUav/vUPo1UUXvzuRNlkNbsdPA1PQh6sURpCsnbuAp0lSJ+t/79lcqxpKkY1S31Wmrjn/5SpXvIx+7baGjPsG6JWopY/8hT3K2JhnlPGd7u0ZLFW4A7WIFtU5j4cKT1RRDQHRtvy099zkteSxQW/EIRxPvFXiIkYQdTfIP2NktupWIyHVI6KMkZZtoL6Na/j9B6X50AACQOgNQEIMH/c6jl1RMcNM+6gHK4zpRvJ/ujenAAAAz0GaWknhDyZTBRE8K//+OEAAAAMABJuibLx8KnsC+AC/VpDIaggA3nV/dDG2ukIOhE7xd6j2rQVPoNdj0RUaDg/cYdqdSFXepEizTjfpmDh4uNSUyZajwlXYNLrVdJCNAxbE0TXhgT39s6iaS/yB7ePyBDHTY2EBVD7X0wt7QiWg1bMyyPDfna9OwI895LvLIKJb3uIyuYE8Q3FG8H8R/APJQhkM4Dy5xYSGmfyuOycx676+F/r4cak9Ey8CHIw86VYxdZ+P+Hv3GP8ucPCvYAAAAFYBnnlqRv8Aa9tMo9iX4RAXQlkemKrL4XGkblqDZV7vY9P0NsEAQ8+IAcklT4vuZeWr6gz+4ISWXDZaDfbbaAQSiu0RZ/phqsQGF8M3Ih5qN3ye1secgQAAAQ5BmnxJ4Q8mUwU8K//+OEAAAAMABLaGDvycAZk4k3TaaGL+34B5y0NusNyHNXkdd4F8NsZuWyztIDkbvlg0njWSx26lyRCaRRyZY2ZwZuIwc4moZD1Ir5zencyZbGyVDKO2y6Z4sULaO3x8vJtQugTHFW0FnfVQvUTaQLmyC+17F3ckMyPOJDx6erywfUXMx78hfdAbR8sMU2BNTOHQk0vr/mGFepnvBEOrRDvj1WCG60TQrdSl2IOBFaWXXISD3JR54U5argAXvaholKZcuA2CZb1Riz7JSLo4pJwiZr9Ekk1wiO0rsd/4yIenwA8MfPRvwybLd6X8thXBMeiBLoS9/PQ8s4jeLhwL24n6QEAAAABcAZ6bakb/AGvbTKPYl+EQF+j7SUtR0OnWTE+xb02mFMFbWNIxsfLZRAAb/6a2AJpsBzAhv+x0PIx3wr6WBSDjSAHfwhdMkvHZJqkPUQCA1Grmck5sNT9RvAV70MEAAAEAQZqeSeEPJlMFPCv//jhAAAADAAS2RJHmOIriUgCt9+TD5bXW1JZc86x6cEjO+UwU0cNsURyYVqJQOVfMqOCUkPOxZ79QIEiJpTE16Zm8vvayifO+HMxjpupN31s7XLxM6YYDSakC7jkYiXIW4aXRRWu8OXLb+/D1BslULv4gWz1+HxzV63HuJq65/wT/tQk8wUZvNQ2nacObFUrVpCqnpsrLmUjdOT+OhvqkXF8a8Zd3ozaop/zhaJNLuSIUYqbB8Dx5r9DkNt6llx1+f6jIQPz+k9gZmMBWH3U3nN0Fb0R3PbqgpNSYWxLvipYsXVkDFRAuvR25+gl/PaAS2n+KLQAAAEoBnr1qRv8Aa9tMo9iX4RAXzcDMZH/cTOCFPtP/FPDTmSxy3DrhbLoUcay4KdK4JgBaSELcCOamYOc0v9HXJAgTf/D7jz0tKKLwPwAAAVRBmqFJ4Q8mUwIV//44QAAAAwAE09Fcr6iAKtbMOR3Bcvv3rDGaok7MctpK5bsCnvAfSxvrz4/Pk6Ez7Yh0sPzFVXBAHFvbLs6ppSowFt871Akm5/8jQ2kaNRthM8P4JamDJY5cx+OG5gEy2fP6Ep6tcbcKA/bkDqnzfPuRXKUlKuD1sD0h+p/CyuQWz+JDs1wuZ5JOXFQ8ou6loRBEf9DNNJ8v6kymGQ+OKzlSHpd9IIQ+6XpuexJBHgTkb7KjnBLMfBPLIXrVJuvTyLgV2JQR7m9mF5A8j2y5iwEEMSZGWYUEEIkUSFWxixqqAGYeYnoTHMy8KBHqij86Fov40bGmBYh9qznt4PjouEyrR3mFAoaI2Q0/8sGVdLVothSL1ium4CJa5meIgPDSReFREk2H6BI494JrMJ3/pMsYKQjjzxcALXxX7aO8nQMPdyQMThhZTussAAAAhkGe30URPH8AVj3aYugC4NAYiXGkoEYJVwjqcGGI6woW2nrfNNba7i/0AW0K0wkEByjXz4tm568NOiZU+EXU5G+dyEm/l+TpTpW0LQQKSarCSkDP/6vdkzMTo+EkBkAMF2eU7DoNMqFRwjr4MI80pVgmNvYnv92TSM3HI7EbtIGhru1tUtPTAAAAXwGe4GpG/wBr20ygADioHVFCyVDRbSnuyesgASngHqCmOnpBcF+qT4uNcx6lu1JAI/y+GxlhbJIIF40f1S6FVnkCxGx0mc02f6dI35tfudfMFvxidyrBdO9OYxDyKyksAAABTEGa5UmoQWiZTAhX//44QAAAAwAE0sS66Tug6Hz6mQgBGJ+pBlLd7xPvBjmNvrX6flQwH6GZQ4sHrnwNrmhELYEm27WO0YHNm1bMI4EvUc5jMT60Xo3MJMOjG6MQ2937m1jEI0U5j0JAbxVeSQl7FEAnSqhPOAoRGGf+EDy/ZR73xcnSyuB44k+FH+7aGQjqx90JS2hQbkaBr+eIv1DVb/4zwkRAVZ5cAz/+4c4xtk7KPF/dLaUUoyd9QFrDKIgLMcusHL+2LGb+s3DX+OZ5RKSdlHncjpobOvFUCAMFebh5qcGdNkvGPMZP9K+Ejxa3B0aFcdEuD1W89m0LQa380UV+rxY6tl8vpKcycwv2JQ4loNjLfDwYwneLWez+cGrywuTE2d4FV8/IQbcRurvFbNMQQ5KqSqRF+clogSIqiUySAaB1aQI2w6fVWTqtAAAAg0GfA0URLH8AVj3aYugC4NAYMUvl1qWlygCJCNkFhJsF8dWgNgGh18z1IPz94tSVYyv6JcfqtQZFgnHC0HEexB1WepPkTBj2WdvI37DYbk4SVeVWArcgM2yf7E8RcuVEdxcnyUEcfvamZ1pBqiJn5Zf/eyou8+bvBefFNAHY2KKer+JxAAAAXAGfInRG/wAAAwAAzb+Mk7HD0/nx3Y5oDwge9i/bxumJYlVrQVuKFDygyAl/HBRADTWpcR65hwqLzzZArfX1TKg4nK3c8sXvVuZqz2G48mOaKf6L+GFHQ6Pzt1ExAAAARQGfJGpG/wBr20ygADhptpi2ajqij0MEWajBgujgpRIIevVTJzjZw4YkG1ACpU4USEborzrJSD2enfbFi/6br+3R4pxk8QAAAOBBmylJqEFsmUwIV//+OEAAAAMABPYtDrRYAmV9oTaQQHr92m5ORVjj1qgTa6nh4CmUrjSBIct+/lZhZ/cEDCOGAeaCHzZOWKqeYqkA3cIwI+8XX+/4CqEXFshHzDWLPIDlM+K6w/VmtA0b1oCwPqUMBQAIqfbqX3iOCMpwu505umtzdltpMFFf6wjZYWzmEVAD6q8KOTN3BVZxCSRuqjbeYSJpvihupYrh8UOdyh/SRB4bxYZgNPSYXuQDgC7OPQhkc7pTiADI7861iFv5WpKqzh2BAfa9ja6Ulmji9UCJwQAAAGpBn0dFFSx/AFY92mLoAuDQGRvx1w9mqAiw9m878sU9/DLm5MCn6drb7IAbFl+TwuzcVcOGakdn6MXF7KOJBrXa1b/J6DLFiuQoQpK6/uXZSwFnFGzoeoHma82kFbIf/bDQiLts/9LM30AhAAAAVgGfZnRG/wAAAwAA01ctahmx8h57xQFbavpckvJAZkdn5ABwNJ90WaLxcdBYfGpbB1Fo90qnGKSlbS7kQPltq2pkKgZJYrUOhFXUFI06OxEI/NxxjOFgAAAAMwGfaGpG/wBr20ygADnoQiSr/qss1hUbrl6dYAWzDCNi9Ek78VrQ2fJUr3Wn/wX8/92nQAAAAFZBm21JqEFsmUwIV//+OEAAAAMADNr6wL0/1dx8tNwMFBHmHghnTctYKEeD9VP3sOq7STnVUoqRNXvEtzXHPfWAo8cA8vRGKc7DXolf1cqE7FEYQlpbgQAAAF5Bn4tFFSx/AFY92mLoAuDQGST4l3Br9RJeHK3VGWhABYZm06aIOy53Q81kDb/e7kTSRED6ItasTvDh0ndyoV6WpKnpI98gufW373AZ1mcqWMQhtyjp9uQD362NucCuAAAAHQGfqnRG/wAAAwAA0tAZi2qoYamJHCWCkuiCvkqAAAAAJAGfrGpG/wBr20ygAJayngxqFJxNT/zYqhD5m9d1t2AeNwNEdwAAANdBm7FJqEFsmUwIV//+OEAAAAMADO7/0to4RmWTsEudchDGSJfXTFYA5gJjCg1hn4kJk4Nv6l5NvDw++5jw6nJ31akwzukiG9zNBuRG3v3bauzkEf1xf7TxVIfXPMTjcfQIS7nHNcaDZey4mx98JS7iZqne26QXNdHhlVjN6xDSQO68FSx23kWq3kMhysNfeP3hsLCfgWlxq+uI+jtwUIexhb1YCagqorQWLwaSSW6/JzGWXjSSz2pgX64EZ2C6daz4G3wslC0Xbl1haeCOhcY65NJcodHzIQAAAF9Bn89FFSx/AFY92mLoAuDQGRyWcPBp/bJ1GJybcn3IMAMx6ShAK98daE4IKGSo5Z5U6c+kwC0cpcsr+b3dZfCVA484fET67X85Xk7HqxinIlZWFhz6fDf0NaPMK6HVYQAAAEIBn+50Rv8AAAMAANNLplS5tE7dOaPg4aggBnJaAONF0+c/EAD/FMUvy04sJACT2SBHQf3NuaEd5PAjAxY4YfHzarMAAABYAZ/wakb/AGvbTKAAOe3ezjbEyAZ3u16OuakTLjQAh2jddEDsr74RGvznO+gOTrPxzqCaqPO0UStvdC6YwDc65QV1fMElJ6X1qdLCCbBzpH/1rU7Fagz78AAAAM1Bm/NJqEFsmUwUTCv//jhAAAADAATU3iuDhSAG2k01OdcRrAFo0hFLoiJZc13sT1a8N/T08nAcTT7OT1q/AGCw4LGcWsGWaOvXChcyrP+dDMXMh/s1rnYccUyqQEPIlbl88hfLCd/dhkrWzS6fPwdZjNXYfpy8dQ+D/b/BYsT6RjXUrQsVHNg1j0i+FUElOUHcO7PEhmsbi+74LQD5xdl25gPe3Dkd2mJBcSP8Ru3ZZYNg3WzkMJxl1lD4d0ud5MwG67sVED8gchfOuhzBAAAARQGeEmpG/wBr20yj2JfhEBgxP+sJ64HOcR4ug5k3T8/Z8FqOltadEaAFcQ0/PyLjNv0iWKyb9D3vMkai2oNF70kJrCWwqAAAASFBmhdJ4QpSZTAhX/44QAAAAwAE09MEHGgAuG1edODfgGWopsNVT38dze3oKX98lE8fH/Y35OjtObOuAra0ZPPWHrZoStGq1bptpVrihbTVTM9LsiPt8e6CL7GHJrG/6H39eoqLpb/cQLYUoxlo2dGTdu8U9qvJRssaWyOnPtqmJhLIneA7K4jJQwuNmZoQ+bOtO0MNbV/8y+IOSGkES5YKXvf+oyndzVeR8RUQL5/bZ/9ONncYFuPctqrx1GJ/yhzsbmo/slJ7AVQuFHzz556KnzfMDyBBJxbDL1nAbOYg+xTWm+oXSOqeRKZIEJd8Y6pCGICgIW3LUR9R6vLRHPEDRwmkDM7SFxoDj6co1v214u5PxtbjiKEOq/ajYlzBFphFAAAAg0GeNUU0TH8AVj3aYugC4NAYWSimzPmew9sYLd5ndkCFWXCyLElXuEh2pQAsbuYSqXvi6yAQCaFfIMBV7IkLkYt8Y/sJju4IYrrDHxYs6hKS0dC1yjPIs2gnohjxusFZ4VO7xLR2dzpjcEKB8bVfL486r/mIK+Fv5Sa7uohWqamZ0QtBAAAAXwGeVHRG/wAAAwAAzb82C9/JSA7rXzfCchX3oAFuvrI4pRreYqjJdlf+B5MI3j1U2zDcXVVWDJ9OALprTsc6TXSHMRxfBh6FGxbbBNK7g5EYzlG+dxqCaU40ZA3jguH4AAAAQgGeVmpG/wBr20ygADiFun/mMyBfN9kS/V+DYU9XZJcJKHKXwFzAwAV0280gN23Iul2pYRqVDRQO0igOt2otPswKGwAAAQhBmlpJqEFomUwIV//+OEAAAAMABNuiarWBn8oABdQI3q3W947N+ZZT0cADTC7TcKCDX/mCZH+Kt5UwNrF20IdUNixXuNud8qPb0VaisoDaGDlPITeu2JytT24M6YIdy6t/iChrH8UMZil88/hgIwWxVnUDKskH02dq7KFUEGW8NjN2vTcO1XCB868iB67eLFJTgBXn0Yp4PY2Q88OqG5OgCBaw0SkZPVDCOwq/UBLJFb6QMZn7axd9kNt9MBLmPqbxb3hr1biZdxGLrhoIPMBm4IvlpkmYBAjrP5lUrqzGba0hzJOXy8zQkW+ceamxy8oMgPfTBBW8/3+N9a9k3ThOICGZxvXNokcAAABdQZ54RREsfwBWPdpi6ALg0BiIb81AmYpJSQDexWrDPyypeivZMut71W50OfgwAtjsJ9MMSV2KhESub8SGReoD4eF7pa/AHAHyP6bVGhpHIijAq2s9+toYVq5+NjQ2AAAATAGemWpG/wBr20ygADh67FrlNHH1pnRc7qB6D4TAAcfAXhiL8No7PdxqZoS3dCwDjhcbQOfo68+5qX+EhgQAYotNnzr7cJnpwS55JwkAAAEpQZqeSahBbJlMCFf//jhAAAADAAS7omzdmb9A83A/1dx8+clNiLjCa7u8jII4AUOIxrIcNKS0PTHw65kek88SbiqcaHf14ClZxw7xFoL5TnbKl18uCouO06zXvPDqY6+en1gW+z1vRDkpAGsQabLi1gnRG7EQy2RoLUn1yMuaIUFZ6B1US2J4PujwvwbxxTD+9lS7qe4B5oWNTbqTyny/DB0HQrDQELmCYClaEtno/r4woWhoo0bdLF3PM73dvcAYs3KR273QKWJr5WMBUHV3nWw+bHng1iINDNMesyhhvl2D194t/FoxL7L2nnH1lcQevyT7vI5n5x8+gl1hUxXqqITr6L5yk4dzwx3rBf2ltSsJ52IeNNxvAWUXQiroULiPDXHhKDDX8GxQAAAAikGevEUVLH8AVj3aYugC4NAXuSXaqDhq6IVcCA/Fsc2+80Qd0zwyZkah591csGXdgQGjFT3RRcW0yz365MCM6pJBf4Dt2doi7f+dNdaD1x+DhKNm8UEU2QF549OYGhmF/2lXVrj6RbNvZ2aVJDIc74zZQeXTF0l1/DPuSPWX/g5jUHtVM7tqdOAk9QAAAFwBntt0Rv8AAAMAAMgGEEyU6Um9ANGTG2mvaiAjXAyNZRdZ8+nNpqB7+NYscfUk8wALVe77KY59IPrpIRwCi+Jv8pN8e5N8p9buU57UDrYeCxWr8ApppZlqWeyw7QAAAEoBnt1qRv8Aa9tMoAA3Tc8zwybiArydqaj3GyAQ3KD65KgAaf27/MSN/o31qA40zr7GUCN+xw9sJ/eVUdhci9m2N0GMTFatyW7kWAAAARRBmsBJqEFsmUwUTCv//jhAAAADAASUOKARY/yzOfx6x9jkU3nlZPH3kmrjd8+P4TsRgEwzvFTTq8b+or+Jb1mg1ZI+B/AudeVLhwNTErNDOZJ0cI7mmjwaW7LZr3K/NNgTMuJSuDbQYUKpo2jfygESIceXwz8z9I1MUyP/0mCftDbHgqc9sB/zV7EdsYhZZ/drQjp/TZ+IDz4I+dTNePdpwA2k9ke4WHq6ayP7qNcrnwucxANMqVihxOcMi/jM/80rpvfyctjVd5iE1v+jzvmtZqcN3nOSZ/hYHzWSf5TsMTvH8nx/2DHzWDtjTc/2hMQQhIxactBN7w5PbYoWVpSaH9o2whjwOsMjB0R6ePVj1aPYnhwAAABSAZ7/akb/AGvbTKPYl+EQFr3h0wwWCoxhcRASD984QYp2yyFAdADiIUW4L2+av9Y1ltaJ78MICUFi59UU0GuJ4Vvs6KSo6RiTrJDFlYHJprYEsQAAASlBmuRJ4QpSZTAhX/44QAAAAwAElPubzkAw8DoN0wjmEClJmDojRPNbYPgqlWxNZ5DF3XdKciJifpotbhjKiSVeLxFxRyQG72QcPqI9t2DEmKLOm0RQImGbA2BAR+r3A9PEjxXG7fk3LxONzRxaToyWtTzFRYns+W2j2U6Ddh7sM5RPQk5na/ZnQKmyBYZb6x2Z/8B7mYVBvhoo9QViUDNpeS6+xg/WKVg2wgQJIQVEZcOlFgQPmjrEBzxLhOHqP+UHjSFOo2nCBlgSx9Ti+OHZXQ2h7rX0V6Bfq+2YDDqswOmcHiJL5eJX2ZJuFc6z/KrXfQwTcxz6eCglzQrz1ZykDUNV8BJWljEIo2CNUMFToEof+DTerpQd2EcZk+UEk6aAKpWcTdWentAAAACfQZ8CRTRMfwBWPdpi6ALg0BdNSWFwjHszEuN46hb1p88O4yCakfeWQlZtcANz+YvZzE6BmrJsPMEmTQP/ELmH+LRwUr4nQbILDqgza4uMWk+NaIxDgnCXxfDtoXm2yT+R4SI1b8ZRmVP+J5kiy7OfUjhLDnNEVLyCQatwYvKY/VDULBsPD+sD62/rmR1IxuFotnQf0wqEiQrW5s2StirZAAAATAGfIXRG/wAAAwAAxFtsZNOULJLrzg+yDg1qb7gACwoo1PX3E+kWr7VJ2gNzAExo45wR8zIdiiSZ4ZPV9mN5j/IklheaOS/WwJ/672oAAABbAZ8jakb/AGvbTKAANiDS4V7GGrvY3S+zIF/LOhMS6WCPPERAA2wdQlf8GtWJ/qB9CcmsMJUIZg3+3chi76upHHchX5lNZP/fSVZevVNqCaEg7RXGxZ/gy19U4QAAASBBmydJqEFomUwIV//+OEAAAAMABHY/2lvjnRAUM6G48dNBsIMDyfEYBHCRasYVxset5xcZPdCbY22wvsgvE9dXOnPLrYc7Pc5xOjayEH/ICqAIBtH3LQrt5JhndLmlK+MTAIm1jBPpATlWRgCKMIIYwLi/ZArSuhYRqq63vX2EX5Kt1FKlAF11UrE+NG2/uOkNQnieuSFuWc6eg6SuRWgnEv+kdHPq/9vurmHofDkwZVJ0mG9WMOj/LBEP+wjSgnuraZe8wtaSl8/P84V3O44GvCTVdcbW0CGE5Szdk26ypQdT+5SUbcZl3jlGT8WzerCHDHyHzGzo1PnfP3kYUyAjzwOQ6ALEmfc1denA4FdYvZWyT/pkQ1Q0qxVjxv4BPa8AAABoQZ9FRREsfwBWPdpi6ALg0BdQRKOQjADmUDCU6HFrlgA43ZGFbg9Fis3wXuVeBVpgqQJ9x3/bGXTAIllABcbATotejrGl5Sx+ijjSsSVrMnxmEi+TFY1tNhnd+ERsFCQc/z9bVoUvircAAABVAZ9makb/AGvbTKAANfkrXpoyF0sXDpoe5AMgdADjoL20Z9618kgEVSPTO+MfKrdqoagPQwy/IHS0ojAe4RtC+KdOk63b278FSD182vvXiHv8+hBFnQAAAStBm2tJqEFsmUwIV//+OEAAAAMABHPISMAB41MGcnlNq7G6Gp+z4+vXiH6JesTtn4y+BVJA2ialL8Zs2r3bnYOkh4lVHB4mdMuZah8tskJcxE1BZwHIPGQqg5lUp9eKe7HqEhipaCYLvDffEHqPAmkg+ZmHQxUUDQFTq6DFN/oS0/KC7b17eSyB+L2zirs6wTcmd27hhV9B9IcjIiMErjbZ/gNErxrMoVUwnp7DTITYIcI3Vwa7C2T+20vOdEhrWtxMgEc9AkcOWRxQsv+co0A4v0NBnfFhDpQtTAuVHFY/vlWErUmH4Y3M431ehkW3bEI9EIFgKhip6EqTTt7Jno8J9MESuTrybguk63vBBnNUdCLD+B2wCNeulCccn41NMniwnhrPO1FJVP3U0QAAAH5Bn4lFFSx/AFY92mLoAuDQOLAGY0Fi0uftY+BhgpwTdMMRhSURwArdS5KAxyirU5A07fJS5L/vJ/gzrglQP3KiVAhP83VFC1vG7L0h/ZW4F1tP382Swd0NI+5x0UP5+8yrrU1rs709h5DIwjVKg/HpYRiBpVDrdwv8eXD4HUAAAABcAZ+odEb/AAADAAHbscRWaPdSh/2xr6Ay/uq/VFTIEgDwIGtSQAbqrDoO4yIQtSOnwChb//12azqcs8ipTJMpG7B7LC+h7nTFAIsE0H8Q+CkjApdPcQPZXeA22zEAAAA1AZ+qakb/AGvbTKAAgyd4Fc2Beh0+RdkU2AsQFiO/wA+Q/a0XhqHuZ1dE3+/D/Ex3x24jFFAAAADRQZuvSahBbJlMCFf//jhAAAADAAR2i3dYBRnsRWH/bb2lctzs2ir8jLyVnnsie49t3U4bJztIKVx+/pXpVB4ysy3GuqtSmSqBfd3oe+ipAgVvJxuZ8F4+0oGBso/2MnUpwwD5lgNQ6pJFcyFHQge0x6DEMbiFNROX4sjNqDTOKB8oufi9xPBoM5CL7AIB2WQu+z5opjFEx7zCZHHOKSeRrFjjpQv0Ovv9Lf3ENqtiiOyvC8ysYwISVuz7FLJM+tZ625nd15YELrQSCTCYcD7IhYAAAABeQZ/NRRUsfwBWPdpi6ALg0Di4qgCLq7/Db7nfwvei0AIyBCKqh06ewTKln0S+8JbZE/NJOGWuh9PPTtYRx6VP0OebHE5y4yH2i4EqCRyRDThEnK9xZYtCh9VGF11UgQAAADMBn+x0Rv8AAAMAAMPQg0IPvFN2MEacw1OT5GADjJKQsQD9jOykj1zleTsXe3fEXAuvslcAAAAvAZ/uakb/AGvbTKAAgvrxHKWv0OTKuPZRP+X00SG6AIII+/8h2itgV1dlIlVj07cAAABMQZvySahBbJlMCFf//jhAAAADAARVQCdBcDO1Mh5NUX1FZMdweggBGLDx5MPLDpPpeZA5dlqcnXiBciH3tvHQZh7StQAdyO6AmwIPQAAAAClBnhBFFSx/AFY92mLoAuDQOArXoS2KyFC6pMAK3J7oWw6+XAfXrdQo4AAAAEsBnjFqRv8Aa9tMoACA9WLKsHO7sWLkWRWfYeLL9d+yFhItXZgAFbkCnv6lQYCxFzsNu+oJeuo0MwENtdfEVim58FOPedapYFkrJKMAAACSQZo0SahBbJlMFEwr//44QAAAAwAEdLX7z8SNKH7Mx2gBF8Qf4Rmv8OYJLSKY5PnLIQuTbd/fnG03lsRuq4cJZP6MReLvQSqMCyHMsllllce9ESIyqbDllZPtrxaQN4En1dMP44KsVIkbsgrZ74hS0vGLTUgXEm3UXI24ozlcv0jWbgGcWc5ozegnecPC3ljD4sAAAAA8AZ5Takb/AGvbTKPYl+EQF1QG/mQMhXdXSGABFQN5CuRxI4zwDkSrT0ywmKnrDVPW4qtPhQ2lxCoAepSAAAAAwkGaVknhClJlMFLCv/44QAAAAwAEd57SDQAg4YzVpWop2Kg9tpG0v+fQwocSPdf48RJz8TxoIrMM0MBId/XgsZ4p79/s4AvjwFr9CGRxnq8qXnTthK3bUBM0IXzaNPwRgABPAVMQcOx9D47sEI3k+q3kgc8uc9s3TGRzAb9HczytqqMCwq12cu8Sr+MyJ9Xu2Na8Z8q54jHh/5FhFaRmf4yfuovzctNCf5Ru5ri5yUcSfYlycbDga/XxO+TyoYl/wWbJAAAAQgGedWpG/wBr20yj2JfhEBawXI3ctvtC3O57kvMJYJIAOGvy1ka4LbDWIPy28T7V2JlDXpHgFJFD8ey0dnaI1+jUsAAAANhBmnpJ4Q6JlMCFf/44QAAAAwAEc93tiAalPjwAY3xG0ZiFMu8Y2bZJin93ASyo6GJxzQcS3rDP5Tpt1cpjE70xK6sCcUFyAUnSko6zVRtUwpzQc/IvwsuCQ+BjO6n8kgn0zGmFfIcf00fx7dGPY7jQkObi0bfNgeNVAEwt0lEWWgtzlF3oerXsDUVTAbcLS4aDYw4zKkKbEXtFDRHGpDNngm3huVBAAuNUm3ct9zihQr9KMsDLqtDk7jDpNoEFjWVnjOrfL2CY/qjea2rp8lznRRWKilWl3gMAAABqQZ6YRRU8fwBWPdpi6ALg0BalWuqBrMIecz2uT9IHAhig+zQPzgAjH+VV6gqIgzZSX5EoHyOQnn4NT0hmWm4q6C6VdKZ/dUN87gBzTg0V9E0omcMtMeIHhPhZVzpoOi/upbTqIXE2WzVDbQAAADEBnrd0Rv8AAAMAALp1sMxAFG5G5Pmx42SNluEhZaQkh+AGpi7UYDtg/0/+d2XVZ3xVAAAAOQGeuWpG/wBr20ygADTNvbcMWRf7WesX4sgVznLs3h9AIdcu1AAAagen0IqowIsLLkEk2LpXvsYmgQAAAONBmr1JqEFomUwIV//+OEAAAAMABHRC8AF9c3F7gkt1CAlVSZPuMhyr111xMC97uXf4tlGReQPPwpVXg9lmLCHm3ewOa+SJGmm44AKxbXP3JcsfGHLytKg6mc9PMgwk1700g5rjfYvqRIWGLTa+XzsMc1zZCnWvmW3WnXKUR1Li+hkpPjaYmX9xE4GIWAmRGVfmeJ/SNLtCxmZPfVxVp2/IRMofzQxXa/fIaDRcgmRzNYcX32W7dfxUKUaolE2F/y0YYAnr+k6461k0/fy1abe85d86qf46gPe1/uarynF5hD9M4AAAAF5BnttFESx/AFY92mLoAuDQFq1A9HrpleFUDFACGBkK8M9jJKyXeHypj+n6qU+GPpYsLfjshqhsI/GoLrV4xN2gti9ZK/T9bhQ7fklkSNDmbeEkTLwapv+uzvtdLuLhAAAARAGe/GpG/wBr20ygAIMJGH+Pt4AmBbjc0HbMt/p0iL4JRx4oAiEnabLsTd6w1BcJXK205V6Z4bMXaPE6KRhpXn4Pe2nhAAAA7EGa4EmoQWyZTAhX//44QAAAAwAEeVvXhAA4wfpdpf+UYgJli7tci84DFejC/5SfwL1vOQmEnM90ihSanFMZvtLwXx2yGKOQP373wEnLYUw8TB2Svh7my5f3CMiIrD6l+GRkwQBnw+rJma166NKGZMLo+3flbpEAOc3zTsRaa6RyB+xxqOHTLDcc/J7xzCCvJRQa0RLpxcKqBQUl5yhL7DRFMYdXg1pu4kCONCXcFjECPpW+qcfiYaM2uapHah1kuI/KcnXGvWTBw5Z3dfk0U0mXBBjAqbqXGpWky7V4Mn19cqy7fz5FNEjK2LT3AAAAZEGfHkUVLH8AVj3aYugC4NA4lsxnBOtgMvON8j/zr+Osw7DtvgBT5HTNzeyYQOdchb+uIJjNUFWr2ENi4p82NhZ/AwD1iiWv9wLxBHfgt2IioGj9PNyRqnBoJLzkdLcHfnNRTIgAAABRAZ8/akb/AGvbTKAAgrKsnIndbj1i+CnxBTYj+LqVDTPAA4NhEzkOnGysU9EpW6dpwFa5Hv6EGTDkWPJxMHiPBj15bQNvE+A2bXm4pqqJdEzpAAAAtEGbIkmoQWyZTBRMK//+OEAAAAMABHPOfH61XMJvsK4xDgPuM2CKAFn58V2QerpbuX867HX+3y7Zb7ZXMqusXF70Fn0/1BvAI7gMvZKrPipzaTjqUh3xzN9y2QuYORQjzdoABzoWm8iVBfrxDQWX1mvypKhRjr7+uzqRvAlDiJzAF826OfXliqQSQpFz7m1VGfjR9oao1A3g/WKGuE9JblpmrXFNe3LNzYFySpUPzYNXFhk5NAAAAEcBn0FqRv8Aa9tMo9iX4RAWvAB+Fj4L5fNWvoUo/pjVWAG34cBJaCwv6vh2tqV8DUO4+rzAKgT8A+v7w0jjenrHWDq/Co01UQAAAMtBm0RJ4QpSZTBSwr/+OEAAAAMABJv74AD6c/ll/8ZNMKYdwhWnJ94W7j5X7ureEEtmti4X4tqZHMS8lxxpe+213mbB+FifMxytHqoLW5IcRHAqL/vsm/h36lb51FYBir+7KP/nzLgHI/YahUfU90MzItd43LCAEhwT5y8rECShUoX7b+HAkJhIWSqcZbzELobdaLrkPqy13cc8ypJ+ljhQyQn5j5ZHDl9oZ17saRyVquUU++lJ6Dyurn2UpKjCGARyj/CXZT8jv+KLQAAAAGEBn2NqRv8Aa9tMo9iX4RAXQyql4w8+RGWe/3IgN0//4AAFWEy8+TAwcXwHbKPZZOoeHAyC8XCr0SkzKTIqIPHHlkZFEswjf/v1De+V61RNannzaKldf97E0lpgOrKEQB9ZAAABP0GbZ0nhDomUwIV//jhAAAADAATbomtDGuimg1FAAOFsxxkyhlZ6jOy1UT4Z+EaEXpC4hm+Hjll4meYjzLQCzl7jdZpQDeJjEqTgy2YMegvELtB9aGsPFB8DOU8ct3SXZEGox9R84XoTLqDUJQ5f9PV17EvE/Zpn2xO9DU1NbmSTagd/jwvp+zNIBU5wKpZrh4kd60LcrGAM9319r7COg4nST5DVRRnJqFeOiEY2DEX6jwCKlHQnQazUvmNNmgrXpwCpv3H8oGcqIGkhYelhVJNXt6Vhd5fMPuc5JU/7yfoX32Xu+m1Iok3PJzq8nIqeZRyiPlqDj+SmKJgpPnFw66SGXqRO5wQjVL0pS7dhBC1+FYv1JHFqMJ4crMXZD1DywQjQcPcvRUEMsKSq4fO+nTobNMLu5CbQkX9AZB+OxNUAAAB7QZ+FRRU8fwBWPdpi6ALg0Bh+vj9hOQCDeIjwXphWk+es5XpIWn3FOpBSRj4Lvj6VlmzJL1FgX6enz1t8n+xcKhppFYP3naE0zxLJYGjDYEcAaEsDZzQAyTXwnQKicnzlU9hTdzbqMypvtinjSqdqIdAGz+66HlABwR4bAAAAZAGfpmpG/wBr20ygADcYgW6Xdg7RNvjmEei5SUA6+HjIkACUzpavsEAb7P/xUFbD6CEyazdB0oIlhUH5aLAJJCi/XFtswZVR7fdymmsDQYgg4OPdkfDnj5e974e0LJWhJB/pqvEAAADkQZupSahBaJlMFPCv/jhAAAADAATTz+g50QBW/OYJOHHcmujyAneFQz5EDnAx0y9/KJAGk8xnbf1JbzSbR70ys83ZQCDKAZnR6mmx8CLnaePDBxTbP82tJ6zJ+cop2PWz337dQVzyLMA9ejg8zV+3B8l4WCll7NjNT/NKUZcEZo3Uzh+r0P/8MTeuki5ps+3j7+bvAoMJh2HNRv1ibB+lwu7UdhGxHCzTUGOmfDi01rsdyKOGQ5nd9LuHQWyJZ1f95z2CSIjzqFbXGVBO6KR59lPDP/rMw66YIQJjji34rFvevd6QAAAAWQGfyGpG/wBr20yj2JfhEBiGm4C5EMoHJxEghmL/VNJ/Zd3OpRiwBDw8de+qh8A3JPPY6wXEghyHAeG20OtwDRdSzDUK36cAfqc82wMg9rYQkKf2RfH+y7xAAAABVEGbzEnhClJlMCFf/jhAAAADAATSxMaavsOG351ZYABdKowFHjVQjHyF+RrsBoiJbdUGnHE5h4AB2E36fuuzEhZtJMN8ys8HrIV0puYaLg4dEnLtyhzdTCbSVWe+m74PdcRhbSSP9sj2ljFH4rfWbOVsAufMZiCqYmjoXqX7LuRMEPKONS96aQAeOIv5p8Aam6boR8fAz7BJ/9hPRrN0SXO7qFVA+cjym7TRcRhgiecyGlpfY64aMJvQzdWWWDp6opL9OmofLlqxGg/nD5LxZkKWtaWi8MjRxft1sv8pboT72UiIKNN9fsFIygElIno5pSTtk6gHzARCUVBaHze4D5neUVc7PYHMZsfJWiXfolWg/aWQA2QJFq93aCMekBqivOYtMpuDOywC0ay2gWvO7eXIxUqqbw1LtLyY5mYmGjMDQKVc2pYAbds7x+c250JEOkNlFyEAAACNQZ/qRTRMfwBWPdpi6ALg0Bkph6w2LuwXFBRcBfUt9GzfIgAWmeK6CwbrkhSs1if7RZB9/I57H1wb1C/pxpFsr//5wTU7ZzABEmSDoQ1CCItdJAaDuoSnKGSnYdzIrAM8DVG4DGKQo7pD6ST2a3KsqdJBrH0J1UtWSmCQVvZk3OFU1auB4Ei4wi0LF0/wAAAAVgGeC2pG/wBr20ygADoMmhOgJy+ZoDrkGKONEBtFzfryB29GwUd70AFrrUOKYZoKlL/T2SpK8wRl4Lwz9muUydGBeij5GyrYnBu7IOsInLISbwj6ODjYAAABGkGaEEmoQWiZTAhX//44QAAAAwAM2vrAIsf5ZnP49qJh9FmaJsuaGEmVXVAOD+Wn+O6qPMkrfcrD0+X+JMcOtszelTfbZyACpXCSDy+s8CKSEcUcdElA/i1dMUq95ut5P53E8s9WLCFIA4htl8ESRqObk/+LJ4EJOSZuzU6APcN0EeNav/fjV0/hSHOlx47kEl5jVY2l7B6YYrK2iAxlR2D8hJb4Ui5Jf9WL/HKF1Pf+e/B+9tKpp17uZ7LZy4lB+s9awBM6D0c37MDIAxaHO6VtLg04P/kFy8+PTdQH7AlpHjDC1YsiVboQ5WvkkFPysnUvQ+SNRjHChy0FHun2/06+ax+R0GEL+HkUMqVMFanESuFBJX/fcEnWtQAAAHtBni5FESx/AFY92mLoAuDQQX/R0myEbFjfHtMxfS8/PWcaVOsgzjL4gpOrU/r5hWeqQ1AARkLK+7N6HtyO69EvB2zFb+LQdJKSramlLGW9YzJPFoz9qgmIFVqb+KfDNXq3vAEqxnoKKsK5WOaxEHxjTfCrskM0HSJ7EIsAAABdAZ5NdEb/AAADAADTQOoX511iG3JoNvEH0XQ2GsADiujQVg5jAtnmGDmMddxvoEX+SIVnnmZXwrAv6pR+0+HMOnkrgIx4VzBgBNECjVys8pLtxtzY3tw4pfoYF4ohAAAATQGeT2pG/wBr20ygAJr6o98y4VCe/JvyhzKKDeplWJAA4TZvtAfgK5PZMcZcweGw+0vVK4Yxet1s68sEZS3pGO+PPZ+BVab890kDrQ2AAAABQEGaVEmoQWyZTAhX//44QAAAAwANMD4wzIdQJ2gAjOaqROc0cKKZT55hsyizCtpd57n70cpsiJjJEL0LoxZB9N4FS3GUVOsolMSw+oC5U3aECvxatfid2T0gtoefVMBHYzdhZpcCmO6ET6CtZUI711cOkfupHtLyOm8u12CDvw6lh2sjSHddI9e+O9LyXNghzjGoxh5X+QHEPkuw6g6UNGIKTUZorIAX+/PEjCqtgAZn2d+dMGUjQ/yqzU4NDNEUruSnQ9WKZPLcFNR3FqAGMQ+YQDmvor3X4y26gSYBa+FMUj1zR7bO/Kzn6uzqgV05OEUaku02fD64sgesl5xtZCxXuD3/y8UJh0evpVNnqZjl7nHtdHJEz1iPw8tVQfS5IaM9oKJls6jgch+2oSogB86+RqiRN51fF0C2FxWJLR7gAAAAbEGeckUVLH8AVj3aYugC4NBDf1j8zMKFmgUqA/4H5QOrsB9F+cU+2/mQAvVS2KQnIFkBnxnoxa+oLuGBlu95rnIvFHNDBsDy0k1DKW8N+EFEF3gZxnFb78u9OdmXTCSr2ih1Rd4vp/YHnVlU+wAAAFcBnpF0Rv8AAAMAAii3fCczmfJjL9F6muTAlHBQadXCU7DOUHEgAiy2Y15E+OXbB3Ctj77Q+dqTVko19FtM2cNjTbx/O+EN82rPBeA70k2TdvCo5puJwawAAABMAZ6Takb/AGvbTKAAn2Q8c7G9MOb2fiNkxr3Y8CAA4fSp788d/t6hHZRHZA2LMd1kqpnIiVMrMt+h8Y9JM+wmUvsYzBaKxxrMucNl/gAAALJBmphJqEFsmUwIV//+OEAAAAMADSkit3AAWTX3nbmGuZjYiMs0LgIK358BrFYhYR+XgMeZq3s07XEx1JP2hU+MhQQPHuJZSQep/wV1h/gJd45BSwgLTEv+enTnBGwawsMQUkkNoDszplHP9/HYMBJtkeGqmFgf//INeWWnwzAE+q0bxda6GQDR0hgQHdtrDSmwlInS3Cj/R3Unf3Kck9yqFJvtUnpcAhBYt2hLXKcvuZrhAAAAUEGetkUVLH8AVj3aYugC4NBDlEeqAmE+5hVRcxT99AEbZnZ82XsQSD7I6je69EEwx9fVsdErfSruInMi+mJ/cu/tYzZurbLaJMe6XyUi+FJAAAAAIwGe1XRG/wAAAwACOn/tx2xtvdP9AQxXyNCbreFOeierMFxVAAAAHgGe12pG/wBr20ygAJ9lmf3A6zWvhVfBHMdqZrrZOQAAAMhBmtxJqEFsmUwIV//+OEAAAAMADS2B0RrRAES+mteVWKpy3P6u4+rfm4O3jsvA8Es6C0tZMbZuUS69UklISFcmzvx6GNURn0oZ4SxXWCsORLVMWYSMmFToZ8W1Lv27q82Gi6YHsvmvFhzbU6Ac4ZFAA4sxOVLY6IXHU/E62eoVApoXDNJncK3iX3BMykJRVZVNUxp9mWDO40wHDs0EpHaBpk7GVoCbLzFXV7UqohWk/O5X87V07uZYGEeXInS8udf1RPSoH/8/7gAAAE9BnvpFFSx/AFY92mLoAuDQQ5Q8yU+q20FoH/QBG4tNbNsfU9osdXxKWqBydT0kKzJcXl312Gun4yv4mIiT+RcRAr4UQzd+wNC83YO9jFZhAAAARQGfGXRG/wAAAwACKlbDiqOz25gS0rPTNXivQG5CP5/FVkAAM0AIRppOD2Rpisl0RMQ25HNIwCwujTrKDvRa5FdOwsqA4AAAAE4BnxtqRv8Aa9tMoACamR/Z/5nSYoUQArjusb0chrMsk7s1wHhjK5i9GzgMmibAAfoM53zHP7QOZBCTfcCgS5eAGULqpl8VYT2D7xSbw5sAAAEKQZsASahBbJlMCE///fEAAAMAAB/d/2sxqOF7rh/ZYZsACH479YMNLlnDJnDCkiSgslT4G8e/BV58enuCe1eEMc9Uf8T4rMagNxfmtULTrLDYZVy8i4beL81qmIXGpM8XEhnc0s7RZJnSGzdmp7uLnMFksFYKORkAQeQLB5KaSfg1beWonrjpavMYNfm9gTFXrt+LIjbaZYGNK5/+oBt3sfUlenVlTcXvpWIhUO1S3eHZ5m9e/+0xHoPPRGlStx6XfGwg0ijSI4mnYLbw8LCe+JArnGAAvZzJ7ndvKzk3Kx7a5vvyMijNdN5qTQ3vmq6Rt98pmCzu1Hh529f96iLXg7PkY5esD/kAG6EAAABxQZ8+RRUsfwBWPdpi6ALg0EF56jRxPSrFBxoOlm+TqjjmFUjAzDgPiwwdWMjn/rAAENbMjyuiH7f5mKRVCYn6UK6kz+tnRQmnoQHwLmWSwFxFFLDXbiSQhfN9mcdp1E9pY9kPvuCkoFTBZQYCKdCelw8AAABZAZ9ddEb/AAADAAIsCRLWk1FUStsXmKrG9SwZGSGm7NL6AG8IKkOA2VOAIkKDpJTcgTALnhqECgqWFXP0uJ0WhZfpJfIzg1frCIfKcR5oHciquu2LaalGW+AAAABWAZ9fakb/AGvbTKAAmUZ3V4bKzXTEI4p7+ThxeABYNMGJoSojqWc14JtUw3fW3XCjF7lKrdRnJZqmmG857MrdVxulSYZIjgXuJK5sjUp7/tM8CWqtePsAAACqQZtBSahBbJlMCE///fEAAAMAAAxO/830PlPxoy5fCE3W97OnsidLdVy0WmBrBEO4+1cEAYyA7+Lb5Vjr6KMidpQzgdrnyT7YyOXLMnbC2Kb+GEvI1vXJYboOSLz9iUBKinXm1W6gHN2XW+bdbnFM7W86We21mU5QOoGH11hxtqx7pwUTmgMUSFqOUREzg5UJnmnAiQRf0wfjiCmhMY/+9MjNXWau40fTuVoAAAEkQZtkSeEKUmUwIT/98QAAAwAADE7/rMB6N3MQAOBOBxQohzNJ1fnbQQMghsSPfc3WYoRh6NirX70m/trMBc1RAcXqv7YuRq3JL3YW2TEQgEcTa07olDaukjeyATpbrhgl15lw0KVpxZmLkkkdsnc0NRu1QniUlz3oCuJ5h9pfbtz3kH/TkWVMrShaJUgI0PBRh/69Xhr+D7BQBllS2AJVaGqcxgKQ2OAPNzWTMO9kmiK1N3D8tXhpKySrfr2NOxSkqa2YfnwovGuxWs/nmFF39CmrrpMK+ert57eGkI/zG0rCB7HJRkaiRphwrqtWquDl9qQTWi9P1GgBZk+ujGvsK/HJg9KosqmPr5h6f19PNmntsd0++cg4KNFxLCPmo4tlJqu9QQAAAKFBn4JFNEx/AFY92mLoAuDQP3bHWAw9RK0xkB6iSGCoYAShI1zLFXIwYtXx4rADzDc9Zu5X50YPVvXEQyISa48XDJFOjEE8uQnvatNCh1BUqTOy0SO5jAR8bbrMgNBRqKKM/CcCbjuKZ/PFdF557YEg7vFfuArkrWDmT2U9EzdKA6yPlflBpPJSuM51U4RriOw9vmgA8ffrFh+uZJRLeOaOgAAAAGYBn6NqRv8Aa9tMoACWsprj8fCO72sdRTOCRmSeDfvf8w5ABbNoj1Dh9VwoB2e/QPEs1DK3udDRRclRDKEnjXFBQbclXaXre+IiTqsXUo+qjxRq59t3q7byLeNnNSKKJ4Jp75dxdoEAAADjQZulSahBaJlMCE///fEAAAMAAAv+/6+UmtbACuxdDWZpC9JXtijHLtB9w6n1TZxR7/eZCHOFUGx3dU7VoVyF7fGzQrExCBx2Y5dWubU/PZ8cEcd8grCYzkeYox+Wywiif4f/cVFt1Sz7wuhwZhs6e0zSOkSqPPZeSQvdkjZxOlzS0FS4NDKnVmRwLxrYH41dhYqvOaah+fFim6DroP2MLKxXOWCGMp0y8W/ANh/2rdbXVuIyyaVGFsfr5c1aV13JJwcg0/U9XKSiDJwrz9/CuwvVYVP/JvtKFoVczmkEZo7qUo0AAAEJQZvGSeEKUmUwIT/98QAAAwAAC/7/sLoPzDblC8AJY3Aa3YRXAKF7OGGGibyCWLBX5mBnvCABO+DCdykv+CKd1PLg7y7GKmOoO0n0xbGl+9F0cQLJ1jvSXBgjhPORE2o4YL2IisKAHo6Zbrqk0yDVmsqI8jYUG72VnFbJDD7EkcBwipa3xCy7+9p/zhBwVu8dLM//HOz0xG5d9BezkOOEhk7e7xOYab5RO6tvut2+Xuq0nuAKeJjkZkG3k0wJBFiG8dGgB2nbyr/pwlrsBdxLr3oav4QHAU8xidy5DQTQcnsOKOENJwiTqkJRfPYHh8CH+sa4EDdkyt2MclIIcnVYOf/Y7NCcHPfikQAAAN1Bm+hJ4Q6JlMFNEwn//fEAAAMAAAuvJ9tC7o3yh1JKZ2eW0tcYKYcWKLh1JAL9XyjTPLARLIt1vKqMkoEuKA4KUKF/1KMMe6laotglQMYkzo5r8hNu/C8xnK4gtRuiMSEcEYItlSl+zsDPdHIiUw9T8XFvmBaYsxQzQ0zO8r6hKhgDmN6TRTmCe4GNTnZ+OoDjlvmU8ZTBOcdmgmQd90lVCEYsKlNONG8L3DeOTJOM/6U4fQxzEnSZOf8FHTPdj1UBtWE6sPjrsqQV42du61MsWoe+Wx6RDQb6NK0aQQAAAGQBngdqRv8Aa9tMo9iX4RAXtbJDXcy/5hF8f5sQWAC0xw65zGhPIh9b5TH0+oKXHa16nCRdRo2zVPYdPNEff4xX77NgCCMTpY/sQtfZAxR+9ErqZIQiN2K/tp+nIf04P1+z4XwgAAABD0GaCknhDyZTBTwn//3xAAADAAALZyfX/5OFAVos3GG1D+rYQRPSwLxJGUJLv5OdlXj75ITKYYJLGqNV9FNmtyUmgX5TLeEU7peDYmly6BrovDQZ3EgwY+JXCi5aOlyYpQrec613GEay3XJRew0RPChPUVtmQO4KLtDZCBwB14NqKcMB11LVEyGKn8gW9CQJSdgd5hI5qQi163lcpSPJNAmX1DM1aOJ9CzJlUnqagsrUrEAx8ATJyRRQ4vTQgHTkUM0s3ysPTzHKBRX6Ja2uBBgkPcANqkkCXDByZfHXb2GcQC3DT2GNKoVtb6Ow68yA6QI07M/DeVx9WXS9ZVWwC5RDhk0e+huc+rMP/bJh2SoAAABgAZ4pakb/AGvbTKPYl+EQF01xWR03yYLzwZVC/TynmvIqtfPk1ACzlgXMzcwVVdS9gXBZxfXvaWw7eMSPAGyEVx43aOSpzeeXlUEHD83kfPmA3OpUF5C5Tjqb0hK37ofhAAAA40GaK0nhDyZTAhP//fEAAAMAAAsJD/KqeNIDRBTFkpn6ClL3CN0ZyM+tn20c3kUMlVeYfB5d1c0HOMohvJ/HvMOdJjNZQFpIh1bqrPPAxYSpwFQgIcCR48xeS7uJHv4NMMyC3h3f4nxgE9v+/iFfxaI7SO5aaVeVymk4ilafTTk8xFknDNZKSvHNTBbq+IFnV3iCetWl+A3DzNXl1CT5ZsvE7G0BFDkXK9IwlOxOkz4j1bhlZGpGxB+0HjPWjkYLYjttD9nB2wsnKaxU/wA8/aAUBDv7idGGot3aTD13gP9dR2xAAAAA70GaTEnhDyZTAhP//fEAAAMAAAtnJ9ZyEPAQkjwFQGQ5iWlxs5qrWiAncezZ2GV4HD60gXtHTef5Khy4iKSj7h3baCbTTwUHZyuviVoE70AZGcJvoN3X99XIcJVDob/7RCzeMZejckKkNTcVkng9SHcLLWBHDDpmcSVxeTkSORxwT2gjYb5IytIGm7b7PvTvE/3jM+SF1zOznPZYvoNnbvYHWzmghxMKGmKiMGO0QCvQAMdxmH4c43qO+hfEIi2dSuGQBexppErjKzyYaMayeeNqo7fMVEXyQdvtwHNNXi/CbzYA3Xb++2SiBmyY7Nu8AAAAsEGabUnhDyZTAhX//jhAAAADAARyyUnnimT7eAIj4ARd30dOrUG7RGU3k1Do2tzmzOAN5x1bmvsZVSg9UODdojmfPk3PqDKy67ze8iPsSv54+6oz78gwYb4abFktDPrMM4WiN0Ntdj1lIV3kMUxNAsiTIsbZuWkI9aV6koiBNAr9f6shaLIIridNSHbrSDDhHbQrGHWfX0O1KssbWgsLbKmjLv/p4lcjTpZepGC85HH1AAABZkGaj0nhDyZTBRE8K//+OEAAAAMABHlWpRohwAhDWHfBWpJxz+IUttSH11OfGycl4SVz5av9lygVs4QZeJuin79VUnxsyrq7sDi/Y2ozrPGMsXCToVXftXb8GyjSxyExAM5/NVHFCTaOFC6iFV4WFGnHOeGpQjoeY/sDb5N861ZYnEO7Lt/CD2p4Fga/tcS0B5uNTXf5kZfv9AEQgUEUWAsZVZQ1q4F0nNGrV06uGQsCO/u6xM1QwvoPHjycjPQFPJPx8p2UGDXCRJrvnAvEIZSTQF68qU8FKvE1KD5CIciiGGDbvp/RAobFXC8EjF+kzpu1zn8MkKlQny+mTJUMd/YBCCXhN07QwvMPUyPM/LzuJ3bW7Gvq83K1aEPCuoNVZagA7/FYEx+0CRD5ZGYnELHgJR9+PCnHF+ko7vVoPFOVskHYMLFUgVNQiTakU+nGzXQvC5otf/2rieRVBsCmXXvvW8wM2fEAAAB0AZ6uakb/AGvbTKPYl+EQOLJcSLhV9EcJaG3ulUYPhVQAjwghWnjc1vKtFnCbcd0pzE+iPgjqv9OfeRRmJd0LhWpZvosbZv3qajWrieLW85x7gaJwjBsKh2N+cAIx5ucyUxQxDeiUkTu0yagoweqCA40EdC0AAAETQZqySeEPJlMCFf/+OEAAAAMAC2cn1oaK4YWA3vPAARe5RWxH7xIU4m/3UGLZzP6brhD8gaO9M+HZNvbxs40HMvByQG6KRhokFvXKupGbIsfuFcnA+E7WcsFxPGGyjuN0SfySs9ldywi5cuCayEi1iMwHNHUwufLMFZSIyf+uB1FWZtnjmbSNRXALgSononYzchXxyJYF+WGmrNy6dzdAzgaFSZMZ/mE/ejnSwW3jFazdz+a4uzP0Sfj3yYhpvS7PP7gLlGOHNQ0W8f+gv6G48/lbv+FSWKuzWV0ypxKvXciAcXspRZ8hLy1Hgiv23BuGas9yIxyUQ6nGraX0m6KVJ02IG5BS1vfWx53gf7Fetxd523gAAAB5QZ7QRRE8fwBWPdpi6ALg0DognBIWVk50kbrYklsmaZkh7OndekOg1Rjr0ntu1KB8hPoKuzElyxQA1ORi7bal5eD84XhSky9taQNhBjCgwFHBOkbTFKY2g8xNl9qN3bAopucibwYpmH9eJIbjdxBHJ+nIQMO3poWV4AAAAGYBnvFqRv8Aa9tMoACC+VTfJJKej/VjGGa5orywO/CZ4jxA0xEJCZMALVl758aUCtdwpEEeoS5M7LarflbRPlC5HdAFCuabogXS36ReOePYzq2ntOq6oThVZvJN7bLa3pA415cGCSEAAAExQZr0SahBaJlMFPCv/jhAAAADAAtn9tQB9Ofyy/+KuzsHpOYmMax02aoPBzf5y1y1q3Y5NzMj4n4vZ8q37M27+PbvLJ3u0TX2s+gu3SOkAGRqNahk722ZHwgUZ6DsXkGZWs3nb+hyxy7iZ8IQzN6FtTPUX5ofgRaPNlpbUyqUkpRy7PwQL6cxeAgsFQYQJC42uZ0kZBfEH3ctaEJ3GHo3HKx53C+7meEY4JDn2qWnWxezrMSW6V4LWotHIsxvn9Jr7r5PLx0QwJw0HWiGgCV71byR3C2rTzpwBLY3r/jvb/FbHnxMC5mohmiGGEpdwt7VAUo4FSjD17et3+hPQUj0ZyT5FN97C0SC/B5oSrZ34WdwPbMQYK5zv8fRpSw3TwsPpUsT9EHN/GNd2KpvbJ7UXCwAAABuAZ8Takb/AGvbTKPYl+EQOiI1KySLwvFIE9QAkkSbVGpBojq9b65c/8iLL5U7x3m8Uxq9hPjqP3YEREq8rYJDk1plYMoLTRvvuvFVtS+Duz0V/kvzYjX9Nf3oOeWe8o/wwUVC/AIbtV9winHt7EAAAAD2QZsWSeEKUmUwUsK//jhAAAADAAsSd/+xDT6YARiFPdpLnh5qqjozUdMruEZH5DBjyl2qk5AD5cYrSflA60HsP5RMDpj3WaY2JLatpMAaqjcRxCNSVWHowLfpDu9kxW+SoJ++sfi/FkJSUL+lG7r8mzm2wD7wjTg2LjbmzUZ1eVaodS43flOB6agvMTLdOxBH/lmV1/7ja7rnwouUlpY94DaLh1xpD1HeUri8kdaY8gHgEgPFKkpW3gvnWN86g34T7lwK30jZ8icHso9VYNEWY0xkRF+PSSd9ZisWakQ6TcrAEn4ojZNiz1qq81zpIOdYBZLjykCBAAAAQgGfNWpG/wBr20yj2JfhEDdOz3zL5sGRdMsl5Io4YSXhantABxbkvP5lnMQfSleTHbV7vvD4JN8BZsWVfNPmJmHhQgAAAJtBmzpJ4Q6JlMCFf/44QAAAAwALCi/qfthq6388xADZwChcyFKWldI960WvM8t19XOJ7j2ZL2Ep7mXhaOFYBVa1V3WOQkT6y9FTrToRxDvXAMwkYpBWX+1lrjFqEQambsGHgeliNtsyZOw/dOpJEsc8cGGQpyhbmUBCEPuORlPPXYdQ5WMqwRqglkMVi4NON0OBmpTUXO9Nhtq+YQAAAHNBn1hFFTx/AFY92mLoAuDQjwAM7Bmv67bV1CmKQFlaN6E6cpKQa0aiB5AyAOScL0ECDoGYXEiyDa5QM4YU28ef4uUDkbtpmiIG7O0GI31pzz8aIjYUfL8OsscAp88dib2yAV4FKPzx1HU/3nV62AnFhOVxAAAAPQGfd3RG/wAAAwAB2637AXkd/21DXgOQn3L4uSwRdlCVnoZa31Lde4AZcgV0Qrcs5oXJ+UDmehCDYfxd8GIAAABDAZ95akb/AGvbTKABUM2nfWhW8P+0zliHWRCa9KfHEHT3ACJc4X0lads9ya7qU7NTOyCvV9GcKCNYluXuT/sqBevlEwAAAE5Bm35JqEFomUwIV//+OEAAAAMAHG3/pbPDfpyEqBEYjKOWt8IkYQD01SK063T31BiOD5LZ8BPTmpO7TQji2GRqZnNKTNJE6Y2bIu8W/EAAAABMQZ+cRREsfwBWPdpi6ALg0I7C9D5oxZQBYqfmGsjFmzv5yF6UdXUYpHbxf3xAFWoEd035jFJUb+3RYfGpKQCrBWR4GgAKTvkUpLf+gQAAAFQBn7t0Rv8AAAMABLbRrc4KE57QW1Dy7Bo9ACHQTdOBuMSgvUMAbKf5U6VXThpLEjml1xDRy0HeVOKkkTZCU+j5C0Tx7KxNBskGcPwiK3BgPf11IOEAAABaAZ+9akb/AGvbTKABUB5nx94LSoRWQXQlkvw1My6v3m6uMuchdQsAN1zblA/248odOtgeKsHG83BSsJEn2yhR9asuWZkuYuiH/rONUQrmSCAdNXbgx5drLh9QAAAAx0GboUmoQWyZTAhP//3xAAADAAAbACrunJc8zPi35LgHvK6RScZc5agEoRTbfBo20ZELYibvOM38tryjvqvNrFqjsEdE9vADbIjDOFODYCqyiU5ZCkd8AkNI7pm8o/NWWtlcGiXmyKYFS4nUmbpEE0eYcYnjV4yZDGHcjYQYV+zG1yKt/CfqmnGH4xzH2SW+2yvnyOiGoazO7Hy4bGmELbjPqD65lzl1i8Tu7ULYohDs8RwM6pGAHEp9GpZGOTeQy3csTeRYmCQAAABdQZ/fRRUsfwBWPdpi6ALg0DogUqumdWGSlGf2I6BDNvrY97ZNt6N8AIuBNNuaUsPGu7O/aSTNOGaV2CImhl2lam2xh5t/JYS3N438bXiLgkcck9SPn/ZQLIrQBGAhAAAANwGf4GpG/wBr20ygAH8T8FFq/zzJI93S/hsn1YfN0Tx6F9bAC1rQdpc7PQBg4Pz3YQgFVMhlgIAAAAC3QZvjSahBbJlMFEwn//3xAAADAAAbvf9ZcWAZdAAjIxLINS7XfWwMRJiTUJjVEPOA3c+6BidfEn0GHiQf9QgoUJvy6/tdo7Gc2z6j68WZMg04A9KcashMMhSHA4K2/kj+l9PXlgqhQ2x+QqrYGZuLl4aNo87B+8MLX/KbGDOWPp73d986dvtMDyz4xDmCqadsjmRGE0oeBnDfsXbsH+tO2FteUOx4j7ep50q//gOQU4CeNZ8ZX8sjAAAAXgGeAmpG/wBr20yj2JfhEDcM/fWDkRT+QiS7z3SM82TwG1Yjtsh0qswA1L52L/SeW3HNd15TqpvObEwA7JG1GbDuTbfV4a/4jnsZ3a/3RkKucJ2s7g2/ImOY784LhW4AAADhQZoHSeEKUmUwI//8hAAAAwAAqPHMVDQkwv3PQCahj9RHaVLSHkDLihum+0z8Z8J1VTnPPXnB/nqzbgjkCCGv5Eg88kCrXJkMYWEdp0gMKKNmocdYs2I4f9dY9HJQ+I4AR3wgUVOcxBm8p6ECFnY6z4ziL8kY0fOUGc7SMlLOt+hjND4799YtCFIrwvPDMIUti9KnVPR6+mOR2b0Koit0b0OJ958VVnFvv/+AdShkArLlfH06bKf3YXHaWs7DKLPTphnQUsv13dyNdj///0TaIL01CQE2mRtbuIWzh6WPzWSpAAAAa0GeJUU0TH8AVj3aYugC4NA4lZvjcsYEA5cKP6CF5E2rYneoxjoOrmqpp5UaxQYbr90f/g/AEExeXNuAoJymxxk7Nyjifyb8719VoAs2WRxHLUPsBt5jQUds5XqDKTdhkoiCKOzFZT7+2iBJAAAAWAGeRHRG/wAAAwAB2lD6fViHVodHq+oJvT3NCSTEFsOs3geUCADf9YNAwL8btM1KGZPrvi+mBGQ+6D308PUXaSjs085W6Bjva55WxneRp8zwah0l+eEpgzkAAABRAZ5Gakb/AGvbTKAANN9sTjtIH/KE3nVg0YJ5XPGBRS0UmgAOMpzqTJf0AhmB7Uok7ORUrcHE660mSPEWQwSRKxmTF6GqpsEdsrQ/QISPfechAAAAnUGaSEmoQWiZTAjf+lgAAAMAAIPIkoUAFfB6yYwtnc7ul+CkUYMeyolDvOUhH7NwEYgEFNHZnq8c70dEWLk1G7uxLirt9Lvcqc1q03WJWuK0vsAHhaZXOI8dCflb8bIxp9Sfnt9xWz63un6V8fWX6nh4ULJAIGS6y/dOs/6br2rkBzobVSNQ46dMN+RUESJnfKpIID1KAIbVl7vhp4AAAAvvbW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAGiwAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAACxl0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAGiwAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAlgAAAGQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAABosAAAEAAABAAAAAAqRbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAA8AAABkgBVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAAKPG1pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAACfxzdGJsAAAAmHN0c2QAAAAAAAAAAQAAAIhhdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAlgBkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAAMmF2Y0MBZAAe/+EAGWdkAB6s2UCYM+XhAAADAAEAAAMAPA8WLZYBAAZo6+PLIsAAAAAYc3R0cwAAAAAAAAABAAAAyQAAAgAAAAAUc3RzcwAAAAAAAAABAAAAAQAABchjdHRzAAAAAAAAALcAAAABAAAEAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAEAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAEAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAEAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABAAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAQAAAAAAQAABgAAAAABAAACAAAAAAIAAAQAAAAAAQAABgAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABAAAAAABAAAIAAAAAAIAAAIAAAAAAgAABAAAAAABAAAGAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAMAAAQAAAAAAQAABgAAAAABAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAMkAAAABAAADOHN0c3oAAAAAAAAAAAAAAMkAABDLAAAAswAAAC0AAAAlAAAAIwAAAM8AAABbAAAAMgAAAEoAAADMAAAAPwAAAXQAAACNAAAATAAAAFUAAAFoAAAAjwAAAGIAAABeAAAA8QAAAF8AAAERAAABKwAAAIYAAABlAAAAnQAAAPYAAABrAAAA7AAAAE0AAADiAAAASgAAAMkAAABlAAABGQAAAG0AAABKAAAAVwAAAHgAAABYAAAAdwAAABsAAABJAAAAegAAAHQAAABdAAAAqQAAAN4AAABTAAAASQAAAP4AAABiAAAA1gAAAPAAAABaAAAA0AAAANQAAADTAAAAWgAAARIAAABgAAABBAAAAE4AAAFYAAAAigAAAGMAAAFQAAAAhwAAAGAAAABJAAAA5AAAAG4AAABaAAAANwAAAFoAAABiAAAAIQAAACgAAADbAAAAYwAAAEYAAABcAAAA0QAAAEkAAAElAAAAhwAAAGMAAABGAAABDAAAAGEAAABQAAABLQAAAI4AAABgAAAATgAAARgAAABWAAABLQAAAKMAAABQAAAAXwAAASQAAABsAAAAWQAAAS8AAACCAAAAYAAAADkAAADVAAAAYgAAADcAAAAzAAAAUAAAAC0AAABPAAAAlgAAAEAAAADGAAAARgAAANwAAABuAAAANQAAAD0AAADnAAAAYgAAAEgAAADwAAAAaAAAAFUAAAC4AAAASwAAAM8AAABlAAABQwAAAH8AAABoAAAA6AAAAF0AAAFYAAAAkQAAAFoAAAEeAAAAfwAAAGEAAABRAAABRAAAAHAAAABbAAAAUAAAALYAAABUAAAAJwAAACIAAADMAAAAUwAAAEkAAABSAAABDgAAAHUAAABdAAAAWgAAAK4AAAEoAAAApQAAAGoAAADnAAABDQAAAOEAAABoAAABEwAAAGQAAADnAAAA8wAAALQAAAFqAAAAeAAAARcAAAB9AAAAagAAATUAAAByAAAA+gAAAEYAAACfAAAAdwAAAEEAAABHAAAAUgAAAFAAAABYAAAAXgAAAMsAAABhAAAAOwAAALsAAABiAAAA5QAAAG8AAABcAAAAVQAAAKEAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTguMjkuMTAw" type="video/mp4">
 Your browser does not support the video tag.
 </video></div></div>
</div>
<p>Há uma versão contínua cujo espaço de ações é [-1, 1]</p>
<p>-1 : Aceleração total para a esquerda<br>
0 : Não acelerar<br>
1 : Aceleração total para a direita</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env2</span> <span class="o">=</span> <span class="n">gym2</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;MountainCarContinuous-v0&quot;</span><span class="p">)</span>
<span class="n">env2</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">RenderFrame</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;./output2&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">env2</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env2</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Discrete(3)
Box([-1.2  -0.07], [0.6  0.07], (2,), float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inicializacao e estado inicial</span>
<span class="n">observ0</span> <span class="o">=</span> <span class="n">env2</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">n_iteracoes</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># acoes</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iteracoes</span><span class="p">):</span>

    <span class="c1"># obtem acao aleatoriamente</span>
    <span class="n">acao</span> <span class="o">=</span> <span class="n">env2</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

    <span class="c1"># executa acao e obtem observacao/recompensa</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">trunc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env2</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">acao</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fim</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n_iteracoes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ultima Acao: &quot;</span><span class="p">,</span> <span class="n">acao</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posicao, velocidade finais: &quot;</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio finalizou após </span><span class="si">%d</span><span class="s2"> passos&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">break</span>

<span class="n">env2</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>

<span class="n">env2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ultima Acao:  0
Posicao, velocidade finais:  [-0.7458525   0.01244828]
Episódio finalizou após 1000 passos
Moviepy - Building video temp-{start}.mp4.
Moviepy - Writing video temp-{start}.mp4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moviepy - Done !
Moviepy - video ready temp-{start}.mp4
</pre></div>
</div>
<div class="output text_html"><video controls  >
 <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAe1dtZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1OSByMjk5MSAxNzcxYjU1IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxOSAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAANs2WIhAAr//7Y5/Msq1xA0DVUuHVl7uFSgaMoZ2nkvUzAAAADAAADAABo/Ot9/srZ0dc2TAAADNAlrD2ajoAyREKrGoBrmFT/jbr+uKV63H+jYfwGJbVbOn0m1S65oHQGpImqAsySWWW5d9HhpxanDBmZZ4hwTZLG5zws+xg1ZHx6j6STz4DqXbkjtj3+BkQFNtJD/LVwfkW6Q1ZyYS5LqWHgxTbDafHmxytMOgl2OiwH+ipXzwuuyhKz4aqAvG/R51rllCin0WqN1BvyulgAJvuWES6pcBaahQ8kjJcvXTs2FQNwlCiejhKF2f6DxTxMC9x7Fq8ScVJXWWN0F+ULtMhKkployw9zRywa6dFRIB4g2vIeFxXVVHY05adbe0p9zi6uVuA6oc/k/yy+4B1upje23oG8MDq9eAZdfd3mrB4453dtBWjYQUzqOIw9sbShslNlO3szVnzmG6AuyCIZRZAU8iSg97YN5LEQDNsSdhk2O2Qykyyk5mJLyrLLuVDYS8vy0y356/FQyKN2JYuyAEvSCTQ1m4ByXG3vh6APai/Td0OkoBiOh3eSz6TfauSbc1nbjgUgOUlF6f28bq27RGk5D5Ylj4wM8IChBPln/Ll6lkMX12yMNdzJnaScs97BqF9BieRGrcxYB44CzS48gzYAjntUY19oNAV9XVRn2SZPmyuVKE+hSJ+gHvDfUBuX4aoH4Y5suNMwHD+Li7dz5/8ypCFXZ9HnLq6iSie0/GA43kkydtzRBW9fwtGy6FtT6bKd+Zf5aoB3auO08n282j5/f2BNxtGEeUi++ydnUf5LPxtepOVFqIG+HUMSIlT4WJL+1FKTEiyJE1BsIud8KhvfPfE2Dj1L9xSD1UGZg1EKMgRtA+0UwtnwwDQLduZwR5kgH6Uev4ZXC4qvgpodYAAAAwAAXUMmffNUWjvKIFXMOWV5wzPloNRcdtHYt/kaJ5OJjAeSZ83W+5gZGzD9gB8zCmD8v7Iaohu7lBakLBewe+WHONcXldVAt+DE+RO7A724ySkuLyXTEtKuX1OEBXwAAjIxAAykDAvKsgdAsJTHmG4+uAkQ//nc14k1G3fG7Ks6JaqzYsMBBve0CFx5JP/oGIAA84GaUh9aP5W68aZT8YT5raZU/f7672qt9JtGNEW9IOqLr3ldRD6415UYLtJMZX3OtZOsUo6YxSbk9OcR/F0d4raBnwv/U72fb7zKKV0j5BdxDD50ApHx1UGkh0+EBCUWqUVKwn6Gx+0OBfPHhfIuyVq/gKY6UoQHMd8c6Ch3fK6ROFM94lxuL2WiWS/o2REHP+nFN6FsSW1CfHMMSwE4fe7ivJvVC6bxBa0B/2QF5f4VRcEpbiQEpgDAISEweYZoleJfeaWwUe2fvYK5EHRi0779rjDf2hzlprMlkA+NQxmYCNeVF4JIygxs1Jgab8clYBWenqXAopMCSnMgfqU/gCzuuORriGX+ZZq3UfPGlrgmle2r8zKphaMKeJOxGLI9wCQwKPWXxsUomRbGUMsi3BfhpU1DnGZK6LwPJv7UCsdVBAnePRHFkwE/BDAFcTk0IHMjrE82H4uFhUREs74eDR+LSqDKWXf1OJMcqdvXx8OuNUNZbBRN+4gRyOuDiZkAY6adXVkwita1KhioQQF+6CPZymDpt5ZQcLGZR/0XTn2uj0P0vsEIz6t8bqShu24muiQC9GDPACJUijluGbr55LQxMEXn3O49snqIGu+gPP1/q7y999lvQ/+zD7AFPH77tjQmzuQrqNMxb+xuQdk2YTo/Xk3VjpvvuPeV5V5RZpWcT56sBZfyksAfLKTt3of5LScuha0bERNOAXGBDo+51HLCkjyEVa+N40s1F5hPdRaxgNnQ2gmppL4j6YmULSCOUTYKm4TLVg1JJ3C9eEDhylu61xk2Fyc/yKE9RQzrZeRGTHLyyw5XGTfWn7XVXku/e03MXR0MBKXQSuT9jMAORL46jzCS+hO+4U+X6UvXVnPo5BXy98WtehDbSE0waE6pAoOXBTbyj2DP77BmDxCj7EEGMs3K7q9xh+fBYo2se1UV9GYt1kHkOmuM0r0q1DNC/38pyWq9CRmVscTBrYQSlFYFcZBU7EZDnAnyLdHf1cIBEdNrYjmXFKTsGzbGk12OkHJLwJjByqek9ekxH4P8ARMTGWPN2aH80hSn3QoJBP9bPEHsOgb/OR10taqjLtRl1ziX7ZkwNKlLfwPO39hp5BNPga8yC9ccOuNCarNhBSn99WloUh6HLXFzDM0xeP/70GTPFuPKnh0pGxBt2kgYX9ab2Jlyl4kcyYrHiELhsdhHOB5bA+h/EX8ZPjEvk8I3mUDfF3u4rk3hK7dzwDqw+6BgHWUBQKGTRnVhSNLNa0PjfVykyVMcLkHLDJvKqr+3a6V28b9mwB45nkvHIMmHqQ/7I5B8LxaVFQUCXCxzUvje7zXfzoUvs8/cFO6MDRfW/5KShuFVr5VvQeKOt9c/sGDjr4OgvTgH/CSF8K1HNbABIXpr09vDGaNafsCwrpDhSrxTZ3Tzi/pBXUo03z5R0Y/vK9bMp2cAE32Q8h4roWsBkMPAoBE2n7u3ogN/1R1WNYr17SBwsRawf+AbmEFfqRkAAB/C/XOMoY7iSjry0Z5KBZ7uSOaWuI92sJZM6kZzIzaVcrYbtlM4/A42BsoEaB/DxJKLF3Y+NERbCbbmAuld5Ml7IJ4b9AfAvSfKKv0Q40HYAksma+BfH3LZpcVW7dcwIZF5BJU1at9Pld412ObFx/r5Lz2aBenwLsnkplRsVkEMz240o8HZhrTABC4GT4pA1uRaqt2bemG2ATQdLuAAmo5S3eD2oy5Ut3Q+lBiXW0HPU0CzfrOlvAwgU2DQp0yiIwSbkLfAKTAOnkOSZDEid7gVGSH7x2m0JLXEhbyMZwn55WTSG8FtbBdizSnYrpszd30/irnaVbzDPSXTpRVv/ON4Ntyc2ZsiadiBFtVv4Js7S5PiBFI/e2gblfj+3aCAzFDV7rwVQyxu6oS8PaFZe1gMyAEpFc0ASMKSKVSrg6sHfnRj7cbSikZN87zW51f1Yz2Lpc06yEBZSD3VMJ63YyHN/bNTuGw7kRqyJFnSuWxmyIh/pM2/YDZUWz3xNmszGdWFRbkJfN8CdIZmveQw6GpLSUVLQRrJK4lDKctbGg7wYEx1+19hHOMnnlGwmIwnHlOuXShVt1NxiBMUE8/vGG+KFTfCWem0rcJy8a99w+Oue2MLtjFJOb4RJ+AIeK5n6tR3BqXhEIefqeuZr9dQWgqr/ShO9pgjN48c6RN5wAmGhQmYemVR/yforMs2C1GNpovLQVvXXXEeicVzsobpwlrHBLh997+DpNlpKQlDlPpFEcDImnmVv/GPn4OU8mn0mpzp48G0AnQ0KLgtfN6Hsah38w4/KdvyvS0B2ElEzGycS0qyLd9D/fA8bSsmycu5maVLs/xegZjuTgPFz2AJ3yAMgIgAGHs2tk3GZhHKrztXvAZclzyn0JoO7cWVnMDCBeX0Lw2MteOKZj/bgokPDNTkVSqFVtZie0gq5xvSszowFBgIqQa8wlL86WHev5gBdOS0o0ebSuk+YvSVdPlgROgi2G4iItZsmhFWZFZFm2bAqJgGz+nGHvfywmSENIzqjgO3Oy9QzDMWzz9kGKrr3+qSgccWeplmpStJU+02kE7eoeX4E/gAaTt/aG/cw+cgn7oOAAGWvz37ijMlN6Y6lqGkPKZIOWsRyuuRJu5vTFJ5M/DyhnxoMJDUKwCoSyYhG9gn/dXWnLEUCZ2oDfje3ZQEsbYPVkiDX1qCFSMGm8f3KhklgfnnNL/0+u5IQYPljUouy0mQ2a5Q6vV5A9s9DttAUJ0/gOgGYM4xe/8mHgX24JbSDKbP/7mT/9uTui/9DANYodAgNvQkbbYOv97JXjRl/XZ2Bkb+gBEbP/7nYn97GAv+UxRO6OxHJzLxZEARyJ3jl0XbXzU8P0E4yHJUY5obbn+eq32j42hbiBwU04WMV7lprwQ5227cmTlr+qFUhN2Olrav36MiFN9O31BIRervC0g3E2OzaqF5mWL4mfRafiBX+mYHqHxEOSg+VmTOXT7IzBCmrvuivCjeJVzuq+jHZtr+6NJ6AWoOXT/9E9wysXIUjN28vSaVFVlotvJLAAAnK/J118dnoZV92JAcyB7SSyVNyGFqA4AvLLHeJ9tcToSlpxJ2Gd2CYL0zzvWlf0Bz6GLQ9PHCTAZ57czFdqHzUMfLAWPUmC5s/g3Opn0QkamJk1Nl/mQO11NIX/DH7rgNy+Btnq5sylplMnzMN444/nRnTEG5m9/Gb5vLskqy7PVubsMuHb19yKVFQA31HMxptkWBAijiOjK/m7omPWYhD6n+s0Oyl010KMykGDWiL2eKqA9QYHpdXGXnemrYSlknDGh6pYKectKapU+2ce1MrpCY4Uwz6PiDZ2YVQStRHUiVvMQY3mlt/6Nof+BCEGYkh0Zgq57nXNczdwmFaDkixVQEOOP6suBAAtsM1fODjOrL6Yzde7w7R3lXgou1PGpdxeA9ORjW2sailNqvEfTLAQPeK5B8GTFnexZ/aN7UgYFeizskSralqIBuqzuwbBDLGORkYIyXHVQ5K5TMTkGjwc1NnAoSqLE/UXEqi++6Rs91NW5xp3pbdA8mX0AWmUHP/1aLYs8CxABjwQAAAKpBmiRsQr/+OEAAAiq/mgDFcV66dd5vOSl5fGvF+Tnp/VD4wucSZzVinnGXmRSwX1PHpJXx3m3x33PIhJq14Xb4LsAo/YtO3qMU4KVbvTz7vgsg/1jfHMBdAKlZ5lLWPgZlNauFs5EHnX7JEuimMGrZ9y47bqgtN37yytsom/7trsErCYXXwZlXGvi/kHeSNmhUASubSxPUQCXj3w1yEWwnnROJiAzN2HoF3AAAACRBnkJ4j/8AVj3acwgmwiDiTvr8QRtPhH7AA6eaYEvFUAEy5bUAAAATAZ5hdEb/AAADAABCobHwTrqqQAAAABoBnmNqRv8Aa9tMoAAzkegXNnImHf9Q5cesmQAAAKlBmmhJqEFomUwIV//+OEAAAaVoGAFKbxDa/dtxTELJa1mVYjvFFLpfb4pvb7xBrstezRrmKDh4lDtuDT0djUQgJie3N0/7qJrQkkfPH0gvlHwwNtOKAz2K0myUIlPEdHS7ogDt35eMHmRCM/jfLI/1FEReCT+PoV6JbzBzwH66cWG4biRvviRZzvNg3J/qlEaZIY01SBF3IJaQemFZwYXcJ9kY/9iNUF4hAAAAQ0GehkURLH8AVj3aYAAmKT0xXEUAyQhWpfyh+LBLEk8pcQquAGzbdlpbtA2m0V1ph7el7ox6Vai5lrvGfV9h/VCnjYEAAAAhAZ6ldEb/AAADAAC5/Al8i9zT62TpAtGo+COeeqnnv0bXAAAAHAGep2pG/wBr20ygADOR5/649H9EcBK1BzVFgqAAAAGyQZqsSahBbJlMCE///fEAKzPqASrfLPjoElNk83TaiMC7ZzDUcDvPB75qw6cCoMABXaNEUJZPNdOQ3jFApDhN2Z6SdbE0OcP+8SQXFk5tx1niwP9+xeSUHX3aCaru2X/gNIiXzK6E6Ni+YxAQzPgyqtKMYSH1BhuhoNvQgeAcoNkPicmOSA7J7II/NkLwmPRm3jDkIpgqEagqkExeDibRuId1nIW3Vl7XrTL6I3r284V3oLvI5MLvjnGiFn5bDOZP9s/VgSnEa0qgbicIfSNf6JhDes8VF5QcRD2ojHex8wxEuu0DWYINwiswDnKXyJHWGaDLaBFHrk65WUCmuNsgd3IIQr0SbbncDZXpFqJZ88zYQkS6sWGbjlCKWVehvaUP5SsvlN2IYaYaVbRkZDwi0OrkM4rylyZ3nDsLezykemEVmTMtkDFSftYST870Yn9+1qCXm8nYjIIEru/NfxOH0KwbpPuRKFbphZvBdjoDVjXiIM9SoN0B9Dgt+8mKaZT9NP1WuSucXCT9FLF6r5jUi0UZw+kzLfXcbOFqm69m8NQofz9OZ8Y7qvlMmABM76Y/VEAAAABmQZ7KRRUsfwIr7AmJ1noIHu2aZihJj4DwZ0d0gfB/5f8dI3UY1E2Bl1WHT3MKAG0Bs9MeCGJT9l7f3Hacr7KRqTXg6nSSdIFCT9uHDANFc4g47QSCgt44AIC/dbz2spFEpW8x/p9nAAAANgGe6XRG/wAAAwBLh5E06lKCqoN6qOLDsReyqso547CUgCACz6w9wZdfYmD9Hzr2uFMQvytdeAAAAC4BnutqRv8Cv4Q3rbX1WFn7NOGBSE3soiwpiC4IU795jiuCaV5xmuQeMIJoZV22AAABt0Ga7UmoQWyZTAhX//44QBDBg7wBK2swqinlHQcX0TRfdLhCIi1fryiikAFMz2EqF1b2NlcVsUHYDIHnZvO2WSbDZtBTHi5ctPdz8EH1akLboQZGyP+QEv6jGxDioXLQsWafV7nMQrT4dBseP3Bz9IXLod/Lyo3mRmveEawPTW0VyMAy7+1Ww3A2EI304ZlbZK03KiRzR2Xk2y0LWtebtWnrpUni0c3rOv6WIl9ruHYwjg6nas0QLgrlAWHWqSusb2opU/MN3w3RjslUwLFhhP8ndzgE7nd16KgDpLxhH+LBJZ2CgX/y0AtCgOhkR3DEn6oE/a0RXf7INilVlm5EaC1iBHJ2jO2PQYbU0d20IzFJ1ikLlFMTOAH9druWPsRBQuxtRH7eXe7KA+h1+XVZsYzNKJSYs5WGKEN9HKpfJ3lQdsFwj+Iq0S38O1FtTEgSuW1AUoz5ZRgIponkxE/Jt3c9evJG4PxPWk6hQCe5bg56hH88+UE1Bo9jz4TBAbADrLL4wbKWTNK/o6TPQOtwDZx2mw2KDKzaSL5DGfOriI/0xjD6H3AE79C7y/zwG7NbjJXlc0HJCUEAAADMQZsPSeEKUmUwUVLCv/44QAAAUbucoEwmIWzMxrCZRaAOXZq/c47l7mxdJ/o/N8bx551GiHueB5c5nN8JyHOgoug31xH+Ym3AQ8Ol3o0+knHgja7iSztBYjhcmVCeeuRdSUKQz2UK//plmThkH5LkO/w31SIN+XXhxQdsK1r5xemHpCQv1B3QVxlbKUHOh1D5v8yC1tSzl3n5ptbW1KMDjcskkoeal3GcwiYLgReOdd4nXpLyiDSt1q+mP8oQ2DLS2um0/5TyWz4HZ97BAAAASwGfLmpG/wehgFxjvMwYRmmAgwIgEqAJ+oFomUB0NBesEJhjDv+oAA4eLM7gpdEeOkOgKUjhh2xpt2E5Q4dvadlLwQmp2GwOPJMmgQAAARVBmzNJ4Q6JlMCFf/44QAAAAwAE1ELwi1xKMcW0esMpBKT2l/Bt8zkh29/IGEUCSi8ZhYliL3pSnKHrxH0TPMkaSCarAw/h3tzVQLSPfcWDuAU7yHT5keWtupt+1+HxeiDbYlwIFaxq5Ur60Zodh41gLX35K5OMRhVfcdQUOlFEdgm37s5PiAnAUUqHE91tMvuAkaY/U2QC1w6f8u0B167H2G4oImJpZPrvKdLhcrVHt0Qi/doJibV2XDxx0vCHkdY26t28vDIqw3nXE/Y+q8THNaxQaiPmcJh/KnhMSRwrFlP0SMZHNDHTNlCByt6kip9L3t4ejuvNBr67BQkyXB5D3K7y1DZdk6y8Xx7wt+vlj5cBsVegAAAAUkGfUUUVPH8GNQdkuNYnWpSOlQ502sdi2EwbA9XTw0Uknhiq41AAsqc1vKUmW0EOrGYWoCXtHTLKAnWNawERrHc17eJlxVUU2D07zi+NLTNas5UAAABHAZ9wdEb/B5htcREleb3QADYYbJpx9Ymp3xPVs557eKmb9KobPOkANgdnfqib4hmuyRrmVvXgBA1kgWWRujAUY1O+EVz2rSsAAAAfAZ9yakb/B57LuhrypNnQADXq+VJXgK0bTY5nltkH8AAAAIRBm3dJqEFomUwIV//+OEAAAAMABNPod8CT4dl6b+31rGrmc+yAZZ+Mvqg8gtylYvDWkWd4gctmbfn7k5FXUO+2XvMLz9gDLhobFdTHDl24Ppa1q2BlvMs5rVml2pqBO98OpE1Dnd6s9Hd8ZEoZj9BjxoZjgzvhnZpqSgWYr+PtsBvkvOAAAAAkQZ+VRREsfwIseY3B2rk2TsdJqjGTWP7gtB4+Y9hWFWtNfu7BAAAALgGftHRG/wK932QAAXT5BuAK27gAALbl2mH9LdDmRYTH2Tyo/VvbjS9ZoGXDfIAAAAAYAZ+2akb/Ar+DWvlxAAAriZtVSVue42mhAAAAMkGbu0moQWyZTAhX//44QAAAAwAE1Ux5VtbU7pQVn14RgPHTT10V8gAFe46kN0+iq9InAAAAI0Gf2UUVLH8CLHmNwdq5Nk7HSajDuqsgj/CUBFAUh9IX0ydbAAAAEwGf+HRG/wK932QAAHxEnfvtdhcAAAAtAZ/6akb/Ar+DWvlxAAB9VHRC3gBuuGazr/FUxvW67Izp49aVZyGvKevFWxiAAAAAfkGb/UmoQWyZTBRMK//+OEAAAAMABNU+5prW1Hxhg15HPyoA4mToyKSkSHCB2BoEP7OG44Vlu9MsZ3a109bEElFrVlqbrhWQDQN9TwWTJ8Z7ivtEYIP8AuV5je0RWv3wn3AdIhKHPAsfudnx83TVh5laEY9FEhjePw7cT+fP8QAAACkBnhxqRv8CwFFJ5m9ybGbLGwdpCyfcaeGShhE3M5kAEXO1XSSWw+p7gQAAANpBmgFJ4QpSZTAhX/44QAAAAwAE26JrQQBRCVUQALZi9IGp9S+xNEuCBZPRYatCIymN65ArVfxXL6BFn7lFAUpm9tARENEkEHYHhJXXYt8/WX8vyE0upCPqGtTDdJ6nIUqrieG8fWix7J+SOen49rAoQMtyFPW1cPPYjMaaOH8Nzr1PLhqXdoClZnNNYf9EzHGiqdYN6hwUjg1oSc76vbJHFUVCji5xpat4st1rRxeIr5w3+oWmz189OljUP2dv3rqZ6XjA4K8awcwG4Z/pqnVK5XVjXD6i2NB/oAAAAGVBnj9FNEx/Aiw6JmDtXJsQLaP087qExKxWqqvqNnzJN5l9au39BONIAVx6vMdsbM/WFQqvzmj9Qz/5D/GPRNfGr0oB88ZPbaIVqwJiju6ttw1ldcRa1GcTXFu5BAmtVj1DkfplcAAAAEABnl50Rv8Cvd9kAAF0w+Pycg9VTEyCE4m1ikTAgAId9gnl+GXY9JZBJCj3R3JmQ3FLVTuLzL2eWW1bdHsvzvcRAAAAJgGeQGpG/wK/g1r5cQAAfDr7lwfY7BTWeyhhUDMZH7hB2xJCWblUAAAAvEGaREmoQWiZTAhX//44QAAAAwAE26JrQQBPJ7k3XOwABaz1NXplrguPFrsk1Wjd/piVbePOsVZUz7PZ1G3Z3wcQS33ovyweSBzy/swZZA9jbCqQfnsjz+wRIEySrMTShG+lw6k/54b8MqMs/0/DeXX0tnGdHozo5exQCNLTLDUPS0OpgRPX60/D2vmDr9Nn5AM2PYovPD9N3DrM6Yf/YuHcUxHLYzmCf2wV7xcPJWZj+Ctrs6+cq6UokhpBAAAAPkGeYkURLH8CLHmNwdq5Nk7HSapBxqoP+wj/HXl0Wi3/5OAFrgHQS5twf95TE4Uvg/Y5Xq5Bi38xhxoUEOBAAAAAKwGeg2pG/wK/g1r5cQAAfVKQlLPdtDE1pLB3GXZ6UcdSvTIjkkqByfmBy8EAAADnQZqHSahBbJlMCFf//jhAAAADAASz26T5YAV7GNio7E0VTVa83rOOG6aueDhex/TYqc8ubZJCiq0/t64+TOFeXwsBu/7LklBmft0PR5l03hmnK2r3VA0Pcx2cEnzKeNr3hYDfXOZn8pWEhmMxuQYFkbPciy8+Qew1vTvUFU5KdkwxksfGmTDLguAUqWzzL2c9N2W1fKHn7od25KKJ9tg/WAyk5Ljx75dog1r//O/xDGKixKb9quB24otPqig8BsnhjEABaxTc4MRi15MBI5R3tmw/H3YY42MYHXi7VfUVJDaIfrE7i5hxAAAASkGepUUVLH8CLHmNwdq5Nk7HSWUGhHCbb2hze+/GhTcaafbhE7RvycALSHMvncgLc26PAAo4g7Ix2YdnG9b/bxoShFU0QAbrs3MfAAAAMQGexmpG/wK/g1r5cQAAeoJtdm+DvcrGZOD8aAC1dECKHJ900FjLo1zxEZxAZNiuyXkAAADXQZrJSahBbJlMFEwr//44QAAAAwAEu6JsvHTxGheT+ruPpIy2Q/XzKJHAyK5fUj/Q88dvXCNMmvF88i+jxfvwFTYSqwsrBMz+91dB4bLzAembx7R5wuQGWBDmEj/bkxHUoeOpEkSFOqy6zGwB8aqLRmj1Li4GK1h96SS6dxctUjiwH893J/VZwxYaOhcEPi4sEtuU6by2nqHdBVJtf+WvpYAwSXkvRgCso7XgChTglTbe+F/c/+8omsti8WJ/vA1oArb0b4+lE7olpLxXhibqYvV/v7b5RIQAAABGAZ7oakb/AsBRSeZvcmxmyxpjm3gFm2DiltB2ujDfcc8+PrUnABtNNOaULCZrMfepCwYR1kD8QZxMbSZIL03rkywtfr2jYAAAARlBmu1J4QpSZTAhX/44QAAAAwAEdoWVlJwRGB1mYoRo5Jq58K0cyWRqPDXuTONlUyiEvoO46ogUnfuYrYzWTEd1VhY+V+Kd6ODLFV+yu+bFaAWxtoGoRE+l0Fxff6ZsQZIMuN5Lr8eYLcb+SYnSNOrkC+qfcN2B3TizzaefAtM8OnyVsTaqaxOMQ79errl88AFDZD0+LPhycdAh8qPQVV34RCwjxtpF0jx9822shQyGqugkLKJiziQ1TI57okntXt00HkPbbFn/cM7ZiOvpQzpXjXcqtIdRlIvR6uPneLlxiFrAIuNnNqwYOZr+fZyphrtd7EoFNb2xeq/+xDUldaqba/VGGB3CEQTREjgmHAcaLrkRT/DCD4KEIwAAAGNBnwtFNEx/Aiw6JmDtXJsQLaO8xEg4yjJJ9nH5rlqtldks7PqKEL84ZasfaABBXjiMg0+TYlQvReF5Kp/goMBudzwZt7X23jKrpgSxmJuG3Y2CWY/P1VAf6m3U/3eLyruBX2AAAABAAZ8qdEb/Ar3fZAAAhg+TL5zHKwcBl1FjohfhOb8AQTcjmZvnwqONVYxSaALBuTdneuotNy+DOAj9JpJ54UQ5PAAAAEQBnyxqRv8Cv4Na+XEAAHVcutR/a7Im3iba1/RAEJcrdWhAQNh1g5Zz2h+G7EeS4DGkP4JmvsmU+YIsdHA9Ey/SpWtBkwAAAKZBmzBJqEFomUwIX//+jLAAAAMABvHZkAoFy5K412EItQ2HPLwJx9GoNwtKATvnm4Guoxz8i36/zfxA7Wk8xQQSIX9VMx7vTw9EBdEdgTlGac12YZHmShnBxdeI81j3xvpUPYo59LqyuyTdQITDf2s+iBC0kE24S59vlcN/b4g3CZopdLzwh1u7K+mwDj2JgJOOtYJWwIW0SXR3Yesav55HnOXmDn9ZAAAAUEGfTkURLH8CLHmNwdq5Nk7HdfR/FjEgn0Gcv3X22pEWCtba07pAuccgA38jEEzO/sje6wjDo1jlk7rmtBYlovBnHFMJ14LHHU3bEy3Ezr63AAAATgGfb2pG/wK/g1r5cQAAdPeF7lZMot5ygBW0pHuKACWE2fegYF7cUZfNeTPVKEd8DaxoAGl03CDs5xoqJaJANKsuOdj4oTPmzm0l9BubfQAAASBBm3RJqEFsmUwIX//+jLAAAAMAASgDQ8kApJ3/sqp3wcimD4XHIaV4WpTtvzVob8MJGAvwZ7Z9gy8YBGJgFPZXxybKnBkCQKTon4gqOAddpHVBnp0waf0Ov+drUrcJ566wYiuCIWdfIzd4Rw+VixvgEy24eMq8YQYC60PgOXfVfzrvQYytkaHdI7U4HCKsEkok8LvX8WCXoomwST6+Dcprj2xUOC364xrzFOm712zRGQsuEj8rmY/JkVaPykdvr+AMoZA/94Cog6WiKGj6BYmEHS5IZ6DPDUOrQrMUMmT8PB7TXxsMoV1mkNgQI7aVUfuzpFek/VliRrZPfC0UpmFPIgr8ia4s/L/AroLfRMDZQmmWugrX/DOiqS2kCOdYgXAAAACRQZ+SRRUsfwIseY3B2rk2TsdI6LPDFuhugev4/1WevkHlhLiADhXEZF67vuWU3TuW0AqEIlPSF/3CPnab+d/701q2jbTzjaZCkwOwL1JAfz+AeGZK8Ep/GDlB51apkir139CtQQq5A4v/pv6dFhpPPFxlJQoh6XRpA3VNNbKMwYv2QGpIO3Txl6FNBd4dmcsXqQAAAEgBn7F0Rv8Cvd9kAAFZVATOoD3qvLb47TXVPGRw5lMAN0fxg0YjRgxcT6UebAuY9WbSlmxi+zL/g/iir/kqnvqgfudOIdCISIAAAABNAZ+zakb/Ar+DWvlxAAB1VCVNH9lviZVQsW0eEMqF+KJgBZeTsh1k5f8LODRM7ubiKBKSOPgH2LLHQFeIPk/w9pCyIhiDKjQoArR9w6AAAAEhQZu4SahBbJlMCF///oywAAADAAEoBpOyeCAF/gB1HDThbyB2RmRjP62e1Tckz+a0nUbZEeUrZShsNL71RFVJ0wW1SvJTx4CW2W8bXv7xz1AlVF+xFB4HGI3Np0PobYwyY9bCmszUwIOVoSPu6AJqsCUDXuFcODCBN5MNwiEftUwS52wRl1zlCowISlBxXDoXiyoM3pst4ktnnDqNQtEo3tUQNZFswqiL7lt41KeeujbbPo54FeseA6yzxoF8mQmUbgxPE10/j7Xq1fDYetCNl7+6kYw45ymth7wbmrv8YB/wZJgvbKD7PhKPqvkOWHkgXHAISUa+fTZ26+gCBB5scG9mX0IJiUzTWiNCadvvFNnzM9AIkosIgx1mTLlZmzZaQQAAAGtBn9ZFFSx/Aix5jcHauTZOx0joJ39JcjEzgFAr+uzfp7OwAON2kirMug1cWhcbdNtZe5Be991Gtq0lFtfCS2wq23Pt039cDYFS7vYOXm4OUig3LwcsnwA95+3BPPOeK5LTVc02QQc43yU/6wAAAFQBn/V0Rv8Cvd9kAAFXWj3AuNbXAetDhrdcjhyYoAW7jmj5+oiefP5Z+FbwK7QKIprM2bGdXm6hwHCFLE9CH4yolpR1ZxjMJc4xJPpEVFSQeBm5veEAAABfAZ/3akb/Ar+DWvlxAAB1VlMJIPrlY+qsSM3HVyCA6AHHUd50v5Z0artAv+HMkSXJDFGTgK9E6scU8Vu0MOTtClw/52nJNzpz0TvbKiku0CDk62Ot2eM3q7EeeY9si1UAAADjQZv8SahBbJlMCFf//jhAAAADAAR2yxdQEgBaHsGMFGmXWckblYaZKrfVG3FrJreqW646by48NQbw6Qq8plbziTXNWG9dYGLk8CVs/XAvUY69wqnP5YpprCxDvAb62/nmqFL6dz7HKTMj9Oz38d6P9ZASQq3zXf0uzx859v35xuRKQYB6hnrf3hM/s6JBBFQvwva/+r4WXOtCDm2QnCtgLY/agEh4/y83Xxqn/LP30BZphoCQTQpWz3NifRYHDNr/OJFo22o4ewzXdOwVW/NfeKa2hUkwuc/eQa0xdb5fl/7YgIAAAABnQZ4aRRUsfwIseY3B2rk2TsdIzKg87nGTcbcFpUiznmiGC+T6AFrmCufo1bY/WZ91zpaDz2XavZUqU/uAN4nXqWeKv2YIjNT16GJGl0LrsFu9qooy+qm63M153qMsFay79bXMUR2amQAAADYBnjl0Rv8Cvd9kAAFi9ByeBwtVhr35UQzfF1hOMNjC6n0UAG0XO4PQAbfYk01MxH8wRAhlaxAAAABPAZ47akb/Ar+DWvlxAAB31BBjuT3D904qA59ghqnRGrPtrOQFGoNd6oAG/oQJXHtx2URP54Z/3nztcp5rP5Wh2Z8DJAy8FfKZ96/lZJj3gQAAAEtBmiBJqEFsmUwIV//+OEAAAAMABBuiRc++EhWcjat2GrWAf+r/F45vIx9YPpUqUMcb9jJdC+gDu1U9Y9s2jsLD02e62FCSvftyYe8AAABqQZ5eRRUsfwIseY3B2rk2TsdI6Q2kdxUsiPIAIXjEvHQwU8Me179J5raXb9FR/dPMeEgkbNQnEZJlfufSk7rfkx8TFWPhhPlSRsxtZgiwiuXpXFb6xjxCJhxRcfIIAzPLdQsB4oPSqxoNgAAAADUBnn10Rv8Cvd9kAAFZ9X22vuJm5lW+u4FmqqABuLz0BqPJndlU/A5YEm5DBDk8EVP8FLLrgAAAADYBnn9qRv8Cv4Na+XEAAHUTTbxGT8JAjnMD0xmcJ0ABw3+2xElTFo40yQt46xApWLJMqQuwkhEAAACyQZpkSahBbJlMCFf//jhAAAADAAR06AdQp+O07aSGqvQdAAhZeAh2u5mEODat7GYGVHNGTssvCnhIOD8SSduVIy0W+TAsWwTB6mpXuWjIMHqE9Uv5+dgeHCrhssn4vaTcRUetS8aTv7j8ZvR1q41L/uNlyMjYF+/uoFFtAOzmZGSM5Yqg0Ueg1WzUOmfSE3PRMtlL2cxJk72RbCl6rUGaKXJ+m8NH/aa/oYbV3/0FTHvyVQAAAGFBnoJFFSx/Aix5jcHauTZOx0kvIdKmagv3X+urtE6yaszRID5PxMQVzlSTExgZG6AKlWIebQQNwCVsz91EgglTYzWRzi533xFgTzOPzkI1xvGC4vmyrQuvdqK7lmWf1MiJAAAANQGeoXRG/wK932QAAVn0IH5qOR6brKqZiQrjJHxm8ADgpmH5YFAhr0DP/G3llIvxZsrCsIwgAAAAQAGeo2pG/wK/g1r5cQAAeBwOkNVboJ/2K4p3zUbis7o/osg5rzo6gAtK0C7hIr1KugYckbShJcSJQrQ2b8s1F2EAAADKQZqoSahBbJlMCFf//jhAAAADAAR0QvABfXN2WepFwCFoYwJVADh0re2FGRZvfMuxAsOi307cFPeoK+xSg2NyH69p5mwm8povPIICjNfzUow1QoJiUS2zTV+JzZSl6K7pcXoCTCus2LdsvSoDkfnPfnAv8eED4Toe4atfXRIF6fPx0MbyjfaffFfv7U6bkDaF7yxDeV1qiui1J8meSh3QCGcXCk4lE/VT3VAD1bvu+lxDYh9Yq3S05p7Icli5wpAnjkUQvXh39O1twQAAAGVBnsZFFSx/Aix5jcHauTZOx0kxTfQU81k0ErWcC2evyJbEgA475T26Tr5BkZyBhoBWFpozn4fo8kZ2TixK2XauQFG9shLDGqQr383u0Nx9Lh3YDWLcYfN3sdyaL9zWP+VUAW9qoQAAADQBnuV0Rv8Cvd9kAAFhzCqA2pDis3OcbrdqNmd4aEU3BTRq7+dzoAcZ17u/DqfWY5OungBhAAAARwGe52pG/wK/g1r5cQAAeBwS5peeHcYVRof/asKgaABD72B3A93iF51KfQ0vexwyAf1uw7D/tMzvZQexh3Sf4bV/wcd2asXAAAAA9kGa7EmoQWyZTAhX//44QAAAAwAEdlFZh0QA3NPeSP/ASoRL42OESmg7oOG8CQX63YswpKGmorsFDOzMOOBaDXLNlUnGwBO9CLacYc+tsrcLO3LC/jDbOhQL0fqgvacIQxW85TW8rJtJCYJPZ26FuiXxAskmzQfLORMXTQGs0vVwTnCA4lmHUB79BpqdDOY2jXYtFaZLXEZ62QxA4Gf5O4G/SZGAa2yCn7fgiVB07498gR+P6Rfcha9qFUJ8gEUg9aEsSG52WvJGYP+YXpQd16IDl+xncMPzTX0bK59kdqjIy3I4bpf+Jaqq1grUx5ag9PRDm2/TOAAAAHRBnwpFFSx/Aix5jcHauTZOx0kxVSBTIkbpNRh5s/t8MwU89bWvOqADhXQ1Mzv2scZ7IuthZnyNHrWqQSXr4zq0KAic5WWDv+L+jyj1AL0JtLoEDYvOSkoY99k5C6osUWnZGAvrMu3HVzM2L6cWOMthH95A+QAAADwBnyl0Rv8Cvd9kAAFhy/Ay6k9eb9oueHoEKEWlznXpcfuab3sABuThaw5zoBmi6cFbOAohs0TIHPycxmAAAABXAZ8rakb/Ar+DWvlxAAB1UgIHEk30AVVva3/9LPfvZdgwjABsVEPCrVbcphX2L6fM+QNF7sDdxGxVg46gohviGIhLd8XAnsO/dk8q3ZRCjvspPWvV4Jg2AAAAuEGbLkmoQWyZTBRMK//+OEAAAAMABHPNwX59lMvWIeAAmIc6WZdx15s6zEB700JZ37KgRgFtEgD01/LLhV/cz+DiQhnOwwbhaNo2ITNRAPC3Ju6QDd9Gx52WhyjZi/d427k479sZWpmTBkJJzxof8iscJo3NLqQ87bmU6mulef9ysIDuvu3tiX3PsYcBMT8hRcTxr3V4SLimeCFkqYlY3mpLrkpfOn0EdwaQO7loIhku65oAjTvhIycAAABgAZ9Nakb/AsBRSeZvcmxmyxnNKLwjXutIXMEIlmtwAJYTZ+L5pmJYLRBxL6k+i4HmyQa2V+Pbz3H7W5dMECqRBeLTKNY6OOGfSn4S/AE1JiE9/YnjyZ0Kg2ICi2CiobiBAAAA80GbUEnhClJlMFLCv/44QAAAAwAElUXqALgYKic1Y11p7OdHHqSN/ptIajLJcSFOs25n29s5FX5OtnNMi1GP7yj9jMDlEKUHW+1VloI8KgLXzGNzuy7Z45rPQVnzpawk2qyShdW37mQtEDLV+IDkcHrVTfFm9fpvKXxMsIk3hdrWUXFuNCPcYUQKyLcW6/3KyYf3YMwWkDJF5sPVl+5HfO81n2NYZeDDDm1Zb4nX1O58U3f4QNv4RCx+cEznyd7HDPDOYgYQst6IpDxyZ/jCfhh++oeN2bqUQpO6yA87OZ5sJZIAmSefTbMcZEtRxj+yJPxFqQAAAFQBn29qRv8Aa9tMoAA1+UB68C3x4KyyCOW03a3z/X41F7oYgDytgBF4bK7mgVTnB/r3PTzY2KcogcdjKSPIWsPIf3pGIDSXl/mbsXOTOwFSD5/8zpgAAAFFQZt0SeEOiZTAhX/+OEAAAAMABLZHZHddnaARAFakS5mQr72sukbHLHm0Udth6afEReODLaZD2u+vdXuN2H2cWwuIAXY+pmjqFn0dGg1oBvdJWKcX7+i/wPEOQ1hxGIrTvsJ33NXtEOMo14iDerx0ZKLy/BGykbktZtyON6geXumFq+eIe2rRFm7y8Wo6y4riBRZX+I5Y+5go55qVZ95IXXGyuie+DRRrSkcNfxkYZCNIqr3SvhqVw3fZCXWh4dkthCKAJ3TYJac40rMetX5ajwKI6w+s2Z8m9eFnCMR3Un8ue7J6OMUX0E/kwGn+2Z3lAlq+cY8bIF8RLMCKTmaodkDHQQWrxFMyTdwlvEnS5gnKkHa0ojavfFab3Nne2+mykqMVhUUbMiE6uuP+bRE1dPwccgCyF1B573TKkCdR4pW2afqrYAAAAHpBn5JFFTx/AFY92mAAKTDb2bWoYuBuxoyStsQO9AnJHDUi0rzdwT+p2g8mcUHTBqR45CQAs78ad0QKZxUGiQiop5UAjMf/cHpJF+j3J6hfCWKQIgaCtgu4BRVYOZ4s1/IIDEZsvtgmTfTyqMUsfCmXB5vWUGLG4zch4QAAAGUBn7F0Rv8AAAMAAMiWLh/g1FkkOQJcWTOXZpJ+Opd7blKT5iTA2e6FNABa0z52/fX5sOiNQEcFoFMmJbZWPp5VCmFzZJTHSj/Bf33iEqcDo1eyHkXqypC42JkhW93Delr54hH9dgAAAGEBn7NqRv8Aa9tMoAA3MNzMVqBQe7zwrtW1Gl7ABcuqAJv38JJ7y3yhQXxhKpKXF1PwqKSmnnCVMQQheZ6QRfu8+xYMtujqUgJG224Q+UJXk+PxT36xgY7vnBnZWD+ZF9ACAAABQEGbt0moQWiZTAhX//44QAAAAwAE09Fcr6iAIe1k8clYLUqPeu1OTi1y5imsfWbyUV3VvbMtG7BCOGBbLddwvE/jyBw5N6CEQrTZrS9OLaLf2Xpdf0ubwY+bo5xKlB8APBbVwj2pv8Jf+NQ9Su90ZHYTPDT8RTVtSEn2vmjh/0TtHIqMoo9EUlZ1JhgMjTCEbPIsBlSh9Fb6p3lUGSgeNdLQpEevduOLk8qrataptot48K8GQeNCxO9HJN066h/MQmnXUaSHVMUg96gdFmZwPNxvMYbn1FHZw8r2Uge//myaerEv8Kf8dG0IcULdBpH5DZR1H3hKN4c7fxLRBcO2uEjNtf2jO/sGI/hrQ5iLDVwoi7tJsdQVbmaKypiG5sBc2Sc0yTxU7qetS3T7xg/PfmV0YXhGAi6H5RL/xp8D6vCFAAAAd0Gf1UURLH8AVj3aYAAqd1jpRz08ZCDUU6sjaouJLqERkGgIIKm8ZPvIAB3C5R00ME5K0B7FpyuvHUsSuAsUX43h05jqswvx0QsyB4elO5Pea93q23+lfjoDjlW1Xr5AtAAddIA7eqFGvgfEvLsVf2OjQtef5TTAAAAAaAGf9mpG/wBr20ygADfnlhxSH/oc2vqt6hRolgbZn3BsoAJGJ/d5pYWSJo0nSbZBqcTek+60c375BG1dJGDOzxrWBRbBL1BlgENnxQFIyIYRn3NV3zttwWb/5Ii/i9P8LzCA+Cz2utFVAAABP0Gb+0moQWyZTAhX//44QAAAAwAE0sSvOTsYAfOEruAAr7RnbpE9IeyaYea7qW8evT+WNE9x/8JoPlbyNKv2IN71gretdtAVy1v28sUN71cJ2ZD27AF+kOv8rWUqDlgoc0xb5nc269gw/ujdcvEMb8yi/zpsfq1/GYX2ox9pvway+8+U/r6q+uiNfogfogqMBf7Y3WsT5OgbH4RYUwyMu2MgiwH3VCU1jVJnwp4IdH0q1joEZduH2tttPrwSiPQ/8Zt5B+30vGUFu1bWw4ZsWyiJz30yH+zn2g0J9HjTlh08GR6ITg6U1qAYz9/uaQ8Cws3YjIUTGPI0vo2QMLqmZtbyGr/9rFN+ZS87yJaI/w3zRhxBholnj3+YvwQTyD+aN/dhx3X3yEmH2WJHu5T/aZCm/DacF9v7MWv6RGtnc/0AAACAQZ4ZRRUsfwBWPdpgACnh+s57+SvC/z/wEOsW2NnLcwv0aCRNJPWbKO2ADfiphuYYMtDgl7xaieGue8zeJZLnVdjrK4NGkqLCoMTAf75oAqN2sIVOVGYhEfIb+R79yg4W736bECqus55ygD81HxWmzL8j4bENzhtShawtSWrWCt4AAABcAZ44dEb/AAADAADORuH0Ze/NBu73BPPj3e+u9yb/AAN4FLqfyU7CT8OVGF6WeWogWwenQ5/AsNf6pr6oNnizAF3c7G7ynNZogEzI1EV+8pcwgso0zvXqZ8j6ZT8AAABCAZ46akb/AGvbTKAAOGm2mLZqH29CntzXPz/MTHZxKmYP5SE/3NCACrooKbnedzBN75+xJUtvC134cUd8aCgXKC5UAAAA3EGaPkmoQWyZTAhX//44QAAAAwAE9i0O1+ACgZE91O2RgZmEjdGyDikCpOUZPvEBfM6aReHrQeou04xq0zD99R+51s0ZTrmId2PFht0e2fCm5KvEuuf5jT5RCEelKZ/ckl5+IAphcA1oigWOaRLU1GOAzBPNEnzG0FkgPaZk+aBv1VCo6pZHuLstdkKqJxzDCFtrnuBANFSWqXLAx8H5+4W/JHYVAkvzcfDinRq/Gog5KrHjPQHn7mb93aJKyhBGcWqg+nHa9DX9Fm/EDRSYhIE51fY8HXg8Pmaof+EAAABfQZ5cRRUsfwBWPdpgACuZA5FCsH8ig1pDdFT+wEQ+E1/jgAtgC9WqcQCrLzD7hZRKf49dsK3J3drWjJuSKcluW9Di8Q5z8G/d9WU9bwKykyQ1FfkUdK5G1kN7CTKo0OEAAABMAZ59akb/AGvbTKAAOc1umYIXkKYJfBOimRx6KqjIAbIw7ZJ8Y62r2MmmIIZwjz72cMsfm08fNW4isV1dcP7TbIrFFJTR7pJFxT4ACAAAAMNBmmJJqEFsmUwIV//+OEAAAAMADNr6wGOf6u4+k7ebAenO1KO+J0hYFwHIZTUoXI+vc5bH8PiRFuW8KxgX02WFKutaNzpmK5qFSSzkG1DElOLg1XkUy8Nmc/Dmm9V60yImqPG1+F5J+PSGnXbuEsDBNr+ZQK1bB1rfi7ZdOoag89HxCKZVl9Ypc7dHogdTiPDh/ECQs0TeAwhzaRgdUmjUI2ClYZy0kfFAiaxm2JW4tI3DE1cZsfqaUuY0WWZQGVXmfpAAAABgQZ6ARRUsfwBWPdpgAHIgj5WCll4mrHCmhOx6bgmABZTALLFropGQoxPHUzfUqGHlUvNQWT/PAvw1agmUKdBIPXQWrR7NIQctk5EIm/FHCj/pwTQUa6T8ovsXL1yqAABNAAAARQGev3RG/wAAAwAA00tz4r1RNgIo6r8AEM9ZOMAFoCzOmjMnkh/Qhf4q/QeWARbpVBqeviFocML95SVYuZ2CcRuSLvEInwAAABwBnqFqRv8Aa9tMoACa+qxUeJnCW1RUxD4tuRkfAAAAoEGapkmoQWyZTAhX//44QAAAAwAM3POZlWBe4FKzk9vsBIfZEVPJOuKDC7tfmzROTlBfYBiIBGZ5LQJpvOtEOn2o1FD7ge028+RJCvQLAAfcv/6LKxKcDnRPtjFTcqhReDzM5szC5wlARIvMKnbna0ADb8M9IgEkiMqWgPdtndhjehXNRwccjQnIPDYfT3QSO4NIQsCeAeYG+GuEph9zLD4AAABSQZ7ERRUsfwBWPdpgAHI/4z7fdn4fy61cXF0B0noKYF8WtUAIqcUcdMAyyAjIpP4fjfn21jxKsQYj7pK82/SVQUcLi5KP/ZSp7cM036o9RDRDSQAAAD8BnuN0Rv8AAAMAAip/8B2J3awq5tLp7T9YpSAAMyIfWvp7+AEMN+UFKwXME6aYlNa6pJDZWdm2iKb0TlcoIIEAAABAAZ7lakb/AGvbTKAAmvmQZw/9GtPh62Z1vI8HoYGVNmEENeBC05L3Hs5QiAUHkeywAGsy4xS/eqBNCg67NvX+WQAAASxBmupJqEFsmUwIV//+OEAAAAMABP+T6raGQotbACz2ee0Rs5J9x7MBZYT6R/NMISlYoOB7ekJnXLtLyhRJ+cQqzBgKIXOZ5KfPfvDcsxiR9cuFcOHtz784bknYCaGM/nKwabeffaKj1EHEsId0NflqH6vmE+ugttndv8chfogReFkG/YPaM7cq5HAyLHDfj2oAaews7YuUUnNTNl8fQ1Hf9pnNz1QIUSLx+vljw5CEOFyesh1G9tJ6ll5Wame4snvznH4LWYfNmTw6jAr2xYX87t/HtyhcLdYIJtAjQkeqGMcmRe60AJBcVoDeek0id/s2ylm1AGqc5GA221TF54SSBvroYFjanzxui96rlmpjQRKpohYWl5aBVa88iQ9zIlvD/nEI/uaPEOe3i5EAAACQQZ8IRRUsfwBWPdpgAHJAETLWnVVTOXQHg13YbwA2yGNGPFIy5nrs1zYP6OALxaGrYa5LtkLgkPBZTjC11s8TY7Hcm4IgLLu37LIH3I0WorrAN+dURXPt+mv4cYZct0lC8EKosv8EkE692mtd+9uXY2Hj5I3Vb8vkazkNaVMWOubZwZvBh8SFhyu+V+TTIkjGAAAAXwGfJ3RG/wAAAwACKoN//VIPmSno1nkwnOA4RMLwRxVE6AIeBvAgdXyMfIjKgL/ONrK9E9HfN40GTQdxqr9ojJNmcFf1UAKorL3MYsqB1N/PkxGY+ZSi5ZJVPmR5TNGuAAAAaAGfKWpG/wBr20ygAJr6ib9qWxSBVwYB3ENVPJJ+YGzkxT9l2AFqZENKi9UbfWjukTzL5g5rPWmDann2yK5qDLVJ0QiJ7wcNRjB611g+eaQsEER1IMuCyWmauRHzx4k2zPABrWsuxoc5AAABUEGbLUmoQWyZTAhP//3xAAADAAAL/v+sv+4TjoAC6bi/T8sACs9nTSLpjIqWET6VLXhu0wKuKIUXqyY/aNhDLemi/4TuUGFDVF+T/xEVdRKMiB9e02sJXvXiJR/QE5b592AVW/5hNZcwLPlBhwZm09xvu8iVumqqvyUEBloxjmOuuZwuYeaypM2fKGWIrgXg3Xeqzc7KrxQYBKqxrX4S+X8JPR9OedVLQ8Ic6T/OYyN13a8QvE5r/i8gLv0+Rr1gK3zwG7+Ku/so9Vg4YK5XuZEN9cn3t6y0hu1uPGJEpG+EUuh3ni1ohf2S7Lxh+M1p/Tk1tgP/00EWh2vNaZQ6HS6JfqQX5rmDY4LPBSVmqykRpaqXuCOIZaHFvdKDe3zH1g3H9JbMN6UzgNF6GpIZF7QlGbv6noFmh8HsoyS/Lba8XlED9S2WMSxWqyw/a7B3KgAAAI9Bn0tFFSx/AFY92mAAckAk6jEYih7kbGKXvuO2wawcdeuSoHOkFW3UAEtVn0oaYrrCOd+QpQn+KOEGCQ3UthBjq0zkaTCpUjj7L7XzP9urWEOHzIbUFtdoylvPtWPgHM6dxJBOvWWawWQBqbIYHi+zfgQd4mxbmIxgX4UHzzKTe4FIHv8glyX6OLSNECrr6AAAAGQBn2xqRv8Aa9tMoACa+ui84S2NKV1po+rqYNyaijsXYWRa+IAA380izLVnDZphXGUzu0CyoyQ7ZtM0lBUz5S+ngr9fYdIS9pCMv7ZZ910ZT+OKuNxX2kr2B0Hofb7s2qyncolbAAAAx0Gbb0moQWyZTBRMJ//98QAAAwAAC68n1jMafVWzUxi8Ap5x4UA6gSstDjjp7+M7//4f0iFWgep1KsOQVXrMuC5PNCCHUoco3Y1lop3rfsLhIw53WR/0Nfu+c82EadEjZuIvMbrjx2Ump7CQe00zILEW5RpU6zpPWC0LcCGyiBzIYAK3ageu1xHJDF7fdds+6zQ1bwM2ZxVpWJlVZZqOTnPYdnMSRxwyMhoKC+jlpsy5Ov5y5vRZt5sJC0vaWzGYSRn2Ee3WLmEAAABnAZ+Oakb/AGvbTKAAmyd0c0gy4vCsP/EN2H0LSiSM2ZEB8m0NnjgAReljRS5irqEK+nInugshCrlAQbYMbILJwUaHGNrl5wwYy20vYDBDY1Tk2o4hfEnVs4kUmpH/TwYbYBiUgYcGfwAAAPFBm5BJ4QpSZTAhP/3xAAADAAALE5U1AELFgGwxyShnTEbnMjQX12nNsfXRU1m6CICPJBgr5HVtKU7WVvROk4NzHuK2vSTdGmW7gugitpQVrT350TfqDBgJgEgMQBFMcvcTPLLmoiLi7l+uv8w/dFc4YNDuekuzg/7lx9H87R5NAdOy6Zqn1iBfIFqnsKnGT6waRHysW1shX/ZrhU1vFwhba2FNWZF/awdRcFkcmlJJ+oRwpfX4AR1INebn8oFphe6ko5krqooUn2qER5qNhYBkUyvPekW/7Z8KKmdw10JwCGumH3CIbwF1bnEtvlr6q31AAAAAhUGbsUnhDomUwIT//fEAAAMAAAtnJ9fCWaL3oA+fDcbrSmUeAYD5uvLeeHEUW4G6Qz7Br4ni05R2z9uMwvjEWYipWke7xBVL2L1l64QY0xD4/BlC7jj8J94gxDG9w0sZYWQV5kQy8bTmfE9b++C3nyJmlDOcOPJpQGxUphXK1rFYkpBEdN0AAAENQZvTSeEPJlMFETwn//3xAAADAAALC7cJwCo8fimV0JEKXcSgzsJGaYlGv9n7dy8YpuVgmmqrCKxBQrtQNp7SULOVb1u2c6CLtxyqvpS2fXAqobO7of+gGs/Ydqz326/ODlXLp1r2oc92pX6ySKJudz0S2Rz/a6B5MkHFg0/OwvKrWQeKz4VReJt4n5lS9v5THfbVlpiSVxAi34xA7T45KK3ZhPH6wxdQHXQeCPzvyjjK2z7bZE2/lNh/+PjqN6F7ueX6IZ+UG82ekP60P1zifzsmdb2o3cE3orhMPsgTZ3DtZSyZuDHCQk/w6jDewegbalBbS4991RHBqGZzfZCnwLpGgA5rffMb//sag7EAAABzAZ/yakb/AGvbTKAAOWl+XirZP6zwc5dTu8EJ0M4/SAFHZLy11CwFElA8UVpjSiM7xQ9P1eFxvQiPnGUPrPnUn58cqG344NUJZ+Hy6temH1/8SocQJjDzkcXIwV4OJNi6+YpsMfAOL5ljVh/G2UWIzyEHoAAAANRBm/RJ4Q8mUwIT//3xAAADAAALC+8T4D9J8BUBnbspaeG1p9mQtI9xxZb3qEcxcqEa5dERniJZRK248mVT0TLJqlmU1gPkIgwojoV1awpYHums931u8YZdHtpb5lcbx4bF1LfM/z4ptHTgB4c4xx5X1NJ9K528e5OupAKg1txHfnw4Oj03+O+UIxLOlElY0+jXAgmFzEHGiM9BcQJPvZzHE1h8nhY+Iwy7pd7M3r1xxAdv9eXtqOg6KOFXGwnqlTGfaf5j0LcrYqyaGN3f+3EX97CWYAAAANdBmhZJ4Q8mUwURPCv//jhAAAADAASbomtlSVAEIeYLwA6nF4p8KK0Xzx+lWpeWEGToDnMF8pa07qRbdfEffm1f70yPQQ+Fyk+HHMtCEeCu/Isjq730c/PQOEhRtPS/zSHmOL2XMs07SvBMTXvNRu96d3iJug7HRyVUSGHjQH1zD1qnypr/L3T77C+9XKPWz78Nt3N35v7AtVrZRDvoqy+y7mWrYIZoGj/pB+kL0U9Lxkw0HgaeqriQTYujz0/FfF/ATJvsYhYRL4b7xrLnkknJoqVpPRrVhwAAAGsBnjVqRv8Aa9tMoAA1+YOdGMUCLIgJUTAb54eB1Jw+7E14AGY/BuncLm6Opyv+dydB356pqAtOZFmet2FkvfPCzkUZYFXYfbLthb9cYA8ktEJSr23J8l8aZCITzrbRzldqcqNvAlzF342ZgAAAALtBmjdJ4Q8mUwIV//44QAAAAwAEc+GlsQVmwbrOAA4iNFroBjrrDsYxqGMo6cohcsGASl6cDZ9FY3fIHMY1JWVZJndSG7I4GVtD12sSVQX03hm8GelcXBI0INHzWkt02J7WHe99JxAURgeCx6RiBBdndIS5aDjBNJJ0KkFx7Ft4pIzMWUVkp85vOXkuuBWLlsJAIJotb7zd4AajpBaqR57fov8da3NxEX4ft6rUAAUZdZq8Ip/bvq4638wnAAABMUGaW0nhDyZTAhX//jhAAAADAAtXe1AY5/q7j6WvUf0mWDQfD9AyjOPw9lO8zuDe9X1f8kZeNGwvy/IlegLhRuDHWs7bOKVnWItMroc1t4XgGzQ4g3DkFqE85UOcYyZ0zJHCuoMKAoHTCL4nkSgDZNxc49i3dMTstGHDNRMEanCDBlb4Xr5xCYaeCumaqHxezpYKF5eLm8UtcRmgms5pVW8SzEmduT3asD4ATKZ4N0BV2kO4ic8yYNVP8tHXIUdPJxPgY2mwpyHX9/2AUXTIl0TYWWeZm1C0bjhVlMY/yLZ2mi4bWO6G0FAL1dS1bU/MMFhubyBvYlSNuX02xvURDmysgNRiaEqVI+3nyS86C84kHxc5o4/q+xbmqdSO4sl2JmYLb/p9Aj+M6YLgJGucxnELAAAAe0GeeUURPH8AVj3aYABgaAiGvZek4AOkF0i+3rjgNObWfhbpVOtuIdK1MUOtnitpHg4VYAeqUcxmyJG9JHs19cBvHMPzV0Pjd/KMGLYHO3wI7uVWXXC59TIyJHmyP19GzVlBK9kNDJPOlANtpPMeZbyIWk47ZJtzHfauDgAAAFIBnph0Rv8AAAMAAL6/NpXf5067jci/qTHXjWvI5cEbeAAs8Ec+leDKBjhKvTa6nROYFbV4ZQxUcpfxcmwSS0iVK4v65oefNtSiv3Bnw6lSzU71AAAATwGemmpG/wBr20ygADSyzpgGdu1UErBDU/jz2qMfVppKfMXnG4ANicH6jotrUB6J5pLEFGdel5he67VKUMVKnoN/pD6p92kXgPnEIGyitLQAAACvQZqdSahBaJlMFPCv/jhAAAADAAsSegWzZwczMSy1MiACw2UyqyYvMeCgAdqiqdJNcBASMUtueJfv6+Z2Jef7CjnUlUbS/3kGH+T3v8C/eSCqSK8Hf1G2m9IB8csfRuHX/LhSFiZEgNCHc6qQMLK0/9pXu2gm0dxgmzTqvHAMMrl86gnU9Ng+9t51dxdukDaPgTQqDK0So76ZySs88fbT6rpFnhPTAYbB2sBYw9Qt2QAAAFsBnrxqRv8Aa9tMoACC91G/gjZiueBYbks4MZpt8E+HNSF6RILd48LSbgADbEyS5AHh5knPebDkBjvneyTEciSMgpZ70RUQ828wTShZdgFeFCQblb47ucd/Ph2BAAAAsEGaoUnhClJlMCFf/jhAAAADAAsSo1PkLlWAK1xWXx2GlJ8JZrQYZDg9L8ywfn6SFAs8xsWhKsHsLuoIbu7wWy94Lbuz1CpObYvrvudZeoTt6BVhDZfG/CyGKCC3bu+cKQDWQaWXTrlqcF5b6Ey7SSrT7GJP/igAvNM6ErNIxO9f30wNSn1veW5d2fd9US/FJqHvAQZBy0L6dCw+slcYbDjSMhOG7F3SwOt82paWnpLAAAAAMUGe30U0TH8AVj3aYABgO2DQsMwmBhtMORkOCq82AC4fgRjtx9VNLnttZDQFSGenaGQAAABGAZ7+dEb/AAADAAHWB3UmghXIbhc1v1oAAsbj2PAnRSgjwUQ9i3so3SafkuWiqd+e33VSuBWGyDRoynlNaEuc24PWtVxPiQAAACgBnuBqRv8Aa9tMoACBJZe3b0gpoK2TiloAWrABs6PkM+AiyigetXq8AAAAhUGa5UmoQWiZTAhP//3xAAADAAAa8r0RySgrQJpxCxOKvQsDhh5fgA428FYmd1h+VYmqdl91eAbi09LeiqRowrrYp2sISR7LyARUkBYt+Idn0eX2k+QB9ymq9k73IjmhZn2Ge80vfF4l+My7vhTS5JObAfAinixNbwVvaSIXoccH63bywYEAAABUQZ8DRREsfwBWPdpgAGBnapIDd4NGOyj9iAC6gydwq4PbUDL+4fx0cRriAv8uyTsHaVOQwoLw82KdLhAFR9/f9ffpBRopaVdWinrlHe2yjgVf6VHQAAAAHAGfInRG/wAAAwAB1geqk55DA44ruokLXR1KlecAAABGAZ8kakb/AGvbTKAAgSWLCoHWjf6tbvjWMfU6Tf9is7H+HdDyEAKibHY5Q7ib3v/7nmADdFpH55We6ElEBvDDPYL/KTKxiwAAAHNBmyZJqEFsmUwIV//+OEAAAAMAC2cn2Xj9hcqvz9QM2+1HZOWcjIASLnzHCuvWHhZncTgc74lAZeruZHCU0dHH8ssqsjGlAoM7RO5FX6QhDscOAwpRGk5H/V45MyueiacjpPWyd+fcY0QU+KQ0qVzFxW2RAAAA+EGbSknhClJlMCE//fEAAAMAAAsLymfGh8Amt82WPaAV94pkscjwVZgizWjVcwxgFFUGG+uML1d+zgnz2uXeUXOc2tLFM+ea9PBRuf6l4Ag6g9gIx2w+b4gl2yPlhSptbTk4K8kE5zi2DZDGCKd/ZfboJ3jnkEvIe40MeCIfIhWT8d8SVvvxDkpmVSTppKPOGrnnU0F79P6WOpp5XketTD4VAtrolsDPyhwnQVFJsgZuY5L/785Bz+uWBnT+EnC8uF5gYojthxMN3c9slRUxOjjtcnR0592vtgbxsajz9Ds4H73YY/EGz/li0pFhjzbOgZRD/eD40wDxAAAAbUGfaEU0TH8AVj3aYABfR9wxj6D61m5kT09cYrECwCLY+5d06wmJ4dhKcOkAFgUCh/S74cUFEyPHQFQa6dDmjPSK1c57QeO3o5/WW8F8f+I76bQTA5O82HmLP4WCzZEcsUm3fi7m1xFmP43LvQgAAABXAZ+HdEb/AAADAAHbqyE+3uxLVLObzppP0t+IfXeCz+ZI9jSGx70AG64og34L2fJ+eTDLeUotxce44tY9LbDhAcYkZcrW+k669MFCcXtOd5uJOehGTvC0AAAAYwGfiWpG/wBr20ygAIKwQlIRikAoAEdVZqsiIuba9rKPjlFR1pMNLxoXxI1svtoWEt2qOe+jRW5z8J0586KyqkO/NIriKm1O0EtQXoyXZrkmIzLSHly1US/yjRidwvNz9mGg4QAAAOFBm4tJqEFomUwIT//98QAAAwAACwv8VgAOfDV+Z5/v27b+gWNNPs8Nb1HMRo0jY6wiMkGDWRE21vl1LIiuMVx7JFCFiikr+sAOC2Vc1lNvKOOkdzmOkXnzG5cPzy9980zC0ShsQbrar7fbzreF+zQzfwrimUgspHf4BXgUohkM2pY1ozRmeM2+tX0tyRvELChb+itl0KG8lGg90ABBspAxLSaECECCHbt/OVjul7vXzAKJU/Fyndhl4FqkeCBbZh5Uk8XBATnYbDMKfxS0AXd5JQFvCL1p0O1kZVMx1/o9p4AAAACVQZusSeEKUmUwIT/98QAAAwAACwjpwlrB7GKqrSynoIifzzd6myGOFsARMcl9vN4PiflM2rbMS3B3CKcuxUBYidlh1fKjcq6CdIEztoAzttKLSyKzO/6DyYzLSW1NlcyyCk0wfNA1aQws6msiu/yUbdVm6YmAgG6YXUhIhPYIGJE9hkLcZLT2HsgCzij1BwKX64c2VYAAAADDQZvNSeEOiZTAhP/98QAAAwAACwkmyyzsMlJD4rx3zBiPCYAGz/dP01ZGKE0+TZXN9OIDH+l/hBOb28ZvwAHHcs4j43HOFB3WLlCRrJN3qPldMlK+sEoHtrTXYduLyKtGlZsKQf/S4Ki9Kl1ummrE28IL2Em/wPMTRaJAOMKCzz1m87ii5Z9KKkY4ohlvAF7VXd8a13+glgcIb9e1Q32UTt2ElijkMXPVc1o/XIR6FXRHqBUynMyVWWi41pIPc2az34/BAAAA4UGb7knhDyZTAhX//jhAAAADAARz/J2AEX0DQsRVLuY2FIa+W4oHcF+Dgdksn3wsyxRpkTMUg9i/YZrCk0+pbbSbp+NvFaeDguggVGG7Co6WlD7GHv4HCRYkr44NU4ntuFP/mdCOXcMpxPffbJS1vKXalkfB9lYFTLzwI0q2m7In9OK2kfoQRwjqEn/jdw/9U21x/rF87EV9oJ8WUwMnu9GAA5jWXFxRyCcscrtFOX0nhd+/4nBcDriLdVtecJzCq1K+cTqeG2jw74VAKvnR4qL6ya0zKTSwuh9E6u7hNj/GjwAAAS5BmhFJ4Q8mUwIV//44QAAAAwAElUXqAxz/V3HvnOc5w+fXxe65i5veDgXdUOPNtVuIYzBOpyDKv3gz481n+HN4/y3xrSORBMB44Ecimc72cLEa04dr/lcJlMJSCjLLQvlisJA8cn+fO+m3d1HjbOF0wzBCMtcm2SjlvGQ2L4x36AF2EH0gbW+UcrPoy8c/fFsXMaB7U2M5muRCb+8e6aMdv1YJqcN9mk3nmocqPeza/pf3WcdEhJZW1hHosZYa+xafWrox+1FUXLGDXN+q/6Yvva6/TwJ8KP901zMVaLOBE1jgkvnyvmwzsviQJ2onw9966SyYtZrDulDY8105Uj6u5La7xA1QMB/tkYd3U1vQa3THMJ/ftbFH1p/V6BL555em2RfSD26YHEIANYWnLwAAAHpBni9FETx/AFY92mAAKCTfXRcBTR5qH5kert7mQtrTgZ9i5uVmtHj88AIqfvCV+Mp/oM6zuUCzDrLF1nvo5iSKsaMCp0MDF3RrUMDDPILBs3rVCxsNJNG3M5s2jspTJHWFrv7KP04mSuVNqjq3wleHVo8VhARH7RdrNwAAAFEBnlBqRv8Aa9tMoAA1+QDt4TVFH4FEIkQijN5IyAWiAEeQlGVEM4LtqfZ2+wT6kwt7xNYzMBL+oapjI9OVetDDb6Kv5YpAlVntd4BgJcpnr7AAAAEOQZpUSahBaJlMCFf//jhAAAADAASyyN2MUjKcE+sAHC1TF/jknuCnqwHUKgYhUoqwPluGY31lC+NQ+ajj0Lxtb7KCmNq166OvDY/6Dmh+yWeiUk5eO/DJNCPQIVA29jhytUXdaL8Qan9zZG8LY30XQNKi68jYPb8KmO5vq5AAYUpWiYfl7Ic3gwYP/oS04JwXRQOS6je2CiztPlvXMoI8XMMlfI299QN3mpd0FpUzhDTJSZ/rBIOB+eFUpmvdpYK2Gn6zqC7yXoGZM4gJxlVHTNqG4HfAb4G2qMAu4Xdypu3CDcpy4AlV+q4ReJF129qhvGpM60HiHn0diChsE1/49wol1kG4iVLIP3a/6dzDAAAAaUGeckURLH8AVj3aYAApWZVTqcKvuTDEcFjVO078RYFhm6T/cf/gA4Lru0jZlNO3MqcwlzdgVAcz1lRX/O3dubVjCpkTKzTrmzKF0bshVA8l7fhC9yLOWEVxEuQ9kqM4uqb49NhaCO3OEAAAAGIBnpNqRv8Aa9tMoAA3TR/QDgBWNpDyB0XRWzT3dtY0iBOd1X9DGVfYGU632HNyg8ujuWoTT1+nvFGSDn0dmqTm1kw/tKDlKG+/0EmjEpxkwT8FGNn3HSGJ01W9BMBcDdt0QAAAAURBmpdJqEFsmUwIT//98QAAAwAAC+lK8fW3wBTCOGEL5gttwtMPFfVgWGhyD7XWSNk9KFp/9QFEQ1iYQUeythhzw4ej18OqBqUE1Oq8ZTBMEu6tyvrFuyRTVIKFc3ARht5KCgP7DPS27JeQ/4yudeZJDK3yoiT5kL/LyFFlmn4ID9kYyaoDkj1rz8CuR0zn6SzQsSR8JM9MyuOP6ttnGMnWx2n/ABs+ZBGjr4Lh7pasTd4Sx/PnQ9S86XFOj8gWArOGp9qe+FfcUq3FlXLlXHLmj44sfYFX9su2+Ke8ylKGWbGm/ma8qGup9AO1kyw642HxUwwPzqdBA0k2mZeeAIe5DC6/o3Thb1ZWbTzORk6vsJrluMuksLbU/BOWr3UEO2moR8Cd6CVAHM3kAYWeK4OTe8J6jKbB6+eX56aOqRChwyjJuEEAAACDQZ61RRUsfwBWPdpgACp5aoT+NbCIAC6aHxa66JDPtMwPLflbyontRejecM9f7aeZxg8xn+SJ/cZP1jmXqrKemmlL962W+b+KEfn9g3ZZvZN36oT9WnYmRilHqqMBHJZAjHtJSOflWbv6CzeElv85eHcU0hswqYAB3gW1Ajbm4W5oHPgAAABuAZ7Wakb/AGvbTKAAOKgzsJb3GMLFMHTs7KrkWjy/fOYwYNyBHM0EgAFzz4pzanzkofB3iEdDBaAWeg7N5T8R5yrnHIp/y9W3AzsH8bihpKsi+UEr+lS5I0VynmpWineSYw9LDR6lxw9pIxWV7xEAAAEVQZrZSahBbJlMFEwn//3xAAADAAAL6UKqu3EADjdpeTqZAag4fA2KMULvlvftkO0wL7uyBOGx80Ut7VX2J5KTJIi30ULoH4fozsa+ZAxKm+zu7DM/I92P9ANLgV89453jPRETtTG/qEj/9TYhsprG6VpokAvMaIs4Ys1h5RjBi8MfsvsorugNqHYAOySPAsToShQvsITt7cY2L/Qsx4+O6Yx/qV3gKPZAxbfhVtJD817QsIUnpWQK0MFvBvU4PPRICZXAnQUOIDczJb7oofqKBV3T7m3aNyqI5U9Ta0gDrIFym+DSB6pizlnZ4omoL5B6TvVfdL7YOuD0E43/B56v/3LzBEoAQPT2TU5SSmGhw1ud25rn+QAAAGoBnvhqRv8Aa9tMoAA5aX27fWEXfiUAknMoi2u5dPbjg4ZGbGZoAJMYRaz55SdbSPcsHWvIqPaC55OT9A0C63p5CamYSWY793dl695yxnKIDyqsfKUUwvq0IzqwiQw42Mp4LObLcEqMJ2LaAAAAxkGa+knhClJlMCFf/jhAAAADAAT/k+p9GRHYB/Ty+csAEnPj+03/H97FZoXpI5nA/rjeUy28NOf1ZbB1cU6+Y3qKLYw+4nuWf3WrXRtQAgMGeEEU0tORjIp7J3nYyQrVDootmu8oAkpcJCUmnlJpxY62yTFrC1jGNn7Jc1San50h8kNlK/MEc9WfGsoomc4vibmPSLW6u81R2BPblGcdV5FNUW9xEtqGewA/rLfQLD8SAsE9qP/kKRFV4LBaw1vjKrXLuhiDwQAAASJBmxxJ4Q6JlMFNEwr//jhAAAADAAza+sAXAwVE5qxrvkje8lEmgPBKz1ZixN8IGOZGf+7SSN6iMozMc3ocU7Q4luusOpVkLjOeYxE/N5nRi6Hs57zLDidYCZub7zKY2lFlmKfojrHbkG1IJLew3etJdWXb9U2ervlhtrw4Bt5vO1QqIf6KkzeeuPrm+uo6ba+H3BIOsIA/g9Y7PG0gE9eywGaLpHTOh6w9/QX3+bI0vI9P3qzlp9xXKAuwBleo90pOzSqK1T3O9Clm8x9uojZlprgBbwZnVZpoKWcHozg00khNz6lcsWKtu7m35yYpdxAe7RJ9apUjOvmHEAuJaRIkpOfldKnF46tN7o1o26myfqqDz7gCzdXymgxKplyvPagimAAAAF8BnztqRv8Aa9tMoAA6CBz68X5uTxzVEGoRubWElRkiE9gWABtgXjrJENfqTU6WSv2CFxN2h1pBYCPE+47d3tSAINJnh2w8hL0ZW2YsQ2puOOo0cRZN+C/R+1e4oCDVzQAAAUpBmyBJ4Q8mUwIV//44QAAAAwANKe0tp26QBD4BKv9HF53fXte3rXouJmsACu6F6OyABo4FIMfQEnQ4vWPmZfhgMFmwiVT+d3p8mcSxqTPSP9VlH44xAQ1eaIZL2jkJJhaSPTObp+abf1rG/ksqIWJ/rHLMisT5fzPxO6s0SB7mf5xcib5xTLlKewgfdOBfAImb4qlYfmP0+f85S4Aws3Z1uQlGlUzlWXxzQgpFTBFgh1aiiaTWNNPvWSiGjWi42Jx2iH0lsYODvjaw6onNToUvX5KZoyrly14PKpEiy/tleZ/N0lt9b2r1YpvafLsaheXsLJsjixOfMBQOvoBz7+VT1XTqpMbm4klWFSaYiPwukCTAYfqJpPOr1RxkZR5pbymXm/thwZ7RlK5bSjQDuvLhLmDWgfCYFKcgllrN0jFHNX8yu3bV6UJ4qCEAAABuQZ9eRRE8fwBWPdpgAHTf5ptk03wAcdesF1K5z8H45VDFqcL+ERP1g3gufmQX2ycARaESima5k9pDzLsgikY4yg+7A4Ma1g9y8tpQLLHVEn20DJtyTBYGgsmhnpAdm95TJklLd8ZfsEzt4eqY3sAAAABVAZ99dEb/AAADAAIqTjYRVPo9FmTs3SzeBXAZ++Lq59DiWJR/zusgA24LikeHFj6NdbIT/3exZgMSP6hRXBoBHo+M5SKenULpX5yo2u+M1+KAfCdAgAAAAFoBn39qRv8Aa9tMoACfYh6vBSkGU34hpgAi5AV6c0VK7WZwVLnqYTsmZhT3Xg2PwjBdfhpDdsaO3ytsLFRaMRzYa4tILuwi6NiCvXUHXm4b2NQiO14H/o6uO3cAAADJQZtjSahBaJlMCFf//jhAAAADAA152IMqthFXgBDElMZ5RpsFiS4C6KCM6+tbUopteLnETv66CLlzn4QnyaaCDaEVixX/VheQgAddp1/LSXfMHKwpkaPOkpXAhuXpxjn3W7L8H+OKSbg6ZLnUW/4U8Bkd/WtfPdFwu0yZkWpKRd87ve8b+9AWBmhisFOPV+GqS/FYJWiVJzryKoy+vXBic9MBlAi55mWZAYExDcwm7kO9afvf424IsC4vK1ojgKLday4YKF0Qv+dwAAAAUUGfgUURLH8AVj3aYAB0/9wRsLTEKUddWY7EYRoIicHbiABusXu5IMN9aheTsefI5kpGzw/Wf1kBjw6SAIU0tAwRyeqTRiPV9VKQMSRJDo1CdQAAAEMBn6JqRv8Aa9tMoACdYrfVXABk/x81sANnXtO4gR8FVGR+K0blZnyXVLzTRrx9EdMrdUCtB+uNxH99Yb+ML9sicWKAAAAAgUGbp0moQWyZTAhP//3xAAADAAAfqEv4AoKAfY9HbjKGlDs7YIscZ7gvBqZsy6qVY16Ij1MjdbkgxNhOAR3kDjyXn5aZAWYvrD17PyggYHRdGrrOtJv1Rn6rR0KNkwIozN8HNrjmbbE34ETrzofgNlRdd6ySy9f8sYZj4xm9Nh8eqQAAAEVBn8VFFSx/AFY92mAALBx6/SAC2di8bK95zrn2SGtyF1TsHh/CElHuZ/WZmyWGH4JHwA8xup/1ZWE4HnfWdkW01cmm1UEAAAAiAZ/kdEb/AAADAADX0BvS9btdpADcFrA7qJgSYrROGN/FwQAAABoBn+ZqRv8Aa9tMoACasp4dBYte6bZwq8vefwAAAIFBm+lJqEFsmUwUTCf//fEAAAMAACDdE2MG0ooInIFnSoA5auKbkefm6z1qkjCBwK84nBRgpsRPTn9uBIDZic6zhEZQ50uRKp5+7MQvpa9ZFda7Q1HMEPKceoQ0FM6qlBIfIpRrixpwWfNRj0eeOnEQjMkXkXv0NMYakwZyHjVun8AAAAAvAZ4Iakb/AGvbTKAAn2XqTgctBeRqc/1S+UuufgAafPIKO9tuSxhYVJPZz3lz9WAAAACtQZoMSeEKUmUwIT/98QAAAwAAH6tY15hTu+ecB4gJ4BHoVXZJPbJo28uRo39VK41Vq31wpLegjwbRZPjDgCYeIoNhObdxuR2tR8VDc42ycBP4JrzcQYP25uqdgpZc8hLaCAkja+HCndWUSScQ29RkRLTkhFZ01xn0gya9SOATvJodbbqOsc6UQvr0d8IQ44S56V5k6V7Re6HqxoSyeiYWR2Ng7Pe2MISiHlu+fCEAAABKQZ4qRTRMfwBWPdpgAHIbAmsEpLZq0gfHpk4Lmbo2uDNSnFhIAIpgyEUZJf5WJ3phYO6MzUbF60uVTjb910YiJ48YYBvMmxo4+9QAAABKAZ5Lakb/AGvbTKAAmlN/5JoqmLc8SroAiBogmDqdiHlLuZ9w0M++SRbOtyif0Z8F7EwJz4trJWShZIMj61EofwxZOCsW/Vw0U6wAAAC9QZpNSahBaJlMCE///fEAAAMAAB+rukVCA/wszeULAqVwAsheS73s6/O7APdqEjskiCZ7gvfl+QRK26etDBL5zOfH6eIP3PnD6bfBTsClNz7k3xZZT54Xmh2sSV9pv0RbgZVG49PCTnsqHrHEEaaiiLeeNPPNGlLiCh8Jh++EqPBeMQmZOZ8ALjtRlODkMb1JJCldTmpHiACUPojaCejioj29laQvcqus+ERmPG5JshwSIEx0ceUIxZJKoHeBAAAAoUGabknhClJlMCFf/jhAAAADAA0+/9LJjWTSEdsAC33zoCZ4okQ2ug+NHnnQNXyVUiC2bNLPuf45wCLmY0vJlutvfCt1sA7j/BRbL2ONs0wzhddfXI+aSDffZNUqQslLzOu5xSgN0+PrLh7cgE+7yYTh9AoW19lkQaN3sH2XoGMOt64v6vZEDUNNzouvSXVPvrkPx45HKYuIeWlYdrNkHzfBAAABIkGakEnhDomUwU0TCv/+OEAAAAMADO7/0to4RmjmEP5Ibya4CnuIgA/liG4UeTyeywbXn2Qx7Xr8V4kD5jMYl6DRqE3DHz5vhJlm/oeTP5qYB6R9hSiRpNPP3p6Wx23M4herBw/90CqPcqNz8j2G/BUPBDwqONeVw3HtGu1Ih/PFtnhlAQWwsv6InJnGYrD+54WRG6nNTY76vSUP1EsswuHCQpRh6FamUOt6ueLX/eokxDdJsu5UAI0XQEtY6LudWTgOXT6zkRG//DbUvhbUWh9jiT5365o/a0/PXreRhMDBJvn1FAAaw/zJtZo9TsNndriNgjJTQWxh1PXo+tywsQpMiqZ8WyPTeazTcDCxB2hzPDT0gyk+AYGtHFaa+7v+CfpBAAAAXAGer2pG/wBr20ygAJaynMEGranBRJW0aqMentw3+uvJ8h8xUFVEwwWlymPYi2G3AAIeOdhEITRq1alUxUXTZINda+vJ34ZexWIGy0UuvJJj7i2A99dPJgL7/FiIAAABBUGas0nhDyZTAhP//fEAAAMAAAvpTCioofADaBJbnEfr4ZQyQbMaEMABlZzsoYd8hfbV9J/5rUhdsVHlk00pJbcv9sYwxwoazztJKdkhYU6+4n+m9BaPCQjPdTQdgs1iaXjWxacvBpmhOw7Kh313q7y090bbaEXWSn3IA4RI+L084wuJeCXezcHqkk2jWwO9HMRMYfw/SKfYYHomzUGenDp0SJLZIVp5zdM3Zj8CR3aNf13k0veWFLNChhi3fkIq+YtdFPwlvDQhKEM1zFxcVqWQHo1PU5wta8ldnySrEhcc9JUt5pJLFRuIpxuHHHYbYhrQMpaKz2/+kn8ARmVGUI/CfC2LkAAAAHBBntFFETx/AFY92mAAKyAt6R5FIclXymrrQmLZbmbn/zogBatb0QBGilTqRlAeU9dLjphzrh1IpxqJmHwV7rt6IE4eIZ8SltPelehfnBRqrF5Xr2FZH1mMSkU9MWUfnnOz+kiX81B1Fg2Flfa1tVjNAAAAYgGe8mpG/wBr20ygAJr6ib95m2wnpbRpAvVwtR9Fh7wEQUV7NPANwuDBlVp+QXcbtyb5OAEUgQQe9o8PK3rmuOvKNfTeGSTeXapdXqLKa1J6RbMXCmUNkZtKHHKAtTp6BRnrAAABQ0Ga9kmoQWiZTAhH//3hAAADAAAS7omppHvSDkgBak397dRcn7/ZUMturZ2D9rTMdnpmzZSJCLSW5KWUMwE9Xzg95bKFdVvx3jYMqERm/Zszk+bBLmMMZ1GfbtZjCUorcK4DyPbuWX5UwfxLmjZQ459U0qssDarwiOeVYvjj86zCCuoF2/vkEEIKBci3UWv9hrdKCeivpmh++OhE/36zm7ayx1gHNdl69brVqCJ0Iw4teeFeMoEJtQm8cUiCteOJY/EMl8mnYGw8TtG8xhTccuoeq4cq+abLjvNPknhGBfUVnCqb80eo51n8tfvTKYbKC+BgtS4eYtWK0Amwwt1/CdCiQtzIF07nEV5xMMiLUgz7Hf/tcETqvnM3LRNfdRm+o0+nMR1bR10yyM+xSFMMJo10hPTkupS+6pwZGWw9zxgBgzCAAAAAjkGfFEURLH8AVj3aYAByQBEy3Ihxwb7W3jn2aZOrCpS7tZYgl+rnUvVzzC5hWzAA3wBlD1887zmALF75p7oInDW7H10pcrNH0rc1+nlHURzo6N2gxrceA09GomVArtnBiNFd5DHzKucXRl/wsp/+sQGmOdil/NYeYE4burtayIPflKRt21ZO8kqjCGgnJskAAABuAZ81akb/AGvbTKAAmvqJv3SlcN9NDAagWlTzpumVJ1gJwNK2zsoowUKKfQwF+XgRYrfcAJTN/RHBc7a7b4RTtQVone2YncvBQevYxQukrADPsKyIO0RJ61MoJe3VaVJiMLOFWkVtJfZ8Oy+WqcAAAACqQZs3SahBbJlMCEf//eEAAAMAABJuibSgDsauY9Wsyqs6RZBUAOLaazsUknPm2XeGExde0pNDb8D5j8ZorXP+KG/YudG9qlzEQG0i7KePseL0BZY3YDm0W4CIc6PKSeTB8Ntk0dUrjCNV57NxDd17vgyz1aXNf+29h/e0uC1665AkdqZZlsbl4B6K24Pqynsse1DTvf18zZCA05NMFcfj3JSCktNKBYCSEYEAAAC8QZtYSeEKUmUwIR/94QAAAwAAEVrClYGSXnE5rHEIdW7WRRoPro28Qb7+9PLdWScnWERrUXvhfSF4A4HL6DqM7gDWDq0okwXohWoKfopWU17HPGQ9OyJVOm3679IGc+yhLsCaKBlHFEupAHRYFdOtZCXlDt5/v+Ft6C1uxlqoHlp90IhFsK6cru7rnnQXXu1Jf6hJMpycl+UVt/X152uBgq1QTPLewVnmFzlKLN8Cqgwtu8b2V9Q2D5MVqEkAAAClQZt5SeEOiZTAhP/98QAAAwAACxKbAjW0gC1giTKMAlaz/q4+AHsDQfHnmFjObJIG6FqDpwf25WHMeAHGANeF26EsIhdaGA6Xk6KKjCXwhDm2qbhlPXKlgAvQX2SysFrziQV/glY4lvNV3YREZbohTV8JErAaGMpEI41Cd1tG2j7mKC/xwiRTmmbrlGwjhgxPXG6y0zOQatyow/ijFz7I5N/LHbiyAAAAxUGbmknhDyZTAhP//fEAAAMAAAsLwLqgClhTfsy9s9iBUM0KtwxEgdtb0bEb2BH7uerDZDjJO0x34dSL9NoGxmjwGvSz6/UVP7Qt0v1iVdFYV91MCrLrG4Z0FsWKtqp+iY9fEdVXcrcWW6kW5Ye5zZBEDSvMQVxZwALPIsAyLSgEc8Seje47ZDJhxt4/QiUEIVo8JTrfkBwvUifMAsO5kKlgp/dk6AzHXNdk+sfIVPz1id6PkgA/sWZQV5NLwGVkTP63Xv5BAAAA1EGbu0nhDyZTAhP//fEAAAMAAAsL5GhAISRhtqDbDx8r6xa8hf6thcWyYUa0upr7Xcn+lyDt7S5/0+a3mtzIyaXd7IUedhcs45z0VVni477j1u/nmlO/afvGNpNStO9eePqdqH9/6oj5XOj/eaPz+XHLjKY4C0uqdLrrFIW2u466VowTH/TeeTHr2N4EWwHaEgSzSkQdhTsDuRHPClLd+MG8BchsvEd97GMzBAVzZi9g6QoXtmo3nrWSos7lbQJsSuS0UTuID6fwxiIxV4ZN2gM3HtgcAAAA2kGb3EnhDyZTAhP//fEAAAMAAAsI6T3TTzV4BqWeunnGUtWO7FsXUjAt2V5qauCa7W14AC6hPDff8AOFWklYhfHJADo6jcqG51NOn3SRJQiFxpzgYlcgaZfpnbgp2BXGDEoAM2++QkqAlckYECqilc2Trw6V0bUE8MQHkmgXdeBmelbsF2xdZasUSs1uLgf2w7FCjmv7GD8+2UlD+8HS7lvr738I+cMDMjceEvwh6Uq4j7loEoCKvg0mKLgsKEDBd1Z0e5+5q+A/0InJxvXjmdxMaRW7eZ7EzI8hAAAAr0Gb/UnhDyZTAhP//fEAAAMAAAsLqfqAD4DlHK6HSbgtdmjC1IJ9x+xH8zuYE1nVV0w3RpncX6PvTldD4KRdUur+M9b6izwEp5AR8E3zuNchqAS0d7DQvJ9Yl0Jv5Oi939/R0j5D7HbOBB4Y0LjR4IzcyjV0BCF//F+6tJA2cHoW/mtuPtHFoTaRvFHN0lvtnvtxh70nGK+dx69uXkphsRdMvLFPlHtQMZyxLy/iilEAAADEQZoeSeEPJlMCFf/+OEAAAAMABHbYfwMAbVPSVpZct5orRvPNRmp0+dWeI39ZM/1M7SqUFCfbL6pFlGIfEAkHzeX5rMxxo0D7rv42CKUoROYGA4FLeSSOOb7DXLI6i8eTTiL0HiLuoEvpRmfv6R3zS2UcVxtfrSPbm5CK/EWZHso4YFP3DiQ+pE4wA8gtfzQmxbbRbD+Ft0EV88t6TKOwVBXltaDgnXJ70fr4kw7vVPtKgSDxfWpixRbpBAU5/img6cDygAAAASxBmiJJ4Q8mUwIT//3xAAADAAAbAGke0Z3FDRugCgyxoaUdLputB/n5k+Cv1doGU1jxjGaAQvK7tthdctNMElox6wKW6W6pqaCCwmgNJ6Aa5FBjHyOZ8GNHpG6DlWQSDRw9v7F6y6EpEa3Rh5rUCr6XLpEpnfBCac/ErjotcKkv9EfPAGahDNzfllLS2KbcrOcWu64x2vUQb8GGRLD/+mXMbq6CRp5DtAYCJiHnsaiNkfIZMnRXi7TTM/E4BoQMsXCm37uQ4EYuvgleMBhK2OCDAK3efF6hhXihsyJJJ/WqcLbMMROcLwAzKIM79diepjwHysrX7s5eWEL81FDTf4Dm7Rk1vZ15KaihOSoDY+sxJbzsdW5rTb2T+9//jvuDiCK9uN26tbcJfgEHKoAAAABZQZ5ARRE8fwBWPdpgAGLnsTKePsufHro93WtvSs/1nEpY1auv76wA3UyrgmHUz2VX1RpUFdzn73Dq8RuvJSnOTdlKCHfWlEPVRvz/QmVJ/6/zqXtHSFfU8UUAAABdAZ5/dEb/AAADAAC+uet8TNSGW1w9wrTB2YC4hnSWFTvAA29AjEJgQoPn6GYfRVNgiuO9yvZojr/wgRlX3HfRIxrHDhg+DM6CF3rvP3biaeS0ULmcTfs81iBbmCROAAAAZQGeYWpG/wBr20ygAIL3Ub+St6WKaxhotQudtgAJDu3ZwgjClmvZrtChfKy2YEFCPnF+a+FEH0dLzFjl9ZKj646ojFpO9eVRFtlOrDC05dB7cijK2iblZT49TFv2+Kd5RaNI3ltlAAAA2UGaZkmoQWiZTAhH//3hAAADAAArKnOJNxTs2AAcUK0zX5AG2PJo1tVioWZA98xlYk14iQ6jYsDbf28gfXRx5fpuxCe6o+8mVGvdu6S8xYeTJWAEans6FENJT29nYaGyW4sp/kMCmMpVNBLuBwe+A+113ndAN+hnNlaMR8keOGB1DMmdiNwNpIA9A7qBHhGyc4YX97EYC/vx5M1gOiSeibZjkXqVUPCD4/UFLLdZ04Z9ML19StM9NX5WGjHXV78GjntjxPA2Wj4MmKgknP6Bff6AFJCCC9iz8oAAAABvQZ6ERREsfwBWPdpgAGMAP1QuTmdDkeOnVeLvDnMq4fAUkmiSpk4yFiBAQgAcWtCLYdUJAPj8Cp03zl15o4A54aqg06picw/t/Jok56SYZpEPygJkFy1AXwndyIw6PCXt3LewzaI6ykTWzkpN8QPdAAAASAGeo3RG/wAAAwAB1gduiMiZlEBcviTgB3bIseoANkesPJuACF/Ls28QEv8SRFg/jk0PVsUTIaEiWXAAYcXZFaml9x4PzCPMiQAAAEMBnqVqRv8Aa9tMoACBJYsE6gevrO6M2IA4D02AAtYbX4Ba9qH5BF4+wz3ZSdiqGU60TGtt7fsKuUqaYLukDmF7f9lxAAAAV0GaqEmoQWyZTBRMb/pYAAADAAFJLUr7TxqtWQAG5Eg3/HUOAbS46yoc/FhdEf9h1rxBSrmJnUv3uam3j66UlmHo3M2RHr1F08mmbg323+3VPxzQ5DYNcQAAADUBnsdqRv8Aa9tMoACBJYI3B9SW3okIAP+KecVOReovEvsEe353jy8sADc6Wlfz3eXPwEpKQAAAC7dtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAaLAABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAK4XRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAEAAAAAAAAaLAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAACWAAAAZAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAGiwAAAQAAAEAAAAAClltZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAADwAAAGSAFXEAAAAAAAtaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAoEbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAAJxHN0YmwAAACYc3RzZAAAAAAAAAABAAAAiGF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAACWAGQAEgAAABIAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAY//8AAAAyYXZjQwFkAB7/4QAZZ2QAHqzZQJgz5eEAAAMAAQAAAwA8DxYtlgEABmjr48siwAAAABhzdHRzAAAAAAAAAAEAAADJAAACAAAAABRzdHNzAAAAAAAAAAEAAAABAAAFkGN0dHMAAAAAAAAAsAAAAAEAAAQAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABAAAAAABAAAGAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAGAAAAAAEAAAIAAAAAAgAABAAAAAABAAAGAAAAAAEAAAIAAAAAAQAABAAAAAABAAAGAAAAAAEAAAIAAAAAAQAABAAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABAAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAQAAAQAAAAAAQAACAAAAAACAAACAAAAAAEAAAgAAAAAAgAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAQAAAAAAQAABgAAAAABAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAACAAAAAACAAACAAAAAAEAAAoAAAAAAQAABAAAAAABAAAAAAAAAAEAAAIAAAAAAQAABgAAAAABAAACAAAAAAEAAAgAAAAAAgAAAgAAAAACAAAEAAAAAAEAAAYAAAAAAQAAAgAAAAABAAAIAAAAAAIAAAIAAAAAAQAACAAAAAACAAACAAAAAAgAAAQAAAAAAQAACgAAAAABAAAEAAAAAAEAAAAAAAAAAQAAAgAAAAABAAAKAAAAAAEAAAQAAAAAAQAAAAAAAAABAAACAAAAAAEAAAYAAAAAAQAAAgAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAMkAAAABAAADOHN0c3oAAAAAAAAAAAAAAMkAABBpAAAArgAAACgAAAAXAAAAHgAAAK0AAABHAAAAJQAAACAAAAG2AAAAagAAADoAAAAyAAABuwAAANAAAABPAAABGQAAAFYAAABLAAAAIwAAAIgAAAAoAAAAMgAAABwAAAA2AAAAJwAAABcAAAAxAAAAggAAAC0AAADeAAAAaQAAAEQAAAAqAAAAwAAAAEIAAAAvAAAA6wAAAE4AAAA1AAAA2wAAAEoAAAEdAAAAZwAAAEQAAABIAAAAqgAAAFQAAABSAAABJAAAAJUAAABMAAAAUQAAASUAAABvAAAAWAAAAGMAAADnAAAAawAAADoAAABTAAAATwAAAG4AAAA5AAAAOgAAALYAAABlAAAAOQAAAEQAAADOAAAAaQAAADgAAABLAAAA+gAAAHgAAABAAAAAWwAAALwAAABkAAAA9wAAAFgAAAFJAAAAfgAAAGkAAABlAAABRAAAAHsAAABsAAABQwAAAIQAAABgAAAARgAAAOAAAABjAAAAUAAAAMcAAABkAAAASQAAACAAAACkAAAAVgAAAEMAAABEAAABMAAAAJQAAABjAAAAbAAAAVQAAACTAAAAaAAAAMsAAABrAAAA9QAAAIkAAAERAAAAdwAAANgAAADbAAAAbwAAAL8AAAE1AAAAfwAAAFYAAABTAAAAswAAAF8AAAC0AAAANQAAAEoAAAAsAAAAiQAAAFgAAAAgAAAASgAAAHcAAAD8AAAAcQAAAFsAAABnAAAA5QAAAJkAAADHAAAA5QAAATIAAAB+AAAAVQAAARIAAABtAAAAZgAAAUgAAACHAAAAcgAAARkAAABuAAAAygAAASYAAABjAAABTgAAAHIAAABZAAAAXgAAAM0AAABVAAAARwAAAIUAAABJAAAAJgAAAB4AAACFAAAAMwAAALEAAABOAAAATgAAAMEAAAClAAABJgAAAGAAAAEJAAAAdAAAAGYAAAFHAAAAkgAAAHIAAACuAAAAwAAAAKkAAADJAAAA2AAAAN4AAACzAAAAyAAAATAAAABdAAAAYQAAAGkAAADdAAAAcwAAAEwAAABHAAAAWwAAADkAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTguMjkuMTAw" type="video/mp4">
 Your browser does not support the video tag.
 </video></div></div>
</div>
<hr class="docutils" />
<p>Outros ambientes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gym</span> <span class="kn">import</span> <span class="n">envs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">envs</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:py.warnings:/usr/local/lib/python3.10/dist-packages/gym/envs/registration.py:421: UserWarning: <span class=" -Color -Color-Yellow">WARN: The `registry.all` method is deprecated. Please use `registry.values` instead.</span>
  logger.warn(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_values([EnvSpec(id=&#39;CartPole-v0&#39;, entry_point=&#39;gym.envs.classic_control.cartpole:CartPoleEnv&#39;, reward_threshold=195.0, nondeterministic=False, max_episode_steps=200, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;CartPole&#39;, version=0), EnvSpec(id=&#39;CartPole-v1&#39;, entry_point=&#39;gym.envs.classic_control.cartpole:CartPoleEnv&#39;, reward_threshold=475.0, nondeterministic=False, max_episode_steps=500, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;CartPole&#39;, version=1), EnvSpec(id=&#39;MountainCar-v0&#39;, entry_point=&#39;gym.envs.classic_control.mountain_car:MountainCarEnv&#39;, reward_threshold=-110.0, nondeterministic=False, max_episode_steps=200, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;MountainCar&#39;, version=0), EnvSpec(id=&#39;MountainCarContinuous-v0&#39;, entry_point=&#39;gym.envs.classic_control.continuous_mountain_car:Continuous_MountainCarEnv&#39;, reward_threshold=90.0, nondeterministic=False, max_episode_steps=999, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;MountainCarContinuous&#39;, version=0), EnvSpec(id=&#39;Pendulum-v1&#39;, entry_point=&#39;gym.envs.classic_control.pendulum:PendulumEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=200, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Pendulum&#39;, version=1), EnvSpec(id=&#39;Acrobot-v1&#39;, entry_point=&#39;gym.envs.classic_control.acrobot:AcrobotEnv&#39;, reward_threshold=-100.0, nondeterministic=False, max_episode_steps=500, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Acrobot&#39;, version=1), EnvSpec(id=&#39;LunarLander-v2&#39;, entry_point=&#39;gym.envs.box2d.lunar_lander:LunarLander&#39;, reward_threshold=200, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;LunarLander&#39;, version=2), EnvSpec(id=&#39;LunarLanderContinuous-v2&#39;, entry_point=&#39;gym.envs.box2d.lunar_lander:LunarLander&#39;, reward_threshold=200, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={&#39;continuous&#39;: True}, namespace=None, name=&#39;LunarLanderContinuous&#39;, version=2), EnvSpec(id=&#39;BipedalWalker-v3&#39;, entry_point=&#39;gym.envs.box2d.bipedal_walker:BipedalWalker&#39;, reward_threshold=300, nondeterministic=False, max_episode_steps=1600, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;BipedalWalker&#39;, version=3), EnvSpec(id=&#39;BipedalWalkerHardcore-v3&#39;, entry_point=&#39;gym.envs.box2d.bipedal_walker:BipedalWalker&#39;, reward_threshold=300, nondeterministic=False, max_episode_steps=2000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={&#39;hardcore&#39;: True}, namespace=None, name=&#39;BipedalWalkerHardcore&#39;, version=3), EnvSpec(id=&#39;CarRacing-v2&#39;, entry_point=&#39;gym.envs.box2d.car_racing:CarRacing&#39;, reward_threshold=900, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;CarRacing&#39;, version=2), EnvSpec(id=&#39;Blackjack-v1&#39;, entry_point=&#39;gym.envs.toy_text.blackjack:BlackjackEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=None, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={&#39;sab&#39;: True, &#39;natural&#39;: False}, namespace=None, name=&#39;Blackjack&#39;, version=1), EnvSpec(id=&#39;FrozenLake-v1&#39;, entry_point=&#39;gym.envs.toy_text.frozen_lake:FrozenLakeEnv&#39;, reward_threshold=0.7, nondeterministic=False, max_episode_steps=100, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={&#39;map_name&#39;: &#39;4x4&#39;}, namespace=None, name=&#39;FrozenLake&#39;, version=1), EnvSpec(id=&#39;FrozenLake8x8-v1&#39;, entry_point=&#39;gym.envs.toy_text.frozen_lake:FrozenLakeEnv&#39;, reward_threshold=0.85, nondeterministic=False, max_episode_steps=200, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={&#39;map_name&#39;: &#39;8x8&#39;}, namespace=None, name=&#39;FrozenLake8x8&#39;, version=1), EnvSpec(id=&#39;CliffWalking-v0&#39;, entry_point=&#39;gym.envs.toy_text.cliffwalking:CliffWalkingEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=None, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;CliffWalking&#39;, version=0), EnvSpec(id=&#39;Taxi-v3&#39;, entry_point=&#39;gym.envs.toy_text.taxi:TaxiEnv&#39;, reward_threshold=8, nondeterministic=False, max_episode_steps=200, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Taxi&#39;, version=3), EnvSpec(id=&#39;Reacher-v2&#39;, entry_point=&#39;gym.envs.mujoco:ReacherEnv&#39;, reward_threshold=-3.75, nondeterministic=False, max_episode_steps=50, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Reacher&#39;, version=2), EnvSpec(id=&#39;Reacher-v4&#39;, entry_point=&#39;gym.envs.mujoco.reacher_v4:ReacherEnv&#39;, reward_threshold=-3.75, nondeterministic=False, max_episode_steps=50, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Reacher&#39;, version=4), EnvSpec(id=&#39;Pusher-v2&#39;, entry_point=&#39;gym.envs.mujoco:PusherEnv&#39;, reward_threshold=0.0, nondeterministic=False, max_episode_steps=100, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Pusher&#39;, version=2), EnvSpec(id=&#39;Pusher-v4&#39;, entry_point=&#39;gym.envs.mujoco.pusher_v4:PusherEnv&#39;, reward_threshold=0.0, nondeterministic=False, max_episode_steps=100, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Pusher&#39;, version=4), EnvSpec(id=&#39;InvertedPendulum-v2&#39;, entry_point=&#39;gym.envs.mujoco:InvertedPendulumEnv&#39;, reward_threshold=950.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;InvertedPendulum&#39;, version=2), EnvSpec(id=&#39;InvertedPendulum-v4&#39;, entry_point=&#39;gym.envs.mujoco.inverted_pendulum_v4:InvertedPendulumEnv&#39;, reward_threshold=950.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;InvertedPendulum&#39;, version=4), EnvSpec(id=&#39;InvertedDoublePendulum-v2&#39;, entry_point=&#39;gym.envs.mujoco:InvertedDoublePendulumEnv&#39;, reward_threshold=9100.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;InvertedDoublePendulum&#39;, version=2), EnvSpec(id=&#39;InvertedDoublePendulum-v4&#39;, entry_point=&#39;gym.envs.mujoco.inverted_double_pendulum_v4:InvertedDoublePendulumEnv&#39;, reward_threshold=9100.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;InvertedDoublePendulum&#39;, version=4), EnvSpec(id=&#39;HalfCheetah-v2&#39;, entry_point=&#39;gym.envs.mujoco:HalfCheetahEnv&#39;, reward_threshold=4800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;HalfCheetah&#39;, version=2), EnvSpec(id=&#39;HalfCheetah-v3&#39;, entry_point=&#39;gym.envs.mujoco.half_cheetah_v3:HalfCheetahEnv&#39;, reward_threshold=4800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;HalfCheetah&#39;, version=3), EnvSpec(id=&#39;HalfCheetah-v4&#39;, entry_point=&#39;gym.envs.mujoco.half_cheetah_v4:HalfCheetahEnv&#39;, reward_threshold=4800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;HalfCheetah&#39;, version=4), EnvSpec(id=&#39;Hopper-v2&#39;, entry_point=&#39;gym.envs.mujoco:HopperEnv&#39;, reward_threshold=3800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Hopper&#39;, version=2), EnvSpec(id=&#39;Hopper-v3&#39;, entry_point=&#39;gym.envs.mujoco.hopper_v3:HopperEnv&#39;, reward_threshold=3800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Hopper&#39;, version=3), EnvSpec(id=&#39;Hopper-v4&#39;, entry_point=&#39;gym.envs.mujoco.hopper_v4:HopperEnv&#39;, reward_threshold=3800.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Hopper&#39;, version=4), EnvSpec(id=&#39;Swimmer-v2&#39;, entry_point=&#39;gym.envs.mujoco:SwimmerEnv&#39;, reward_threshold=360.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Swimmer&#39;, version=2), EnvSpec(id=&#39;Swimmer-v3&#39;, entry_point=&#39;gym.envs.mujoco.swimmer_v3:SwimmerEnv&#39;, reward_threshold=360.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Swimmer&#39;, version=3), EnvSpec(id=&#39;Swimmer-v4&#39;, entry_point=&#39;gym.envs.mujoco.swimmer_v4:SwimmerEnv&#39;, reward_threshold=360.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Swimmer&#39;, version=4), EnvSpec(id=&#39;Walker2d-v2&#39;, entry_point=&#39;gym.envs.mujoco:Walker2dEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Walker2d&#39;, version=2), EnvSpec(id=&#39;Walker2d-v3&#39;, entry_point=&#39;gym.envs.mujoco.walker2d_v3:Walker2dEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Walker2d&#39;, version=3), EnvSpec(id=&#39;Walker2d-v4&#39;, entry_point=&#39;gym.envs.mujoco.walker2d_v4:Walker2dEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Walker2d&#39;, version=4), EnvSpec(id=&#39;Ant-v2&#39;, entry_point=&#39;gym.envs.mujoco:AntEnv&#39;, reward_threshold=6000.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Ant&#39;, version=2), EnvSpec(id=&#39;Ant-v3&#39;, entry_point=&#39;gym.envs.mujoco.ant_v3:AntEnv&#39;, reward_threshold=6000.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Ant&#39;, version=3), EnvSpec(id=&#39;Ant-v4&#39;, entry_point=&#39;gym.envs.mujoco.ant_v4:AntEnv&#39;, reward_threshold=6000.0, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Ant&#39;, version=4), EnvSpec(id=&#39;Humanoid-v2&#39;, entry_point=&#39;gym.envs.mujoco:HumanoidEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Humanoid&#39;, version=2), EnvSpec(id=&#39;Humanoid-v3&#39;, entry_point=&#39;gym.envs.mujoco.humanoid_v3:HumanoidEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Humanoid&#39;, version=3), EnvSpec(id=&#39;Humanoid-v4&#39;, entry_point=&#39;gym.envs.mujoco.humanoid_v4:HumanoidEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;Humanoid&#39;, version=4), EnvSpec(id=&#39;HumanoidStandup-v2&#39;, entry_point=&#39;gym.envs.mujoco:HumanoidStandupEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;HumanoidStandup&#39;, version=2), EnvSpec(id=&#39;HumanoidStandup-v4&#39;, entry_point=&#39;gym.envs.mujoco.humanoidstandup_v4:HumanoidStandupEnv&#39;, reward_threshold=None, nondeterministic=False, max_episode_steps=1000, order_enforce=True, autoreset=False, disable_env_checker=False, new_step_api=False, kwargs={}, namespace=None, name=&#39;HumanoidStandup&#39;, version=4)])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Problema do Taxi</span>

<span class="n">env3</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">env3</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env3</span><span class="o">.</span><span class="n">observation_space</span><span class="p">)</span>
<span class="n">env3</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Discrete(6)
Discrete(500)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>443
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">env3</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ansi&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------+
|R: | : :<span class=" -Color -Color-Bold -Color-Bold-Blue">G</span>|
| :<span class=" -Color -Color-BGYellow"> </span>| : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="problema-do-taxi">
<h3>Problema do táxi<a class="headerlink" href="#problema-do-taxi" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Temos 4 localizações relevantes indicadas por 0:R, 1:G, 2:Y e 3:B.</p></li>
<li><p>Azul é o passageiro e magenta o destino.</p></li>
<li><p>O taxi é amarelo quando livre e verde quando ocupado</p></li>
<li><p>Grid contém 25 posições para o táxi, 5 para o passageiro, e 4 destinos</p></li>
</ul>
<p><strong>Ações</strong>:<br>
0 : mover para norte<br>
1 : mover para sul<br>
2 : mover para leste<br>
3 : mover para oeste<br>
4 : pegar passageiro (pickup)<br>
5 : deixar passageiro (dropoff)</p>
<p><strong>Observação/estado</strong>:<br>
Posições do taxi, passageiro e destino codificada numericamente</p>
<p><strong>Recompensas</strong>:<br></p>
<ul class="simple">
<li><p>-1 : por passo<br></p></li>
<li><p>20 : deixar passageiro<br></p></li>
<li><p>-10: executar “pegar” ou “deixar” ilegalmente</p></li>
</ul>
<p><strong>Término</strong>:</p>
<ul class="simple">
<li><p>Passageiro é deixado no destino</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inicializacao e estado inicial</span>
<span class="n">observ0</span> <span class="o">=</span> <span class="n">env3</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado inicial: &quot;</span><span class="p">,</span> <span class="n">observ0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">acao</span> <span class="o">=</span> <span class="n">env3</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env3</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">acao</span><span class="p">)</span> <span class="c1"># take a random action</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">env3</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ansi&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado atual:&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recompensa: &quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">fim</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio finalizou após </span><span class="si">%d</span><span class="s2"> passos&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">break</span>

<span class="n">env3</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estado inicial:  43 

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: |<span class=" -Color -Color-BGYellow"> </span>: :G|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
  (Dropoff)

Estado atual: 43
Recompensa:  -10

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | :<span class=" -Color -Color-BGYellow"> </span>:G|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
  (East)

Estado atual: 63
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | :<span class=" -Color -Color-BGYellow"> </span>: |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
  (South)

Estado atual: 163
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | : : |
| : : :<span class=" -Color -Color-BGYellow"> </span>: |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
  (South)

Estado atual: 263
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | : : |
| : : : : |
| | : |<span class=" -Color -Color-BGYellow"> </span>: |
|Y| : |<span class=" -Color -Color-Magenta">B</span>: |
+---------+
  (South)

Estado atual: 363
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta -Color-Magenta-BGYellow">B</span>: |
+---------+
  (South)

Estado atual: 463
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>:<span class=" -Color -Color-BGYellow"> </span>|
+---------+
  (East)

Estado atual: 483
Recompensa:  -1

+---------+
|<span class=" -Color -Color-Bold -Color-Bold-Blue">R</span>: | : :G|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Magenta">B</span>:<span class=" -Color -Color-BGYellow"> </span>|
+---------+
  (East)

Estado atual: 483
Recompensa:  -1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Action: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reward: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">])</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env4</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="c1"># inicializacao e estado inicial</span>
<span class="n">observ0</span> <span class="o">=</span> <span class="n">env4</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># animacao</span>

<span class="n">rec_total</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># passos</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>

    <span class="c1"># amostra ação do espaço</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">env4</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="c1"># executa acao</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env4</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">rec_total</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">env4</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ansi&#39;</span><span class="p">),</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">r</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">fim</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio finalizou após </span><span class="si">%d</span><span class="s2"> passos&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">break</span>

<span class="n">env4</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recompensa total episódio: &quot;</span><span class="p">,</span> <span class="n">rec_total</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------+
|R: | : :G|
| : | : : |
| : : : :<span class=" -Color -Color-BGYellow"> </span>|
| | : | : |
|<span class=" -Color -Color-Magenta">Y</span>| : |<span class=" -Color -Color-Bold -Color-Bold-Blue">B</span>: |
+---------+
  (Dropoff)

t:  100
State:  294
Action:  5
Reward:  -10
Recompensa total episódio:  -397
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id129">
<h2><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span><a class="headerlink" href="#id129" title="Permalink to this heading">#</a></h2>
<section id="span-style-color-darkred-parte-2-algoritmo-de-aprendizado-por-reforco-value-learning-span">
<h3><span style="color:darkred"><strong>Parte 2: Algoritmo de Aprendizado por Reforço “Value Learning”</strong></span><a class="headerlink" href="#span-style-color-darkred-parte-2-algoritmo-de-aprendizado-por-reforco-value-learning-span" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problema-taxi">
<h3>Problema Taxi<a class="headerlink" href="#problema-taxi" title="Permalink to this heading">#</a></h3>
<p>Relembrando:</p>
<ul class="simple">
<li><p>Temos 4 localizações relevantes indicadas por 0:R, 1:G, 2:Y e 3:B.</p></li>
<li><p>Azul é o passageiro e magenta o destino.</p></li>
<li><p>O taxi é amarelo quando livre e verde quando ocupado</p></li>
<li><p>Grid contém 25 posições para o táxi, 5 para o passageiro, e 4 destinos</p></li>
</ul>
<p><strong>Ações</strong>:<br>
0 : mover para norte<br>
1 : mover para sul<br>
2 : mover para leste<br>
3 : mover para oeste<br>
4 : pegar passageiro (pickup)<br>
5 : deixar passageiro (dropoff)</p>
<p><strong>Observação/estado</strong>:<br>
Posições do taxi, passageiro e destino codificada numericamente</p>
<p><strong>Recompensas</strong>:<br></p>
<ul class="simple">
<li><p>-1 : por passo<br></p></li>
<li><p>20 : deixar passageiro<br></p></li>
<li><p>-10: executar “pegar” ou “deixar” ilegalmente</p></li>
</ul>
<p><strong>Término</strong>:</p>
<ul class="simple">
<li><p>Passageiro é deixado no destino</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;Taxi-v3&quot;</span><span class="p">)</span>

<span class="c1"># tabela Q</span>
<span class="n">q_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>

<span class="n">q_table</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(500, 6)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span><span class="mi">305</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0. 0. 0. 0. 0. 0.]
[0. 0. 0. 0. 0. 0.]
[0. 0. 0. 0. 0. 0.]
[0. 0. 0. 0. 0. 0.]
</pre></div>
</div>
</div>
</div>
<section id="algoritmo-de-value-learning">
<h4>Algoritmo de Value learning<a class="headerlink" href="#algoritmo-de-value-learning" title="Permalink to this heading">#</a></h4>
<p>Tentaremos predizer o valor atual, ajustando com o melhor valor do estado subsequente.</p>
<p>Iremos considerar uma taxa de aprendizado <span class="math notranslate nohighlight">\(\alpha\)</span> e um desconto para recompensas futuras <span class="math notranslate nohighlight">\(\gamma\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hiperparametros</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># taxa de aprendizado</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># desconto de recompensas futuras</span>

<span class="c1"># historico</span>
<span class="n">episodios</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># episodios</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">epochs</span><span class="p">,</span> <span class="n">recompensas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># episodio atual</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="c1"># explorar espaco de acao</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

        <span class="c1"># realizar acao</span>
        <span class="n">s_n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1"># estado subsequente s_n</span>

        <span class="c1"># salvo o valor atual para (s,a) - Q(s,a)</span>
        <span class="n">valor_ant</span> <span class="o">=</span> <span class="n">q_table</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>

        <span class="c1"># verifica proximo valor</span>
        <span class="n">prox_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">q_table</span><span class="p">[</span><span class="n">s_n</span><span class="p">])</span>

        <span class="c1"># combina com desconto na recompensa futura</span>
        <span class="n">novo_valor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">valor_ant</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">gamma</span><span class="o">*</span><span class="n">prox_max</span><span class="p">)</span>
        <span class="n">q_table</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">novo_valor</span>

        <span class="c1"># atualiza estado</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s_n</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">250</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Episódio: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Ao consultar a tabela, teremos <em>valores</em> diferentes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span><span class="mi">305</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">q_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1.1404 -1.059  -0.7172 -0.9744 -8.1059 -7.8449]
[-0.6963 -0.7288 -0.5557 -0.371  -3.4485 -4.149 ]
[-0.8611 -0.6747 -0.5985 -0.8149 -3.4815 -6.2218]
[-0.4231 -0.5191 -0.195  -0.6046 -5.7218 -3.4532]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="avaliando-a-performance-do-agente">
<h3>Avaliando a performance do agente<a class="headerlink" href="#avaliando-a-performance-do-agente" title="Permalink to this heading">#</a></h3>
<p>Após obter a função Q, armazenada na tabela, agora podemos avaliar a performance do agente</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_episodios_teste</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">total_epochs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total_recs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_episodios_teste</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">epochs</span><span class="p">,</span> <span class="n">rec_total_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">rec_total_i</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">total_epochs</span> <span class="o">+=</span> <span class="n">epochs</span>
    <span class="n">total_recs</span> <span class="o">+=</span> <span class="n">rec_total_i</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de recompensas totais: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_recs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Média de passos por episódio: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_epochs</span><span class="o">/</span><span class="n">n_episodios_teste</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Média de recompensas totais: 8.42
Média de passos por episódio: 12.58
</pre></div>
</div>
</div>
</div>
<section id="executando-uma-vez-para-visualizar">
<h4>Executando uma vez para visualizar<a class="headerlink" href="#executando-uma-vez-para-visualizar" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="k">def</span> <span class="nf">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estado: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ação: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recompensa: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">])</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inicializacao</span>
<span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># animacao</span>
<span class="n">rec_total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">epochs</span><span class="p">,</span> <span class="n">rec_total_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="n">fim</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">fim</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_table</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fim</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">rec_total</span> <span class="o">+=</span> <span class="n">r</span>

    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;ansi&#39;</span><span class="p">),</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">r</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recompensa total: &quot;</span><span class="p">,</span> <span class="n">rec_total</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passos até o estado terminal: &quot;</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---------+
|R: | : :<span class=" -Color -Color-Magenta -Color-Magenta-BGYellow">G</span>|
| : | : : |
| : : : : |
| | : | : |
|Y| : |<span class=" -Color -Color-Bold -Color-Bold-Blue">B</span>: |
+---------+
  (North)

t:  23
Estado:  93
Ação:  1
Recompensa:  -1
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-25-ef1cdc1285ec&gt;</span> in <span class="ni">&lt;cell line: 26&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span> 
<span class="ne">---&gt; </span><span class="mi">26</span> <span class="n">animacao_episodio</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recompensa total: &quot;</span><span class="p">,</span> <span class="n">rec_total</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passos até o estado terminal: &quot;</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>

<span class="nn">&lt;ipython-input-9-efc7a86642ae&gt;</span> in <span class="ni">animacao_episodio</span><span class="nt">(frames)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ação: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recompensa: &quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">])</span>
<span class="ne">---&gt; </span><span class="mi">11</span>         <span class="n">sleep</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="avaliacao-final-2023">
<h2>Avaliação Final - 2023<a class="headerlink" href="#avaliacao-final-2023" title="Permalink to this heading">#</a></h2>
<p>Nessa avaliação será utilizado o dataset <code class="docutils literal notranslate"><span class="pre">imdb-reviews-pt-br.csv</span></code> que contém avaliações de filmes realizadas no site IMDB, com textos em português e em inglês. O alvo do dataset é a coluna <code class="docutils literal notranslate"><span class="pre">sentiment</span></code> que contém o sentimento relacionado à avaliação: positivo ou negativo.</p>
<p>Vamos explorar um sentence embedding pré-treinado para multiplos idiomas, e avaliar redes neurais comparando-as com relação aos textos em inglês e português.</p>
<p>Use o código existente como forma ilustrativa, adaptando e completando quando necessário para realizar as tarefas.</p>
<p>As tarefas a realizar são as seguintes:</p>
<p>Preparação:</p>
<ol class="arabic simple">
<li><p><strong>Instalar o pacote</strong> <code class="docutils literal notranslate"><span class="pre">sentence_transformers</span></code> e <strong>carregar o modelo</strong> ‘paraphrase-multilingual-mpnet-base-v2’ para geração de sentence embeddings, conforme mostrado no código abaixo.</p></li>
<li><p><strong>Carregar a base de dados</strong> e obter uma amostra de 10 mil linhas (use o método <code class="docutils literal notranslate"><span class="pre">sample</span></code> do dataframe pandas).</p></li>
<li><p><strong>Gerar os embeddings</strong> usando o método encode, para os textos em português e em inglês. Ver <a class="reference external" href="https://www.sbert.net/examples/applications/computing-embeddings/README.html">https://www.sbert.net/examples/applications/computing-embeddings/README.html</a> para mais detalhes. OBS: pode demorar um pouco</p></li>
<li><p><strong>Separar dados</strong> 85% para treinamento, 15% para teste usando <code class="docutils literal notranslate"><span class="pre">train_test_split</span></code>, sendo a mesma partição para ingles e portugues.</p></li>
</ol>
<p>Modelos:</p>
<ol class="arabic">
<li><p>(2,5 pt) <strong>Modelo A</strong>: projete e treine uma rede neural profunda densa, utilizando como entrada os embeddings em <strong>portugues</strong> para análise de sentimento (classificação binária).<br></p>
<ul class="simple">
<li><p>A arquitetura deve ter portanto as seguintes camadas:</p>
<ul>
<li><p>entrada</p></li>
<li><p>normalização em batch</p></li>
<li><p>densa 384 neurônios, relu</p></li>
<li><p>densa 384 neurônios, ativação linear</p></li>
<li><p>normalização em batch</p></li>
<li><p>ativação relu</p></li>
<li><p>dropout 0.375</p></li>
<li><p>densa 1 neurônio, sigmoide</p></li>
</ul>
</li>
<li><p>Utilizar Adam com taxa de aprendizado inicial de 0.0007 e com decaimento em todas as épocas exponencial a -0.075</p></li>
<li><p>Treinar com perda entropia cruzada por 15 épocas com batch size 24</p></li>
<li><p>Compute como métricas, além da perda, a área sob a curva Precision-Recall (AUC PR) e a Acurácia Binária (ver <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/metrics">https://www.tensorflow.org/api_docs/python/tf/keras/metrics</a>)<br><br></p></li>
</ul>
</li>
<li><p>(2,5 pt) <strong>Modelo B</strong>: projete e treine uma rede neural profunda densa, utilizando como entrada os <em>textos tokenizados</em> em <strong>português</strong> para análise de sentimento (classificação binária).<br></p>
<ul class="simple">
<li><p>A arquitetura deve ter portanto as seguintes camadas:</p>
<ul>
<li><p>entrada</p></li>
<li><p>camada embedding com max_words=5000 e dimensão do embedding de tamanho 128</p></li>
<li><p>camada convolucional 1d com 32 neuronios de tamanho 2 e padding=’same’, ativação relu</p></li>
<li><p>camada LSTM 256 neurônios, sem ativação</p></li>
<li><p>densa 384 neurônios, ativação relu</p></li>
<li><p>dropout 0.375</p></li>
<li><p>densa 1 neurônio, sigmoide</p></li>
</ul>
</li>
<li><p>Utilizar os mesmos hiper-parâmetros de otimização, treinamento e métricas do modelo anterior<br><br></p></li>
</ul>
</li>
<li><p>(2,0 pt) <strong>Avalie as rede neurais de classificação</strong> (Modelos A e B):</p>
<ul class="simple">
<li><p>Exiba o gráfico das métricas PR AUC e Accuracy calculadas no treinamento ao longo das épocas para o modelos A e B</p></li>
<li><p>Calcule e exiba as métricas no conjunto de teste usando o cada modelo</br></br></p></li>
</ul>
</li>
<li><p>(3,0 pt) <strong>Fine-tuning</strong> dos Modelo A e B com os dados em inglês, treinando por 15 épocas e batch_size=24, com Adam e taxa de aprendizado 0.00002 (sem decaimento):</p>
<ol class="arabic simple">
<li><p>Modelo A: realize ajuste fino, congelando a primeira camada densa (de 384 neurônios)</p></li>
<li><p>Modelo B: realize ajuste fino permitindo a adaptação de todas as camadas</p></li>
</ol>
<ul class="simple">
<li><p>calcular e exibir métricas dos modelos após fine-tuning usando o conjunto de tests em ingles</br></br></p></li>
</ul>
</li>
<li><p><strong>Bônus:</strong> (+1 ponto extra)</p>
<ul class="simple">
<li><p><em>Análise de projeção das características</em>: visualize scatterplots com os 2 dimensões obtidos com o método tSNE as classes dos exemplos atribuídas com cores ou marcadores diferentes:</p>
<ol class="arabic simple">
<li><p>scatterplot com projeção tSNE do conjunto de teste referente ao embedding original em português (paraphrase-multilingual-mpnet-base-v2)</p></li>
<li><p>scatterplot com projeção tSNE da última camada densa de 384 dimensões extraído do conjunto de teste  em português (embeddings pré-treinados) referente ao <em>Modelo A</em></p></li>
<li><p>scatterplot com projeção tSNE da última camada densa de 384 dimensões extraído do conjunto de teste  em português (tokens) referente ao <em>Modelo B</em></p></li>
</ol>
</li>
<li><p>Após visualização, escreva comentários com suas conclusões sobre a análise visual</p></li>
</ul>
</li>
</ol>
</section>
<section id="preparacao">
<h2>Preparação<a class="headerlink" href="#preparacao" title="Permalink to this heading">#</a></h2>
<section id="biblioteca-sentence-transformers-e-carregar-modelo">
<h3>1. Biblioteca <code class="docutils literal notranslate"><span class="pre">sentence_transformers</span></code> e carregar modelo<a class="headerlink" href="#biblioteca-sentence-transformers-e-carregar-modelo" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install sentence_transformers</span>
<span class="c1">#Comentado pois já foi instalado</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># bibliotecas recomendadas, voce pode adicionar mais conforme necessario</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>

<span class="kn">from</span> <span class="nn">tensorflow.random</span> <span class="kn">import</span> <span class="n">set_seed</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.text</span> <span class="kn">import</span> <span class="n">Tokenizer</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.sequence</span> <span class="kn">import</span> <span class="n">pad_sequences</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span><span class="p">,</span> <span class="n">util</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From C:\Users\jmblima\AppData\Local\anaconda3\Lib\site-packages\keras\src\losses.py:2976: The name tf.losses.sparse_softmax_cross_entropy is deprecated. Please use tf.compat.v1.losses.sparse_softmax_cross_entropy instead.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># baixar modelo codificador de setenças &#39;paraphrase-multilingual-mpnet-base-v2&#39; conforme enunciado</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;paraphrase-multilingual-mpnet-base-v2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="carregar-base-de-dados-e-obter-amostra">
<h3>2. Carregar base de dados e obter amostra<a class="headerlink" href="#carregar-base-de-dados-e-obter-amostra" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!gdown 1ltAAPcaPD1epgs-F9i-nhaF350DPPrGK</span>

<span class="c1"># ler base de dados</span>
<span class="n">df_orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;imdb-reviews-pt-br.csv&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># obter amostra de 10.000</span>
<span class="n">tam_amostra</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_orig</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">tam_amostra</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sentiment
pos    5048
neg    4952
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># Verificando as primeiras linhas do DF importado</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>text_en</th>
      <th>text_pt</th>
      <th>sentiment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>35668</td>
      <td>This show is not clever. Thats basically what ...</td>
      <td>Esse show não é inteligente. Isso é basicament...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22938</td>
      <td>I thought that this is a wonderfully written m...</td>
      <td>Eu pensei que este é um filme maravilhosamente...</td>
      <td>pos</td>
    </tr>
    <tr>
      <th>2</th>
      <td>26614</td>
      <td>As interesting as a sheet of cardboard, this d...</td>
      <td>Tão interessante quanto uma folha de papelão, ...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>3</th>
      <td>27334</td>
      <td>How this film ever got a 6 star average is bey...</td>
      <td>Como este filme já teve uma média de 6 estrela...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>4</th>
      <td>26019</td>
      <td>We saw this on the shelf at the local video st...</td>
      <td>Vimos isso na prateleira da locadora de vídeo ...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10563</td>
      <td>only if its the last thing yo do and your humo...</td>
      <td>só se for a última coisa que fizer e seu humor...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>6</th>
      <td>29624</td>
      <td>This movie was just heckled by MST3K and with ...</td>
      <td>Este filme foi apenas interceptado pelo MST3K ...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8550</td>
      <td>Let me say at the outset that Im not a very ar...</td>
      <td>Deixe-me dizer no início que eu não sou uma pe...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2821</td>
      <td>Blake Edwards tried very hard to change Julie ...</td>
      <td>Blake Edwards tentou muito mudar a imagem de J...</td>
      <td>neg</td>
    </tr>
    <tr>
      <th>9</th>
      <td>44236</td>
      <td>This stylistically sophisticated visual game p...</td>
      <td>Este jogo visual estilisticamente sofisticado ...</td>
      <td>pos</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="separar-dados-em-treinamento-e-teste-preparar-rotulos-e-estimar-numero-de-palavras-nas-instancias">
<h3>3. Separar dados em treinamento e teste, preparar rótulos e estimar número de palavras nas instancias<a class="headerlink" href="#separar-dados-em-treinamento-e-teste-preparar-rotulos-e-estimar-numero-de-palavras-nas-instancias" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rotulos</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="c1">#Divisão da base em treino e teste (85/15)</span>
<span class="n">X_train_txt_en</span><span class="p">,</span> <span class="n">X_test_txt_en</span><span class="p">,</span> <span class="n">y_train_en</span><span class="p">,</span> <span class="n">y_test_en</span><span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">text_en</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>
<span class="n">X_train_txt_pt</span><span class="p">,</span> <span class="n">X_test_txt_pt</span><span class="p">,</span> <span class="n">y_train_pt</span><span class="p">,</span> <span class="n">y_test_pt</span><span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">text_pt</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>

<span class="c1">#Teste para verificar diferenças entre a coluna em inglês e port (random state)</span>
<span class="nb">sum</span><span class="p">(</span><span class="n">y_train_en</span><span class="o">!=</span><span class="n">y_train_pt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># obter numero de palavras nos dados em portugues</span>
<span class="n">num_words</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">text_pt</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="n">num_words</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">percentile_75</span> <span class="o">=</span> <span class="n">num_words</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">percentile_95</span> <span class="o">=</span> <span class="n">num_words</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;percentil 75: </span><span class="si">{</span><span class="n">percentile_75</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;percentil 95: </span><span class="si">{</span><span class="n">percentile_95</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximo: </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>percentil 75: 269.0
percentil 95: 549.0
Maximo: 955
</pre></div>
</div>
</div>
</div>
<p>Usaremos o valor do percentil 75 para limitar o tamanho da sentenca no processo de tokenizacao dos textos, tanto para o Portugues quanto para o Ingles.</p>
</section>
<section id="geracao-dos-embeddings">
<h3>4. Geração dos embeddings<a class="headerlink" href="#geracao-dos-embeddings" title="Permalink to this heading">#</a></h3>
<p>Gerar e armazenar embeddings para uso como entrada para o modelo A</p>
<p>Exemplo de uso: <code class="docutils literal notranslate"><span class="pre">model.encode(texto,</span> <span class="pre">batch_size=10,</span> <span class="pre">show_progress_bar=True)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Embeddings dos Textos em ingles (treinamento e teste)</span>
<span class="n">embeddings_train</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">X_train_txt_en</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">embeddings_test</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">X_test_txt_en</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Similarity:&quot;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">dot_score</span><span class="p">(</span><span class="n">embeddings_train</span><span class="p">,</span> <span class="n">embeddings_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f203d41978aa42909f0e862d23163406", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3ed0cd151fa9478d8949641f818811d3", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Similarity: tensor([[3.1590, 3.4519, 1.5644,  ..., 1.9984, 1.5925, 3.7460],
        [1.7468, 0.9279, 2.0933,  ..., 2.5202, 0.7782, 1.8697],
        [3.8906, 2.8403, 2.4475,  ..., 2.2244, 1.4180, 3.6132],
        ...,
        [2.3072, 1.5124, 2.4917,  ..., 1.7448, 0.6633, 3.1070],
        [2.1846, 1.3713, 2.7736,  ..., 1.9600, 0.9954, 2.8793],
        [2.3308, 1.8574, 1.6102,  ..., 2.1179, 1.5841, 2.0061]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Embeddings dos Textos em portugues (treinamento e teste)</span>
<span class="n">embeddings_pt_train</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">X_train_txt_pt</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">embeddings_pt_test</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">X_test_txt_pt</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Similarity:&quot;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">dot_score</span><span class="p">(</span><span class="n">embeddings_pt_train</span><span class="p">,</span> <span class="n">embeddings_pt_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a7198992dccb4539b95f98e89398dfca", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4f5f16dad0034a3994113990482c2d4d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Similarity: tensor([[2.8994, 3.2233, 0.9757,  ..., 1.9585, 1.5549, 2.8900],
        [1.5978, 1.1575, 1.6085,  ..., 2.2392, 0.8912, 1.7676],
        [3.4118, 2.7360, 1.7795,  ..., 1.9474, 1.2782, 2.9745],
        ...,
        [1.9892, 1.3116, 1.5423,  ..., 1.7410, 0.6407, 2.4591],
        [2.1957, 1.5015, 1.9203,  ..., 1.7989, 1.1737, 2.6558],
        [2.3928, 1.4599, 1.3933,  ..., 1.9902, 1.6639, 1.7615]])
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="5">
<li><p>Tokenização do texto</p></li>
</ol>
<p>Seguir exemplo usado para textos em Portugues, e repetir para os textos em Ingles</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Numero maximo de palavras no vocabulario (com base na frequencia)</span>
<span class="n">max_words</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Tamanho maximo da sequencia (serao truncadas maiores) usando percentil 75</span>
<span class="n">max_sequence_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile_75</span><span class="p">)</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">max_words</span><span class="p">)</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">fit_on_texts</span><span class="p">(</span><span class="n">X_train_txt_pt</span><span class="p">)</span>

<span class="n">sequences_train</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">texts_to_sequences</span><span class="p">(</span><span class="n">X_train_txt_pt</span><span class="p">)</span>
<span class="n">sequences_test</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">texts_to_sequences</span><span class="p">(</span><span class="n">X_test_txt_pt</span><span class="p">)</span>

<span class="c1"># realizar padding para igualar sentencas</span>
<span class="n">X_train_tok_pt</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">sequences_train</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_sequence_length</span><span class="p">)</span>
<span class="n">X_test_tok_pt</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">sequences_test</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_sequence_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## realizar o mesmo procedimento para os textos em ingles</span>
<span class="c1"># use os mesmos parametros de maximo de palavras e sequencia</span>
<span class="n">max_words</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="c1"># Tamanho maximo da sequencia (serao truncadas maiores) usando percentil 75</span>
<span class="c1"># Recalculando o percentil com base nas sequencias em inglês</span>
<span class="n">num_words</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">text_en</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
<span class="n">percentile_75</span> <span class="o">=</span> <span class="n">num_words</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">max_sequence_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile_75</span><span class="p">)</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">max_words</span><span class="p">)</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">fit_on_texts</span><span class="p">(</span><span class="n">X_train_txt_en</span><span class="p">)</span>

<span class="n">sequences_train</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">texts_to_sequences</span><span class="p">(</span><span class="n">X_train_txt_en</span><span class="p">)</span>
<span class="n">sequences_test</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">texts_to_sequences</span><span class="p">(</span><span class="n">X_test_txt_en</span><span class="p">)</span>

<span class="c1"># realizar padding para igualar sentencas</span>
<span class="n">X_train_tok_en</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">sequences_train</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_sequence_length</span><span class="p">)</span>
<span class="n">X_test_tok_en</span> <span class="o">=</span> <span class="n">pad_sequences</span><span class="p">(</span><span class="n">sequences_test</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_sequence_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="realizar-tarefas">
<h2>Realizar Tarefas:<a class="headerlink" href="#realizar-tarefas" title="Permalink to this heading">#</a></h2>
<section id="pt-modelo-a-classificador-de-sentimento-em-portugues-usando-embedding-pre-treinado">
<h3>1. (2,5 pt) Modelo A: classificador de sentimento em <em>portugues</em> usando embedding pré-treinado<a class="headerlink" href="#pt-modelo-a-classificador-de-sentimento-em-portugues-usando-embedding-pre-treinado" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># definir modelo A</span>

<span class="n">tamanho</span> <span class="o">=</span> <span class="n">embeddings_pt_train</span><span class="o">.</span><span class="n">shape</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">tamanho</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.375</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">modelo_A</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
<span class="n">modelo_A</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From C:\Users\jmblima\AppData\Local\anaconda3\Lib\site-packages\keras\src\backend.py:1398: The name tf.executing_eagerly_outside_functions is deprecated. Please use tf.compat.v1.executing_eagerly_outside_functions instead.

Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, 768)]             0         
                                                                 
 batch_normalization (Batch  (None, 768)               3072      
 Normalization)                                                  
                                                                 
 dense (Dense)               (None, 384)               295296    
                                                                 
 dense_1 (Dense)             (None, 384)               147840    
                                                                 
 batch_normalization_1 (Bat  (None, 384)               1536      
 chNormalization)                                                
                                                                 
 activation (Activation)     (None, 384)               0         
                                                                 
 dropout (Dropout)           (None, 384)               0         
                                                                 
 dense_2 (Dense)             (None, 1)                 385       
                                                                 
=================================================================
Total params: 448129 (1.71 MB)
Trainable params: 445825 (1.70 MB)
Non-trainable params: 2304 (9.00 KB)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># decaimento de learning rate</span>
    <span class="c1"># Utilizar Adam com taxa de aprendizado inicial de 0.0007 e com decaimento em todas as épocas exponencial a -0.075</span>

<span class="c1"># função para variação da learning rate   </span>
<span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">lr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0007</span>
        <span class="k">return</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lr</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.075</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
<span class="n">callbacklr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">)</span>

<span class="c1"># Compilando o modelo com perda entropia cruzada e métricas além da perda, a área sob a curva Precision-Recall (AUC PR) e a Acurácia Binária</span>
<span class="n">modelo_A</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> 
    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">BinaryAccuracy</span><span class="p">(),</span> <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">AUC</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span><span class="p">)])</span>

<span class="c1"># Treinando o modelo para a línguagem PT por 15 épocas com batch size 24</span>
<span class="n">hist_modeloA_treino</span> <span class="o">=</span>  <span class="n">modelo_A</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeddings_pt_train</span><span class="p">,</span> <span class="n">y_train_pt</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From C:\Users\jmblima\AppData\Local\anaconda3\Lib\site-packages\keras\src\optimizers\__init__.py:309: The name tf.train.Optimizer is deprecated. Please use tf.compat.v1.train.Optimizer instead.

Epoch 1/15
WARNING:tensorflow:From C:\Users\jmblima\AppData\Local\anaconda3\Lib\site-packages\keras\src\utils\tf_utils.py:492: The name tf.ragged.RaggedTensorValue is deprecated. Please use tf.compat.v1.ragged.RaggedTensorValue instead.

355/355 [==============================] - 2s 3ms/step - loss: 0.4939 - binary_accuracy: 0.7754 - auc: 0.8497 - lr: 7.0000e-04
Epoch 2/15
355/355 [==============================] - 1s 3ms/step - loss: 0.3824 - binary_accuracy: 0.8311 - auc: 0.9072 - lr: 6.4942e-04
Epoch 3/15
355/355 [==============================] - 1s 3ms/step - loss: 0.3405 - binary_accuracy: 0.8533 - auc: 0.9284 - lr: 6.0249e-04
Epoch 4/15
355/355 [==============================] - 1s 3ms/step - loss: 0.2981 - binary_accuracy: 0.8734 - auc: 0.9440 - lr: 5.5896e-04
Epoch 5/15
355/355 [==============================] - 1s 3ms/step - loss: 0.2560 - binary_accuracy: 0.8915 - auc: 0.9615 - lr: 5.1857e-04
Epoch 6/15
355/355 [==============================] - 1s 3ms/step - loss: 0.2296 - binary_accuracy: 0.9053 - auc: 0.9682 - lr: 4.8110e-04
Epoch 7/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1847 - binary_accuracy: 0.9286 - auc: 0.9795 - lr: 4.4634e-04
Epoch 8/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1532 - binary_accuracy: 0.9434 - auc: 0.9856 - lr: 4.1409e-04
Epoch 9/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1258 - binary_accuracy: 0.9556 - auc: 0.9910 - lr: 3.8417e-04
Epoch 10/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1032 - binary_accuracy: 0.9609 - auc: 0.9936 - lr: 3.5641e-04
Epoch 11/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0951 - binary_accuracy: 0.9629 - auc: 0.9947 - lr: 3.3065e-04
Epoch 12/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0971 - binary_accuracy: 0.9633 - auc: 0.9943 - lr: 3.0676e-04
Epoch 13/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0689 - binary_accuracy: 0.9751 - auc: 0.9973 - lr: 2.8460e-04
Epoch 14/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0558 - binary_accuracy: 0.9818 - auc: 0.9984 - lr: 2.6403e-04
Epoch 15/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0533 - binary_accuracy: 0.9812 - auc: 0.9982 - lr: 2.4496e-04
</pre></div>
</div>
</div>
</div>
</section>
<section id="pt-modelo-b-classificador-de-sentimento-em-portugues-usando-tokenizador-e-rede-cnn-lstm">
<h3>2. (2,5 pt) Modelo B: classificador de sentimento em <em>português</em> usando tokenizador e rede CNN+LSTM<a class="headerlink" href="#pt-modelo-b-classificador-de-sentimento-em-portugues-usando-tokenizador-e-rede-cnn-lstm" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># definir modelo B </span>
<span class="n">tamanho</span> <span class="o">=</span> <span class="n">X_train_tok_pt</span><span class="o">.</span><span class="n">shape</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">emb</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">256</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> 
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.375</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">modelo_B</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
<span class="n">modelo_B</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_1&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_2 (InputLayer)        [(None, None)]            0         
                                                                 
 embedding (Embedding)       (None, None, 128)         640000    
                                                                 
 conv1d (Conv1D)             (None, None, 32)          8224      
                                                                 
 lstm (LSTM)                 (None, 256)               295936    
                                                                 
 dense_3 (Dense)             (None, 384)               98688     
                                                                 
 dropout_1 (Dropout)         (None, 384)               0         
                                                                 
 dense_4 (Dense)             (None, 1)                 385       
                                                                 
=================================================================
Total params: 1043233 (3.98 MB)
Trainable params: 1043233 (3.98 MB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># instanciar, compilar e treinar modelo B</span>
<span class="c1"># Compilando o modelo com perda entropia cruzada e métricas além da perda, a área sob a curva Precision-Recall (AUC PR) e a Acurácia Binária</span>
<span class="n">modelo_B</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">BinaryAccuracy</span><span class="p">(),</span> <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">AUC</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span><span class="p">)])</span>

<span class="c1"># Treinando o modelo para a línguagem PT por 15 épocas com batch size 24</span>
<span class="n">hist_modeloB_treino</span> <span class="o">=</span>  <span class="n">modelo_B</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_tok_pt</span><span class="p">,</span> <span class="n">y_train_pt</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">callbacklr</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
355/355 [==============================] - 52s 143ms/step - loss: 0.5966 - binary_accuracy: 0.6632 - auc_1: 0.7394 - lr: 7.0000e-04
Epoch 2/15
355/355 [==============================] - 51s 144ms/step - loss: 0.3624 - binary_accuracy: 0.8449 - auc_1: 0.9190 - lr: 6.4942e-04
Epoch 3/15
355/355 [==============================] - 61s 173ms/step - loss: 0.2278 - binary_accuracy: 0.9120 - auc_1: 0.9669 - lr: 6.0249e-04
Epoch 4/15
355/355 [==============================] - 67s 188ms/step - loss: 0.1537 - binary_accuracy: 0.9449 - auc_1: 0.9847 - lr: 5.5896e-04
Epoch 5/15
355/355 [==============================] - 61s 171ms/step - loss: 0.0967 - binary_accuracy: 0.9692 - auc_1: 0.9929 - lr: 5.1857e-04
Epoch 6/15
355/355 [==============================] - 57s 161ms/step - loss: 0.0594 - binary_accuracy: 0.9802 - auc_1: 0.9969 - lr: 4.8110e-04
Epoch 7/15
355/355 [==============================] - 67s 188ms/step - loss: 0.0378 - binary_accuracy: 0.9876 - auc_1: 0.9982 - lr: 4.4634e-04
Epoch 8/15
355/355 [==============================] - 67s 188ms/step - loss: 0.0232 - binary_accuracy: 0.9934 - auc_1: 0.9994 - lr: 4.1409e-04
Epoch 9/15
355/355 [==============================] - 62s 175ms/step - loss: 0.0120 - binary_accuracy: 0.9966 - auc_1: 0.9997 - lr: 3.8417e-04
Epoch 10/15
355/355 [==============================] - 63s 178ms/step - loss: 0.0042 - binary_accuracy: 0.9993 - auc_1: 0.9999 - lr: 3.5641e-04
Epoch 11/15
355/355 [==============================] - 67s 190ms/step - loss: 0.0091 - binary_accuracy: 0.9974 - auc_1: 0.9999 - lr: 3.3065e-04
Epoch 12/15
355/355 [==============================] - 67s 189ms/step - loss: 0.0124 - binary_accuracy: 0.9968 - auc_1: 0.9995 - lr: 3.0676e-04
Epoch 13/15
355/355 [==============================] - 65s 182ms/step - loss: 0.0020 - binary_accuracy: 0.9998 - auc_1: 1.0000 - lr: 2.8460e-04
Epoch 14/15
355/355 [==============================] - 60s 168ms/step - loss: 0.0012 - binary_accuracy: 0.9996 - auc_1: 1.0000 - lr: 2.6403e-04
Epoch 15/15
355/355 [==============================] - 69s 195ms/step - loss: 3.0794e-04 - binary_accuracy: 1.0000 - auc_1: 1.0000 - lr: 2.4496e-04
</pre></div>
</div>
</div>
</div>
</section>
<section id="pt-avaliacao-dos-modelos-metricas-durante-treinamento-e-avaliacao-das-metricas-no-conjunto-de-teste-de-ambos-os-modelos">
<h3>3. (2,0 pt) Avaliação dos modelos: métricas durante treinamento e avaliação das métricas no conjunto de teste de ambos os modelos<a class="headerlink" href="#pt-avaliacao-dos-modelos-metricas-durante-treinamento-e-avaliacao-das-metricas-no-conjunto-de-teste-de-ambos-os-modelos" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exibir curvas das métricas ao longo do treinamento (epocas)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Treinamento do Modelo A</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Treinamento Modelo A&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6df6491d692b20e2b9625df7b2a5d240ab1eb9ab1c46b31850798a61ae2f1e57.svg" src="../_images/6df6491d692b20e2b9625df7b2a5d240ab1eb9ab1c46b31850798a61ae2f1e57.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## avaliacao no conjunto de teste do Modelo A</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">modelo_A</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">embeddings_pt_test</span><span class="p">,</span> <span class="n">y_test_pt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Binária: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC-PR: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="c1"># exibir os valores obtidos</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>47/47 [==============================] - 0s 1ms/step - loss: 0.7447 - binary_accuracy: 0.8080 - auc: 0.8703
Acurácia Binária:  0.808
AUC-PR:  0.8703
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Matriz de Confuzão do Modelo A</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">embeddings_pt_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">y_pred_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_pt</span><span class="p">,</span> <span class="n">y_pred_class</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/185a5c774dd9e8b2cd2b1d3399f3451ab2e6d0deeedef21298a866d295e4df45.svg" src="../_images/185a5c774dd9e8b2cd2b1d3399f3451ab2e6d0deeedef21298a866d295e4df45.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Treinamento do Modelo B</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Treinamento Modelo B&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_1&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4b77e4d1490a98d801afaf5d7e19bcf00c7eaedc326198b79d4d4f1433817d21.svg" src="../_images/4b77e4d1490a98d801afaf5d7e19bcf00c7eaedc326198b79d4d4f1433817d21.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## avaliacao no conjunto de teste do Modelo B</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">modelo_B</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_tok_pt</span><span class="p">,</span> <span class="n">y_test_pt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Binária: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC-PR: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="c1"># exibir os valores obtidos</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>47/47 [==============================] - 4s 81ms/step - loss: 1.7236 - binary_accuracy: 0.8113 - auc_1: 0.8224
Acurácia Binária:  0.8113
AUC-PR:  0.8224
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Matriz de Confuzão do Modelo B</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">modelo_B</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_tok_pt</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">y_pred_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_pt</span><span class="p">,</span> <span class="n">y_pred_class</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e551be8e3f38a3a3e3820ee598ad231f9afce9ca0da80fc33b28cc1136fcd398.svg" src="../_images/e551be8e3f38a3a3e3820ee598ad231f9afce9ca0da80fc33b28cc1136fcd398.svg" /></div>
</div>
</section>
<section id="pt-fine-tuning-dos-modelos-anteriores-usando-os-dados-em-ingles">
<h3>4. (3,0 pt) Fine-tuning dos Modelos anteriores usando os dados em <strong>ingles</strong><a class="headerlink" href="#pt-fine-tuning-dos-modelos-anteriores-usando-os-dados-em-ingles" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Modelo A : usando embeddings extraídos dos textos em ingles. Para esse modelo torne a primeira camada densa não treinável.</p></li>
<li><p>Modelo B : usando os tokens extraídos dos textos em ingles. Para esse modelo permita a adaptação de todas as camadas</p></li>
</ol>
<p>Siga o exemplo que copia o modelo e seus pesos para um novo modelo.</p>
<p>Após o treinamento exiba as métricas obtidas em teste</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Fine-tuning do Modelo A com a primeira camada densa congelada</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cria novo modelo copiando a arquitetura</span>
<span class="n">modelo_A2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">clone_model</span><span class="p">(</span><span class="n">modelo_A</span><span class="p">)</span>
<span class="c1"># Copia os pesos do modelo anterior para o novo modelo</span>
<span class="n">modelo_A2</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tornando a primeira camada densa não treinável</span>
<span class="n">modelo_A2</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span><span class="kc">False</span>
<span class="n">modelo_A2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, 768)]             0         
                                                                 
 batch_normalization (Batch  (None, 768)               3072      
 Normalization)                                                  
                                                                 
 dense (Dense)               (None, 384)               295296    
                                                                 
 dense_1 (Dense)             (None, 384)               147840    
                                                                 
 batch_normalization_1 (Bat  (None, 384)               1536      
 chNormalization)                                                
                                                                 
 activation (Activation)     (None, 384)               0         
                                                                 
 dropout (Dropout)           (None, 384)               0         
                                                                 
 dense_2 (Dense)             (None, 1)                 385       
                                                                 
=================================================================
Total params: 448129 (1.71 MB)
Trainable params: 150529 (588.00 KB)
Non-trainable params: 297600 (1.14 MB)
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compilando o modelo com perda entropia cruzada e métricas além da perda, a área sob a curva Precision-Recall (AUC PR) e a Acurácia Binária</span>
<span class="c1"># Otimizador Adam e taxa de aprendizado constante de 0.00002</span>
<span class="n">modelo_A2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.00002</span> <span class="p">),</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BinaryAccuracy&#39;</span><span class="p">,</span> <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">AUC</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span><span class="p">)])</span>

<span class="c1"># Treinando o modelo para a línguagem EN (Inglês) por 15 épocas com batch size 24 </span>
<span class="n">hist_modeloA2_treino</span> <span class="o">=</span>  <span class="n">modelo_A2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeddings_train</span><span class="p">,</span> <span class="n">y_train_en</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
WARNING:tensorflow:From C:\Users\jmblima\AppData\Local\anaconda3\Lib\site-packages\keras\src\engine\base_layer_utils.py:384: The name tf.executing_eagerly_outside_functions is deprecated. Please use tf.compat.v1.executing_eagerly_outside_functions instead.

355/355 [==============================] - 2s 3ms/step - loss: 0.1522 - binary_accuracy: 0.9441 - auc_2: 0.9844
Epoch 2/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1265 - binary_accuracy: 0.9522 - auc_2: 0.9888
Epoch 3/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1289 - binary_accuracy: 0.9524 - auc_2: 0.9887
Epoch 4/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1304 - binary_accuracy: 0.9521 - auc_2: 0.9887
Epoch 5/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1277 - binary_accuracy: 0.9531 - auc_2: 0.9889
Epoch 6/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1196 - binary_accuracy: 0.9544 - auc_2: 0.9906
Epoch 7/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1317 - binary_accuracy: 0.9508 - auc_2: 0.9888
Epoch 8/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1228 - binary_accuracy: 0.9527 - auc_2: 0.9904
Epoch 9/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1111 - binary_accuracy: 0.9565 - auc_2: 0.9920
Epoch 10/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1146 - binary_accuracy: 0.9559 - auc_2: 0.9911
Epoch 11/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1159 - binary_accuracy: 0.9569 - auc_2: 0.9909
Epoch 12/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1120 - binary_accuracy: 0.9588 - auc_2: 0.9915
Epoch 13/15
355/355 [==============================] - 1s 3ms/step - loss: 0.0982 - binary_accuracy: 0.9628 - auc_2: 0.9940
Epoch 14/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1089 - binary_accuracy: 0.9608 - auc_2: 0.9922
Epoch 15/15
355/355 [==============================] - 1s 3ms/step - loss: 0.1082 - binary_accuracy: 0.9564 - auc_2: 0.9911
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Treinamento do Modelo A2</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Treinamento Modelo A2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_2&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/baa0603e2c6c1ae1a75789144b8a0985f32b9034dfa84da72057da1cda2d4942.svg" src="../_images/baa0603e2c6c1ae1a75789144b8a0985f32b9034dfa84da72057da1cda2d4942.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## avaliacao no conjunto de teste do Modelo A2</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">modelo_A2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">embeddings_test</span><span class="p">,</span> <span class="n">y_test_en</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Binária: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC-PR: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>47/47 [==============================] - 0s 1ms/step - loss: 0.6569 - binary_accuracy: 0.8173 - auc_2: 0.8857
Acurácia Binária:  0.8173
AUC-PR:  0.8857
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Fine-tuning do Modelo B</span>
<span class="c1"># Cria novo modelo copiando a arquitetura</span>
<span class="n">modelo_B2</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">clone_model</span><span class="p">(</span><span class="n">modelo_B</span><span class="p">)</span>
<span class="c1"># Copia os pesos do modelo anterior para o novo modelo</span>
<span class="n">modelo_B2</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">modelo_B</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># instanciar, compilar e treinar modelo B2</span>
<span class="c1"># Compilando o modelo com perda entropia cruzada e métricas além da perda, a área sob a curva Precision-Recall (AUC PR) e a Acurácia Binária</span>
<span class="c1"># Otimizador Adam e taxa de aprendizado constante de 0.00002</span>
<span class="n">modelo_B2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.00002</span><span class="p">)</span> <span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BinaryAccuracy&#39;</span><span class="p">,</span> <span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">AUC</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="s1">&#39;PR&#39;</span><span class="p">)])</span>

<span class="c1"># Treinando o modelo para a línguagem PT por 15 épocas com batch size 24</span>
<span class="n">hist_modeloB2_treino</span> <span class="o">=</span>  <span class="n">modelo_B2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_tok_en</span><span class="p">,</span> <span class="n">y_train_en</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
355/355 [==============================] - 67s 185ms/step - loss: 2.6903 - binary_accuracy: 0.5053 - auc_3: 0.5088
Epoch 2/15
355/355 [==============================] - 59s 167ms/step - loss: 0.9425 - binary_accuracy: 0.5039 - auc_3: 0.5054
Epoch 3/15
355/355 [==============================] - 63s 177ms/step - loss: 0.6990 - binary_accuracy: 0.5120 - auc_3: 0.5181
Epoch 4/15
355/355 [==============================] - 66s 185ms/step - loss: 0.6988 - binary_accuracy: 0.5087 - auc_3: 0.5124
Epoch 5/15
355/355 [==============================] - 65s 184ms/step - loss: 0.6958 - binary_accuracy: 0.5061 - auc_3: 0.5179
Epoch 6/15
355/355 [==============================] - 63s 178ms/step - loss: 0.6941 - binary_accuracy: 0.5176 - auc_3: 0.5195
Epoch 7/15
355/355 [==============================] - 63s 177ms/step - loss: 0.6936 - binary_accuracy: 0.5155 - auc_3: 0.5226
Epoch 8/15
355/355 [==============================] - 66s 186ms/step - loss: 0.6930 - binary_accuracy: 0.5209 - auc_3: 0.5225
Epoch 9/15
355/355 [==============================] - 64s 180ms/step - loss: 0.6926 - binary_accuracy: 0.5167 - auc_3: 0.5243
Epoch 10/15
355/355 [==============================] - 64s 181ms/step - loss: 0.6920 - binary_accuracy: 0.5219 - auc_3: 0.5260
Epoch 11/15
355/355 [==============================] - 60s 170ms/step - loss: 0.6918 - binary_accuracy: 0.5232 - auc_3: 0.5288
Epoch 12/15
355/355 [==============================] - 66s 186ms/step - loss: 0.6914 - binary_accuracy: 0.5260 - auc_3: 0.5315
Epoch 13/15
355/355 [==============================] - 66s 185ms/step - loss: 0.6896 - binary_accuracy: 0.5358 - auc_3: 0.5434
Epoch 14/15
355/355 [==============================] - 63s 176ms/step - loss: 0.6876 - binary_accuracy: 0.5398 - auc_3: 0.5541
Epoch 15/15
355/355 [==============================] - 60s 168ms/step - loss: 0.6858 - binary_accuracy: 0.5527 - auc_3: 0.5640
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Treinamento do Modelo B2</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Treinamento Modelo B2&quot;</span><span class="p">)</span>
<span class="c1">#plt.plot(hist_modeloB2_treino.history[&quot;loss&quot;], label=&#39;loss&#39;) # Removida do gráfico para melhorar a visualização</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_3&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/783a82fe2b6dbba8b7267cef24bde5f09ec920b5ac170ac8dd3cc7341771d383.svg" src="../_images/783a82fe2b6dbba8b7267cef24bde5f09ec920b5ac170ac8dd3cc7341771d383.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## avaliacao no conjunto de teste do Modelo B2</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">modelo_B2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_tok_en</span><span class="p">,</span> <span class="n">y_test_en</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acurácia Binária: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC-PR: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>47/47 [==============================] - 4s 82ms/step - loss: 0.6877 - binary_accuracy: 0.5453 - auc_3: 0.5805
Acurácia Binária:  0.5453
AUC-PR:  0.5805
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Comparação entre modelos</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparação entre Modelos - Acurácia Binária&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;binary_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7ce8c4b3a341d55f3002dc39c308585f9de976eb7064a2f03115e894b2decac6.svg" src="../_images/7ce8c4b3a341d55f3002dc39c308585f9de976eb7064a2f03115e894b2decac6.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Comparação entre modelos - AUC</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparação entre Modelos - AUC - PR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_1&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_2&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;auc_3&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f3e9b7bcd856af9c4434e6064e912499e78287fb261152fb83c92f0e32dd911e.svg" src="../_images/f3e9b7bcd856af9c4434e6064e912499e78287fb261152fb83c92f0e32dd911e.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Comparação entre modelos - Loss</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparação entre Modelos - Perda&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloA2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo A2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_modeloB2_treino</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Modelo B2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5b1774f7198a55c4d363263ad91ce7d50f1f0c65ca4934ae64d77bc3a8da5313.svg" src="../_images/5b1774f7198a55c4d363263ad91ce7d50f1f0c65ca4934ae64d77bc3a8da5313.svg" /></div>
</div>
</section>
</section>
<section id="bonus-1pt">
<h2>Bônus (+1pt)<a class="headerlink" href="#bonus-1pt" title="Permalink to this heading">#</a></h2>
<section id="analise-dos-espacos-de-caracteristicas-do-textos-em-portugues-usando-tsne-em-duas-dimensoes">
<h3>1: Análise dos espaços de características do textos em português usando tSNE em duas dimensões<a class="headerlink" href="#analise-dos-espacos-de-caracteristicas-do-textos-em-portugues-usando-tsne-em-duas-dimensoes" title="Permalink to this heading">#</a></h3>
<section id="a-espaco-embedding-original-em-portugues">
<h4>a. Espaço embedding original em portugues<a class="headerlink" href="#a-espaco-embedding-original-em-portugues" title="Permalink to this heading">#</a></h4>
</section>
<section id="b-espaco-embedding-modelo-a">
<h4>b. Espaço embedding Modelo A<a class="headerlink" href="#b-espaco-embedding-modelo-a" title="Permalink to this heading">#</a></h4>
</section>
<section id="c-espaco-embedding-modelo-b">
<h4>c. Espaço embedding Modelo B<a class="headerlink" href="#c-espaco-embedding-modelo-b" title="Permalink to this heading">#</a></h4>
<p>Use o TNSE com os parametros definidos no exemplo abaixo. Realize fit_transform nos dados de teste relativo a cada modelo para projetar os dados em 2 dimensões e a seguir plote esses espaços 2d usando scatterplots.</p>
<p>Após, escreva suas conclusões sobre essa análise visual comparativa entre os 3 espaços</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TSNE e seus parametros</span>
<span class="n">tsne_1</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">espaco_original</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">embeddings_pt_test</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">espaco_original</span><span class="p">[</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">espaco_original</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Transformação TSNE - Espaço Original PT&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/608602565167eef72fd004cae24c411dd1fce74212e0b5828439549709e35f91.svg" src="../_images/608602565167eef72fd004cae24c411dd1fce74212e0b5828439549709e35f91.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extraíndo dados da última camada densa de 384 dimensões do Modelo A (layer[3])</span>

<span class="n">modelo_A_densa</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">embeddings_modelo_A</span> <span class="o">=</span> <span class="n">modelo_A_densa</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">embeddings_pt_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">espaco_ModeloA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">embeddings_modelo_A</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">espaco_ModeloA</span><span class="p">[</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">espaco_ModeloA</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Transformação TSNE - Espaço Modelo A Camada densa 384&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c5987555bdbe2a68057fd527a1ad4d1900a2b435f8a9480c80aa969543c2f65d.svg" src="../_images/c5987555bdbe2a68057fd527a1ad4d1900a2b435f8a9480c80aa969543c2f65d.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extraíndo dados da última camada densa de 384 dimensões do Modelo B</span>

<span class="n">modelo_B_densa</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">modelo_B</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">modelo_B</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">embeddings_modelo_B</span> <span class="o">=</span> <span class="n">modelo_B_densa</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_tok_pt</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">espaco_ModeloB</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">embeddings_modelo_B</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
<span class="n">espaco_ModeloB</span><span class="p">[</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">espaco_ModeloB</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Transformação TSNE - Espaço Modelo B Camada densa 384&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2f8b2f8b0b036f2612882936701c1efd52646806622aea7a43d395f19d1065d9.svg" src="../_images/2f8b2f8b0b036f2612882936701c1efd52646806622aea7a43d395f19d1065d9.svg" /></div>
</div>
<p>Comparando os gráficos conseguimos notar uma evolução na separação entre os grupos de sentimentos positivos e negativos. Quanto mais avançada na rede neural a separação fica mais evidente. Isso nos leva a concluir que a construção está sendo eficiente em separar os grupos com sentimentos positivos e negativos nas avaliações.</p>
<p>Para evidenciar a afirmação coloquei a evolução dos outputs das camadas no esquema abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">modelo_A_densa</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">modelo_A</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">embeddings_modelo_A</span> <span class="o">=</span> <span class="n">modelo_A_densa</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">embeddings_pt_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">espaco_ModeloA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">embeddings_modelo_A</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
    <span class="n">espaco_ModeloA</span><span class="p">[</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_pt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">);</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">espaco_ModeloA</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Sentimento&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cfc85f0ffbb223c305cc7ae78ad61d79ff6e51fd1c8649d475d10c8468d8b316.svg" src="../_images/cfc85f0ffbb223c305cc7ae78ad61d79ff6e51fd1c8649d475d10c8468d8b316.svg" /></div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="7.1-ADBPMP-Slides%2BASs.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">7.1-ADBPMP-Slides+ASs</p>
      </div>
    </a>
    <a class="right-next"
       href="9-REVISOES.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">1 - APRENDIZADO DE MÁQUINA - AM</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Redes Neurais e Aprendizado Profundo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perceptron">Perceptron</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classe-perceptron">1. Classe Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metodo-para-predicao-e-funcao-de-custo">2. Método para predição e função de custo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#redes-neurais-e-arquiteturas-profundas">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mba-em-ciencias-de-dados"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-1-introducao-ao-aprendizado-profundo"><em>Módulo 1 - Introdução ao Aprendizado Profundo</em></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-com-tensorflow-e-keras">Implementação com Tensorflow e Keras</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-avaliacao-com-solucoes-span"><span style="color:darkred">Avaliação (com soluções)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-1">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-2">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-3">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-4">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-5">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-exercicios-com-solucoes-span"><span style="color:darkred">Exercícios com soluções</span></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-1-exercicios-essenciais">Parte 1 - Exercícios Essenciais</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-1">Exercício 1)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-2">Exercício 2)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-3">Exercício 3)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-4">Exercício 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-5">Exercício 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-6">Exercício 6)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-7">Exercício 7)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-8">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#perceptron-e-seu-treinamento">Perceptron e seu Treinamento</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">1. Classe Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-da-classe">Uso da classe</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dados-de-treinamento">Dados de treinamento:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2"><em>Módulo 2</em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-com-dados-estruturados">MLP com dados estruturados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#podemos-mudar-as-metricas-a-serem-acompanhadas">Podemos mudar as métricas a serem acompanhadas</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisando-o-modelo">Analisando o modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#desbalanceamento">Desbalanceamento</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outros-ajustes">Outros ajustes:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2-embeddings-de-modelos-pre-treinados-imagens">Modulo 2 - Embeddings de Modelos Pré-treinados - Imagens</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rede-convolucional-supervisionada-pre-treinada">Rede Convolucional Supervisionada Pré-treinada</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicando-as-features-obtidas-em-um-classificador">Aplicando as features obtidas em um classificador</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-2-embeddings-de-modelos-pre-treinados-texto"><em>Modulo 2</em> - Embeddings de Modelos Pré-treinados - Texto</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelos-sentence-transformer">Modelos Sentence Transformer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Aplicando as features obtidas em um classificador</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-ii-span"><span style="color:darkred">Módulo II</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Questão 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questao-5-as2">Questão 5 - AS2</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Implementação com Tensorflow e Keras</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-2-span"><span style="color:darkred">Módulo 2</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12"><span style="color:darkred">Exercícios com soluções</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-3-redes-neurais-convolucionais-cnns"><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-vs-cnn"><strong>MLP vs CNN</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exemplo-de-uso-de-redes-neurais-profundas-para-classificacao-de-imagens">Exemplo de uso de redes neurais profundas para classificação de imagens</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#como-tratar-bases-de-imagens-antes-de-comecar-a-processar">1. Como tratar bases de imagens antes de começar a processar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacao-rede-densa-mlp-vs-rede-convolucional-cnn">2. Comparação: Rede Densa (MLP) vs Rede Convolucional (CNN)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tudo-pronto-agora-vamos-comecar">Tudo pronto, agora vamos começar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vamos-aos-concorrentes">Vamos aos concorrentes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-o-dataset-e-os-modelos">1) Preparando o dataset e os modelos</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#e-la-vamos-nos-em-quem-voce-apostaria"><strong>E lá vamos nós</strong>: em quem você apostaria?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Redes Neurais e Arquiteturas Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id22"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id23"><em>Módulo 3 - Redes Neurais Convolucionais (CNNs)</em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-e-preparar-base-de-dados">1. Carregar e preparar base de dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparar-os-batches">Preparar os batches</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#projetar-redes-neurais">2. Projetar redes neurais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cnn-estilo-vggnet">2.1 - CNN estilo “VGGNet”</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#substituicao-de-maxpooling-por-strides-1">2.2 - Substituição de MaxPooling por strides &gt; 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-de-convolucoes-por-partes-1x3-3x1-1x1">2.3 - Uso de convoluções por partes 1x3, 3x1, 1x1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#blocos-residuais-estilo-resnet">2.4 - Blocos Residuais (estilo ResNet)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#blocos-separaveis-em-profundidade-estilo-xception-mobilenet">2.5 - Blocos Separáveis em Profundidade (estilo Xception/MobileNet)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#compilando-modelos">3. Compilando Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#executando-o-treinamento">4. Executando o treinamento</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-3-redes-neurais-convolucionais-cnns-span"><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Questão 1)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Questão 2)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Questão 3)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Questão 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Questão 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30"><span style="color:darkred">Módulo 3 - Redes Neurais Convolucionais (CNNs)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id31"><span style="color:darkred">Exercícios com soluções</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-4-treinamento-de-redes-profundas"><em>Módulo 4 - Treinamento de Redes Profundas</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regularizacao-e-normalizacao">Regularização e Normalização</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vamos-investigar-uma-cnn-sequencial-e-adicionar-opcoes-de-dropout-regularizacao-e-normalizacao-por-batch-e-por-camada">1) Vamos investigar uma CNN sequencial, e adicionar opções de Dropout (regularização), e normalização por batch e por camada</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#i-avaliando-o-papel-da-normalizacao">I - Avaliando o papel da Normalização</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#com-batch-normalization">com Batch Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#com-layer-normalization">com Layer Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">Redes Neurais e Aprendizado Profundo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id41"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42"><em>Módulo 4 - Treinamento de Redes Profundas</em></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-augmentation">Data Augmentation:</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#funciona-como-uma-camada-de-pre-processamento-gerando-transformacoes-aleatorias-na-imagem-de-entrada">funciona como uma camada de pré-processamento, gerando transformações aleatórias na imagem de entrada.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-a-cnn-mobilenet-v2-para-ser-usada-como-backbone-da-solucao">Carregando a CNN “MobileNet V2” para ser usada como “backbone” da solução</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compilando-e-treinando-o-modelo-a-partir-de-pessos-aleatorios">Compilando e treinando o modelo a partir de pessos aleatórios</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-a-cnn-mobilenet-v2-com-pesos-pre-treinados">Carregando a CNN “MobileNet V2” com pesos pré-treinados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-1-treinar-apenas-a-camada-de-saida-softmax">Passo 1: treinar apenas a camada de saída (softmax)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-2-ajuste-fino-do-restante-dos-parametros">Passo 2: ajuste fino do restante dos parâmetros</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#obtendo-features-a-partir-da-cnn-mobilenet-v2-com-pesos-pre-treinados">Obtendo features a partir da CNN “MobileNet V2” com pesos pré-treinados</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-4-estrategias-de-treinamento-e-transferencia-de-aprendizado-span"><span style="color:darkred">Módulo 4 - Estratégias de Treinamento e Transferência de Aprendizado</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id43"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id44">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id45">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id46">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id47">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id48">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-iv-estrategias-de-treinamento-e-transferencia-de-aprendizado-span"><span style="color:darkred">Módulo IV - Estratégias de Treinamento e Transferência de Aprendizado</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id49"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id50">Parte 1 - Exercícios Essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id51">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id52">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id53">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id54">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id55">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id56">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id57">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-exercicios-complementares-opcionais">Parte 2 - Exercícios Complementares/Opcionais</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id58">Exercício 8)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-9">Exercício 9)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercicio-10">Exercício 10)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id59">Módulo 4 - Treinamento de Redes Profundas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entendendo-a-funcao-de-custo-entropia-cruzada-cross-entropy">Entendendo a função de custo entropia cruzada (cross-entropy)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id60"><em>Módulo 4 - Treinamento de Redes Profundas</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taxa-de-aprendizado">Taxa de aprendizado</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-dataset">1. Preparando Dataset</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#definindo-rede-neural">2. Definindo Rede Neural</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explorando-diferentes-estrategias-para-o-learning-rate">3. Explorando Diferentes Estratégias para o Learning Rate</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-fixo">3.1 - Learning Rate Fixo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate-alto">3.2 - Learning Rate Alto</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sgd-momentum-com-peso-0-9">3.2 - SGD + Momentum com peso 0.9</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decaimento-de-learning-rate">3.3 - Decaimento de Learning Rate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-5-redes-neurais-para-dados-sequenciais-span"><span style="color:darkred">Módulo 5 - Redes neurais para dados sequenciais</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id61"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id62">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id63">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id64">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id65">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id66">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-5-redes-neurais-para-dados-sequenciais-span">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-lstms-e-grus-para-predicao-de-series-temporais-span"><span style="color:darkred"><strong>LSTMs e GRUs</strong> para predição de séries temporais</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-1-preparando-os-dados">Parte 1: Preparando os dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulacao-para-aprendizado-supervisionado-adequacao-dos-arrays">Formulação para aprendizado supervisionado: adequação dos arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-utilizando-unidades-densas-para-predicao">Parte 2: Utilizando unidades Densas para predição</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-utilizando-lstms-para-predicao">Parte 3 : Utilizando LSTMs para predição</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rede-com-unidades-lstm">Rede com unidades LSTM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gru-como-forma-alternativa-a-lstm">GRU como forma alternativa à LSTM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modulo-5-redes-neurais-para-dados-sequenciais">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-mecanismo-de-atencao-span"><span style="color:darkred"><strong>Mecanismo de atenção</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id67">Redes Neurais e Aprendizado Profundo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id68"><strong>MBA em Ciências de Dados</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id69">Módulo 5 - Redes neurais para dados sequenciais </a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-camada-self-attention-combinada-com-lstm-span"><span style="color:darkred"><strong>Camada Self-Attention</strong> combinada com LSTM</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id70">Parte 1: Preparando os dados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id71">Formulação para aprendizado supervisionado: adequação dos arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-utilizando-lstms-para-predicao">Parte 2 : Utilizando LSTMs para predição</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id72">Rede com unidades LSTM</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-camada-self-attention">Parte 3: Camada Self-Attention</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id73">Módulo 5 - Redes neurais para dados sequenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-series-multivariadas-e-statefulness-span"><span style="color:darkred"><strong>Séries Multivariadas e Statefulness</strong></span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id74">Parte 1: Preparando os dados</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-problema-regressao-com-entrada-multivariada">Parte 2: problema regressão com entrada multivariada</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statefullness">Statefullness</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-6-redes-neurais-para-texto-span"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id75"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id76">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id77">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id78">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id79">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id80">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id81"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id82"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id83">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id84">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id85">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id86">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id87">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id88">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id89">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id90">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id91"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-word-embeddings-span"><span style="color:darkred"><strong>Parte 1: Word Embeddings</strong></span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-representacoes-pre-treinadas-em-portugues">Carregando representações pré-treinadas em português</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#base-de-dados-rumor-brazil-2018">Base de dados: rumor Brazil 2018</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#camada-de-word-embedding">Camada de “Word Embedding”</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-baseado-em-convolucoes">Modelo baseado em Convoluções</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-utilizando-gru">Modelo utilizando GRU</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id92"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-transformer-based-network-span"><strong>Parte 2: Transformer-based Network</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-de-transformer">Implementação de Transformer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#camada-de-embedding-contendo-word-embedding-e-vetor-com-posicoes-das-palavras">Camada de Embedding, contendo word embedding e vetor com posições das palavras</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#montando-a-rede-transformer">Montando a rede Transformer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id93"><span style="color:darkred">Módulo 6 - Redes neurais para texto</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-3-distilbert-transferencia-de-aprendizado-span"><strong>Parte 3: DistilBERT: transferência de aprendizado</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#carregando-dataset-de-texto">1. Carregando Dataset de texto</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparando-o-dataset-para-uso-na-rede-neural">2.1 Preparando o dataset para uso na rede neural</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-modelo-pre-treinado-e-configura-lo">3. Carregar modelo pré-treinado e configurá-lo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#criar-modelo-para-realizar-transferencia-de-aprendizado-para-a-tarefa-alvo-downstream-task-de-classificacao">3.1 Criar modelo para realizar transferência de aprendizado para a tarefa alvo (downstream task) de classificação</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#treinamento-das-camadas-novas-transfer-learning">3.2 Treinamento das camadas novas (transfer learning)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fine-tuning-do-distilbert">3.3 Fine-tuning do DistilBERT</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-7-auto-encoders-e-redes-geradoras-span"><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id94"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id95">Parte 1 - Exercícios Essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id96">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id97">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id98">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id99">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id100">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id101">Exercício 6)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parte-2-exercicios-complementares">Parte 2 - Exercícios complementares</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id102">Exercício 8)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-7-auto-encodes-e-redes-geradoras-span"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-autoencoders-para-aprendizado-de-representacoes-span"><span style="color:darkred"><strong>Parte 1: Autoencoders para Aprendizado de Representações</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autoencoder-convolucional">Autoencoder convolucional</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#treinando-o-autoencoder">Treinando o autoencoder</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id103"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-2-autoencoders-para-reducao-de-dimensionalidade-span"><span style="color:darkred"><strong>Parte 2: Autoencoders para Redução de Dimensionalidade</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#o-autoencoder-sera-denso-com">O autoencoder será denso, com:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#uso-em-regressor-externo">Uso em regressor externo</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id104"><span style="color:darkred">Módulo 7 - Auto-encodes e Redes Geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-3-rede-geradora-adversarial-gan-span"><span style="color:darkred"><strong>Parte 3: Rede Geradora Adversarial (GAN)</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discriminador">Discriminador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gerador">Gerador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gan">GAN</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id105"><span style="color:darkred">Módulo 7 - Auto-encoders e Redes geradoras</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id106"><span style="color:darkred">Avaliação (com soluções)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id107">Questão 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id108">Questão 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id109">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id110">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id111">Questão 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-spa"><span style="color:darkred">Módulo 8 -  Introdução ao Aprendizado por Reforço&lt;/spa</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-avaliacao-respostas"><span style="color:darkred">Avaliação&lt;respostas</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id112">Questão 1)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id113">Questão 2)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id114">Questão 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id115">Questão 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id116">Questão 5)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-vii-introducao-ao-aprendizado-por-reforco-span"><span style="color:darkred">Módulo VII -  Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id117"><span style="color:darkred">Exercícios (com soluções)</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id118">Parte 1: Exercícios essenciais</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id119">Exercício 1)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id120">Exercício 2)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id121">Exercício 3)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id122">Exercício 4)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id123">Exercício 5)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id124">Exercício 6)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id125">Parte 2: Exercícios Complementares</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id126">Exercício 7)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id127">Exercício 8)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id128">Exercício 9)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-modulo-8-introducao-ao-aprendizado-por-reforco-span"><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-1-biblioteca-gym-e-problemas-benchmark-de-aprendizado-por-reforco-span"><span style="color:darkred"><strong>Parte 1: Biblioteca Gym e Problemas Benchmark de Aprendizado por Reforço</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-montain-car">Problema “Montain Car”</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-do-taxi">Problema do táxi</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id129"><span style="color:darkred">Módulo 8 - Introdução ao Aprendizado por Reforço</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-darkred-parte-2-algoritmo-de-aprendizado-por-reforco-value-learning-span"><span style="color:darkred"><strong>Parte 2: Algoritmo de Aprendizado por Reforço “Value Learning”</strong></span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-taxi">Problema Taxi</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#algoritmo-de-value-learning">Algoritmo de Value learning</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#avaliando-a-performance-do-agente">Avaliando a performance do agente</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#executando-uma-vez-para-visualizar">Executando uma vez para visualizar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avaliacao-final-2023">Avaliação Final - 2023</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacao">Preparação</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#biblioteca-sentence-transformers-e-carregar-modelo">1. Biblioteca <code class="docutils literal notranslate"><span class="pre">sentence_transformers</span></code> e carregar modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carregar-base-de-dados-e-obter-amostra">2. Carregar base de dados e obter amostra</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#separar-dados-em-treinamento-e-teste-preparar-rotulos-e-estimar-numero-de-palavras-nas-instancias">3. Separar dados em treinamento e teste, preparar rótulos e estimar número de palavras nas instancias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geracao-dos-embeddings">4. Geração dos embeddings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#realizar-tarefas">Realizar Tarefas:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-modelo-a-classificador-de-sentimento-em-portugues-usando-embedding-pre-treinado">1. (2,5 pt) Modelo A: classificador de sentimento em <em>portugues</em> usando embedding pré-treinado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-modelo-b-classificador-de-sentimento-em-portugues-usando-tokenizador-e-rede-cnn-lstm">2. (2,5 pt) Modelo B: classificador de sentimento em <em>português</em> usando tokenizador e rede CNN+LSTM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-avaliacao-dos-modelos-metricas-durante-treinamento-e-avaliacao-das-metricas-no-conjunto-de-teste-de-ambos-os-modelos">3. (2,0 pt) Avaliação dos modelos: métricas durante treinamento e avaliação das métricas no conjunto de teste de ambos os modelos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pt-fine-tuning-dos-modelos-anteriores-usando-os-dados-em-ingles">4. (3,0 pt) Fine-tuning dos Modelos anteriores usando os dados em <strong>ingles</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-1pt">Bônus (+1pt)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-dos-espacos-de-caracteristicas-do-textos-em-portugues-usando-tsne-em-duas-dimensoes">1: Análise dos espaços de características do textos em português usando tSNE em duas dimensões</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-espaco-embedding-original-em-portugues">a. Espaço embedding original em portugues</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#b-espaco-embedding-modelo-a">b. Espaço embedding Modelo A</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#c-espaco-embedding-modelo-b">c. Espaço embedding Modelo B</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>